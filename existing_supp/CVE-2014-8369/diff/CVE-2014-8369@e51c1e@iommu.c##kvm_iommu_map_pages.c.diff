--- before
+++ after
@@ -48,7 +48,7 @@
 		 * Pin all pages we are about to map in memory. This is

 		 * important because we unmap and unpin in 4kb steps later.

 		 */

-		pfn = kvm_pin_pages(slot, gfn, page_size);

+		pfn = kvm_pin_pages(slot, gfn, page_size >> PAGE_SHIFT);

 		if (is_error_noslot_pfn(pfn)) {

 			gfn += 1;

 			continue;

@@ -60,7 +60,7 @@
 		if (r) {

 			printk(KERN_ERR "kvm_iommu_map_address:"

 			       "iommu failed to map pfn=%llx\n", pfn);

-			kvm_unpin_pages(kvm, pfn, page_size);

+			kvm_unpin_pages(kvm, pfn, page_size >> PAGE_SHIFT);

 			goto unmap_pages;

 		}

 

