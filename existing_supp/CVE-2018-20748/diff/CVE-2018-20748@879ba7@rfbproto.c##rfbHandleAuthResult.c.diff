--- before
+++ after
@@ -1,7 +1,6 @@
 rfbHandleAuthResult(rfbClient* client)

 {

-    uint32_t authResult=0, reasonLen=0;

-    char *reason=NULL;

+    uint32_t authResult=0;

 

     if (!ReadFromRFBServer(client, (char *)&authResult, 4)) return FALSE;

 

@@ -16,13 +15,7 @@
       if (client->major==3 && client->minor>7)

       {

         /* we have an error following */

-        if (!ReadFromRFBServer(client, (char *)&reasonLen, 4)) return FALSE;

-        reasonLen = rfbClientSwap32IfLE(reasonLen);

-        reason = malloc((uint64_t)reasonLen+1);

-        if (!ReadFromRFBServer(client, reason, reasonLen)) { free(reason); return FALSE; }

-        reason[reasonLen]=0;

-        rfbClientLog("VNC connection failed: %s\n",reason);

-        free(reason);

+        ReadReason(client);

         return FALSE;

       }

       rfbClientLog("VNC authentication failed\n");

