--- before
+++ after
@@ -7,19 +7,22 @@
                     % locals())

             raise webob.exc.HTTPForbidden(explanation=msg)

 

-        status = 'deleted'

-        if image['location']:

-            if CONF.delayed_delete:

-                status = 'pending_delete'

-                self.store_api.schedule_delayed_delete_from_backend(

-                                image['location'], id)

-            else:

-                self.store_api.safe_delete_from_backend(image['location'],

-                                                        req.context, id)

+        if image['location'] and CONF.delayed_delete:

+            status = 'pending_delete'

+        else:

+            status = 'deleted'

 

         try:

             self.db_api.image_update(req.context, image_id, {'status': status})

             self.db_api.image_destroy(req.context, image_id)

+

+            if image['location']:

+                if CONF.delayed_delete:

+                    self.store_api.schedule_delayed_delete_from_backend(

+                                    image['location'], id)

+                else:

+                    self.store_api.safe_delete_from_backend(image['location'],

+                                                            req.context, id)

         except (exception.NotFound, exception.Forbidden):

             msg = ("Failed to find image %(image_id)s to delete" % locals())

             LOG.info(msg)

