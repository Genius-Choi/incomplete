--- before
+++ after
@@ -10,8 +10,12 @@
 		// don't copy it if we already have the file
 		if (stat(fname, &s) == 0)
 			return;
+		if (is_link(fname)) { // stat on dangling symlinks fails, try again using lstat
+			fprintf(stderr, "Error: invalid %s file\n", fname);
+			exit(1);
+		}
 		if (stat("/etc/skel/.zshrc", &s) == 0) {
-			copy_file("/etc/skel/.zshrc", fname, u, g, 0644);
+			copy_file_as_user("/etc/skel/.zshrc", fname, u, g, 0644);
 			fs_logger("clone /etc/skel/.zshrc");
 		}
 		else {
@@ -29,8 +33,12 @@
 		// don't copy it if we already have the file
 		if (stat(fname, &s) == 0)
 			return;
+		if (is_link(fname)) { // stat on dangling symlinks fails, try again using lstat
+			fprintf(stderr, "Error: invalid %s file\n", fname);
+			exit(1);
+		}
 		if (stat("/etc/skel/.cshrc", &s) == 0) {
-			copy_file("/etc/skel/.cshrc", fname, u, g, 0644);
+			copy_file_as_user("/etc/skel/.cshrc", fname, u, g, 0644);
 			fs_logger("clone /etc/skel/.cshrc");
 		}
 		else {
@@ -48,8 +56,12 @@
 		// don't copy it if we already have the file
 		if (stat(fname, &s) == 0) 
 			return;
+		if (is_link(fname)) { // stat on dangling symlinks fails, try again using lstat
+			fprintf(stderr, "Error: invalid %s file\n", fname);
+			exit(1);
+		}
 		if (stat("/etc/skel/.bashrc", &s) == 0) {
-			copy_file("/etc/skel/.bashrc", fname, u, g, 0644);
+			copy_file_as_user("/etc/skel/.bashrc", fname, u, g, 0644);
 			fs_logger("clone /etc/skel/.bashrc");
 		}
 		free(fname);
