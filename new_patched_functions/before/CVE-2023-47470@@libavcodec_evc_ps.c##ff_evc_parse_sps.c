int ff_evc_parse_sps(GetBitContext *gb, EVCParamSets *ps)
{
    EVCParserSPS *sps;
    unsigned sps_seq_parameter_set_id;
    int ret;

    sps_seq_parameter_set_id = get_ue_golomb(gb);

    if (sps_seq_parameter_set_id >= EVC_MAX_SPS_COUNT)
        return AVERROR_INVALIDDATA;

    sps = av_mallocz(sizeof(*sps));
    if (!sps)
        return AVERROR(ENOMEM);

    sps->sps_seq_parameter_set_id = sps_seq_parameter_set_id;

    // the Baseline profile is indicated by profile_idc eqal to 0
    // the Main profile is indicated by profile_idc eqal to 1
    sps->profile_idc = get_bits(gb, 8);

    sps->level_idc = get_bits(gb, 8);

    skip_bits_long(gb, 32); /* skip toolset_idc_h */
    skip_bits_long(gb, 32); /* skip toolset_idc_l */

    // 0 - monochrome
    // 1 - 4:2:0
    // 2 - 4:2:2
    // 3 - 4:4:4
    sps->chroma_format_idc = get_ue_golomb_31(gb);

    sps->pic_width_in_luma_samples = get_ue_golomb_long(gb);
    sps->pic_height_in_luma_samples = get_ue_golomb_long(gb);

    sps->bit_depth_luma_minus8 = get_ue_golomb_31(gb);
    sps->bit_depth_chroma_minus8 = get_ue_golomb_31(gb);

    sps->sps_btt_flag = get_bits1(gb);
    if (sps->sps_btt_flag) {
        sps->log2_ctu_size_minus2 = get_ue_golomb_long(gb);
        sps->log2_min_cb_size_minus2 = get_ue_golomb_long(gb);
        sps->log2_diff_ctu_max_14_cb_size = get_ue_golomb_long(gb);
        sps->log2_diff_ctu_max_tt_cb_size = get_ue_golomb_long(gb);
        sps->log2_diff_min_cb_min_tt_cb_size_minus2 = get_ue_golomb_long(gb);
    }

    sps->sps_suco_flag = get_bits1(gb);
    if (sps->sps_suco_flag) {
        sps->log2_diff_ctu_size_max_suco_cb_size = get_ue_golomb_long(gb);
        sps->log2_diff_max_suco_min_suco_cb_size = get_ue_golomb_long(gb);
    }

    sps->sps_admvp_flag = get_bits1(gb);
    if (sps->sps_admvp_flag) {
        sps->sps_affine_flag = get_bits1(gb);
        sps->sps_amvr_flag = get_bits1(gb);
        sps->sps_dmvr_flag = get_bits1(gb);
        sps->sps_mmvd_flag = get_bits1(gb);
        sps->sps_hmvp_flag = get_bits1(gb);
    }

    sps->sps_eipd_flag =  get_bits1(gb);
    if (sps->sps_eipd_flag) {
        sps->sps_ibc_flag = get_bits1(gb);
        if (sps->sps_ibc_flag)
            sps->log2_max_ibc_cand_size_minus2 = get_ue_golomb(gb);
    }

    sps->sps_cm_init_flag = get_bits1(gb);
    if (sps->sps_cm_init_flag)
        sps->sps_adcc_flag = get_bits1(gb);

    sps->sps_iqt_flag = get_bits1(gb);
    if (sps->sps_iqt_flag)
        sps->sps_ats_flag = get_bits1(gb);

    sps->sps_addb_flag = get_bits1(gb);
    sps->sps_alf_flag = get_bits1(gb);
    sps->sps_htdf_flag = get_bits1(gb);
    sps->sps_rpl_flag = get_bits1(gb);
    sps->sps_pocs_flag = get_bits1(gb);
    sps->sps_dquant_flag = get_bits1(gb);
    sps->sps_dra_flag = get_bits1(gb);

    if (sps->sps_pocs_flag) {
        sps->log2_max_pic_order_cnt_lsb_minus4 = get_ue_golomb(gb);
        if (sps->log2_max_pic_order_cnt_lsb_minus4 > 12U) {
            ret = AVERROR_INVALIDDATA;
            goto fail;
        }
    }

    if (!sps->sps_pocs_flag || !sps->sps_rpl_flag) {
        sps->log2_sub_gop_length = get_ue_golomb(gb);
        if (sps->log2_sub_gop_length > 5U) {
            ret = AVERROR_INVALIDDATA;
            goto fail;
        }
        if (sps->log2_sub_gop_length == 0)
            sps->log2_ref_pic_gap_length = get_ue_golomb(gb);
    }

    if (!sps->sps_rpl_flag)
        sps->max_num_tid0_ref_pics = get_ue_golomb_31(gb);
    else {
        sps->sps_max_dec_pic_buffering_minus1 = get_ue_golomb_long(gb);
        sps->long_term_ref_pic_flag = get_bits1(gb);
        sps->rpl1_same_as_rpl0_flag = get_bits1(gb);
        sps->num_ref_pic_list_in_sps[0] = get_ue_golomb(gb);

        if ((unsigned)sps->num_ref_pic_list_in_sps[0] >= EVC_MAX_NUM_RPLS) {
            ret = AVERROR_INVALIDDATA;
            goto fail;
        }

        for (int i = 0; i < sps->num_ref_pic_list_in_sps[0]; ++i)
            ref_pic_list_struct(gb, &sps->rpls[0][i]);

        if (!sps->rpl1_same_as_rpl0_flag) {
            sps->num_ref_pic_list_in_sps[1] = get_ue_golomb(gb);
            if ((unsigned)sps->num_ref_pic_list_in_sps[1] >= EVC_MAX_NUM_RPLS) {
                ret = AVERROR_INVALIDDATA;
                goto fail;
            }
            for (int i = 0; i < sps->num_ref_pic_list_in_sps[1]; ++i)
                ref_pic_list_struct(gb, &sps->rpls[1][i]);
        }
    }

    sps->picture_cropping_flag = get_bits1(gb);

    if (sps->picture_cropping_flag) {
        sps->picture_crop_left_offset = get_ue_golomb_long(gb);
        sps->picture_crop_right_offset = get_ue_golomb_long(gb);
        sps->picture_crop_top_offset = get_ue_golomb_long(gb);
        sps->picture_crop_bottom_offset = get_ue_golomb_long(gb);
    }

    if (sps->chroma_format_idc != 0) {
        sps->chroma_qp_table_struct.chroma_qp_table_present_flag = get_bits1(gb);

        if (sps->chroma_qp_table_struct.chroma_qp_table_present_flag) {
            sps->chroma_qp_table_struct.same_qp_table_for_chroma = get_bits1(gb);
            sps->chroma_qp_table_struct.global_offset_flag = get_bits1(gb);
            for (int i = 0; i < (sps->chroma_qp_table_struct.same_qp_table_for_chroma ? 1 : 2); i++) {
                sps->chroma_qp_table_struct.num_points_in_qp_table_minus1[i] = get_ue_golomb(gb);
                if (sps->chroma_qp_table_struct.num_points_in_qp_table_minus1[i] >= EVC_MAX_QP_TABLE_SIZE) {
                    ret = AVERROR_INVALIDDATA;
                    goto fail;
                }
                for (int j = 0; j <= sps->chroma_qp_table_struct.num_points_in_qp_table_minus1[i]; j++) {
                    sps->chroma_qp_table_struct.delta_qp_in_val_minus1[i][j] = get_bits(gb, 6);
                    sps->chroma_qp_table_struct.delta_qp_out_val[i][j] = get_se_golomb_long(gb);
                }
            }
        }
    }

    sps->vui_parameters_present_flag = get_bits1(gb);
    if (sps->vui_parameters_present_flag)
        vui_parameters(gb, &(sps->vui_parameters));

    // @note
    // If necessary, add the missing fields to the EVCParserSPS structure
    // and then extend parser implementation

    av_freep(&ps->sps[sps_seq_parameter_set_id]);
    ps->sps[sps_seq_parameter_set_id] = sps;

    return 0;
fail:
    av_free(sps);
    return ret;
}
