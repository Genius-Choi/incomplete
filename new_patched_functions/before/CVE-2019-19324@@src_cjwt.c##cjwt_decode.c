int cjwt_decode( const char *encoded, unsigned int options, cjwt_t **jwt,
                 const uint8_t *key, size_t key_len )
{
    int ret = 0;
    char *payload, *signature;
    ( void )options; //suppressing unused parameter warning
    ( void ) options;

    //validate inputs
    if( !encoded || !jwt ) {
        cjwt_error( "null parameter\n" );
        ret = EINVAL;
        goto error;
    }

    cjwt_info( "parameters cjwt_decode()\n encoded : %s\n options : %d\n", encoded, options );
    //create copy
    char *enc_token = malloc( strlen( encoded ) + 1 );

    if( !enc_token ) {
        cjwt_error( "memory alloc failed\n" );
        ret = ENOMEM;
        goto error;
    }

    strcpy( enc_token, encoded );

    //tokenize the jwt token
    for( payload = enc_token; payload[0] != '.'; payload++ ) {
        if( payload[0] == '\0' ) {
            cjwt_error( "Invalid jwt token,has only header\n" );
            ret = EINVAL;
            goto end;
        }
    }

    payload[0] = '\0';
    payload++;

    for( signature = payload; signature[0] != '.'; signature++ ) {
        if( signature[0] == '\0' ) {
            cjwt_error( "Invalid jwt token,missing signature\n" );
            ret = EINVAL;
            goto end;
        }
    }

    signature[0] = '\0';
    signature++;
    //create cjson
    cjwt_t *out = cjwt_create();

    if( !out ) {
        cjwt_error( "cjwt memory alloc failed\n" );
        ret = ENOMEM;
        goto end;
    }

    //populate key
    ret = cjwt_update_key( out, key, key_len );

    if( ret ) {
        cjwt_error( "Failed to update key\n" );
        goto invalid;
    }

    //parse header
    ret = cjwt_parse_header( out, enc_token );

    if( ret ) {
        cjwt_error( "Invalid header\n" );
        goto invalid;
    }

    //parse payload
    ret = cjwt_parse_payload( out, payload );

    if( ret ) {
        cjwt_error( "Invalid payload\n" );
        goto invalid;
    }

    if( out->header.alg != alg_none ) {
        enc_token[strlen( enc_token )] = '.';
        //verify
        ret = cjwt_verify_signature( out, enc_token, signature );

        if( ret ) {
            cjwt_error( "\nSignature authentication failed\n" );
            goto invalid;
        }

        cjwt_info( "\nSignature authentication passed\n" );
    }

invalid:

    if( ret ) {
        cjwt_destroy( &out );
        *jwt = NULL;
    } else {
        *jwt = out;
    }

end:
    free( enc_token );
error:
    return ret;
}
