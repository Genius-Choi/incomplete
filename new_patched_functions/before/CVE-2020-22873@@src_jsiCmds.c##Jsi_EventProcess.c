int Jsi_EventProcess(Jsi_Interp *interp, int maxEvents)
{
    Jsi_Event *evPtr;
    Jsi_HashEntry *hPtr;
    Jsi_HashSearch search;
    Jsi_Value* nret = NULL;
    Jsi_RC rc;
    int cnt = 0, newIdx = interp->eventIdx;
    long cur_sec, cur_ms;
    jsiGetTime(&cur_sec, &cur_ms);
    Jsi_Value *vpargs = NULL;

    /*if (Jsi_MutexLock(interp, interp->Mutex) != JSI_OK)
        return JSI_ERROR;*/

    for (hPtr = Jsi_HashSearchFirst(interp->eventTbl, &search);
            hPtr != NULL; hPtr = Jsi_HashSearchNext(&search)) {

        if (!(evPtr = (Jsi_Event*)Jsi_HashValueGet(hPtr)))
            continue;
        SIGASSERT(evPtr,EVENT);
        if ((int)evPtr->id > newIdx) /* Avoid infinite loop of event creating events. */
            continue;
        switch (evPtr->evType) {
        case JSI_EVENT_SIGNAL:
#ifndef JSI_OMIT_SIGNAL   /* TODO: win signals? */
            if (!jsi_SignalIsSet(interp, evPtr->sigNum))
                continue;
            jsi_SignalClear(interp, evPtr->sigNum);
#endif
            break;
        case JSI_EVENT_TIMER:
            if (cur_sec <= evPtr->when_sec && (cur_sec != evPtr->when_sec || cur_ms < evPtr-> when_ms)) {
                if (evPtr->when_sec && evPtr->when_ms)
                    continue;
            }
            cnt++;
            evPtr->count++;
            break;
        case JSI_EVENT_ALWAYS:
            break;
        default:
            assert(0);
        }
        if (evPtr->busy)
            continue;
        evPtr->busy = 1;
        if (evPtr->handler) {
            rc = evPtr->handler(interp, evPtr->data);
        } else {
            if (vpargs == NULL) {
                vpargs = Jsi_ValueMakeObject(interp, NULL, Jsi_ObjNewArray(interp, NULL, 0, 0));
                Jsi_IncrRefCount(interp, vpargs);
            }
            if (!nret)
                nret = Jsi_ValueNew1(interp);
            rc = Jsi_FunctionInvoke(interp, evPtr->funcVal, vpargs, &nret, NULL);
        }
        evPtr->busy = 0;
        if (interp->deleting) {
            cnt = -1;
            goto bail;
        }
        if (rc != JSI_OK) {
            if (interp->exited) {
                cnt = rc;
                goto bail;
            }
            Jsi_LogError("event function call failure");
        }
        if (evPtr->once) {
            Jsi_EventFree(interp, evPtr);
        } else {
            evPtr->when_sec = cur_sec + evPtr->initialms / 1000;
            evPtr->when_ms = cur_ms + evPtr->initialms % 1000;
            if (evPtr->when_ms >= 1000) {
                evPtr->when_sec++;
                evPtr->when_ms -= 1000;
            }
        }
        if (maxEvents>=0 && cnt>=maxEvents)
            break;
    }
bail:
    if (vpargs)
        Jsi_DecrRefCount(interp, vpargs);
    if (nret)
        Jsi_DecrRefCount(interp, nret);
    /*Jsi_MutexUnlock(interp, interp->Mutex);*/

    static int evCnt = 0;
    evCnt++;
    if (interp->parent && interp->busyCallback)
        Jsi_EventProcess(interp->parent, maxEvents);
    return cnt;
}
