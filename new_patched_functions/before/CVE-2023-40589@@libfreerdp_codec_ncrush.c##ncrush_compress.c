int ncrush_compress(NCRUSH_CONTEXT* ncrush, const BYTE* pSrcData, UINT32 SrcSize, BYTE* pDstBuffer,
                    const BYTE** ppDstData, UINT32* pDstSize, UINT32* pFlags)
{
	BYTE Literal;
	const BYTE* SrcPtr;
	BYTE* DstPtr;
	UINT32 bits;
	UINT32 offset;
	UINT16 Mask;
	UINT32 MaskedBits;
	UINT32 accumulator;
	const BYTE* SrcEndPtr;
	BYTE* DstEndPtr;
	BYTE* HistoryPtr;
	BYTE* pDstData;
	UINT32 DstSize;
	BOOL PacketAtFront = FALSE;
	BOOL PacketFlushed = FALSE;
	UINT32 MatchLength;
	UINT32 IndexLEC;
	UINT32 IndexLOM;
	UINT32 IndexCO;
	UINT32 CodeLEC;
	UINT32 BitLength;
	UINT32 CopyOffset;
	UINT32 MatchOffset;
	UINT32 OldCopyOffset;
	UINT32* OffsetCache;
	UINT32 OffsetCacheIndex;
	UINT32 HistoryOffset;
	BYTE* HistoryBuffer;
	UINT32 HistoryBufferSize;
	BYTE* HistoryBufferEndPtr;
	UINT32 CopyOffsetIndex;
	UINT32 CopyOffsetBits;
	UINT32 CompressionLevel = 2;

	WINPR_ASSERT(ncrush);

	WINPR_ASSERT(ncrush);
	WINPR_ASSERT(pSrcData);
	WINPR_ASSERT(pDstBuffer);
	WINPR_ASSERT(ppDstData);
	WINPR_ASSERT(pDstSize);
	WINPR_ASSERT(pFlags);

	HistoryBuffer = ncrush->HistoryBuffer;
	*pFlags = 0;

	if ((SrcSize + ncrush->HistoryOffset) >= 65529)
	{
		if (ncrush->HistoryOffset == (ncrush->HistoryBufferSize + 1))
		{
			ncrush->HistoryOffset = 0;
			ncrush->HistoryPtr = HistoryBuffer;
			PacketFlushed = TRUE;
		}
		else
		{
			if (ncrush_move_encoder_windows(ncrush, &(HistoryBuffer[ncrush->HistoryOffset])) < 0)
				return -1001;

			ncrush->HistoryPtr = &HistoryBuffer[32768];
			ncrush->HistoryOffset = 32768;
			PacketAtFront = TRUE;
		}
	}
	else
	{
		*pFlags = 0;
	}

	pDstData = pDstBuffer;
	*ppDstData = pDstBuffer;

	if (!pDstData)
		return -1002;

	DstSize = *pDstSize;

	if (DstSize < SrcSize)
		return -1003;

	DstSize = SrcSize;
	NCrushWriteStart(&bits, &offset, &accumulator);
	DstPtr = pDstData;
	SrcPtr = pSrcData;
	SrcEndPtr = &pSrcData[SrcSize];
	DstEndPtr = &pDstData[DstSize - 1];
	OffsetCache = ncrush->OffsetCache;
	HistoryPtr = &HistoryBuffer[ncrush->HistoryOffset];
	HistoryBufferEndPtr = &HistoryBuffer[65536];
	HistoryBufferSize = ncrush->HistoryBufferSize;
	CopyOffset = 0;
	MatchOffset = 0;
	const intptr_t thsize = HistoryPtr - HistoryBuffer;
	WINPR_ASSERT(thsize >= 0);
	WINPR_ASSERT(thsize <= UINT32_MAX);
	ncrush_hash_table_add(ncrush, pSrcData, SrcSize, (UINT32)thsize);
	CopyMemory(HistoryPtr, pSrcData, SrcSize);
	ncrush->HistoryPtr = &HistoryPtr[SrcSize];

	while (SrcPtr < (SrcEndPtr - 2))
	{
		MatchLength = 0;
		const intptr_t hsize = HistoryPtr - HistoryBuffer;
		WINPR_ASSERT(hsize <= UINT32_MAX);
		WINPR_ASSERT(hsize >= 0);
		HistoryOffset = (UINT32)hsize;

		if (ncrush->HistoryPtr && (HistoryPtr > ncrush->HistoryPtr))
			return -1;

		if (HistoryOffset >= 65536)
			return -1004;

		if (ncrush->MatchTable[HistoryOffset])
		{
			int rc;

			MatchOffset = 0;
			rc = ncrush_find_best_match(ncrush, HistoryOffset, &MatchOffset);

			if (rc < 0)
				return -1005;
			MatchLength = (UINT32)rc;
		}

		if (MatchLength)
			CopyOffset = (HistoryBufferSize - 1) & (HistoryPtr - &HistoryBuffer[MatchOffset]);

		if ((MatchLength == 2) && (CopyOffset >= 64))
			MatchLength = 0;

		if (MatchLength == 0)
		{
			/* Literal */
			Literal = *SrcPtr++;
			HistoryPtr++;

			if ((DstPtr + 2) > DstEndPtr) /* PACKET_FLUSH #1 */
			{
				ncrush_context_reset(ncrush, TRUE);
				*pFlags = PACKET_FLUSHED;
				*pFlags |= CompressionLevel;
				*ppDstData = pSrcData;
				*pDstSize = SrcSize;
				return 1;
			}

			IndexLEC = Literal;
			BitLength = HuffLengthLEC[IndexLEC];
			CodeLEC = get_word(&HuffCodeLEC[IndexLEC * 2]);

			if (BitLength > 15)
				return -1006;

			NCrushWriteBits(&DstPtr, &accumulator, &offset, CodeLEC, BitLength);
		}
		else
		{
			HistoryPtr += MatchLength;
			SrcPtr += MatchLength;

			if (!MatchLength)
				return -1007;

			if ((DstPtr + 8) > DstEndPtr) /* PACKET_FLUSH #2 */
			{
				ncrush_context_reset(ncrush, TRUE);
				*pFlags = PACKET_FLUSHED;
				*pFlags |= CompressionLevel;
				*ppDstData = pSrcData;
				*pDstSize = SrcSize;
				return 1;
			}

			OffsetCacheIndex = 5;

			if ((CopyOffset == OffsetCache[0]) || (CopyOffset == OffsetCache[1]) ||
			    (CopyOffset == OffsetCache[2]) || (CopyOffset == OffsetCache[3]))
			{
				if (CopyOffset == OffsetCache[3])
				{
					OldCopyOffset = OffsetCache[3];
					OffsetCache[3] = OffsetCache[0];
					OffsetCache[0] = OldCopyOffset;
					OffsetCacheIndex = 3;
				}
				else
				{
					if (CopyOffset == OffsetCache[2])
					{
						OldCopyOffset = OffsetCache[2];
						OffsetCache[2] = OffsetCache[0];
						OffsetCache[0] = OldCopyOffset;
						OffsetCacheIndex = 2;
					}
					else
					{
						if (CopyOffset == OffsetCache[1])
						{
							OldCopyOffset = OffsetCache[1];
							OffsetCache[1] = OffsetCache[0];
							OffsetCache[0] = OldCopyOffset;
							OffsetCacheIndex = 1;
						}
						else
						{
							if (CopyOffset == OffsetCache[0])
							{
								OffsetCacheIndex = 0;
							}
						}
					}
				}
			}
			else
			{
				OffsetCache[3] = OffsetCache[2];
				OffsetCache[2] = OffsetCache[1];
				OffsetCache[1] = OffsetCache[0];
				OffsetCache[0] = CopyOffset;
			}

			if (OffsetCacheIndex >= 4)
			{
				/* CopyOffset not in OffsetCache */
				if (CopyOffset >= 256)
					bits = (CopyOffset >> 7) + 256;
				else
					bits = CopyOffset;

				CopyOffsetIndex = ncrush->HuffTableCopyOffset[bits + 2];
				CopyOffsetBits = CopyOffsetBitsLUT[CopyOffsetIndex];
				IndexLEC = 257 + CopyOffsetIndex;
				BitLength = HuffLengthLEC[IndexLEC];
				CodeLEC = get_word(&HuffCodeLEC[IndexLEC * 2]);

				if (BitLength > 15)
					return -1008;

				if (CopyOffsetBits > 18)
					return -1009;

				NCrushWriteBits(&DstPtr, &accumulator, &offset, CodeLEC, BitLength);
				Mask = ((1 << CopyOffsetBits) - 1);
				MaskedBits = CopyOffset & Mask;
				NCrushWriteBits(&DstPtr, &accumulator, &offset, MaskedBits, CopyOffsetBits);

				if ((MatchLength - 2) >= 768)
					IndexCO = 28;
				else
					IndexCO = ncrush->HuffTableLOM[MatchLength];

				BitLength = HuffLengthLOM[IndexCO];
				IndexLOM = LOMBitsLUT[IndexCO];
				NCrushWriteBits(&DstPtr, &accumulator, &offset, HuffCodeLOM[IndexCO], BitLength);
				Mask = ((1 << IndexLOM) - 1);
				MaskedBits = (MatchLength - 2) & Mask;
				NCrushWriteBits(&DstPtr, &accumulator, &offset, MaskedBits, IndexLOM);

				if ((MaskedBits + LOMBaseLUT[IndexCO]) != MatchLength)
					return -1010;
			}
			else
			{
				/* CopyOffset in OffsetCache */
				IndexLEC = 289 + OffsetCacheIndex;
				BitLength = HuffLengthLEC[IndexLEC];
				CodeLEC = get_word(&HuffCodeLEC[IndexLEC * 2]);

				if (BitLength >= 15)
					return -1011;

				NCrushWriteBits(&DstPtr, &accumulator, &offset, CodeLEC, BitLength);

				if ((MatchLength - 2) >= 768)
					IndexCO = 28;
				else
					IndexCO = ncrush->HuffTableLOM[MatchLength];

				BitLength = HuffLengthLOM[IndexCO];
				IndexLOM = LOMBitsLUT[IndexCO];
				NCrushWriteBits(&DstPtr, &accumulator, &offset, HuffCodeLOM[IndexCO], BitLength);
				Mask = ((1 << IndexLOM) - 1);
				MaskedBits = (MatchLength - 2) & Mask;
				NCrushWriteBits(&DstPtr, &accumulator, &offset, MaskedBits, IndexLOM);

				if ((MaskedBits + LOMBaseLUT[IndexCO]) != MatchLength)
					return -1012;
			}
		}

		if (HistoryPtr >= HistoryBufferEndPtr)
			return -1013;
	}

	while (SrcPtr < SrcEndPtr)
	{
		if ((DstPtr + 2) > DstEndPtr) /* PACKET_FLUSH #3 */
		{
			ncrush_context_reset(ncrush, TRUE);
			*pFlags = PACKET_FLUSHED;
			*pFlags |= CompressionLevel;
			*ppDstData = pSrcData;
			*pDstSize = SrcSize;
			return 1;
		}

		Literal = *SrcPtr++;
		HistoryPtr++;
		IndexLEC = Literal;
		BitLength = HuffLengthLEC[IndexLEC];
		CodeLEC = get_word(&HuffCodeLEC[IndexLEC * 2]);

		if (BitLength > 15)
			return -1014;

		NCrushWriteBits(&DstPtr, &accumulator, &offset, CodeLEC, BitLength);
	}

	if ((DstPtr + 4) >= DstEndPtr) /* PACKET_FLUSH #4 */
	{
		ncrush_context_reset(ncrush, TRUE);
		*pFlags = PACKET_FLUSHED;
		*pFlags |= CompressionLevel;
		*ppDstData = pSrcData;
		*pDstSize = SrcSize;
		return 1;
	}

	IndexLEC = 256;
	BitLength = HuffLengthLEC[IndexLEC];

	if (BitLength > 15)
		return -1015;

	bits = get_word(&HuffCodeLEC[IndexLEC * 2]);
	NCrushWriteBits(&DstPtr, &accumulator, &offset, bits, BitLength);
	NCrushWriteFinish(&DstPtr, accumulator);
	const intptr_t dsize = DstPtr - pDstData;
	WINPR_ASSERT(dsize <= UINT32_MAX);
	WINPR_ASSERT(dsize >= 0);
	*pDstSize = (UINT32)dsize;

	if (*pDstSize > SrcSize)
		return -1016;

	*pFlags |= PACKET_COMPRESSED;
	*pFlags |= CompressionLevel;

	if (PacketAtFront)
		*pFlags |= PACKET_AT_FRONT;

	if (PacketFlushed)
		*pFlags |= PACKET_FLUSHED;

	ncrush->HistoryOffset = HistoryPtr - HistoryBuffer;

	if (ncrush->HistoryOffset >= ncrush->HistoryBufferSize)
		return -1;

	return 1;
}
