char *gf_text_get_utf8_line(char *szLine, u32 lineSize, FILE *txt_in, s32 unicode_type)
{
	u32 i, j, len;
	char *sOK;
	char szLineConv[1024];
	unsigned short *sptr;

	memset(szLine, 0, sizeof(char)*lineSize);
	sOK = fgets(szLine, lineSize, txt_in);
	if (!sOK) return NULL;
	if (unicode_type<=1) {
		j=0;
		len = (u32) strlen(szLine);
		for (i=0; i<len && j < sizeof(szLineConv) - 1; i++, j++) {

			if (!unicode_type && (szLine[i] & 0x80)) {
				/*non UTF8 (likely some win-CP)*/
				if ((szLine[i+1] & 0xc0) != 0x80) {
					if (j + 1 < sizeof(szLineConv) - 1) {
						szLineConv[j] = 0xc0 | ((szLine[i] >> 6) & 0x3);
						j++;
						szLine[i] &= 0xbf;
					}
					else
						break;
				}
				/*UTF8 2 bytes char*/
				else if ( (szLine[i] & 0xe0) == 0xc0) {

					// don't cut multibyte in the middle in there is no more room in dest
					if (j + 1 < sizeof(szLineConv) - 1 && i + 1 < len) {
						szLineConv[j] = szLine[i];
						i++;
						j++;
					}
					else {
						break;
					}
				}
				/*UTF8 3 bytes char*/
				else if ( (szLine[i] & 0xf0) == 0xe0) {
					if (j + 2 < sizeof(szLineConv) - 1 && i + 2 < len) {
						szLineConv[j] = szLine[i];
						i++;
						j++;
						szLineConv[j] = szLine[i];
						i++;
						j++;
					}
					else {
						break;
					}
				}
				/*UTF8 4 bytes char*/
				else if ( (szLine[i] & 0xf8) == 0xf0) {
					if (j + 3 < sizeof(szLineConv) - 1 && i + 3 < len) {
						szLineConv[j] = szLine[i];
						i++;
						j++;
						szLineConv[j] = szLine[i];
						i++;
						j++;
						szLineConv[j] = szLine[i];
						i++;
						j++;
					}
					else {
						break;
					}
				} else {
					i+=1;
					continue;
				}
			}
			if (j < sizeof(szLineConv)-1 && i<len)
				szLineConv[j] = szLine[i];

		}
		if (j >= sizeof(szLineConv))
			szLineConv[sizeof(szLineConv) - 1] = 0;
		else
			szLineConv[j] = 0;

		strcpy(szLine, szLineConv);
		return sOK;
	}

#ifdef GPAC_BIG_ENDIAN
	if (unicode_type==3) {
#else
	if (unicode_type==2) {
#endif
		i=0;
		while (1) {
			char c;
			if (!szLine[i] && !szLine[i+1]) break;
			c = szLine[i+1];
			szLine[i+1] = szLine[i];
			szLine[i] = c;
			i+=2;
		}
	}
	sptr = (u16 *)szLine;
	i = (u32) gf_utf8_wcstombs(szLineConv, 1024, (const unsigned short **) &sptr);
	if (i >= (u32)ARRAY_LENGTH(szLineConv))
		return NULL;
	szLineConv[i] = 0;
	strcpy(szLine, szLineConv);
	/*this is ugly indeed: since input is UTF16-LE, there are many chances the fgets never reads the \0 after a \n*/
	if (unicode_type==3) fgetc(txt_in);
	return sOK;
}
