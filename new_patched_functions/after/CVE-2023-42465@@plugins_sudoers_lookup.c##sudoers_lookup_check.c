sudoers_lookup_check(struct sudo_nss *nss, struct sudoers_context *ctx,
    unsigned int *validated, struct cmnd_info *info, time_t now,
    sudoers_lookup_callback_fn_t callback, void *cb_data,
    struct cmndspec **matching_cs, struct defaults_list **defs)
{
    struct cmndspec *cs;
    struct privilege *priv;
    struct userspec *us;
    struct member *matching_user;
    debug_decl(sudoers_lookup_check, SUDOERS_DEBUG_PARSER);

    init_cmnd_info(ctx, info);

    TAILQ_FOREACH_REVERSE(us, &nss->parse_tree->userspecs, userspec_list, entries) {
	int user_match = userlist_matches(nss->parse_tree, ctx->user.pw, &us->users);
	if (user_match != ALLOW) {
	    if (callback != NULL && user_match == DENY) {
		callback(nss->parse_tree, us, user_match, NULL, UNSPEC, NULL,
		    UNSPEC, UNSPEC, UNSPEC, cb_data);
	    }
	    continue;
	}
	CLR(*validated, FLAG_NO_USER);
	TAILQ_FOREACH_REVERSE(priv, &us->privileges, privilege_list, entries) {
	    int host_match = hostlist_matches(nss->parse_tree, ctx->user.pw,
		&priv->hostlist);
	    if (host_match == ALLOW) {
		CLR(*validated, FLAG_NO_HOST);
	    } else {
		if (callback != NULL) {
		    callback(nss->parse_tree, us, user_match, priv, host_match,
			NULL, UNSPEC, UNSPEC, UNSPEC, cb_data);
		}
		continue;
	    }
	    TAILQ_FOREACH_REVERSE(cs, &priv->cmndlist, cmndspec_list, entries) {
		int cmnd_match = UNSPEC;
		int date_match = UNSPEC;
		int runas_match = UNSPEC;

		if (cs->notbefore != UNSPEC) {
		    date_match = now < cs->notbefore ? DENY : ALLOW;
		}
		if (cs->notafter != UNSPEC) {
		    date_match = now > cs->notafter ? DENY : ALLOW;
		}
		if (date_match != DENY) {
		    matching_user = NULL;
		    runas_match = runaslist_matches(nss->parse_tree,
			cs->runasuserlist, cs->runasgrouplist, &matching_user,
			NULL);
		    if (runas_match == ALLOW) {
			cmnd_match = cmnd_matches(nss->parse_tree, cs->cmnd,
			    cs->runchroot, info);
		    }
		}
		if (callback != NULL) {
		    callback(nss->parse_tree, us, user_match, priv, host_match,
			cs, date_match, runas_match, cmnd_match, cb_data);
		}

		if (SPECIFIED(cmnd_match)) {
		    /*
		     * If user is running command as themselves,
		     * set ctx->runas.pw = ctx->user.pw.
		     * XXX - hack, want more general solution
		     */
		    if (matching_user && matching_user->type == MYSELF) {
			sudo_pw_delref(ctx->runas.pw);
			sudo_pw_addref(ctx->user.pw);
			ctx->runas.pw = ctx->user.pw;
		    }
		    *matching_cs = cs;
		    *defs = &priv->defaults;
		    sudo_debug_printf(SUDO_DEBUG_DEBUG|SUDO_DEBUG_LINENO,
			"userspec matched @ %s:%d:%d: %s",
			us->file ? us->file : "???", us->line, us->column,
			cmnd_match ? "allowed" : "denied");
		    debug_return_int(cmnd_match);
		}
		free(info->cmnd_path);
		init_cmnd_info(ctx, info);
	    }
	}
    }
    debug_return_int(UNSPEC);
}
