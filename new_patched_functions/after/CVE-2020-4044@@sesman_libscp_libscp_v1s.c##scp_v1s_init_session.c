scp_v1s_init_session(struct SCP_CONNECTION *c, struct SCP_SESSION *session)
{
    tui8 type;
    tui16 height;
    tui16 width;
    tui8 bpp;
    tui8 sz;
    char buf[256];

    scp_session_set_version(session, 1);

    /* Check there's data for the session type, the height, the width, the
     * bpp, the resource sharing indicator and the locale */
    if (!s_check_rem(c->in_s, 1 + 2 + 2 + 1 + 1 + 17))
    {
        log_message(LOG_LEVEL_WARNING,
                    "[v1s:%d] connection aborted: short packet",
                    __LINE__);
        return SCP_SERVER_STATE_SIZE_ERR;
    }

    in_uint8(c->in_s, type);

    if ((type != SCP_SESSION_TYPE_XVNC) && (type != SCP_SESSION_TYPE_XRDP))
    {
        log_message(LOG_LEVEL_WARNING, "[v1s:%d] connection aborted: unknown session type", __LINE__);
        return SCP_SERVER_STATE_SESSION_TYPE_ERR;
    }

    scp_session_set_type(session, type);

    in_uint16_be(c->in_s, height);
    scp_session_set_height(session, height);
    in_uint16_be(c->in_s, width);
    scp_session_set_width(session, width);
    in_uint8(c->in_s, bpp);
    if (0 != scp_session_set_bpp(session, bpp))
    {
        log_message(LOG_LEVEL_WARNING,
                    "[v1s:%d] connection aborted: unsupported bpp: %d",
                    __LINE__, bpp);
        return SCP_SERVER_STATE_INTERNAL_ERR;
    }
    in_uint8(c->in_s, sz);
    scp_session_set_rsr(session, sz);
    in_uint8a(c->in_s, buf, 17);
    buf[17] = '\0';
    scp_session_set_locale(session, buf);

    /* Check there's enough data left for at least an IPv4 address (+len) */
    if (!s_check_rem(c->in_s, 1 + 4))
    {
        log_message(LOG_LEVEL_WARNING,
                    "[v1s:%d] connection aborted: IP addr len missing",
                    __LINE__);
        return SCP_SERVER_STATE_SIZE_ERR;
    }

    in_uint8(c->in_s, sz);

    if (sz == SCP_ADDRESS_TYPE_IPV4)
    {
        tui32 ipv4;
        in_uint32_be(c->in_s, ipv4);
        scp_session_set_addr(session, sz, &ipv4);
    }
    else if (sz == SCP_ADDRESS_TYPE_IPV6)
    {
        if (!s_check_rem(c->in_s, 16))
        {
            log_message(LOG_LEVEL_WARNING,
                        "[v1s:%d] connection aborted: IP addr missing",
                        __LINE__);
            return SCP_SERVER_STATE_SIZE_ERR;
        }
        in_uint8a(c->in_s, buf, 16);
        scp_session_set_addr(session, sz, buf);
    }

    /* reading hostname */
    if (!in_string8(c->in_s, buf, "hostname", __LINE__))
    {
        return SCP_SERVER_STATE_SIZE_ERR;
    }

    if (0 != scp_session_set_hostname(session, buf))
    {
        log_message(LOG_LEVEL_WARNING, "[v1s:%d] connection aborted: internal error", __LINE__);
        return SCP_SERVER_STATE_INTERNAL_ERR;
    }

    /* reading username */
    if (!in_string8(c->in_s, buf, "username", __LINE__))
    {
        return SCP_SERVER_STATE_SIZE_ERR;
    }

    if (0 != scp_session_set_username(session, buf))
    {
        log_message(LOG_LEVEL_WARNING, "[v1s:%d] connection aborted: internal error", __LINE__);
        return SCP_SERVER_STATE_INTERNAL_ERR;
    }

    /* reading password */
    if (!in_string8(c->in_s, buf, "passwd", __LINE__))
    {
        return SCP_SERVER_STATE_SIZE_ERR;
    }

    if (0 != scp_session_set_password(session, buf))
    {
        log_message(LOG_LEVEL_WARNING, "[v1s:%d] connection aborted: internal error", __LINE__);
        return SCP_SERVER_STATE_INTERNAL_ERR;
    }

    return SCP_SERVER_STATE_OK;
}
