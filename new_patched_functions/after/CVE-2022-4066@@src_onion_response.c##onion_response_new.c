onion_response *onion_response_new(onion_request * req) {
  onion_response *res = onion_low_malloc(sizeof(onion_response));

  res->request = req;
  res->headers = onion_dict_new();
  res->code = 200;              // The most normal code, so no need to overwrite it in other codes.
  res->flags = 0;
  res->sent_bytes_total = res->length = res->sent_bytes = 0;
  res->buffer_pos = 0;

#ifndef DONT_USE_DATE_HEADER
  {
    time_t t;
    struct tm tmp;

    t = time(NULL);

    // onion_response_last_date_header is set to t later. It should be more or less atomic.
    // If not no big deal, as we will just use slightly more CPU on those "ephemeral" moments.

    time_t current = __sync_add_and_fetch(&onion_response_last_time, 0);

    if (t != current) {
      ONION_DEBUG("Recalculating date header");
      char current_datetime[200];

      if (localtime_r(&t, &tmp) == NULL) {
        perror("localtime");
        exit(EXIT_FAILURE);
      }

      if (strftime
          (current_datetime, sizeof(current_datetime),
           "%a, %d %b %Y %H:%M:%S %Z", &tmp) == 0) {
        fprintf(stderr, "strftime returned 0");
        exit(EXIT_FAILURE);
      }
#ifdef HAVE_PTHREADS
      pthread_rwlock_wrlock(&onion_response_date_lock);
#endif
      __sync_bool_compare_and_swap(&onion_response_last_time, current, t);
      if (onion_response_last_date_header)
        onion_low_free(onion_response_last_date_header);
      onion_response_last_date_header = onion_low_strdup(current_datetime);
#ifdef HAVE_PTHREADS
      pthread_rwlock_unlock(&onion_response_date_lock);
#endif
    }
  }
#ifdef HAVE_PTHREADS
  pthread_rwlock_rdlock(&onion_response_date_lock);
#endif
  assert(onion_response_last_date_header);
  onion_dict_add(res->headers, "Date", onion_response_last_date_header,
                 OD_DUP_VALUE);
#ifdef HAVE_PTHREADS
  pthread_rwlock_unlock(&onion_response_date_lock);
#endif
#endif                          // USE_DATE_HEADER
  // Sorry for the advertisment.
  onion_dict_add(res->headers, "Server",
                 "libonion v" ONION_VERSION " - coralbits.com", 0);
  onion_dict_add(res->headers, "Content-Type", "text/html", 0); // Maybe not the best guess, but really useful.
  //time_t t=time(NULL);
  //onion_dict_add(res->headers, "Date", asctime(localtime(&t)), OD_DUP_VALUE);

  return res;
}
