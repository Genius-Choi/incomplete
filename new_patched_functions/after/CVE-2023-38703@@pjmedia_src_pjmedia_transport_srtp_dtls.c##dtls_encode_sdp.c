static pj_status_t dtls_encode_sdp( pjmedia_transport *tp,
                                    pj_pool_t *sdp_pool,
                                    pjmedia_sdp_session *sdp_local,
                                    const pjmedia_sdp_session *sdp_remote,
                                    unsigned media_index)
{
    dtls_srtp *ds = (dtls_srtp *)tp;
    pjmedia_sdp_media *m_loc;
    pjmedia_sdp_attr *a;
    pj_bool_t use_ice = PJ_FALSE;
    pj_status_t status = PJ_SUCCESS;

#if DTLS_DEBUG
    PJ_LOG(2,(ds->base.name, "dtls_encode_sdp()"));
#endif

    PJ_UNUSED_ARG(sdp_pool);

    m_loc = sdp_local->media[media_index];
    if (ds->srtp->offerer_side) {
        /* As offerer */

        /* Add attribute a=setup if none (rfc5763 section 5) */
        a = pjmedia_sdp_media_find_attr(m_loc, &ID_SETUP, NULL);
        if (!a)
            a = pjmedia_sdp_attr_find(sdp_local->attr_count,
                                      sdp_local->attr, &ID_SETUP, NULL);
        if (!a) {
            pj_str_t val;

            if (ds->setup == DTLS_SETUP_UNKNOWN)
                ds->setup = DTLS_SETUP_ACTPASS;
            
            if (ds->setup == DTLS_SETUP_ACTIVE)
                val = ID_ACTIVE;
            else if (ds->setup == DTLS_SETUP_PASSIVE)
                val = ID_PASSIVE;
            else
                val = ID_ACTPASS;
            a = pjmedia_sdp_attr_create(ds->pool, ID_SETUP.ptr, &val);
            pjmedia_sdp_media_add_attr(m_loc, a);
        }
    } else {
        /* As answerer */
        dtls_setup last_setup = ds->setup;
        pj_str_t last_rem_fp = ds->rem_fingerprint;
        pj_bool_t rem_addr_changed = PJ_FALSE;

        /* Parse a=setup and a=fingerprint */
        status = parse_setup_finger_attr(ds, PJ_TRUE, sdp_remote,
                                         media_index);
        if (status != PJ_SUCCESS)
            goto on_return;

        /* Add attribute a=setup:active/passive if we are client/server. */
        a = pjmedia_sdp_attr_create(ds->pool, ID_SETUP.ptr,
                    (ds->setup==DTLS_SETUP_ACTIVE? &ID_ACTIVE:&ID_PASSIVE));
        pjmedia_sdp_media_add_attr(m_loc, a);

        if (last_setup != DTLS_SETUP_UNKNOWN) {
            pj_sockaddr rem_rtp;
            pj_sockaddr rem_rtcp;
            pj_bool_t use_rtcp_mux;

            status = get_rem_addrs(ds, sdp_remote, media_index, &rem_rtp,
                                   &rem_rtcp, &use_rtcp_mux);
            if (status == PJ_SUCCESS) {
                if (use_rtcp_mux) {
                    /* Remote indicates it wants to use rtcp-mux */
                    pjmedia_transport_info info;

                    pjmedia_transport_info_init(&info);
                    pjmedia_transport_get_info(ds->srtp->member_tp, &info);
                    if (pj_sockaddr_cmp(&info.sock_info.rtp_addr_name,
                        &info.sock_info.rtcp_addr_name))
                    {
                        /* But we do not wish to use rtcp mux */
                        use_rtcp_mux = PJ_FALSE;
                    }
                }
                if (pj_sockaddr_has_addr(&ds->rem_addr) &&
                    pj_sockaddr_has_addr(&rem_rtp) &&
                    (pj_sockaddr_cmp(&ds->rem_addr, &rem_rtp) ||
                     (!use_rtcp_mux &&
                      pj_sockaddr_has_addr(&ds->rem_rtcp) &&
                      pj_sockaddr_has_addr(&rem_rtcp) &&
                      pj_sockaddr_cmp(&ds->rem_rtcp, &rem_rtcp))))
                {
                    rem_addr_changed = PJ_TRUE;
                }
            }
        }

        /* Check if remote signals DTLS re-nego by changing its
         * setup/fingerprint in SDP or media transport address in SDP.
         */
        if ((last_setup != DTLS_SETUP_UNKNOWN && last_setup != ds->setup) ||
            (last_rem_fp.slen &&
             pj_memcmp(&last_rem_fp, &ds->rem_fingerprint, sizeof(pj_str_t)))||
            (rem_addr_changed))
        {
            dtls_media_stop_channel(ds, RTP_CHANNEL);
            dtls_media_stop_channel(ds, RTCP_CHANNEL);
            ds->got_keys = PJ_FALSE;
            ds->rem_fprint_status = PJ_EPENDING;
        }
    }

    /* Set media transport to UDP/TLS/RTP/SAVP if we are the offerer,
     * otherwise just match it to the offer (currently we only accept
     * UDP/TLS/RTP/SAVP in remote offer though).
     */
    if (ds->srtp->offerer_side) {
        m_loc->desc.transport = ID_TP_DTLS_SRTP;
    } else {
        m_loc->desc.transport = 
                            sdp_remote->media[media_index]->desc.transport;
    }

    /* Add a=fingerprint attribute, fingerprint of our TLS certificate */
    {
        char buf[128];
        pj_size_t buf_len = sizeof(buf);
        pj_str_t fp;

        status = ssl_get_fingerprint(dtls_cert, PJ_TRUE, buf, &buf_len);
        if (status != PJ_SUCCESS)
            goto on_return;

        pj_strset(&fp, buf, buf_len);
        a = pjmedia_sdp_attr_create(ds->pool, ID_FINGERPRINT.ptr, &fp);
        pjmedia_sdp_media_add_attr(m_loc, a);
    }

    if (ds->nego_completed[RTP_CHANNEL]) {
        /* This is subsequent SDP offer/answer and no DTLS re-nego has been
         * signalled.
         */
        goto on_return;
    }

    /* Attach member transport, so we can receive DTLS init (if our setup
     * is PASSIVE/ACTPASS) or send DTLS init (if our setup is ACTIVE).
     */
    {
        pjmedia_transport_attach_param ap;
        pjmedia_transport_info info;

        pj_bzero(&ap, sizeof(ap));
        ap.user_data = ds->srtp;
        pjmedia_transport_get_info(ds->srtp->member_tp, &info);

        if (sdp_remote) {
            get_rem_addrs(ds, sdp_remote, media_index, &ds->rem_addr,
                          &ds->rem_rtcp, NULL);
        }

        if (pj_sockaddr_has_addr(&ds->rem_addr)) {
            pj_sockaddr_cp(&ap.rem_addr, &ds->rem_addr);
        } else if (pj_sockaddr_has_addr(&info.sock_info.rtp_addr_name)) {
            pj_sockaddr_cp(&ap.rem_addr, &info.sock_info.rtp_addr_name);
        } else {
            pj_sockaddr_init(pj_AF_INET(), &ap.rem_addr, 0, 0);
        }

        if (pj_sockaddr_cmp(&info.sock_info.rtp_addr_name,
                            &info.sock_info.rtcp_addr_name) == 0)
        {
            /* Using RTP & RTCP multiplexing */
            pj_sockaddr_cp(&ap.rem_rtcp, &ap.rem_addr);
        } else if (pj_sockaddr_has_addr(&ds->rem_rtcp)) {
            pj_sockaddr_cp(&ap.rem_rtcp, &ds->rem_rtcp);
        } else if (pj_sockaddr_has_addr(&info.sock_info.rtcp_addr_name)) {
            pj_sockaddr_cp(&ap.rem_rtcp, &info.sock_info.rtcp_addr_name);
        } else {
            pj_sockaddr_init(pj_AF_INET(), &ap.rem_rtcp, 0, 0);
        }

        ap.addr_len = pj_sockaddr_get_len(&ap.rem_addr);
        status = pjmedia_transport_attach2(&ds->srtp->base, &ap);
        if (status != PJ_SUCCESS)
            goto on_return;

        /* Start member transport if it is UDP, so we can receive packet
         * (see also #2097).
         */
        udp_member_transport_media_start(ds);

#if DTLS_DEBUG
        {
            char addr[PJ_INET6_ADDRSTRLEN];
            PJ_LOG(2,(ds->base.name, "Attached transport, remote addr=%s:%d",
                      pj_sockaddr_print(&ap.rem_addr, addr, sizeof(addr), 2),
                      pj_sockaddr_get_port(&ap.rem_addr)));
        }
#endif
    }

    /* If our setup is ACTIVE and member transport is not ICE,
     * start DTLS nego.
     */
    if (ds->setup == DTLS_SETUP_ACTIVE) {
        pjmedia_transport_info info;
        pjmedia_ice_transport_info *ice_info;

        pjmedia_transport_info_init(&info);
        pjmedia_transport_get_info(ds->srtp->member_tp, &info);
        ice_info = (pjmedia_ice_transport_info*)
                   pjmedia_transport_info_get_spc_info(
                                    &info, PJMEDIA_TRANSPORT_TYPE_ICE);
        use_ice = ice_info && ice_info->comp_cnt;
        if (!use_ice) {
            /* Start SSL nego */
            status = ssl_handshake(ds);
            if (status != PJ_SUCCESS)
                goto on_return;
        }
    }

on_return:
#if DTLS_DEBUG
    if (status != PJ_SUCCESS) {
        pj_perror(4, ds->base.name, status, "dtls_encode_sdp() failed");
    }
#endif
    return status;
}
