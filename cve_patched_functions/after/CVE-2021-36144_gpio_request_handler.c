gpio_request_handler(struct virtio_gpio *gpio, struct virtio_gpio_request *req,
		struct virtio_gpio_response *rsp)
{
	int rc;

	if (req->cmd >= GPIO_REQ_MAX || req->offset >= gpio->nvline) {
		WPRINTF(("discards the gpio request, command:%u, offset:%u\n",
				req->cmd, req->offset));
		rsp->err = -1;
		return;
	}

	print_virtio_gpio_info(req, rsp, true);
	switch (req->cmd) {
	case GPIO_REQ_SET_VALUE:
		rc = gpio_set_value(gpio, req->offset, req->data);
		break;
	case GPIO_REQ_GET_VALUE:
		rc = gpio_get_value(gpio, req->offset);
		if (rc >= 0)
			rsp->data = rc;
		break;
	case GPIO_REQ_OUTPUT_DIRECTION:
		rc = gpio_set_direction_output(gpio, req->offset,
				req->data);
		break;
	case GPIO_REQ_INPUT_DIRECTION:
		rc = gpio_set_direction_input(gpio, req->offset);
		break;
	case GPIO_REQ_GET_DIRECTION:
		rc = gpio_get_direction(gpio, req->offset);
		if (rc >= 0)
			rsp->data = rc;
		break;
	case GPIO_REQ_SET_CONFIG:
		rc = gpio_set_config(gpio, req->offset, req->data);
		break;
	default:
		WPRINTF(("invalid gpio request command:%d\n", req->cmd));
		rc = -1;
		break;
	}

	rsp->err = rc < 0 ? -1 : 0;
	print_virtio_gpio_info(req, rsp, false);
}
