virtio_console_config_backend(struct virtio_console_backend *be)
{
	int fd, flags;
	char *pts_name = NULL;
	int client_fd = -1;
	struct termios tio, saved_tio;
	struct sockaddr_un addr;

	if (!be || be->fd == -1)
		return -1;

	fd = be->fd;
	switch (be->be_type) {
	case VIRTIO_CONSOLE_BE_PTY:
		pts_name = ptsname(fd);
		if (pts_name == NULL) {
			WPRINTF(("vtcon: ptsname return NULL, errno = %d\n",
				errno));
			return -1;
		}

		client_fd = open(pts_name, O_RDWR);
		if (client_fd == -1) {
			WPRINTF(("vtcon: client_fd open failed, errno = %d\n",
				errno));
			return -1;
		}

		tcgetattr(client_fd, &tio);
		cfmakeraw(&tio);
		tcsetattr(client_fd, TCSAFLUSH, &tio);
		be->pts_fd = client_fd;

		WPRINTF(("***********************************************\n"));
		WPRINTF(("virt-console backend redirected to %s\n", pts_name));
		WPRINTF(("***********************************************\n"));

		flags = fcntl(fd, F_GETFL);
		fcntl(fd, F_SETFL, flags | O_NONBLOCK);
		break;
	case VIRTIO_CONSOLE_BE_TTY:
	case VIRTIO_CONSOLE_BE_STDIO:
		tcgetattr(fd, &tio);
		saved_tio = tio;
		cfmakeraw(&tio);
		tio.c_cflag |= CLOCAL;
		tcsetattr(fd, TCSANOW, &tio);

		if (be->be_type == VIRTIO_CONSOLE_BE_STDIO) {
			flags = fcntl(fd, F_GETFL);
			fcntl(fd, F_SETFL, flags | O_NONBLOCK);

			virtio_console_saved_flags = flags;
			virtio_console_saved_tio = saved_tio;
			atexit(virtio_console_restore_stdio);
		}
		break;
	case VIRTIO_CONSOLE_BE_SOCKET:
		if (be->portpath == NULL) {
			WPRINTF(("vtcon: portpath is NULL\n"));
			return -1;
		}

		memset(&addr, 0, sizeof(addr));
		addr.sun_family = AF_UNIX;
		strncpy(addr.sun_path, be->portpath, sizeof(addr.sun_path));
		addr.sun_path[sizeof(addr.sun_path) - 1] = '\0';

		if (be->socket_type == NULL || !strcmp(be->socket_type,"server")) {
			unlink(be->portpath);
			if (bind(fd, (struct sockaddr *)&addr, sizeof(addr)) == -1) {
				WPRINTF(("Bind Error = %d\n", errno));
				return -1;
			}
			if (listen(fd, 64) == -1) {
				WPRINTF(("Listen Error= %d\n", errno));
				return -1;
			}
			if (make_socket_non_blocking(fd) == -1) {
				WPRINTF(("Backend config: fcntl Error\n"));
				return -1;
			}
		} else if (!strcmp(be->socket_type,"client")) {
			if (access(be->portpath,0)) {
				WPRINTF(("%s not exist\n", be->portpath));
				return -1;
			}
			if (connect(fd, (struct sockaddr *)&addr, sizeof(addr)) == -1) {
				WPRINTF(("vtcon: connect error[%d] \n", errno));
			} else {
				if (make_socket_non_blocking(fd) == -1) {
					WPRINTF(("Backend config: fcntl Error\n"));
				}
			}
		} else {
			WPRINTF(("Socket type not exist\n"));
			return -1;
		}

	default:
		break; /* nothing to do */
	}

	return 0;
}
