ssize_t clif_add_attr(clif_attr_t *attr, char *buf, size_t maxlen)
{
    assert(attr);
    assert(attr->key);

    /* if no length given, calculate it */
    if (!attr->key_len) {
        attr->key_len = strlen(attr->key);
    }

    /* count attr name size and separator ';' */
    size_t req_space = attr->key_len + 1;
    size_t pos = 0;
    int quoted = strcmp(attr->key, LF_ATTR_SIZE) ? 1 : 0;

    if (attr->value) {
        if (!attr->value_len) {
            attr->value_len = strlen(attr->value);
        }
        /* count also '=' */
        req_space += attr->value_len +  1;
    }

    if (quoted) {
        req_space += 2;
    }

    if (!buf) {
        return req_space;
    }

    if (req_space > maxlen) {
        return CLIF_NO_SPACE;
    }

    /* add attribute separator ';' */
    buf[pos++] = LF_ATTR_SEPARATOR_C;

    /* add attribute name */
    memcpy(&buf[pos], attr->key, attr->key_len);
    pos += attr->key_len;

    /* add attribute value if defined */
    if (attr->value) {
        buf[pos++] = LF_ATTR_VAL_SEPARATOR_C;

        if (quoted) {
            buf[pos++] = '"';
        }

        memcpy(&buf[pos], attr->value, attr->value_len);
        pos += attr->value_len;

        if (quoted) {
            buf[pos++] = '"';
        }
    }

    return pos;
}
