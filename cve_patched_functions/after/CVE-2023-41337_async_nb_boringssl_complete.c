enum ssl_private_key_result_t async_nb_boringssl_complete(SSL *ssl, uint8_t *out, size_t *outlen, size_t max_out)
{
    struct async_nb_job_t *job = SSL_get_ex_data(ssl, h2o_socket_boringssl_get_async_job_index());
    void *digest;
    size_t digestlen;

    assert(job != NULL);

    neverbleed_finish_digestsign(&job->buf, &digest, &digestlen);
    async_nb_job_free(&job->super);
    job = NULL;
    SSL_set_ex_data(ssl, h2o_socket_boringssl_get_async_job_index(), NULL);

    assert(digestlen <= max_out);
    memcpy(out, digest, digestlen);
    *outlen = digestlen;

    ptls_clear_memory(digest, digestlen);
    free(digest);

    return ssl_private_key_success;
}
