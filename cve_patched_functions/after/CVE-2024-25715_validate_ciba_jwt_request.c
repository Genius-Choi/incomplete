static json_t * validate_ciba_jwt_request(struct _oidc_config * config, const char * jwt_request, const char * ip_source) {
  json_t * j_return, * j_result, * j_claims;
  jwt_t * jwt = NULL;
  char * requested_expiry = NULL;
  int res;
  const char * client_id = NULL;

  if (jwt_request != NULL) {
    if (r_jwt_init(&jwt) == RHN_OK && r_jwt_advanced_parse(jwt, jwt_request, R_PARSE_NONE, 0) == RHN_OK && decrypt_request_token(config, jwt) == G_OK) {
      // request or request_uri must not be present in the payload
      if (r_jwt_get_claim_str_value(jwt, "request") == NULL && r_jwt_get_claim_str_value(jwt, "request_uri") == NULL) {
        j_result = verify_request_signature(config, jwt, r_jwt_get_claim_str_value(jwt, "iss"), GLEWLWYD_AUTH_CIBA, ip_source);
        if (check_result_value(j_result, G_OK)) {
          // Verify mandatory claims
          if (!o_strnullempty(client_id = r_jwt_get_claim_str_value(jwt, "iss"))) {
            if (r_jwt_validate_claims(jwt, R_JWT_CLAIM_AUD, json_string_value(json_object_get(config->j_params, "iss")),
                                           R_JWT_CLAIM_EXP, R_JWT_CLAIM_PRESENT,
                                           R_JWT_CLAIM_IAT, R_JWT_CLAIM_PRESENT,
                                           R_JWT_CLAIM_NBF, R_JWT_CLAIM_PRESENT,
                                           R_JWT_CLAIM_JTI, NULL,
                                           R_JWT_CLAIM_NOP) == RHN_OK &&
                o_strnstr(r_jwt_get_claim_str_value(jwt, "aud"), json_string_value(json_object_get(config->j_params, "iss")), json_string_length(json_object_get(config->j_params, "iss"))) != NULL) {
              if ((res = check_ciba_jti(config, r_jwt_get_claim_str_value(jwt, "jti"), client_id, ip_source)) == RHN_OK) {
                j_claims = r_jwt_get_full_claims_json_t(jwt);
                if (json_object_get(j_claims, "requested_expiry") != NULL) {
                  if (json_is_integer(json_object_get(j_claims, "requested_expiry"))) {
                    requested_expiry = msprintf("%"JSON_INTEGER_FORMAT, json_integer_value(json_object_get(j_claims, "requested_expiry")));
                    r_jwt_set_claim_str_value(jwt, "requested_expiry", requested_expiry);
                    o_free(requested_expiry);
                  }
                }
                json_decref(j_claims);
                j_return = json_pack("{sisosOsOsiss}",
                                     "result", G_OK,
                                     "request", r_jwt_get_full_claims_json_t(jwt),
                                     "client", json_object_get(j_result, "client"),
                                     "client_auth_method", json_object_get(j_result, "client_auth_method"),
                                     "type", r_jwt_get_type(jwt),
                                     "jti", r_jwt_get_claim_str_value(jwt, "jti"));
              } else if (res == G_ERROR_UNAUTHORIZED) {
                y_log_message(Y_LOG_LEVEL_ERROR, "validate_ciba_jwt_request - Error jti already used for client_id '%s', origin: %s", client_id, ip_source);
                j_return = json_pack("{si}", "result", G_ERROR_UNAUTHORIZED);
              } else {
                y_log_message(Y_LOG_LEVEL_ERROR, "validate_ciba_jwt_request - Error check_ciba_jti");
                j_return = json_pack("{si}", "result", G_ERROR);
              }
            } else {
              y_log_message(Y_LOG_LEVEL_ERROR, "validate_ciba_jwt_request - Error invalid jwt claims, origin: %s", ip_source);
              j_return = json_pack("{si}", "result", G_ERROR_PARAM);
            }
          } else {
            y_log_message(Y_LOG_LEVEL_ERROR, "validate_ciba_jwt_request - Error jwt_request does not contain iss value, origin: %s", ip_source);
            j_return = json_pack("{si}", "result", G_ERROR_PARAM);
          }
        } else if (check_result_value(j_result, G_ERROR_UNAUTHORIZED)) {
          j_return = json_pack("{si}", "result", G_ERROR_UNAUTHORIZED);
        } else {
          y_log_message(Y_LOG_LEVEL_ERROR, "validate_ciba_jwt_request - Error verify_request_signature");
          j_return = json_pack("{si}", "result", G_ERROR);
        }
        json_decref(j_result);
      } else {
        y_log_message(Y_LOG_LEVEL_ERROR, "validate_ciba_jwt_request - jwt has an invalid payload with attribute request or request_uri, origin: %s", ip_source);
        j_return = json_pack("{si}", "result", G_ERROR_UNAUTHORIZED);
      }
    } else {
      y_log_message(Y_LOG_LEVEL_ERROR, "validate_ciba_jwt_request - Error jwt_request is not a valid jwt, origin: %s", ip_source);
      j_return = json_pack("{si}", "result", G_ERROR_PARAM);
    }
    r_jwt_free(jwt);
  } else {
    y_log_message(Y_LOG_LEVEL_ERROR, "validate_ciba_jwt_request - Error jwt_request is NULL");
    j_return = json_pack("{si}", "result", G_ERROR_PARAM);
  }

  return j_return;
}
