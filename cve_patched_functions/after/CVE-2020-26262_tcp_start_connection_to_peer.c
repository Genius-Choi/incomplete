static int tcp_start_connection_to_peer(turn_turnserver *server, ts_ur_super_session *ss, stun_tid *tid,
				allocation *a, ioa_addr *peer_addr,
				int *err_code, const uint8_t **reason)
{
	FUNCSTART;

	if(!ss) {
		*err_code = 500;
		*reason = (const uint8_t *)"Server error: empty session";
		FUNCEND;
		return -1;
	}

	if(!peer_addr) {
		*err_code = 500;
		*reason = (const uint8_t *)"Server error: empty peer addr";
		FUNCEND;
		return -1;
	}

	if(!get_relay_socket(a,peer_addr->ss.sa_family)) {
		*err_code = 500;
		*reason = (const uint8_t *)"Server error: no relay connection created";
		FUNCEND;
		return -1;
	}

	tcp_connection *tc = get_tcp_connection_by_peer(a, peer_addr);
	if(tc) {
		*err_code = 446;
		FUNCEND;
		return -1;
	}

	tc = create_tcp_connection(server->id, a, tid, peer_addr, err_code);
	if(!tc) {
		if(!(*err_code)) {
			*err_code = 500;
			*reason = (const uint8_t *)"Server error: TCP connection object creation failed";
		}
		FUNCEND;
		return -1;
	} else if(*err_code) {
		delete_tcp_connection(tc);
		FUNCEND;
		return -1;
	}

	IOA_EVENT_DEL(tc->peer_conn_timeout);
	tc->peer_conn_timeout = set_ioa_timer(server->e, TCP_PEER_CONN_TIMEOUT, 0,
						tcp_peer_conn_timeout_handler, tc, 0,
						"tcp_peer_conn_timeout_handler");

	ioa_socket_handle tcs = ioa_create_connecting_tcp_relay_socket(get_relay_socket(a,peer_addr->ss.sa_family),
			peer_addr, tcp_peer_connection_completed_callback, tc);
	if(!tcs) {
		delete_tcp_connection(tc);
		*err_code = 500;
		*reason = (const uint8_t *)"Server error: TCP relay socket for connection cannot be created";
		FUNCEND;
		return -1;
	}

	tc->state = TC_STATE_CLIENT_TO_PEER_CONNECTING;
	if(tc->peer_s != tcs) {
		IOA_CLOSE_SOCKET(tc->peer_s);
		tc->peer_s = tcs;
	}
	set_ioa_socket_sub_session(tc->peer_s,tc);

	FUNCEND;
	return 0;
}
