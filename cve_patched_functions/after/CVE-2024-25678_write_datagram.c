write_datagram (struct ietf_full_conn *conn)
{
    struct lsquic_packet_out *packet_out;
    size_t need;
    int w;

    need = conn->ifc_conn.cn_pf->pf_datagram_frame_size(conn->ifc_min_dg_sz);
    packet_out = get_writeable_packet(conn, need);
    if (!packet_out)
        return 0;

    w = conn->ifc_conn.cn_pf->pf_gen_datagram_frame(
            packet_out->po_data + packet_out->po_data_sz,
            lsquic_packet_out_avail(packet_out), conn->ifc_min_dg_sz,
            conn->ifc_max_dg_sz,
            conn->ifc_enpub->enp_stream_if->on_dg_write, &conn->ifc_conn);
    if (w < 0)
    {
        LSQ_DEBUG("could not generate DATAGRAM frame");
        return 0;
    }
    if (0 != lsquic_packet_out_add_frame(packet_out, conn->ifc_pub.mm, 0,
                        QUIC_FRAME_DATAGRAM, packet_out->po_data_sz, w))
    {
        ABORT_ERROR("adding DATAGRAME frame to packet failed: %d", errno);
        return 0;
    }
    packet_out->po_regen_sz += w;
    packet_out->po_frame_types |= QUIC_FTBIT_DATAGRAM;
    lsquic_send_ctl_incr_pack_sz(&conn->ifc_send_ctl, packet_out, w);
    /* XXX The DATAGRAM frame should really be a regen.  Do it when we
     * no longer require these frame types to be at the beginning of the
     * packet.
     */

    return 1;
}
