perdition_log_auth(timed_log_t *auth_log, const char *from_to_host_str,
		struct auth *auth, const char *servername, const char *port,
		const char *reason, int ssl_mode, int tls_state)
{
	const char *eu_ssl, *rs_ssl, *pw_head, *pw_body, *pw_tail;
	struct quoted_str authorisation_id = quote_str(auth->authorisation_id);
	char *protocol = NULL;

	if (opt.debug &&
	    ((!strcmp(reason, "ok") && (opt.log_passwd & LOG_PASSWD_OK)) ||
	     (opt.log_passwd & LOG_PASSWD_FAIL))) {
		pw_body = auth->passwd;
		pw_head = " passwd=\"";
		pw_tail = "\"";
	}
	else
		pw_head = pw_body = pw_tail = "";

	if (ssl_mode & SSL_MODE_SSL_LISTEN)
		eu_ssl = "ssl";
	else if (tls_state & SSL_MODE_TLS_LISTEN)
		eu_ssl = "starttls";
	else
		eu_ssl = "plaintext";

	if (ssl_mode & SSL_MODE_SSL_OUTGOING)
		rs_ssl = "ssl";
	else if (tls_state & SSL_MODE_TLS_OUTGOING)
		rs_ssl = "starttls";
	else
		rs_ssl = "plaintext";

	protocol = protocol_list(protocol, NULL, opt.protocol);

	memset(auth_log->log_str, 0, sizeof(auth_log->log_str));
	snprintf(auth_log->log_str, sizeof(auth_log->log_str),
			"Auth:%s client-secure=%s authorisation_id=%s%s%s "
			"authentication_id=\"%s\"%s%s%s "
			"server=\"%s:%s\" protocol=%s "
			"server-secure=%s status=\"%s\"",
			from_to_host_str, eu_ssl, authorisation_id.quote,
			authorisation_id.str, authorisation_id.quote,
			str_null_safe(auth->authentication_id),
			pw_head, pw_body, pw_tail, str_null_safe(servername),
			str_null_safe(port), str_null_safe(protocol),
			rs_ssl, str_null_safe(reason));
	auth_log->log_time = time(NULL) + opt.connect_relog;

	free(protocol);

	VANESSA_LOGGER_LOG(LOG_NOTICE, auth_log->log_str);

	set_proc_title("%s: connect (%s)", progname,
		       str_null_safe(auth_get_authorisation_id(auth)));
}
