EXTERN_C BAAPI UserExperienceOnCacheAcquireBegin(
    __in BURN_USER_EXPERIENCE* pUserExperience,
    __in_z_opt LPCWSTR wzPackageOrContainerId,
    __in_z_opt LPCWSTR wzPayloadId,
    __in_z LPWSTR* pwzSource,
    __in_z LPWSTR* pwzDownloadUrl,
    __in_z_opt LPCWSTR wzPayloadContainerId,
    __out BOOTSTRAPPER_CACHE_OPERATION* pCacheOperation
    )
{
    HRESULT hr = S_OK;
    BA_ONCACHEACQUIREBEGIN_ARGS args = { };
    BA_ONCACHEACQUIREBEGIN_RESULTS results = { };
    *pCacheOperation = BOOTSTRAPPER_CACHE_OPERATION_NONE;

    args.cbSize = sizeof(args);
    args.wzPackageOrContainerId = wzPackageOrContainerId;
    args.wzPayloadId = wzPayloadId;
    args.wzSource = *pwzSource;
    args.wzDownloadUrl = *pwzDownloadUrl;
    args.wzPayloadContainerId = wzPayloadContainerId;
    args.recommendation = *pCacheOperation;

    results.cbSize = sizeof(results);
    results.action = *pCacheOperation;

    hr = SendBAMessageFromInactiveEngine(pUserExperience, BOOTSTRAPPER_APPLICATION_MESSAGE_ONCACHEACQUIREBEGIN, &args, &results);
    ExitOnFailure(hr, "BA OnCacheAcquireBegin failed.");

    if (results.fCancel)
    {
        hr = HRESULT_FROM_WIN32(ERROR_INSTALL_USEREXIT);
    }
    else
    {
        // Verify the BA requested an action that is possible.
        if (BOOTSTRAPPER_CACHE_OPERATION_DOWNLOAD == results.action && *pwzDownloadUrl && **pwzDownloadUrl ||
            BOOTSTRAPPER_CACHE_OPERATION_EXTRACT == results.action && wzPayloadContainerId ||
            BOOTSTRAPPER_CACHE_OPERATION_COPY == results.action ||
            BOOTSTRAPPER_CACHE_OPERATION_NONE == results.action)
        {
            *pCacheOperation = results.action;
        }
    }

LExit:
    return hr;
}
