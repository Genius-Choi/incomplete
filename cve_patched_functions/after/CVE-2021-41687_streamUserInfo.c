streamUserInfo(DUL_USERINFO * userInfo, unsigned char *b,
               unsigned long *length)
{
    unsigned long subLength;

    *length = 0;
    *b++ = userInfo->type;
    *b++ = userInfo->rsv1;
    COPY_SHORT_BIG(userInfo->length, b);
    b += 2;
    *length += 4;

    // stream user info sub-item 51H: maximum length
    OFCondition cond = streamMaxLength(&userInfo->maxLength, b, &subLength);
    if (cond.bad())
        return cond;
    b += subLength;
    *length += subLength;

    // stream user info sub-item 52H: implementation class UID
    cond = streamSubItem(&userInfo->implementationClassUID, b, &subLength);
    if (cond.bad())
        return cond;
    b += subLength;
    *length += subLength;

    // user info sub-item 53H (async operations) is not yet implemented!

#ifdef OLD_USER_INFO_SUB_ITEM_ORDER
    /* prior DCMTK releases did not encode user information sub items
     * in ascending order, i.e. they sent 55H followed by 54H and 56H.
     * This behaviour has been "legalized" by DICOM CP 280 but is known
     * to create problems with some other toolkits.
     * Should be re-activated for testing purposes only.
     */

    // stream user info sub-item 55H: implementation version name
    if (userInfo->implementationVersionName.length != 0) {
        cond = streamSubItem(&userInfo->implementationVersionName, b, &subLength);
        if (cond.bad())
            return cond;
        b += subLength;
        *length += subLength;
    }
#endif

    // stream one or more user info sub-items 54H: SCP/SCU role selection
    if (LST_Count(&userInfo->SCUSCPRoleList) != 0) {
        cond = streamSCUSCPList(&userInfo->SCUSCPRoleList, b, &subLength);
        if (cond.bad())
            return cond;
        b += subLength;
        *length += subLength;
    }

#ifndef OLD_USER_INFO_SUB_ITEM_ORDER
    // stream user info sub-item 55H: implementation version name
    if (userInfo->implementationVersionName.length != 0) {
        cond = streamSubItem(&userInfo->implementationVersionName, b, &subLength);
        if (cond.bad())
            return cond;
        b += subLength;
        *length += subLength;
    }
#endif

    // stream one or more user info sub-items 56H: extended negotiation
    if (userInfo->extNegList != NULL) {
        cond = streamExtNegList(userInfo->extNegList, b, &subLength);
        if (cond.bad())
            return cond;
        b += subLength;
        *length += subLength;
    }

    // stream user info sub-item 58H: user identity negotiation
    if (userInfo->usrIdent != NULL) {
        cond = userInfo->usrIdent->stream(b, subLength /*out*/);
        if (cond.bad())
            return cond;
        b += subLength;
        *length += subLength;
    }

    return EC_Normal;
}
