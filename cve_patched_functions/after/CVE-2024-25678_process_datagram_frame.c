process_datagram_frame (struct ietf_full_conn *conn,
    struct lsquic_packet_in *packet_in, const unsigned char *p, size_t len)
{
    const void *data;
    size_t data_sz;
    int parsed_len;

    if (!(conn->ifc_flags & IFC_DATAGRAMS))
    {
        ABORT_QUIETLY(0, TEC_PROTOCOL_VIOLATION,
            "Received unexpected DATAGRAM frame (not negotiated)");
        return 0;
    }

    parsed_len = conn->ifc_conn.cn_pf->pf_parse_datagram_frame(p, len,
                                                            &data, &data_sz);
    if (parsed_len < 0)
        return 0;

    EV_LOG_CONN_EVENT(LSQUIC_LOG_CONN_ID, "%zd-byte DATAGRAM", data_sz);
    LSQ_DEBUG("%zd-byte DATAGRAM", data_sz);

    conn->ifc_enpub->enp_stream_if->on_datagram(&conn->ifc_conn, data, data_sz);

    return parsed_len;
}
