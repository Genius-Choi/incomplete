ssize_t onion_response_write(onion_response * res, const char *data,
                             size_t length) {
  if (res->flags & OR_SKIP_CONTENT) {
    if (!(res->flags & OR_HEADER_SENT)) {       // Automatic header write
      onion_response_write_headers(res);
    }
    ONION_DEBUG("Skipping content as we are in HEAD mode");
    return OCS_CLOSE_CONNECTION;
  }
  if (length == 0) {
    onion_response_flush(res);
    return 0;
  }
  //ONION_DEBUG0("Write %d bytes [%d total] (%p)", length, res->sent_bytes, res);

  int l = length;
  int w = 0;
  while (res->buffer_pos + l > sizeof(res->buffer)) {
    int wb = sizeof(res->buffer) - res->buffer_pos;
    memcpy(&res->buffer[res->buffer_pos], data, wb);

    res->buffer_pos = sizeof(res->buffer);
    if (onion_response_flush(res) < 0)
      return w;

    l -= wb;
    data += wb;
    w += wb;
  }

  memcpy(&res->buffer[res->buffer_pos], data, l);
  res->buffer_pos += l;
  w += l;

  return w;
}
