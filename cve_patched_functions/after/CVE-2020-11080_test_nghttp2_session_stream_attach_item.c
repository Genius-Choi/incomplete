void test_nghttp2_session_stream_attach_item(void) {
  nghttp2_session *session;
  nghttp2_session_callbacks callbacks;
  nghttp2_stream *a, *b, *c, *d, *e;
  nghttp2_outbound_item *da, *db, *dc, *dd;
  nghttp2_mem *mem;

  mem = nghttp2_mem_default();

  memset(&callbacks, 0, sizeof(callbacks));

  nghttp2_session_server_new(&session, &callbacks, NULL);

  a = open_stream(session, 1);
  b = open_stream_with_dep(session, 3, a);
  c = open_stream_with_dep(session, 5, a);
  d = open_stream_with_dep(session, 7, c);

  /* a
   * |
   * c--b
   * |
   * d
   */

  db = create_data_ob_item(mem);

  nghttp2_stream_attach_item(b, db);

  CU_ASSERT(a->queued);
  CU_ASSERT(b->queued);
  CU_ASSERT(!c->queued);
  CU_ASSERT(!d->queued);

  CU_ASSERT(1 == nghttp2_pq_size(&a->obq));

  /* Attach item to c */
  dc = create_data_ob_item(mem);

  nghttp2_stream_attach_item(c, dc);

  CU_ASSERT(a->queued);
  CU_ASSERT(b->queued);
  CU_ASSERT(c->queued);
  CU_ASSERT(!d->queued);

  CU_ASSERT(2 == nghttp2_pq_size(&a->obq));

  /* Attach item to a */
  da = create_data_ob_item(mem);

  nghttp2_stream_attach_item(a, da);

  CU_ASSERT(a->queued);
  CU_ASSERT(b->queued);
  CU_ASSERT(c->queued);
  CU_ASSERT(!d->queued);

  CU_ASSERT(2 == nghttp2_pq_size(&a->obq));

  /* Detach item from a */
  nghttp2_stream_detach_item(a);

  CU_ASSERT(a->queued);
  CU_ASSERT(b->queued);
  CU_ASSERT(c->queued);
  CU_ASSERT(!d->queued);

  CU_ASSERT(2 == nghttp2_pq_size(&a->obq));

  /* Attach item to d */
  dd = create_data_ob_item(mem);

  nghttp2_stream_attach_item(d, dd);

  CU_ASSERT(a->queued);
  CU_ASSERT(b->queued);
  CU_ASSERT(c->queued);
  CU_ASSERT(d->queued);

  CU_ASSERT(2 == nghttp2_pq_size(&a->obq));
  CU_ASSERT(1 == nghttp2_pq_size(&c->obq));

  /* Detach item from c */
  nghttp2_stream_detach_item(c);

  CU_ASSERT(a->queued);
  CU_ASSERT(b->queued);
  CU_ASSERT(c->queued);
  CU_ASSERT(d->queued);

  CU_ASSERT(2 == nghttp2_pq_size(&a->obq));
  CU_ASSERT(1 == nghttp2_pq_size(&c->obq));

  /* Detach item from b */
  nghttp2_stream_detach_item(b);

  CU_ASSERT(a->queued);
  CU_ASSERT(!b->queued);
  CU_ASSERT(c->queued);
  CU_ASSERT(d->queued);

  CU_ASSERT(1 == nghttp2_pq_size(&a->obq));

  /* exercises insertion */
  e = open_stream_with_dep_excl(session, 9, a);

  /* a
   * |
   * e
   * |
   * c--b
   * |
   * d
   */

  CU_ASSERT(a->queued);
  CU_ASSERT(e->queued);
  CU_ASSERT(!b->queued);
  CU_ASSERT(c->queued);
  CU_ASSERT(d->queued);

  CU_ASSERT(1 == nghttp2_pq_size(&a->obq));
  CU_ASSERT(1 == nghttp2_pq_size(&e->obq));
  CU_ASSERT(nghttp2_pq_empty(&b->obq));
  CU_ASSERT(1 == nghttp2_pq_size(&c->obq));
  CU_ASSERT(nghttp2_pq_empty(&d->obq));

  /* exercises deletion */
  nghttp2_stream_dep_remove(e);

  /* a
   * |
   * c--b
   * |
   * d
   */

  CU_ASSERT(a->queued);
  CU_ASSERT(!b->queued);
  CU_ASSERT(c->queued);
  CU_ASSERT(d->queued);

  CU_ASSERT(1 == nghttp2_pq_size(&a->obq));
  CU_ASSERT(nghttp2_pq_empty(&b->obq));
  CU_ASSERT(1 == nghttp2_pq_size(&c->obq));
  CU_ASSERT(nghttp2_pq_empty(&d->obq));

  /* e's weight 16 is distributed equally among c and b, both now have
     weight 8 each. */
  CU_ASSERT(8 == b->weight);
  CU_ASSERT(8 == c->weight);

  /* da, db, dc have been detached */
  nghttp2_outbound_item_free(da, mem);
  nghttp2_outbound_item_free(db, mem);
  nghttp2_outbound_item_free(dc, mem);
  free(da);
  free(db);
  free(dc);

  nghttp2_session_del(session);

  nghttp2_session_server_new(&session, &callbacks, NULL);

  a = open_stream(session, 1);
  b = open_stream_with_dep(session, 3, a);
  c = open_stream_with_dep(session, 5, a);
  d = open_stream_with_dep(session, 7, c);

  /* a
   * |
   * c--b
   * |
   * d
   */

  da = create_data_ob_item(mem);
  db = create_data_ob_item(mem);
  dc = create_data_ob_item(mem);

  nghttp2_stream_attach_item(a, da);
  nghttp2_stream_attach_item(b, db);
  nghttp2_stream_attach_item(c, dc);

  CU_ASSERT(a->queued);
  CU_ASSERT(b->queued);
  CU_ASSERT(c->queued);
  CU_ASSERT(!d->queued);

  CU_ASSERT(2 == nghttp2_pq_size(&a->obq));
  CU_ASSERT(nghttp2_pq_empty(&b->obq));
  CU_ASSERT(nghttp2_pq_empty(&c->obq));
  CU_ASSERT(nghttp2_pq_empty(&d->obq));

  /* Detach item from a */
  nghttp2_stream_detach_item(a);

  CU_ASSERT(a->queued);
  CU_ASSERT(b->queued);
  CU_ASSERT(c->queued);
  CU_ASSERT(!d->queued);

  CU_ASSERT(2 == nghttp2_pq_size(&a->obq));
  CU_ASSERT(nghttp2_pq_empty(&b->obq));
  CU_ASSERT(nghttp2_pq_empty(&c->obq));
  CU_ASSERT(nghttp2_pq_empty(&d->obq));

  /* da has been detached */
  nghttp2_outbound_item_free(da, mem);
  free(da);

  nghttp2_session_del(session);
}
