static int check_ciba_auth_req_id(struct _oidc_config * config,
                                  const struct _u_request * request,
                                  struct _u_response * response,
                                  json_t * j_assertion_client,
                                  const char * x5t_s256,
                                  int client_auth_method) {
  const char * auth_req_id = u_map_get(request->map_post_body, "auth_req_id"),
             * client_id = request->auth_basic_user,
             * client_secret = request->auth_basic_password,
             * ip_source = get_ip_source(request, config->glewlwyd_config->glewlwyd_config->originating_ip_header);
  json_t * j_ciba_request = get_ciba_request_from_auth_req_id(config, auth_req_id),
         * j_response,
         * j_client = NULL,
         * j_user = NULL,
         * j_token = NULL,
         * j_jkt = NULL;
  time_t now;
  int res;
  char * dpop_nonce = NULL;

  if (check_result_value(j_ciba_request, G_OK)) {
    if (client_id == NULL && u_map_get(request->map_post_body, "client_id") != NULL) {
      client_id = u_map_get(request->map_post_body, "client_id");
    }
    if (client_secret == NULL && u_map_get(request->map_post_body, "client_secret") != NULL) {
      client_secret = u_map_get(request->map_post_body, "client_secret");
      client_auth_method = GLEWLWYD_CLIENT_AUTH_METHOD_SECRET_POST;
    } else if (client_secret != NULL) {
      client_auth_method = GLEWLWYD_CLIENT_AUTH_METHOD_SECRET_BASIC;
    }
    do {
      // Check if client is valid
      if (j_assertion_client != NULL) {
        j_client = json_pack("{sisO}", "result", G_OK, "client", j_assertion_client);
      } else {
        if (client_id != NULL && 0 != o_strcmp(json_string_value(json_object_get(json_object_get(j_ciba_request, "ciba"), "client_id")), client_id)) {
          y_log_message(Y_LOG_LEVEL_DEBUG, "check_ciba_auth_req_id oidc - client_id invalid");
          j_client = json_pack("{si}", "result", G_ERROR_UNAUTHORIZED);
        } else {
          j_client = check_client_valid(config, client_id, client_secret, NULL, GLEWLWYD_AUTHORIZATION_TYPE_CIBA_FLAG, 0, ip_source);
        }
      }
      if (!check_result_value(j_client, G_OK) || !is_client_auth_method_allowed(json_object_get(j_client, "client"), client_auth_method)) {
        j_response = json_pack("{ss}", "error", "unauthorized_client");
        ulfius_set_json_body_response(response, 403, j_response);
        json_decref(j_response);
        break;
      } else if (client_id == NULL && client_secret == NULL && json_object_get(json_object_get(j_client, "client"), "confidential") == json_true()) {
        y_log_message(Y_LOG_LEVEL_DEBUG, "check_ciba_auth_req_id oidc - client '%s' is invalid or is not confidential, origin: %s", client_id, ip_source);
        j_response = json_pack("{ss}", "error", "unauthorized_client");
        ulfius_set_json_body_response(response, 400, j_response);
        json_decref(j_response);
        break;
      }

      // Check if x5t_s256 matches
      if ((x5t_s256 != NULL || !json_string_null_or_empty(json_object_get(json_object_get(j_ciba_request, "ciba"), "x5t_s256"))) &&
          0 != o_strcmp(x5t_s256, json_string_value(json_object_get(json_object_get(j_ciba_request, "ciba"), "x5t_s256")))) {
        y_log_message(Y_LOG_LEVEL_DEBUG, "check_ciba_auth_req_id oidc - client '%s' mismatch x5t#s256, origin: %s", client_id, ip_source);
        j_response = json_pack("{ss}", "error", "unauthorized_client");
        ulfius_set_json_body_response(response, 400, j_response);
        json_decref(j_response);
        break;
      }

      // Check that client delivery mode is allowed
      if (0 != o_strcmp(json_string_value(json_object_get(json_object_get(j_client, "client"), "backchannel_token_delivery_mode")), "ping") &&
          0 != o_strcmp(json_string_value(json_object_get(json_object_get(j_client, "client"), "backchannel_token_delivery_mode")), "poll")) {
        y_log_message(Y_LOG_LEVEL_DEBUG, "check_ciba_auth_req_id oidc - client '%s' invalid backchannel_token_delivery_mode, origin: %s", client_id, ip_source);
        j_response = json_pack("{ss}", "error", "unauthorized_client");
        ulfius_set_json_body_response(response, 400, j_response);
        json_decref(j_response);
        break;
      }

      // Check if request has expired
      time(&now);
      if (now > (time_t)json_integer_value(json_object_get(json_object_get(j_ciba_request, "ciba"), "expires_at"))) {
        j_response = json_pack("{ss}", "error", "expired_token");
        ulfius_set_json_body_response(response, 400, j_response);
        json_decref(j_response);
        break;
      }

      // Check if authorization request is still pending
      if (0 == json_integer_value(json_object_get(json_object_get(j_ciba_request, "ciba"), "status"))) {
        j_response = json_pack("{ss}", "error", "authorization_pending");
        ulfius_set_json_body_response(response, 400, j_response);
        json_decref(j_response);
        break;
      }

      // Check if authorization request is denied or error
      if (1 != json_integer_value(json_object_get(json_object_get(j_ciba_request, "ciba"), "status"))) {
        j_response = json_pack("{ss}", "error", "access_denied");
        ulfius_set_json_body_response(response, 400, j_response);
        json_decref(j_response);
        break;
      }

      j_jkt = oidc_verify_dpop_proof(config, request, "POST", "/token", json_object_get(j_client, "client"), NULL, json_string_value(json_object_get(json_object_get(j_ciba_request, "ciba"), "dpop_jkt")));

      if (check_result_value(j_jkt, G_ERROR_PARAM) || check_result_value(j_jkt, G_ERROR_UNAUTHORIZED)) {
        if (json_object_get(j_jkt, "nonce") != NULL) {
          j_response = json_pack("{ssss}", "error", "use_dpop_nonce", "error_description", "Authorization server requires nonce in DPoP proof");
          ulfius_set_response_properties(response, U_OPT_STATUS, 400,
                                                   U_OPT_HEADER_PARAMETER, "DPoP-Nonce", json_string_value(json_object_get(j_jkt, "nonce")),
                                                   U_OPT_JSON_BODY, j_response,
                                                   U_OPT_NONE);
          json_decref(j_response);
          break;
        } else {
          y_log_message(Y_LOG_LEVEL_WARNING, "Security - DPoP invalid at IP Address %s", get_ip_source(request, config->glewlwyd_config->glewlwyd_config->originating_ip_header));
          j_response = json_pack("{ssss}", "error", "invalid_dpop_proof", "error_description", "Invalid DPoP");
          ulfius_set_json_body_response(response, 403, j_response);
          json_decref(j_response);
          config->glewlwyd_config->glewlwyd_plugin_callback_metrics_increment_counter(config->glewlwyd_config, GLWD_METRICS_OIDC_UNAUTHORIZED_CLIENT, 1, "plugin", config->name, NULL);
          break;
        }
      }

      if (!check_result_value(j_jkt, G_OK)) {
        y_log_message(Y_LOG_LEVEL_ERROR, "check_ciba_auth_req_id - oidc - Error oidc_verify_dpop_proof");
        j_response = json_pack("{ss}", "error", "server_error");
        ulfius_set_json_body_response(response, 500, j_response);
        json_decref(j_response);
        break;
      }

      if (json_object_get(j_jkt, "jkt") != NULL) {
        res = check_dpop_jti(config,
                             json_string_value(json_object_get(json_object_get(j_jkt, "claims"), "jti")),
                             json_string_value(json_object_get(json_object_get(j_jkt, "claims"), "htm")),
                             json_string_value(json_object_get(json_object_get(j_jkt, "claims"), "htu")),
                             json_integer_value(json_object_get(json_object_get(j_jkt, "claims"), "iat")),
                             client_id,
                             json_string_value(json_object_get(j_jkt, "jkt")),
                             ip_source);
        if (res == G_ERROR_UNAUTHORIZED) {
          j_response = json_pack("{ssss}", "error", "invalid_dpop_proof", "error_description", "Invalid DPoP");
          ulfius_set_json_body_response(response, 403, j_response);
          json_decref(j_response);
          break;
        }
        if (res != G_OK) {
          y_log_message(Y_LOG_LEVEL_ERROR, "check_ciba_auth_req_id - oidc - Error check_dpop_jti");
          j_response = json_pack("{ss}", "error", "server_error");
          ulfius_set_json_body_response(response, 500, j_response);
          json_decref(j_response);
          break;
        }
        if ((dpop_nonce = refresh_client_dpop_nonce(config, client_id)) != NULL) {
          ulfius_set_response_properties(response, U_OPT_HEADER_PARAMETER, "DPoP-Nonce", dpop_nonce, U_OPT_NONE);
          o_free(dpop_nonce);
        }
      }

      // If we arrive here, request is accepted and valid, let's send the tokens!
      j_user = config->glewlwyd_config->glewlwyd_plugin_callback_get_user(config->glewlwyd_config, json_string_value(json_object_get(json_object_get(j_ciba_request, "ciba"), "username")));
      if (check_result_value(j_user, G_OK)) {
        j_token = generate_ciba_token_response(config, json_object_get(j_client, "client"),
                                               json_object_get(j_user, "user"),
                                               json_object_get(j_ciba_request, "ciba"),
                                               json_string_value(json_object_get(json_object_get(j_ciba_request, "ciba"), "scope")),
                                               json_string_value(json_object_get(json_object_get(j_ciba_request, "ciba"), "sid")),
                                               json_string_value(json_object_get(j_jkt, "jkt")));
        if (check_result_value(j_token, G_OK)) {
          if (close_ciba_request(config, json_integer_value(json_object_get(json_object_get(j_ciba_request, "ciba"), "gpob_id"))) == G_OK) {
            ulfius_set_json_body_response(response, 200, json_object_get(j_token, "token"));
          } else {
            y_log_message(Y_LOG_LEVEL_ERROR, "check_ciba_auth_req_id oidc - Error close_ciba_request");
            j_response = json_pack("{ss}", "error", "server_error");
            ulfius_set_json_body_response(response, 500, j_response);
            json_decref(j_response);
          }
        } else if(check_result_value(j_token, G_ERROR_PARAM)) {
          j_response = json_pack("{ss}", "error", "invalid_request");
          ulfius_set_json_body_response(response, 400, j_response);
          json_decref(j_response);
        } else {
          y_log_message(Y_LOG_LEVEL_ERROR, "check_ciba_auth_req_id oidc - Error generate_ciba_token_response");
          j_response = json_pack("{ss}", "error", "server_error");
          ulfius_set_json_body_response(response, 500, j_response);
          json_decref(j_response);
        }
        json_decref(j_token);
      } else {
        y_log_message(Y_LOG_LEVEL_ERROR, "check_ciba_auth_req_id oidc - Error glewlwyd_plugin_callback_get_user");
        j_response = json_pack("{ss}", "error", "server_error");
        ulfius_set_json_body_response(response, 400, j_response);
        json_decref(j_response);
      }
      json_decref(j_user);
    } while (0);
    json_decref(j_client);
    json_decref(j_jkt);
  } else if (check_result_value(j_ciba_request, G_ERROR_NOT_FOUND)) {
    j_response = json_pack("{ss}", "error", "invalid_grant");
    ulfius_set_json_body_response(response, 400, j_response);
    json_decref(j_response);
  } else {
    y_log_message(Y_LOG_LEVEL_ERROR, "check_ciba_auth_req_id oidc - Error get_ciba_request_from_auth_req_id");
    j_response = json_pack("{ss}", "error", "server_error");
    ulfius_set_json_body_response(response, 400, j_response);
    json_decref(j_response);
  }
  json_decref(j_ciba_request);
  return U_CALLBACK_CONTINUE;
}
