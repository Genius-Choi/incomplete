int spider_db_mbase_util::append_tables_top_down(
  ha_spider *spider,
  spider_fields *fields,
  spider_string *str,
  TABLE_LIST *table_list,
  TABLE_LIST **used_table_list,
  uint *current_pos,
  TABLE_LIST **cond_table_list_ptr
) {
  int error_num;
  uint outer_join_backup;
  TABLE_LIST *cur_table_list, *prev_table_list = NULL, *cond_table_list = NULL;
  bool first = TRUE;
  DBUG_ENTER("spider_db_mbase_util::append_tables_top_down");
  DBUG_PRINT("info",("spider this=%p", this));
  if (
    table_list->outer_join ||
    table_list->on_expr ||
    table_list->join_using_fields
  ) {
    DBUG_ASSERT(!(*cond_table_list_ptr));
    (*cond_table_list_ptr) = table_list;
    DBUG_PRINT("info",("spider cond_table_list=%p", table_list));
  }
  List_iterator_fast<TABLE_LIST> it1(table_list->nested_join->join_list);
  cur_table_list = it1++;
  if (cur_table_list->outer_join & JOIN_TYPE_RIGHT)
  {
    first = FALSE;
    prev_table_list = cur_table_list;
    cur_table_list = it1++;
  } else if (*cond_table_list_ptr)
  {
    first = TRUE;
    cond_table_list = (*cond_table_list_ptr);
    (*cond_table_list_ptr) = NULL;
    if (cond_table_list->outer_join & JOIN_TYPE_LEFT)
    {
      if (str)
      {
        if (str->reserve(SPIDER_SQL_LEFT_JOIN_LEN + SPIDER_SQL_OPEN_PAREN_LEN))
        {
          DBUG_RETURN(HA_ERR_OUT_OF_MEM);
        }
        str->q_append(SPIDER_SQL_LEFT_JOIN_STR, SPIDER_SQL_LEFT_JOIN_LEN);
        str->q_append(SPIDER_SQL_OPEN_PAREN_STR, SPIDER_SQL_OPEN_PAREN_LEN);
      }
    } else {
      if (str)
      {
        if (str->reserve(SPIDER_SQL_JOIN_LEN + SPIDER_SQL_OPEN_PAREN_LEN))
        {
          DBUG_RETURN(HA_ERR_OUT_OF_MEM);
        }
        str->q_append(SPIDER_SQL_JOIN_STR, SPIDER_SQL_JOIN_LEN);
        str->q_append(SPIDER_SQL_OPEN_PAREN_STR, SPIDER_SQL_OPEN_PAREN_LEN);
      }
    }
  }

  do {
    if (cur_table_list->outer_join & JOIN_TYPE_RIGHT)
    {
      prev_table_list = cur_table_list;
    } else {
      if ((error_num = append_table(spider, fields, str, cur_table_list,
        used_table_list, current_pos, cond_table_list_ptr, TRUE, first)))
        DBUG_RETURN(error_num);
      first = FALSE;
      if (prev_table_list)
      {
        outer_join_backup = prev_table_list->outer_join;
        prev_table_list->outer_join = JOIN_TYPE_LEFT;
        if ((error_num = append_table(spider, fields, str, prev_table_list,
          used_table_list, current_pos, cond_table_list_ptr, TRUE, FALSE)))
        {
          prev_table_list->outer_join = outer_join_backup;
          DBUG_RETURN(error_num);
        }
        prev_table_list->outer_join = outer_join_backup;
        prev_table_list = NULL;
      }
    }
  } while ((cur_table_list = it1++));

  if (cond_table_list)
  {
    if (str)
    {
      if (str->reserve(SPIDER_SQL_CLOSE_PAREN_LEN))
      {
        DBUG_RETURN(HA_ERR_OUT_OF_MEM);
      }
      str->q_append(SPIDER_SQL_CLOSE_PAREN_STR,
        SPIDER_SQL_CLOSE_PAREN_LEN);

      List<String> *join_using_fields = cond_table_list->join_using_fields;
      if (join_using_fields)
      {
        if (str->reserve(SPIDER_SQL_USING_LEN + SPIDER_SQL_OPEN_PAREN_LEN))
        {
          DBUG_RETURN(HA_ERR_OUT_OF_MEM);
        }
        str->q_append(SPIDER_SQL_USING_STR, SPIDER_SQL_USING_LEN);
        str->q_append(SPIDER_SQL_OPEN_PAREN_STR,
          SPIDER_SQL_OPEN_PAREN_LEN);
        List_iterator_fast<String> it2(*join_using_fields);
        String *ptr;
        while ((ptr = it2++))
        {
          if (str->reserve(ptr->length() + SPIDER_SQL_COMMA_LEN))
          {
            DBUG_RETURN(HA_ERR_OUT_OF_MEM);
          }
          str->q_append(ptr->ptr(), ptr->length());
          str->q_append(SPIDER_SQL_COMMA_STR, SPIDER_SQL_COMMA_LEN);
        }
        str->length(str->length() - SPIDER_SQL_COMMA_LEN);
        if (str->reserve(SPIDER_SQL_CLOSE_PAREN_LEN))
        {
          DBUG_RETURN(HA_ERR_OUT_OF_MEM);
        }
        str->q_append(SPIDER_SQL_CLOSE_PAREN_STR,
          SPIDER_SQL_CLOSE_PAREN_LEN);
      }
    }

    Item *on_expr = cond_table_list->on_expr;
    if (on_expr)
    {
      if (str)
      {
        if (str->reserve(SPIDER_SQL_ON_LEN))
        {
          DBUG_RETURN(HA_ERR_OUT_OF_MEM);
        }
        str->q_append(SPIDER_SQL_ON_STR, SPIDER_SQL_ON_LEN);
      }
      if ((error_num = spider_db_print_item_type(on_expr, NULL,
        spider, str, NULL, 0, dbton_id, TRUE, fields)))
      {
        DBUG_RETURN(error_num);
      }
    }
  }
  DBUG_RETURN(0);
}
