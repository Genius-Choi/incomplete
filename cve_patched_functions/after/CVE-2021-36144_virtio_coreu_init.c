virtio_coreu_init(struct vmctx *ctx, struct pci_vdev *dev, char *opts)
{
	struct virtio_coreu *vcoreu;
	pthread_mutexattr_t attr;
	char tname[MAXCOMLEN + 1];
	int rc;

	vcoreu = calloc(1, sizeof(struct virtio_coreu));
	if (!vcoreu) {
		WPRINTF(("vcoreu init: fail to alloc virtio_coreu\n"));
		return -1;
	}

	/* init mutex attribute properly */
	int mutexattr_type = virtio_uses_msix()
			? PTHREAD_MUTEX_DEFAULT
			: PTHREAD_MUTEX_RECURSIVE;

	rc = pthread_mutexattr_init(&attr);
	if (rc)
		WPRINTF(("vcoreu init: mutexattr init fail, erro %d\n", rc));
	rc = pthread_mutexattr_settype(&attr, mutexattr_type);
	if (rc)
		WPRINTF(("vcoreu init: mutexattr_settype fail, erro %d\n", rc));
	rc = pthread_mutex_init(&vcoreu->mtx, &attr);
	if (rc)
		WPRINTF(("vcoreu init: mutexattr_settype fail, erro %d\n", rc));

	DPRINTF(("vcoreu init: using VBS-U...\n"));
	virtio_linkup(&vcoreu->base, &virtio_coreu_ops,
			vcoreu, dev, vcoreu->queues, BACKEND_VBSU);
	vcoreu->base.mtx = &vcoreu->mtx;

	vcoreu->queues[0].qsize  = VIRTIO_COREU_RINGSZ;
	vcoreu->queues[0].notify = virtio_coreu_notify;

	/* initialize config space */
	pci_set_cfgdata16(dev, PCIR_DEVICE, VIRTIO_DEV_COREU);
	pci_set_cfgdata16(dev, PCIR_VENDOR, INTEL_VENDOR_ID);
	pci_set_cfgdata8(dev, PCIR_CLASS, PCIC_CRYPTO);
	pci_set_cfgdata8(dev, PCIR_SUBCLASS, PCIS_SIMPLECOMM_OTHER);
	pci_set_cfgdata16(dev, PCIR_SUBDEV_0, VIRTIO_TYPE_COREU);
	pci_set_cfgdata16(dev, PCIR_SUBVEND_0, INTEL_VENDOR_ID);

	if (virtio_interrupt_init(&vcoreu->base, virtio_uses_msix())) {
		WPRINTF(("vcoreu init: interrupt init fail\n"));
		free(vcoreu);
		return -1;
	}

	virtio_set_io_bar(&vcoreu->base, 0);

	/*
	 * connect to coreu daemon in init phase
	 *
	 * @FIXME if failed connecting to CoreU daemon, the return value should
	 * be set appropriately for SOS not exposing the CoreU PCI device to UOS
	 */
	vcoreu->fd = connect_coreu_daemon();
	if (vcoreu->fd < 0) {
		WPRINTF(("connection to server failed\n"));
		pthread_mutex_destroy(&vcoreu->mtx);
		free(vcoreu);
		return -errno;
	}

	pthread_mutex_init(&vcoreu->rx_mtx, NULL);
	pthread_cond_init(&vcoreu->rx_cond, NULL);
	pthread_create(&vcoreu->rx_tid, NULL,
			virtio_coreu_thread, (void *)vcoreu);
	snprintf(tname, sizeof(tname), "vtcoreu-%d:%d tx",
			dev->slot, dev->func);
	pthread_setname_np(vcoreu->rx_tid, tname);

	return 0;
}
