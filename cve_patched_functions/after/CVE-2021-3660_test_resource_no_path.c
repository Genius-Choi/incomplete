test_resource_no_path (TestResourceCase *tc,
                       gconstpointer data)
{
  CockpitWebResponse *response;
  GError *error = NULL;
  GBytes *bytes;
  gconstpointer str;
  const gchar *url = "/cockpit/another@localhost";
  const gchar *expected = "HTTP/1.1 404 Not Found\r\n"
    "Content-Type: text/html; charset=utf8\r\n"
    "Transfer-Encoding: chunked\r\n"
    STATIC_HEADERS
    "\r\n13\r\n"
    "<html><head><title>\r\n9\r\n"
    "Not Found\r\n15\r\n"
    "</title></head><body>\r\n9\r\n"
    "Not Found\r\nf\r\n"
    "</body></html>\n\r\n0\r\n\r\n";

  /* Missing path after package */
  response = cockpit_web_response_new (tc->io, url, url, NULL, NULL, COCKPIT_WEB_RESPONSE_NONE);

  cockpit_channel_response_serve (tc->service, tc->headers, response, "another@localhost", "");

  while (cockpit_web_response_get_state (response) != COCKPIT_WEB_RESPONSE_SENT)
    g_main_context_iteration (NULL, TRUE);

  g_output_stream_close (G_OUTPUT_STREAM (tc->output), NULL, &error);
  g_assert_no_error (error);

  bytes = g_memory_output_stream_steal_as_bytes (tc->output);
  str = g_bytes_get_data (bytes, NULL);
  g_assert (str_contains_strv (str, expected, "\n"));
  cockpit_assert_strmatch (str, "*\r\n13\r\n"
                           "<html><head><title>\r\n9\r\n"
                           "Not Found\r\n15\r\n"
                           "</title></head><body>\r\n9\r\n"
                           "Not Found\r\nf\r\n"
                           "</body></html>\n\r\n0\r\n\r\n");

  g_bytes_unref (bytes);
  g_object_unref (response);
}
