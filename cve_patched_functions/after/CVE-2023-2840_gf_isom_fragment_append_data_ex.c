GF_Err gf_isom_fragment_append_data_ex(GF_ISOFile *movie, GF_ISOTrackID TrackID, u8 *data, u32 data_size, u8 PaddingBits, void **ref, u32 ref_offset)
{
	u32 count;
	u8 rap;
	u16 degp;
	GF_TrunEntry *ent;
	GF_TrackFragmentBox *traf;
	GF_TrackFragmentRunBox *trun;
	if (!movie->moof || !(movie->FragmentsFlags & GF_ISOM_FRAG_WRITE_READY) ) return GF_BAD_PARAM;

	traf = gf_isom_get_traf(movie, TrackID);
	if (!traf || !traf->tfhd->sample_desc_index) return GF_BAD_PARAM;

	//add TRUN entry
	count = gf_list_count(traf->TrackRuns);
	if (!count) return GF_BAD_PARAM;

	trun = (GF_TrackFragmentRunBox *)gf_list_get(traf->TrackRuns, count-1);
	if (!trun->nb_samples) return GF_BAD_PARAM;
	ent = &trun->samples[trun->nb_samples-1];
	ent->size += data_size;
	trun->run_size += data_size;

	rap = GF_ISOM_GET_FRAG_SYNC(ent->flags);
	degp = GF_ISOM_GET_FRAG_DEG(ent->flags);
	ent->flags = GF_ISOM_FORMAT_FRAG_FLAGS(PaddingBits, rap, degp);

	//finally write the data
	if (!traf->DataCache) {
		if (movie->moof_first && movie->on_block_out && (ref || trun->sample_refs)) {
			GF_TrafSampleRef *sref;
			if (!trun->sample_refs) trun->sample_refs = gf_list_new();
			GF_SAFEALLOC(sref, GF_TrafSampleRef);
			if (!sref) return GF_OUT_OF_MEM;
			if (ref && *ref) {
				sref->data = data;
				sref->len = data_size;
				sref->ref = *ref;
				sref->ref_offset = ref_offset;
				*ref = NULL;
			} else {
				sref->data = gf_malloc(data_size);
				if (!sref->data) {
					gf_free(sref);
					return GF_OUT_OF_MEM;
				}
				memcpy(sref->data, data, data_size);
				sref->len = data_size;
			}
			traf->trun_ref_size += sref->len;
			movie->moof->trun_ref_size += sref->len;
			gf_list_add(trun->sample_refs, sref);
		} else {
			gf_bs_write_data(movie->editFileMap->bs, data, data_size);
		}
	} else if (trun->cache) {
		gf_bs_write_data(trun->cache, data, data_size);
	} else {
		return GF_BAD_PARAM;
	}
	return GF_OK;
}
