static int create_wolfssl_instance(TLS_IO_INSTANCE* tls_io_instance)
{
    int result;
    tls_io_instance->ssl = wolfSSL_new(tls_io_instance->ssl_context);
    if (tls_io_instance->ssl == NULL)
    {
        LogError("Failed to add certificates to store");
        result = MU_FAILURE;
    }
    else
    {
        tls_io_instance->socket_io_read_bytes = NULL;
        tls_io_instance->socket_io_read_byte_count = 0;
        tls_io_instance->on_send_complete = NULL;
        tls_io_instance->on_send_complete_callback_context = NULL;
#ifdef INVALID_DEVID
        tls_io_instance->wolfssl_device_id = INVALID_DEVID;
#endif

        wolfSSL_set_using_nonblock(tls_io_instance->ssl, 1);
        wolfSSL_SetHsDoneCb(tls_io_instance->ssl, on_handshake_done, tls_io_instance);
        wolfSSL_SetIOWriteCtx(tls_io_instance->ssl, tls_io_instance);
        wolfSSL_SetIOReadCtx(tls_io_instance->ssl, tls_io_instance);

        tls_io_instance->tlsio_state = TLSIO_STATE_NOT_OPEN;
        result = 0;

#ifdef HAVE_SECURE_RENEGOTIATION
        if (wolfSSL_UseSecureRenegotiation(tls_io_instance->ssl) != SSL_SUCCESS)
        {
            LogError("unable to enable secure renegotiation");
            result = MU_FAILURE;
        }
#endif
    }
    return result;
}
