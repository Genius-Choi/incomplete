bool JT_PushMessage::take(const QDomElement &e)
{
	if(e.tagName() != "message")
		return false;

	QDomElement e1 = e;
	QDomElement forward;
	Message::CarbonDir cd = Message::NoCarbon;

	Jid fromJid = Jid(e1.attribute(QLatin1String("from")));
	// Check for Carbon
	QDomNodeList list = e1.childNodes();
	for (int i = 0; i < list.size(); ++i) {
		QDomElement el = list.at(i).toElement();

		if (el.attribute("xmlns") == QLatin1String("urn:xmpp:carbons:2")
		    && (el.tagName() == QLatin1String("received") || el.tagName() == QLatin1String("sent"))
		    && fromJid.compare(Jid(e1.attribute(QLatin1String("to"))), false)) {
			QDomElement el1 = el.firstChildElement();
			if (el1.tagName() == QLatin1String("forwarded")
			    && el1.attribute(QLatin1String("xmlns")) == QLatin1String("urn:xmpp:forward:0")) {
				QDomElement el2 = el1.firstChildElement(QLatin1String("message"));
				if (!el2.isNull()) {
					forward = el2;
					cd = el.tagName() == QLatin1String("received")? Message::Received : Message::Sent;
					break;
				}
			}
		}
		else if (el.tagName() == QLatin1String("forwarded")
			 && el.attribute(QLatin1String("xmlns")) == QLatin1String("urn:xmpp:forward:0")) {
			forward = el.firstChildElement(QLatin1String("message")); // currently only messages are supportted
			// TODO <delay> element support
			if (!forward.isNull()) {
				break;
			}
		}
	}

	Stanza s = client()->stream().createStanza(addCorrectNS(forward.isNull()? e1 : forward));
	if(s.isNull()) {
		//printf("take: bad stanza??\n");
		return false;
	}

	Message m;
	if(!m.fromStanza(s, client()->manualTimeZoneOffset(), client()->timeZoneOffset())) {
		//printf("bad message\n");
		return false;
	}
	if (!forward.isNull()) {
		m.setForwardedFrom(fromJid);
		m.setCarbonDirection(cd);
	}

	emit message(m);
	return true;
}
