struct pico_socket *pico_socket_ipv4_open(struct pico_stack *S, uint16_t proto)
{
    struct pico_socket_ipv4 *s;
    if ((proto & PICO_PROTO_RAWSOCKET) == 0) {
        pico_err = PICO_ERR_EINVAL;
        return NULL;
    }

    s = PICO_ZALLOC(sizeof(struct pico_socket_ipv4));
    if (!s) {
        pico_err = PICO_ERR_ENOMEM;
        return NULL;
    }
    if ((proto & 0x00FF)== PICO_RAWSOCKET_RAW)
        s->hdr_included = 1;
    s->id = S->IP4Socket_id++;
    s->proto = (uint8_t)(proto & 0x00FF);
    s->sock.proto = &pico_proto_ipv4;
    s->sock.stack = S;

    pico_tree_insert(&S->IP4Sockets, s);
    return (struct pico_socket *)s;
}
