static char * build_jwt_auth_response(struct _oidc_config * config, json_t * j_client, struct _u_map * map_query, int * enc_res) {
  jwt_t * jwt;
  jwa_alg alg = get_token_sign_alg(config, j_client, GLEWLWYD_TOKEN_TYPE_AUTH);
  jwk_t * jwk = get_jwk_sign(config, j_client, alg);
  time_t now;
  char * token = NULL, * out_token = NULL;
  const char ** keys, * value;
  size_t i;

  time(&now);
  if (jwk != NULL && alg != R_JWA_ALG_UNKNOWN) {
    if (r_jwt_init(&jwt) == RHN_OK) {
      if (r_jwt_set_properties(jwt, RHN_OPT_SIG_ALG, alg,
                                    RHN_OPT_CLAIM_JSON_T_VALUE, "iss", json_object_get(config->j_params, "iss"),
                                    RHN_OPT_CLAIM_JSON_T_VALUE, "aud", json_object_get(j_client, "client_id"),
                                    RHN_OPT_CLAIM_RHN_INT_VALUE, "exp", ((rhn_int_t)now)+config->access_token_duration,
                                    RHN_OPT_NONE) == RHN_OK) {
        keys = u_map_enum_keys(map_query);
        for (i=0; keys[i]!=NULL; i++) {
          value = u_map_get(map_query, keys[i]);
          if (!o_strnullempty(value)) {
            r_jwt_set_claim_str_value(jwt, keys[i], value);
          }
        }
        if ((token = r_jwt_serialize_signed(jwt, jwk, 0)) == NULL) {
          y_log_message(Y_LOG_LEVEL_ERROR, "build_jwt_auth_response - Error r_jwt_serialize_signed");
        }
      } else {
        y_log_message(Y_LOG_LEVEL_ERROR, "build_jwt_auth_response - Error r_jwt_set_properties");
      }
    } else {
      y_log_message(Y_LOG_LEVEL_ERROR, "build_jwt_auth_response - oidc - Error r_jwt_init");
    }
    r_jwt_free(jwt);
  } else {
    y_log_message(Y_LOG_LEVEL_ERROR, "build_jwt_auth_response - oidc - Error no jwk available");
  }
  r_jwk_free(jwk);
  if (token != NULL) {
    out_token = encrypt_token_if_required(config, token, j_client, GLEWLWYD_TOKEN_TYPE_AUTH, enc_res);
    o_free(token);
  }
  return out_token;
}
