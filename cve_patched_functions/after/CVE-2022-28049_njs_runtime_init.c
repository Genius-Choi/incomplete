njs_runtime_init(njs_vm_t *vm, njs_opts_t *opts)
{
    njs_int_t      ret;
    njs_uint_t     i;
    njs_runtime_t  *rt;

    rt = njs_mp_alloc(vm->mem_pool, sizeof(njs_runtime_t));
    if (rt == NULL) {
        return NULL;
    }

    rt->size = opts->repeat;
    rt->states = njs_mp_alloc(vm->mem_pool,
                              sizeof(njs_external_state_t) * rt->size);
    if (rt->states == NULL) {
        return NULL;
    }

    rt->current = 0;
    srandom(opts->seed);

    for (i = 0; i < rt->size; i++) {
        ret = njs_external_state_init(vm, &rt->states[i], opts);
        if (ret != NJS_OK) {
            njs_stderror("njs_external_state_init() failed\n");
            return NULL;
        }
    }

    return rt;
}
