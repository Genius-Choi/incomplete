HANDLE CEAnsi::XTermBufferConEmuPrimary()
{
	// Сброс расширенных атрибутов!
	CONSOLE_SCREEN_BUFFER_INFO csbi = {};
	HANDLE hOut = GetStdHandle(STD_OUTPUT_HANDLE);
	if (GetConsoleScreenBufferInfoCached(hOut, &csbi, TRUE))
	{
		const WORD nDefAttr = GetDefaultTextAttr();
		// Сброс только расширенных атрибутов
		ExtFillOutputParm fill = {sizeof(fill), /*efof_ResetExt|*/efof_Attribute/*|efof_Character*/, hOut,
			{ConEmu::ColorFlags::None, CONFORECOLOR(nDefAttr), CONBACKCOLOR(nDefAttr)},
			L' ', {0,0}, static_cast<DWORD>(csbi.dwSize.X * csbi.dwSize.Y)};
		ExtFillOutput(&fill);
		CEAnsi* pObj = CEAnsi::Object();
		if (pObj)
			pObj->ReSetDisplayParm(hOut, TRUE, TRUE);
		else
			SetConsoleTextAttribute(hOut, nDefAttr);
	}

	if (!IsWin7Eql() && ghStdOut.HasHandle())
	{
		SetStdHandle(STD_OUTPUT_HANDLE, ghStdOut);
		SetStdHandle(STD_ERROR_HANDLE, ghStdErr);
		hOut = ghStdOut.Release();
		ghConOut.Close();
	}

	// restore backscroll size and data
	CESERVER_REQ *pIn = nullptr, *pOut = nullptr;
	pIn = ExecuteNewCmd(CECMD_ALTBUFFER,sizeof(CESERVER_REQ_HDR)+sizeof(CESERVER_REQ_ALTBUFFER));
	if (pIn)
	{
		TODO("BufferWidth");
		pIn->AltBuf.AbFlags = abf_BufferOn | abf_RestoreContents;
		if (!gXTermAltBuffer.BufferSize)
			pIn->AltBuf.AbFlags |= abf_BufferOff;
		if (isConnectorStarted())
			pIn->AltBuf.AbFlags |= abf_Connector;
		pIn->AltBuf.BufferHeight = static_cast<USHORT>(gXTermAltBuffer.BufferSize);
		// Async - is not allowed. Otherwise current application (cmd.exe for example)
		// may start printing before server finishes buffer restoration
		pOut = ExecuteSrvCmd(gnServerPID, pIn, ghConWnd);
		ExecuteFreeResult(pIn);
		ExecuteFreeResult(pOut);
		// Restore saved states
		if ((gDisplayCursor.bCursorPosStored = !!(gXTermAltBuffer.Flags & xtb_StoredCursor)))
		{
			gDisplayCursor.StoredCursorPos = gXTermAltBuffer.CursorPos;
		}
		if ((gDisplayOpt.ScrollRegion = !!(gXTermAltBuffer.Flags & xtb_StoredScrollRegion)))
		{
			gDisplayOpt.ScrollStart = gXTermAltBuffer.ScrollStart;
			gDisplayOpt.ScrollEnd = gXTermAltBuffer.ScrollEnd;
		}
	}
	return hOut;
}
