static char *construct_querystring(struct MHD_Connection *connection, t_client *client, char *originurl, char *querystr ) {

	char cid[87] = {0};
	char *clienttype;
	char *clientif;
	char *query_str;
	char *query_str_b64;
	char *msg;
	char *cidinfo;
	char *cidfile;
	char *gw_url_raw;
	char *gw_url;
	char *phpcmd;
	int cidgood = 0;

	s_config *config = config_get_config();

	gw_url_raw = safe_calloc(REDIRECT_URL);

	if (strcmp(config->gw_fqdn, "disable") == 0 || strcmp(config->gw_fqdn, "disabled") == 0) {
		safe_snprintf(gw_url_raw, REDIRECT_URL, "http://%s", config->gw_ip);
	} else {
		safe_snprintf(gw_url_raw, REDIRECT_URL, "http://%s", config->gw_fqdn);
	}

	gw_url = safe_calloc(REDIRECT_URL_ENC_BUF);
	uh_urlencode(gw_url, REDIRECT_URL_ENC_BUF, gw_url_raw, strlen(gw_url_raw));
	debug(LOG_DEBUG, "gw_url: %s", gw_url);
	free (gw_url_raw);

	clienttype = safe_calloc(STATUS_BUF);

	if (!client->client_type || strlen(client->client_type) == 0) {
		clienttype = safe_strdup("cpd_can");
	} else {
		clienttype = safe_strdup(client->client_type);
	}

	if (config->fas_secure_enabled == 0) {
		snprintf(querystr, QUERYMAXLEN, "?clientip=%s&gatewayname=%s&tok=%s&redir=%s",
			client->ip,
			config->url_encoded_gw_name,
			client->token,
			originurl
		);

	} else if (config->fas_secure_enabled == 1) {

			if (config->fas_hid) {
				debug(LOG_DEBUG, "hid=%s", client->hid);

				clientif = safe_calloc(STATUS_BUF);

				get_client_interface(clientif, STATUS_BUF, client->mac);
				debug(LOG_DEBUG, "clientif: [%s] url_encoded_gw_name: [%s]", clientif, config->url_encoded_gw_name);

				query_str = safe_calloc(QUERYMAXLEN);

				snprintf(query_str, QUERYMAXLEN,
					"hid=%s%sclientip=%s%sclientmac=%s%sclient_type=%s%scpi_query=%s%sgatewayname=%s%sgatewayurl=%s%sversion=%s%sgatewayaddress=%s%sgatewaymac=%s%soriginurl=%s%sclientif=%s%sthemespec=%s%s%s%s%s%s",
					client->hid, QUERYSEPARATOR,
					client->ip, QUERYSEPARATOR,
					client->mac, QUERYSEPARATOR,
					clienttype, QUERYSEPARATOR,
					client->cpi_query, QUERYSEPARATOR,
					config->url_encoded_gw_name, QUERYSEPARATOR,
					gw_url, QUERYSEPARATOR,
					VERSION, QUERYSEPARATOR,
					config->gw_address, QUERYSEPARATOR,
					config->gw_mac, QUERYSEPARATOR,
					originurl, QUERYSEPARATOR,
					clientif, QUERYSEPARATOR,
					config->themespec_path, QUERYSEPARATOR,
					config->custom_params,
					config->custom_vars,
					config->custom_images,
					config->custom_files
				);

				query_str_b64 = safe_calloc(ENC_QUERYSTR);

				b64_encode(query_str_b64, ENC_QUERYSTR, query_str, strlen(query_str));

				snprintf(querystr, ENC_QUERYSTR,
					"?fas=%s",
					query_str_b64
				);

				if (config->login_option_enabled >=1) {
					if (client->cid) {
						cidgood = 1;
						cidfile = safe_calloc(SMALL_BUF);
						safe_snprintf(cidfile, SMALL_BUF, "%s/ndscids/%s", config->tmpfsmountpoint, client->cid);

						// Check if cidfile exists
						if(access(cidfile, F_OK) != 0) {
							// does not exist
							cidgood=0;
						}
						free(cidfile);
					}

					if (cidgood == 0) {
						strncpy(cid, query_str_b64+5, 86);
						client->cid = safe_strdup(cid);

						// Write the new cidfile:
						msg = safe_calloc(STATUS_BUF);
						cidinfo = safe_calloc(SMALL_BUF);
						debug(LOG_DEBUG, "writing cid file [%s]", cid);

						safe_snprintf(cidinfo, SMALL_BUF, "hid=\"%s\"\0", client->hid);
						write_client_info(msg, STATUS_BUF, "write", cid, cidinfo);

						safe_snprintf(cidinfo, SMALL_BUF, "clientip=\"%s\"\0", client->ip);
						write_client_info(msg, STATUS_BUF, "write", cid, cidinfo);

						safe_snprintf(cidinfo, SMALL_BUF, "clientmac=\"%s\"\0", client->mac);
						write_client_info(msg, STATUS_BUF, "write", cid, cidinfo);

						safe_snprintf(cidinfo, SMALL_BUF, "cpi_query=\"%s\"\0", client->cpi_query);
						write_client_info(msg, STATUS_BUF, "write", cid, cidinfo);


						safe_snprintf(cidinfo, SMALL_BUF, "client_type=\"%s\"\0", clienttype);
						write_client_info(msg, STATUS_BUF, "write", cid, cidinfo);

						safe_snprintf(cidinfo, SMALL_BUF, "gatewayname=\"%s\"\0", config->http_encoded_gw_name);
						write_client_info(msg, STATUS_BUF, "write", cid, cidinfo);

						safe_snprintf(cidinfo, SMALL_BUF, "gatewayurl=\"%s\"\0", gw_url);
						write_client_info(msg, STATUS_BUF, "write", cid, cidinfo);

						safe_snprintf(cidinfo, SMALL_BUF, "version=\"%s\"\0", VERSION);
						write_client_info(msg, STATUS_BUF, "write", cid, cidinfo);

						safe_snprintf(cidinfo, SMALL_BUF, "gatewayaddress=\"%s\"\0", config->gw_address);
						write_client_info(msg, STATUS_BUF, "write", cid, cidinfo);

						safe_snprintf(cidinfo, SMALL_BUF, "gatewaymac=\"%s\"\0", config->gw_mac);
						write_client_info(msg, STATUS_BUF, "write", cid, cidinfo);

						safe_snprintf(cidinfo, SMALL_BUF, "originurl=\"%s\"\0", originurl);
						write_client_info(msg, STATUS_BUF, "write", cid, cidinfo);

						safe_snprintf(cidinfo, SMALL_BUF, "clientif=\"%s\"\0", clientif);
						write_client_info(msg, STATUS_BUF, "write", cid, cidinfo);

						if (config->themespec_path) {
							safe_snprintf(cidinfo, SMALL_BUF, "themespec=\"%s\"\0", config->themespec_path);
							write_client_info(msg, STATUS_BUF, "write", cid, cidinfo);
						}

						if (config->custom_params) {
							safe_snprintf(cidinfo, SMALL_BUF, "%s\0", config->custom_params);
							write_client_info(msg, STATUS_BUF, "parse", cid, cidinfo);
						}

						if (config->custom_vars) {
							safe_snprintf(cidinfo, SMALL_BUF, "%s\0", config->custom_vars);
							write_client_info(msg, STATUS_BUF, "parse", cid, cidinfo);
						}

						if (config->custom_images) {
							safe_snprintf(cidinfo, SMALL_BUF, "%s\0", config->custom_images);
							write_client_info(msg, STATUS_BUF, "parse", cid, cidinfo);
						}

						if (config->custom_files) {
							safe_snprintf(cidinfo, SMALL_BUF, "%s\0", config->custom_files);
							write_client_info(msg, STATUS_BUF, "parse", cid, cidinfo);
						}

						free(msg);
						free(cidinfo);
					}
				}

				free(query_str);
				free(query_str_b64);
				free(clientif);

			} else {
				snprintf(querystr, QUERYMAXLEN,
					"?clientip=%s&gatewayname=%s&redir=%s",
					client->ip,
					config->url_encoded_gw_name,
					originurl
				);
			}

	} else if (config->fas_secure_enabled == 2 || config->fas_secure_enabled == 3) {

		debug(LOG_DEBUG, "hid=%s", client->hid);

		clientif = safe_calloc(STATUS_BUF);
		get_client_interface(clientif, STATUS_BUF, client->mac);
		debug(LOG_DEBUG, "clientif: [%s]", clientif);
		snprintf(querystr, QUERYMAXLEN,
			"hid=%s%sclientip=%s%sclientmac=%s%sclient_type=%s%scpi_query=%s%sgatewayname=%s%sgatewayurl=%s%sversion=%s%sgatewayaddress=%s%sgatewaymac=%s%sauthdir=%s%soriginurl=%s%sclientif=%s%sthemespec=%s%s%s%s%s%s",
			client->hid, QUERYSEPARATOR,
			client->ip, QUERYSEPARATOR,
			client->mac, QUERYSEPARATOR,
			clienttype, QUERYSEPARATOR,
			client->cpi_query, QUERYSEPARATOR,
			config->url_encoded_gw_name, QUERYSEPARATOR,
			gw_url, QUERYSEPARATOR,
			VERSION, QUERYSEPARATOR,
			config->gw_address, QUERYSEPARATOR,
			config->gw_mac, QUERYSEPARATOR,
			config->authdir, QUERYSEPARATOR,
			originurl, QUERYSEPARATOR,
			clientif, QUERYSEPARATOR,
			config->themespec_path, QUERYSEPARATOR,
			config->custom_params,
			config->custom_vars,
			config->custom_images,
			config->custom_files
		);

		phpcmd = safe_calloc(QUERYMAXLEN);
		safe_snprintf(phpcmd, QUERYMAXLEN,
			"echo '<?php \n"
			"$key=\"%s\";\n"
			"$string=\"%s\";\n"
			"$cipher=\"aes-256-cbc\";\n"

			"if (in_array($cipher, openssl_get_cipher_methods())) {\n"
				"$secret_iv = base64_encode(openssl_random_pseudo_bytes(\"8\"));\n"
				"$iv = substr(openssl_digest($secret_iv, \"sha256\"), 0, 16 );\n"
				"$string = base64_encode( openssl_encrypt( $string, $cipher, $key, 0, $iv ) );\n"
				"echo \"?fas=\".$string.\"&iv=\".$iv;\n"
			"}\n"
			" ?>' "
			" | %s\n",
			config->fas_key,
			querystr,
			config->fas_ssl
		);

		debug(LOG_DEBUG, "phpcmd: %s", phpcmd);

		msg = safe_calloc(QUERYMAXLEN);

		if (!msg) {
			send_error(connection, 503);
			free(msg);
		} else {

			if (! execute_ret_url_encoded(msg, QUERYMAXLEN - 1, phpcmd) == 0) {
				debug(LOG_ERR, "Error encrypting query string. %s", msg);
			}

			snprintf(querystr, QUERYMAXLEN, "%s", msg);

			free(msg);
			free(phpcmd);
		}
		free(clientif);

	} else {
		snprintf(querystr, QUERYMAXLEN, "?clientip=%s&gatewayname=%s", client->ip, config->url_encoded_gw_name);
	}

	debug(LOG_DEBUG, "Constructed Query String [%s]", querystr);
	free(clienttype);
	free(gw_url);
	return querystr;
}
