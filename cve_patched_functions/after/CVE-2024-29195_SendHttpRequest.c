static HTTPAPI_RESULT SendHttpRequest(HTTP_HANDLE_DATA* handleData, HINTERNET requestHandle, const unsigned char* content, size_t contentLength, const wchar_t* httpHeaders)
{
    HTTPAPI_RESULT result;

    if (WinHttpSetTimeouts(requestHandle,
        0,                      /*_In_  int dwResolveTimeout - The initial value is zero, meaning no time-out (infinite). */
        60000,                  /*_In_  int dwConnectTimeout, -  The initial value is 60,000 (60 seconds).*/
        handleData->timeout,    /*_In_  int dwSendTimeout, -  The initial value is 30,000 (30 seconds).*/
        handleData->timeout     /* int dwReceiveTimeout The initial value is 30,000 (30 seconds).*/
    ) == FALSE)
    {
        result = HTTPAPI_SET_TIMEOUTS_FAILED;
        LogErrorWinHTTPWithGetLastErrorAsString("WinHttpOpenRequest failed (result = %" PRI_MU_ENUM ")", MU_ENUM_VALUE(HTTPAPI_RESULT, result));
    }
    else
    {
        DWORD dwSecurityFlags;

        if (handleData->trustedCertificate != NULL)
        {
            // If caller has specified trusted certificates, then we'll instruct Winhttp to ignore certain classes
            // of invalid certificate errors (since the trusted cert won't chain into the Windows cert store).
            // We will validate certificate manually during Winhttp callbacks.
            dwSecurityFlags = SECURITY_FLAG_IGNORE_UNKNOWN_CA;
        }
        else
        {
            dwSecurityFlags = 0;
        }

        if (!WinHttpSetOption(
            requestHandle,
            WINHTTP_OPTION_SECURITY_FLAGS,
            &dwSecurityFlags,
            sizeof(dwSecurityFlags)))
        {
            result = HTTPAPI_SET_OPTION_FAILED;
            LogErrorWinHTTPWithGetLastErrorAsString("WinHttpSetOption failed (result = %" PRI_MU_ENUM ").", MU_ENUM_VALUE(HTTPAPI_RESULT, result));
        }
        else if (!WinHttpSendRequest(
                requestHandle,
                httpHeaders,
                (DWORD)-1L, /*An unsigned long integer value that contains the length, in characters, of the additional headers. If this parameter is -1L ... */
                (void*)content,
                (DWORD)contentLength,
                (DWORD)contentLength,
                (DWORD_PTR)handleData))
        {
            result = HTTPAPI_SEND_REQUEST_FAILED;
            LogErrorWinHTTPWithGetLastErrorAsString("WinHttpSendRequest: (result = %" PRI_MU_ENUM ").", MU_ENUM_VALUE(HTTPAPI_RESULT, result));
        }
        else
        {
            result = HTTPAPI_OK;
        }
    }
    
    return result;    
}
