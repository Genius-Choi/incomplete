static int send_ciba_client_notification(struct _oidc_config * config, json_t * j_client, json_t * j_user, json_t * j_ciba_request, const char * scope_list, int status, const char * sid) {
  int ret;
  struct _u_request req;
  struct _u_response resp;
  char * bearer_token;
  json_t * j_body, * j_ciba_token;

  if (0 == o_strcmp(json_string_value(json_object_get(j_client, "backchannel_token_delivery_mode")), "poll")) {
    ret = G_OK; // Nothing to do, client will poll token endpoint
  } else if (0 == o_strcmp(json_string_value(json_object_get(j_client, "backchannel_token_delivery_mode")), "ping")) {
    // send ping request
    if (ulfius_init_request(&req) == U_OK) {
      if (ulfius_init_response(&resp) == U_OK) {
        bearer_token = msprintf("Bearer %s", json_string_value(json_object_get(j_ciba_request, "client_notification_token")));
        j_body = json_pack("{ss}", "auth_req_id", json_string_value(json_object_get(j_ciba_request, "auth_req_id")));
        ulfius_set_request_properties(&req, U_OPT_HTTP_VERB, "POST",
                                            U_OPT_HTTP_URL, json_string_value(json_object_get(j_client, "backchannel_client_notification_endpoint")),
                                            U_OPT_JSON_BODY, j_body,
                                            U_OPT_HEADER_PARAMETER, "Authorization", bearer_token,
                                            U_OPT_CHECK_SERVER_CERTIFICATE, json_object_get(config->j_params, "oauth-ciba-allow-https-non-secure")==json_true()?0:1,
                                            U_OPT_CHECK_PROXY_CERTIFICATE, json_object_get(config->j_params, "oauth-ciba-allow-https-non-secure")==json_true()?0:1,
                                            U_OPT_NONE);
        o_free(bearer_token);
        json_decref(j_body);
        if (ulfius_send_http_request_with_limit(&req, &resp, 1, 8) == U_OK) {
          if (resp.status == 200 || resp.status == 204) {
            ret = G_OK;
          } else {
            y_log_message(Y_LOG_LEVEL_ERROR, "send_ciba_client_notification ping - Invalid response status: %d", resp.status);
            ret = G_ERROR;
          }
        } else {
          y_log_message(Y_LOG_LEVEL_ERROR, "send_ciba_client_notification ping - Error ulfius_send_http_request_with_limit");
          ret = G_ERROR;
        }
        ulfius_clean_response(&resp);
      } else {
        y_log_message(Y_LOG_LEVEL_ERROR, "send_ciba_client_notification ping - Error ulfius_init_request");
        ret = G_ERROR;
      }
      ulfius_clean_request(&req);
    } else {
      y_log_message(Y_LOG_LEVEL_ERROR, "send_ciba_client_notification ping - Error ulfius_init_request");
      ret = G_ERROR;
    }
  } else if (0 == o_strcmp(json_string_value(json_object_get(j_client, "backchannel_token_delivery_mode")), "push")) {
    if (status == 1) {
      j_ciba_token = generate_ciba_token_response(config, j_client, j_user, j_ciba_request, scope_list, sid, json_string_value(json_object_get(j_ciba_request, "dpop_jkt")));
      if (check_result_value(j_ciba_token, G_OK)) {
        if (close_ciba_request(config, json_integer_value(json_object_get(j_ciba_request, "gpob_id"))) == G_OK) {
          if (ulfius_init_request(&req) == U_OK) {
            if (ulfius_init_response(&resp) == U_OK) {
              bearer_token = msprintf("Bearer %s", json_string_value(json_object_get(j_ciba_request, "client_notification_token")));
              ulfius_set_request_properties(&req, U_OPT_HTTP_VERB, "POST",
                                                  U_OPT_HTTP_URL, json_string_value(json_object_get(j_client, "backchannel_client_notification_endpoint")),
                                                  U_OPT_JSON_BODY, json_object_get(j_ciba_token, "token"),
                                                  U_OPT_HEADER_PARAMETER, "Authorization", bearer_token,
                                                  U_OPT_CHECK_SERVER_CERTIFICATE, json_object_get(config->j_params, "oauth-ciba-allow-https-non-secure")==json_true()?0:1,
                                                  U_OPT_CHECK_PROXY_CERTIFICATE, json_object_get(config->j_params, "oauth-ciba-allow-https-non-secure")==json_true()?0:1,
                                                  U_OPT_NONE);
              o_free(bearer_token);
              if (ulfius_send_http_request_with_limit(&req, &resp, 1, 8) == U_OK) {
                if (resp.status == 200 || resp.status == 204) {
                  ret = G_OK;
                } else {
                  y_log_message(Y_LOG_LEVEL_ERROR, "send_ciba_client_notification push - Invalid response status: %d", resp.status);
                  ret = G_ERROR;
                }
              } else {
                y_log_message(Y_LOG_LEVEL_ERROR, "send_ciba_client_notification push - Error ulfius_send_http_request_with_limit");
                ret = G_ERROR;
              }
              ulfius_clean_response(&resp);
            } else {
              y_log_message(Y_LOG_LEVEL_ERROR, "send_ciba_client_notification push - Error ulfius_init_request");
              ret = G_ERROR;
            }
            ulfius_clean_request(&req);
          } else {
            y_log_message(Y_LOG_LEVEL_ERROR, "send_ciba_client_notification push - Error ulfius_init_request");
            ret = G_ERROR;
          }
        } else {
          y_log_message(Y_LOG_LEVEL_ERROR, "send_ciba_client_notification push - Error close_ciba_request");
          ret = G_ERROR;
        }
      } else if (check_result_value(j_ciba_token, G_ERROR_PARAM)) {
        ret = G_ERROR_PARAM;
      } else {
        y_log_message(Y_LOG_LEVEL_ERROR, "send_ciba_client_notification push - Error generate_ciba_token_response");
        ret = G_ERROR;
      }
      json_decref(j_ciba_token);
    } else {
    if (ulfius_init_request(&req) == U_OK) {
        if (ulfius_init_response(&resp) == U_OK) {
          bearer_token = msprintf("Bearer %s", json_string_value(json_object_get(j_ciba_request, "client_notification_token")));
          j_body = json_pack("{ss}", "error", "access_denied");
          ulfius_set_request_properties(&req, U_OPT_HTTP_VERB, "POST",
                                              U_OPT_HTTP_URL, json_string_value(json_object_get(j_client, "backchannel_client_notification_endpoint")),
                                              U_OPT_JSON_BODY, j_body,
                                              U_OPT_HEADER_PARAMETER, "Authorization", bearer_token,
                                              U_OPT_CHECK_SERVER_CERTIFICATE, json_object_get(config->j_params, "oauth-ciba-allow-https-non-secure")==json_true()?0:1,
                                              U_OPT_CHECK_PROXY_CERTIFICATE, json_object_get(config->j_params, "oauth-ciba-allow-https-non-secure")==json_true()?0:1,
                                              U_OPT_NONE);
          o_free(bearer_token);
          json_decref(j_body);
          if (ulfius_send_http_request_with_limit(&req, &resp, 1, 8) == U_OK) {
            if (resp.status == 200 || resp.status == 204) {
              ret = G_OK;
            } else {
              y_log_message(Y_LOG_LEVEL_ERROR, "send_ciba_client_notification ping - Invalid response status: %d", resp.status);
              ret = G_ERROR;
            }
          } else {
            y_log_message(Y_LOG_LEVEL_ERROR, "send_ciba_client_notification push - Error ulfius_send_http_request_with_limit");
            ret = G_ERROR;
          }
          ulfius_clean_response(&resp);
        } else {
          y_log_message(Y_LOG_LEVEL_ERROR, "send_ciba_client_notification ping - Error ulfius_init_request");
          ret = G_ERROR;
        }
        ulfius_clean_request(&req);
      } else {
        y_log_message(Y_LOG_LEVEL_ERROR, "send_ciba_client_notification ping - Error ulfius_init_request");
        ret = G_ERROR;
      }
    }
  } else {
    ret = G_ERROR_PARAM;
  }
  return ret;
}
