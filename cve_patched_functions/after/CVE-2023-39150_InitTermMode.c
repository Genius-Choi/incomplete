void CEAnsi::InitTermMode()
{
	bool needSetXterm = false;

	if (IsWin10())
	{
		const MHandle hOut{ GetStdHandle(STD_OUTPUT_HANDLE) };
		gPrevConOutMode = 0;
		if (GetConsoleMode(hOut, &gPrevConOutMode))
		{
			if (gPrevConOutMode & ENABLE_VIRTUAL_TERMINAL_PROCESSING)
			{
				needSetXterm = true;
			}
		}
	}

	if (gbIsVimProcess)
	{
		StartVimTerm(true);
		_ASSERTE(CEAnsi::gbIsXTermOutput == true);
	}

	if (needSetXterm)
	{
		DBG_XTERM(L"xTermOutput=ON due ENABLE_VIRTUAL_TERMINAL_PROCESSING in InitTermMode");
		DBG_XTERM(L"AutoLfNl=OFF due ENABLE_VIRTUAL_TERMINAL_PROCESSING in InitTermMode");
		DBG_XTERM(L"term=XTerm due ENABLE_VIRTUAL_TERMINAL_PROCESSING in InitTermMode");
		StartXTermMode(true);
	}

	if (CEAnsi::gbIsXTermOutput && gPrevConOutMode)
	{
		const bool autoLfNl = (gPrevConOutMode & DISABLE_NEWLINE_AUTO_RETURN) == 0;
		if (CEAnsi::IsAutoLfNl() != autoLfNl)
		{
			CEAnsi::SetAutoLfNl(autoLfNl);
		}
	}
}
