void rfx_message_free(RFX_CONTEXT* context, RFX_MESSAGE* message)
{
	if (!message)
		return;

	winpr_aligned_free(message->rects);

	if (message->tiles)
	{
		for (size_t i = 0; i < message->numTiles; i++)
		{
			RFX_TILE* tile = message->tiles[i];
			if (!tile)
				continue;

			if (tile->YCbCrData)
			{
				BufferPool_Return(context->priv->BufferPool, tile->YCbCrData);
				tile->YCbCrData = NULL;
			}

			ObjectPool_Return(context->priv->TilePool, (void*)tile);
		}

		rfx_allocate_tiles(message, 0, FALSE);
	}

	const BOOL freeArray = message->freeArray;
	const RFX_MESSAGE empty = { 0 };
	*message = empty;

	if (!freeArray)
		winpr_aligned_free(message);
}
