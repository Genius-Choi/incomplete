HashMap * IMAPSession::fetchNamespace(ErrorCode * pError)
{
    HashMap * result;
    struct mailimap_namespace_data * namespace_data;
    int r;
    
    loginIfNeeded(pError);
    if (* pError != ErrorNone)
        return NULL;
    
    result = HashMap::hashMap();
    r = mailimap_namespace(mImap, &namespace_data);
    if (r == MAILIMAP_ERROR_STREAM) {
        mShouldDisconnect = true;
        * pError = ErrorConnection;
        return NULL;
    }
    else if (r == MAILIMAP_ERROR_PARSE) {
        mShouldDisconnect = true;
        * pError = ErrorParse;
        return NULL;
    }
    else if (hasError(r)) {
        * pError = ErrorNamespace;
        return NULL;
    }
    
    IMAPNamespace * ns;
    
    if (namespace_data->ns_personal != NULL) {
        ns = new IMAPNamespace();
        ns->importIMAPNamespace(namespace_data->ns_personal);
        result->setObjectForKey(IMAPNamespacePersonal, ns);
        ns->release();
    }
    
    if (namespace_data->ns_other != NULL) {
        ns = new IMAPNamespace();
        ns->importIMAPNamespace(namespace_data->ns_other);
        result->setObjectForKey(IMAPNamespaceOther, ns);
        ns->release();
    }
    
    if (namespace_data->ns_shared != NULL) {
        ns = new IMAPNamespace();
        ns->importIMAPNamespace(namespace_data->ns_shared);
        result->setObjectForKey(IMAPNamespaceShared, ns);
        ns->release();
    }
    
    mailimap_namespace_data_free(namespace_data);
    * pError = ErrorNone;
    
    return result;
}
