GF_Err gf_isom_add_sample_aux_info_internal(GF_TrackBox *trak, void *_traf, u32 sampleNumber, u32 aux_type, u32 aux_info, u8 *data, u32 size)
{
	u32 i, count;
	GF_List **child_box_cont, **child_box_sai, **child_box_saiz, **child_box_saio;
	GF_UnknownBox *sai_cont = NULL;

	if (!trak && !_traf) return GF_BAD_PARAM;

	if (trak) {
		child_box_cont = &trak->child_boxes;
		child_box_sai = &trak->Media->information->sampleTable->child_boxes;
		child_box_saiz = &trak->Media->information->sampleTable->sai_sizes;
		child_box_saio = &trak->Media->information->sampleTable->sai_offsets;
	} else {
#ifndef GPAC_DISABLE_ISOM_FRAGMENTS
		GF_TrackFragmentBox *traf = (GF_TrackFragmentBox *)_traf;

		child_box_cont = &traf->child_boxes;
		child_box_sai = &traf->child_boxes;
		child_box_saiz = &traf->sai_sizes;
		child_box_saio = &traf->sai_offsets;
#endif
	}

	count = gf_list_count(*child_box_cont);
	for (i=0; i<count; i++) {
		GF_UnknownBox *unkn = gf_list_get(*child_box_cont, i);
		if (unkn->type != GF_ISOM_BOX_TYPE_UNKNOWN) continue;
		if (unkn->original_4cc != GF_ISOM_BOX_TYPE_GDAT) continue;
		if (unkn->sai_type != aux_type) continue;
		if (unkn->sai_aux_info != aux_info) continue;
		sai_cont = unkn;
		break;
	}
	if (!sai_cont) {
		sai_cont = (GF_UnknownBox *) gf_isom_box_new_parent(child_box_cont, GF_ISOM_BOX_TYPE_UNKNOWN);
		if (!sai_cont) return GF_OUT_OF_MEM;
		sai_cont->original_4cc = GF_ISOM_BOX_TYPE_GDAT;
		sai_cont->sai_type = aux_type;
		sai_cont->sai_aux_info = aux_info;
	}
	sai_cont->data = gf_realloc(sai_cont->data, (size+sai_cont->dataSize));
	if (!sai_cont->data) return GF_OUT_OF_MEM;
	memcpy(sai_cont->data+sai_cont->dataSize, data, size);
	sai_cont->dataSize += size;

	GF_SampleAuxiliaryInfoSizeBox *saiz=NULL;
	GF_SampleAuxiliaryInfoOffsetBox *saio=NULL;
	count = gf_list_count(*child_box_saiz);
	for (i=0; i<count; i++) {
		saiz = gf_list_get(*child_box_saiz, i);
		if ((saiz->aux_info_type==aux_type) && (saiz->aux_info_type_parameter==aux_info)) break;
		saiz = NULL;
	}
	if (!saiz) {
		saiz = (GF_SampleAuxiliaryInfoSizeBox *) gf_isom_box_new_parent(child_box_sai, GF_ISOM_BOX_TYPE_SAIZ);
		if (!saiz) return GF_OUT_OF_MEM;
		if (! *child_box_saiz) *child_box_saiz = gf_list_new();
		gf_list_add(*child_box_saiz, saiz);

		saiz->aux_info_type = aux_type;
		saiz->aux_info_type_parameter = aux_info;
	}

	if (saiz->sample_count >= sampleNumber)
		return GF_BAD_PARAM;

	if ( (!saiz->sample_count && (sampleNumber==1))
		|| ((saiz->default_sample_info_size==size) && size)
	) {
		saiz->sample_count ++;
		saiz->default_sample_info_size = size;
	} else {
		if (sampleNumber > saiz->sample_alloc) {
			saiz->sample_alloc = sampleNumber+10;
			saiz->sample_info_size = (u8*)gf_realloc(saiz->sample_info_size, sizeof(u8)*(saiz->sample_alloc));
		}

		if (saiz->default_sample_info_size) {
			for (i=0; i<saiz->sample_count; i++)
				saiz->sample_info_size[i] = saiz->default_sample_info_size;
			saiz->default_sample_info_size = 0;
		}
		for (i=saiz->sample_count; i<sampleNumber-1; i++)
			saiz->sample_info_size[i] = 0;

		saiz->sample_info_size[sampleNumber-1] = size;
		saiz->sample_count = sampleNumber;
	}


	count = gf_list_count(*child_box_saio);
	for (i=0; i<count; i++) {
		saio = gf_list_get(*child_box_saio, i);
		if ((saio->aux_info_type==aux_type) && (saio->aux_info_type_parameter==aux_info)) break;
		saio = NULL;
	}
	if (!saio) {
		saio = (GF_SampleAuxiliaryInfoOffsetBox *) gf_isom_box_new_parent(child_box_sai, GF_ISOM_BOX_TYPE_SAIO);
		if (!saio) return GF_OUT_OF_MEM;
		if (! *child_box_saio) *child_box_saio = gf_list_new();
		gf_list_add(*child_box_saio, saio);
		saio->aux_info_type = aux_type;
		saio->aux_info_type_parameter = aux_info;
	}
	if (!saio->sai_data) saio->sai_data = sai_cont;
	saio->version = 1;
	saio->entry_count = 1;

	return GF_OK;
}
