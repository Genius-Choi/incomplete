mqtts_tcptran_pipe_fini(void *arg)
{
	mqtts_tcptran_pipe *p = arg;
	mqtts_tcptran_ep *  ep;

	mqtts_tcptran_pipe_stop(p);
	if ((ep = p->ep) != NULL) {
		nni_mtx_lock(&ep->mtx);
		nni_list_node_remove(&p->node);
		ep->refcnt--;
		if (ep->fini && (ep->refcnt == 0)) {
			nni_reap(&tcptran_ep_reap_list, ep);
		}
		nni_mtx_unlock(&ep->mtx);
	}

	nni_aio_free(p->rxaio);
	nni_aio_free(p->txaio);
	nni_aio_free(p->qsaio);
	nni_aio_free(p->negoaio);
	nni_aio_free(p->rpaio);
	nng_stream_free(p->conn);
	nni_msg_free(p->rxmsg);
	nni_lmq_fini(&p->rslmq);
	nni_mtx_fini(&p->mtx);
	nni_aio_fini(&p->tmaio);
#ifdef NNG_HAVE_MQTT_BROKER
	conn_param_free(p->cparam);
#endif
	NNI_FREE_STRUCT(p);
}
