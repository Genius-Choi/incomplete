static int pico_ipv4_forward(struct pico_stack *S, struct pico_frame *f)
{
    struct pico_ipv4_hdr *hdr = (struct pico_ipv4_hdr *)f->net_hdr;
    struct pico_ipv4_route *rt;
    if (!hdr) {
        return -1;
    }

    rt = route_find(S, &hdr->dst);
    if (!rt) {
        pico_notify_dest_unreachable(S, f);
        return -1;
    }

    f->dev = rt->link->dev;

    if (pico_ipv4_pre_forward_checks(S, f) < 0)
        return -1;

    pico_ipv4_nat_outbound(S, f, &rt->link->address);

    f->start = f->net_hdr;

    if (pico_ipv4_forward_check_dev(S, f) < 0)
        return -1;
#ifdef PICO_SUPPORT_IPFILTER
    if (ipfilter(f)) {
        /*pico_frame is discarded as result of the filtering*/
        return -1;
    }
#endif
    return pico_datalink_send(f);
}
