m_get(int nowait, int type)
{
	struct mbuf *m;
	struct counters_ref cr;
	uint64_t *counters;
	int s;

	KASSERT(type >= 0 && type < MT_NTYPES);

	m = pool_get(&mbpool, nowait == M_WAIT ? PR_WAITOK : PR_NOWAIT);
	if (m == NULL)
		return (NULL);

	s = splnet();
	counters = counters_enter(&cr, mbstat);
	counters[type]++;
	counters_leave(&cr, mbstat);
	splx(s);

	m->m_type = type;
	m->m_next = NULL;
	m->m_nextpkt = NULL;
	m->m_data = m->m_dat;
	m->m_flags = 0;

	return (m);
}
