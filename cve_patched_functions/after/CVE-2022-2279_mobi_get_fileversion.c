size_t mobi_get_fileversion(const MOBIData *m) {
    size_t version = 1;
    if (m == NULL || m->ph == NULL) {
        debug_print("%s", "Mobi structure not initialized\n");
        return MOBI_NOTSET;
    }
    if (strcmp(m->ph->type, "BOOK") == 0 && strcmp(m->ph->creator, "MOBI") == 0) {
        if (m->mh && m->mh->header_length) {
            uint32_t header_length = *m->mh->header_length;
            if (header_length < MOBI_HEADER_V2_SIZE) {
                version = 2;
            } else if (m->mh->version && *m->mh->version > 1) {
                if ((*m->mh->version > 2 && header_length < MOBI_HEADER_V3_SIZE)
                    || (*m->mh->version > 3 && header_length < MOBI_HEADER_V4_SIZE)
                    ||(*m->mh->version > 5 && header_length < MOBI_HEADER_V5_SIZE)) {
                    return MOBI_NOTSET;
                }
                version = *m->mh->version;
            }
        }
    }
    return version;
}
