Jsi_RC Jsi_PkgProvideEx(Jsi_Interp *interp, const char *name, Jsi_Number version, 
    Jsi_InitProc *initProc, Jsi_PkgOpts* popts)
{
    jsi_PkgInfo *ptr;
    Jsi_HashEntry *hPtr = Jsi_HashEntryFind(interp->packageHash, name);
    Jsi_Value *opts = (popts?popts->info:NULL);
    if (version<0) {
        if (hPtr) {
            ptr = (jsi_PkgInfo*)Jsi_HashValueGet(hPtr);
            Jsi_HashEntryDelete(hPtr);
        }
        return JSI_OK;
    }
    version = jsi_VersionNormalize(version, NULL, 0);
    if (version == 0) 
        return Jsi_LogError("Version must be > 0");
    else {
        if (hPtr) {
            ptr = (jsi_PkgInfo*)Jsi_HashValueGet(hPtr);
            if (ptr && ptr->needInit==0) 
                return Jsi_LogError("package %s already provided from: %s", name, ptr->loadFile?ptr->loadFile:"");
            return JSI_OK;
        }
        if (!Jsi_StrIsAlnum(name)) 
            return Jsi_LogError("invalid package name");
        if (opts && !Jsi_ValueIsObjType(interp, opts, JSI_OT_OBJECT) && !Jsi_ValueIsObjType(interp, opts, JSI_OT_FUNCTION))
            return Jsi_LogError("opts must be function or object");
        ptr = (jsi_PkgInfo*)Jsi_Calloc(1, sizeof(*ptr));
        ptr->version = version;
        ptr->initProc = initProc;
        if (popts) {
            ptr->popts = *popts;
            if (popts->info)
                Jsi_IncrRefCount(interp, popts->info);
        }
        if (interp->framePtr->fileName && !initProc)
            ptr->loadFile = Jsi_KeyAdd(interp->topInterp, interp->framePtr->fileName);
        Jsi_HashSet(interp->packageHash, (void*)name, ptr);
        if (initProc && interp->parent) { // Provide C extensions to topInterp.
            ptr = jsi_PkgGet(interp->topInterp, name);
            if (ptr == NULL) {
                Jsi_PkgOpts po = {};
                Jsi_Value *nopts = NULL;
                if (opts) {
                    nopts = Jsi_ValueNew(interp);
                    Jsi_CleanValue(interp, interp->topInterp, po.info, &nopts);
                    po.info = nopts;
                }
                Jsi_RC rc = Jsi_PkgProvideEx(interp->topInterp, name, version, initProc, &po);
                if (rc != JSI_OK)
                    return JSI_ERROR;
                ptr = jsi_PkgGet(interp->topInterp, name);
                if (!ptr)
                    return JSI_ERROR;
                ptr->needInit = 1;
            }
        }

    }
    return JSI_OK;
}
