create_custom_attr_data (MonoImage *image, MonoMethod *method, const guchar *data, guint32 len)
{
	MonoArray *typedargs, *namedargs;
	static MonoMethod *ctor;
	MonoDomain *domain;
	MonoObject *attr;
	void *params [3];
	CattrNamedArg *arginfo;
	int i;

	mono_class_init (method->klass);

	if (!ctor)
		ctor = mono_class_get_method_from_name (mono_defaults.customattribute_data_class, ".ctor", 3);

	domain = mono_domain_get ();
	if (len == 0) {
		/* This is for Attributes with no parameters */
		attr = mono_object_new (domain, mono_defaults.customattribute_data_class);
		params [0] = mono_method_get_object (domain, method, NULL);
		params [1] = params [2] = NULL;
		mono_runtime_invoke (method, attr, params, NULL);
		return attr;
	}

	mono_reflection_create_custom_attr_data_args (image, method, data, len, &typedargs, &namedargs, &arginfo);
	if (!typedargs || !namedargs)
		return NULL;

	for (i = 0; i < mono_method_signature (method)->param_count; ++i) {
		MonoObject *obj = mono_array_get (typedargs, MonoObject*, i);
		MonoObject *typedarg;

		typedarg = create_cattr_typed_arg (mono_method_signature (method)->params [i], obj);
		mono_array_setref (typedargs, i, typedarg);
	}

	for (i = 0; i < mono_array_length (namedargs); ++i) {
		MonoObject *obj = mono_array_get (namedargs, MonoObject*, i);
		MonoObject *typedarg, *namedarg, *minfo;

		if (arginfo [i].prop)
			minfo = (MonoObject*)mono_property_get_object (domain, NULL, arginfo [i].prop);
		else
			minfo = (MonoObject*)mono_field_get_object (domain, NULL, arginfo [i].field);

		typedarg = create_cattr_typed_arg (arginfo [i].type, obj);
		namedarg = create_cattr_named_arg (minfo, typedarg);

		mono_array_setref (namedargs, i, namedarg);
	}

	attr = mono_object_new (domain, mono_defaults.customattribute_data_class);
	params [0] = mono_method_get_object (domain, method, NULL);
	params [1] = typedargs;
	params [2] = namedargs;
	mono_runtime_invoke (ctor, attr, params, NULL);
	return attr;
}
