redirect_to_https_port(struct mg_connection *conn, int ssl_index)
{
	char target_url[MG_BUF_LEN];
	int truncated = 0;

	conn->must_close = 1;

	/* Send host, port, uri and (if it exists) ?query_string */
	if (conn->host) {

		/* Use "308 Permanent Redirect" */
		int redirect_code = 308;

		/* Create target URL */
		mg_snprintf(
		    conn,
		    &truncated,
		    target_url,
		    sizeof(target_url),
		    "Location: https://%s:%d%s%s%s",

		    conn->host,
#if defined(USE_IPV6)
		    (conn->phys_ctx->listening_sockets[ssl_index].lsa.sa.sa_family
		     == AF_INET6)
		        ? (int)ntohs(conn->phys_ctx->listening_sockets[ssl_index]
		                         .lsa.sin6.sin6_port)
		        :
#endif
		        (int)ntohs(conn->phys_ctx->listening_sockets[ssl_index]
		                       .lsa.sin.sin_port),
		    conn->request_info.local_uri,
		    (conn->request_info.query_string == NULL) ? "" : "?",
		    (conn->request_info.query_string == NULL)
		        ? ""
		        : conn->request_info.query_string);

		/* Check overflow in location buffer (will not occur if MG_BUF_LEN
		 * is used as buffer size) */
		if (truncated) {
			mg_send_http_error(conn, 500, "%s", "Redirect URL too long");
			return;
		}

		/* Use redirect helper function */
		mg_send_http_redirect(conn, target_url, redirect_code);
	}
}
