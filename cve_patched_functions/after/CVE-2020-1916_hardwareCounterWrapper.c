void* hardwareCounterWrapper(void* varg) {
  auto arg = (HardwareCounterWrapperArg*)varg;

  HardwareCounter::s_counter.getCheck();
  HardwareCounter::Reset();
  arg->pid = arg->func(arg->afdt_fd);
  // tell the main thread that pid has been set.
  arg->barrier.wait();
  if (arg->pid < 0) return nullptr;

  // Wait until the main thread is ready to join us.
  // Note that even though we have multiple threads running in the LightProcess
  // now, at the time any of the do_* functions are called, any live threads are
  // waiting here on this barrier; so there is no problem with fork, malloc,
  // exec.
  arg->barrier.wait();
  HardwareCounter::GetPerfEvents(
    [](const std::string& event, int64_t value, void* data) {
      auto events = reinterpret_cast<int64_t*>(data);
      if (event == "instructions") {
        events[0] = value;
      } else if (event == "loads") {
        events[1] = value;
      } else if (event == "stores") {
        events[2] = value;
      }
    },
    arg->events);

  return nullptr;
}
