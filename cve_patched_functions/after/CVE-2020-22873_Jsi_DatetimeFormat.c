Jsi_RC Jsi_DatetimeFormat(Jsi_Interp *interp, Jsi_Number num, const char *fmt, int isUtc, Jsi_DString *dStr)
{
    char buf[JSI_BUFSIZ], fmt1[JSI_BUFSIZ], fmt2[JSI_BUFSIZ];
    time_t tt;
    Jsi_RC rc = JSI_OK;
    fmt2[0] = 0;
    
    tt = (time_t)(num/1000);
    if (fmt==NULL)
        fmt = timeFmts[0];
    else if (*fmt == 0) {
        if (!isUtc)
            fmt = timeFmts[1];
        else
            fmt = timeFmts[2];
    }
    
    const char *efp = Jsi_Strstr(fmt, "%f");
    if (efp && efp > fmt && efp[-1] != '%' && ((efp-fmt)+10)<(int)sizeof(fmt1)) {
        int elen = (efp-fmt)+1;
        Jsi_Strncpy(fmt1, fmt, elen);
        Jsi_Strcpy(fmt1+elen, "%S.");
        Jsi_Strcpy(fmt2, efp+2);
        fmt = fmt1;
    } else
        efp = NULL;
    struct tm tm = {}, *tmp=&tm;
    tm.tm_isdst = -1;
#ifdef __WIN32
    if (isUtc)
        tmp = gmtime(&tt);
    else
        tmp = localtime(&tt);
#else
    if (isUtc)
        gmtime_r(&tt, &tm);
    else
        localtime_r(&tt, &tm);
#endif
    buf[0] = 0;
    int rr = strftime(buf, sizeof(buf), fmt, tmp);
       
    if (rr<=0)
        rc = Jsi_LogError("time format error: %d", (int)tt);
    else {
        Jsi_DSAppendLen(dStr, buf, -1);
        if (efp) {
            snprintf(buf, sizeof(buf), "%3.3d", (int)(((Jsi_Wide)num)%1000));
            Jsi_DSAppendLen(dStr, buf[1]=='.'?buf+2:buf, -1);
        }
    }
    if (rc == JSI_OK && fmt2[0]) {
        buf[0] = 0;
        int rr = strftime(buf, sizeof(buf), fmt2, tmp);
           
        if (rr<=0)
            rc = Jsi_LogError("time format error");
        else
            Jsi_DSAppendLen(dStr, buf, -1);
    }
    return rc;
}
