char * r_jws_serialize_unsecure(jws_t * jws, jwk_t * jwk_privkey, int x5u_flags) {
  jwk_t * jwk = NULL;
  char * jws_str = NULL;
  jwa_alg alg;

  if (jws != NULL) {
    if (jwk_privkey != NULL) {
      jwk = r_jwk_copy(jwk_privkey);
      if (jws->alg == R_JWA_ALG_UNKNOWN && (alg = r_str_to_jwa_alg(r_jwk_get_property_str(jwk, "alg"))) != R_JWA_ALG_NONE && alg != R_JWA_ALG_UNKNOWN) {
        r_jws_set_alg(jws, alg);
      }
    } else {
      if (r_jws_get_header_str_value(jws, "kid") != NULL) {
        jwk = r_jwks_get_by_kid(jws->jwks_privkey, r_jws_get_header_str_value(jws, "kid"));
      } else if (jws != NULL && r_jwks_size(jws->jwks_privkey) == 1) {
        jwk = r_jwks_get_at(jws->jwks_privkey, 0);
      }
      if (jws->alg == R_JWA_ALG_UNKNOWN && (alg = r_str_to_jwa_alg(r_jwk_get_property_str(jwk, "alg"))) != R_JWA_ALG_NONE && alg != R_JWA_ALG_UNKNOWN) {
        r_jws_set_alg(jws, alg);
      }
    }

    if (r_jwk_get_property_str(jwk, "kid") != NULL && r_jws_get_header_str_value(jws, "kid") == NULL) {
      r_jws_set_header_str_value(jws, "kid", r_jwk_get_property_str(jwk, "kid"));
    }

    o_free(jws->signature_b64url);
    if (r_jws_set_token_values(jws, 1) == RHN_OK) {
      jws->signature_b64url = _r_generate_signature(jws, jwk, jws->alg, x5u_flags);
      if (jws->signature_b64url != NULL) {
        jws_str = msprintf("%s.%s.%s", jws->header_b64url, jws->payload_b64url, jws->signature_b64url);
      } else {
        y_log_message(Y_LOG_LEVEL_ERROR, "r_jws_serialize - No signature");
      }
    } else {
      y_log_message(Y_LOG_LEVEL_ERROR, "r_jws_serialize - Error r_jws_set_token_values");
    }
  } else {
    y_log_message(Y_LOG_LEVEL_ERROR, "r_jws_serialize - Error input parameters");
  }

  r_jwk_free(jwk);
  return jws_str;
}
