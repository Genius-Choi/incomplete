void rfx_context_free(RFX_CONTEXT* context)
{
	RFX_CONTEXT_PRIV* priv;

	if (!context)
		return;

	WINPR_ASSERT(NULL != context);

	priv = context->priv;
	WINPR_ASSERT(NULL != priv);
	WINPR_ASSERT(NULL != priv->TilePool);
	WINPR_ASSERT(NULL != priv->BufferPool);

	/* coverity[address_free] */
	rfx_message_free(context, &context->currentMessage);
	winpr_aligned_free(context->quants);
	rfx_profiler_print(context);
	rfx_profiler_free(context);

	if (priv)
	{
		ObjectPool_Free(priv->TilePool);
		if (priv->UseThreads)
		{
			if (priv->ThreadPool)
				CloseThreadpool(priv->ThreadPool);
			DestroyThreadpoolEnvironment(&priv->ThreadPoolEnv);
			winpr_aligned_free(priv->workObjects);
			winpr_aligned_free(priv->tileWorkParams);
#ifdef WITH_PROFILER
			WLog_VRB(
			    TAG,
			    "WARNING: Profiling results probably unusable with multithreaded RemoteFX codec!");
#endif
		}

		BufferPool_Free(priv->BufferPool);
		winpr_aligned_free(priv);
	}
	winpr_aligned_free(context);
}
