netgr_matches(const struct sudo_nss *nss, const char *netgr,
    const char *lhost, const char *shost, const char *user)
{
    const char *domain;
    bool rc = false;
    debug_decl(netgr_matches, SUDOERS_DEBUG_MATCH);

    if (!def_use_netgroups) {
	sudo_debug_printf(SUDO_DEBUG_INFO, "netgroups are disabled");
	debug_return_bool(false);
    }

    /* make sure we have a valid netgroup, sudo style */
    if (*netgr++ != '+') {
	sudo_debug_printf(SUDO_DEBUG_DIAG, "netgroup %s has no leading '+'",
	    netgr);
	debug_return_bool(false);
    }

    /* get the domain name (if any) */
    domain = sudo_getdomainname();

    /* Use nss-specific innetgr() function if available. */
    if (nss != NULL && nss->innetgr != NULL) {
	switch (nss->innetgr(nss, netgr, lhost, user, domain)) {
	case 0:
	    if (lhost != shost) {
		if (nss->innetgr(nss, netgr, shost, user, domain) == 1)
		    rc = true;
	    }
	    goto done;
	case 1:
	    rc = true;
	    goto done;
	default:
	    /* Not supported, use system innetgr(3). */
	    break;
	}
    }

#ifdef HAVE_INNETGR
    /* Use system innetgr() function. */
    if (innetgr(netgr, lhost, user, domain) == 1) {
	rc = true;
    } else if (lhost != shost) {
	if (innetgr(netgr, shost, user, domain) == 1)
	    rc = true;
    }
#else
    sudo_debug_printf(SUDO_DEBUG_WARN|SUDO_DEBUG_LINENO,
	"%s: no system netgroup support", __func__);
#endif /* HAVE_INNETGR */

done:
    sudo_debug_printf(SUDO_DEBUG_DEBUG|SUDO_DEBUG_LINENO,
	"netgroup %s matches (%s|%s, %s, %s): %s", netgr, lhost ? lhost : "",
	shost ? shost : "", user ? user : "", domain ? domain : "",
	rc ? "true" : "false");

    debug_return_bool(rc);
}
