int IMA::encodeBlockQT(const int16_t *input, uint8_t *output)
{
	int channelCount = m_track->f.channelCount;

	for (int c=0; c<channelCount; c++)
	{
		adpcmState state = m_adpcmState[c];

		state.previousValue &= ~0x7f;

		output[0] = (state.previousValue >> 8) & 0xff;
		output[1] = (state.previousValue & 0x80) | (state.index & 0x7f);
		output += 2;

		for (int n=0; n<m_framesPerPacket; n+=2)
		{
			uint8_t encoded = encodeSample(state, input[n*channelCount + c]);
			encoded |= encodeSample(state, input[(n+1)*channelCount + c]) << 4;
			*output++ = encoded;
		}

		m_adpcmState[c] = state;
	}

	return m_bytesPerPacket;
}
