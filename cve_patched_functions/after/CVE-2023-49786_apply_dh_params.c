static int apply_dh_params(SSL_CTX *ctx, BIO *bio)
{
	int res = 0;

#if OPENSSL_VERSION_NUMBER >= 0x30000000L
	EVP_PKEY *dhpkey = PEM_read_bio_Parameters(bio, NULL);
	if (dhpkey && EVP_PKEY_is_a(dhpkey, "DH")) {
		res = SSL_CTX_set0_tmp_dh_pkey(ctx, dhpkey);
	}
	if (!res) {
		/* A successful call to SSL_CTX_set0_tmp_dh_pkey() means
		   that we lost ownership of dhpkey and should not free
		   it ourselves */
		EVP_PKEY_free(dhpkey);
	}
#else
	DH *dh = PEM_read_bio_DHparams(bio, NULL, NULL, NULL);
	if (dh) {
		res = SSL_CTX_set_tmp_dh(ctx, dh);
	}
	DH_free(dh);
#endif

	return res;
}
