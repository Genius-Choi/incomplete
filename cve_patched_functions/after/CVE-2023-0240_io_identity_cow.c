static bool io_identity_cow(struct io_kiocb *req)
{
	const struct cred *creds = NULL;
	struct io_identity *id;

	if (req->work.flags & IO_WQ_WORK_CREDS)
		creds = req->work.identity->creds;

	id = kmemdup(req->work.identity, sizeof(*id), GFP_KERNEL);
	if (unlikely(!id)) {
		req->work.flags |= IO_WQ_WORK_CANCEL;
		return false;
	}

	/*
	 * We can safely just re-init the creds we copied  Either the field
	 * matches the current one, or we haven't grabbed it yet. The only
	 * exception is ->creds, through registered personalities, so handle
	 * that one separately.
	 */
	io_init_identity(id);
	if (creds)
		req->work.identity->creds = creds;

	/* add one for this request */
	refcount_inc(&id->count);

	/* drop old identity, assign new one. one ref for req, one for tctx */
	if (req->work.identity != &req->identity &&
	    refcount_sub_and_test(2, &req->work.identity->count))
		kfree(req->work.identity);

	req->work.identity = id;
	return true;
}
