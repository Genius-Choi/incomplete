pf_inp_lookup(struct mbuf *m)
{
	struct inpcb *inp = NULL;
	struct pf_state_key *sk = m->m_pkthdr.pf.statekey;

	if (!pf_state_key_isvalid(sk))
		pf_mbuf_unlink_state_key(m);
	else
		inp = m->m_pkthdr.pf.statekey->sk_inp;

	if (inp && inp->inp_pf_sk)
		KASSERT(m->m_pkthdr.pf.statekey == inp->inp_pf_sk);

	in_pcbref(inp);
	return (inp);
}
