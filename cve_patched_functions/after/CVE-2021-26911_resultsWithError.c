static Array * resultsWithError(int r, clist * list, ErrorCode * pError)
{
    clistiter * cur;
    Array * result;
    
    result = Array::array();
    if (r == MAILIMAP_ERROR_STREAM) {
        * pError = ErrorConnection;
        return NULL;
    }
    else if (r == MAILIMAP_ERROR_PARSE) {
        * pError = ErrorParse;
        return NULL;
    }
    else if (hasError(r)) {
        * pError = ErrorNonExistantFolder;
        return NULL;
    }
    
    for(cur = clist_begin(list) ; cur != NULL ; cur = cur->next) {
        struct mailimap_mailbox_list * mb_list;
        IMAPFolderFlag flags;
        IMAPFolder * folder;
        String * path;
        
        mb_list = (struct mailimap_mailbox_list *) cur->data;
        
        flags = IMAPFolderFlagNone;
        if (mb_list->mb_flag != NULL)
            flags = (IMAPFolderFlag) imap_mailbox_flags_to_flags(mb_list->mb_flag);
        
        folder = new IMAPFolder();
        path = String::stringWithUTF8Characters(mb_list->mb_name);
        if (path->uppercaseString()->isEqual(MCSTR("INBOX"))) {
            folder->setPath(MCSTR("INBOX"));
        }
        else {
            folder->setPath(path);
        }
        folder->setDelimiter(mb_list->mb_delimiter);
        folder->setFlags(flags);
        
        result->addObject(folder);
        
        folder->release();
    }
    
    mailimap_list_result_free(list);
    
    * pError = ErrorNone;
    return result;
}
