ssl_servername_callback(SSL *ssl, int *ad, void *arg)
{
	struct mg_context *ctx = (struct mg_context *)arg;
	struct mg_domain_context *dom =
	    (struct mg_domain_context *)ctx ? &(ctx->dd) : NULL;

#if defined(__GNUC__) || defined(__MINGW32__)
#pragma GCC diagnostic push
#pragma GCC diagnostic ignored "-Wcast-align"
#endif /* defined(__GNUC__) || defined(__MINGW32__) */

	/* We used an aligned pointer in SSL_set_app_data */
	struct mg_connection *conn = (struct mg_connection *)SSL_get_app_data(ssl);

#if defined(__GNUC__) || defined(__MINGW32__)
#pragma GCC diagnostic pop
#endif /* defined(__GNUC__) || defined(__MINGW32__) */

	const char *servername = SSL_get_servername(ssl, TLSEXT_NAMETYPE_host_name);

	(void)ad;

	if ((ctx == NULL) || (conn->phys_ctx == ctx)) {
		DEBUG_TRACE("%s", "internal error - assertion failed");
		return SSL_TLSEXT_ERR_NOACK;
	}

	/* Old clients (Win XP) will not support SNI. Then, there
	 * is no server name available in the request - we can
	 * only work with the default certificate.
	 * Multiple HTTPS hosts on one IP+port are only possible
	 * with a certificate containing all alternative names.
	 */
	if ((servername == NULL) || (*servername == 0)) {
		DEBUG_TRACE("%s", "SSL connection not supporting SNI");
		conn->dom_ctx = &(ctx->dd);
		SSL_set_SSL_CTX(ssl, conn->dom_ctx->ssl_ctx);
		return SSL_TLSEXT_ERR_NOACK;
	}

	DEBUG_TRACE("TLS connection to host %s", servername);

	while (dom) {
		if (!mg_strcasecmp(servername, dom->config[AUTHENTICATION_DOMAIN])) {

			/* Found matching domain */
			DEBUG_TRACE("TLS domain %s found",
			            dom->config[AUTHENTICATION_DOMAIN]);
			SSL_set_SSL_CTX(ssl, dom->ssl_ctx);
			conn->dom_ctx = dom;
			return SSL_TLSEXT_ERR_OK;
		}
		dom = dom->next;
	}

	/* Default domain */
	DEBUG_TRACE("TLS default domain %s used",
	            ctx->dd.config[AUTHENTICATION_DOMAIN]);
	conn->dom_ctx = &(ctx->dd);
	SSL_set_SSL_CTX(ssl, conn->dom_ctx->ssl_ctx);
	return SSL_TLSEXT_ERR_OK;
}
