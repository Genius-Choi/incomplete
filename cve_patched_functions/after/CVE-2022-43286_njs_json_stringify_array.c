njs_json_stringify_array(njs_vm_t *vm, njs_json_stringify_t *stringify)
{
    njs_int_t    ret;
    int64_t      i, k, length;
    njs_value_t  *value, *item;
    njs_array_t  *properties;

    ret = njs_object_length(vm, &stringify->replacer, &length);
    if (njs_slow_path(ret != NJS_OK)) {
        return ret;
    }

    properties = njs_array_alloc(vm, 1, 0, NJS_ARRAY_SPARE);
    if (njs_slow_path(properties == NULL)) {
        return NJS_ERROR;
    }

    item = njs_array_push(vm, properties);
    njs_value_assign(item, &njs_string_empty);

    for (i = 0; i < length; i++) {
        ret = njs_value_property_i64(vm, &stringify->replacer, i,
                                     &stringify->retval);
        if (njs_slow_path(ret == NJS_ERROR)) {
            return ret;
        }

        value = &stringify->retval;

        switch (value->type) {
        case NJS_STRING:
            break;

        case NJS_NUMBER:
            ret = njs_number_to_string(vm, value, value);
            if (njs_slow_path(ret != NJS_OK)) {
                return NJS_ERROR;
            }

            break;

        case NJS_OBJECT_VALUE:
            switch (njs_object_value(value)->type) {
            case NJS_NUMBER:
            case NJS_STRING:
                ret = njs_value_to_string(vm, value, value);
                if (njs_slow_path(ret != NJS_OK)) {
                    return NJS_ERROR;
                }

                break;

            default:
                continue;
            }

            break;

        default:
            continue;
        }

        for (k = 0; k < properties->length; k++) {
            if (njs_values_strict_equal(value, &properties->start[k]) == 1) {
                break;
            }
        }

        if (k == properties->length) {
            item = njs_array_push(vm, properties);
            if (njs_slow_path(item == NULL)) {
                return NJS_ERROR;
            }

            njs_value_assign(item, value);
        }
    }

    njs_set_array(&stringify->replacer, properties);

    return NJS_OK;
}
