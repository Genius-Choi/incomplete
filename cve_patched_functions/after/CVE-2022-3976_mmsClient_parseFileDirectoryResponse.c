mmsClient_parseFileDirectoryResponse(ByteBuffer* response, int bufPos, uint32_t invokeId, MmsConnection_FileDirectoryHandler handler, void* parameter)
{
    uint8_t* buffer = response->buffer;
    int maxBufPos = response->size;
    int length;

    uint8_t tag = buffer[bufPos++];

    if (tag != 0xbf) {
        if (DEBUG_MMS_CLIENT)
            printf("mmsClient_parseFileDirectoryResponse: unknown tag %02x\n", tag);
        return false;
    }

    tag = buffer[bufPos++];

    if (tag != 0x4d) {
        if (DEBUG_MMS_CLIENT)
            printf("mmsClient_parseFileDirectoryResponse: unknown tag %02x\n", tag);
        return false;
    }

    bufPos = BerDecoder_decodeLength(buffer, &length, bufPos, maxBufPos);
    if (bufPos < 0) return false;

    int endPos = bufPos + length;

    bool moreFollows = false;

    while (bufPos < endPos) {
        tag = buffer[bufPos++];

        bufPos = BerDecoder_decodeLength(buffer, &length, bufPos, maxBufPos);
        if (bufPos < 0) return false;

        switch (tag) {
        case 0xa0: /* listOfDirectoryEntries */
            parseListOfDirectoryEntries(buffer, bufPos, bufPos + length, invokeId, handler, parameter);

            bufPos += length;
            break;
        case 0x81: /* moreFollows */
            moreFollows = BerDecoder_decodeBoolean(buffer, bufPos);
            bufPos += length;
            break;
        case 0x00: /* indefinite length end tag -> ignore */
            break;
        default:
            bufPos += length;
            if (DEBUG_MMS_CLIENT)
                printf("mmsClient_parseFileDirectoryResponse: message contains unknown tag!\n");
            break;
        }
    }

    handler(invokeId, parameter, MMS_ERROR_NONE, NULL, 0, 0, moreFollows);

    return true;
}
