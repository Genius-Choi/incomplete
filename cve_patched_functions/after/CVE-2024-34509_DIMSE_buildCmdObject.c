DIMSE_buildCmdObject(T_DIMSE_Message *msg, DcmDataset **obj)
    /*
     * This function creates a DcmDataSet object ("command object") based on the information in the DIMSE
     * message variable (remember that all DICOM command messages are - in the end - particular data sets). This
     * newly created object will contain all the information that is needed for a particular DIMSE command
     * that will be sent over the network, i.e. also command group length, command field, data set type etc.
     * Note that a group length element will already be added to the created object but that the value in
     * this element will not yet be set. (It has to be set before the command is sent over the network though.)
     *
     * Parameters:
     *   msg - [in] Structure that represents a certain DIMSE command which shall be sent.
     *   obj - [out] The DcmDataSet object which was created from msg.
     */
{
    OFCondition cond = EC_Normal;

    /* if there is no such result object yet, create one */
    if (*obj == NULL) {
        *obj = new DcmDataset();
    }

    /* depending on the type of DIMSE command, create a corresponding DcmDataSet object */
    switch (msg->CommandField) {
    case DIMSE_C_ECHO_RQ:
        cond = buildCEchoRQ(&msg->msg.CEchoRQ, *obj);
        break;
    case DIMSE_C_ECHO_RSP:
        cond = buildCEchoRSP(&msg->msg.CEchoRSP, *obj);
        break;
    case DIMSE_C_STORE_RQ:
        cond = buildCStoreRQ(&msg->msg.CStoreRQ, *obj);
        break;
    case DIMSE_C_STORE_RSP:
        cond = buildCStoreRSP(&msg->msg.CStoreRSP, *obj);
        break;
    case DIMSE_C_GET_RQ:
        cond = buildCGetRQ(&msg->msg.CGetRQ, *obj);
        break;
    case DIMSE_C_GET_RSP:
        cond = buildCGetRSP(&msg->msg.CGetRSP, *obj);
        break;
    case DIMSE_C_FIND_RQ:
        cond = buildCFindRQ(&msg->msg.CFindRQ, *obj);
        break;
    case DIMSE_C_FIND_RSP:
        cond = buildCFindRSP(&msg->msg.CFindRSP, *obj);
        break;
    case DIMSE_C_MOVE_RQ:
        cond = buildCMoveRQ(&msg->msg.CMoveRQ, *obj);
        break;
    case DIMSE_C_MOVE_RSP:
        cond = buildCMoveRSP(&msg->msg.CMoveRSP, *obj);
        break;
    case DIMSE_C_CANCEL_RQ:
        cond = buildCCancelRQ(&msg->msg.CCancelRQ, *obj);
        break;
    case DIMSE_N_EVENT_REPORT_RQ:
        cond = buildNEventReportRQ(&msg->msg.NEventReportRQ, *obj);
        break;
    case DIMSE_N_EVENT_REPORT_RSP:
        cond = buildNEventReportRSP(&msg->msg.NEventReportRSP, *obj);
        break;
    case DIMSE_N_GET_RQ:
        cond = buildNGetRQ(&msg->msg.NGetRQ, *obj);
        break;
    case DIMSE_N_GET_RSP:
        cond = buildNGetRSP(&msg->msg.NGetRSP, *obj);
        break;
    case DIMSE_N_SET_RQ:
        cond = buildNSetRQ(&msg->msg.NSetRQ, *obj);
        break;
    case DIMSE_N_SET_RSP:
        cond = buildNSetRSP(&msg->msg.NSetRSP, *obj);
        break;
    case DIMSE_N_ACTION_RQ:
        cond = buildNActionRQ(&msg->msg.NActionRQ, *obj);
        break;
    case DIMSE_N_ACTION_RSP:
        cond = buildNActionRSP(&msg->msg.NActionRSP, *obj);
        break;
    case DIMSE_N_CREATE_RQ:
        cond = buildNCreateRQ(&msg->msg.NCreateRQ, *obj);
        break;
    case DIMSE_N_CREATE_RSP:
        cond = buildNCreateRSP(&msg->msg.NCreateRSP, *obj);
        break;
    case DIMSE_N_DELETE_RQ:
        cond = buildNDeleteRQ(&msg->msg.NDeleteRQ, *obj);
        break;
    case DIMSE_N_DELETE_RSP:
        cond = buildNDeleteRSP(&msg->msg.NDeleteRSP, *obj);
        break;
    default:
        {
          char buf[256];
          sprintf(buf, "DIMSE_buildCmdObject: Invalid Command Message: 0x%x", msg->CommandField);
          cond = makeDcmnetCondition(DIMSEC_BADCOMMANDTYPE, OF_error, buf);
        }
        break;
    }

    /* if the creation was not successful delete the DcmDataSet object */
    if (cond.bad())
    {
        delete *obj;
        *obj = NULL;
    }

    /* return result value */
    return cond;
}
