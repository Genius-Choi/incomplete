njs_json_internalize_property(njs_vm_t *vm, njs_function_t *reviver,
    njs_value_t *holder, njs_value_t *name, njs_int_t depth,
    njs_value_t *retval)
{
    int64_t       k, length;
    njs_int_t     ret;
    njs_value_t   val, new_elem, index;
    njs_value_t   arguments[3];
    njs_array_t   *keys;

    if (njs_slow_path(depth++ >= NJS_JSON_MAX_DEPTH)) {
        njs_type_error(vm, "Nested too deep or a cyclic structure");
        return NJS_ERROR;
    }

    ret = njs_value_property(vm, holder, name, &val);
    if (njs_slow_path(ret == NJS_ERROR)) {
        return NJS_ERROR;
    }

    keys = NULL;

    if (njs_is_object(&val)) {
        if (!njs_is_array(&val)) {
            keys = njs_array_keys(vm, &val, 0);
            if (njs_slow_path(keys == NULL)) {
                return NJS_ERROR;
            }

            for (k = 0; k < keys->length; k++) {
                ret = njs_json_internalize_property(vm, reviver, &val,
                                                    &keys->start[k], depth,
                                                    &new_elem);

                if (njs_slow_path(ret != NJS_OK)) {
                    goto done;
                }

                if (njs_is_undefined(&new_elem)) {
                    ret = njs_value_property_delete(vm, &val, &keys->start[k],
                                                    NULL, 0);

                } else {
                    ret = njs_value_property_set(vm, &val, &keys->start[k],
                                                 &new_elem);
                }

                if (njs_slow_path(ret == NJS_ERROR)) {
                    goto done;
                }
            }

        } else {

            ret = njs_object_length(vm, &val, &length);
            if (njs_slow_path(ret == NJS_ERROR)) {
                return NJS_ERROR;
            }

            for (k = 0; k < length; k++) {
                ret = njs_int64_to_string(vm, &index, k);
                if (njs_slow_path(ret != NJS_OK)) {
                    return NJS_ERROR;
                }

                ret = njs_json_internalize_property(vm, reviver, &val, &index,
                                                    depth, &new_elem);

                if (njs_slow_path(ret != NJS_OK)) {
                    return NJS_ERROR;
                }

                if (njs_is_undefined(&new_elem)) {
                    ret = njs_value_property_delete(vm, &val, &index, NULL, 0);

                } else {
                    ret = njs_value_property_set(vm, &val, &index, &new_elem);
                }

                if (njs_slow_path(ret == NJS_ERROR)) {
                    return NJS_ERROR;
                }
            }
        }
    }

    njs_value_assign(&arguments[0], holder);
    njs_value_assign(&arguments[1], name);
    njs_value_assign(&arguments[2], &val);

    ret = njs_function_apply(vm, reviver, arguments, 3, retval);

done:

    if (keys != NULL) {
        njs_array_destroy(vm, keys);
    }

    return ret;
}
