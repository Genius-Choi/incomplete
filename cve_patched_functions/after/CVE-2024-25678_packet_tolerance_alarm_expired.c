packet_tolerance_alarm_expired (enum alarm_id al_id, void *ctx,
                                    lsquic_time_t expiry, lsquic_time_t now)
{
    struct ietf_full_conn *const conn = ctx;
    const float             Kp = conn->ifc_settings->es_ptpc_prop_gain,
                            Ki = conn->ifc_settings->es_ptpc_int_gain,
                    err_thresh = conn->ifc_settings->es_ptpc_err_thresh,
                   err_divisor = conn->ifc_settings->es_ptpc_err_divisor;
    const unsigned periodicity = conn->ifc_settings->es_ptpc_periodicity;
    const unsigned max_packtol = conn->ifc_settings->es_ptpc_max_packtol;
    float avg_acks_per_rtt, error, combined_error, normalized,
            combined_error_abs, target, rtts;
    double dt;
    lsquic_time_t srtt, begin_t;

    srtt = lsquic_rtt_stats_get_srtt(&conn->ifc_pub.rtt_stats);

    if (srtt == 0)
        goto end;
    if (0 == conn->ifc_pts.n_acks)
        /* Don't reset last_sample and calculate average for both this and next
         * period the next time around.
         */
        goto end;

    if (conn->ifc_settings->es_ptpc_dyn_target)
        target = calc_target(srtt);
    else
        target = conn->ifc_settings->es_ptpc_target;

    dt = periodicity * (double) srtt / 1000000;

    begin_t = conn->ifc_pts.last_sample ? conn->ifc_pts.last_sample
                                                    : conn->ifc_created;
    /*
    LSQ_DEBUG("begin: %"PRIu64"; now: %"PRIu64"; SRTT: %"PRIu64"; acks: %u",
        begin_t, now, srtt, conn->ifc_pts.n_acks);
    */
    rtts = (float) (now - begin_t) / (float) srtt;
    avg_acks_per_rtt = (float) conn->ifc_pts.n_acks / (float) rtts;
    normalized = avg_acks_per_rtt * M_E / target;
    error = logf(normalized) - 1;
    conn->ifc_pts.integral_error += error * (float) dt;
    combined_error = Kp * error + Ki * conn->ifc_pts.integral_error;
    combined_error_abs = fabsf(combined_error);
    conn->ifc_pts.last_sample = now;
    if (combined_error_abs > err_thresh)
    {
        unsigned adj = combined_error_abs / err_divisor;
        unsigned last_pack_tol = conn->ifc_last_pack_tol;
        if (0 == last_pack_tol)
        {
            last_pack_tol = (unsigned)
                lsquic_senhist_largest(&conn->ifc_send_ctl.sc_senhist)
                                                    / conn->ifc_pts.n_acks;
            LSQ_DEBUG("packets sent: %"PRIu64"; ACKs received: %u; implied "
                "tolerance: %u",
                lsquic_senhist_largest(&conn->ifc_send_ctl.sc_senhist),
                conn->ifc_pts.n_acks, last_pack_tol);
            if (last_pack_tol < 2)
                last_pack_tol = 2;
            else if (last_pack_tol >= max_packtol)
                last_pack_tol = max_packtol / 2;
        }
        if (combined_error > 0)
        {
            conn->ifc_last_calc_pack_tol = last_pack_tol + adj;
            if (conn->ifc_last_calc_pack_tol >= max_packtol)
            {
                /* Clamp integral error when we can go no higher */
                conn->ifc_pts.integral_error -= error * (float) dt;
                conn->ifc_last_calc_pack_tol = max_packtol;
            }
        }
        else
        {
            if (adj + 2 < last_pack_tol)
                conn->ifc_last_calc_pack_tol = last_pack_tol - adj;
            else
                conn->ifc_last_calc_pack_tol = 2;
            if (conn->ifc_last_calc_pack_tol == 2)
            {
                /* Clamp integral error when we can go no lower */
                conn->ifc_pts.integral_error -= error * (float) dt;
            }
        }
        if (conn->ifc_last_calc_pack_tol != conn->ifc_last_pack_tol)
        {
            LSQ_DEBUG("old packet tolerance target: %u, schedule ACK_FREQUENCY "
                "%s to %u", conn->ifc_last_pack_tol,
                combined_error > 0 ? "increase" : "decrease",
                conn->ifc_last_calc_pack_tol);
            conn->ifc_send_flags |= SF_SEND_ACK_FREQUENCY;
        }
        else
        {
            LSQ_DEBUG("packet tolerance unchanged at %u", conn->ifc_last_pack_tol);
            conn->ifc_send_flags &= ~SF_SEND_ACK_FREQUENCY;
        }
    }
    else
        conn->ifc_send_flags &= ~SF_SEND_ACK_FREQUENCY;
    LSQ_DEBUG("avg ACKs per RTT: %.3f; normalized: %.3f; target: %.3f; error: %.3f; "
        "p-error: %.3f, i-error: %.3f; Overall: %.3f; "
        "packet tolerance: current: %u, last: %u",
        avg_acks_per_rtt, normalized, target, error, Kp * error,
        conn->ifc_pts.integral_error, combined_error,
        conn->ifc_last_calc_pack_tol, conn->ifc_last_pack_tol);
    /* Until we have the first value, don't reset the counters */
    if (conn->ifc_last_calc_pack_tol != 0)
        conn->ifc_pts.n_acks = 0;

  end:
    if (lsquic_send_ctl_have_unacked_retx_data(&conn->ifc_send_ctl))
    {
        LSQ_DEBUG("set PACK_TOL alarm %"PRIu64" microseconds into the future",
            srtt * periodicity);
        lsquic_alarmset_set(&conn->ifc_alset, al_id, now + srtt * periodicity);
    }
    else
        LSQ_DEBUG("no unacked retx data: do not rearm the packet tolerance "
                                                                    "alarm");
}
