CONCRETE_IO_HANDLE tlsio_mbedtls_create(void *io_create_parameters)
{
    TLSIO_CONFIG *tls_io_config = (TLSIO_CONFIG *)io_create_parameters;
    TLS_IO_INSTANCE *result;

    if (tls_io_config == NULL)
    {
        LogError("NULL tls_io_config");
        result = NULL;
    }
    else
    {
        // Codes_SRS_TLSIO_MBED_OS5_TLS_99_006: [ The tlsio_mbedtls_create shall return NULL if allocating memory for TLS_IO_INSTANCE failed. ]
        result = calloc(1, sizeof(TLS_IO_INSTANCE));
        if (result != NULL)
        {
            SOCKETIO_CONFIG socketio_config;
            const IO_INTERFACE_DESCRIPTION *underlying_io_interface;
            void *io_interface_parameters;

            if (tls_io_config->underlying_io_interface != NULL)
            {
                underlying_io_interface = tls_io_config->underlying_io_interface;
                io_interface_parameters = tls_io_config->underlying_io_parameters;
            }
            else
            {
                socketio_config.hostname = tls_io_config->hostname;
                socketio_config.port = tls_io_config->port;
                socketio_config.accepted_socket = NULL;
                underlying_io_interface = socketio_get_interface_description();
                io_interface_parameters = &socketio_config;
            }

            if (underlying_io_interface == NULL)
            {
                free(result);
                result = NULL;
                LogError("Failed getting socket IO interface description.");
            }
            else
            {
                if (mallocAndStrcpy_s((char **)&result->hostname, tls_io_config->hostname) != 0)
                {
                    free(result);
                    result = NULL;
                    LogError("Failure allocating hostname.");
                }
                else if ((result->socket_io = xio_create(underlying_io_interface, io_interface_parameters)) == NULL)
                {
                    LogError("socket xio create failed");
                    free(result->hostname);
                    free(result);
                    result = NULL;
                }
                else
                {
                    result->tls_status = TLS_STATE_NOT_INITIALIZED;
                    mbedtls_init((void*)result);
                    result->tlsio_state = TLSIO_STATE_NOT_OPEN;
                    result->invoke_on_send_complete_callback_for_fragments = tls_io_config->invoke_on_send_complete_callback_for_fragments;
                }
            }
        }
        else
        {
            LogError("Failure allocating TLS object");
        }
    }
    return result;
}
