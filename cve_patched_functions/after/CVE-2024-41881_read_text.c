read_text(uschar *p, BOOL *iscdata, int pinflags)
{
int len;
int extra = 0;
uschar *pp = p;
uschar *temp = NULL;

/* If we are handling CDATA, search till end of line or ]]>. If there are any
ampersands in the string, we have to convert them into &amp; because there is
no memory that this data is literal, and it will be scanned later for entities.
*/

if (*iscdata)
  {
  int ampcount = 0;
  while (*p != 0 && Ustrncmp(p, "]]>", 3) != 0)
    if (*p++ == '&') ampcount++;
  len = p - pp;

  if (*p != 0)
    {
    *iscdata = FALSE;
    extra = 3;
    }

  if (ampcount != 0)
    {
    uschar *t;
    len += 4*ampcount;
    t = temp = misc_malloc(len);

    while (pp < p)
      {
      *t = *pp++;
      if (*t++ == '&')
        {
        (void)memcpy(t, "amp;", 4);
        t += 4;
        }
      }

    pp = temp;
    }
  }

/* Otherwise, search till end of line or next element. */

else
  {
  while (*p != 0 && *p != '<') p++;
  len = p - pp;
  }

/* If the previous item is a data item, tack this text onto it. */

if (Ustrcmp(read_addto->name, "#PCDATA") == 0)
  {
  textblock *tb = read_addto->p.txtblk;
  textblock *tbnew = misc_malloc(sizeof(textblock) + tb->length + len + 1);
  tbnew->next = NULL;
  tbnew->vfont = NULL;
  tbnew->pin_flags = tb->pin_flags | pinflags;
  tbnew->colour = 0;

  (void)memcpy(tbnew->string, tb->string, tb->length);
  (void)memcpy(tbnew->string + tb->length, pp, len);
  tbnew->length = tb->length + len;
  tbnew->string[tbnew->length] = 0;

  read_addto->p.txtblk = tbnew;
  misc_free(tb, sizeof(textblock) + tb->length);
  }

/* Otherwise we have to make a new data item. The item's name is #PCDATA;
it points to a textblock item. */

else
  {
  item *new;
  textblock *tbnew;

  tbnew = misc_malloc(sizeof(textblock) + len + 1);
  tbnew->next = NULL;
  tbnew->vfont = NULL;
  tbnew->pin_flags = pinflags;
  tbnew->colour = 0;

  (void)memcpy(tbnew->string, pp, len);
  tbnew->length = len;
  tbnew->string[tbnew->length] = 0;

  new = misc_malloc(sizeof(item));
  new->next = read_addto->next;
  new->prev = read_addto;
  new->partner = new;
  new->linenumber = read_linenumber;
  new->flags = 0;
  Ustrcpy(new->name, US"#PCDATA");
  new->p.txtblk = tbnew;

  read_addto->next = new;
  read_addto = new;
  }

if (temp != NULL) misc_free(temp, len);
return p + extra;
}
