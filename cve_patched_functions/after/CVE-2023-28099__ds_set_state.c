static void _ds_set_state(ds_set_p set, int idx, str *address, int state,
	int type, ds_partition_t *partition, int do_repl, int raise_event)
{
	evi_params_p list = NULL;
	int old_flags;

	/* remove the Probing/Inactive-State? Set the fail-count to 0. */
	if (state == DS_PROBING_DST) {
		if (type) {
			if (set->dlist[idx].flags & DS_INACTIVE_DST) {
				LM_INFO("Ignoring the request to set this destination"
						" to probing: It is already inactive!\n");
				return;
			}

			if (do_repl) {
				set->dlist[idx].failure_count++;
				/* Fire only, if the Threshold is reached. */
				if (set->dlist[idx].failure_count
						< probing_threshold)
					return;

				if (set->dlist[idx].failure_count
						> probing_threshold)
					set->dlist[idx].failure_count
						= probing_threshold;
			}
		}
	}
	/* Reset the Failure-Counter */
	if ((state & DS_RESET_FAIL_DST) > 0) {
		set->dlist[idx].failure_count = 0;
		state &= ~DS_RESET_FAIL_DST;
	}

	/* set the new state of the destination */
	old_flags = set->dlist[idx].flags;
	if(type)
		set->dlist[idx].flags |= state;
	else
		set->dlist[idx].flags &= ~state;

	if ( set->dlist[idx].flags != old_flags) {

		/* state actually changed -> do all updates */
		set->dlist[idx].flags |= DS_STATE_DIRTY_DST;

		/* replicate the change of status */
		if (do_repl) replicate_ds_status_event( &partition->name,
			set->id, address, state, type);

		/* update info on active destinations */
		if ( ((old_flags&(DS_PROBING_DST|DS_INACTIVE_DST))?0:1) !=
		((set->dlist[idx].flags&(DS_PROBING_DST|DS_INACTIVE_DST))?0:1) )
			/* this destination switched state between
			 * disabled <> enabled -> update active info */
			re_calculate_active_dsts( set );

		if (raise_event && evi_probe_event(dispatch_evi_id)) {
			if (!(list = evi_get_params()))
				return;

			if (partition != default_partition &&
			evi_param_add_str(list,&partition_str,&partition->name)){
				LM_ERR("unable to add partition parameter\n");
				evi_free_params(list);
				return;
			}
			if (evi_param_add_int(list, &group_str, &set->id)) {
				LM_ERR("unable to add group parameter\n");
				evi_free_params(list);
				return;
			}
			if (evi_param_add_str(list, &address_str, address)) {
				LM_ERR("unable to add address parameter\n");
				evi_free_params(list);
				return;
			}
			if (evi_param_add_str(list, &status_str,
						type ? &inactive_str : &active_str)) {
				LM_ERR("unable to add status parameter\n");
				evi_free_params(list);
				return;
			}
			if (evi_raise_event(dispatch_evi_id, list)) {
				LM_ERR("unable to send event\n");
			}
		} else {
			LM_DBG("no event sent\n");
		}

	} /* end 'if status changed' */
}
