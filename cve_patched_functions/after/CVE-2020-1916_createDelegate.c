int LightProcess::createDelegate() {
  int pair[2];
  if (socketpair(AF_UNIX, SOCK_STREAM, 0, pair)) {
    Logger::Warning("Unable to create a unix socket pair: %s",
                    folly::errnoStr(errno).c_str());
    return -1;
  }

  pid_t child = fork();

  if (child < 0) {
    Logger::Warning("Unable to fork delegate process: %s",
                    folly::errnoStr(errno).c_str());
    close(pair[0]);
    close(pair[1]);
    return -1;
  }

  if (child == 0) {
    // child
    fclose(stdin);
    fclose(stdout);
    fclose(stderr);

    mprotect_1g_pages(PROT_READ);
    if (s_trackProcessTimes) {
      HardwareCounter::RecordSubprocessTimes();
    }
    Logger::ResetPid();
    pid_t sid = setsid();
    if (sid < 0) {
      Logger::Warning("Unable to setsid");
      _Exit(HPHP_EXIT_FAILURE);
    }

    close(pair[0]);
#ifdef __APPLE__
    {
      int newfd = dup2(pair[1], 0);
      always_assert(newfd == 0);
    }
    close(pair[1]);
    pair[1] = 0;
#endif
    runShadow(pair[1]);
  }

  always_assert(child > 0);
  close(pair[1]);
  return pair[0];
}
