extern "C" void CoreCleanup(
    __in BURN_ENGINE_STATE* pEngineState
    )
{
    HRESULT hr = S_OK;
    LONGLONG llValue = 0;
    BOOL fNeedsElevation = pEngineState->registration.fPerMachine && INVALID_HANDLE_VALUE == pEngineState->companionConnection.hPipe;

    LogId(REPORT_STANDARD, MSG_CLEANUP_BEGIN);

    if (pEngineState->plan.fAffectedMachineState)
    {
        LogId(REPORT_STANDARD, MSG_CLEANUP_SKIPPED_APPLY);
        ExitFunction();
    }

    if (fNeedsElevation)
    {
        hr = VariableGetNumeric(&pEngineState->variables, BURN_BUNDLE_ELEVATED, &llValue);
        ExitOnFailure(hr, "Failed to get value of WixBundleElevated variable during cleanup");

        if (llValue)
        {
            fNeedsElevation = FALSE;
        }
        else
        {
            LogId(REPORT_STANDARD, MSG_CLEANUP_SKIPPED_ELEVATION_REQUIRED);
            ExitFunction();
        }
    }

    if (!pEngineState->fDetected)
    {
        hr = CoreDetect(pEngineState, pEngineState->hMessageWindow);
        ExitOnFailure(hr, "Detect during cleanup failed");
    }

    if (!pEngineState->registration.fEligibleForCleanup)
    {
        ExitFunction();
    }

    hr = CorePlan(pEngineState, BOOTSTRAPPER_ACTION_UNINSTALL);
    ExitOnFailure(hr, "Plan during cleanup failed");

    hr = CoreApply(pEngineState, pEngineState->hMessageWindow);
    ExitOnFailure(hr, "Apply during cleanup failed");

LExit:
    LogId(REPORT_STANDARD, MSG_CLEANUP_COMPLETE, hr);
}
