int belle_sip_dialog_establish_full(belle_sip_dialog_t *obj, belle_sip_request_t *req, belle_sip_response_t *resp){
	belle_sip_header_contact_t *ct=belle_sip_message_get_header_by_type(resp,belle_sip_header_contact_t);
	belle_sip_header_to_t *to=belle_sip_message_get_header_by_type(resp,belle_sip_header_to_t);
	const belle_sip_list_t *elem;

	if (strcmp(belle_sip_request_get_method(req),"INVITE")==0)
		obj->needs_ack=TRUE;

	if (obj->is_server){
		if (strcmp(belle_sip_request_get_method(req),"INVITE")==0){
			belle_sip_dialog_init_200Ok_retrans(obj,resp);
		}
	} else {
		if (!ct && !obj->remote_target) {
			belle_sip_error("Missing contact header in resp [%p] cannot set remote target for dialog [%p]",resp,obj);
			return -1;
		}
		/* 13.2.2.4 2xx Responses
		   ...
		   If the dialog identifier in the 2xx response matches the dialog
		   identifier of an existing dialog, the dialog MUST be transitioned to
		   the "confirmed" state, and the route set for the dialog MUST be
		   recomputed based on the 2xx response using the procedures of Section
		   12.2.1.2.
		 */
		obj->route_set=belle_sip_list_free_with_data(obj->route_set,belle_sip_object_unref);
		for(elem=belle_sip_message_get_headers((belle_sip_message_t*)resp,BELLE_SIP_RECORD_ROUTE);elem!=NULL;elem=elem->next){
			obj->route_set=belle_sip_list_prepend(obj->route_set,belle_sip_object_ref(belle_sip_header_route_create(
			                                     (belle_sip_header_address_t*)elem->data)));
		}

		if (ct) {
			/*remote Contact header may have changed between early dialog to confirmed*/
			if (obj->remote_target) belle_sip_object_unref(obj->remote_target);
			obj->remote_target=(belle_sip_header_address_t*)belle_sip_object_ref(ct);
		}
	}
	/*update to tag*/
	set_to_tag(obj,to);
	set_state(obj,BELLE_SIP_DIALOG_CONFIRMED);
	return 0;
}
