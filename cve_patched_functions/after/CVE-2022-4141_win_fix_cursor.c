win_fix_cursor(int normal)
{
    long	so = get_scrolloff_value();
    win_T	*wp = curwin;
    linenr_T	nlnum = 0;
    linenr_T	lnum = wp->w_cursor.lnum;
    linenr_T	bot;
    linenr_T	top;

    if (wp->w_buffer->b_ml.ml_line_count < wp->w_height)
	return;
    if (skip_win_fix_cursor)
	return;

    // Determine valid cursor range.
    so = MIN(wp->w_height / 2, so);
    wp->w_cursor.lnum = wp->w_topline;
    top = cursor_down_inner(wp, so);
    wp->w_cursor.lnum = wp->w_botline - 1;
    bot = cursor_up_inner(wp, so);
    wp->w_cursor.lnum = lnum;
    // Check if cursor position is above or below valid cursor range.
    if (lnum > bot && (wp->w_botline - wp->w_buffer->b_ml.ml_line_count) != 1)
	nlnum = bot;
    else if (lnum < top && wp->w_topline != 1)
	nlnum = (so == wp->w_height / 2) ? bot : top;

    if (nlnum)  // Cursor is invalid for current scroll position.
    {
	if (normal)  // Save to jumplist and set cursor to avoid scrolling.
	{
	    setmark('\'');
	    wp->w_cursor.lnum = nlnum;
	}
	else  // Scroll instead when not in normal mode.
	{
	    wp->w_fraction = (nlnum == bot) ? FRACTION_MULT : 0;
	    scroll_to_fraction(wp, wp->w_prev_height);
	    validate_botline_win(curwin);
	}
    }
}
