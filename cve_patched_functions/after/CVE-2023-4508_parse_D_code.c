parse_D_code(gerb_file_t *fd, gerb_state_t *state,
		gerbv_image_t *image, long int *line_num_p)
{
    int a;
    gerbv_stats_t *stats = image->gerbv_stats;
    gerbv_error_list_t *error_list = stats->error_list;

    a = gerb_fgetint(fd, NULL);
    dprintf("     Found D%02d code at line %ld\n", a, *line_num_p);

    switch(a) {
    case 0 : /* Invalid code */
        gerbv_stats_printf(error_list, GERBV_MESSAGE_ERROR, -1,
		_("Found invalid D00 code at line %ld in file \"%s\""),
		*line_num_p, fd->filename);
        stats->D_error++;
	break;
    case 1 : /* Exposure on */
	state->aperture_state = GERBV_APERTURE_STATE_ON;
	state->changed = 1;
	stats->D1++;
	break;
    case 2 : /* Exposure off */
	state->aperture_state = GERBV_APERTURE_STATE_OFF;
	state->changed = 1;
	stats->D2++;
	break;
    case 3 : /* Flash aperture */
	state->aperture_state = GERBV_APERTURE_STATE_FLASH;
	state->changed = 1;
	stats->D3++;
	break;
    default: /* Aperture in use */
	if ((a >= 0) && (a <= APERTURE_MAX)) {
	    state->curr_aperture = a;
	    
	} else {
	    gerbv_stats_printf(error_list, GERBV_MESSAGE_ERROR, -1,
		    _("Found out of bounds aperture D%02d "
			"at line %ld in file \"%s\""),
		    a, *line_num_p, fd->filename);
	    stats->D_error++;
	}
	state->changed = 0;
	break;
    }
    
    return;
} /* parse_D_code */
