njs_unit_test(njs_unit_test_t tests[], size_t num, njs_str_t *name,
    njs_opts_t *opts, njs_stat_t *stat)
{
    u_char                *start, *end;
    njs_vm_t              *vm;
    njs_int_t             ret;
    njs_str_t             s;
    njs_bool_t            success;
    njs_uint_t            i;
    njs_stat_t            prev;
    njs_vm_opt_t          options;
    njs_runtime_t         *rt;
    njs_external_state_t  *state;

    vm = NULL;
    rt = NULL;

    prev = *stat;

    ret = NJS_ERROR;

    for (i = 0; i < num; i++) {

        if (opts->verbose) {
            njs_printf("\"%V\"\n", &tests[i].script);
        }

        njs_vm_opt_init(&options);

        options.module = opts->module;
        options.unsafe = opts->unsafe;
        options.backtrace = opts->backtrace;

        vm = njs_vm_create(&options);
        if (vm == NULL) {
            njs_printf("njs_vm_create() failed\n");
            goto done;
        }

        if (opts->externals) {
            ret = njs_externals_shared_init(vm);
            if (ret != NJS_OK) {
                goto done;
            }
        }

        start = tests[i].script.start;
        end = start + tests[i].script.length;

        ret = njs_vm_compile(vm, &start, end);

        if (ret == NJS_OK && start == end) {
            if (opts->disassemble) {
                njs_disassembler(vm);
            }

            rt = njs_runtime_init(vm, opts);
            if (rt == NULL) {
                njs_stderror("njs_runtime_init() failed\n");
                goto done;
            }

            for ( ;; ) {
                state = njs_runtime_next_state(rt, opts);
                if (state == NULL) {
                    break;
                }

                ret = njs_process_test(state, opts, &tests[i]);
                if (ret != NJS_OK) {
                    if (ret == NJS_DECLINED) {
                        break;
                    }

                    njs_stderror("njs_process_test() failed\n");
                    goto done;
                }
            }

            success = (ret == NJS_OK);

            if (rt != NULL) {
                njs_runtime_destroy(rt);
                rt = NULL;
            }

        } else {
            if (ret != NJS_OK) {
                if (njs_vm_retval_string(vm, &s) != NJS_OK) {
                    njs_printf("njs_vm_retval_string() failed\n");
                    goto done;
                }

            } else {
                s = njs_str_value("Error: "
                                  "Extra characters at the end of the script");
            }

            success = njs_strstr_eq(&tests[i].ret, &s);
            if (!success) {
                njs_stderror("njs(\"%V\")\nexpected: \"%V\"\n"
                             "     got: \"%V\"\n",
                             &tests[i].script, &tests[i].ret, &s);
            }
        }

        if (success) {
            stat->passed++;

        } else {
            stat->failed++;
        }

        njs_vm_destroy(vm);
        vm = NULL;
    }

    ret = NJS_OK;

done:

    if (rt != NULL) {
        njs_runtime_destroy(rt);
    }

    if (vm != NULL) {
        njs_vm_destroy(vm);
    }

    njs_unit_test_report(name, &prev, stat);

    return ret;
}
