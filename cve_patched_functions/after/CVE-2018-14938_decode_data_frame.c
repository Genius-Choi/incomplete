int WifiPacket::decode_data_frame(const u_char * ptr, size_t len, u_int16_t fc)
{
    mac_hdr_t hdr;
    hdr.fc       = fc;
    hdr.duration = EXTRACT_LE_16BITS(ptr+2);
    hdr.seq_ctl  = pletohs(ptr + 22);
    hdr.seq      = COOK_SEQUENCE_NUMBER(hdr.seq_ctl);
    hdr.frag     = COOK_FRAGMENT_NUMBER(hdr.seq_ctl);

    if(FC_TYPE(fc)==2 && FC_SUBTYPE(fc)==8){ // quality of service?
        hdr.qos = 1;
    }
        
    size_t hdrlen=0;

    const MAC address1 = MAC::ether2MAC(ptr+4);
    const MAC address2 = MAC::ether2MAC(ptr+10);
    const MAC address3 = MAC::ether2MAC(ptr+16);
    
    /* call the 80211 callback data callback */

    if (FC_TO_DS(fc)==0 && FC_FROM_DS(fc)==0) {	/* ad hoc IBSS */
	hdr.da = address1;
	hdr.sa = address2;
	hdr.bssid = address3;
	hdrlen = DATA_HDRLEN;
        if(hdr.qos) hdrlen+=2;
        cbs->Handle80211( *this, fc, hdr.sa, hdr.da, hdr.ra, hdr.ta, ptr, len);
	cbs->Handle80211DataIBSS( *this, hdr, ptr+hdrlen, len-hdrlen);
    } else if (FC_TO_DS(fc)==0 && FC_FROM_DS(fc)) { /* from AP to STA */
        hdr.da = address1;
        hdr.bssid = address2;
        hdr.sa = address3;
	hdrlen = DATA_HDRLEN;
        if(hdr.qos) hdrlen+=2;
        cbs->Handle80211( *this, fc, hdr.sa, hdr.da, hdr.ra, hdr.ta, ptr, len);
	cbs->Handle80211DataFromAP( *this, hdr, ptr+hdrlen, len-hdrlen);
    } else if (FC_TO_DS(fc) && FC_FROM_DS(fc)==0) {	/* frame from STA to AP */
        hdr.bssid = address1;
        hdr.sa = address2;
        hdr.da = address3;
	hdrlen = DATA_HDRLEN;
        if(hdr.qos) hdrlen+=2;
        cbs->Handle80211( *this, fc, hdr.sa, hdr.da, hdr.ra, hdr.ta, ptr, len);
	cbs->Handle80211DataToAP( *this, hdr, ptr+hdrlen, len-hdrlen);
    } else if (FC_TO_DS(fc) && FC_FROM_DS(fc)) {	/* WDS */
        const MAC address4 = MAC::ether2MAC(ptr+18);
        hdr.ra = address1;
        hdr.ta = address2;
        hdr.da = address3;
        hdr.sa = address4;
        hdrlen = DATA_WDS_HDRLEN;
        if(hdr.qos) hdrlen+=2;
        cbs->Handle80211( *this, fc, hdr.sa, hdr.da, hdr.ra, hdr.ta, ptr, len);
	cbs->Handle80211DataWDS( *this, hdr, ptr+hdrlen, len-hdrlen);
    }

    /* Handle either the WEP or the link layer. This handles the data itself */
    if (FC_WEP(fc)) {
        handle_wep(ptr+hdrlen, len-hdrlen-4 ); 
    } else {
        handle_llc(hdr, ptr+hdrlen, len-hdrlen-4, fc); 
    }
    return 0;
}
