void Isolate::Shutdown() {
  Thread* thread = Thread::Current();
  ASSERT(this == thread->isolate());

  // Don't allow anymore dart code to execution on this isolate.
  thread->ClearStackLimit();

  {
    StackZone zone(thread);
    HandleScope handle_scope(thread);
    ServiceIsolate::SendIsolateShutdownMessage();
#if !defined(PRODUCT)
    debugger()->Shutdown();
    // Cleanup profiler state.
    SampleBlock* cpu_block = current_sample_block();
    if (cpu_block != nullptr) {
      cpu_block->release_block();
    }
    SampleBlock* allocation_block = current_allocation_sample_block();
    if (allocation_block != nullptr) {
      allocation_block->release_block();
    }

    // Process the previously assigned sample blocks if we're using the
    // profiler's sample buffer. Some tests create their own SampleBlockBuffer
    // and handle block processing themselves.
    if ((cpu_block != nullptr || allocation_block != nullptr) &&
        Profiler::sample_block_buffer() != nullptr) {
      StackZone zone(thread);
      HandleScope handle_scope(thread);
      Profiler::sample_block_buffer()->ProcessCompletedBlocks();
    }
#endif
  }

#if !defined(PRODUCT) && !defined(DART_PRECOMPILED_RUNTIME)
  if (FLAG_check_reloaded && is_runnable() && !Isolate::IsSystemIsolate(this)) {
    if (!group()->HasAttemptedReload()) {
      FATAL(
          "Isolate did not reload before exiting and "
          "--check-reloaded is enabled.\n");
    }
  }

#endif  // !defined(PRODUCT) && !defined(DART_PRECOMPILED_RUNTIME)

  // Then, proceed with low-level teardown.
  Isolate::UnMarkIsolateReady(this);

  // Post message before LowLevelShutdown that sends onExit message.
  // This ensures that exit message comes last.
  if (bequest_.get() != nullptr) {
    auto beneficiary = bequest_->beneficiary();
    auto handle = bequest_->TakeHandle();
    PortMap::PostMessage(
        Message::New(beneficiary, handle, Message::kNormalPriority));
    bequest_.reset();
  }

  LowLevelShutdown();

  // Now we can unregister from the thread, invoke cleanup callback, delete the
  // isolate (and possibly the isolate group).
  Isolate::LowLevelCleanup(this);
}
