static int callback_oidc_authorization(const struct _u_request * request, struct _u_response * response, void * user_data) {
  struct _oidc_config * config = (struct _oidc_config *)user_data;
  const char * response_type = NULL,
             * redirect_uri = NULL,
             * client_id = NULL,
             * scope = NULL,
             * nonce = NULL,
             * resource = NULL,
             * claims = NULL,
             * code_challenge = NULL,
             * code_challenge_method = NULL,
             * display = NULL,
             * ui_locales = NULL,
             * login_hint = NULL,
             * prompt = NULL,
             * id_token_hint = NULL,
             * ip_source = get_ip_source(request, config->glewlwyd_config->glewlwyd_config->originating_ip_header),
             * key = NULL,
             * max_age = NULL,
             * str_response_mode = NULL,
             * state = NULL,
             * authorization_code = NULL,
             * dpop_jkt = NULL;
  char * redirect_url = NULL,
      ** resp_type_array = NULL,
      ** scope_list = NULL,
      ** resource_list = NULL,
       * authorization_code_out = NULL,
       * access_token = NULL,
       * id_token = NULL,
       * id_token_out = NULL,
       * expires_in_str = NULL,
       * iat_str = NULL,
       * str_request = NULL,
       * access_token_out = NULL,
       * session_state = NULL,
       * rar_list = NULL,
       * scope_reduced = NULL,
       * id_token_hash = NULL,
       * issued_for = NULL,
       * endptr = NULL,
       * s_hash = NULL,
         jti[OIDC_JTI_LENGTH+1] = {0},
         sid[OIDC_SID_LENGTH+1] = {0},
         code_challenge_stored[GLEWLWYD_CODE_CHALLENGE_MAX_LENGTH + 1] = {0};
  json_t * j_request = NULL,
         * j_client = NULL,
         * j_client_checked = NULL,
         * j_authorization_details = NULL,
         * j_authorization_details_processed = NULL,
         * j_authorization_code = NULL,
         * j_element = NULL,
         * j_claims = NULL,
         * j_session = NULL,
         * j_reduced_scope = NULL,
         * j_last_token = NULL,
         * j_rar_filtered_result = NULL;
  time_t now = 0;
  int auth_type = GLEWLWYD_AUTHORIZATION_TYPE_NULL_FLAG,
      check_request = 0,
      request_par = 0,
      has_code = 0,
      has_token = 0,
      has_id_token = 0,
      has_none = 0,
      res,
      enc_res = G_OK,
      resource_error = 0;
  struct _u_map map_redirect, map_login, * map = get_map(request);
  int response_mode = GLEWLWYD_RESPONSE_MODE_QUERY;
  size_t index = 0, count_resource;
  long int l_max_age;
  jwk_t * jwk_id_token = NULL;
  jwt_t * jwt = NULL;
  jwa_alg alg;

  u_map_put(response->map_header, "Cache-Control", "no-store");
  u_map_put(response->map_header, "Pragma", "no-cache");
  u_map_put(response->map_header, "Referrer-Policy", "no-referrer");

  time(&now);

  if (u_map_init(&map_redirect) != U_OK) {
    y_log_message(Y_LOG_LEVEL_ERROR, "callback_oidc_authorization - Error u_map_init map_redirect");
    response->status = 500;
    return U_CALLBACK_CONTINUE;
  }

  if (u_map_init(&map_login) != U_OK) {
    y_log_message(Y_LOG_LEVEL_ERROR, "callback_oidc_authorization - Error u_map_init map_login");
    response->status = 500;
    return U_CALLBACK_CONTINUE;
  }

  do {
    if (u_map_has_key(map, "state")) {
      u_map_put(&map_redirect, "state", u_map_get(map, "state"));
      state = u_map_get(map, "state");
    }
    if (u_map_has_key(map, "redirect_uri")) {
      redirect_uri = u_map_get(map, "redirect_uri");
    }
    if (u_map_has_key(map, "client_id")) {
      client_id = u_map_get(map, "client_id");
    }
    if (u_map_has_key(map, "scope")) {
      scope = u_map_get(map, "scope");
    }
    if (u_map_has_key(map, "nonce")) {
      nonce = u_map_get(map, "nonce");
    }
    if (u_map_has_key(map, "claims")) {
      claims = u_map_get(map, "claims");
    }
    if (u_map_has_key(map, "display")) {
      display = u_map_get(map, "display");
    }
    if (u_map_has_key(map, "ui_locales")) {
      ui_locales = u_map_get(map, "ui_locales");
    }
    if (u_map_has_key(map, "login_hint")) {
      login_hint = u_map_get(map, "login_hint");
    }
    if (u_map_has_key(map, "prompt")) {
      prompt = u_map_get(map, "prompt");
    }
    if (u_map_has_key(map, "id_token_hint")) {
      id_token_hint = u_map_get(map, "id_token_hint");
    }
    if (u_map_has_key(map, "max_age")) {
      max_age = u_map_get(map, "max_age");
    }
    if (u_map_has_key(map, "code_challenge")) {
      code_challenge = u_map_get(map, "code_challenge");
    }
    if (u_map_has_key(map, "code_challenge_method")) {
      code_challenge_method = u_map_get(map, "code_challenge_method");
    }
    if (u_map_has_key(map, "resource") && json_object_get(config->j_params, "resource-allowed") == json_true()) {
      resource = u_map_get(map, "resource");
    }
    if (u_map_has_key(map, "dpop_jkt") && json_object_get(config->j_params, "oauth-dpop-allowed") == json_true()) {
      dpop_jkt = u_map_get(map, "dpop_jkt");
    }

    if (u_map_has_key(map, "response_type")) {
      response_type = u_map_get(map, "response_type");
      if (o_strstr(response_type, "code") == NULL) {
        response_mode = GLEWLWYD_RESPONSE_MODE_FRAGMENT;
      }
    }

    if (!o_strnullempty(response_type) && check_client_redirect_uri_valid(config, client_id, redirect_uri, ip_source) != G_OK) {
      y_log_message(Y_LOG_LEVEL_DEBUG, "callback_oidc_authorization - invlid client identified with redirect_uri");
      response->status = 403;
      break;
    }

    if (u_map_has_key(map, "response_mode")) {
      str_response_mode = u_map_get(map, "response_mode");
      if (0 == o_strcmp("query", str_response_mode)) {
        response_mode = GLEWLWYD_RESPONSE_MODE_QUERY;
      } else if (0 == o_strcmp("fragment", str_response_mode)) {
        response_mode = GLEWLWYD_RESPONSE_MODE_FRAGMENT;
      } else if (0 == o_strcmp("form_post", str_response_mode)) {
        response_mode = GLEWLWYD_RESPONSE_MODE_FORM_POST;
      } else if (json_object_get(config->j_params, "oauth-fapi-allow-jarm") == json_true() && (0 == o_strcmp("query.jwt", str_response_mode) || 0 == o_strcmp("jwt", str_response_mode))) {
        response_mode = GLEWLWYD_RESPONSE_MODE_QUERY_JWT;
      } else if (json_object_get(config->j_params, "oauth-fapi-allow-jarm") == json_true() && 0 == o_strcmp("fragment.jwt", str_response_mode)) {
        response_mode = GLEWLWYD_RESPONSE_MODE_FRAGMENT_JWT;
      } else if (json_object_get(config->j_params, "oauth-fapi-allow-jarm") == json_true() && 0 == o_strcmp("form_post.jwt", str_response_mode)) {
        response_mode = GLEWLWYD_RESPONSE_MODE_FORM_POST_JWT;
      }
    }

    if (!o_strnullempty(u_map_get(map, "authorization_details")) && json_object_get(config->j_params, "oauth-rar-allowed") == json_true() && json_object_get(config->j_params, "rar-allow-auth-unsigned") == json_true()) {
      if ((j_authorization_details = json_loads(u_map_get(map, "authorization_details"), JSON_DECODE_ANY, NULL)) == NULL) {
        y_log_message(Y_LOG_LEVEL_DEBUG, "callback_oidc_authorization - Invalid authorization_details, origin: %s", ip_source);
        u_map_put(&map_redirect, "error", "invalid_request");
        u_map_put(&map_redirect, "error_description", "Invalid authorization_details");
        build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
        break;
      }
    }

    if (json_object_get(config->j_params, "oauth-par-allowed") == json_true()) {
      if (o_strlen(u_map_get(map, "request_uri")) > json_string_length(json_object_get(config->j_params, "oauth-par-request_uri-prefix")) &&
          0 == o_strncmp(u_map_get(map, "request_uri"), json_string_value(json_object_get(config->j_params, "oauth-par-request_uri-prefix")), json_string_length(json_object_get(config->j_params, "oauth-par-request_uri-prefix")))) {
        j_request = verify_pushed_authorization_request(config, u_map_get(map, "request_uri"), client_id, ip_source);
        check_request = 1;
        request_par = 1;
      } else if (json_object_get(config->j_params, "oauth-par-required") == json_true()) {
        y_log_message(Y_LOG_LEVEL_DEBUG, "callback_oidc_authorization - Pushed authorization request is mandatory, origin: %s", ip_source);
        response->status = 403;
        break;
      }
    }

    if (j_request == NULL && (!o_strnullempty(u_map_get(map, "request")) || !o_strnullempty(u_map_get(map, "request_uri")))) {
      if (json_object_get(config->j_params, "request-parameter-allow") != json_false()) {
        if (!o_strnullempty(u_map_get(map, "request")) && !o_strnullempty(u_map_get(map, "request_uri"))) {
          // parameters request and request_uri at the same time is forbidden
          u_map_put(&map_redirect, "error", "invalid_request");
          u_map_put(&map_redirect, "error_description", "request_uri forbidden");
          build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
        } else if (!o_strnullempty(u_map_get(map, "request_uri"))) {
          if ((str_request = get_request_from_uri(config, u_map_get(map, "request_uri"))) == NULL) {
            y_log_message(Y_LOG_LEVEL_DEBUG, "callback_oidc_authorization - Error getting request from uri %s, origin: %s", u_map_get(map, "request_uri"), ip_source);
            u_map_put(&map_redirect, "error", "invalid_request_uri");
            build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
            break;
          } else {
            j_request = validate_jwt_auth_request(config, str_request, client_id, ip_source);
            check_request = 1;
          }
          o_free(str_request);
        } else if (!o_strnullempty(u_map_get(map, "request"))) {
          j_request = validate_jwt_auth_request(config, u_map_get(map, "request"), client_id, ip_source);
          check_request = 1;
        }
      } else if (!o_strnullempty(u_map_get(map, "request"))) {
        u_map_put(&map_redirect, "error", "request_not_supported");
        build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
        break;
      } else if (!o_strnullempty(u_map_get(map, "request_uri"))) {
        u_map_put(&map_redirect, "error", "request_uri_not_supported");
        build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
        break;
      }
    }

    if (check_request) {
      if (check_result_value(j_request, G_ERROR_UNAUTHORIZED) || check_result_value(j_request, G_ERROR_PARAM)) {
        u_map_put(&map_redirect, "error", "invalid_request_object");
        build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
        break;
      } else if (!check_result_value(j_request, G_OK)) {
        response->status = 500;
      } else {
        if (json_string_null_or_empty(json_object_get(json_object_get(j_request, "request"), "client_id")) || (u_map_has_key(map, "client_id") && 0 != o_strcmp(json_string_value(json_object_get(json_object_get(j_request, "request"), "client_id")), u_map_get(map, "client_id")))) {
          // url parameter client_id can't differ from request parameter if set and must be present in request
          y_log_message(Y_LOG_LEVEL_DEBUG, "callback_oidc_authorization - client_id missing or invalid, origin: %s", ip_source);
          response->status = 403;
        } else if (json_string_null_or_empty(json_object_get(json_object_get(j_request, "request"), "response_type")) || (u_map_has_key(map, "response_type") && 0 != o_strcmp(json_string_value(json_object_get(json_object_get(j_request, "request"), "response_type")), u_map_get(map, "response_type")))) {
          // url parameter response_type can't differ from request parameter if set and must be present in request
          y_log_message(Y_LOG_LEVEL_DEBUG, "callback_oidc_authorization - response_type missing or invalid, origin: %s", ip_source);
          response->status = 403;
        } else if (json_string_null_or_empty(json_object_get(json_object_get(j_request, "request"), "redirect_uri"))) {
          y_log_message(Y_LOG_LEVEL_DEBUG, "callback_oidc_authorization - redirect_uri missing, origin: %s", ip_source);
          // redirect_uri is mandatory
          response->status = 403;
        } else {
          response_type = json_string_value(json_object_get(json_object_get(j_request, "request"), "response_type"));
          redirect_uri = json_string_value(json_object_get(json_object_get(j_request, "request"), "redirect_uri"));
          client_id = json_string_value(json_object_get(json_object_get(j_request, "request"), "client_id"));
          scope = json_string_value(json_object_get(json_object_get(j_request, "request"), "scope"));
          display = json_string_value(json_object_get(json_object_get(j_request, "request"), "display"));
          ui_locales = json_string_value(json_object_get(json_object_get(j_request, "request"), "ui_locales"));
          login_hint = json_string_value(json_object_get(json_object_get(j_request, "request"), "login_hint"));
          prompt = json_string_value(json_object_get(json_object_get(j_request, "request"), "prompt"));
          max_age = json_string_value(json_object_get(json_object_get(j_request, "request"), "max_age"));
          if (check_client_redirect_uri_valid(config, client_id, redirect_uri, ip_source) != G_OK) {
            y_log_message(Y_LOG_LEVEL_DEBUG, "callback_oidc_authorization - invlid client identified with redirect_uri");
            response->status = 403;
            break;
          }
          if (code_challenge == NULL || request_par) {
            code_challenge = json_string_value(json_object_get(json_object_get(j_request, "request"), "code_challenge"));
          }
          if (code_challenge_method == NULL || request_par) {
            code_challenge_method = json_string_value(json_object_get(json_object_get(j_request, "request"), "code_challenge_method"));
          }
          if (nonce == NULL || request_par) {
            nonce = json_string_value(json_object_get(json_object_get(j_request, "request"), "nonce"));
          }
          if (!u_map_has_key(&map_redirect, "state")) {
            u_map_put(&map_redirect, "state", json_string_value(json_object_get(json_object_get(j_request, "request"), "state")));
            state = json_string_value(json_object_get(json_object_get(j_request, "request"), "state"));
          }
          if ((resource == NULL || request_par) && json_object_get(config->j_params, "resource-allowed") == json_true()) {
            resource = json_string_value(json_object_get(json_object_get(j_request, "request"), "resource"));
          }
          if ((dpop_jkt == NULL || request_par) && json_object_get(config->j_params, "oauth-dpop-allowed") == json_true()) {
            dpop_jkt = json_string_value(json_object_get(json_object_get(j_request, "request"), "dpop_jkt"));
          }
          if ((j_authorization_details == NULL || request_par) && json_object_get(json_object_get(j_request, "request"), "authorization_details") != NULL) {
            if (json_object_get(config->j_params, "oauth-rar-allowed") == json_true()) {
              if ((json_integer_value(json_object_get(j_request, "type")) != R_JWT_TYPE_NESTED_SIGN_THEN_ENCRYPT && json_object_get(config->j_params, "rar-allow-auth-unencrypted") == json_true()) || json_integer_value(json_object_get(j_request, "type")) == R_JWT_TYPE_NESTED_SIGN_THEN_ENCRYPT) {
                json_decref(j_authorization_details);
                j_authorization_details = json_incref(json_object_get(json_object_get(j_request, "request"), "authorization_details"));
              } else {
                y_log_message(Y_LOG_LEVEL_DEBUG, "callback_oidc_authorization - unencrypted authorization_details fobidden, origin: %s", ip_source);
                // redirect_uri is mandatory
                response->status = 403;
                break;
              }
            } else {
              y_log_message(Y_LOG_LEVEL_DEBUG, "callback_oidc_authorization - authorization_details fobidden, origin: %s", ip_source);
              // redirect_uri is mandatory
              response->status = 403;
              break;
            }
          }
          if (json_object_get(json_object_get(j_request, "request"), "response_mode") != NULL) {
            str_response_mode = json_string_value(json_object_get(json_object_get(j_request, "request"), "response_mode"));
            if (0 == o_strcmp("query", str_response_mode)) {
              response_mode = GLEWLWYD_RESPONSE_MODE_QUERY;
            } else if (0 == o_strcmp("fragment", str_response_mode)) {
              response_mode = GLEWLWYD_RESPONSE_MODE_FRAGMENT;
            } else if (0 == o_strcmp("form_post", str_response_mode)) {
              response_mode = GLEWLWYD_RESPONSE_MODE_FORM_POST;
            } else if (json_object_get(config->j_params, "oauth-fapi-allow-jarm") == json_true() && (0 == o_strcmp("query.jwt", str_response_mode) || 0 == o_strcmp("jwt", str_response_mode))) {
              response_mode = GLEWLWYD_RESPONSE_MODE_QUERY_JWT;
            } else if (json_object_get(config->j_params, "oauth-fapi-allow-jarm") == json_true() && 0 == o_strcmp("fragment.jwt", str_response_mode)) {
              response_mode = GLEWLWYD_RESPONSE_MODE_FRAGMENT_JWT;
            } else if (json_object_get(config->j_params, "oauth-fapi-allow-jarm") == json_true() && 0 == o_strcmp("form_post.jwt", str_response_mode)) {
              response_mode = GLEWLWYD_RESPONSE_MODE_FORM_POST_JWT;
            }
          }
        }
      }
    }

    if (j_authorization_details!= NULL && authorization_details_validate(config, j_authorization_details, client_id, scope) != G_OK) {
      y_log_message(Y_LOG_LEVEL_DEBUG, "callback_oidc_authorization - Invalid authorization_details content, origin: %s", ip_source);
      u_map_put(&map_redirect, "error", "invalid_request");
      u_map_put(&map_redirect, "error_description", "Invalid authorization_details content");
      build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
      break;
    }

    if (j_request != NULL) {
      j_client = json_pack("{sisO}", "result", G_OK, "client", json_object_get(j_request, "client"));
    } else {
      j_client = config->glewlwyd_config->glewlwyd_plugin_callback_get_client(config->glewlwyd_config, client_id);
      if (check_result_value(j_client, G_ERROR_NOT_FOUND) || check_result_value(j_client, G_ERROR_PARAM) || json_object_get(json_object_get(j_client, "client"), "enabled") != json_true()) {
        u_map_put(&map_redirect, "error", "unauthorized_client");
        build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
        break;
      } else if (!check_result_value(j_client, G_OK)) {
        y_log_message(Y_LOG_LEVEL_ERROR, "callback_oidc_authorization - Error glewlwyd_plugin_callback_get_client");
        u_map_put(&map_redirect, "error", "server_error");
        build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
        break;
      }
    }

    if (json_object_get(json_object_get(j_client, "client"), "response_mode") != NULL) {
      str_response_mode = json_string_value(json_object_get(json_object_get(j_client, "client"), "response_mode"));
      if (0 == o_strcmp("query", str_response_mode)) {
        response_mode = GLEWLWYD_RESPONSE_MODE_QUERY;
      } else if (0 == o_strcmp("fragment", str_response_mode)) {
        response_mode = GLEWLWYD_RESPONSE_MODE_FRAGMENT;
      } else if (0 == o_strcmp("form_post", str_response_mode)) {
        response_mode = GLEWLWYD_RESPONSE_MODE_FORM_POST;
      } else if (json_object_get(config->j_params, "oauth-fapi-allow-jarm") == json_true() && (0 == o_strcmp("query.jwt", str_response_mode) || 0 == o_strcmp("jwt", str_response_mode))) {
        response_mode = GLEWLWYD_RESPONSE_MODE_QUERY_JWT;
      } else if (json_object_get(config->j_params, "oauth-fapi-allow-jarm") == json_true() && 0 == o_strcmp("fragment.jwt", str_response_mode)) {
        response_mode = GLEWLWYD_RESPONSE_MODE_FRAGMENT_JWT;
      } else if (json_object_get(config->j_params, "oauth-fapi-allow-jarm") == json_true() && 0 == o_strcmp("form_post.jwt", str_response_mode)) {
        response_mode = GLEWLWYD_RESPONSE_MODE_FORM_POST_JWT;
      }
    }

    if (o_strnullempty(response_type)) {
      u_map_put(&map_redirect, "error", "invalid_request");
      u_map_put(&map_redirect, "error_description", "response_type missing");
      build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
      break;
    }

    if (!split_string(response_type, " ", &resp_type_array)) {
      y_log_message(Y_LOG_LEVEL_ERROR, "callback_oidc_authorization - Error split_string");
      u_map_put(&map_redirect, "error", "server_error");
      build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
      break;
    }

    has_code = string_array_has_value((const char **)resp_type_array, "code");
    has_token = string_array_has_value((const char **)resp_type_array, "token");
    has_id_token = string_array_has_value((const char **)resp_type_array, "id_token");
    has_none = string_array_has_value((const char **)resp_type_array, "none");

    if (request_par && json_object_get(json_object_get(j_request, "request"), "additional_parameters") != NULL) {
      json_object_foreach(json_object_get(json_object_get(j_request, "request"), "additional_parameters"), key, j_element) {
        u_map_put(&map_redirect, key, json_string_value(j_element));
      }
    }

    if (!has_code && !has_token && !has_id_token && !has_none) {
      u_map_put(&map_redirect, "error", "unsupported_response_type");
      build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
      break;
    }

    if (string_array_size(resp_type_array) == 1 && has_token && !config->allow_non_oidc) {
      u_map_put(&map_redirect, "error", "unsupported_response_type");
      build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
      break;
    }

    if (has_code) {
      auth_type |= GLEWLWYD_AUTHORIZATION_TYPE_AUTHORIZATION_CODE_FLAG;
    }

    if (has_token && config->allow_non_oidc) {
      auth_type |= GLEWLWYD_AUTHORIZATION_TYPE_TOKEN_FLAG;
    }

    if (has_id_token) {
      auth_type |= GLEWLWYD_AUTHORIZATION_TYPE_ID_TOKEN_FLAG;
    }

    if (has_none) {
      auth_type |= GLEWLWYD_AUTHORIZATION_TYPE_NONE_FLAG;
    }

    if (json_object_get(json_object_get(j_request, "request"), "claims") != NULL) {
      j_claims = json_incref(json_object_get(json_object_get(j_request, "request"), "claims"));
    } else if (!o_strnullempty(claims)) {
      j_claims = json_loads(claims, JSON_DECODE_ANY, NULL);
      if (j_claims == NULL) {
        y_log_message(Y_LOG_LEVEL_DEBUG, "oidc validate_endpoint_auth - error claims parameter not in JSON format, origin: %s", ip_source);
        u_map_put(&map_redirect, "error", "invalid_request");
        u_map_put(&map_redirect, "error_description", "claims parameter not in JSON format");
        build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
        break;
      }
    }

    j_client_checked = check_client_valid_without_secret(config, client_id, redirect_uri, (short unsigned int)auth_type, ip_source);
    if (!check_result_value(j_client_checked, G_OK)) {
      u_map_put(&map_redirect, "error", "unauthorized_client");
      u_map_put(&map_redirect, "error_description", json_string_value(json_object_get(j_client, "error_description")));
      build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
      break;
    }

    if (display != NULL) {
      u_map_put(&map_login, "display", display);
    }

    if (ui_locales != NULL) {
      u_map_put(&map_login, "ui_locales", ui_locales);
    }

    if (login_hint != NULL) {
      u_map_put(&map_login, "login_hint", login_hint);
    }

    if (j_claims != NULL && parse_claims_request(j_claims) != G_OK) {
      y_log_message(Y_LOG_LEVEL_DEBUG, "oidc validate_endpoint_auth - error parsing claims parameter, origin: %s", ip_source);
      u_map_put(&map_redirect, "error", "invalid_request");
      u_map_put(&map_redirect, "error_description", "claims parameter invalid format");
      build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
      break;
    }

    // Check code_challenge if necessary
    if (has_code) {
      if ((res = is_code_challenge_valid(config, scope, code_challenge, code_challenge_method, code_challenge_stored, (json_object_get(json_object_get(j_client, "client"), "confidential") == json_true()))) == G_ERROR_PARAM) {
        y_log_message(Y_LOG_LEVEL_DEBUG, "oidc validate_endpoint_auth - code challenge invalid");
        u_map_put(&map_redirect, "error", "invalid_request");
        build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
        break;
      } else if (res != G_OK) {
        y_log_message(Y_LOG_LEVEL_ERROR, "oidc validate_endpoint_auth - error is_code_challenge_valid");
        u_map_put(&map_redirect, "error", "server_error");
        build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
        break;
      }
    }

    if (j_authorization_details != NULL) {
      json_array_foreach(j_authorization_details, index, j_element) {
        if (rar_list == NULL) {
          rar_list = o_strdup(json_string_value(json_object_get(j_element, "type")));
        } else {
          rar_list = mstrcatf(rar_list, ",%s", json_string_value(json_object_get(j_element, "type")));
        }
      }
      u_map_put(&map_redirect, "authorization_details", rar_list);
      u_map_put(&map_redirect, "plugin", config->name);
      u_map_put(&map_login, "authorization_details", rar_list);
      u_map_put(&map_login, "plugin", config->name);
      o_free(rar_list);
    }

    if (!u_map_has_key(map, "g_continue") && (0 == o_strcmp("login", prompt) || 0 == o_strcmp("consent", prompt) || 0 == o_strcmp("select_account", prompt))) {
      // Redirect to login page
      u_map_put(&map_login, "prompt", prompt);
      redirect_url = get_login_url(config, request, "auth", client_id, scope, &map_login);
      response->status = 302;
      ulfius_add_header_to_response(response, "Location", redirect_url);
      o_free(redirect_url);
      break;
    }

    // Check if the query parameter 'g_continue' exists, otherwise redirect to login page
    if (!u_map_has_key(map, "g_continue") && 0 != o_strcmp("none", prompt)) {
      // Redirect to login page
      redirect_url = get_login_url(config, request, "auth", client_id, scope, &map_login);
      response->status = 302;
      ulfius_add_header_to_response(response, "Location", redirect_url);
      o_free(redirect_url);
      break;
    }

    // Check if at least one scope has been provided
    if (o_strnullempty(scope)) {
      response->status = 403;
      break;
    }

    if (!json_string_null_or_empty(json_object_get(config->j_params, "restrict-scope-client-property"))) {
      j_reduced_scope = reduce_scope(scope, json_object_get(json_object_get(j_client, "client"), json_string_value(json_object_get(config->j_params, "restrict-scope-client-property"))));
      if (check_result_value(j_reduced_scope, G_OK)) {
        scope_reduced = o_strdup(json_string_value(json_object_get(j_reduced_scope, "scope")));
      } else if (check_result_value(j_reduced_scope, G_ERROR_UNAUTHORIZED)) {
        y_log_message(Y_LOG_LEVEL_DEBUG, "oidc validate_endpoint_auth - error client %s is not allowed to claim scopes '%s'", client_id, scope);
        y_log_message(Y_LOG_LEVEL_WARNING, "Security - Authorization invalid for client_id %s at IP Address %s", client_id, ip_source);
        config->glewlwyd_config->glewlwyd_plugin_callback_metrics_increment_counter(config->glewlwyd_config, GLWD_METRICS_OIDC_UNAUTHORIZED_CLIENT, 1, "plugin", config->name, NULL);
        u_map_put(&map_redirect, "error", "invalid_scope");
        build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
        break;
      } else {
        y_log_message(Y_LOG_LEVEL_ERROR, "oidc validate_endpoint_auth - error reduce_scope");
        u_map_put(&map_redirect, "error", "server_error");
        build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
        break;
      }
    } else {
      scope_reduced = o_strdup(scope);
    }

    // Split scope list into scope array
    if (!split_string_remove_duplicates(scope_reduced, " ", &scope_list)) {
      y_log_message(Y_LOG_LEVEL_ERROR, "oidc validate_endpoint_auth - Error split_string_remove_duplicates");
      u_map_put(&map_redirect, "error", "server_error");
      build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
      break;
    }

    // Check that the scope 'openid' is provided, otherwise return error
    if ((!string_array_has_value((const char **)scope_list, "openid") &&
         !config->allow_non_oidc) ||
         (auth_type & GLEWLWYD_AUTHORIZATION_TYPE_ID_TOKEN_FLAG && !string_array_has_value((const char **)scope_list, "openid"))) {
      // Scope openid missing
      y_log_message(Y_LOG_LEVEL_DEBUG, "oidc validate_endpoint_auth - scope 'openid' missing, origin: %s", ip_source);
      u_map_put(&map_redirect, "error", "invalid_scope");
      build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
      break;
    }

    // Check that the session is valid for this user with this scope list
    j_session = validate_session_client_scope(config, request, client_id, scope_reduced);
    if (check_result_value(j_session, G_ERROR_NOT_FOUND)) {
      if (0 == o_strcmp("none", prompt)) {
        // Scope is not allowed for this user
        y_log_message(Y_LOG_LEVEL_DEBUG, "oidc validate_endpoint_auth - prompt 'none', avoid login page, origin: %s", ip_source);
        u_map_put(&map_redirect, "error", "interaction_required");
        build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
      } else {
        // Redirect to login page
        response->status = 302;
        redirect_url = get_login_url(config, request, "auth", client_id, scope_reduced, &map_login);
        ulfius_add_header_to_response(response, "Location", redirect_url);
        o_free(redirect_url);
      }
      break;
    } else if (check_result_value(j_session, G_ERROR_UNAUTHORIZED)) {
      if (0 == o_strcmp("none", prompt)) {
        // Scope is not allowed for this user
        y_log_message(Y_LOG_LEVEL_DEBUG, "oidc validate_endpoint_auth - prompt 'none', avoid login page, origin: %s", ip_source);
        u_map_put(&map_redirect, "error", "interaction_required");
        build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
      } else {
        if (json_object_get(json_object_get(j_session, "session"), "user") != NULL) {
          // Scope is not allowed for this user
          y_log_message(Y_LOG_LEVEL_DEBUG, "oidc validate_endpoint_auth - scope list '%s' is invalid for user '%s', origin: %s", scope, json_string_value(json_object_get(json_object_get(json_object_get(j_session, "session"), "user"), "username")), ip_source);
          u_map_put(&map_redirect, "error", "invalid_scope");
          build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
        } else {
          // Redirect to login page
          u_map_put(&map_login, "prompt", prompt);
          redirect_url = get_login_url(config, request, "auth", client_id, scope_reduced, &map_login);
          ulfius_add_header_to_response(response, "Location", redirect_url);
          o_free(redirect_url);
          response->status = 302;
        }
      }
      break;
    } else if (!check_result_value(j_session, G_OK)) {
      y_log_message(Y_LOG_LEVEL_ERROR, "oidc validate_endpoint_auth - Error validate_session_client_scope %s", json_dumps(j_session, JSON_ENCODE_ANY));
      u_map_put(&map_redirect, "error", "server_error");
      build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
      break;
    }

    // If parameter prompt=none is set, id_token_hint must be set and correspond to the last id_token provided by the client for the current user
    if (0 == o_strcmp("none", prompt)) {
      if (!o_strnullempty(id_token_hint)) {
        alg = get_token_sign_alg(config, json_object_get(j_client, "client"), GLEWLWYD_TOKEN_TYPE_ID_TOKEN);
        jwk_id_token = get_jwk_sign(config, json_object_get(j_client, "client"), alg);
        if ((jwt = r_jwt_quick_parse(id_token_hint, R_PARSE_NONE, 0)) != NULL &&
            r_jwt_verify_signature(jwt, jwk_id_token, 0) == RHN_OK) {
          j_last_token = get_last_id_token(config, json_string_value(json_object_get(json_object_get(json_object_get(j_session, "session"), "user"), "username")), client_id);
          if (check_result_value(j_last_token, G_OK)) {
            if ((id_token_hash = config->glewlwyd_config->glewlwyd_callback_generate_hash(config->glewlwyd_config, id_token_hint)) != NULL) {
              if (0 != o_strcmp(id_token_hash, json_string_value(json_object_get(json_object_get(j_last_token, "id_token"), "token_hash")))) {
                y_log_message(Y_LOG_LEVEL_DEBUG, "oidc validate_endpoint_auth - id_token_hint was not the last one provided to client '%s' for user '%s', origin: %s", client_id, json_string_value(json_object_get(json_object_get(json_object_get(j_session, "session"), "user"), "username")), ip_source);
                u_map_put(&map_redirect, "error", "invalid_request");
                u_map_put(&map_redirect, "error_description", "id_token invalid");
                build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
                break;
              }
            } else {
              y_log_message(Y_LOG_LEVEL_ERROR, "oidc validate_endpoint_auth - Error glewlwyd_callback_generate_hash");
              u_map_put(&map_redirect, "error", "server_error");
              build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
              break;
            }
          } else if (check_result_value(j_last_token, G_ERROR_NOT_FOUND)) {
            y_log_message(Y_LOG_LEVEL_DEBUG, "oidc validate_endpoint_auth - no id_token was provided to client '%s' for user '%s', origin: %s", client_id, json_string_value(json_object_get(json_object_get(json_object_get(j_session, "session"), "user"), "username")), ip_source);
            u_map_put(&map_redirect, "error", "invalid_request");
            u_map_put(&map_redirect, "error_description", "id_token mandatory");
            build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
            break;
          } else {
            y_log_message(Y_LOG_LEVEL_ERROR, "oidc validate_endpoint_auth - Error get_last_id_token");
            u_map_put(&map_redirect, "error", "server_error");
            build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
            break;
          }
        } else {
          y_log_message(Y_LOG_LEVEL_DEBUG, "oidc validate_endpoint_auth - id_token has invalid content or signature, origin: %s", ip_source);
          u_map_put(&map_redirect, "error", "invalid_request");
          u_map_put(&map_redirect, "error_description", "id_token invalid");
          build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
          break;
        }
      } else {
        y_log_message(Y_LOG_LEVEL_DEBUG, "oidc validate_endpoint_auth - no id_token provided in the request, origin: %s", ip_source);
        u_map_put(&map_redirect, "error", "invalid_request");
        u_map_put(&map_redirect, "error_description", "id_token mandatory");
        build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
        break;
      }
    }

    // Session may be valid but another level of authentication may be requested
    if (json_object_get(json_object_get(j_session, "session"), "authorization_required") == json_true()) {
      if (0 == o_strcmp("none", prompt)) {
        // Scope is not allowed for this user
        y_log_message(Y_LOG_LEVEL_DEBUG, "oidc validate_endpoint_auth - prompt 'none', avoid login page, origin: %s", ip_source);
        u_map_put(&map_redirect, "error", "interaction_required");
        build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
        break;
      } else {
        // Redirect to login page
        redirect_url = get_login_url(config, request, "auth", client_id, scope_reduced, &map_login);
        ulfius_add_header_to_response(response, "Location", redirect_url);
        o_free(redirect_url);
        response->status = 302;
      }
      break;
    }

    issued_for = get_client_hostname(request, config->glewlwyd_config->glewlwyd_config->originating_ip_header);
    if (issued_for == NULL) {
      y_log_message(Y_LOG_LEVEL_ERROR, "oidc validate_endpoint_auth - Error get_client_hostname");
      u_map_put(&map_redirect, "error", "interaction_required");
      build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
      break;
    }

    // Trigger the use of this session to reset use of some schemes
    if (config->glewlwyd_config->glewlwyd_callback_trigger_session_used(config->glewlwyd_config, request, json_string_value(json_object_get(json_object_get(j_session, "session"), "scope_filtered"))) != G_OK) {
      y_log_message(Y_LOG_LEVEL_ERROR, "oidc validate_endpoint_auth - Error glewlwyd_callback_trigger_session_used");
      u_map_put(&map_redirect, "error", "interaction_required");
      build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
      break;
    }

    // nonce parameter is required for some authorization types or when openid scope is granted
    if (((auth_type & GLEWLWYD_AUTHORIZATION_TYPE_ID_TOKEN_FLAG) || string_array_has_value((const char **)scope_list, "openid")) && o_strnullempty(nonce)) {
      y_log_message(Y_LOG_LEVEL_DEBUG, "oidc validate_endpoint_auth - nonce required, origin: %s", ip_source);
      u_map_put(&map_redirect, "error", "invalid_request");
      u_map_put(&map_redirect, "error_description", "nonce required");
      build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
      break;
    }

    if (j_authorization_details != NULL) {
      j_rar_filtered_result = authorization_details_filter(config, j_authorization_details, json_string_value(json_object_get(json_object_get(j_session, "session"), "scope_filtered")), json_object_get(j_client, "client"), json_object_get(json_object_get(j_session, "session"), "user"), ip_source);
      if (check_result_value(j_rar_filtered_result, G_ERROR_UNAUTHORIZED)) {
        y_log_message(Y_LOG_LEVEL_DEBUG, "oidc validate_endpoint_auth - authorization_details is invalid for client %s, origin: %s", client_id, ip_source);
        u_map_put(&map_redirect, "error", "invalid_request");
        u_map_put(&map_redirect, "error_description", "authorization_details is invalid for client");
        build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
        break;
      } else if (check_result_value(j_rar_filtered_result, G_OK)) {
        if (json_object_get(j_rar_filtered_result, "requires_consent") == json_true()) {
          // Redirect to login page
          u_map_put(&map_login, "prompt", "consent");
          redirect_url = get_login_url(config, request, "auth", client_id, scope_reduced, &map_login);
          ulfius_add_header_to_response(response, "Location", redirect_url);
          o_free(redirect_url);
          response->status = 302;
          break;
        }
      } else {
        y_log_message(Y_LOG_LEVEL_ERROR, "oidc validate_endpoint_auth - Error authorization_details_filter");
        u_map_put(&map_redirect, "error", "server_error");
        u_map_put(&map_redirect, "error_description", "authorization_details invalid");
        build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
        break;
      }
    }

    if (!o_strnullempty(max_age)) {
      l_max_age = strtol(max_age, &endptr, 10);
      if (!(*endptr) && l_max_age > 0) {
        time(&now);
        if (l_max_age < (now - (time_t)config->glewlwyd_config->glewlwyd_callback_get_session_age(config->glewlwyd_config, request, json_string_value(json_object_get(json_object_get(j_session, "session"), "scope_filtered"))))) {
          // Redirect to login page
          u_map_put(&map_login, "refresh_login", "true");
          redirect_url = get_login_url(config, request, "auth", client_id, scope_reduced, &map_login);
          ulfius_add_header_to_response(response, "Location", redirect_url);
          o_free(redirect_url);
          response->status = 302;
          break;
        }
      } else {
        y_log_message(Y_LOG_LEVEL_DEBUG, "oidc validate_endpoint_auth - max_age invalid, origin: %s", ip_source);
        u_map_put(&map_redirect, "error", "invalid_request");
        u_map_put(&map_redirect, "error_description", "max_age invalid");
        build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
        break;
      }
    }

    if (json_object_get(config->j_params, "session-management-allowed") == json_true()) {
      session_state = generate_session_state(client_id, redirect_uri, json_string_value(json_object_get(json_object_get(json_object_get(j_session, "session"), "user"), "username")));
      if (!o_strnullempty(session_state)) {
        u_map_put(&map_redirect, "session_state", session_state);
      }
      o_free(session_state);
    }

    if (!o_strnullempty(resource)) {
      count_resource = split_string(resource, ",", &resource_list);
      if (count_resource) {
        if (has_token && count_resource > 1) {
          y_log_message(Y_LOG_LEVEL_DEBUG, "Using multiple resource parameters with the response_type token is forbidden");
          u_map_put(&map_redirect, "error", "invalid_target");
          u_map_put(&map_redirect, "error_description", "Invalid Resource");
          build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
          break;
        }
        for (index = 0; resource_list[index] != NULL && !resource_error; index++) {
          if ((res = verify_resource(config, resource_list[index], json_object_get(j_client, "client"), json_string_value(json_object_get(json_object_get(j_session, "session"), "scope_filtered")))) == G_ERROR_PARAM) {
            u_map_put(&map_redirect, "error", "invalid_target");
            u_map_put(&map_redirect, "error_description", "Invalid Resource");
            build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
            resource_error = 1;
          } else if (res != G_OK) {
            y_log_message(Y_LOG_LEVEL_ERROR, "callback_oidc_authorization - Error verify_resource");
            u_map_put(&map_redirect, "error", "server_error");
            build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
            resource_error = 1;
          }
        }
        if (resource_error) {
          break;
        }
      } else {
        y_log_message(Y_LOG_LEVEL_ERROR, "callback_oidc_authorization - Error split_string resource");
        u_map_put(&map_redirect, "error", "server_error");
        build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
        break;
      }
    }

    if (json_object_get(config->j_params, "oauth-fapi-add-s_hash") == json_true()) {
      s_hash = generate_x_hash(config, json_object_get(j_client, "client"), state);
    }

    if (get_session_token(config, request, response, sid) != G_OK) {
      y_log_message(Y_LOG_LEVEL_ERROR, "callback_oidc_authorization - Error get_session_token");
      u_map_put(&map_redirect, "error", "server_error");
      build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
      break;
    }

    if (has_code) {
      if (is_authorization_type_enabled((struct _oidc_config *)user_data, GLEWLWYD_AUTHORIZATION_TYPE_AUTHORIZATION_CODE) && redirect_uri != NULL) {
        // Generates authorization code
        j_authorization_code = generate_authorization_code(config,
                                                           json_string_value(json_object_get(json_object_get(json_object_get(j_session, "session"), "user"), "username")),
                                                           client_id,
                                                           json_string_value(json_object_get(json_object_get(j_session, "session"), "scope_filtered")),
                                                           redirect_uri,
                                                           issued_for,
                                                           u_map_get_case(request->map_header, "user-agent"),
                                                           nonce,
                                                           resource,
                                                           json_object_get(json_object_get(j_session, "session"), "amr"),
                                                           j_claims,
                                                           auth_type,
                                                           code_challenge_stored,
                                                           json_object_get(j_rar_filtered_result, "authorization_details"),
                                                           s_hash,
                                                           sid,
                                                           dpop_jkt);
        if (check_result_value(j_authorization_code, G_OK)) {
          authorization_code = json_string_value(json_object_get(j_authorization_code, "code"));
          if ((authorization_code_out = encrypt_token_if_required(config, authorization_code, json_object_get(j_client, "client"), GLEWLWYD_TOKEN_TYPE_CODE, &enc_res)) != NULL) {
            u_map_put(&map_redirect, "code", authorization_code_out);
          } else if (enc_res == G_ERROR_UNAUTHORIZED) {
            u_map_put(&map_redirect, "error", "invalid_request");
            u_map_put(&map_redirect, "error_description", "Invalid encryption parameters");
            build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
            break;
          } else {
            y_log_message(Y_LOG_LEVEL_ERROR, "oidc check_auth_type_auth_code_grant - encrypt_token_if_required for code");
            u_map_put(&map_redirect, "error", "server_error");
            build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
            break;
          }
          o_free(authorization_code_out);
          config->glewlwyd_config->glewlwyd_plugin_callback_metrics_increment_counter(config->glewlwyd_config, GLWD_METRICS_OIDC_CODE, 1, "plugin", config->name, NULL);
        } else {
          y_log_message(Y_LOG_LEVEL_ERROR, "oidc check_auth_type_auth_code_grant - Error generate_authorization_code");
          u_map_put(&map_redirect, "error", "server_error");
          build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
        }
      } else {
        u_map_put(&map_redirect, "error", "unsupported_response_type");
        build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
        break;
      }
    }

    if (has_token) {
      if (is_authorization_type_enabled((struct _oidc_config *)user_data, GLEWLWYD_AUTHORIZATION_TYPE_TOKEN) && redirect_uri != NULL) {
        j_authorization_details_processed = authorization_details_process_resource(json_object_get(j_rar_filtered_result, "authorization_details"), resource, 1);
        if ((access_token = generate_access_token(config,
                                                  json_string_value(json_object_get(json_object_get(json_object_get(j_session, "session"), "user"), "username")),
                                                  json_object_get(j_client, "client"),
                                                  json_object_get(json_object_get(j_session, "session"), "user"),
                                                  json_string_value(json_object_get(json_object_get(j_session, "session"), "scope_filtered")),
                                                  json_object_get(j_claims, "userinfo"),
                                                  resource,
                                                  now,
                                                  jti,
                                                  NULL,
                                                  NULL,
                                                  j_authorization_details_processed,
                                                  get_ip_source(request, config->glewlwyd_config->glewlwyd_config->originating_ip_header))) != NULL) {
          if (serialize_access_token(config,
                                     (unsigned int)auth_type,
                                     0,
                                     json_string_value(json_object_get(json_object_get(json_object_get(j_session, "session"), "user"), "username")),
                                     client_id,
                                     json_string_value(json_object_get(json_object_get(j_session, "session"), "scope_filtered")),
                                     resource,
                                     now,
                                     issued_for,
                                     u_map_get_case(request->map_header, "user-agent"),
                                     access_token,
                                     jti,
                                     j_authorization_details_processed) != G_OK) {
            y_log_message(Y_LOG_LEVEL_ERROR, "oidc check_auth_type_implicit_grant - Error serialize_access_token");
            u_map_put(&map_redirect, "error", "server_error");
            build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
            break;
          } else {
            if ((access_token_out = encrypt_token_if_required(config, access_token, json_object_get(j_client, "client"), GLEWLWYD_TOKEN_TYPE_ACCESS_TOKEN, &enc_res)) != NULL) {
              expires_in_str = msprintf("%" JSON_INTEGER_FORMAT, config->access_token_duration);
              iat_str = msprintf("%ld", now);
              u_map_put(&map_redirect, "access_token", access_token_out);
              u_map_put(&map_redirect, "token_type", "bearer");
              u_map_put(&map_redirect, "expires_in", expires_in_str);
              u_map_put(&map_redirect, "iat", iat_str);
              u_map_put(&map_redirect, "scope", json_string_value(json_object_get(json_object_get(j_session, "session"), "scope_filtered")));
              o_free(expires_in_str);
              o_free(iat_str);
            } else if (enc_res == G_ERROR_UNAUTHORIZED) {
              u_map_put(&map_redirect, "error", "invalid_request");
              u_map_put(&map_redirect, "error_description", "Invalid encryption parameters");
              build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
              break;
            } else {
              u_map_put(&map_redirect, "error", "server_error");
              build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
              break;
            }
            o_free(access_token_out);
            config->glewlwyd_config->glewlwyd_plugin_callback_metrics_increment_counter(config->glewlwyd_config, GLWD_METRICS_OIDC_USER_ACCESS_TOKEN, 1, "plugin", config->name, NULL);
          }
        } else {
          y_log_message(Y_LOG_LEVEL_ERROR, "oidc check_auth_type_implicit_grant - Error generate_access_token");
          u_map_put(&map_redirect, "error", "server_error");
          build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
          break;
        }
      } else {
        u_map_put(&map_redirect, "error", "unsupported_response_type");
        build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
        break;
      }
    }

    if (has_id_token) {
      if (is_authorization_type_enabled((struct _oidc_config *)user_data, GLEWLWYD_AUTHORIZATION_TYPE_ID_TOKEN) && redirect_uri != NULL) {
        if ((id_token = generate_id_token(config,
                                          json_string_value(json_object_get(json_object_get(json_object_get(j_session, "session"), "user"), "username")),
                                          json_object_get(json_object_get(j_session, "session"), "user"),
                                          json_object_get(j_client, "client"),
                                          now,
                                          config->glewlwyd_config->glewlwyd_callback_get_session_age(config->glewlwyd_config,
                                                                                                     request,
                                                                                                     json_string_value(json_object_get(json_object_get(j_session, "session"), "scope_filtered"))),
                                          nonce,
                                          json_object_get(json_object_get(j_session, "session"), "amr"),
                                          access_token,
                                          authorization_code,
                                          json_string_value(json_object_get(json_object_get(j_session, "session"), "scope_filtered")),
                                          json_object_get(j_claims, "id_token"),
                                          NULL,
                                          NULL,
                                          s_hash,
                                          sid,
                                          ip_source)) != NULL) {
          if (serialize_id_token(config,
                                 GLEWLWYD_AUTHORIZATION_TYPE_AUTHORIZATION_CODE,
                                 id_token,
                                 json_string_value(json_object_get(json_object_get(json_object_get(j_session, "session"), "user"), "username")),
                                 client_id,
                                 sid,
                                 json_integer_value(json_object_get(j_authorization_code, "gpoc_id")),
                                 0,
                                 now,
                                 issued_for,
                                 u_map_get_case(request->map_header, "user-agent")) != G_OK) {
            y_log_message(Y_LOG_LEVEL_ERROR, "oidc check_auth_type_access_token_request - Error serialize_id_token");
            u_map_put(&map_redirect, "error", "server_error");
            build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
            break;
          } else {
            if ((id_token_out = encrypt_token_if_required(config, id_token, json_object_get(j_client, "client"), GLEWLWYD_TOKEN_TYPE_ID_TOKEN, &enc_res)) != NULL) {
              u_map_put(&map_redirect, "id_token", id_token_out);
            } else if (enc_res == G_ERROR_UNAUTHORIZED) {
              u_map_put(&map_redirect, "error", "invalid_request");
              u_map_put(&map_redirect, "error_description", "Invalid encryption parameters");
              build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
              break;
            } else {
              u_map_put(&map_redirect, "error", "server_error");
              build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
              break;
            }
            o_free(id_token_out);
            config->glewlwyd_config->glewlwyd_plugin_callback_metrics_increment_counter(config->glewlwyd_config, GLWD_METRICS_OIDC_ID_TOKEN, 1, "plugin", config->name, "response_type", response_type, NULL);
            config->glewlwyd_config->glewlwyd_plugin_callback_metrics_increment_counter(config->glewlwyd_config, GLWD_METRICS_OIDC_ID_TOKEN, 1, "plugin", config->name, NULL);
          }
        } else {
          y_log_message(Y_LOG_LEVEL_ERROR, "oidc check_auth_type_access_token_request - Error generate_id_token");
          u_map_put(&map_redirect, "error", "server_error");
          build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
          break;
        }
      } else {
        u_map_put(&map_redirect, "error", "unsupported_response_type");
        build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
        break;
      }
    }

    if (has_none) {
      if (!is_authorization_type_enabled((struct _oidc_config *)user_data, GLEWLWYD_AUTHORIZATION_TYPE_NONE)) {
        u_map_put(&map_redirect, "error", "unsupported_response_type");
        build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
        break;
      }
    }

    // Redirect to redirect_uri with results
    build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);

    if (request_par) {
      if (complete_pushed_authorization_request(config, json_integer_value(json_object_get(json_object_get(j_request, "request"), "gpop_id")), json_string_value(json_object_get(json_object_get(json_object_get(j_session, "session"), "user"), "username"))) != G_OK) {
        y_log_message(Y_LOG_LEVEL_ERROR, "callback_oidc_authorization - Error complete_pushed_authorization_request");
        u_map_put(&map_redirect, "error", "server_error");
        build_auth_response(config, response, response_mode, json_object_get(j_client, "client"), redirect_uri, &map_redirect);
        break;
      }
    }
  } while (0);

  o_free(access_token);
  o_free(id_token);
  o_free(scope_reduced);
  o_free(issued_for);
  o_free(id_token_hash);
  o_free(s_hash);
  free_string_array(resp_type_array);
  free_string_array(scope_list);
  free_string_array(resource_list);
  u_map_clean(&map_redirect);
  u_map_clean(&map_login);
  json_decref(j_request);
  json_decref(j_client);
  json_decref(j_client_checked);
  json_decref(j_authorization_details);
  json_decref(j_authorization_details_processed);
  json_decref(j_claims);
  json_decref(j_session);
  json_decref(j_reduced_scope);
  json_decref(j_last_token);
  json_decref(j_rar_filtered_result);
  json_decref(j_authorization_code);
  r_jwt_free(jwt);
  r_jwk_free(jwk_id_token);

  return U_CALLBACK_CONTINUE;
}
