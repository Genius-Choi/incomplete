bool fastly_compute_at_edge_cache_transaction_insert(
    fastly_compute_at_edge_cache_handle_t handle,
    fastly_compute_at_edge_cache_write_options_t *options,
    fastly_compute_at_edge_cache_body_handle_t *ret, fastly_compute_at_edge_cache_error_t *err) {
  uint16_t options_mask = 0;
  fastly::CacheWriteOptions opts;
  std::memset(&opts, 0, sizeof(opts));
  opts.max_age_ns = options->max_age_ns;

  if (options->request_headers != INVALID_HANDLE && options->request_headers != 0) {
    options_mask |= FASTLY_CACHE_WRITE_OPTIONS_MASK_REQUEST_HEADERS;
    opts.request_headers = options->request_headers;
  }
  if (options->vary_rule.len > 0) {
    options_mask |= FASTLY_CACHE_WRITE_OPTIONS_MASK_VARY_RULE;
    opts.vary_rule_len = options->vary_rule.len;
    opts.vary_rule_ptr = reinterpret_cast<uint8_t *>(options->vary_rule.ptr);
  }
  if (options->initial_age_ns != 0) {
    options_mask |= FASTLY_CACHE_WRITE_OPTIONS_MASK_INITIAL_AGE_NS;
    opts.initial_age_ns = options->initial_age_ns;
  }
  if (options->stale_while_revalidate_ns != 0) {
    options_mask |= FASTLY_CACHE_WRITE_OPTIONS_MASK_STALE_WHILE_REVALIDATE_NS;
    opts.stale_while_revalidate_ns = options->stale_while_revalidate_ns;
  }
  if (options->surrogate_keys.ptr != nullptr) {
    options_mask |= FASTLY_CACHE_WRITE_OPTIONS_MASK_SURROGATE_KEYS;
    opts.surrogate_keys_len = options->surrogate_keys.len;
    opts.surrogate_keys_ptr = reinterpret_cast<uint8_t *>(options->surrogate_keys.ptr);
  }
  if (options->length != 0) {
    options_mask |= FASTLY_CACHE_WRITE_OPTIONS_MASK_LENGTH;
    opts.length = options->length;
  }
  if (options->user_metadata.ptr != nullptr) {
    options_mask |= FASTLY_CACHE_WRITE_OPTIONS_MASK_USER_METADATA;
    opts.user_metadata_len = options->user_metadata.len;
    opts.user_metadata_ptr = options->user_metadata.ptr;
  }
  if (options->sensitive_data) {
    options_mask |= FASTLY_CACHE_WRITE_OPTIONS_MASK_SENSITIVE_DATA;
  }
  return convert_result(fastly::cache_transaction_insert(handle, options_mask, &opts, ret), err);
}
