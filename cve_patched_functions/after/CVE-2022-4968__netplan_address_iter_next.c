_netplan_address_iter_next(struct address_iter* it)
{
    NetplanAddressOptions* options = NULL;

    if (it->last_address) {
        free_address_options(it->last_address);
        it->last_address = NULL;
    }

    if (it->netdef->ip4_addresses && it->ip4_index < it->netdef->ip4_addresses->len) {
        options = g_malloc0(sizeof(NetplanAddressOptions));
        options->address = g_strdup(g_array_index(it->netdef->ip4_addresses, char*, it->ip4_index++));
        it->last_address = options;
        return options;
    }

    if (it->netdef->ip6_addresses && it->ip6_index < it->netdef->ip6_addresses->len) {
        options = g_malloc0(sizeof(NetplanAddressOptions));
        options->address = g_strdup(g_array_index(it->netdef->ip6_addresses, char*, it->ip6_index++));
        it->last_address = options;
        return options;
    }

    if (it->netdef->address_options && it->address_options_index < it->netdef->address_options->len) {
        options = g_malloc0(sizeof(NetplanAddressOptions));
        NetplanAddressOptions* netdef_options = g_array_index(it->netdef->address_options, NetplanAddressOptions*, it->address_options_index++);
        options->address = g_strdup(netdef_options->address);
        options->lifetime = g_strdup(netdef_options->lifetime);
        options->label = g_strdup(netdef_options->label);
        it->last_address = options;
        return options;
    }

    return options;
}
