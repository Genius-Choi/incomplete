static json_t * get_ciba_requests_for_user(struct _oidc_config * config, const char * username) {
  json_t * j_query, * j_result, * j_result_scope, * j_return, * j_element = NULL, * j_scope = NULL, * j_client;
  int res;
  char * expires_at_clause;
  time_t now;
  size_t index = 0, index_scope = 0;
  char * external_url = config->glewlwyd_config->glewlwyd_callback_get_plugin_external_url(config->glewlwyd_config, config->name);


  time(&now);
  if (config->glewlwyd_config->glewlwyd_config->conn->type==HOEL_DB_TYPE_MARIADB) {
    expires_at_clause = msprintf("> FROM_UNIXTIME(%u)", (now));
  } else if (config->glewlwyd_config->glewlwyd_config->conn->type==HOEL_DB_TYPE_PGSQL) {
    expires_at_clause = msprintf("> TO_TIMESTAMP(%u)", now);
  } else { // HOEL_DB_TYPE_SQLITE
    expires_at_clause = msprintf("> %u", (now));
  }
  j_query = json_pack("{sss[ssss]s{sssssis{ssss}si}ss}",
                      "table", GLEWLWYD_PLUGIN_OIDC_TABLE_CIBA,
                      "columns",
                        "gpob_id",
                        "gpob_client_id AS client_id",
                        "gpob_user_req_id AS user_req_id",
                        "gpob_binding_message AS binding_message",
                      "where",
                        "gpob_plugin_name", config->name,
                        "gpob_username", username,
                        "gpob_status", 0,
                        "gpob_expires_at",
                          "operator", "raw",
                          "value", expires_at_clause,
                        "gpob_enabled", 1,
                      "order_by",
                      "gpob_id DESC");
  o_free(expires_at_clause);
  res = h_select(config->glewlwyd_config->glewlwyd_config->conn, j_query, &j_result, NULL);
  json_decref(j_query);
  if (res == H_OK) {
    json_array_foreach(j_result, index, j_element) {
      json_object_set_new(j_element, "scopes", json_array());
      j_query = json_pack("{sss[s]s{sO}}",
                          "table", GLEWLWYD_PLUGIN_OIDC_TABLE_CIBA_SCOPE,
                          "columns",
                            "gpops_scope AS scope",
                          "where",
                            "gpob_id", json_object_get(j_element, "gpob_id"));
      res = h_select(config->glewlwyd_config->glewlwyd_config->conn, j_query, &j_result_scope, NULL);
      json_decref(j_query);
      if (res == H_OK) {
        json_array_foreach(j_result_scope, index_scope, j_scope) {
          json_array_append(json_object_get(j_element, "scopes"), json_object_get(j_scope, "scope"));
        }
        json_decref(j_result_scope);
      } else {
        y_log_message(Y_LOG_LEVEL_ERROR, "get_ciba_requests_for_user - Error executing j_query (2) at index %zu", index);
      }
      json_object_del(j_element, "gpob_id");
      j_client = config->glewlwyd_config->glewlwyd_plugin_callback_get_client(config->glewlwyd_config, json_string_value(json_object_get(j_element, "client_id")));
      if (check_result_value(j_client, G_OK) && json_object_get(json_object_get(j_client, "client"), "enabled") == json_true()) {
        json_object_set(j_element, "client_name", json_object_get(json_object_get(j_client, "client"), "name"));
        json_object_set(j_element, "client_description", json_object_get(json_object_get(j_client, "client"), "description"));
      } else {
        y_log_message(Y_LOG_LEVEL_ERROR, "get_ciba_requests_for_user - Error glewlwyd_plugin_callback_get_client '%s'", json_string_value(json_object_get(j_element, "client_id")));
      }
      json_decref(j_client);
      json_object_set_new(j_element, "connect_uri", json_pack("s++", external_url, "/ciba_user_check?user_req_id=", json_string_value(json_object_get(j_element, "user_req_id"))));
      json_object_set_new(j_element, "cancel_uri", json_pack("s+++", external_url, "/ciba_user_check?user_req_id=", json_string_value(json_object_get(j_element, "user_req_id")), "&cancel"));
    }
    j_return = json_pack("{siso}", "result", G_OK, "ciba", j_result);
  } else {
    y_log_message(Y_LOG_LEVEL_ERROR, "get_ciba_requests_for_user - Error executing j_query (1)");
    j_return = json_pack("{si}", "result", G_ERROR_DB);
  }
  o_free(external_url);
  return j_return;
}
