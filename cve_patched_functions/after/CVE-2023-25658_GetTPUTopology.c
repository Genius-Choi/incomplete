tpu::TopologyProto GetTPUTopology() {
  const tpu::TpuTopologyExternal& topology =
      tpu::TpuPlatformInterface::GetRegisteredPlatform()->topology();

  tpu::TopologyProto topology_proto;
  topology_proto.set_num_tasks(topology.HostCount());
  topology_proto.set_num_tpu_devices_per_task(
      topology.LogicalDevicesPerHost(TpuCoreTypeEnum::kTensorCore));

  // mesh shape.
  int devices_per_chip =
      topology.LogicalDevicesPerChip(TpuCoreTypeEnum::kTensorCore);
  topology_proto.add_mesh_shape(topology.chip_bounds().x);
  topology_proto.add_mesh_shape(topology.chip_bounds().y);
  topology_proto.add_mesh_shape(topology.chip_bounds().z);
  topology_proto.add_mesh_shape(devices_per_chip);

  // device coordinates.
  for (const tpu::TpuCoreLocationExternal& core :
       topology.cores(TpuCoreTypeEnum::kTensorCore)) {
    const tpu::TpuDimensionsExternal coords = core.chip_coordinates();
    topology_proto.add_device_coordinates(coords.x);
    topology_proto.add_device_coordinates(coords.y);
    topology_proto.add_device_coordinates(coords.z);
    topology_proto.add_device_coordinates(core.index());
  }

  return topology_proto;
}
