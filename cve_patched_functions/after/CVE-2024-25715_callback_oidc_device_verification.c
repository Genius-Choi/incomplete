static int callback_oidc_device_verification(const struct _u_request * request, struct _u_response * response, void * user_data) {
  struct _oidc_config * config = (struct _oidc_config *)user_data;
  char * redirect_url = NULL, sid[OIDC_SID_LENGTH+1] = {0};
  struct _u_map param;
  json_t * j_result, * j_session;

  if (get_session_token(config, request, response, sid) == G_OK) {
    if (o_strnullempty(u_map_get(request->map_url, "code"))) {
      if (u_map_init(&param) == U_OK) {
        u_map_put(&param, "prompt", "device");
        response->status = 302;
        redirect_url = get_login_url(config, request, "device", NULL, NULL, &param);
        ulfius_add_header_to_response(response, "Location", redirect_url);
        o_free(redirect_url);
        u_map_clean(&param);
      } else {
        y_log_message(Y_LOG_LEVEL_ERROR, "callback_oidc_device_verification - Error u_map_init");
        response->status = 500;
      }
    } else if (o_strlen(u_map_get(request->map_url, "code")) != (GLEWLWYD_DEVICE_AUTH_USER_CODE_LENGTH+1)) {
      if (u_map_init(&param) == U_OK) {
        y_log_message(Y_LOG_LEVEL_WARNING, "Security - Code invalid at IP Address %s", get_ip_source(request, config->glewlwyd_config->glewlwyd_config->originating_ip_header));
        u_map_put(&param, "prompt", "deviceCodeError");
        response->status = 302;
        redirect_url = get_login_url(config, request, "device", NULL, NULL, &param);
        ulfius_add_header_to_response(response, "Location", redirect_url);
        o_free(redirect_url);
        u_map_clean(&param);
        config->glewlwyd_config->glewlwyd_plugin_callback_metrics_increment_counter(config->glewlwyd_config, GLWD_METRICS_OIDC_INVALID_DEVICE_CODE, 1, "plugin", config->name, NULL);
      } else {
        y_log_message(Y_LOG_LEVEL_ERROR, "callback_oidc_device_verification - Error u_map_init");
        response->status = 500;
      }
    } else {
      if (u_map_init(&param) == U_OK) {
        j_result = validate_device_auth_user_code(config, u_map_get(request->map_url, "code"));
        if (check_result_value(j_result, G_OK)) {
          if (u_map_has_key(request->map_url, "g_continue")) {
            j_session = validate_session_client_scope(config, request, json_string_value(json_object_get(json_object_get(j_result, "device_auth"), "client_id")), json_string_value(json_object_get(json_object_get(j_result, "device_auth"), "scope")));
            if (check_result_value(j_session, G_OK)) {
              if (validate_device_authorization_scope(config,
                                                      json_integer_value(json_object_get(json_object_get(j_result, "device_auth"), "gpoda_id")),
                                                      json_string_value(json_object_get(json_object_get(json_object_get(j_session, "session"), "user"), "username")),
                                                      json_string_value(json_object_get(json_object_get(j_session, "session"), "scope_filtered")),
                                                      json_object_get(json_object_get(j_session, "session"), "amr"),
                                                      sid) == G_OK) {
                u_map_put(&param, "prompt", "deviceComplete");
                response->status = 302;
                redirect_url = get_login_url(config, request, "device", NULL, NULL, &param);
                ulfius_add_header_to_response(response, "Location", redirect_url);
                o_free(redirect_url);
              } else {
                y_log_message(Y_LOG_LEVEL_ERROR, "callback_oidc_device_verification - Error validate_device_authorization_scope");
                u_map_put(&param, "prompt", "deviceServerError");
                response->status = 302;
                redirect_url = get_login_url(config, request, "device", NULL, NULL, &param);
                ulfius_add_header_to_response(response, "Location", redirect_url);
                o_free(redirect_url);
              }
            } else if (check_result_value(j_session, G_ERROR_NOT_FOUND) || check_result_value(j_session, G_ERROR_UNAUTHORIZED)) {
              // Redirect to login page
              response->status = 302;
              redirect_url = get_login_url(config, request, "device", json_string_value(json_object_get(json_object_get(j_result, "device_auth"), "client_id")), json_string_value(json_object_get(json_object_get(j_result, "device_auth"), "scope")), NULL);
              ulfius_add_header_to_response(response, "Location", redirect_url);
              o_free(redirect_url);
            } else {
              y_log_message(Y_LOG_LEVEL_ERROR, "callback_oidc_device_verification - Error validate_session_client_scope");
              u_map_put(&param, "prompt", "deviceServerError");
              response->status = 302;
              redirect_url = get_login_url(config, request, "device", NULL, NULL, &param);
              ulfius_add_header_to_response(response, "Location", redirect_url);
              o_free(redirect_url);
            }
            json_decref(j_session);
          } else {
            // Redirect to login page
            response->status = 302;
            redirect_url = get_login_url(config, request, "device", json_string_value(json_object_get(json_object_get(j_result, "device_auth"), "client_id")), json_string_value(json_object_get(json_object_get(j_result, "device_auth"), "scope")), NULL);
            ulfius_add_header_to_response(response, "Location", redirect_url);
            o_free(redirect_url);
          }
        } else if (check_result_value(j_result, G_ERROR_NOT_FOUND)) {
          y_log_message(Y_LOG_LEVEL_WARNING, "Security - Code invalid at IP Address %s", get_ip_source(request, config->glewlwyd_config->glewlwyd_config->originating_ip_header));
          u_map_put(&param, "prompt", "deviceCodeError");
          response->status = 302;
          redirect_url = get_login_url(config, request, "device", NULL, NULL, &param);
          ulfius_add_header_to_response(response, "Location", redirect_url);
          o_free(redirect_url);
          config->glewlwyd_config->glewlwyd_plugin_callback_metrics_increment_counter(config->glewlwyd_config, GLWD_METRICS_OIDC_INVALID_DEVICE_CODE, 1, "plugin", config->name, NULL);
        } else {
          y_log_message(Y_LOG_LEVEL_ERROR, "callback_oidc_device_verification - Error validate_device_auth_user_code");
          u_map_put(&param, "prompt", "deviceServerError");
          response->status = 302;
          redirect_url = get_login_url(config, request, "device", NULL, NULL, &param);
          ulfius_add_header_to_response(response, "Location", redirect_url);
          o_free(redirect_url);
        }
        json_decref(j_result);
        u_map_clean(&param);
      } else {
        y_log_message(Y_LOG_LEVEL_ERROR, "callback_oidc_device_verification - Error u_map_init");
        response->status = 500;
      }
    }
  } else {
    y_log_message(Y_LOG_LEVEL_ERROR, "callback_oidc_device_verification - Error get_session_token");
    response->status = 500;
  }

  return U_CALLBACK_CONTINUE;
}
