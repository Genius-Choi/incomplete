static int do_binauth(
	struct MHD_Connection *connection,
	const char *binauth,
	t_client *client,
	int *seconds_ret,
	unsigned long long int *upload_rate_ret,
	unsigned long long int *download_rate_ret,
	unsigned long long int *upload_quota_ret,
	unsigned long long int *download_quota_ret,
	const char *redirect_url
	)
{

	char *redirect_url_enc_buf;
	const char *custom;
	char *custom_enc;
	char *msg;
	char *argv = NULL;
	const char *user_agent;
	char *enc_user_agent;
	int seconds;
	unsigned long long int upload_rate;
	unsigned long long int download_rate;
	unsigned long long int upload_quota;
	unsigned long long int download_quota;
	int rc =1;

	// Get the client user agent
	user_agent = safe_calloc(USER_AGENT);

	MHD_get_connection_values(connection, MHD_HEADER_KIND, get_user_agent_callback, &user_agent);

	if (user_agent == NULL) {
		return send_error(connection, 403);
	}

	debug(LOG_DEBUG, "BinAuth: User Agent is [ %s ]", user_agent);

	// Get custom data string as passed in the query string
	custom = safe_calloc(CUSTOM);

	custom = MHD_lookup_connection_value(connection, MHD_GET_ARGUMENT_KIND, "custom");

	if (!custom || strlen(custom) == 0) {
		custom="bmE=";
	}

	custom_enc = safe_calloc(CUSTOM_ENC);
	uh_urlencode(custom_enc, CUSTOM_ENC, custom, strlen(custom));

	debug(LOG_DEBUG, "BinAuth: custom data [ %s ]", custom_enc);

	redirect_url_enc_buf = safe_calloc(REDIRECT_URL_ENC_BUF);
	uh_urlencode(redirect_url_enc_buf, REDIRECT_URL_ENC_BUF, redirect_url, strlen(redirect_url));

	debug(LOG_DEBUG, "BinAuth: Redirect URL is [ %s ]", redirect_url_enc_buf);

	enc_user_agent = safe_calloc(ENC_USER_AGENT);
	uh_urlencode(enc_user_agent, ENC_USER_AGENT, user_agent, strlen(user_agent));

	debug(LOG_DEBUG, "BinAuth: User Agent is [ %s ]", enc_user_agent);

	// Note: username, password and user_agent may contain spaces so argument should be quoted
	argv = safe_calloc(REDIRECT_URL_ENC_BUF + CUSTOM_ENC);
	safe_asprintf(&argv,"%s auth_client '%s' '%s' '%s' '%s' '%s' '%s'",
		binauth,
		client->mac,
		redirect_url_enc_buf,
		enc_user_agent,
		client->ip,
		client->token,
		custom_enc
	);

	debug(LOG_DEBUG, "BinAuth argv: %s", argv);

	// ndsctl will deadlock if run within the BinAuth script so lock it
	msg = safe_calloc(SMALL_BUF);

	if(ndsctl_lock() == 0) {
		// execute the script
		rc = execute_ret_url_encoded(msg, SMALL_BUF, argv);
		debug(LOG_DEBUG, "BinAuth returned arguments: %s", msg);

		// unlock ndsctl
		ndsctl_unlock();
	}

	free(custom_enc);
	free(redirect_url_enc_buf);
	free(enc_user_agent);
	free(argv);


	if (rc != 0) {
		debug(LOG_DEBUG, "BinAuth script failed to execute");
		free(msg);
		return 0;
	}

	rc = sscanf(msg, "%d %llu %llu %llu %llu", &seconds, &upload_rate, &download_rate, &upload_quota, &download_quota);
	debug(LOG_DEBUG, "BinAuth returned session length: %d", seconds);
	free(msg);

	// store assigned parameters
	switch (rc) {
		case 5:
			*download_quota_ret = MAX(download_quota, 0);
		case 4:
			*upload_quota_ret = MAX(upload_quota, 0);
		case 3:
			*download_rate_ret = MAX(download_rate, 0);
		case 2:
			*upload_rate_ret = MAX(upload_rate, 0);
		case 1:
			*seconds_ret = MAX(seconds, 0);
		case 0:
			break;
		default:
			return -1;
	}

	return 0;
}
