IndexSet * IMAPSession::capability(ErrorCode * pError)
{
    int r;
    struct mailimap_capability_data * cap;
    
    connectIfNeeded(pError);
    if (* pError != ErrorNone)
        return NULL;
    
    r = mailimap_capability(mImap, &cap);
    if (r == MAILIMAP_ERROR_STREAM) {
        mShouldDisconnect = true;
        * pError = ErrorConnection;
        return NULL;
    }
    else if (r == MAILIMAP_ERROR_PARSE) {
        mShouldDisconnect = true;
        * pError = ErrorParse;
        return NULL;
    }
    else if (hasError(r)) {
        * pError = ErrorCapability;
        return NULL;
    }
    
    mailimap_capability_data_free(cap);
    
    IndexSet * result = new IndexSet();
    capabilitySetWithSessionState(result);
    
    * pError = ErrorNone;
    result->autorelease();
    return result;
}
