EVP_PKEY* generate_dh_key(int type)
{
    EVP_PKEY* keys = nullptr;
    EVP_PKEY* params = EVP_PKEY_new();
    EVP_PKEY_CTX* context = nullptr;

    if(params != nullptr)
    {
        DH* dh = nullptr;

        switch(type)
        {
            case EVP_PKEY_DH:
                dh = DH_get_2048_256();
                break;
        };

        if(dh != nullptr)
        {
            int ret = EVP_PKEY_set1_DH(params, dh);

            if(ret)
            {
                if((context = EVP_PKEY_CTX_new(params, NULL)) != nullptr)
                {
                    if(EVP_PKEY_keygen_init(context))
                    {
                        if(!EVP_PKEY_keygen(context, &keys))
                            logError(AUTHENTICATION, "Cannot generate EVP key");
                    }
                    else
                        logError(AUTHENTICATION, "Cannot init EVP key");

                    EVP_PKEY_CTX_free(context);
                }
                else
                    logError(AUTHENTICATION, "Cannot create EVP context");
            }
            else
                logError(AUTHENTICATION, "Cannot set default paremeters");

            DH_free(dh);
        }

        EVP_PKEY_free(params);
    }
    else
        logError(AUTHENTICATION, "Cannot allocate EVP parameters");

    /*
    EVP_PKEY_CTX* context = EVP_PKEY_CTX_new_id(type, NULL);

    if(context != nullptr)
    {
        // Generate parameters
        if(EVP_PKEY_paramgen_init(context))
        {
            bool generated_param = false;
            switch(type)
            {
                case EVP_PKEY_EC:
                    if(EVP_PKEY_CTX_set_ec_paramgen_curve_nid(context, NID_X9_62_prime256v1))
                        generated_param = true;
                    break;
                case EVP_PKEY_DH:
                    if(EVP_PKEY_CTX_set_dh_paramgen_prime_len(context, 2048))
                        generated_param = true;
                    break;
            }

            if(generated_param)
            {
                std::cout << "PARAM" << std::endl;
                if(EVP_PKEY_paramgen(context, &param))
                {
                std::cout << "END PARAM" << std::endl;
                    if(EVP_PKEY_keygen_init(context))
                    {
                        if(!EVP_PKEY_keygen(context, &keys))
                            logError(AUTHENTICATION, "Cannot generate EVP key");
                    }
                    else
                        logError(AUTHENTICATION, "Cannot init EVP key");

                    //EVP_PKEY_free(param);
                }
                else
                    logError(AUTHENTICATION, "Cannot generate EVP parameters");
            }
            else
                logError(AUTHENTICATION, "Cannot set EVP parameters");
        }
        else
            logError(AUTHENTICATION, "Cannot init EVP context");

        EVP_PKEY_CTX_free(context);
    }
    else
        logError(AUTHENTICATION, "Cannot generate EVP context");
    */


    return keys;
}
