static void conv_up(double *low, double *high, int in_length, double *out, int out_length,
                    const double *lp, const double *hp, int filter_length,
                    double *buffer, double *buffer2, int buffer_length)
{
    int shift = 0, buff_idx = 0, in_idx = 0;

    memset(buffer, 0, buffer_length * sizeof(*buffer));
    memset(buffer2, 0, buffer_length * sizeof(*buffer2));

    for (int i = 0; i < out_length; i++) {
        double sum = 0.0;

        if ((i & 1) == 0) {
            if (in_idx < in_length) {
                buffer[buff_idx] = low[in_idx];
                buffer2[buff_idx] = high[in_idx++];
            } else {
                buffer[buff_idx] = 0;
                buffer2[buff_idx] = 0;
            }
            buff_idx++;
            if (buff_idx >= buffer_length)
                buff_idx = 0;
            shift = 0;
        }

        for (int j = 0; j < (filter_length - shift + 1) / 2; j++) {
            const int idx = mod_pow2(-j + buff_idx - 1, buffer_length);

            sum += buffer[idx] * lp[j * 2 + shift] + buffer2[idx] * hp[j * 2 + shift];
        }
        out[i] = sum;
        shift = 1;
    }
}
