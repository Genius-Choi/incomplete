addressFromSockAddrOrDie(const sockaddr_storage& ss, socklen_t ss_len, os_fd_t fd, bool v6only) {
  // Set v6only to false so that mapped-v6 address can be normalize to v4
  // address. Though dual stack may be disabled, it's still okay to assume the
  // address is from a dual stack socket. This is because mapped-v6 address
  // must come from a dual stack socket. An actual v6 address can come from
  // both dual stack socket and v6 only socket. If |peer_addr| is an actual v6
  // address and the socket is actually v6 only, the returned address will be
  // regarded as a v6 address from dual stack socket. However, this address is not going to be
  // used to create socket. Wrong knowledge of dual stack support won't hurt.
  StatusOr<Address::InstanceConstSharedPtr> address =
      Address::addressFromSockAddr(ss, ss_len, v6only);
  if (!address.ok()) {
    PANIC(fmt::format("Invalid address for fd: {}, error: {}", fd, address.status().ToString()));
  }
  return *address;
}
