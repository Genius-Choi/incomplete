Array * /* IMAPFolder */ IMAPSession::fetchSubscribedFolders(ErrorCode * pError)
{
    int r;
    clist * imap_folders;
    
    MCLog("fetch subscribed");
    loginIfNeeded(pError);
    if (* pError != ErrorNone)
        return NULL;
    
    if (mDelimiter == 0) {
        char delimiter;
        
        delimiter = fetchDelimiterIfNeeded(mDelimiter, pError);
        if (* pError != ErrorNone)
            return NULL;
        
        //setDelimiter(delimiter);
        mDelimiter = delimiter;
    }
    
    String * prefix;
    prefix = defaultNamespace()->mainPrefix();
    if (prefix == NULL) {
        prefix = MCSTR("");
    }
    if (prefix->length() > 0) {
        if (!prefix->hasSuffix(String::stringWithUTF8Format("%c", mDelimiter))) {
            prefix = prefix->stringByAppendingUTF8Format("%c", mDelimiter);
        }
    }
    
    r = mailimap_lsub(mImap, MCUTF8(prefix), "*", &imap_folders);
    MCLog("fetch subscribed %u", r);
    Array * result = resultsWithError(r, imap_folders, pError);
    if (* pError == ErrorConnection || * pError == ErrorParse)
        mShouldDisconnect = true;
    return result;
}
