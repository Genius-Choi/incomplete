static size_t fexpand_copy(constant char *fr, char *to)
{
	xcpy xp;
	xp.copied = 0;
	xp.dest = to;

	for (;  *fr != '\0';  fr++)
	{
		lbool expand = FALSE;
		switch (*fr)
		{
		case '%':
		case '#':
			if (fr[1] == *fr)
			{
				/* Two identical chars. Output just one. */
				fr += 1;
			} else 
			{
				/* Single char. Expand to a (quoted) file name. */
				expand = TRUE;
			}
			break;
		default:
			break;
		}
		if (expand)
		{
			IFILE ifile = (*fr == '%') ? curr_ifile : (*fr == '#') ? old_ifile : NULL_IFILE;
			if (ifile == NULL_IFILE)
				xcpy_char(&xp, *fr);
			else
				xcpy_filename(&xp, get_filename(ifile));
		} else
		{
			xcpy_char(&xp, *fr);
		}
	}
	if (xp.dest != NULL) xcpy_char(&xp, '\0');
	return xp.copied;
}
