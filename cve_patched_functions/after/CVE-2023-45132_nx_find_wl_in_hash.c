nx_find_wl_in_hash(ngx_http_request_t*        req,
                   ngx_str_t*                 mstr,
                   ngx_http_naxsi_loc_conf_t* cf,
                   naxsi_match_zone_t         zone)
{
  ngx_int_t                  k       = 0;
  ngx_http_whitelist_rule_t* b       = NULL;
  ngx_str_t                  scratch = { .data = NULL, .len = mstr->len };

  scratch.data = ngx_pcalloc(req->pool, mstr->len + 1);
  if (!scratch.data) {
    return NULL;
  }

  k = ngx_hash_strlow(scratch.data, mstr->data, mstr->len);

  if ((zone == BODY || zone == FILE_EXT || zone == ANY) && cf->wlr_body_hash &&
      cf->wlr_body_hash->size > 0) {
    b = (ngx_http_whitelist_rule_t*)ngx_hash_find(
      cf->wlr_body_hash, k, (u_char*)scratch.data, scratch.len);
  }
  if ((zone == HEADERS || (zone == ANY && !b)) && cf->wlr_headers_hash &&
      cf->wlr_headers_hash->size > 0) {
    b = (ngx_http_whitelist_rule_t*)ngx_hash_find(
      cf->wlr_headers_hash, k, (u_char*)scratch.data, scratch.len);
  }
  if ((zone == URL || (zone == ANY && !b)) && cf->wlr_url_hash && cf->wlr_url_hash->size > 0) {
    b = (ngx_http_whitelist_rule_t*)ngx_hash_find(
      cf->wlr_url_hash, k, (u_char*)scratch.data, scratch.len);
  }
  if ((zone == ARGS || (zone == ANY && !b)) && cf->wlr_args_hash && cf->wlr_args_hash->size > 0) {
    b = (ngx_http_whitelist_rule_t*)ngx_hash_find(
      cf->wlr_args_hash, k, (u_char*)scratch.data, scratch.len);
  }

  NX_DEBUG(_debug_whitelist_compat,
           NGX_LOG_DEBUG_HTTP,
           req->connection->log,
           0,
           "find wl in hash %d %p %s.",
           k,
           b,
           zone == ARGS       ? "ARGS"
           : zone == HEADERS  ? "HEADERS"
           : zone == BODY     ? "BODY"
           : zone == URL      ? "URL"
           : zone == FILE_EXT ? "FILE_EXT"
           : zone == RAW_BODY ? "RAW_BODY"
           : zone == ANY      ? "ANY"
                              : "UNKNOWN");
  ngx_pfree(req->pool, scratch.data);
  return (b);
}
