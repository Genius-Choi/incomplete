int CMerkleTx::GetDepthInMainChain(CBlockIndex* &pindexRet) const {
    bool fTxMempool = mempool.exists(GetHash());

    if((hashBlock == 0) || (nIndex == -1))
      return(fTxMempool ? 0 : -1);

    // Find the block it claims to be in
    map<uint256, CBlockIndex*>::iterator mi = mapBlockIndex.find(hashBlock);
    if(mi == mapBlockIndex.end())
      return(fTxMempool ? 0 : -1);

    CBlockIndex* pindex = (*mi).second;
    if(!pindex || !pindex->IsInMainChain())
      return(fTxMempool ? 0 : -1);

    // Make sure the merkle branch connects to this block
    if(!fMerkleVerified) {
        if(CBlock::CheckMerkleBranch(GetHash(), vMerkleBranch, nIndex) != pindex->hashMerkleRoot)
          return(fTxMempool ? 0 : -1);
        fMerkleVerified = true;
    }

    pindexRet = pindex;
    return(pindexBest->nHeight - pindex->nHeight + 1);
}
