IndexSet * IMAPSession::search(String * folder, IMAPSearchExpression * expression, ErrorCode * pError)
{
    struct mailimap_search_key * key;
    
    selectIfNeeded(folder, pError);
    if (* pError != ErrorNone)
        return NULL;

    clist * result_list = NULL;
    
    const char * charset = "utf-8";
    if (mYahooServer) {
        charset = NULL;
    }
    
    int r;
    key = searchKeyFromSearchExpression(expression);
    if (mIsGmail) {
        r = mailimap_uid_search_literalplus(mImap, charset, key, &result_list);
    }
    else {
        r = mailimap_uid_search(mImap, charset, key, &result_list);
    }
    mailimap_search_key_free(key);
    MCLog("had error : %i", r);
    if (r == MAILIMAP_ERROR_STREAM) {
        mShouldDisconnect = true;
        * pError = ErrorConnection;
        return NULL;
    }
    else if (r == MAILIMAP_ERROR_PARSE) {
        mShouldDisconnect = true;
        * pError = ErrorParse;
        return NULL;
    }
    else if (hasError(r)) {
        * pError = ErrorFetch;
        return NULL;
    }

    IndexSet * result = IndexSet::indexSet();
    for(clistiter * cur = clist_begin(result_list) ; cur != NULL ; cur = clist_next(cur))  {
        uint32_t * uid = (uint32_t *) clist_content(cur);
        result->addIndex(* uid);
    }
    mailimap_search_result_free(result_list);
    * pError = ErrorNone;
    return result;
}
