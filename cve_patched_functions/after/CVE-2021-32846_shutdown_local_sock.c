static void shutdown_local_sock(const char *ctx,
				struct pci_vtsock_sock *s,
				uint32_t mode)
{
	uint32_t new, set;

	assert((mode & ~VIRTIO_VSOCK_FLAG_SHUTDOWN_ALL) == 0);

	if (s->state != SOCK_CONNECTED) return;

	assert(s->local_shutdown != VIRTIO_VSOCK_FLAG_SHUTDOWN_ALL);

	DPRINTF(("%s: fd %d: LOCAL SHUTDOWN 0x%"PRIx32" (0x%"PRIx32")\n",
		 ctx, s->fd, mode, s->peer_shutdown));

	new = mode | s->local_shutdown;
	set = s->local_shutdown ^ new;
	s->local_shutdown = new;

	DPRINTF(("%s: setting 0x%"PRIx32" mode is now 0x%"PRIx32" (peer 0x%"PRIx32")\n",
		 ctx, set, s->local_shutdown, s->peer_shutdown));

	if (s->local_shutdown & VIRTIO_VSOCK_FLAG_SHUTDOWN_RX && s->write_buf_tail > 0) {
		PPRINTF(("%s: discarding %d bytes from buffer\n", ctx,
			 s->write_buf_tail - s->write_buf_head));
		s->write_buf_tail = s->write_buf_head = 0;
	}

	if (s->local_shutdown == VIRTIO_VSOCK_FLAG_SHUTDOWN_ALL)
		s->rst_deadline = time(NULL) + SHUTDOWN_RST_DELAY;
}
