  void finish(int r) override {
    Mutex::Locker l(osd->osd_lock);
    if (osd->is_stopping())
      return;
    PG::RecoveryCtx rctx = osd->create_context();
    for (set<PGRef>::iterator i = pgs.begin();
	 i != pgs.end();
	 ++i) {
      osd->pg_map_lock.get_write();
      (*i)->lock();
      PG *pg = i->get();
      osd->add_newly_split_pg(pg, &rctx);
      if (!((*i)->deleting)) {
        set<spg_t> to_complete;
        to_complete.insert((*i)->info.pgid);
        osd->service.complete_split(to_complete);
      }
      osd->pg_map_lock.put_write();
      osd->dispatch_context_transaction(rctx, pg);
      osd->wake_pg_waiters(*i);
      (*i)->unlock();
    }

    osd->dispatch_context(rctx, 0, osd->service.get_osdmap());
  }
