int uwsgi_wait_for_mountpoint(char *mountpoint) {
        if (!uwsgi.wait_for_fs_timeout) {
                uwsgi.wait_for_fs_timeout = 60;
        }
        uwsgi_log("waiting for %s (max %d seconds) ...\n", mountpoint, uwsgi.wait_for_fs_timeout);
        int counter = 0;
        for (;;) {
                if (counter > uwsgi.wait_for_fs_timeout) {
                        uwsgi_log("%s unavailable after %d seconds\n", mountpoint, counter);
                        return -1;
                }
		struct stat st0;
		struct stat st1;
		if (stat(mountpoint, &st0)) goto retry;
		if (!S_ISDIR(st0.st_mode)) goto retry;
		char *relative = uwsgi_concat2(mountpoint, "/../");
		if (stat(relative, &st1)) {
			free(relative);
			goto retry;
		}
		free(relative);
		// useless :P
                if (!S_ISDIR(st1.st_mode)) goto retry;
		if (st0.st_dev == st1.st_dev) goto retry;
                uwsgi_log_verbose("%s mounted\n", mountpoint);
                return 0;
retry:
                sleep(1);
                counter++;
        }
	return -1;
}
