static int process_ciba_request (const struct _u_request * request,
                                 struct _u_response * response,
                                 void * user_data,
                                 json_t * j_assertion_client,
                                 int client_auth_method) {
  struct _oidc_config * config = (struct _oidc_config *)user_data;
  const char * scope = u_map_get(request->map_post_body, "scope"),
             * client_notification_token = u_map_get(request->map_post_body, "client_notification_token"),
             * login_hint_token = u_map_get(request->map_post_body, "login_hint_token"),
             * id_token_hint = u_map_get(request->map_post_body, "id_token_hint"),
             * login_hint = u_map_get(request->map_post_body, "login_hint"),
             * binding_message = u_map_get(request->map_post_body, "binding_message"),
             * user_code = u_map_get(request->map_post_body, "user_code"),
             * requested_expiry = u_map_get(request->map_post_body, "requested_expiry"),
             * client_id = request->auth_basic_user,
             * client_secret = request->auth_basic_password,
             * user_agent = u_map_get_case(request->map_header, "user-agent"),
             * dpop_jkt = u_map_get_case(request->map_post_body, "dpop_jkt"),
             * ip_source = get_ip_source(request, config->glewlwyd_config->glewlwyd_config->originating_ip_header),
             * x5t_s256 = NULL;
  json_t * j_user_hint = NULL,
         * j_request = NULL,
         * j_client = NULL,
         * j_result = NULL,
         * j_return = NULL,
         * j_jkt = NULL;
  long int l_requested_expiry = 0;
  char * scope_reduced = NULL,
       * jti_hash = NULL,
       * dpop_nonce = NULL,
         auth_req_id[GLEWLWYD_CIBA_REQ_ID_LENGTH+1] = {0},
         user_req_id[GLEWLWYD_CIBA_REQ_ID_LENGTH+1] = {0};
  int hint_count = 0, res;

  if (j_assertion_client != NULL) {
    client_id = json_string_value(json_object_get(j_assertion_client, "client_id"));
    x5t_s256 = json_string_value(json_object_get(j_assertion_client, "x5t#S256"));
  }

  if (client_id == NULL && u_map_get(request->map_post_body, "client_id") != NULL) {
    client_id = u_map_get(request->map_post_body, "client_id");
  }

  if (client_secret == NULL && u_map_get(request->map_post_body, "client_secret") != NULL) {
    client_secret = u_map_get(request->map_post_body, "client_secret");
    client_auth_method = GLEWLWYD_CLIENT_AUTH_METHOD_SECRET_POST;
  } else if (client_secret != NULL) {
    client_auth_method = GLEWLWYD_CLIENT_AUTH_METHOD_SECRET_BASIC;
  }

  do {
    if (json_object_get(config->j_params, "request-parameter-allow") != json_false()) {
      if (!o_strnullempty(u_map_get(request->map_post_body, "request_uri"))) {
        j_return = json_pack("{ss}", "error", "invalid_request");
        ulfius_set_json_body_response(response, 400, j_return);
        json_decref(j_return);
        break;
      } else if (!o_strnullempty(u_map_get(request->map_post_body, "request"))) {
        j_request = validate_ciba_jwt_request(config, u_map_get(request->map_post_body, "request"), ip_source);
        if (check_result_value(j_request, G_ERROR_UNAUTHORIZED)) {
          j_return = json_pack("{ss}", "error", "invalid_client");
          ulfius_set_json_body_response(response, 403, j_return);
          json_decref(j_return);
          break;
        } else if (check_result_value(j_request, G_ERROR_PARAM)) {
          j_return = json_pack("{ss}", "error", "invalid_request");
          ulfius_set_json_body_response(response, 403, j_return);
          json_decref(j_return);
          break;
        } else if (!check_result_value(j_request, G_OK)) {
          y_log_message(Y_LOG_LEVEL_ERROR, "process_ciba_request oidc - error validate_ciba_jwt_request");
          j_return = json_pack("{ss}", "error", "server_error");
          ulfius_set_json_body_response(response, 500, j_return);
          json_decref(j_return);
          break;
        } else {
          client_auth_method = (int)json_integer_value(json_object_get(j_request, "client_auth_method"));
          client_id = json_string_value(json_object_get(json_object_get(j_request, "client"), "client_id"));
          if ((jti_hash = config->glewlwyd_config->glewlwyd_callback_generate_hash(config->glewlwyd_config, json_string_value(json_object_get(j_request, "jti")))) == NULL) {
            y_log_message(Y_LOG_LEVEL_ERROR, "process_ciba_request oidc - error glewlwyd_callback_generate_hash");
            j_return = json_pack("{ss}", "error", "server_error");
            ulfius_set_json_body_response(response, 500, j_return);
            json_decref(j_return);
            break;
          }
          scope = json_string_value(json_object_get(json_object_get(j_request, "request"), "scope"));
          client_notification_token = json_string_value(json_object_get(json_object_get(j_request, "request"), "client_notification_token"));
          login_hint_token = json_string_value(json_object_get(json_object_get(j_request, "request"), "login_hint_token"));
          id_token_hint = json_string_value(json_object_get(json_object_get(j_request, "request"), "id_token_hint"));
          login_hint = json_string_value(json_object_get(json_object_get(j_request, "request"), "login_hint"));
          binding_message = json_string_value(json_object_get(json_object_get(j_request, "request"), "binding_message"));
          user_code = json_string_value(json_object_get(json_object_get(j_request, "request"), "user_code"));
          requested_expiry = json_string_value(json_object_get(json_object_get(j_request, "request"), "requested_expiry"));
          dpop_jkt = json_string_value(json_object_get(json_object_get(j_request, "request"), "dpop_jkt"));
        }
      }
    }

    if (j_assertion_client != NULL) {
      j_client = json_pack("{sisO}", "result", G_OK, "client", j_assertion_client);
    } else if (j_request != NULL) {
      j_client = json_pack("{sisO}", "result", G_OK, "client", json_object_get(j_request, "client"));
    } else {
      j_client = check_client_valid(config, client_id, client_secret, NULL, GLEWLWYD_AUTHORIZATION_TYPE_CIBA_FLAG, 0, ip_source);
    }

    if (!check_result_value(j_client, G_OK) || json_object_get(json_object_get(j_client, "client"), "enabled") != json_true()) {
      j_return = json_pack("{ss}", "error", "invalid_client");
      ulfius_set_json_body_response(response, 403, j_return);
      json_decref(j_return);
      y_log_message(Y_LOG_LEVEL_DEBUG, "process_ciba_request oidc - client '%s' is invalid, origin: %s", client_id, ip_source);
      break;
    }

    if (o_strnullempty(scope)) {
      j_return = json_pack("{ss}", "error", "invalid_scope");
      ulfius_set_json_body_response(response, 403, j_return);
      json_decref(j_return);
      y_log_message(Y_LOG_LEVEL_DEBUG, "process_ciba_request oidc - client '%s', scope is mandatory, origin: %s", client_id, ip_source);
      break;
    }

    if (json_object_get(config->j_params, "oauth-fapi-ciba-push-forbidden") == json_true()) {
      if (0 == o_strcmp(json_string_value(json_object_get(json_object_get(j_client, "client"), "backchannel_token_delivery_mode")), "push")) {
        j_return = json_pack("{ss}", "error", "invalid_client");
        ulfius_set_json_body_response(response, 403, j_return);
        json_decref(j_return);
        y_log_message(Y_LOG_LEVEL_DEBUG, "process_ciba_request oidc - client '%s' uses ciba mode push, which is forbidden, origin: %s", client_id, ip_source);
        break;
      }
    }

    if (json_object_get(config->j_params, "oauth-fapi-ciba-confidential-client") == json_true() && json_object_get(json_object_get(j_client, "client"), "confidential") != json_true()) {
      j_return = json_pack("{ss}", "error", "invalid_client");
      ulfius_set_json_body_response(response, 403, j_return);
      json_decref(j_return);
      y_log_message(Y_LOG_LEVEL_DEBUG, "process_ciba_request oidc - client '%s' is not confidential, which is forbidden, origin: %s", client_id, ip_source);
      break;
    }

    if (0 == o_strcmp(json_string_value(json_object_get(json_object_get(j_client, "client"), "backchannel_token_delivery_mode")), "poll") &&
        json_true() != json_object_get(config->j_params, "oauth-ciba-mode-poll-allowed")) {
      j_return = json_pack("{ss}", "error", "invalid_request");
      ulfius_set_json_body_response(response, 403, j_return);
      json_decref(j_return);
      y_log_message(Y_LOG_LEVEL_DEBUG, "process_ciba_request oidc - client '%s', mode poll unauthorized, origin: %s", client_id, ip_source);
      break;
    }

    if (0 == o_strcmp(json_string_value(json_object_get(json_object_get(j_client, "client"), "backchannel_token_delivery_mode")), "ping") &&
        json_true() != json_object_get(config->j_params, "oauth-ciba-mode-ping-allowed")) {
      j_return = json_pack("{ss}", "error", "invalid_request");
      ulfius_set_json_body_response(response, 403, j_return);
      json_decref(j_return);
      y_log_message(Y_LOG_LEVEL_DEBUG, "process_ciba_request oidc - client '%s', mode ping unauthorized, origin: %s", client_id, ip_source);
      break;
    }

    if (0 == o_strcmp(json_string_value(json_object_get(json_object_get(j_client, "client"), "backchannel_token_delivery_mode")), "push") &&
        json_true() != json_object_get(config->j_params, "oauth-ciba-mode-push-allowed")) {
      j_return = json_pack("{ss}", "error", "invalid_request");
      ulfius_set_json_body_response(response, 403, j_return);
      json_decref(j_return);
      y_log_message(Y_LOG_LEVEL_DEBUG, "process_ciba_request oidc - client '%s', mode push unauthorized, origin: %s", client_id, ip_source);
      break;
    }

    if (!json_string_null_or_empty(json_object_get(config->j_params, "restrict-scope-client-property"))) {
      j_result = reduce_scope(scope, json_object_get(json_object_get(j_client, "client"), json_string_value(json_object_get(config->j_params, "restrict-scope-client-property"))));
      if (check_result_value(j_result, G_OK)) {
        scope_reduced = o_strdup(json_string_value(json_object_get(j_result, "scope")));
      } else if (check_result_value(j_result, G_ERROR_UNAUTHORIZED)) {
        y_log_message(Y_LOG_LEVEL_ERROR, "process_ciba_request oidc - error client %s is not allowed to claim scopes '%s'", client_id, scope);
        y_log_message(Y_LOG_LEVEL_WARNING, "Security - Authorization invalid for client_id %s at IP Address %s", client_id, ip_source);
        j_return = json_pack("{ss}", "error", "invalid_request");
        ulfius_set_json_body_response(response, 400, j_return);
        json_decref(j_return);
        config->glewlwyd_config->glewlwyd_plugin_callback_metrics_increment_counter(config->glewlwyd_config, GLWD_METRICS_OIDC_UNAUTHORIZED_CLIENT, 1, "plugin", config->name, NULL);
        break;
      } else {
        y_log_message(Y_LOG_LEVEL_ERROR, "process_ciba_request oidc - error reduce_scope");
        j_return = json_pack("{ss}", "error", "server_error");
        ulfius_set_json_body_response(response, 500, j_return);
        json_decref(j_return);
        break;
      }
    } else {
      scope_reduced = o_strdup(scope);
    }

    if (!is_client_auth_method_allowed(json_object_get(j_client, "client"), client_auth_method)) {
      y_log_message(Y_LOG_LEVEL_ERROR, "process_ciba_request oidc - client '%s' authentication method is invalid, origin: %s", client_id, ip_source);
      j_return = json_pack("{ss}", "error", "invalid_client");
      ulfius_set_json_body_response(response, 403, j_return);
      json_decref(j_return);
      break;
    }

    if (client_id == NULL && client_secret == NULL && json_object_get(json_object_get(j_client, "client"), "confidential") == json_true()) {
      y_log_message(Y_LOG_LEVEL_DEBUG, "process_ciba_request oidc - client '%s' is invalid or is not confidential, origin: %s", client_id, ip_source);
      j_return = json_pack("{ss}", "error", "invalid_client");
      ulfius_set_json_body_response(response, 403, j_return);
      json_decref(j_return);
      break;
    }

    // Check client_notification_token
    if (0 == o_strcmp(json_string_value(json_object_get(json_object_get(j_client, "client"), "backchannel_token_delivery_mode")), "ping") ||
        0 == o_strcmp(json_string_value(json_object_get(json_object_get(j_client, "client"), "backchannel_token_delivery_mode")), "push")) {
      if (o_strlen(client_notification_token) > 1024 || o_strlen(client_notification_token) < 22) {
        y_log_message(Y_LOG_LEVEL_DEBUG, "process_ciba_request oidc - client_notification_token invalid length for the client '%s', origin: %s", client_id, ip_source);
        j_return = json_pack("{ss}", "error", "invalid_request");
        ulfius_set_json_body_response(response, 400, j_return);
        json_decref(j_return);
        break;
      }

      if (!str_has_valid_charset(client_notification_token, "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-._~+/=")) {
        y_log_message(Y_LOG_LEVEL_DEBUG, "process_ciba_request oidc - client_notification_token invalid charset for the client '%s', origin: %s", client_id, ip_source);
        j_return = json_pack("{ss}", "error", "invalid_request");
        ulfius_set_json_body_response(response, 400, j_return);
        json_decref(j_return);
        break;
      }
    }

    // Validate login hints
    if (o_strnullempty(login_hint_token) && o_strnullempty(id_token_hint) && o_strnullempty(login_hint)) {
      y_log_message(Y_LOG_LEVEL_DEBUG, "process_ciba_request oidc - missing login hint for the client '%s', origin: %s", client_id, ip_source);
      j_return = json_pack("{ss}", "error", "invalid_request");
      ulfius_set_json_body_response(response, 400, j_return);
      json_decref(j_return);
      break;
    }

    hint_count = (!o_strnullempty(login_hint_token)?1:0) + (!o_strnullempty(id_token_hint)?1:0) + (!o_strnullempty(login_hint)?1:0);

    if (hint_count > 1) {
      y_log_message(Y_LOG_LEVEL_DEBUG, "process_ciba_request oidc - too many login hints for the client '%s', origin: %s", client_id, ip_source);
      j_return = json_pack("{ss}", "error", "invalid_request");
      ulfius_set_json_body_response(response, 400, j_return);
      json_decref(j_return);
      break;
    }

    j_user_hint = check_ciba_login_hint(config, json_object_get(j_client, "client"), login_hint_token, id_token_hint, login_hint, ip_source);
    if (check_result_value(j_user_hint, G_ERROR_UNAUTHORIZED)) {
      y_log_message(Y_LOG_LEVEL_DEBUG, "process_ciba_request oidc - login hint unauthorized for the client '%s', origin: %s", client_id, ip_source);
      j_return = json_pack("{ss}", "error", "invalid_request");
      ulfius_set_json_body_response(response, 400, j_return);
      json_decref(j_return);
      break;
    } else if (check_result_value(j_user_hint, G_ERROR_PARAM)) {
      y_log_message(Y_LOG_LEVEL_DEBUG, "process_ciba_request oidc - login hint invalid for the client '%s', origin: %s", client_id, ip_source);
      j_return = json_pack("{ss}", "error", "invalid_request");
      ulfius_set_json_body_response(response, 400, j_return);
      json_decref(j_return);
      break;
    } else if (!check_result_value(j_user_hint, G_OK)) {
      y_log_message(Y_LOG_LEVEL_ERROR, "process_ciba_request oidc - Error check_ciba_login_hint");
      j_return = json_pack("{ss}", "error", "server_error");
      ulfius_set_json_body_response(response, 500, j_return);
      json_decref(j_return);
      break;
    }

    // Validate binding_message
    if (o_strlen(binding_message) > 256) {
      y_log_message(Y_LOG_LEVEL_DEBUG, "process_ciba_request oidc - binding_message too long for the client '%s', maximum 256 characters, origin: %s", client_id, ip_source);
      j_return = json_pack("{ss}", "error", "invalid_binding_message");
      ulfius_set_json_body_response(response, 400, j_return);
      json_decref(j_return);
      break;
    }

    // Validate user_code
    if (json_object_get(config->j_params, "oauth-ciba-user-code-allowed") == json_true()) {
      if (!o_strnullempty(user_code) && check_ciba_user_code(config, json_object_get(j_user_hint, "user"), user_code) != G_OK) {
        y_log_message(Y_LOG_LEVEL_DEBUG, "process_ciba_request oidc - invalid user_code for the client '%s', origin: %s", client_id, ip_source);
        j_return = json_pack("{ss}", "error", "invalid_user_code");
        ulfius_set_json_body_response(response, 400, j_return);
        json_decref(j_return);
        break;
      }
    } else {
      user_code = NULL;
    }

    // Validate requested_expiry
    if (!o_strnullempty(requested_expiry)) {
      l_requested_expiry = strtol(requested_expiry, NULL, 10);
      if (l_requested_expiry <= 0) {
        y_log_message(Y_LOG_LEVEL_DEBUG, "process_ciba_request oidc - invalid requested_expiry for the client '%s', must be a positive integer, origin: %s", client_id, ip_source);
        j_return = json_pack("{ss}", "error", "invalid_request");
        ulfius_set_json_body_response(response, 400, j_return);
        json_decref(j_return);
        break;
      } else if (l_requested_expiry > json_integer_value(json_object_get(config->j_params, "oauth-ciba-maximum-expiry"))) {
        y_log_message(Y_LOG_LEVEL_DEBUG, "process_ciba_request oidc - invalid requested_expiry for the client '%s', must be a positive integer, maximum %"JSON_INTEGER_FORMAT", origin: %s", client_id, json_integer_value(json_object_get(config->j_params, "oauth-ciba-maximum-expiry")), ip_source);
        j_return = json_pack("{ss}", "error", "invalid_request");
        ulfius_set_json_body_response(response, 400, j_return);
        json_decref(j_return);
        break;
      }
    }

    if (!l_requested_expiry) {
      l_requested_expiry = (long int)json_integer_value(json_object_get(config->j_params, "oauth-ciba-default-expiry"));
    }

    // Validate DPoP
    j_jkt = oidc_verify_dpop_proof(config, request, "POST", "/ciba", json_object_get(j_client, "client"), NULL, NULL);
    if (check_result_value(j_jkt, G_ERROR_PARAM) || check_result_value(j_jkt, G_ERROR_UNAUTHORIZED)) {
      y_log_message(Y_LOG_LEVEL_WARNING, "Security - DPoP invalid at IP Address %s", get_ip_source(request, config->glewlwyd_config->glewlwyd_config->originating_ip_header));
      j_return = json_pack("{ssss}", "error", "invalid_dpop_proof", "error_description", "Invalid DPoP");
      ulfius_set_json_body_response(response, 403, j_return);
      json_decref(j_return);
      config->glewlwyd_config->glewlwyd_plugin_callback_metrics_increment_counter(config->glewlwyd_config, GLWD_METRICS_OIDC_UNAUTHORIZED_CLIENT, 1, "plugin", config->name, NULL);
      break;
    }
    if (!check_result_value(j_jkt, G_OK)) {
      y_log_message(Y_LOG_LEVEL_ERROR, "process_ciba_request - Error oidc_verify_dpop_proof");
      response->status = 500;
      break;
    }
    if (json_object_get(j_jkt, "jkt") != NULL) {
      if ((res = check_dpop_jti(config,
                              json_string_value(json_object_get(json_object_get(j_jkt, "claims"), "jti")),
                              json_string_value(json_object_get(json_object_get(j_jkt, "claims"), "htm")),
                              json_string_value(json_object_get(json_object_get(j_jkt, "claims"), "htu")),
                              json_integer_value(json_object_get(json_object_get(j_jkt, "claims"), "iat")),
                              client_id,
                              json_string_value(json_object_get(j_jkt, "jkt")),
                              ip_source)) == G_ERROR_UNAUTHORIZED) {
        j_return = json_pack("{ssss}", "error", "invalid_dpop_proof", "error_description", "Invalid DPoP");
        ulfius_set_json_body_response(response, 403, j_return);
        json_decref(j_return);
        break;
      } else if (res != G_OK) {
        y_log_message(Y_LOG_LEVEL_ERROR, "process_ciba_request - oidc - Error check_dpop_jti");
        response->status = 500;
        break;
      }
      if (!o_strnullempty(dpop_jkt) && 0 != o_strcmp(dpop_jkt, json_string_value(json_object_get(j_jkt, "jkt")))) {
        j_return = json_pack("{ssss}", "error", "invalid_dpop_proof", "error_description", "Invalid DPoP - dpop_jkt doesn't match");
        ulfius_set_json_body_response(response, 403, j_return);
        json_decref(j_return);
        break;
      }
      dpop_jkt = json_string_value(json_object_get(j_jkt, "jkt"));
      if (json_object_get(config->j_params, "oauth-dpop-nonce-mandatory") == json_true()) {
        if ((dpop_nonce = refresh_client_dpop_nonce(config, client_id)) != NULL) {
          ulfius_set_response_properties(response, U_OPT_HEADER_PARAMETER, "DPoP-Nonce", dpop_nonce, U_OPT_NONE);
          o_free(dpop_nonce);
        }
      }
    }

    // Generate auth_req_id
    if (rand_string(auth_req_id, GLEWLWYD_CIBA_REQ_ID_LENGTH) == NULL) {
      y_log_message(Y_LOG_LEVEL_ERROR, "process_ciba_request oidc - Error rand_string auth_req_id");
      j_return = json_pack("{ss}", "error", "server_error");
      ulfius_set_json_body_response(response, 500, j_return);
      json_decref(j_return);
      break;
    }

    // Generate user_req_id
    if (rand_string(user_req_id, GLEWLWYD_CIBA_REQ_ID_LENGTH) == NULL) {
      y_log_message(Y_LOG_LEVEL_ERROR, "process_ciba_request oidc - Error rand_string user_req_id");
      j_return = json_pack("{ss}", "error", "server_error");
      ulfius_set_json_body_response(response, 500, j_return);
      json_decref(j_return);
      break;
    }

    if (serialize_ciba_request(config, client_id, json_object_get(j_user_hint, "user"), client_notification_token, auth_req_id, user_req_id, binding_message, l_requested_expiry, ip_source, user_agent, scope_reduced, x5t_s256, jti_hash, dpop_jkt) != G_OK) {
      y_log_message(Y_LOG_LEVEL_ERROR, "process_ciba_request oidc - Error serialize_ciba_request");
      j_return = json_pack("{ss}", "error", "server_error");
      ulfius_set_json_body_response(response, 500, j_return);
      json_decref(j_return);
      break;
    }

    if (json_object_get(config->j_params, "oauth-ciba-email-allowed") == json_true()) {
      if ((res = send_ciba_email(config, json_object_get(j_user_hint, "user"), json_object_get(j_client, "client"), user_req_id, binding_message)) == G_ERROR_PARAM) {
        y_log_message(Y_LOG_LEVEL_INFO, "Send ciba e-mail, user '%s' has no e-mail address", json_string_value(json_object_get(json_object_get(j_user_hint, "user"), "email")));
      } else if (res != G_OK) {
        y_log_message(Y_LOG_LEVEL_ERROR, "process_ciba_request oidc - Error send_ciba_email");
      }
    }

    j_return = json_pack("{sssi}", "auth_req_id", auth_req_id, "expires_in", l_requested_expiry);
    if (0 == o_strcmp(json_string_value(json_object_get(json_object_get(j_client, "client"), "backchannel_token_delivery_mode")), "poll")) {
      // This is only to avoid clients that would expect an interval value,
      // but Glewlwyd's ciba implementation doesn't care about the interval
      json_object_set_new(j_return, "interval", json_integer(5));
    }
    ulfius_set_json_body_response(response, 200, j_return);
    json_decref(j_return);
  } while (0);
  json_decref(j_user_hint);
  json_decref(j_client);
  json_decref(j_request);
  json_decref(j_result);
  json_decref(j_jkt);
  o_free(scope_reduced);
  o_free(jti_hash);
  return U_CALLBACK_CONTINUE;
}
