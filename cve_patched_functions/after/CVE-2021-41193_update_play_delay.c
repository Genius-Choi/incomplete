    void audio_io_osx::update_play_delay() {
        ++play_delay_measurement_counter_;
        
        if (play_delay_measurement_counter_ >= 100) {
            // Update HW and OS delay every second, unlikely to change
            AudioUnit auTmp = au_rec_;
            play_delay_HWandOS_ = 0;
            
            // Get audio unit latency.
            if(au_play_){
                auTmp = au_play_;
            }
            Float64 f64(0);
            UInt32 size = sizeof(f64);
            OSStatus result = AudioUnitGetProperty(
                                                   auTmp,
                                                   kAudioUnitProperty_Latency,
                                                   kAudioUnitScope_Global,
                                                   0,
                                                   &f64,
                                                   &size);
            
            if (0 != result) {
                error("audio_io_osx: error AU latency (result=%d) \n", result);
            }
            
            play_delay_HWandOS_ += static_cast<int>(f64 * 1000000);
            
            // Getoutput audio device latency.
            AudioObjectPropertyAddress property_address = {
                kAudioDevicePropertyLatency,
                kAudioDevicePropertyScopeInput,
                kAudioObjectPropertyElementMaster
            };
            UInt32 device_latency_frames = 0;
            size = sizeof(device_latency_frames);
            result = AudioObjectGetPropertyData(output_device_id_,
                                                &property_address,
                                                0,
                                                NULL,
                                                &size,
                                                &device_latency_frames);
            
            if (0 != result) {
                error("audio_io_osx: error Device latency (result=%d) \n", result);
            }
            
            play_delay_HWandOS_ += static_cast<int>((device_latency_frames * 1000000) / play_fs_hz_);
            
            // To ms
            play_delay_HWandOS_ = (uint32_t)(((int32_t)play_delay_HWandOS_ - 500) / 1000); // Below 0.5 ms this will wrap around because of using unsigned
            
            // Reset counter
            play_delay_measurement_counter_ = 0;
        }
        
        uint32_t tmp_play_latency_ms;
        {
            
            tmp_play_latency_ms = play_latency_ms_;
        }
        
        play_delay_ = play_delay_HWandOS_ + tmp_play_latency_ms;
    }
