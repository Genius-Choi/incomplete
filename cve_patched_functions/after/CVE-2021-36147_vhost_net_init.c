vhost_net_init(struct virtio_base *base, int vhostfd, int tapfd, int vq_idx)
{
	struct vhost_net *vhost_net = NULL;
	uint64_t vhost_features = VIRTIO_NET_S_VHOSTCAPS;
	uint64_t vhost_ext_features = VHOST_NET_F_VIRTIO_NET_HDR;
	uint32_t busyloop_timeout = 0;
	int rc;

	vhost_net = calloc(1, sizeof(struct vhost_net));
	if (!vhost_net) {
		WPRINTF(("vhost init out of memory\n"));
		goto fail;
	}

	/* pre-init before calling vhost_dev_init */
	vhost_net->vdev.nvqs = ARRAY_SIZE(vhost_net->vqs);
	vhost_net->vdev.vqs = vhost_net->vqs;
	vhost_net->tapfd = tapfd;

	rc = vhost_dev_init(&vhost_net->vdev, base, vhostfd, vq_idx,
		vhost_features, vhost_ext_features, busyloop_timeout);
	if (rc < 0) {
		WPRINTF(("vhost_dev_init failed\n"));
		goto fail;
	}

	return vhost_net;
fail:
	if (vhost_net)
		free(vhost_net);
	return NULL;
}
