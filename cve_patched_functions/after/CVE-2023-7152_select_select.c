STATIC mp_obj_t select_select(size_t n_args, const mp_obj_t *args) {
    // get array data from tuple/list arguments
    size_t rwx_len[3];
    mp_obj_t *r_array, *w_array, *x_array;
    mp_obj_get_array(args[0], &rwx_len[0], &r_array);
    mp_obj_get_array(args[1], &rwx_len[1], &w_array);
    mp_obj_get_array(args[2], &rwx_len[2], &x_array);

    // get timeout
    mp_uint_t timeout = -1;
    if (n_args == 4) {
        if (args[3] != mp_const_none) {
            #if MICROPY_PY_BUILTINS_FLOAT
            float timeout_f = mp_obj_get_float_to_f(args[3]);
            if (timeout_f >= 0) {
                timeout = (mp_uint_t)(timeout_f * 1000);
            }
            #else
            timeout = mp_obj_get_int(args[3]) * 1000;
            #endif
        }
    }

    // merge separate lists and get the ioctl function for each object
    poll_set_t poll_set;
    poll_set_init(&poll_set, rwx_len[0] + rwx_len[1] + rwx_len[2]);
    poll_set_add_obj(&poll_set, r_array, rwx_len[0], MP_STREAM_POLL_RD, true);
    poll_set_add_obj(&poll_set, w_array, rwx_len[1], MP_STREAM_POLL_WR, true);
    poll_set_add_obj(&poll_set, x_array, rwx_len[2], MP_STREAM_POLL_ERR | MP_STREAM_POLL_HUP, true);

    // poll all objects
    rwx_len[0] = rwx_len[1] = rwx_len[2] = 0;
    poll_set_poll_until_ready_or_timeout(&poll_set, rwx_len, timeout);

    // one or more objects are ready, or we had a timeout
    mp_obj_t list_array[3];
    list_array[0] = mp_obj_new_list(rwx_len[0], NULL);
    list_array[1] = mp_obj_new_list(rwx_len[1], NULL);
    list_array[2] = mp_obj_new_list(rwx_len[2], NULL);
    rwx_len[0] = rwx_len[1] = rwx_len[2] = 0;
    for (mp_uint_t i = 0; i < poll_set.map.alloc; ++i) {
        if (!mp_map_slot_is_filled(&poll_set.map, i)) {
            continue;
        }
        poll_obj_t *poll_obj = MP_OBJ_TO_PTR(poll_set.map.table[i].value);
        if (poll_obj->revents & MP_STREAM_POLL_RD) {
            ((mp_obj_list_t *)MP_OBJ_TO_PTR(list_array[0]))->items[rwx_len[0]++] = poll_obj->obj;
        }
        if (poll_obj->revents & MP_STREAM_POLL_WR) {
            ((mp_obj_list_t *)MP_OBJ_TO_PTR(list_array[1]))->items[rwx_len[1]++] = poll_obj->obj;
        }
        if ((poll_obj->revents & ~(MP_STREAM_POLL_RD | MP_STREAM_POLL_WR)) != 0) {
            ((mp_obj_list_t *)MP_OBJ_TO_PTR(list_array[2]))->items[rwx_len[2]++] = poll_obj->obj;
        }
    }
    poll_set_deinit(&poll_set);
    return mp_obj_new_tuple(3, list_array);
}
