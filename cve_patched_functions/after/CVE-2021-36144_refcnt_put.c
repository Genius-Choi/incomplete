refcnt_put(const struct refcnt *ref)
{
	int new, val;

	do {
		val = atomic_read(ref);
		if (val == 0)
			return;
		new = val - 1;
	} while (!__sync_bool_compare_and_swap((int *)&ref->count, val, new));

	if (new == 0)
		ref->destroy(ref);
}
