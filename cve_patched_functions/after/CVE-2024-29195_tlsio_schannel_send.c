int tlsio_schannel_send(CONCRETE_IO_HANDLE tls_io, const void* buffer, size_t size, ON_SEND_COMPLETE on_send_complete, void* callback_context)
{
    int result;
    TLS_IO_INSTANCE* tls_io_instance = (TLS_IO_INSTANCE*)tls_io;

    if (tls_io_instance->tlsio_state == TLSIO_STATE_RENEGOTIATE)
    {
        /* add to pending list */
        PENDING_SEND* new_pending_send = (PENDING_SEND*)calloc(1, sizeof(PENDING_SEND));
        if (new_pending_send == NULL)
        {
            LogError("Cannot allocate memory for pending IO");
            result = MU_FAILURE;
        }
        else
        {
            new_pending_send->bytes = (unsigned char*)malloc(size);
            if (new_pending_send->bytes == NULL)
            {
                LogError("Cannot allocate memory for pending IO payload");
                result = MU_FAILURE;
            }
            else
            {
                (void)memcpy(new_pending_send->bytes, buffer, size);
                new_pending_send->length = size;
                new_pending_send->on_send_complete = on_send_complete;
                new_pending_send->on_send_complete_context = callback_context;

                if (singlylinkedlist_add(tls_io_instance->pending_io_list, new_pending_send) == NULL)
                {
                    LogError("Cannot add pending IO to list");
                    result = MU_FAILURE;
                }
                else
                {
                    result = 0;
                }
            }
        }
    }
    else
    {
        if (internal_send((TLS_IO_INSTANCE*)tls_io, buffer, size, on_send_complete, callback_context) != 0)
        {
            LogError("send failed");
            result = MU_FAILURE;
        }
        else
        {
            result = 0;
        }
    }

    return result;
}
