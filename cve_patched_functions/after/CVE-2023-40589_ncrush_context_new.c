NCRUSH_CONTEXT* ncrush_context_new(BOOL Compressor)
{
	NCRUSH_CONTEXT* ncrush = (NCRUSH_CONTEXT*)calloc(1, sizeof(NCRUSH_CONTEXT));

	if (!ncrush)
		goto fail;

	ncrush->Compressor = Compressor;
	ncrush->HistoryBufferSize = 65536;
	ncrush->HistoryEndOffset = ncrush->HistoryBufferSize - 1;
	ncrush->HistoryBufferFence = 0xABABABAB;
	ncrush->HistoryOffset = 0;
	ncrush->HistoryPtr = &(ncrush->HistoryBuffer[ncrush->HistoryOffset]);

	if (ncrush_generate_tables(ncrush) < 0)
	{
		WLog_DBG(TAG, "ncrush_context_new: failed to initialize tables");
		goto fail;
	}

	ncrush_context_reset(ncrush, FALSE);

	return ncrush;
fail:
	ncrush_context_free(ncrush);
	return NULL;
}
