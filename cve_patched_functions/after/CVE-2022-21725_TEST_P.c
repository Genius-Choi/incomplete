TEST_P(OpLevelBatchMatMulCostEstimatorTest, TestBatchMatMul) {
  {
    auto cost = PredictCosts(DescribeBatchMatMul({}, {}));
    EXPECT_EQ(1, cost.num_ops_total);
    EXPECT_TRUE(cost.inaccurate);
    EXPECT_EQ(1, cost.num_ops_with_unknown_shapes);
  }
  {
    auto cost = PredictCosts(DescribeBatchMatMul({2, 4}, {}));
    EXPECT_EQ(1, cost.num_ops_total);
    EXPECT_TRUE(cost.inaccurate);
    EXPECT_EQ(1, cost.num_ops_with_unknown_shapes);
  }
  {
    auto cost = PredictCosts(DescribeBatchMatMul({2, 4}, {4, 2}));
    EXPECT_EQ(1, cost.num_ops_total);
    EXPECT_FALSE(cost.inaccurate);
    EXPECT_EQ(0, cost.num_ops_with_unknown_shapes);
  }
  {
    auto cost = PredictCosts(DescribeBatchMatMul({1, 2, 4}, {1, 4, 2}));
    EXPECT_EQ(1, cost.num_ops_total);
    EXPECT_FALSE(cost.inaccurate);
    EXPECT_EQ(0, cost.num_ops_with_unknown_shapes);
  }
  {
    auto cost = PredictCosts(DescribeBatchMatMul({2, 4}, {1, 3, 4, 2}));
    EXPECT_EQ(1, cost.num_ops_total);
    EXPECT_FALSE(cost.inaccurate);
    EXPECT_EQ(0, cost.num_ops_with_unknown_shapes);
  }
  bool matmul_inaccurate = false;
  bool batch_matmul_inaccurate = false;
  EXPECT_EQ(
      CountMatMulOperations(DescribeMatMul(2, 2, 4, 4).op_info,
                            &matmul_inaccurate),
      CountBatchMatMulOperations(DescribeBatchMatMul({2, 4}, {4, 2}).op_info,
                                 &batch_matmul_inaccurate));
  EXPECT_EQ(matmul_inaccurate, batch_matmul_inaccurate);
  EXPECT_EQ(10 * CountMatMulOperations(DescribeMatMul(2, 2, 4, 4).op_info,
                                       &matmul_inaccurate),
            CountBatchMatMulOperations(
                DescribeBatchMatMul({10, 2, 4}, {-1, 10, 4, 2}).op_info,
                &batch_matmul_inaccurate));
  EXPECT_NE(matmul_inaccurate, batch_matmul_inaccurate);
  EXPECT_EQ(20 * CountMatMulOperations(DescribeMatMul(2, 2, 4, 4).op_info,
                                       &matmul_inaccurate),
            CountBatchMatMulOperations(
                DescribeBatchMatMul({2, 10, 2, 4}, {-1, 10, 4, 2}).op_info,
                &batch_matmul_inaccurate));
  EXPECT_NE(matmul_inaccurate, batch_matmul_inaccurate);

  // Test the count to make sure that they extracted the dimensions correctly
  int prod = CountBatchMatMulDimProduct(
      DescribeBatchMatMul({2, 4}, {1, 3, 4, 2}).op_info,
      &batch_matmul_inaccurate);
  EXPECT_EQ(prod, 16);
  EXPECT_FALSE(batch_matmul_inaccurate);

  // Exercise the bad cases of a batchMatMul.
  OpContext bad_batch = DescribeBatchMatMul({2, 4}, {4, 2});
  bad_batch.op_info.set_op("notBatchMatMul");
  prod =
      CountBatchMatMulDimProduct(bad_batch.op_info, &batch_matmul_inaccurate);

  EXPECT_EQ(prod, 0);
  EXPECT_TRUE(batch_matmul_inaccurate);

  // Exercise a transpose case of a batchMatMul
  OpContext transpose_batch = DescribeBatchMatMul({2, 4, 3, 1}, {4, 2});
  auto attr = transpose_batch.op_info.mutable_attr();
  (*attr)["adj_x"].set_b(true);
  (*attr)["adj_y"].set_b(true);

  prod = CountBatchMatMulDimProduct(transpose_batch.op_info,
                                    &batch_matmul_inaccurate);
  EXPECT_EQ(prod, 12);
}
