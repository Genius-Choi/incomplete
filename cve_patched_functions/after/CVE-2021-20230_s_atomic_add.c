NOEXPORT int s_atomic_add(int *val, int amount, CRYPTO_RWLOCK *lock) {
    int ret;

    (void)lock; /* squash the unused parameter warning */
#if !defined(USE_OS_THREADS)
    /* no synchronization is needed */
    return *val+=amount;
#elif defined(__GNUC__) && defined(__ATOMIC_ACQ_REL)
    if(__atomic_is_lock_free(sizeof *val, val))
        return __atomic_add_fetch(val, amount, __ATOMIC_ACQ_REL);
#elif defined(_MSC_VER)
    return InterlockedExchangeAdd(val, amount)+amount;
#endif
    CRYPTO_THREAD_write_lock(lock);
    ret=(*val+=amount);
    CRYPTO_THREAD_unlock(lock);
    return ret;
}
