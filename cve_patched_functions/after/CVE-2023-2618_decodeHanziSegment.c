void DecodedBitStreamParser::decodeHanziSegment(Ref<BitSource> bits_, string& result, int count,
                                                ErrorHandler& err_handler) {
    BitSource& bits(*bits_);
    // Don't crash trying to read more bits than we have available.
    if (count * 13 > bits.available()) {
        err_handler = zxing::FormatErrorHandler("decodeKanjiSegment");
        return;
    }

    // Each character will require 2 bytes. Read the characters as 2-byte pairs
    // and decode as GB2312 afterwards
    size_t nBytes = 2 * count;
    char* buffer = new char[nBytes];
    int offset = 0;
    while (count > 0) {
        // Each 13 bits encodes a 2-byte character
        int twoBytes = bits.readBits(13, err_handler);
        if (err_handler.ErrCode()) {
            delete[] buffer;
            return;
        }
        int assembledTwoBytes = ((twoBytes / 0x060) << 8) | (twoBytes % 0x060);
        if (assembledTwoBytes < 0x003BF) {
            // In the 0xA1A1 to 0xAAFE range
            assembledTwoBytes += 0x0A1A1;
        } else {
            // In the 0xB0A1 to 0xFAFE range
            assembledTwoBytes += 0x0A6A1;
        }
        buffer[offset] = (char)((assembledTwoBytes >> 8) & 0xFF);
        buffer[offset + 1] = (char)(assembledTwoBytes & 0xFF);
        offset += 2;
        count--;
    }
    // for(int i=0;i<nBytes;i++)
    // cout<<buffer[i]<<endl;
    append(result, buffer, nBytes, err_handler);
    if (err_handler.ErrCode()) {
        delete[] buffer;
        return;
    }

    delete[] buffer;
}
