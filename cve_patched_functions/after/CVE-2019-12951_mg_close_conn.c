void mg_close_conn(struct mg_connection *conn) {
  /* See if there's any remaining data to deliver. Skip if user completely
   * throttled the connection there will be no progress anyway. */
  if (conn->sock != INVALID_SOCKET && mg_do_recv(conn) == -2) {
    /* Receive is throttled, wait. */
    conn->flags |= MG_F_RECV_AND_CLOSE;
    return;
  }
#if MG_ENABLE_SSL
  if (conn->flags & MG_F_SSL_HANDSHAKE_DONE) {
    mg_ssl_if_conn_close_notify(conn);
  }
#endif
  /*
   * Clearly mark the connection as going away (if not already).
   * Some net_if impls (LwIP) need this for cleanly handling half-dead conns.
   */
  conn->flags |= MG_F_CLOSE_IMMEDIATELY;
  mg_remove_conn(conn);
  conn->iface->vtable->destroy_conn(conn);
  mg_call(conn, NULL, conn->user_data, MG_EV_CLOSE, NULL);
  mg_destroy_conn(conn, 0 /* destroy_if */);
}
