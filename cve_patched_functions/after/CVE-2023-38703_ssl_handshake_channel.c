static pj_status_t ssl_handshake_channel(dtls_srtp *ds, unsigned idx)
{
    pj_status_t status;
    int err;

    DTLS_LOCK(ds);

    /* Init DTLS (if not yet) */
    status = ssl_create(ds, idx);
    if (status != PJ_SUCCESS) {
        DTLS_UNLOCK(ds);
        return status;
    }

    /* Check if handshake has been initiated or even completed */
    if (ds->nego_started[idx] || SSL_is_init_finished(ds->ossl_ssl[idx])) {
        DTLS_UNLOCK(ds);
        return PJ_SUCCESS;
    }

    /* Perform SSL handshake */
    if (ds->setup == DTLS_SETUP_ACTIVE) {
        SSL_set_connect_state(ds->ossl_ssl[idx]);
    } else {
        SSL_set_accept_state(ds->ossl_ssl[idx]);
    }
    err = SSL_do_handshake(ds->ossl_ssl[idx]);
    if (err < 0) {
        err = SSL_get_error(ds->ossl_ssl[idx], err);

        DTLS_UNLOCK(ds);

        if (err == SSL_ERROR_WANT_READ) {
            status = ssl_flush_wbio(ds, idx);
            if (status != PJ_SUCCESS)
                goto on_return;
        } else if (err != SSL_ERROR_NONE) {
            /* Handshake fails */
            status = STATUS_FROM_SSL_ERR(ds, err);
            pj_perror(2, ds->base.name, status, "SSL_do_handshake() error");
            goto on_return;
        }
    } else {
        DTLS_UNLOCK(ds);
    }

    /* Create and start clock @4Hz for retransmission */
    if (!ds->clock[idx]) {
        ds->channel[idx].dtls_srtp = ds;
        ds->channel[idx].channel = idx;
        status = pjmedia_clock_create(ds->pool, 4, 1, 1,
                                      PJMEDIA_CLOCK_NO_HIGHEST_PRIO, clock_cb,
                                      &ds->channel[idx], &ds->clock[idx]);
        if (status != PJ_SUCCESS)
            goto on_return;
    }    
    status = pjmedia_clock_start(ds->clock[idx]);
    if (status != PJ_SUCCESS)
        goto on_return;

    /* Finally, DTLS nego started! */
    ds->nego_started[idx] = PJ_TRUE;
    PJ_LOG(4,(ds->base.name, "DTLS-SRTP %s negotiation initiated as %s",
              CHANNEL_TO_STRING(idx),
              (ds->setup==DTLS_SETUP_ACTIVE? "client":"server")));

on_return:
    if (status != PJ_SUCCESS) {
        if (ds->clock[idx])
            pjmedia_clock_stop(ds->clock[idx]);
    }
    return status;
}
