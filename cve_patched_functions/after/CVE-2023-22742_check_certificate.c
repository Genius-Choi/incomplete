static int check_certificate(
	LIBSSH2_SESSION *session,
	LIBSSH2_KNOWNHOSTS *known_hosts,
	git_transport_certificate_check_cb check_cb,
	void *check_cb_payload,
	const char *host,
	int port)
{
	git_cert_hostkey cert = {{ 0 }};
	const char *key;
	size_t cert_len;
	int cert_type, cert_valid = 0, error = 0;

	if ((key = libssh2_session_hostkey(session, &cert_len, &cert_type)) == NULL) {
		ssh_error(session, "failed to retrieve hostkey");
		return -1;
	}

	if ((cert_valid = check_against_known_hosts(session, known_hosts, host, port, key, cert_len, cert_type)) < 0)
		return -1;

	cert.parent.cert_type = GIT_CERT_HOSTKEY_LIBSSH2;
	if (key != NULL) {
		cert.type |= GIT_CERT_SSH_RAW;
		cert.hostkey = key;
		cert.hostkey_len = cert_len;
		switch (cert_type) {
		case LIBSSH2_HOSTKEY_TYPE_RSA:
			cert.raw_type = GIT_CERT_SSH_RAW_TYPE_RSA;
			break;
		case LIBSSH2_HOSTKEY_TYPE_DSS:
			cert.raw_type = GIT_CERT_SSH_RAW_TYPE_DSS;
			break;

#ifdef LIBSSH2_HOSTKEY_TYPE_ECDSA_256
		case LIBSSH2_HOSTKEY_TYPE_ECDSA_256:
			cert.raw_type = GIT_CERT_SSH_RAW_TYPE_KEY_ECDSA_256;
			break;
		case LIBSSH2_HOSTKEY_TYPE_ECDSA_384:
			cert.raw_type = GIT_CERT_SSH_RAW_TYPE_KEY_ECDSA_384;
			break;
		case LIBSSH2_KNOWNHOST_KEY_ECDSA_521:
			cert.raw_type = GIT_CERT_SSH_RAW_TYPE_KEY_ECDSA_521;
			break;
#endif

#ifdef LIBSSH2_HOSTKEY_TYPE_ED25519
		case LIBSSH2_HOSTKEY_TYPE_ED25519:
			cert.raw_type = GIT_CERT_SSH_RAW_TYPE_KEY_ED25519;
			break;
#endif
		default:
			cert.raw_type = GIT_CERT_SSH_RAW_TYPE_UNKNOWN;
		}
	}

#ifdef LIBSSH2_HOSTKEY_HASH_SHA256
	key = libssh2_hostkey_hash(session, LIBSSH2_HOSTKEY_HASH_SHA256);
	if (key != NULL) {
		cert.type |= GIT_CERT_SSH_SHA256;
		memcpy(&cert.hash_sha256, key, 32);
	}
#endif

	key = libssh2_hostkey_hash(session, LIBSSH2_HOSTKEY_HASH_SHA1);
	if (key != NULL) {
		cert.type |= GIT_CERT_SSH_SHA1;
		memcpy(&cert.hash_sha1, key, 20);
	}

	key = libssh2_hostkey_hash(session, LIBSSH2_HOSTKEY_HASH_MD5);
	if (key != NULL) {
		cert.type |= GIT_CERT_SSH_MD5;
		memcpy(&cert.hash_md5, key, 16);
	}

	if (cert.type == 0) {
		git_error_set(GIT_ERROR_SSH, "unable to get the host key");
		return -1;
	}

	git_error_clear();
	error = 0;
	if (!cert_valid) {
		git_error_set(GIT_ERROR_SSH, "invalid or unknown remote ssh hostkey");
		error = GIT_ECERTIFICATE;
	}

	if (check_cb != NULL) {
		git_cert_hostkey *cert_ptr = &cert;
		git_error_state previous_error = {0};

		git_error_state_capture(&previous_error, error);
		error = check_cb((git_cert *) cert_ptr, cert_valid, host, check_cb_payload);
		if (error == GIT_PASSTHROUGH) {
			error = git_error_state_restore(&previous_error);
		} else if (error < 0 && !git_error_last()) {
			git_error_set(GIT_ERROR_NET, "user canceled hostkey check");
		}

		git_error_state_free(&previous_error);
	}

	return error;
}
