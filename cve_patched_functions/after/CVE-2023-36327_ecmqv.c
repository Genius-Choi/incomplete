static int ecmqv(void) {
	int code = RLC_ERR;
	bn_t d1a, d1_b;
	bn_t d2a, d2_b;
	ec_t q1a, q1_b;
	ec_t q2a, q2_b;
	uint8_t key1[RLC_MD_LEN], key2[RLC_MD_LEN];

	bn_null(d1a);
	bn_null(d1_b);
	ec_null(q1a);
	ec_null(q1_b);
	bn_null(d2a);
	bn_null(d2_b);
	ec_null(q2a);
	ec_null(q2_b);

	RLC_TRY {
		bn_new(d1a);
		bn_new(d1_b);
		ec_new(q1a);
		ec_new(q1_b);
		bn_new(d2a);
		bn_new(d2_b);
		ec_new(q2a);
		ec_new(q2_b);

		TEST_CASE("ecmqv authenticated key agreement is correct") {
			TEST_ASSERT(cp_ecmqv_gen(d1a, q1a) == RLC_OK, end);
			TEST_ASSERT(cp_ecmqv_gen(d2a, q2a) == RLC_OK, end);
			TEST_ASSERT(cp_ecmqv_gen(d1_b, q1_b) == RLC_OK, end);
			TEST_ASSERT(cp_ecmqv_gen(d2_b, q2_b) == RLC_OK, end);
			TEST_ASSERT(cp_ecmqv_key(key1, RLC_MD_LEN, d1_b, d2_b, q2_b, q1a,
							q2a) == RLC_OK, end);
			TEST_ASSERT(cp_ecmqv_key(key2, RLC_MD_LEN, d1a, d2a, q2a, q1_b,
							q2_b) == RLC_OK, end);
			TEST_ASSERT(memcmp(key1, key2, RLC_MD_LEN) == 0, end);
		} TEST_END;
	}
	RLC_CATCH_ANY {
		RLC_ERROR(end);
	}
	code = RLC_OK;

  end:
	bn_free(d1a);
	bn_free(d1_b);
	ec_free(q1a);
	ec_free(q1_b);
	bn_free(d2a);
	bn_free(d2_b);
	ec_free(q2a);
	ec_free(q2_b);
	return code;
}
