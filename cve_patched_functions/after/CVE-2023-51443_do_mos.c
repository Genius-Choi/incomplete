static void do_mos(switch_rtp_t *rtp_session) {
	int R;
	
	if ((switch_size_t)rtp_session->stats.inbound.recved < rtp_session->stats.inbound.flaws) {
		rtp_session->stats.inbound.flaws = 0;
	}

	if (rtp_session->stats.inbound.recved > 0 &&
		rtp_session->stats.inbound.flaws && (rtp_session->stats.inbound.last_flaw != rtp_session->stats.inbound.flaws)) {
		
		if (rtp_session->consecutive_flaws++) {
			int penalty = rtp_session->consecutive_flaws;

			switch_log_printf(SWITCH_CHANNEL_SESSION_LOG(rtp_session->session), SWITCH_LOG_DEBUG1, "%s %s %d consecutive flaws, adding %d flaw penalty\n",
							  rtp_session_name(rtp_session), rtp_type(rtp_session),
							  rtp_session->consecutive_flaws, penalty);
			rtp_session->bad_stream++;
			rtp_session->stats.inbound.flaws += penalty;
			rtp_session->stats.inbound.last_flaw = rtp_session->stats.inbound.flaws;
			
			if (rtp_session->stats.inbound.error_log) {
				rtp_session->stats.inbound.error_log->flaws += penalty;
				rtp_session->stats.inbound.error_log->consecutive_flaws++;
			}
		}
	} else {
		rtp_session->consecutive_flaws = 0;
	}

	R = (int)((double)((double)(rtp_session->stats.inbound.recved - rtp_session->stats.inbound.flaws) / (double)rtp_session->stats.inbound.recved) * 100.0);

	if (R < 0 || R > 100) R = 100;

	rtp_session->stats.inbound.R = R;
	rtp_session->stats.inbound.mos = 1 + (0.035) * R + (.000007) * R * (R-60) * (100-R);
		
	switch_log_printf(SWITCH_CHANNEL_SESSION_LOG(rtp_session->session), SWITCH_LOG_DEBUG3, "%s %s stat %0.2f %ld/%d flaws: %ld mos: %0.2f v: %0.2f %0.2f/%0.2f\n",
					  rtp_session_name(rtp_session),
					  rtp_type(rtp_session),
					  rtp_session->stats.inbound.R,
					  (long int)(rtp_session->stats.inbound.recved - rtp_session->stats.inbound.flaws), rtp_session->stats.inbound.recved,
					  (long int)rtp_session->stats.inbound.flaws,
					  rtp_session->stats.inbound.mos,
					  rtp_session->stats.inbound.variance,
					  rtp_session->stats.inbound.min_variance,
					  rtp_session->stats.inbound.max_variance
					  );
	
}
