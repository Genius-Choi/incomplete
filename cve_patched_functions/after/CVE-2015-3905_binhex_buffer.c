binhex_buffer(const byte *s, int len, FILE *f)
{
  static int col = 1;
  static int bits = 0;
  static int bitspos = 2;
  static const char *table = "!\"#$%&'()*+,-012345689@ABCDEFGHIJKLMNPQRSTUVXYZ[`abcdefhijklmpqr";
  byte buf[5];
  int c, i, left;

  if (!s && bitspos > 2) {	/* output the remaining bits */
    s = (const byte *)"\0";
    len = 1;
  }

  for (left = len; left > 0; left--, s++) {
    int pos;
    if (s[0] == 0x90) {
      buf[0] = 0x90;
      buf[1] = 0x00;
      pos = 2;
    } else {
      buf[0] = s[0];
      pos = 1;
    }

    /* find a run */
    if (left > 2 && s[0] == s[1] && s[0] == s[2]) {
      for (i = 3; i < left && i < 255; i++)
	if (s[i] != s[0])
	  break;
      buf[pos] = 0x90;
      buf[pos+1] = i;
      pos += 2;
      s += i - 1;
      left -= i - 1;
    }

    /* store those characters */
    for (i = 0; i < pos; i++) {
      bits |= buf[i];
      while (bitspos >= 0) {
	c = (bits >> bitspos) & 0x3F;
	putc(table[c], f);
	if (++col == 63) {
	  putc('\n', f);
	  col = 0;
	}
	bitspos -= 6;
      }
      bits <<= 8;
      bitspos += 8;
    }
  }
}
