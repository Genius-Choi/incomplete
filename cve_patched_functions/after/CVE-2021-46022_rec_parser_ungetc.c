rec_parser_ungetc (rec_parser_t parser,
                   int ci)
{
  int res;

  /* Update statistics.  */
  parser->character--;
  if (((char) ci) == '\n')
    parser->line--;

  /* Unread the character, depending on the backend used (memory or
     file).  */
  if (parser->in_file)
    {
      res = ungetc (ci, parser->in_file);
      if (res != ci)
        parser->error = REC_PARSER_EUNGETC;
    }
  else if (parser->in_buffer)
    {
      if (parser->p > parser->in_buffer)
        {
          res = ci; /* Emulate ungetc. */
          parser->p--;
        }
      else
        {
          res = EOF;
          parser->error = REC_PARSER_EUNGETC;
        }
    }
  else
    {
      /* This point should not be reached!  */
      fprintf (stderr, "rec_parser_ungetc: no backend in parser. This is a bug.\
  Please report it.");
      return EOF;
    }

  return res;
}
