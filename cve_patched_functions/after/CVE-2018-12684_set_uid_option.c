set_uid_option(struct mg_context *phys_ctx)
{
	int success = 0;

	if (phys_ctx) {
		/* We are currently running as curr_uid. */
		const uid_t curr_uid = getuid();
		/* If set, we want to run as run_as_user. */
		const char *run_as_user = phys_ctx->dd.config[RUN_AS_USER];
		const struct passwd *to_pw = NULL;

		if (run_as_user != NULL && (to_pw = getpwnam(run_as_user)) == NULL) {
			/* run_as_user does not exist on the system. We can't proceed
			 * further. */
			mg_cry_internal(fc(phys_ctx),
			                "%s: unknown user [%s]",
			                __func__,
			                run_as_user);
		} else if (run_as_user == NULL || curr_uid == to_pw->pw_uid) {
			/* There was either no request to change user, or we're already
			 * running as run_as_user. Nothing else to do.
			 */
			success = 1;
		} else {
			/* Valid change request.  */
			if (setgid(to_pw->pw_gid) == -1) {
				mg_cry_internal(fc(phys_ctx),
				                "%s: setgid(%s): %s",
				                __func__,
				                run_as_user,
				                strerror(errno));
			} else if (setgroups(0, NULL) == -1) {
				mg_cry_internal(fc(phys_ctx),
				                "%s: setgroups(): %s",
				                __func__,
				                strerror(errno));
			} else if (setuid(to_pw->pw_uid) == -1) {
				mg_cry_internal(fc(phys_ctx),
				                "%s: setuid(%s): %s",
				                __func__,
				                run_as_user,
				                strerror(errno));
			} else {
				success = 1;
			}
		}
	}

	return success;
}
