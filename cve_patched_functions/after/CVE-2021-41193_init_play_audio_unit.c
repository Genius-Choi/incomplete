    int32_t audio_io_osx::init_play_audio_unit() {
        OSStatus result = -1;
        
        AudioUnit auTmp = au_rec_;
        
        info("audio_io_osx: InitAuPlay two_devices_ = %d \n", two_devices_);
        
        // Check if already initialized
        if (NULL != au_play_) {
            info("audio_io_osx: Already initialized \n");
            return 0;
        }
        
        if( output_device_id_ == kAudioObjectUnknown){
            error("audio_io_osx: invalid _outputDeviceID \n");
        }
        
        Float64 nominal_sample_rate;
        UInt32 info_size = sizeof(nominal_sample_rate);
        
        static const AudioObjectPropertyAddress kNominalSampleRateAddress = {
            kAudioDevicePropertyNominalSampleRate,
            kAudioObjectPropertyScopeGlobal,
            kAudioObjectPropertyElementMaster
        };
        result = AudioObjectGetPropertyData(output_device_id_,
                                            &kNominalSampleRateAddress,
                                            0,
                                            0,
                                            &info_size,
                                            &nominal_sample_rate);
        if (result != noErr) {
            error("audio_io_osx: Failed to get device nominal sample rate for playback AudioUnit \n");
        }
        
        // Start by obtaining an AudioOuputUnit using an AUHAL component description.
        if(two_devices_){ // Two devices needs two Audio Units
            AudioComponent comp;
            AudioComponentDescription desc;
            
            // Description for the Audio Unit we want to use (AUHAL in this case).
            desc.componentType = kAudioUnitType_Output;
            desc.componentSubType = kAudioUnitSubType_HALOutput;
            desc.componentManufacturer = kAudioUnitManufacturer_Apple;
            desc.componentFlags = 0;
            desc.componentFlagsMask = 0;
            comp = AudioComponentFindNext(0, &desc);
            
            // Get access to the service provided by the specified Audio Unit.
            result = AudioComponentInstanceNew(comp, &au_play_);
            if (result) {
                error("audio_io_osx: Cannot open playback AudioUnit \n");
            }
            auTmp = au_play_;
        }
        
        UInt32 enableIO = 0;
        if( two_devices_){
            // Disable input on the AUHAL.
            result = AudioUnitSetProperty(auTmp,
                                          kAudioOutputUnitProperty_EnableIO,
                                          kAudioUnitScope_Input,
                                          1,          // input element 1
                                          &enableIO,  // enable
                                          sizeof(enableIO));
            if (result) {
                error("audio_io_osx: Cannot disable input for playback AudioUnit \n");
            }
        }
        
        // Enable output on the AUHAL.
        enableIO = 1;
        result = AudioUnitSetProperty(auTmp,
                                      kAudioOutputUnitProperty_EnableIO,
                                      kAudioUnitScope_Output,
                                      0,          // output element 0
                                      &enableIO,  // disable
                                      sizeof(enableIO));
        if (result) {
            error("audio_io_osx: Cannot enable output for playback AudioUnit \n");
        }
        
        result = AudioUnitSetProperty(auTmp,
                                      kAudioOutputUnitProperty_CurrentDevice,
                                      kAudioUnitScope_Global,
                                      0,
                                      &output_device_id_,
                                      sizeof(output_device_id_));
        if (result) {
            error("audio_io_osx: Cannot set audio device for playback AudioUnit \n");
        }
        
        AURenderCallbackStruct callback;
        callback.inputProc = play_process;
        callback.inputProcRefCon = this;
        result = AudioUnitSetProperty(auTmp,
                                      kAudioUnitProperty_SetRenderCallback,
                                      kAudioUnitScope_Global,
                                      0,
                                      &callback,
                                      sizeof(callback));
        if (result) {
            error("audio_io_osx: Cannot set callback for playback AudioUnit \n");
        }
        
        AudioStreamBasicDescription format_;
        UInt32 size = sizeof(format_);
        result = AudioUnitGetProperty(auTmp,
                                      kAudioUnitProperty_StreamFormat,
                                      kAudioUnitScope_Input, 0, &format_,
                                      &size);
        if (result) {
            error("audio_io_osx: Cannot get stream properties for playback AudioUnit \n");
        }
        
        format_.mSampleRate = (int)nominal_sample_rate;
        format_.mFormatID = kAudioFormatLinearPCM;
        format_.mFormatFlags = kLinearPCMFormatFlagIsPacked |
        kLinearPCMFormatFlagIsSignedInteger;
        format_.mBitsPerChannel = sizeof(SInt16) * 8;
        format_.mFramesPerPacket = 1;  // uncompressed audio
        format_.mBytesPerPacket = (format_.mBitsPerChannel *
                                   format_.mChannelsPerFrame) / 8;
        format_.mBytesPerFrame = format_.mBytesPerPacket;
        format_.mReserved = 0;
        
        result = AudioUnitSetProperty(auTmp,
                                      kAudioUnitProperty_StreamFormat,
                                      kAudioUnitScope_Input,
                                      0,
                                      &format_,
                                      sizeof(format_));
        if (result) {
            error("audio_io_osx: Cannot set stream properties for playback AudioUnit \n");
        }
        
        play_fs_hz_ = format_.mSampleRate;
        
        UInt32 buffer_size = 0;
        UInt32 property_size = sizeof(buffer_size);
        result = AudioUnitGetProperty(auTmp,
                                      kAudioDevicePropertyBufferFrameSize,
                                      kAudioUnitScope_Output,
                                      1,
                                      &buffer_size,
                                      &property_size);
        if (result != noErr) {
            error("audio_io_osx: Cannot get callback buffer size for playback AudioUnit \n");
        }
        
        buffer_size = play_fs_hz_/100;
        result = AudioUnitSetProperty(auTmp,
                                      kAudioDevicePropertyBufferFrameSize,
                                      kAudioUnitScope_Output,
                                      1,
                                      &buffer_size,
                                      sizeof(buffer_size));
        if (result != noErr) {
            error("audio_io_osx: Cannot set callback buffer size for playback AudioUnit \n");
        }
        
        if(two_devices_){
            result = AudioUnitInitialize(au_play_);
            if (result) {
                error("audio_io_osx: Cannot initialize playback AudioUnit \n");
            }
        }
        
        return 0;
    }
