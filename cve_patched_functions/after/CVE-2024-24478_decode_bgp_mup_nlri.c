static int decode_bgp_mup_nlri(proto_tree *tree, tvbuff_t *tvb, gint offset, packet_info *pinfo, guint16 afi) {

    int reader_offset = offset;

    proto_tree *prefix_tree;
    proto_item *nlri_pi;
    proto_item *rd_pi;
    guint8 architecture_type;
    guint16 route_type;
    guint8 nlri_len;

    int decoded_length = 0;

    architecture_type = tvb_get_guint8(tvb, offset);
    route_type = tvb_get_guint16(tvb, offset + 1, ENC_BIG_ENDIAN);
    nlri_len = tvb_get_guint8(tvb, offset + 3);

    nlri_pi = proto_tree_add_item(tree, hf_bgp_mup_nlri, tvb, reader_offset, nlri_len+4, ENC_NA);

    prefix_tree = proto_item_add_subtree(nlri_pi, ett_bgp_mup_nlri);

    proto_tree_add_item(prefix_tree, hf_bgp_mup_nlri_at, tvb, reader_offset, 1, ENC_BIG_ENDIAN);
    proto_item_append_text(nlri_pi, ": %s", val_to_str(architecture_type, bgp_mup_architecture_types,
                           "Unknown architecture type %d"));
    reader_offset++;

    proto_tree_add_item(prefix_tree, hf_bgp_mup_nlri_rt, tvb, reader_offset, 2, ENC_BIG_ENDIAN);
    proto_item_append_text(nlri_pi, ": %s", val_to_str(route_type, bgp_mup_route_types,
                           "Unknown route type %d"));
    reader_offset += 2;

    proto_tree_add_item(prefix_tree, hf_bgp_mup_nlri_len, tvb, reader_offset, 1, ENC_BIG_ENDIAN);
    reader_offset++;

    switch (route_type) {
    case BGP_MUP_RT_INTERWORK_SEGMENT_DISCOVERY:
        /*
         +-----------------------------------+
         |           RD  (8 octets)          |
         +-----------------------------------+
         |       Prefix Length (1 octet)     |
         +-----------------------------------+
         |        Prefix (variable)          |
         +-----------------------------------+
        */
        rd_pi = proto_tree_add_item(prefix_tree, hf_bgp_mup_nlri_rd, tvb, reader_offset, 8, ENC_NA);
        proto_item_append_text(rd_pi, " (%s)", decode_bgp_rd(pinfo->pool, tvb, reader_offset));
        reader_offset += 8;

        decoded_length = decode_bgp_mup_nlri_variable_prefix(prefix_tree, tvb, reader_offset, pinfo, afi);
        if (decoded_length < 0) {
            return -1;
        }
        break;

    case BGP_MUP_RT_DIRECT_SEGMENT_DISCOVERY:
        /*
         +-----------------------------------+
         |           RD  (8 octets)          |
         +-----------------------------------+
         |        Address (4 or 16 octets)   |
         +-----------------------------------+
        */
        rd_pi = proto_tree_add_item(prefix_tree, hf_bgp_mup_nlri_rd, tvb, reader_offset, 8, ENC_NA);
        proto_item_append_text(rd_pi, " (%s)", decode_bgp_rd(pinfo->pool, tvb, reader_offset));
        reader_offset += 8;
        switch (afi) {
        case AFNUM_INET:
            proto_tree_add_item(prefix_tree, hf_bgp_mup_nlri_ip_addr, tvb, reader_offset, 4, ENC_NA);
            break;
        case AFNUM_INET6:
            proto_tree_add_item(prefix_tree, hf_bgp_mup_nlri_ipv6_addr, tvb, reader_offset, 16, ENC_NA);
            break;
        }
        break;

    case BGP_MUP_RT_TYPE_1_SESSION_TRANSFORMED:
        decoded_length = decode_bgp_mup_nlri_type1_st_route(prefix_tree, tvb, reader_offset, pinfo, afi, architecture_type);
        if (decoded_length < 0) {
            return -1;
        }
        break;

    case BGP_MUP_RT_TYPE_2_SESSION_TRANSFORMED:
        decoded_length = decode_bgp_mup_nlri_type2_st_route(prefix_tree, tvb, reader_offset, pinfo, afi, architecture_type);
        if (decoded_length < 0) {
            return -1;
        }
        break;

    default:
        /* for unknown route types, just decode as binary */
        proto_tree_add_item(prefix_tree, hf_bgp_mup_nlri_unknown_data, tvb, reader_offset, nlri_len, ENC_NA);
        reader_offset += nlri_len;
        proto_tree_add_expert_format(prefix_tree, pinfo, &ei_bgp_mup_unknown_rt, tvb, reader_offset, -1,
                                     "Unknown route type: %d", route_type);
        break;
    }

    return nlri_len+4;
}
