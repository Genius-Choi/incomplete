gpio_get_value(struct virtio_gpio *gpio, unsigned int offset)
{
	struct gpio_line *line;
	struct gpiohandle_data data;
	int rc, fd;

	line = gpio->vlines[offset];
	if (line->busy) {
		WPRINTF(("failed to get gpio %d value, it is busy\n", offset));
		return -1;
	}

	fd = line->fd;
	if (fd < 0) {

		/*
		 * if the GPIO line has configured as IRQ mode, then can't use
		 * gpio line fd to get its value, instead, use IRQ fd to get
		 * the value.
		 */
		if (line->irq->fd < 0) {
			WPRINTF(("failed to get gpio %d value, fd is invalid\n",
				offset));
			return -1;
		}
		fd = line->irq->fd;
	}

	memset(&data, 0, sizeof(data));
	rc = ioctl(fd, GPIOHANDLE_GET_LINE_VALUES_IOCTL, &data);
	if (rc < 0) {
		WPRINTF(("ioctl GPIOHANDLE_GET_LINE_VALUES_IOCTL error %s\n",
				strerror(errno)));
		return -1;
	}
	return data.values[0];
}
