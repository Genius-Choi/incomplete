MOBI_RET mobi_cp1252_to_utf8(char *output, const char *input, size_t *outsize, const size_t insize) {
    if (!output || !input) {
        return MOBI_PARAM_ERR;
    }
    const unsigned char *in = (unsigned char *) input;
    unsigned char *out = (unsigned char *) output;
    const unsigned char *outend = out + *outsize - 1; /* leave space for null terminator */
    const unsigned char *inend = in + insize;
    while (in < inend && out < outend && *in) {
        if (*in < 0x80) {
           *out++ = *in++;
        }
        else if (*in < 0xa0) {
            /* table lookup */
            size_t i = 0;
            while (i < 3 && out < outend) {
                unsigned char c = cp1252_to_utf8[*in - 0x80][i];
                if (c == 0) {
                    break;
                }
                *out++ = c;
                i++;
            }
            if (i == 0) {
                /* unmappable character in input */
                /* substitute with utf-8 replacement character */
                if (out >= outend - 1) { break; }
                *out++ = 0xff;
                *out++ = 0xfd;
                debug_print("Invalid character found: %c\n", *in);
            }
            in++;
        }
        else if (*in < 0xc0) {
            if (out >= outend - 1) { break; }
            *out++ = 0xc2;
            *out++ = *in++;
        }
        else {
            if (out >= outend - 1) { break; }
            *out++ = 0xc3;
            *out++ = (*in++ & 0x3f) + 0x80;
        }
    }
    *out = '\0';
    *outsize = (size_t) (out - (unsigned char *) output);
    return MOBI_SUCCESS;
}
