struct mg_connection *mg_connect_http_base(
    struct mg_mgr *mgr, MG_CB(mg_event_handler_t ev_handler, void *user_data),
    struct mg_connect_opts opts, const char *schema, const char *schema_ssl,
    const char *url, const char **path, char **user, char **pass, char **addr) {
  struct mg_connection *nc = NULL;
  int port_i = -1;
  int use_ssl = 0;

  if (mg_http_common_url_parse(url, schema, schema_ssl, &use_ssl, user, pass,
                               addr, &port_i, path) < 0) {
    MG_SET_PTRPTR(opts.error_string, "cannot parse url");
    return NULL;
  }

  LOG(LL_DEBUG, ("%s use_ssl? %d", url, use_ssl));
  if (use_ssl) {
#if MG_ENABLE_SSL
    /*
     * Schema requires SSL, but no SSL parameters were provided in opts.
     * In order to maintain backward compatibility, use a faux-SSL with no
     * verification.
     */
    if (opts.ssl_ca_cert == NULL) {
      opts.ssl_ca_cert = "*";
    }
#else
    MG_SET_PTRPTR(opts.error_string, "ssl is disabled");
    if (user != NULL) MG_FREE(*user);
    if (pass != NULL) MG_FREE(*pass);
    MG_FREE(*addr);
    return NULL;
#endif
  }

  if ((nc = mg_connect_opt(mgr, *addr, MG_CB(ev_handler, user_data), opts)) !=
      NULL) {
    mg_set_protocol_http_websocket(nc);
    /* If the port was addred by us, restore the original host. */
    if (port_i >= 0) (*addr)[port_i] = '\0';
  }

  return nc;
}
