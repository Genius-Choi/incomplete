rb_xml_reader_attribute_nodes(VALUE rb_reader)
{
  xmlTextReaderPtr c_reader;
  xmlNodePtr c_node;
  VALUE attr_nodes;
  int j;

  // TODO: deprecated, remove in Nokogiri v1.15, see https://github.com/sparklemotion/nokogiri/issues/2598
  // After removal, we can also remove all the "node_has_a_document" special handling from xml_node.c
  NOKO_WARN_DEPRECATION("Reader#attribute_nodes is deprecated and will be removed in a future version of Nokogiri. Please use Reader#attribute_hash instead.");

  Data_Get_Struct(rb_reader, xmlTextReader, c_reader);

  if (! has_attributes(c_reader)) {
    return rb_ary_new() ;
  }

  c_node = xmlTextReaderExpand(c_reader);
  if (c_node == NULL) {
    return Qnil;
  }

  attr_nodes = noko_xml_node_attrs(c_node);

  /* ensure that the Reader won't be GCed as long as a node is referenced */
  for (j = 0 ; j < RARRAY_LEN(attr_nodes) ; j++) {
    rb_iv_set(rb_ary_entry(attr_nodes, j), "@reader", rb_reader);
  }

  return attr_nodes;
}
