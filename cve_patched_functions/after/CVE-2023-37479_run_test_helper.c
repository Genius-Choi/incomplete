int run_test_helper(const char* test_name, libc_test_function_t test_function)
{
    extern char** __environ;
    char** environ = NULL;
    int ret = 1;

    /* Print running message. */
    printf("=== running: %s\n", test_name);

#if defined(XMM_OK)
    /* Reset the FXSAVE state between tests.
     * The original libc tests for floating point math were compiled as
     * individual executables and assume ABI-initialized floating point and
     * MXCSR state. Since the enclave runs multiple tests in the same enclave
     * consecutively, we reset the FXSAVE state on each run. */
    _reset_fxsave_state();
#endif

    /* Disable Open Enclave debug malloc checks. */
    extern bool oe_disable_debug_malloc_check;
    oe_disable_debug_malloc_check = true;

    /* Allocate an environment for invoking the test. */
    if (!(environ = (char**)calloc(1, sizeof(char*))))
        goto done;

    memset(environ, 0, sizeof(char**));
    __environ = environ;

    /* Run the test */
    const char* argv[] = {"test", NULL};

    if (test_function(1, argv) != 0)
    {
        /* Prevent cascading of false negatives. */
        t_status = 0;

        fprintf(stderr, "*** failed: %s\n", test_name);
        goto done;
    }

    ret = 0;

done:

    free(environ);
    __environ = NULL;

    return ret;
}
