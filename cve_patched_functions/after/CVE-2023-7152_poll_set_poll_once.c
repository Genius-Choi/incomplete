STATIC mp_uint_t poll_set_poll_once(poll_set_t *poll_set, size_t *rwx_num) {
    mp_uint_t n_ready = 0;
    for (mp_uint_t i = 0; i < poll_set->map.alloc; ++i) {
        if (!mp_map_slot_is_filled(&poll_set->map, i)) {
            continue;
        }

        poll_obj_t *poll_obj = MP_OBJ_TO_PTR(poll_set->map.table[i].value);

        #if MICROPY_PY_SELECT_POSIX_OPTIMISATIONS
        if (poll_obj->pollfd != NULL) {
            // Object has file descriptor so will be polled separately by poll().
            continue;
        }
        #endif

        int errcode;
        mp_int_t ret = poll_obj->ioctl(poll_obj->obj, MP_STREAM_POLL, poll_obj_get_events(poll_obj), &errcode);
        poll_obj_set_revents(poll_obj, ret);

        if (ret == -1) {
            // error doing ioctl
            mp_raise_OSError(errcode);
        }

        if (ret != 0) {
            // object is ready
            n_ready += 1;
            #if MICROPY_PY_SELECT_SELECT
            if (rwx_num != NULL) {
                if (ret & MP_STREAM_POLL_RD) {
                    rwx_num[0] += 1;
                }
                if (ret & MP_STREAM_POLL_WR) {
                    rwx_num[1] += 1;
                }
                if ((ret & ~(MP_STREAM_POLL_RD | MP_STREAM_POLL_WR)) != 0) {
                    rwx_num[2] += 1;
                }
            }
            #else
            (void)rwx_num;
            #endif
        }
    }
    return n_ready;
}
