alloc_connection(struct trans *t)
{
    struct sesman_con *result;
    struct SCP_SESSION *s;

    if ((result = g_new(struct sesman_con, 1)) != NULL)
    {
        if ((s = scp_session_create()) != NULL)
        {
            result->t = t;
            result->s = s;
            /* Ensure we can find the connection easily from a callback */
            t->callback_data = (void *)result;
        }
        else
        {
            g_free(result);
            result = NULL;
        }
    }

    return result;
}
