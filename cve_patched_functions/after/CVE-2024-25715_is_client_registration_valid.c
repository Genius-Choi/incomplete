static json_t * is_client_registration_valid(struct _oidc_config * config, json_t * j_registration, const char * client_id) {
  json_t * j_error = NULL, * j_return, * j_element = NULL, * j_authorization_details, * j_resp = NULL, * j_info = r_library_info_json_t(), * j_response_modes_supported = NULL, * j_enc_list;
  size_t index = 0;
  jwks_t * jwks = NULL;
  const char * resource = NULL, * response_mode = NULL, * key = NULL;
  struct _u_request req;
  struct _u_response resp;
  int auth_detail_found;
  memset(&req, 0, sizeof(struct _u_request));
  memset(&resp, 0, sizeof(struct _u_response));

  if (json_object_get(config->j_params, "oauth-fapi-allow-restrict-alg") == json_true()) {
    j_enc_list = json_object_get(config->j_params, "oauth-fapi-restrict-alg");
  } else {
    j_enc_list = json_object_get(json_object_get(j_info, "jwe"), "alg");
  }

  do {
    if (!json_is_object(j_registration)) {
      j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "registration parameter must be a JSON object");
      break;
    }
    if (json_object_get(j_registration, "token_endpoint_auth_method") != NULL &&
        0 != o_strcmp("none", json_string_value(json_object_get(j_registration, "token_endpoint_auth_method"))) &&
        0 != o_strcmp("client_secret_post", json_string_value(json_object_get(j_registration, "token_endpoint_auth_method"))) &&
        0 != o_strcmp("client_secret_basic", json_string_value(json_object_get(j_registration, "token_endpoint_auth_method"))) &&
        0 != o_strcmp("client_secret_jwt", json_string_value(json_object_get(j_registration, "token_endpoint_auth_method"))) &&
        0 != o_strcmp("private_key_jwt", json_string_value(json_object_get(j_registration, "token_endpoint_auth_method")))) {
      j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "token_endpoint_auth_method must have one of the following values: 'none', 'client_secret_post', 'client_secret_basic', 'client_secret_jwt', 'private_key_jwt'");
      break;
    }
    if (client_id != NULL && 0 != o_strcmp(client_id, json_string_value(json_object_get(j_registration, "client_id")))) {
      j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "Invalid client_id");
      break;
    }
    if (json_object_get(j_registration, "grant_types") != NULL && !json_is_array(json_object_get(j_registration, "grant_types"))) {
      j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "grant_types is optional and must be an array of strings");
      break;
    }
    json_array_foreach(json_object_get(j_registration, "grant_types"), index, j_element) {
      if (0 != o_strcmp("authorization_code", json_string_value(j_element)) &&
          0 != o_strcmp("implicit", json_string_value(j_element)) &&
          0 != o_strcmp("password", json_string_value(j_element)) &&
          0 != o_strcmp("client_credentials", json_string_value(j_element)) &&
          0 != o_strcmp("refresh_token", json_string_value(j_element)) &&
          0 != o_strcmp("delete_token", json_string_value(j_element)) &&
          0 != o_strcmp("device_authorization", json_string_value(j_element)) &&
          0 != o_strcmp(GLEWLWYD_CIBA_GRANT_TYPE, json_string_value(j_element))) {
        if (j_error == NULL) {
          j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "grant_types must have one of the following values: 'authorization_code', 'implicit', 'password', 'client_credentials', 'refresh_token', 'delete_token', 'device_authorization', '" GLEWLWYD_CIBA_GRANT_TYPE "'");
        }
      }
    }
    if (j_error != NULL) {
      break;
    }
    if (json_object_get(j_registration, "response_types") != NULL && !json_is_array(json_object_get(j_registration, "response_types"))) {
      j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "response_types is optional and must be an array of strings");
      break;
    }
    json_array_foreach(json_object_get(j_registration, "response_types"), index, j_element) {
      if (0 != o_strcmp("code", json_string_value(j_element)) &&
          0 != o_strcmp("token", json_string_value(j_element)) &&
          0 != o_strcmp("id_token", json_string_value(j_element))) {
        if (j_error == NULL) {
          j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "response_types must have one of the following values: 'code', 'token', 'id_token'");
        }
      }
    }
    if (j_error != NULL) {
      break;
    }
    if (!json_array_size(json_object_get(j_registration, "redirect_uris"))) {
      j_error = json_pack("{ssss}", "error", "invalid_redirect_uri", "error_description", "redirect_uris is mandatory and must be an array of strings");
      break;
    }
    json_array_foreach(json_object_get(j_registration, "redirect_uris"), index, j_element) {
      if (!is_redirect_uri_valid_without_credential(json_string_value(j_element)) ||
         (0 != o_strncmp("https://", json_string_value(j_element), o_strlen("https://")) &&
          0 != o_strncmp(GLEWLWYD_REDIRECT_URI_LOOPBACK_1, json_string_value(j_element), o_strlen(GLEWLWYD_REDIRECT_URI_LOOPBACK_1)) &&
          0 != o_strncmp(GLEWLWYD_REDIRECT_URI_LOOPBACK_2, json_string_value(j_element), o_strlen(GLEWLWYD_REDIRECT_URI_LOOPBACK_2)) &&
          0 != o_strncmp(GLEWLWYD_REDIRECT_URI_LOOPBACK_3, json_string_value(j_element), o_strlen(GLEWLWYD_REDIRECT_URI_LOOPBACK_3)))) {
        if (j_error == NULL) {
          j_error = json_pack("{ssss}", "error", "invalid_redirect_uri", "error_description", "a redirect_uri must be a 'https://' uri or a 'http://localhost' uri without credentials");
        }
      }
    }
    if (j_error != NULL) {
      break;
    }
    if (json_object_get(j_registration, "application_type") != NULL && 0 != o_strcmp("web", json_string_value(json_object_get(j_registration, "application_type"))) && 0 != o_strcmp("native", json_string_value(json_object_get(j_registration, "application_type")))) {
      j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "application_type is optional and must have one of the following values: 'web', 'native'");
      break;
    }
    if (json_object_get(j_registration, "contacts") != NULL && !json_is_array(json_object_get(j_registration, "contacts"))) {
      j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "contacts is optional and must be an array of strings");
      break;
    }
    json_array_foreach(json_object_get(j_registration, "contacts"), index, j_element) {
      if (json_string_null_or_empty(j_element)) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "contact value must be a non empty string");
      }
    }
    if (j_error != NULL) {
      break;
    }
    if (json_object_get(j_registration, "client_confidential") != NULL && !json_is_boolean(json_object_get(j_registration, "client_confidential"))) {
      j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "client_confidential is optional and must be a boolean");
      break;
    }
    if (json_object_get(j_registration, "client_name") != NULL && !json_is_string(json_object_get(j_registration, "client_name"))) {
      j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "client_name is optional and must be a string");
      break;
    }
    if (json_object_get(j_registration, "logo_uri") != NULL && 0 != o_strncmp("https://", json_string_value(json_object_get(j_registration, "logo_uri")), o_strlen("https://")) && 0 != o_strncmp("http://", json_string_value(json_object_get(j_registration, "logo_uri")), o_strlen("http://"))) {
      j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "logo_uri is optional and must be a string");
      break;
    }
    if (json_object_get(j_registration, "client_uri") != NULL && 0 != o_strncmp("https://", json_string_value(json_object_get(j_registration, "client_uri")), o_strlen("https://")) && 0 != o_strncmp("http://", json_string_value(json_object_get(j_registration, "client_uri")), o_strlen("http://"))) {
      j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "client_uri is optional and must be a string");
      break;
    }
    if (json_object_get(j_registration, "policy_uri") != NULL && 0 != o_strncmp("https://", json_string_value(json_object_get(j_registration, "policy_uri")), o_strlen("https://")) && 0 != o_strncmp("http://", json_string_value(json_object_get(j_registration, "policy_uri")), o_strlen("http://"))) {
      j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "policy_uri is optional and must be a string");
      break;
    }
    if (json_object_get(j_registration, "tos_uri") != NULL && 0 != o_strncmp("https://", json_string_value(json_object_get(j_registration, "tos_uri")), o_strlen("https://")) && 0 != o_strncmp("http://", json_string_value(json_object_get(j_registration, "tos_uri")), o_strlen("http://"))) {
      j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "tos_uri is optional and must be a string");
      break;
    }
    if (0 == o_strcmp("private_key_jwt", json_string_value(json_object_get(j_registration, "token_endpoint_auth_method")))) {
      if (json_object_get(j_registration, "jwks_uri") != NULL && json_object_get(j_registration, "jwks") != NULL) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "jwks_uri and jwks can't coexist");
        break;
      }
      if (json_object_get(j_registration, "jwks_uri") != NULL) {
        if (0 != o_strncmp("https://", json_string_value(json_object_get(j_registration, "jwks_uri")), o_strlen("https://"))) {
          j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "jwks_uri is optional and must be an https:// uri");
          break;
        }
        r_jwks_init(&jwks);
        if (r_jwks_import_from_uri(jwks, json_string_value(json_object_get(j_registration, "jwks_uri")), config->x5u_flags) != RHN_OK) {
          j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "Invalid JWKS pointed by jwks_uri");
        } else {
          if (is_client_jwks_valid(config, jwks) != G_OK) {
            if (j_error == NULL) {
              j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "Invalid JWKS");
            }
          }
        }
        r_jwks_free(jwks);
        if (j_error != NULL) {
          break;
        }
      }
      if (json_object_get(j_registration, "jwks") != NULL) {
        r_jwks_init(&jwks);
        if (r_jwks_import_from_json_t(jwks, json_object_get(j_registration, "jwks")) != RHN_OK) {
          if (j_error == NULL) {
            j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "Invalid JWKS");
          }
        } else {
          if (is_client_jwks_valid(config, jwks) != G_OK) {
            if (j_error == NULL) {
              j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "Invalid JWKS");
            }
          }
        }
        r_jwks_free(jwks);
        if (j_error != NULL) {
          break;
        }
      }
    }
    if (json_object_get(j_registration, "sector_identifier_uri") != NULL &&
        0 != o_strncmp("https://", json_string_value(json_object_get(j_registration, "sector_identifier_uri")), o_strlen("https://"))) {
      j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "sector_identifier_uri is optional and must be an https:// uri");
      break;
    }
    if (json_object_get(j_registration, "sector_identifier_uri") != NULL &&
        0 == o_strcmp("pairwise", json_string_value(json_object_get(config->j_params, "subject-type")))) {
      if (ulfius_init_request(&req) == U_OK && ulfius_init_response(&resp) == U_OK) {
        if (ulfius_set_request_properties(&req, U_OPT_HTTP_VERB, "GET",
                                                U_OPT_HTTP_URL, json_string_value(json_object_get(j_registration, "sector_identifier_uri")),
                                                U_OPT_CHECK_SERVER_CERTIFICATE, (json_object_get(config->j_params, "request-uri-allow-https-non-secure")==json_true())?0:1,
                                                U_OPT_CHECK_PROXY_CERTIFICATE, (json_object_get(config->j_params, "request-uri-allow-https-non-secure")==json_true())?0:1,
                                                U_OPT_NONE) == U_OK) {
          if (ulfius_send_http_request_with_limit(&req, &resp, config->glewlwyd_config->glewlwyd_config->response_body_limit, config->glewlwyd_config->glewlwyd_config->max_header) == U_OK) {
            if (resp.status >= 200 && resp.status < 300) {
              if ((j_resp = ulfius_get_json_body_response(&resp, NULL)) != NULL && json_is_array(j_resp)) {
                json_array_foreach(j_resp, index, j_element) {
                  if (!is_redirect_uri_valid_without_credential(json_string_value(j_element)) ||
                     (0 != o_strncmp("https://", json_string_value(j_element), o_strlen("https://")) &&
                      0 != o_strncmp(GLEWLWYD_REDIRECT_URI_LOOPBACK_1, json_string_value(j_element), o_strlen(GLEWLWYD_REDIRECT_URI_LOOPBACK_1)) &&
                      0 != o_strncmp(GLEWLWYD_REDIRECT_URI_LOOPBACK_2, json_string_value(j_element), o_strlen(GLEWLWYD_REDIRECT_URI_LOOPBACK_2)) &&
                      0 != o_strncmp(GLEWLWYD_REDIRECT_URI_LOOPBACK_3, json_string_value(j_element), o_strlen(GLEWLWYD_REDIRECT_URI_LOOPBACK_3)))) {
                    if (j_error == NULL) {
                      j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "a redirect_uri pointed by sector_identifier_uri must be a 'https://' uri or a 'http://localhost' uri without credentials");
                    }
                  }
                }
                if (j_error != NULL) {
                  break;
                }
                json_array_foreach(json_object_get(j_registration, "redirect_uris"), index, j_element) {
                  if (!json_array_has_string(j_resp, json_string_value(j_element))) {
                    if (j_error == NULL) {
                      j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "a redirect_uri isn't present in the array pointed by sector_identifier_uri");
                    }
                  }
                }
                if (j_error != NULL) {
                  break;
                }
                if (json_string_value(json_object_get(j_registration, "backchannel_client_notification_endpoint")) != NULL &&
                    !json_array_has_string(j_resp, json_string_value(json_object_get(j_registration, "backchannel_client_notification_endpoint")))) {
                  j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "backchannel_client_notification_endpoint is not present in sector_identifier_uri content");
                  break;
                }
                if (json_string_value(json_object_get(j_registration, "post_logout_redirect_uri")) != NULL &&
                    !json_array_has_string(j_resp, json_string_value(json_object_get(j_registration, "post_logout_redirect_uri")))) {
                  j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "post_logout_redirect_uri is not present in sector_identifier_uri content");
                  break;
                }
                if (json_string_value(json_object_get(j_registration, "frontchannel_logout_uri")) != NULL &&
                    !json_array_has_string(j_resp, json_string_value(json_object_get(j_registration, "frontchannel_logout_uri")))) {
                  j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "frontchannel_logout_uri is not present in sector_identifier_uri content");
                  break;
                }
              } else {
                j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "Invalid sector_identifier_uri response data, must be a JSON array");
                break;
              }
            } else {
              j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "Invalid sector_identifier_uri response status");
              break;
            }
          } else {
            y_log_message(Y_LOG_LEVEL_ERROR, "is_client_registration_valid - Error ulfius_send_http_request_with_limit");
            j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "Invalid sector_identifier_uri");
            break;
          }
        } else {
          y_log_message(Y_LOG_LEVEL_ERROR, "is_client_registration_valid - Error ulfius_set_request_properties");
          j_error = json_pack("{ss}", "error", "server_error");
          break;
        }
      } else {
        y_log_message(Y_LOG_LEVEL_ERROR, "is_client_registration_valid - Error initializing request or response objects");
        j_error = json_pack("{ss}", "error", "server_error");
        break;
      }
    }
    if (json_object_get(config->j_params, "register-resource-specify-allowed") == json_true()) {
      if (json_object_get(j_registration, "resource") != NULL) {
        if (json_array_size(json_object_get(j_registration, "resource"))) {
          json_array_foreach(json_object_get(j_registration, "resource"), index, j_element) {
            resource = json_string_value(j_element);
            if (!is_redirect_uri_valid_without_credential(resource) ||
                (0 != o_strncmp("https://", resource, o_strlen("https://")) &&
                 0 != o_strncmp(GLEWLWYD_REDIRECT_URI_LOOPBACK_1, resource, o_strlen(GLEWLWYD_REDIRECT_URI_LOOPBACK_1)) &&
                 0 != o_strncmp(GLEWLWYD_REDIRECT_URI_LOOPBACK_2, resource, o_strlen(GLEWLWYD_REDIRECT_URI_LOOPBACK_2)) &&
                 0 != o_strncmp(GLEWLWYD_REDIRECT_URI_LOOPBACK_3, resource, o_strlen(GLEWLWYD_REDIRECT_URI_LOOPBACK_3))) ||
                 o_strchr(resource, '#') != NULL) { // URL with fragment not allowed
              if (j_error == NULL) {
                j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "resource is optional and must be an array of urls");
              }
            }
          }
          if (j_error != NULL) {
            break;
          }
        }
      }
    }
    if (json_object_get(config->j_params, "oauth-ciba-allowed") == json_true()) {
      if (json_object_get(j_registration, "backchannel_token_delivery_mode") != NULL &&
          0 != o_strcmp("poll", json_string_value(json_object_get(j_registration, "backchannel_token_delivery_mode"))) &&
          0 != o_strcmp("ping", json_string_value(json_object_get(j_registration, "backchannel_token_delivery_mode"))) &&
          0 != o_strcmp("push", json_string_value(json_object_get(j_registration, "backchannel_token_delivery_mode")))) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "backchannel_token_delivery_mode must have one of the following values: 'poll', 'ping', 'push'");
        break;
      }
      if (json_object_get(config->j_params, "oauth-fapi-ciba-push-forbidden") == json_true()) {
        if (0 == o_strcmp("push", json_string_value(json_object_get(j_registration, "backchannel_token_delivery_mode")))) {
          j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "backchannel_token_delivery_mode value 'push' forbidden");
          break;
        }
      }
      if (json_object_get(j_registration, "backchannel_token_delivery_mode") != NULL) {
        if (json_object_get(j_registration, "backchannel_client_notification_endpoint") != NULL) {
          resource = json_string_value(json_object_get(j_registration, "backchannel_client_notification_endpoint"));
          if ((0 != o_strncmp("https://", resource, o_strlen("https://")) &&
               0 != o_strncmp(GLEWLWYD_REDIRECT_URI_LOOPBACK_1, resource, o_strlen(GLEWLWYD_REDIRECT_URI_LOOPBACK_1)) &&
               0 != o_strncmp(GLEWLWYD_REDIRECT_URI_LOOPBACK_2, resource, o_strlen(GLEWLWYD_REDIRECT_URI_LOOPBACK_2)) &&
               0 != o_strncmp(GLEWLWYD_REDIRECT_URI_LOOPBACK_3, resource, o_strlen(GLEWLWYD_REDIRECT_URI_LOOPBACK_3))) ||
               o_strchr(resource, '#') != NULL) { // URL with fragment not allowed
            if (j_error == NULL) {
              j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "resource is optional and must be an array of urls");
            }
          }
        }
        if (json_object_get(j_registration, "backchannel_client_notification_endpoint") == NULL &&
        (0 == o_strcmp("ping", json_string_value(json_object_get(j_registration, "backchannel_token_delivery_mode"))) ||
         0 == o_strcmp("push", json_string_value(json_object_get(j_registration, "backchannel_token_delivery_mode"))))) {
          j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "backchannel_client_notification_endpoint is mandatory when using backchannel_client_notification_endpoint 'ping' or 'push'");
          break;
        }
      }
      if (json_object_get(j_registration, "backchannel_user_code_parameter") != NULL && !json_is_boolean(json_object_get(j_registration, "backchannel_user_code_parameter"))) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "backchannel_user_code_parameter is optional and must be a boolean");
        break;
      }
    }

    if (json_object_get(j_registration, "access_token_signing_alg") != NULL) {
      if (json_string_null_or_empty(json_object_get(j_registration, "access_token_signing_alg")) || 0 == o_strcmp("none", json_string_value(json_object_get(j_registration, "access_token_signing_alg")))) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "access_token_signing_alg is invalid");
        break;
      }
      if (!json_array_has_string(json_object_get(json_object_get(j_info, "jws"), "alg"), json_string_value(json_object_get(j_registration, "access_token_signing_alg")))) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "access_token_signing_alg not supported");
        break;
      }
    }
    if (json_object_get(j_registration, "access_token_encryption_alg") != NULL) {
      if (json_string_null_or_empty(json_object_get(j_registration, "access_token_encryption_alg"))) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "access_token_encryption_alg is invalid");
        break;
      }
      if (!json_array_has_string(j_enc_list, json_string_value(json_object_get(j_registration, "access_token_encryption_alg")))) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "access_token_encryption_alg not supported");
        break;
      }
    }
    if (json_object_get(j_registration, "access_token_encryption_enc") != NULL) {
      if (json_string_null_or_empty(json_object_get(j_registration, "access_token_encryption_enc"))) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "access_token_encryption_enc is invalid");
        break;
      }
      if (!json_array_has_string(json_object_get(json_object_get(j_info, "jwe"), "enc"), json_string_value(json_object_get(j_registration, "access_token_encryption_enc")))) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "access_token_encryption_enc not supported");
        break;
      }
      if (json_object_get(j_registration, "access_token_encryption_alg") == NULL) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "access_token_encryption_alg is mandatory");
        break;
      }
    }

    if (json_object_get(j_registration, "id_token_signing_alg") != NULL) {
      if (json_string_null_or_empty(json_object_get(j_registration, "id_token_signing_alg")) || 0 == o_strcmp("none", json_string_value(json_object_get(j_registration, "id_token_signing_alg")))) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "id_token_signing_alg is invalid");
        break;
      }
      if (!json_array_has_string(json_object_get(json_object_get(j_info, "jws"), "alg"), json_string_value(json_object_get(j_registration, "id_token_signing_alg")))) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "id_token_signing_alg not supported");
        break;
      }
    }
    if (json_object_get(j_registration, "id_token_encryption_alg") != NULL) {
      if (json_string_null_or_empty(json_object_get(j_registration, "id_token_encryption_alg"))) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "id_token_encryption_alg is invalid");
        break;
      }
      if (!json_array_has_string(j_enc_list, json_string_value(json_object_get(j_registration, "id_token_encryption_alg")))) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "id_token_encryption_alg not supported");
        break;
      }
    }
    if (json_object_get(j_registration, "id_token_encryption_enc") != NULL) {
      if (json_string_null_or_empty(json_object_get(j_registration, "id_token_encryption_enc"))) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "id_token_encryption_enc is invalid");
        break;
      }
      if (!json_array_has_string(json_object_get(json_object_get(j_info, "jwe"), "enc"), json_string_value(json_object_get(j_registration, "id_token_encryption_enc")))) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "id_token_encryption_enc not supported");
        break;
      }
      if (json_object_get(j_registration, "id_token_encryption_alg") == NULL) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "id_token_encryption_alg is mandatory");
        break;
      }
    }

    if (json_object_get(j_registration, "userinfo_signing_alg") != NULL) {
      if (json_string_null_or_empty(json_object_get(j_registration, "userinfo_signing_alg")) || 0 == o_strcmp("none", json_string_value(json_object_get(j_registration, "userinfo_signing_alg")))) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "userinfo_signing_alg is invalid");
        break;
      }
      if (!json_array_has_string(json_object_get(json_object_get(j_info, "jws"), "alg"), json_string_value(json_object_get(j_registration, "userinfo_signing_alg")))) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "userinfo_signing_alg not supported");
        break;
      }
    }
    if (json_object_get(j_registration, "userinfo_encryption_alg") != NULL) {
      if (json_string_null_or_empty(json_object_get(j_registration, "userinfo_encryption_alg"))) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "userinfo_encryption_alg is invalid");
        break;
      }
      if (!json_array_has_string(j_enc_list, json_string_value(json_object_get(j_registration, "userinfo_encryption_alg")))) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "userinfo_encryption_alg not supported");
        break;
      }
    }
    if (json_object_get(j_registration, "userinfo_encryption_enc") != NULL) {
      if (json_string_null_or_empty(json_object_get(j_registration, "userinfo_encryption_enc"))) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "userinfo_encryption_enc is invalid");
        break;
      }
      if (!json_array_has_string(json_object_get(json_object_get(j_info, "jwe"), "enc"), json_string_value(json_object_get(j_registration, "userinfo_encryption_enc")))) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "userinfo_encryption_enc not supported");
        break;
      }
      if (json_object_get(j_registration, "userinfo_encryption_alg") == NULL) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "userinfo_encryption_alg is mandatory");
        break;
      }
    }

    if (json_object_get(j_registration, "request_object_signing_alg") != NULL) {
      if (json_string_null_or_empty(json_object_get(j_registration, "request_object_signing_alg")) || 0 == o_strcmp("none", json_string_value(json_object_get(j_registration, "request_object_signing_alg")))) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "request_object_signing_alg is invalid");
        break;
      }
      if (!json_array_has_string(json_object_get(json_object_get(j_info, "jws"), "alg"), json_string_value(json_object_get(j_registration, "request_object_signing_alg")))) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "request_object_signing_alg not supported");
        break;
      }
    }
    if (json_object_get(j_registration, "request_object_encryption_alg") != NULL) {
      if (json_string_null_or_empty(json_object_get(j_registration, "request_object_encryption_alg"))) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "request_object_encryption_alg is invalid");
        break;
      }
      if (!json_array_has_string(j_enc_list, json_string_value(json_object_get(j_registration, "request_object_encryption_alg")))) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "request_object_encryption_alg not supported");
        break;
      }
    }
    if (json_object_get(j_registration, "request_object_encryption_enc") != NULL) {
      if (json_string_null_or_empty(json_object_get(j_registration, "request_object_encryption_enc"))) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "request_object_encryption_enc is invalid");
        break;
      }
      if (!json_array_has_string(json_object_get(json_object_get(j_info, "jwe"), "enc"), json_string_value(json_object_get(j_registration, "request_object_encryption_enc")))) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "request_object_encryption_enc not supported");
        break;
      }
      if (json_object_get(j_registration, "request_object_encryption_alg") == NULL) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "request_object_encryption_alg is mandatory");
        break;
      }
    }

    if (json_object_get(j_registration, "token_endpoint_signing_alg") != NULL) {
      if (json_string_null_or_empty(json_object_get(j_registration, "token_endpoint_signing_alg")) || 0 == o_strcmp("none", json_string_value(json_object_get(j_registration, "token_endpoint_signing_alg")))) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "token_endpoint_signing_alg is invalid");
        break;
      }
      if (!json_array_has_string(json_object_get(json_object_get(j_info, "jws"), "alg"), json_string_value(json_object_get(j_registration, "token_endpoint_signing_alg")))) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "token_endpoint_signing_alg not supported");
        break;
      }
    }
    if (json_object_get(j_registration, "token_endpoint_encryption_alg") != NULL) {
      if (json_string_null_or_empty(json_object_get(j_registration, "token_endpoint_encryption_alg"))) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "token_endpoint_encryption_alg is invalid");
        break;
      }
      if (!json_array_has_string(j_enc_list, json_string_value(json_object_get(j_registration, "token_endpoint_encryption_alg")))) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "token_endpoint_encryption_alg not supported");
        break;
      }
    }
    if (json_object_get(j_registration, "token_endpoint_encryption_enc") != NULL) {
      if (json_string_null_or_empty(json_object_get(j_registration, "token_endpoint_encryption_enc"))) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "token_endpoint_encryption_enc is invalid");
        break;
      }
      if (!json_array_has_string(json_object_get(json_object_get(j_info, "jwe"), "enc"), json_string_value(json_object_get(j_registration, "token_endpoint_encryption_enc")))) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "token_endpoint_encryption_enc not supported");
        break;
      }
      if (json_object_get(j_registration, "token_endpoint_encryption_alg") == NULL) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "token_endpoint_encryption_alg is mandatory");
        break;
      }
    }

    if (json_object_get(j_registration, "backchannel_authentication_request_signing_alg") != NULL) {
      if (json_string_null_or_empty(json_object_get(j_registration, "backchannel_authentication_request_signing_alg")) || 0 == o_strcmp("none", json_string_value(json_object_get(j_registration, "backchannel_authentication_request_signing_alg")))) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "backchannel_authentication_request_signing_alg is invalid");
        break;
      }
      if (!json_array_has_string(json_object_get(json_object_get(j_info, "jws"), "alg"), json_string_value(json_object_get(j_registration, "backchannel_authentication_request_signing_alg")))) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "backchannel_authentication_request_signing_alg not supported");
        break;
      }
    }
    if (json_object_get(j_registration, "backchannel_authentication_request_encryption_alg") != NULL) {
      if (json_string_null_or_empty(json_object_get(j_registration, "backchannel_authentication_request_encryption_alg"))) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "backchannel_authentication_request_encryption_alg is invalid");
        break;
      }
      if (!json_array_has_string(j_enc_list, json_string_value(json_object_get(j_registration, "backchannel_authentication_request_encryption_alg")))) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "backchannel_authentication_request_encryption_alg not supported");
        break;
      }
    }
    if (json_object_get(j_registration, "backchannel_authentication_request_encryption_enc") != NULL) {
      if (json_string_null_or_empty(json_object_get(j_registration, "backchannel_authentication_request_encryption_enc"))) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "backchannel_authentication_request_encryption_enc is invalid");
        break;
      }
      if (!json_array_has_string(json_object_get(json_object_get(j_info, "jwe"), "enc"), json_string_value(json_object_get(j_registration, "backchannel_authentication_request_encryption_enc")))) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "backchannel_authentication_request_encryption_enc not supported");
        break;
      }
      if (json_object_get(j_registration, "backchannel_authentication_request_encryption_alg") == NULL) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "backchannel_authentication_request_encryption_alg is mandatory");
        break;
      }
    }

    if (json_object_get(j_registration, "authorization_signed_response_alg") != NULL) {
      if (json_string_null_or_empty(json_object_get(j_registration, "authorization_signed_response_alg")) || 0 == o_strcmp("none", json_string_value(json_object_get(j_registration, "authorization_signed_response_alg")))) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "authorization_signed_response_alg is invalid");
        break;
      }
      if (!json_array_has_string(json_object_get(json_object_get(j_info, "jws"), "alg"), json_string_value(json_object_get(j_registration, "authorization_signed_response_alg")))) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "authorization_signed_response_alg not supported");
        break;
      }
    }
    if (json_object_get(j_registration, "authorization_encrypted_response_alg") != NULL) {
      if (json_string_null_or_empty(json_object_get(j_registration, "authorization_encrypted_response_alg"))) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "authorization_encrypted_response_alg is invalid");
        break;
      }
      if (!json_array_has_string(j_enc_list, json_string_value(json_object_get(j_registration, "authorization_encrypted_response_alg")))) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "authorization_encrypted_response_alg not supported");
        break;
      }
    }
    if (json_object_get(j_registration, "authorization_encrypted_response_enc") != NULL) {
      if (json_string_null_or_empty(json_object_get(j_registration, "authorization_encrypted_response_enc"))) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "authorization_encrypted_response_enc is invalid");
        break;
      }
      if (!json_array_has_string(json_object_get(json_object_get(j_info, "jwe"), "enc"), json_string_value(json_object_get(j_registration, "authorization_encrypted_response_enc")))) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "authorization_encrypted_response_enc not supported");
        break;
      }
      if (json_object_get(j_registration, "authorization_encrypted_response_alg") == NULL) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "authorization_encrypted_response_alg is mandatory");
        break;
      }
    }

    if (json_object_get(j_registration, "response_mode") != NULL) {
      response_mode = json_string_value(json_object_get(j_registration, "response_mode"));
      j_response_modes_supported = json_pack("[sss]", "query", "fragment", "form_post");
      if (json_object_get(config->j_params, "oauth-fapi-allow-jarm") == json_true()) {
        json_array_append_new(j_response_modes_supported, json_string("jwt"));
        json_array_append_new(j_response_modes_supported, json_string("query.jwt"));
        json_array_append_new(j_response_modes_supported, json_string("fragment.jwt"));
        json_array_append_new(j_response_modes_supported, json_string("form_post.jwt"));
      }
      if (!json_array_has_string(j_response_modes_supported, response_mode)) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "response_mode value not supported");
        break;
      }
    }

    if (json_object_get(j_registration, "post_logout_redirect_uri") != NULL) {
      resource = json_string_value(json_object_get(j_registration, "post_logout_redirect_uri"));
      if (!is_redirect_uri_valid_without_credential(resource) ||
         (0 != o_strncmp("https://", resource, o_strlen("https://")) &&
          0 != o_strncmp(GLEWLWYD_REDIRECT_URI_LOOPBACK_1, resource, o_strlen(GLEWLWYD_REDIRECT_URI_LOOPBACK_1)) &&
          0 != o_strncmp(GLEWLWYD_REDIRECT_URI_LOOPBACK_2, resource, o_strlen(GLEWLWYD_REDIRECT_URI_LOOPBACK_2)) &&
          0 != o_strncmp(GLEWLWYD_REDIRECT_URI_LOOPBACK_3, resource, o_strlen(GLEWLWYD_REDIRECT_URI_LOOPBACK_3)))) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "post_logout_redirect_uri is not a valid uri");
        break;
      }
    }
    if (json_object_get(j_registration, "frontchannel_logout_uri") != NULL) {
      resource = json_string_value(json_object_get(j_registration, "frontchannel_logout_uri"));
      if (!is_redirect_uri_valid_without_credential(resource) ||
         (0 != o_strncmp("https://", resource, o_strlen("https://")) &&
          0 != o_strncmp(GLEWLWYD_REDIRECT_URI_LOOPBACK_1, resource, o_strlen(GLEWLWYD_REDIRECT_URI_LOOPBACK_1)) &&
          0 != o_strncmp(GLEWLWYD_REDIRECT_URI_LOOPBACK_2, resource, o_strlen(GLEWLWYD_REDIRECT_URI_LOOPBACK_2)) &&
          0 != o_strncmp(GLEWLWYD_REDIRECT_URI_LOOPBACK_3, resource, o_strlen(GLEWLWYD_REDIRECT_URI_LOOPBACK_3)))) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "frontchannel_logout_uri is not a valid uri");
        break;
      }
    }
    if (json_object_get(j_registration, "frontchannel_logout_session_required") != NULL) {
      if (!json_is_boolean(json_object_get(j_registration, "frontchannel_logout_session_required"))) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "frontchannel_logout_session_required is not a boolean");
        break;
      }
      if (json_object_get(j_registration, "frontchannel_logout_session_required") == json_true()) {
        json_object_set_new(j_registration, "frontchannel_logout_session_required", json_string("1"));
      } else {
        json_object_set_new(j_registration, "frontchannel_logout_session_required", json_string("0"));
      }
    }
    if (json_object_get(j_registration, "backchannel_logout_uri") != NULL) {
      resource = json_string_value(json_object_get(j_registration, "backchannel_logout_uri"));
      if (!is_redirect_uri_valid_without_credential(resource) ||
         (0 != o_strncmp("https://", resource, o_strlen("https://")) &&
          0 != o_strncmp(GLEWLWYD_REDIRECT_URI_LOOPBACK_1, resource, o_strlen(GLEWLWYD_REDIRECT_URI_LOOPBACK_1)) &&
          0 != o_strncmp(GLEWLWYD_REDIRECT_URI_LOOPBACK_2, resource, o_strlen(GLEWLWYD_REDIRECT_URI_LOOPBACK_2)) &&
          0 != o_strncmp(GLEWLWYD_REDIRECT_URI_LOOPBACK_3, resource, o_strlen(GLEWLWYD_REDIRECT_URI_LOOPBACK_3)))) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "backchannel_logout_uri is not a valid uri");
        break;
      }
    }
    if (json_object_get(j_registration, "backchannel_logout_session_required") != NULL) {
      if (!json_is_boolean(json_object_get(j_registration, "backchannel_logout_session_required"))) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "backchannel_logout_session_required is not a boolean");
        break;
      }
      if (json_object_get(j_registration, "backchannel_logout_session_required") == json_true()) {
        json_object_set_new(j_registration, "backchannel_logout_session_required", json_string("1"));
      } else {
        json_object_set_new(j_registration, "backchannel_logout_session_required", json_string("0"));
      }
    }
    if (json_object_get(j_registration, "authorization_details_types") != NULL) {
      if (!json_is_array(json_object_get(j_registration, "authorization_details_types"))) {
        j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "authorization_details_types is not a JSON array");
        break;
      }
      json_array_foreach(json_object_get(j_registration, "authorization_details_types"), index, j_element) {
        if (!json_string_length(j_element)) {
          j_error = json_pack("{ssss}", "error", "invalid_client_metadata", "error_description", "authorization_details_types must contain JSON strings");
          break;
        }
        auth_detail_found = 0;
        json_object_foreach(json_object_get(config->j_params, "rar-types"), key, j_authorization_details) {
          if (0 == o_strcmp(key, json_string_value(j_element))) {
            auth_detail_found = 1;
          }
        }
        if (!auth_detail_found) {
          j_error = json_pack("{ssss++}", "error", "invalid_client_metadata", "error_description", "authorization_details_type '", json_string_value(j_element), "' doesn't exist");
          break;
        }
      }
    }
  } while(0);
  ulfius_clean_request(&req);
  ulfius_clean_response(&resp);
  json_decref(j_resp);
  json_decref(j_info);
  json_decref(j_response_modes_supported);

  if (j_error != NULL) {
    j_return = json_pack("{siso}", "result", G_ERROR_PARAM, "error", j_error);
  } else {
    j_return = json_pack("{si}", "result", G_OK);
  }
  return j_return;
}
