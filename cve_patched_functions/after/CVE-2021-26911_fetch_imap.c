fetch_imap(mailimap * imap, bool identifier_is_uid, uint32_t identifier,
           struct mailimap_fetch_type * fetch_type,
           char ** result, size_t * result_len)
{
    int r;
    struct mailimap_msg_att * msg_att;
    struct mailimap_msg_att_item * msg_att_item;
    clist * fetch_result;
    struct mailimap_set * set;
    char * text;
    size_t text_length;
    clistiter * cur;
    
    set = mailimap_set_new_single(identifier);
    if (identifier_is_uid) {
        r = mailimap_uid_fetch(imap, set, fetch_type, &fetch_result);
    }
    else {
        r = mailimap_fetch(imap, set, fetch_type, &fetch_result);
    }
    
    mailimap_set_free(set);
    
    switch (r) {
        case MAILIMAP_NO_ERROR:
            break;
        default:
            return r;
    }
    
    if (clist_isempty(fetch_result)) {
        mailimap_fetch_list_free(fetch_result);
        return MAILIMAP_ERROR_FETCH;
    }
    
    msg_att = (struct mailimap_msg_att *) clist_begin(fetch_result)->data;
    
    text = NULL;
    text_length = 0;
    
    for(cur = clist_begin(msg_att->att_list) ; cur != NULL ;
        cur = clist_next(cur)) {
        msg_att_item = (struct mailimap_msg_att_item *) clist_content(cur);
        
        if (msg_att_item->att_type != MAILIMAP_MSG_ATT_ITEM_STATIC) {
            continue;
        }
        
        if (msg_att_item->att_data.att_static->att_type !=
            MAILIMAP_MSG_ATT_BODY_SECTION) {
            continue;
        }
        
        text = msg_att_item->att_data.att_static->att_data.att_body_section->sec_body_part;
        msg_att_item->att_data.att_static->att_data.att_body_section->sec_body_part = NULL;
        text_length = msg_att_item->att_data.att_static->att_data.att_body_section->sec_length;
    }
    
    mailimap_fetch_list_free(fetch_result);
    
    if (text == NULL)
        return MAILIMAP_ERROR_FETCH;
    
    * result = text;
    * result_len = text_length;
    
    return MAILIMAP_NO_ERROR;
}
