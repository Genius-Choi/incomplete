ecma_proxy_check_invariants_for_own_prop_keys (ecma_collection_t *trap_result,
                                               ecma_collection_t *target_non_configurable_keys,
                                               ecma_collection_t *target_configurable_keys,
                                               ecma_value_t extensible_target)
{
  /* 20. */
  ecma_collection_t *unchecked_result_keys = ecma_new_collection ();

  ecma_collection_append (unchecked_result_keys, trap_result->buffer_p, trap_result->item_count);

  for (uint32_t i = 0; i < unchecked_result_keys->item_count; i++)
  {
    ecma_string_t *unchecked_prop_name = ecma_get_prop_name_from_value (unchecked_result_keys->buffer_p[i]);
    ecma_ref_ecma_string (unchecked_prop_name);
  }

  bool check_ok = false;
  uint32_t unchecked_prop_name_counter = 0;

  /* 21. */
  if (ECMA_IS_VALUE_ERROR (ecma_proxy_object_own_property_keys_helper (target_non_configurable_keys,
                                                                       unchecked_result_keys,
                                                                       &unchecked_prop_name_counter)))
  {
    ecma_raise_type_error (ECMA_ERR_TRAP_RESULT_NOT_INCLUDE_ALL_NON_CONFIGURABLE_KEYS);
  }
  /* 22. */
  else if (ecma_is_value_true (extensible_target))
  {
    check_ok = true;
  }
  /* 23. */
  else if (ECMA_IS_VALUE_ERROR (ecma_proxy_object_own_property_keys_helper (target_configurable_keys,
                                                                            unchecked_result_keys,
                                                                            &unchecked_prop_name_counter)))
  {
    ecma_raise_type_error (ECMA_ERR_TRAP_RESULT_NOT_INCLUDE_ALL_CONFIGURABLE_KEYS);
  }
  /* 24. */
  else if (unchecked_result_keys->item_count != unchecked_prop_name_counter)
  {
    ecma_raise_type_error (ECMA_ERR_TRAP_EXTRA_KEYS_FOR_A_NON_EXTENSIBLE_TARGET);
  }
  /* 25. */
  else
  {
    check_ok = true;
  }

  ecma_collection_free (unchecked_result_keys);

  return check_ok;
} /* ecma_proxy_check_invariants_for_own_prop_keys */
