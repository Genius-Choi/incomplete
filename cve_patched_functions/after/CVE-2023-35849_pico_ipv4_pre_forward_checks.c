static int pico_ipv4_pre_forward_checks(struct pico_stack *S, struct pico_frame *f)
{

    struct pico_ipv4_hdr *hdr = (struct pico_ipv4_hdr *)f->net_hdr;

    /* Decrease TTL, check if expired */
    hdr->ttl = (uint8_t)(hdr->ttl - 1);
    if (hdr->ttl < 1) {
        pico_notify_ttl_expired(S, f);
        dbg(" ------------------- TTL EXPIRED\n");
        return -1;
    }

    /* HACK: increase crc to compensate decreased TTL */
    hdr->crc++;

    /* If source is local, discard anyway (packets bouncing back and forth) */
    if (pico_ipv4_link_get(S, &hdr->src))
        return -1;

    /* If this was the last forwarded packet, silently discard to prevent duplications */
    if ((S->ipv4_pre_forward_last_src.addr == hdr->src.addr) && (S->ipv4_pre_forward_last_id == hdr->id)
        && (S->ipv4_pre_forward_last_dst.addr == hdr->dst.addr) && (S->ipv4_pre_forward_last_proto == hdr->proto)) {
        return -1;
    } else {
        S->ipv4_pre_forward_last_src.addr = hdr->src.addr;
        S->ipv4_pre_forward_last_dst.addr = hdr->dst.addr;
        S->ipv4_pre_forward_last_id = hdr->id;
        S->ipv4_pre_forward_last_proto = hdr->proto;
    }

    return 0;
}
