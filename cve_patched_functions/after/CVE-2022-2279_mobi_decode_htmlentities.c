char * mobi_decode_htmlentities(const char *input) {
    if (!input) {
        return NULL;
    }
    const size_t codepoint_max = 0x10ffff;
    size_t output_length = strlen(input) + 1;
    char *in = (char *) input;
    /* output size will be less or equal to input */
    char *output = malloc(output_length);
    char *out = output;
    if (output == NULL) {
        debug_print("Memory allocation failed (%zu bytes)\n", output_length);
        return NULL;
    }
    char *offset = in;
    while ((in = strchr(in, '&'))) {
        size_t decoded_length = 0;
        char *end = NULL;
        char decoded[MOBI_UTF8_MAXBYTES + 1] = { 0 };
        if (in[1] == '#' && (in[2] == 'x' || in[2] == 'X')) {
            // hex entity
            size_t codepoint = strtoul(in + 3, &end, 16);
            if (*end++ == ';' && codepoint <= codepoint_max) {
                decoded_length = mobi_unicode_to_utf8(decoded, codepoint);
            }
        } else if (in[1] == '#') {
            // dec entity
            size_t codepoint = strtoul(in + 2, &end, 10);
            if (*end++ == ';' && codepoint <= codepoint_max) {
                decoded_length = mobi_unicode_to_utf8(decoded, codepoint);
            }
        } else {
            // named entity
            for (size_t i = 0; i < ARRAYSIZE(entities); i++) {
                if (strncmp(in, entities[i].name, strlen(entities[i].name)) == 0) {
                    int ret = snprintf(decoded, MOBI_UTF8_MAXBYTES + 1, "%s", entities[i].utf8_bytes);
                    if (ret > 0) {
                        decoded_length = (size_t) ret;
                        end = in + strlen(entities[i].name);
                        break;
                    }
                }
            }
        }
        if (decoded_length) {
            size_t len = (size_t) (in - offset);
            memcpy(out, offset, len);
            offset = end;
            out += len;
            memcpy(out, decoded, decoded_length);
            out += decoded_length;
        }
        in += decoded_length + 1;
    }
    strcpy(out, offset);
    return output;
}
