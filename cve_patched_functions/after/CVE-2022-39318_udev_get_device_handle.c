static int udev_get_device_handle(URBDRC_PLUGIN* urbdrc, libusb_context* ctx, UDEVICE* pdev,
                                  UINT16 bus_number, UINT16 dev_number)
{
	int error;
	ssize_t i, total_device;
	uint8_t port_numbers[16];
	LIBUSB_DEVICE** libusb_list;
	total_device = libusb_get_device_list(ctx, &libusb_list);
	/* Look for device. */
	error = -1;

	for (i = 0; i < total_device; i++)
	{
		LIBUSB_DEVICE* dev = libusb_list[i];

		if ((bus_number != libusb_get_bus_number(dev)) ||
		    (dev_number != libusb_get_device_address(dev)))
			continue;

		error = libusb_open(dev, &pdev->libusb_handle);

		if (log_libusb_result(urbdrc->log, WLOG_ERROR, "libusb_open", error))
			break;

		/* get port number */
		error = libusb_get_port_numbers(dev, port_numbers, sizeof(port_numbers));

		if (error < 1)
		{
			/* Prevent open hub, treat as error. */
			log_libusb_result(urbdrc->log, WLOG_ERROR, "libusb_get_port_numbers", error);
			break;
		}

		pdev->port_number = port_numbers[(error - 1)];
		error = 0;
		WLog_Print(urbdrc->log, WLOG_DEBUG, "  Port: %d", pdev->port_number);
		/* gen device path */
		sprintf(pdev->path, "%" PRIu16 "-%" PRIu16 "", bus_number, pdev->port_number);

		WLog_Print(urbdrc->log, WLOG_DEBUG, "  DevPath: %s", pdev->path);
		break;
	}
	libusb_free_device_list(libusb_list, 1);

	if (error < 0)
		return -1;
	return 0;
}
