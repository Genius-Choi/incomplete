calcPosition(char *l, Lineprop *pr, int len, int pos, int bpos, int mode)
{
    static int *realColumn = NULL;
    static int size = 0;
    static char *prevl = NULL;
    int i, j;

    if (l == NULL || len == 0 || pos < 0)
	return bpos;
    if (l == prevl && mode == CP_AUTO) {
	if (pos <= len)
	    return realColumn[pos];
    }
    if (size < len + 1) {
	size = (len + 1 > LINELEN) ? (len + 1) : LINELEN;
	realColumn = New_N(int, size);
    }
    prevl = l;
    i = 0;
    j = bpos;
#ifdef USE_M17N
    if (pr[i] & PC_WCHAR2) {
	for (; i < len && pr[i] & PC_WCHAR2; i++)
	    realColumn[i] = j;
	if (i > 0 && pr[i - 1] & PC_KANJI && WcOption.use_wide)
	    j++;
    }
#endif
    while (1) {
	realColumn[i] = j;
	if (i == len)
	    break;
	j = nextColumn(j, &l[i], &pr[i]);
	i++;
#ifdef USE_M17N
	for (; i < len && pr[i] & PC_WCHAR2; i++)
	    realColumn[i] = realColumn[i - 1];
#endif
    }
    if (pos >= i)
	return j;
    return realColumn[pos];
}
