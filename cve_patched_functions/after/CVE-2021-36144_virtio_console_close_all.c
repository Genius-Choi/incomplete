virtio_console_close_all(struct virtio_console *console)
{
	int i, rc = 0;
	struct virtio_console_port *port;
	struct virtio_console_backend *be;

	/*
	 * we should close ports without mevent first.
	 * port->enabled is reset to false when a backend is closed.
	 */
	for (i = 0; i < console->nports; i++) {
		port = &console->ports[i];

		if (!port->enabled)
			continue;

		be = (struct virtio_console_backend *)port->arg;
		if (be && !be->evp)
			virtio_console_close_backend(be);
	}

	for (i = 0; i < console->nports; i++) {
		port = &console->ports[i];

		if (!port->enabled)
			continue;

		be = (struct virtio_console_backend *)port->arg;
		if (be && be->evp) {
			/* resources will be freed in the teardown callback */
			mevent_delete(be->evp);
			rc = 1;
		}
	}

	return rc;
}
