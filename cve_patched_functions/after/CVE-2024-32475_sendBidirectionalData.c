  void sendBidirectionalData(FakeRawConnectionPtr& fake_raw_upstream_connection,
                             IntegrationStreamDecoderPtr& response,
                             const char* downstream_send_data = "hello",
                             const char* upstream_received_data = "hello",
                             const char* upstream_send_data = "there!",
                             const char* downstream_received_data = "there!") {
    // Send some data upstream.
    codec_client_->sendData(*request_encoder_, downstream_send_data, false);
    ASSERT_TRUE(fake_raw_upstream_connection->waitForData(
        FakeRawConnection::waitForInexactMatch(upstream_received_data)));
    // Send some data downstream.
    ASSERT_TRUE(fake_raw_upstream_connection->write(upstream_send_data));
    response->waitForBodyData(strlen(downstream_received_data));
    EXPECT_EQ(downstream_received_data, response->body());
  }
