parse_aperture_definition(gerb_file_t *fd, gerbv_aperture_t *aperture,
			  gerbv_image_t *image, gdouble scale,
			  long int *line_num_p)
{
    int ano, i;
    char *ad;
    char *token;
    gerbv_amacro_t *curr_amacro;
    gerbv_amacro_t *amacro = image->amacro;
    gerbv_error_list_t *error_list = image->gerbv_stats->error_list;
    gdouble tempHolder;
    
    if (gerb_fgetc(fd) != 'D') {
	gerbv_stats_printf(error_list, GERBV_MESSAGE_ERROR, -1,
		_("Found AD code with no following 'D' "
		    "at line %ld in file \"%s\""),
		*line_num_p, fd->filename);
	return -1;
    }
    
    /*
     * Get aperture no
     */
    ano = gerb_fgetint(fd, NULL);
    
    /*
     * Read in the whole aperture defintion and tokenize it
     */
    ad = gerb_fgetstring(fd, '*');

    if (ad == NULL) {
	gerbv_stats_printf(error_list, GERBV_MESSAGE_ERROR, -1,
		_("Invalid aperture definition at line %ld in file \"%s\", "
		    "cannot find '*'"),
		*line_num_p, fd->filename);
	return -1;
    }

    token = strtok(ad, ",");
    
    if (token == NULL) {
	gerbv_stats_printf(error_list, GERBV_MESSAGE_ERROR, -1,
		_("Invalid aperture definition at line %ld in file \"%s\""),
		*line_num_p, fd->filename);
	return -1;
    }
    if (strlen(token) == 1) {
	switch (token[0]) {
	case 'C':
	    aperture->type = GERBV_APTYPE_CIRCLE;
	    break;
	case 'R' :
	    aperture->type = GERBV_APTYPE_RECTANGLE;
	    break;
	case 'O' :
	    aperture->type = GERBV_APTYPE_OVAL;
	    break;
	case 'P' :
	    aperture->type = GERBV_APTYPE_POLYGON;
	    break;
	}
	/* Here a should a T be defined, but I don't know what it represents */
    } else {
	aperture->type = GERBV_APTYPE_MACRO;
	/*
	 * In aperture definition, point to the aperture macro 
	 * used in the defintion
	 */
	curr_amacro = amacro;
	while (curr_amacro) {
	    if ((strlen(curr_amacro->name) == strlen(token)) &&
		(strcmp(curr_amacro->name, token) == 0)) {
		aperture->amacro = curr_amacro;
		break;
	    }
	    curr_amacro = curr_amacro->next;
	}
    }
    
    /*
     * Parse all parameters
     */
    for (token = strtok(NULL, "X"), i = 0; token != NULL; 
	 token = strtok(NULL, "X"), i++) {
	if (i == APERTURE_PARAMETERS_MAX) {
	    gerbv_stats_printf(error_list, GERBV_MESSAGE_ERROR, -1,
		    _("Maximum number of allowed parameters exceeded "
			"in aperture %d at line %ld in file \"%s\""),
		    ano, *line_num_p, fd->filename);
	    break;
	}
	errno = 0;

	tempHolder = strtod(token, NULL);
	/* convert any MM values to inches */
	/* don't scale polygon angles or side numbers, or macro parmaeters */
	if (!(((aperture->type == GERBV_APTYPE_POLYGON) && ((i==1) || (i==2)))||
		(aperture->type == GERBV_APTYPE_MACRO))) {
	    tempHolder /= scale;
	}
	
	aperture->parameter[i] = tempHolder;
	if (errno) {
	    gerbv_stats_printf(error_list, GERBV_MESSAGE_WARNING, -1,
		    _("Failed to read all parameters exceeded in "
			"aperture %d at line %ld in file \"%s\""),
		    ano, *line_num_p, fd->filename);
            aperture->parameter[i] = 0.0;
        }
    }
    
    aperture->nuf_parameters = i;
    
    gerb_ungetc(fd);

    if (aperture->type == GERBV_APTYPE_MACRO) {
	dprintf("Simplifying aperture %d using aperture macro \"%s\"\n", ano,
		aperture->amacro->name);
	simplify_aperture_macro(aperture, scale);
	dprintf("Done simplifying\n");
    }
    
    g_free(ad);
    
    return ano;
} /* parse_aperture_definition */
