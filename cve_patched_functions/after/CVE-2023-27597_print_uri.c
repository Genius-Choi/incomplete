int print_uri(struct sip_uri *uri, str *out_buf)
{
#define append_str_chunk(field) \
	do { \
		if (bytes + uri->field.len > out_buf->len) { \
			LM_ERR("no more space left! printed so far: '%.*s'\n", \
		           bytes, out_buf->s); \
			return -1; \
		} \
		memcpy(out_buf->s + bytes, uri->field.s, uri->field.len); \
		bytes += uri->field.len; \
	} while (0)

#define append_char(ch) \
	do { \
		if (bytes + 1 > out_buf->len) { \
			LM_ERR("no more space left! printed so far: '%.*s'\n", \
		           bytes, out_buf->s); \
			return -1; \
		} \
		out_buf->s[bytes++] = ch; \
	} while (0)

#define VAL(p) p##_val

#define append_param(p) \
	do { \
		if (uri->p.s) { \
			append_char(';'); \
			append_str_chunk(p); \
		} \
	} while (0)

#define append_uk_param(idx) \
	do { \
		if (uri->u_name[idx].s) { \
			append_char(';'); \
			if (bytes + uri->u_name[idx].len > out_buf->len) { \
				LM_ERR("no more space left! printed so far: '%.*s'\n", \
			           bytes, out_buf->s); \
				return -1; \
			} \
			memcpy(out_buf->s + bytes, uri->u_name[idx].s, uri->u_name[idx].len); \
			bytes += uri->u_name[idx].len; \
			if (uri->u_val[idx].s) { \
				append_char('='); \
				if (bytes + uri->u_val[idx].len > out_buf->len) { \
					LM_ERR("no more space left! printed so far: '%.*s'\n", \
				           bytes, out_buf->s); \
					return -1; \
				} \
				memcpy(out_buf->s + bytes, uri->u_val[idx].s, uri->u_val[idx].len); \
				bytes += uri->u_val[idx].len; \
			} \
		} \
	} while (0)

	int bytes = 0;
	int i;

	memcpy(out_buf->s, uri_type_names[uri->type].s, uri_type_names[uri->type].len);
	bytes += uri_type_names[uri->type].len;
	append_char(':');
	append_str_chunk(user);
	if (uri->passwd.s) {
		append_char(':');
		append_str_chunk(passwd);
	}
	if (uri->host.s) {
		append_char('@');
		append_str_chunk(host);
	}
	if (uri->port.s) {
		append_char(':');
		append_str_chunk(port);
	}

	append_param(transport);
	append_param(ttl);
	append_param(user_param);
	append_param(maddr);
	append_param(method);
	append_param(lr);
	append_param(r2);
	append_param(gr);
	append_param(pn_provider);
	append_param(pn_prid);
	append_param(pn_param);
	append_param(pn_purr);

	for (i = 0; i < uri->u_params_no; i++)
		append_uk_param(i);

	out_buf->len = bytes;

	return 0;
#undef append_str_chunk
#undef append_char
#undef VAL
#undef append_param
#undef append_uk_param
}
