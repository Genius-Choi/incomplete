output_applesingle(FILE *rf, int32_t rf_len, const char *filename, FILE *f,
		   int appledouble)
{
  uint32_t offset;
  int i, nentries, len = strlen(filename);
  if (appledouble)		/* magic number */
    write_four(APPLEDOUBLE_MAGIC, f);
  else
    write_four(APPLESINGLE_MAGIC, f);
  write_four(APPLESINGLE_VERSION, f); /* version number */
  for (i = 0; i < 4; i++)
    write_four(0, f);		/* filler */
  nentries = (appledouble ? 4 : 5);
  write_two(nentries, f); /* number of entries */

  /* real name entry */
  offset = APPLESINGLE_HEADERLEN + nentries * APPLESINGLE_ENTRYLEN;
  write_four(APPLESINGLE_REALNAME_ENTRY, f);
  write_four(offset, f);
  write_four(len, f);
  offset += len;

  /* time entry */
  write_four(APPLESINGLE_DATES_ENTRY, f);
  write_four(offset, f);
  write_four(APPLESINGLE_DATES_LEN, f);
  offset += APPLESINGLE_DATES_LEN;

  /* finder info entry */
  write_four(APPLESINGLE_FINDERINFO_ENTRY, f);
  write_four(offset, f);
  write_four(APPLESINGLE_FINDERINFO_LEN, f);
  offset += APPLESINGLE_FINDERINFO_LEN;

  /* resource fork entry */
  write_four(APPLESINGLE_RFORK_ENTRY, f);
  write_four(offset, f);
  write_four(rf_len, f);
  offset += rf_len;

  /* data fork entry */
  if (!appledouble) {
    write_four(APPLESINGLE_DFORK_ENTRY, f);
    write_four(offset, f);
    write_four(0, f);
  }

  /* real name data */
  fwrite(filename, 1, len, f);

  /* time data */
  i = time(0) - APPLESINGLE_TIME_DELTA;
  write_four(i, f);		/* creation date */
  write_four(i, f);		/* modification date */
  write_four(0x80000000, f);	/* backup date */
  write_four(0, f);		/* access date */

  /* finder info data */
  write_four(T1_FILETYPE, f);	/* file type */
  write_four(T1_FILECREATOR, f); /* file creator */
  write_one(T1_FINDERFLAGS, f); /* finder flags */
  write_one(0, f);		/* extended finder flags */
  write_two(0, f);		/* vertical position in window */
  write_two(0, f);		/* horizontal position in window */
  write_two(0, f);		/* window or folder ID */
  write_four(0, f);		/* icon ID and reserved */
  write_four(0, f);		/* reserved */
  write_one(0, f);		/* script flag */
  write_one(0, f);		/* reserved */
  write_two(0, f);		/* comment ID */
  write_four(0, f);		/* put away */

  /* resource fork data */
  output_raw(rf, rf_len, f);
}
