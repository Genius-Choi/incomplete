    .SetShapeFn([](InferenceContext* c) {
      ShapeHandle unused;
      TF_RETURN_IF_ERROR(c->WithRank(c->input(3), 1, &unused));
      int num_params_weights;
      int num_params_biases;
      TF_RETURN_IF_ERROR(c->GetAttr("num_params_weights", &num_params_weights));
      TF_RETURN_IF_ERROR(c->GetAttr("num_params_biases", &num_params_biases));
      // Set shape for weight matrices
      for (int i = 0; i < num_params_weights; i++) {
        c->set_output(i, c->Matrix(InferenceContext::kUnknownDim,
                                   InferenceContext::kUnknownDim));
      }
      // Set shape for bias vectors
      for (int i = 0; i < num_params_biases; i++) {
        c->set_output(num_params_weights + i,
                      c->Vector(InferenceContext::kUnknownDim));
      }
      return Status::OK();
    });
