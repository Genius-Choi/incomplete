njs_json_stringify(njs_vm_t *vm, njs_value_t *args, njs_uint_t nargs,
    njs_index_t unused)
{
    size_t                length;
    int64_t               i64;
    njs_int_t             i;
    njs_int_t             ret;
    njs_value_t           *replacer, *space;
    const u_char          *p;
    njs_string_prop_t     prop;
    njs_json_stringify_t  *stringify, json_stringify;

    stringify = &json_stringify;

    stringify->vm = vm;
    stringify->depth = 0;
    stringify->keys_type = NJS_ENUM_STRING;

    replacer = njs_arg(args, nargs, 2);

    if (njs_is_function(replacer) || njs_is_array(replacer)) {
        stringify->replacer = *replacer;
        if (njs_is_array(replacer)) {
            ret = njs_json_stringify_array(vm, stringify);
            if (njs_slow_path(ret != NJS_OK)) {
                goto memory_error;
            }
        }

    } else {
        njs_set_undefined(&stringify->replacer);
    }

    space = njs_arg(args, nargs, 3);

    if (njs_is_object(space)) {
        if (njs_is_object_number(space)) {
            ret = njs_value_to_numeric(vm, space, space);
            if (njs_slow_path(ret != NJS_OK)) {
                return ret;
            }

        } else if (njs_is_object_string(space)) {
            ret = njs_value_to_string(vm, space, space);
            if (njs_slow_path(ret != NJS_OK)) {
                return ret;
            }
        }
    }

    switch (space->type) {
    case NJS_STRING:
        length = njs_string_prop(&prop, space);

        if (njs_is_byte_string(&prop)) {
            njs_internal_error(vm, "space argument cannot be"
                               " a byte string");
            return NJS_ERROR;
        }

        if (length > 10) {
            p = njs_string_offset(prop.start, prop.start + prop.size, 10);

        } else {
            p = prop.start + prop.size;
        }

        stringify->space.start = prop.start;
        stringify->space.length = p - prop.start;

        break;

    case NJS_NUMBER:
        i64 = njs_min(njs_number_to_integer(njs_number(space)), 10);

        if (i64 > 0) {
            stringify->space.length = i64;
            stringify->space.start = stringify->space_buf;

            for (i = 0; i < i64; i++) {
                stringify->space.start[i] = ' ';
            }

            break;
        }

        /* Fall through. */

    default:
        stringify->space.length = 0;

        break;
     }

    return njs_json_stringify_iterator(vm, stringify, njs_arg(args, nargs, 1));

memory_error:

    njs_memory_error(vm);

    return NJS_ERROR;
}
