send_http_error(
    cupsd_client_t  *con,		/* I - Client connection */
    http_status_t   status,		/* I - HTTP status code */
    cupsd_printer_t *printer)		/* I - Printer, if any */
{
  ipp_attribute_t	*uri;		/* Request URI, if any */


  if ((uri = ippFindAttribute(con->request, "printer-uri",
                              IPP_TAG_URI)) == NULL)
    uri = ippFindAttribute(con->request, "job-uri", IPP_TAG_URI);

  cupsdLogMessage(status == HTTP_FORBIDDEN ? CUPSD_LOG_ERROR : CUPSD_LOG_DEBUG,
                  "[Client %d] Returning HTTP %s for %s (%s) from %s",
                  con->number, httpStatus(status),
		  con->request ?
		      ippOpString(con->request->request.op.operation_id) :
		      "no operation-id",
		  uri ? uri->values[0].string.text : "no URI",
		  con->http->hostname);

  if (printer)
  {
    int		auth_type;		/* Type of authentication required */


    auth_type = CUPSD_AUTH_NONE;

    if (status == HTTP_UNAUTHORIZED &&
        printer->num_auth_info_required > 0 &&
        !strcmp(printer->auth_info_required[0], "negotiate") &&
	con->request &&
	(con->request->request.op.operation_id == IPP_PRINT_JOB ||
	 con->request->request.op.operation_id == IPP_CREATE_JOB ||
	 con->request->request.op.operation_id == CUPS_AUTHENTICATE_JOB))
    {
     /*
      * Creating and authenticating jobs requires Kerberos...
      */

      auth_type = CUPSD_AUTH_NEGOTIATE;
    }
    else
    {
     /*
      * Use policy/location-defined authentication requirements...
      */

      char	resource[HTTP_MAX_URI];	/* Resource portion of URI */
      cupsd_location_t *auth;		/* Pointer to authentication element */


      if (printer->type & CUPS_PRINTER_CLASS)
	snprintf(resource, sizeof(resource), "/classes/%s", printer->name);
      else
	snprintf(resource, sizeof(resource), "/printers/%s", printer->name);

      if ((auth = cupsdFindBest(resource, HTTP_POST)) == NULL ||
	  auth->type == CUPSD_AUTH_NONE)
	auth = cupsdFindPolicyOp(printer->op_policy_ptr,
				 con->request ?
				     con->request->request.op.operation_id :
				     IPP_PRINT_JOB);

      if (auth)
      {
        if (auth->type == CUPSD_AUTH_DEFAULT)
	  auth_type = cupsdDefaultAuthType();
	else
	  auth_type = auth->type;
      }
    }

    cupsdSendError(con, status, auth_type);
  }
  else
    cupsdSendError(con, status, CUPSD_AUTH_NONE);

  ippDelete(con->response);
  con->response = NULL;

  return;
}
