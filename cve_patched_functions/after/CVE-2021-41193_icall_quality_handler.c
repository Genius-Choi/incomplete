static void icall_quality_handler(struct icall *icall,
				  const char *userid,
				  const char *clientid,
				  int rtt, int uploss, int downloss,
				  void *arg)
{
	struct wcall *wcall = arg;
	struct calling_instance *inst = wcall ? wcall->inst : NULL;
	int quality = WCALL_QUALITY_NORMAL;
	uint64_t now;
	char userid_anon[ANON_ID_LEN];
	char clientid_anon[ANON_CLIENT_LEN];

	if (!WCALL_VALID(wcall)) {
		warning("wcall(%p): ecall_quality_handler wcall not valid\n",
			wcall);
		return;
	}

	if (!inst->quality.netqh)
		return;

	if (uploss == ICALL_NETWORK_PROBLEM
	    && downloss == ICALL_NETWORK_PROBLEM)
		quality = WCALL_QUALITY_NETWORK_PROBLEM;
	if (rtt > 800 || uploss > 20 || downloss > 20)
		quality = WCALL_QUALITY_POOR;
	else if (rtt > 400 || uploss > 5 || downloss > 5)
		quality = WCALL_QUALITY_MEDIUM;

	info(APITAG "wcall(%p): calling netqh:%p %s.%s rtt=%d up=%d dn=%d q=%d\n",
	     wcall, inst->quality.netqh,
	     anon_id(userid_anon, userid),
	     anon_client(clientid_anon, clientid),
	     rtt, uploss, downloss, quality);
	now = tmr_jiffies();
	inst->quality.netqh(wcall->convid,
			    userid,
			    clientid,
			    quality,
			    rtt,
			    uploss,
			    downloss,
			    inst->quality.arg);
	info(APITAG "wcall(%p): netqh:%p (quality=%d) took %llu ms\n",
	     wcall, inst->quality.netqh, quality, tmr_jiffies() - now);
}
