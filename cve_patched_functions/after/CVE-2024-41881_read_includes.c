read_includes(item *i, uschar *main_filename)
{
BOOL yield = TRUE;
BOOL included = FALSE;
incfile *open_includes = NULL;

for (; i != NULL; i = i->next)
  {
  paramstr *p;
  item *rest;
  incfile *ff;

  if (open_includes != NULL && i == open_includes->end)
    open_includes = open_includes->next;

  if (Ustrcmp(i->name, "?sdop") != 0 ||
      (p = misc_param_find(i, US"include")) == NULL)
    continue;

  if (Ustrcmp(p->value, main_filename) == 0)
    (void)error(54, p->value);   /* Hard */

  for (ff = open_includes; ff != NULL; ff = ff->next)
    {
    if (Ustrcmp(p->value, ff->name) == 0)
      (void)error(54, p->value);   /* Hard */
    }

  ff = misc_malloc(sizeof(incfile) + Ustrlen(p->value));
  ff->next = open_includes;
  ff->end = i->next;
  open_includes = ff;
  Ustrcpy(ff->name, p->value);

  included = TRUE;
  rest = i->next;
  read_linenumber = i->linenumber;   /* For error on open failure */
  yield = read_file(p->value, i);
  if (!yield) break;
  read_addto->next = rest;
  rest->prev = read_addto;
  }

if (included)
  {
  DEBUG(D_read) debug_print_item_list(main_item_list,
    "at end of reading included files");
  }
else
  {
  DEBUG(D_read) debug_printf("No included files\n");
  }

return yield;
}
