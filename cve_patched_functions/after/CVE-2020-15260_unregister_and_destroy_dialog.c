static pj_status_t unregister_and_destroy_dialog( pjsip_dialog *dlg,
						  pj_bool_t unlock_mutex )
{
    pj_status_t status;

    /* Lock must have been held. */

    /* Check dialog state. */
    /* Number of sessions must be zero. */
    PJ_ASSERT_RETURN(dlg->sess_count==0, PJ_EINVALIDOP);

    /* MUST not have pending transactions. */
    PJ_ASSERT_RETURN(dlg->tsx_count==0, PJ_EINVALIDOP);

    /* Unregister from user agent, if it has been registered (see #1924) */
    if (dlg->dlg_set) {
	status = pjsip_ua_unregister_dlg(dlg->ua, dlg);
	if (status != PJ_SUCCESS) {
	    pj_assert(!"Unexpected failed unregistration!");
	    return status;
	}
    }

    /* Destroy this dialog. */
    destroy_dialog(dlg, unlock_mutex);

    return PJ_SUCCESS;
}
