    [&handler, expectedProtocol, expectedUpgradeHeader, &testH2IndexingStrat] {
      EXPECT_FALSE(handler->txn_->getSetupTransportInfo().secure);
      EXPECT_EQ(*handler->txn_->getSetupTransportInfo().appProtocol,
                expectedUpgradeHeader);
      if (expectedProtocol == CodecProtocol::HTTP_2) {
        const HTTP2Codec* codec = dynamic_cast<const HTTP2Codec*>(
          &handler->txn_->getTransport().getCodec());
        ASSERT_NE(codec, nullptr);
        EXPECT_EQ(codec->getHeaderIndexingStrategy(), &testH2IndexingStrat);
      }
      handler->sendReplyWithBody(200, 100);
    });
