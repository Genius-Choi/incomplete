static void pb_release_single_field(const pb_field_iter_t *iter)
{
    pb_type_t type;
    type = iter->pos->type;

    if (PB_ATYPE(type) == PB_ATYPE_POINTER)
    {
        if (PB_HTYPE(type) == PB_HTYPE_REPEATED &&
            (PB_LTYPE(type) == PB_LTYPE_STRING ||
             PB_LTYPE(type) == PB_LTYPE_BYTES))
        {
            /* Release entries in repeated string or bytes array */
            void **pItem = *(void***)iter->pData;
            pb_size_t count = *(pb_size_t*)iter->pSize;
            while (count--)
            {
                pb_free(*pItem);
                *pItem++ = NULL;
            }
            *(pb_size_t*)iter->pSize = 0;
        }
        else if (PB_LTYPE(type) == PB_LTYPE_SUBMESSAGE)
        {
            /* Release fields in submessages */
            void *pItem = *(void**)iter->pData;
            if (pItem)
            {
                pb_size_t count = 1;
                
                if (PB_HTYPE(type) == PB_HTYPE_REPEATED)
                {
                    count = *(pb_size_t*)iter->pSize;
                    *(pb_size_t*)iter->pSize = 0;
                }
                
                while (count--)
                {
                    pb_release((const pb_field_t*)iter->pos->ptr, pItem);
                    pItem = (uint8_t*)pItem + iter->pos->data_size;
                }
            }
        }
        
        /* Release main item */
        pb_free(*(void**)iter->pData);
        *(void**)iter->pData = NULL;
    }
}
