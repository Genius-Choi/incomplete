void test_nghttp2_submit_origin(void) {
  nghttp2_session *session;
  nghttp2_session_callbacks callbacks;
  my_user_data ud;
  int rv;
  ssize_t len;
  const uint8_t *data;
  static const uint8_t nghttp2[] = "https://nghttp2.org";
  static const uint8_t examples[] = "https://examples.com";
  static const nghttp2_origin_entry ov[] = {
      {
          (uint8_t *)nghttp2,
          sizeof(nghttp2) - 1,
      },
      {
          (uint8_t *)examples,
          sizeof(examples) - 1,
      },
  };
  nghttp2_frame frame;
  nghttp2_ext_origin origin;
  nghttp2_mem *mem;

  mem = nghttp2_mem_default();

  memset(&callbacks, 0, sizeof(nghttp2_session_callbacks));
  callbacks.on_frame_send_callback = on_frame_send_callback;

  frame.ext.payload = &origin;

  nghttp2_session_server_new(&session, &callbacks, &ud);

  rv = nghttp2_submit_origin(session, NGHTTP2_FLAG_NONE, ov, 2);

  CU_ASSERT(0 == rv);

  ud.frame_send_cb_called = 0;
  len = nghttp2_session_mem_send(session, &data);

  CU_ASSERT(len > 0);
  CU_ASSERT(1 == ud.frame_send_cb_called);

  nghttp2_frame_unpack_frame_hd(&frame.hd, data);
  rv = nghttp2_frame_unpack_origin_payload(
      &frame.ext, data + NGHTTP2_FRAME_HDLEN, (size_t)len - NGHTTP2_FRAME_HDLEN,
      mem);

  CU_ASSERT(0 == rv);
  CU_ASSERT(0 == frame.hd.stream_id);
  CU_ASSERT(NGHTTP2_ORIGIN == frame.hd.type);
  CU_ASSERT(2 == origin.nov);
  CU_ASSERT(0 == memcmp(nghttp2, origin.ov[0].origin, sizeof(nghttp2) - 1));
  CU_ASSERT(sizeof(nghttp2) - 1 == origin.ov[0].origin_len);
  CU_ASSERT(0 == memcmp(examples, origin.ov[1].origin, sizeof(examples) - 1));
  CU_ASSERT(sizeof(examples) - 1 == origin.ov[1].origin_len);

  nghttp2_frame_origin_free(&frame.ext, mem);

  nghttp2_session_del(session);

  /* Submitting ORIGIN frame from client session is error */
  nghttp2_session_client_new(&session, &callbacks, NULL);

  rv = nghttp2_submit_origin(session, NGHTTP2_FLAG_NONE, ov, 1);

  CU_ASSERT(NGHTTP2_ERR_INVALID_STATE == rv);

  nghttp2_session_del(session);

  /* Submitting empty ORIGIN frame */
  nghttp2_session_server_new(&session, &callbacks, &ud);

  rv = nghttp2_submit_origin(session, NGHTTP2_FLAG_NONE, NULL, 0);

  CU_ASSERT(0 == rv);

  ud.frame_send_cb_called = 0;
  len = nghttp2_session_mem_send(session, &data);

  CU_ASSERT(len == NGHTTP2_FRAME_HDLEN);
  CU_ASSERT(1 == ud.frame_send_cb_called);

  nghttp2_frame_unpack_frame_hd(&frame.hd, data);

  CU_ASSERT(NGHTTP2_ORIGIN == frame.hd.type);

  nghttp2_session_del(session);
}
