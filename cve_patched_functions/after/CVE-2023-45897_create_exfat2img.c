static int create_exfat2img(struct exfat2img *ei,
			    struct pbr *bs,
			    const char *out_path)
{
	int err;

	ei->exfat = exfat_alloc_exfat(&ei->bdev, bs);
	if (!ei->exfat)
		return -ENOMEM;

	ei->dump_bdesc = exfat_alloc_buffer(2,
					    ei->exfat->clus_size,
					    ei->exfat->sect_size);
	if (!ei->dump_bdesc) {
		err = -ENOMEM;
		goto err;
	}

	ei->scan_bdesc = exfat_alloc_buffer(2,
					    ei->exfat->clus_size,
					    ei->exfat->sect_size);
	if (!ei->scan_bdesc) {
		err = -ENOMEM;
		goto err;
	}

	if (strcmp(out_path, "-")) {
		ei->out_fd = open(out_path, O_CREAT | O_TRUNC | O_RDWR, 0664);
	} else {
		ei->is_stdout = true;
		ei->out_fd = fileno(stdout);
		ei->save_cc = true;
	}
	if (ei->out_fd < 0) {
		exfat_err("failed to open %s: %s\n", out_path,
			  strerror(errno));
		err = -errno;
		goto err;
	}

	return 0;
err:
	free_exfat2img(ei);
	return err;
}
