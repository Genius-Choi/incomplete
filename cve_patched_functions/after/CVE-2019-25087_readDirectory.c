Resource* ResourceHost::readDirectory(std::string path, struct stat sb) {
	Resource* res = NULL;
	// Make the path end with a / (for consistency) if it doesnt already
	if (path.empty() || path[path.length() - 1] != '/')
		path += "/";

	// Probe for valid indexes
	int numIndexes = sizeof(validIndexes) / sizeof(*validIndexes);
	std::string loadIndex;
	struct stat sidx;
	for (int i = 0; i < numIndexes; i++) {
		loadIndex = path + validIndexes[i];
		// Found a suitable index file to load and return to the client
		if (stat(loadIndex.c_str(), &sidx) != -1)
			return readFile(loadIndex.c_str(), sidx);
	}

	// Make sure the webserver USER owns the directory
	if (!(sb.st_mode & S_IRWXU))
		return NULL;

	// Generate an HTML directory listing
	std::string listing = generateDirList(path);

	unsigned int slen = listing.length();
	char* sdata = new char[slen];
	strncpy(sdata, listing.c_str(), slen);

	res = new Resource(path, true);
	res->setMimeType("text/html");
	res->setData((byte*)sdata, slen);

	return res;
}
