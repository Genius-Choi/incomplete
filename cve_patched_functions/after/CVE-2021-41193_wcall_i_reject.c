int wcall_i_reject(struct wcall *wcall)
{
	struct calling_instance *inst;
	char convid_anon[ANON_ID_LEN];
	int reason = WCALL_REASON_REJECTED;

	info(APITAG "wcall(%p): reject convid=%s\n", wcall,
	     wcall ? anon_id(convid_anon, wcall->convid) : "");

	if (!wcall)
		return EINVAL;

	inst = wcall->inst;

	info("wcall(%p): reject: convid=%s\n", wcall, anon_id(convid_anon, wcall->convid));

	switch (wcall->conv_type) {
	case WCALL_CONV_TYPE_GROUP:
	case WCALL_CONV_TYPE_CONFERENCE:
		reason = WCALL_REASON_STILL_ONGOING;
		break;

	case WCALL_CONV_TYPE_ONEONONE:
	default:
		reason = WCALL_REASON_REJECTED;
		break;
	}

	wcall->disable_audio = true;
	if (!wcall_has_calls()) {
		if (wcall->inst->mm) {
			mediamgr_set_call_state(wcall->inst->mm,
						MEDIAMGR_STATE_NORMAL);
		}
	}

	if (wcall->state == WCALL_STATE_INCOMING) {
		ICALL_CALL(wcall->icall, reject);
	
		if (inst->closeh) {
			uint64_t now = tmr_jiffies();
			info(APITAG "wcall(%p): wcall_reject: closeh(%p) "
			     "state=%s reason=%s\n",
			     wcall, inst->closeh, wcall_state_name(wcall->state),
			     wcall_reason_name(reason));

			inst->closeh(reason, wcall->convid,
				ECONN_MESSAGE_TIME_UNKNOWN, inst->userid,
				inst->clientid, inst->arg);
			info(APITAG "wcall(%p): wcall_reject: closeh took %llu ms\n",
			     wcall, tmr_jiffies() - now);
		}
	}

	return 0;
}
