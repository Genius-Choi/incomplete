X509_verify_cert(X509_STORE_CTX *ctx)
{
	STACK_OF(X509) *roots = NULL;
	struct x509_verify_ctx *vctx = NULL;
	int chain_count = 0;

	if (ctx->cert == NULL) {
		X509error(X509_R_NO_CERT_SET_FOR_US_TO_VERIFY);
		ctx->error = X509_V_ERR_INVALID_CALL;
		return -1;
	}
	if (ctx->chain != NULL) {
		/*
		 * This X509_STORE_CTX has already been used to verify
		 * a cert. We cannot do another one.
		 */
		X509error(ERR_R_SHOULD_NOT_HAVE_BEEN_CALLED);
		ctx->error = X509_V_ERR_INVALID_CALL;
		return -1;
	}
	if (ctx->param->id->poisoned) {
		/*
		 * This X509_STORE_CTX had failures setting
		 * up verify parameters. We can not use it.
		 */
		X509error(ERR_R_SHOULD_NOT_HAVE_BEEN_CALLED);
		ctx->error = X509_V_ERR_INVALID_CALL;
		return -1;
	}
	if (ctx->error != X509_V_ERR_INVALID_CALL) {
		/*
		 * This X509_STORE_CTX has not been properly initialized.
		 */
		X509error(ERR_R_SHOULD_NOT_HAVE_BEEN_CALLED);
		ctx->error = X509_V_ERR_INVALID_CALL;
		return -1;
	}

	/*
	 * If flags request legacy, use the legacy verifier. If we
	 * requested "no alt chains" from the age of hammer pants, use
	 * the legacy verifier because the multi chain verifier really
	 * does find all the "alt chains".
	 *
	 * XXX deprecate the NO_ALT_CHAINS flag?
	 */
	if ((ctx->param->flags & X509_V_FLAG_LEGACY_VERIFY) ||
	    (ctx->param->flags & X509_V_FLAG_NO_ALT_CHAINS))
		return X509_verify_cert_legacy(ctx);

	/* Use the modern multi-chain verifier from x509_verify_cert */

	if ((vctx = x509_verify_ctx_new_from_xsc(ctx)) != NULL) {
		ctx->error = X509_V_OK; /* Initialize to OK */
		chain_count = x509_verify(vctx, NULL, NULL);
	}
	x509_verify_ctx_free(vctx);

	sk_X509_pop_free(roots, X509_free);

	/* if we succeed we have a chain in ctx->chain */
	return (chain_count > 0 && ctx->chain != NULL);
}
