void FilterUtility::setUpstreamScheme(Http::RequestHeaderMap& headers, bool downstream_secure) {
  if (Http::Utility::schemeIsValid(headers.getSchemeValue())) {
    return;
  }
  // After all the changes in https://github.com/envoyproxy/envoy/issues/14587
  // this path should only occur if a buggy filter has removed the :scheme
  // header. In that case best-effort set from X-Forwarded-Proto.
  absl::string_view xfp = headers.getForwardedProtoValue();
  if (Http::Utility::schemeIsValid(xfp)) {
    headers.setScheme(xfp);
    return;
  }

  if (downstream_secure) {
    headers.setReferenceScheme(Http::Headers::get().SchemeValues.Https);
  } else {
    headers.setReferenceScheme(Http::Headers::get().SchemeValues.Http);
  }
}
