pf_inp_link(struct mbuf *m, struct inpcb *inp)
{
	struct pf_state_key *sk = m->m_pkthdr.pf.statekey;

	if (!pf_state_key_isvalid(sk)) {
		pf_mbuf_unlink_state_key(m);
		return;
	}

	/*
	 * we don't need to grab PF-lock here. At worst case we link inp to
	 * state, which might be just being marked as deleted by another
	 * thread.
	 */
	if (inp && !sk->sk_inp && !inp->inp_pf_sk)
		pf_state_key_link_inpcb(sk, inp);

	/* The statekey has finished finding the inp, it is no longer needed. */
	pf_mbuf_unlink_state_key(m);
}
