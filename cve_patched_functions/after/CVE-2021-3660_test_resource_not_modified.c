test_resource_not_modified (TestResourceCase *tc,
                            gconstpointer data)
{
  CockpitWebResponse *response;
  GError *error = NULL;
  GBytes *bytes;
  const gchar *expected = "HTTP/1.1 304 Not Modified\r\n"
    "ETag: \"" CHECKSUM "-c\"\r\n"
    STATIC_HEADERS
    "\r\n";

  request_checksum (tc);

  g_hash_table_insert (tc->headers, g_strdup ("If-None-Match"),
                       g_strdup ("\"" CHECKSUM "-c\""));

  response = cockpit_web_response_new (tc->io, "/unused", "/unused", NULL, tc->headers, COCKPIT_WEB_RESPONSE_NONE);
  cockpit_channel_response_serve (tc->service, tc->headers, response,
                                CHECKSUM,
                                "/test/sub/file.ext");

  while (cockpit_web_response_get_state (response) != COCKPIT_WEB_RESPONSE_SENT)
    g_main_context_iteration (NULL, TRUE);

  g_output_stream_close (G_OUTPUT_STREAM (tc->output), NULL, &error);
  g_assert_no_error (error);

  bytes = g_memory_output_stream_steal_as_bytes (tc->output);
  g_assert (str_contains_strv (g_bytes_get_data (bytes, NULL), expected, "\n"));

  g_bytes_unref (bytes);
  g_object_unref (response);
}
