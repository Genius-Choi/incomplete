        .WillOnce(Invoke([&, request_with_data_and_trailers](Buffer::Instance&) -> void {
          StreamDecoder* decoder = &conn_manager_->newStream(response_encoder_);
          HeaderMapPtr headers{
              new TestHeaderMapImpl{{":authority", "host"}, {":path", "/"}, {":method", "GET"}}};
          if (request_with_data_and_trailers) {
            decoder->decodeHeaders(std::move(headers), false);

            Buffer::OwnedImpl fake_data("12345");
            decoder->decodeData(fake_data, false);

            HeaderMapPtr trailers{new TestHeaderMapImpl{{"foo", "bar"}}};
            decoder->decodeTrailers(std::move(trailers));
          } else {
            decoder->decodeHeaders(std::move(headers), true);
          }
        }));
