static int samldb_check_user_account_control_objectclass_invariants(
	struct samldb_ctx *ac,
	uint32_t user_account_control,
	uint32_t user_account_control_old,
	bool is_computer_objectclass)
{
	struct ldb_context *ldb = ldb_module_get_ctx(ac->module);

	uint32_t old_ufa = user_account_control_old & UF_ACCOUNT_TYPE_MASK;
	uint32_t new_ufa = user_account_control & UF_ACCOUNT_TYPE_MASK;

	uint32_t old_rodc = user_account_control_old & UF_PARTIAL_SECRETS_ACCOUNT;
	uint32_t new_rodc = user_account_control & UF_PARTIAL_SECRETS_ACCOUNT;

	bool is_admin;
	struct security_token *user_token
		= acl_user_token(ac->module);
	if (user_token == NULL) {
		return LDB_ERR_INSUFFICIENT_ACCESS_RIGHTS;
	}

	is_admin
		= security_token_has_builtin_administrators(user_token);


	/*
	 * We want to allow changes to (eg) disable an account
	 * that was created wrong, only checking the
	 * objectclass if the account type changes.
	 */
	if (old_ufa == new_ufa && old_rodc == new_rodc) {
		return LDB_SUCCESS;
	}

	switch (new_ufa) {
	case UF_NORMAL_ACCOUNT:
		if (is_computer_objectclass && !is_admin) {
			ldb_asprintf_errstring(ldb,
				"%08X: samldb: UF_NORMAL_ACCOUNT "
				"requires objectclass 'user' not 'computer'!",
				W_ERROR_V(WERR_DS_MACHINE_ACCOUNT_CREATED_PRENT4));
			return LDB_ERR_OBJECT_CLASS_VIOLATION;
		}
		break;

	case UF_INTERDOMAIN_TRUST_ACCOUNT:
		if (is_computer_objectclass) {
			ldb_asprintf_errstring(ldb,
				"%08X: samldb: UF_INTERDOMAIN_TRUST_ACCOUNT "
				"requires objectclass 'user' not 'computer'!",
				W_ERROR_V(WERR_DS_MACHINE_ACCOUNT_CREATED_PRENT4));
			return LDB_ERR_OBJECT_CLASS_VIOLATION;
		}
		break;

	case UF_WORKSTATION_TRUST_ACCOUNT:
		if (!is_computer_objectclass) {
			/*
			 * Modify of a user account account into a
			 * workstation without objectclass computer
			 * as an admin is still permitted, but not
			 * to make an RODC
			 */
			if (is_admin
			    && ac->req->operation == LDB_MODIFY
			    && new_rodc == 0) {
				break;
			}
			ldb_asprintf_errstring(ldb,
				"%08X: samldb: UF_WORKSTATION_TRUST_ACCOUNT "
				"requires objectclass 'computer'!",
				W_ERROR_V(WERR_DS_MACHINE_ACCOUNT_CREATED_PRENT4));
			return LDB_ERR_OBJECT_CLASS_VIOLATION;
		}
		break;

	case UF_SERVER_TRUST_ACCOUNT:
		if (!is_computer_objectclass) {
			ldb_asprintf_errstring(ldb,
				"%08X: samldb: UF_SERVER_TRUST_ACCOUNT "
				"requires objectclass 'computer'!",
				W_ERROR_V(WERR_DS_MACHINE_ACCOUNT_CREATED_PRENT4));
			return LDB_ERR_OBJECT_CLASS_VIOLATION;
		}
		break;

	default:
		ldb_asprintf_errstring(ldb,
			"%08X: samldb: invalid userAccountControl[0x%08X]",
			W_ERROR_V(WERR_INVALID_PARAMETER),
				       user_account_control);
		return LDB_ERR_OTHER;
	}
	return LDB_SUCCESS;
}
