get_font_name_from_dpi(const struct xrdp_cfg_globals *globals,
                       unsigned int dpi,
                       char *font_name, int font_name_len)
{
    int bad_selector = 0;

    font_name[0] = '\0';

    const char *fv1_select = globals->fv1_select;
    if (fv1_select == NULL || fv1_select[0] == '\0')
    {
        fv1_select = DEFAULT_FV1_SELECT;
    }

    const char *p = fv1_select;

    while (p != NULL)
    {
        /* DPI value must be next in string */
        if (!isdigit(*p))
        {
            bad_selector = 1;
            break;
        }
        unsigned int field_dpi = g_atoi(p);
        if (field_dpi <= dpi)
        {
            /* Use this font */
            p = g_strchr(p, ':');
            if (p == NULL)
            {
                bad_selector = 1;
            }
            else
            {
                ++p;
                const char *q = g_strchr(p, ',');
                if (q == NULL)
                {
                    q = p + g_strlen(p);
                }
                if (q - p > (font_name_len - 1))
                {
                    q = p + font_name_len - 1;
                }
                g_memcpy(font_name, p, q - p);
                font_name[q - p] = '\0';
            }
            break;
        }
        else
        {
            p = g_strchr(p, ',');
            if (p != NULL)
            {
                ++p;
            }
        }
    }

    if (bad_selector)
    {
        LOG(LOG_LEVEL_WARNING, "Unable to parse fv1_select configuration");
    }

    if (font_name[0] == '\0')
    {
        LOG(LOG_LEVEL_WARNING, "Loading default font " DEFAULT_FONT_NAME);
        g_snprintf(font_name, font_name_len, DEFAULT_FONT_NAME);
    }
}
