SWITCH_DECLARE(switch_status_t) switch_rtp_write_raw(switch_rtp_t *rtp_session, void *data, switch_size_t *bytes, switch_bool_t process_encryption)
{
	switch_status_t status = SWITCH_STATUS_FALSE;

	switch_assert(bytes);

	if (!switch_rtp_ready(rtp_session) || !rtp_session->remote_addr || *bytes > SWITCH_RTP_MAX_BUF_LEN) {
		return status;
	}

	if (!rtp_write_ready(rtp_session, *bytes, __LINE__)) {
		return SWITCH_STATUS_NOT_INITALIZED;
	}

	WRITE_INC(rtp_session);

	if (process_encryption) {
#ifdef ENABLE_SRTP
		switch_mutex_lock(rtp_session->ice_mutex);
		if (rtp_session->flags[SWITCH_RTP_FLAG_SECURE_SEND]) {

			int sbytes = (int) *bytes;
			srtp_err_status_t stat;

			if (rtp_session->flags[SWITCH_RTP_FLAG_SECURE_SEND_RESET]) {
				switch_rtp_clear_flag(rtp_session, SWITCH_RTP_FLAG_SECURE_SEND_RESET);
				srtp_dealloc(rtp_session->send_ctx[rtp_session->srtp_idx_rtp]);
				rtp_session->send_ctx[rtp_session->srtp_idx_rtp] = NULL;
				if (srtp_create(&rtp_session->send_ctx[rtp_session->srtp_idx_rtp],
										&rtp_session->send_policy[rtp_session->srtp_idx_rtp]) || !rtp_session->send_ctx[rtp_session->srtp_idx_rtp]) {
					switch_log_printf(SWITCH_CHANNEL_SESSION_LOG(rtp_session->session), SWITCH_LOG_ERROR, "Error! RE-Activating Secure RTP SEND\n");
					rtp_session->flags[SWITCH_RTP_FLAG_SECURE_SEND] = 0;
					status = SWITCH_STATUS_FALSE;
					switch_mutex_unlock(rtp_session->ice_mutex);
					goto end;
				} else {
					switch_log_printf(SWITCH_CHANNEL_SESSION_LOG(rtp_session->session), SWITCH_LOG_INFO, "RE-Activating Secure RTP SEND\n");
				}
			}

			if (!rtp_session->flags[SWITCH_RTP_FLAG_SECURE_SEND_MKI]) {
				stat = srtp_protect(rtp_session->send_ctx[rtp_session->srtp_idx_rtp], &rtp_session->write_msg.header, &sbytes);
			} else {
				stat = srtp_protect_mki(rtp_session->send_ctx[rtp_session->srtp_idx_rtp], &rtp_session->write_msg.header, &sbytes, 1, SWITCH_CRYPTO_MKI_INDEX);
			}

			if (stat) {
				switch_log_printf(SWITCH_CHANNEL_SESSION_LOG(rtp_session->session), SWITCH_LOG_ERROR, "Error: SRTP protection failed with code %d\n", stat);
			}
			*bytes = sbytes;
		}
		switch_mutex_unlock(rtp_session->ice_mutex);
#endif
	}

	status = switch_socket_sendto(rtp_session->sock_output, rtp_session->remote_addr, 0, data, bytes);
#if defined(ENABLE_SRTP)
 end:
#endif

	WRITE_DEC(rtp_session);

	return status;
}
