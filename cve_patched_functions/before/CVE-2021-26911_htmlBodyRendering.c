String * IMAPSession::htmlBodyRendering(IMAPMessage * message, String * folder, ErrorCode * pError)
{
    MCAssert(folder != NULL);
    HTMLRendererIMAPDataCallback * dataCallback = new HTMLRendererIMAPDataCallback(this, message->uid());
    HTMLBodyRendererTemplateCallback * htmlCallback = new HTMLBodyRendererTemplateCallback();
    
    String * htmlBodyString = HTMLRenderer::htmlForIMAPMessage(folder,
                                                               message,
                                                               dataCallback,
                                                               htmlCallback);

    * pError = dataCallback->error();
    
    MC_SAFE_RELEASE(dataCallback);
    MC_SAFE_RELEASE(htmlCallback);

    if (* pError != ErrorNone) {
        return NULL;
    }
    
    return htmlBodyString;
}
