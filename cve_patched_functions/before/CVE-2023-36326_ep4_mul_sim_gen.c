void ep4_mul_sim_gen(ep4_t r, const bn_t k, const ep4_t q, const bn_t m) {
	ep4_t gen;

	ep4_null(gen);

	if (bn_is_zero(k)) {
		ep4_mul(r, q, m);
		return;
	}
	if (bn_is_zero(m) || ep4_is_infty(q)) {
		ep4_mul_gen(r, k);
		return;
	}

	RLC_TRY {
		ep4_new(gen);

		ep4_curve_get_gen(gen);
#if EP_FIX == LWNAF && defined(EP_PRECO)
		ep4_mul_sim_plain(r, gen, k, q, m, ep4_curve_get_tab());
#else
		ep4_mul_sim(r, gen, k, q, m);
#endif
	}
	RLC_CATCH_ANY {
		RLC_THROW(ERR_CAUGHT);
	}
	RLC_FINALLY {
		ep4_free(gen);
	}
}
