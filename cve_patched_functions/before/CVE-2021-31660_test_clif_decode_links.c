static void test_clif_decode_links(void)
{
    /* string to decode */
    char input_string[] = "</sensors>;ct=40;title=\"\\\"Sensor\\\" Index, collection\","
                          "</sensors/temp>;rt=\"temperature-c\";if=\"sensor\","
                          "</sensors/light>;rt=\"light-lux\";if=sensor,"
                          "<http://www.example.com/sensors/t123>;"
                          "anchor=\"/sensors/temp\";rel=\"describedby\";sz=1234,"
                          "</t>;anchor=\"/sensors/temp\";rel=\"alternate\";a;s=\"This is \\\"escaped and has , \\\"\","
                          "</riot/board>,</riot/info>;obs";

    /* ordered expected types to be decoded */
    clif_attr_type_t exp_types[] = {
        CLIF_ATTR_CT, CLIF_ATTR_TITLE, CLIF_ATTR_RT, CLIF_ATTR_IF,
        CLIF_ATTR_RT, CLIF_ATTR_IF, CLIF_ATTR_ANCHOR, CLIF_ATTR_REL,
        CLIF_ATTR_SZ, CLIF_ATTR_ANCHOR, CLIF_ATTR_REL, CLIF_ATTR_EXT,
        CLIF_ATTR_EXT, CLIF_ATTR_OBS
    };

    /* ordered amount of expected attributes per link to be decoded */
    unsigned exp_attr_numof[] = { 2, 2, 2, 3, 4, 0, 1 };

    /* ordered expected attributes to be decoded */
    clif_attr_t exp_attrs[] = {
        _NEW_ATTR("ct", "40"),
        _NEW_ATTR("title", "\\\"Sensor\\\" Index, collection"),
        _NEW_ATTR("rt", "temperature-c"),
        _NEW_ATTR("if", "sensor"),
        _NEW_ATTR("rt", "light-lux"),
        _NEW_ATTR("if", "sensor"),
        _NEW_ATTR("anchor", "/sensors/temp"),
        _NEW_ATTR("rel", "describedby"),
        _NEW_ATTR("sz", "1234"),
        _NEW_ATTR("anchor", "/sensors/temp"),
        _NEW_ATTR("rel", "alternate"),
        _NEW_ATTR_NO_VAL("a"),
        _NEW_ATTR("s", "This is \\\"escaped and has , \\\""),
        _NEW_ATTR_NO_VAL("obs"),
    };

    /* ordered expected targets to be decoded */
    const char *exp_targets[] = {
        "/sensors", "/sensors/temp", "/sensors/light",
        "http://www.example.com/sensors/t123", "/t", "/riot/board", "/riot/info"
    };

    const unsigned exp_links_numof = ARRAY_SIZE(exp_targets);
    const unsigned exp_attrs_numof = ARRAY_SIZE(exp_attrs);
    const size_t input_len = sizeof(input_string) - 1;

    clif_t out_link;
    char *pos = input_string;
    unsigned links_numof = 0;

    /* first test without attributes array, to test the expected attributes
     * functionality */
    do {
        ssize_t res = clif_decode_link(&out_link, NULL, 0, pos,
                                       input_len - (pos - input_string));
        if (res < 0) {
            break;
        }
        pos += res;

        /* check expected target */
        TEST_ASSERT(!strncmp(exp_targets[links_numof], out_link.target, out_link.target_len));

        /* check expected amount of attributes */
        TEST_ASSERT_EQUAL_INT(exp_attr_numof[links_numof], out_link.attrs_len);
        links_numof++;
    } while (pos < input_string + sizeof(input_string));

#ifdef TESTS_CLIF_PRINT
    puts("\n========================================");
    puts("[Test: decode_links]");
    printf("- Amount of decoded links: %u\n", links_numof);
#endif
    TEST_ASSERT(exp_links_numof == links_numof);

    /* now decode again but saving the attributes */
    clif_attr_t out_attrs[ARRAY_SIZE(exp_attrs)];
    pos = input_string;
    unsigned attrs_numof = 0;
    do {
        ssize_t res = clif_decode_link(&out_link, &out_attrs[attrs_numof],
                                       exp_attrs_numof - attrs_numof, pos,
                                       input_len - (pos - input_string));

        if (res < 0) {
            break;
        }
        pos += res;
#ifdef TESTS_CLIF_PRINT
        puts("---------------------");
        puts("New link:");
        printf("- Target: %.*s\n", out_link.target_len, out_link.target);
        printf("- Number of attributes: %d\n", out_link.attrs_len);
#endif

        for (unsigned i = 0; i < out_link.attrs_len; i++) {
#ifdef TESTS_CLIF_PRINT
            _print_attr(&out_link.attrs[i]);
#endif
            /* compare the attribute structure with the expected one */
            TEST_ASSERT(!_compare_attrs(&out_link.attrs[i],
                                         &exp_attrs[attrs_numof]));
            clif_attr_type_t type = clif_get_attr_type(out_link.attrs[i].key,
                                                         out_link.attrs[i].key_len);

            /* check that the returned type is the expected one */
            TEST_ASSERT_EQUAL_INT(exp_types[attrs_numof], type);

            /* test type to string conversion */
            const char *t;
            if (clif_attr_type_to_str(type, &t) < 0) {
                t = NULL;
            }
            TEST_ASSERT_EQUAL_STRING(type == CLIF_ATTR_EXT ?
                                     NULL : exp_attrs[attrs_numof].key, t);
            attrs_numof++;
        }
    } while (pos < input_string + sizeof(input_string));
    TEST_ASSERT_EQUAL_INT(exp_attrs_numof, attrs_numof);
}
