DIMSE_parseCmdObject(T_DIMSE_Message *msg, DcmDataset *obj)
    /*
     * This function parses the information in the DcmDataset object which was passed
     * and creates a corresponding T_DIMSE_Message structure which represents the
     * DIMSE message which is contained in obj.
     *
     * Parameters:
     *   msg - [out] Contains in the end the DIMSE message which is contained in obj.
     *   obj - [in] The DcmDataset object which shall be parsed.
     */
{
    Uint16 cmd = DIMSE_NOTHING;
    Uint32 glen = 0;

    /* remove group length attribute if there is one in obj */
    getAndDeleteULOpt(obj, DCM_CommandGroupLength, &glen);

    /* get the command field */
    OFCondition cond = getUS(obj, DCM_CommandField, &cmd);
    if (cond.bad())
    {
      return makeDcmnetCondition(DIMSEC_PARSEFAILED, OF_error, "DIMSE_parseCmdObject: Missing CommandField");
    }

    /* initialize msg structure */
    memset((char*)msg, 0, sizeof(*msg));
    msg->CommandField = (T_DIMSE_Command)cmd;

    /* depending on the command, parse the rest of obj */
    /* and insert corresponding information into msg */
    switch (cmd) {
    case DIMSE_C_ECHO_RQ:
        cond = parseCEchoRQ(&msg->msg.CEchoRQ, obj);
        break;
    case DIMSE_C_ECHO_RSP:
        cond = parseCEchoRSP(&msg->msg.CEchoRSP, obj);
        break;
    case DIMSE_C_STORE_RQ:
        cond = parseCStoreRQ(&msg->msg.CStoreRQ, obj);
        break;
    case DIMSE_C_STORE_RSP:
        cond = parseCStoreRSP(&msg->msg.CStoreRSP, obj);
        break;
    case DIMSE_C_GET_RQ:
        cond = parseCGetRQ(&msg->msg.CGetRQ, obj);
        break;
    case DIMSE_C_GET_RSP:
        cond = parseCGetRSP(&msg->msg.CGetRSP, obj);
        break;
    case DIMSE_C_FIND_RQ:
        cond = parseCFindRQ(&msg->msg.CFindRQ, obj);
        break;
    case DIMSE_C_FIND_RSP:
        cond = parseCFindRSP(&msg->msg.CFindRSP, obj);
        break;
    case DIMSE_C_MOVE_RQ:
        cond = parseCMoveRQ(&msg->msg.CMoveRQ, obj);
        break;
    case DIMSE_C_MOVE_RSP:
        cond = parseCMoveRSP(&msg->msg.CMoveRSP, obj);
        break;
    case DIMSE_C_CANCEL_RQ:
        cond = parseCCancelRQ(&msg->msg.CCancelRQ, obj);
        break;
    case DIMSE_N_EVENT_REPORT_RQ:
        cond = parseNEventReportRQ(&msg->msg.NEventReportRQ, obj);
        break;
    case DIMSE_N_EVENT_REPORT_RSP:
        cond = parseNEventReportRSP(&msg->msg.NEventReportRSP, obj);
        break;
    case DIMSE_N_GET_RQ:
        cond = parseNGetRQ(&msg->msg.NGetRQ, obj);
        break;
    case DIMSE_N_GET_RSP:
        cond = parseNGetRSP(&msg->msg.NGetRSP, obj);
        break;
    case DIMSE_N_SET_RQ:
        cond = parseNSetRQ(&msg->msg.NSetRQ, obj);
        break;
    case DIMSE_N_SET_RSP:
        cond = parseNSetRSP(&msg->msg.NSetRSP, obj);
        break;
    case DIMSE_N_ACTION_RQ:
        cond = parseNActionRQ(&msg->msg.NActionRQ, obj);
        break;
    case DIMSE_N_ACTION_RSP:
        cond = parseNActionRSP(&msg->msg.NActionRSP, obj);
        break;
    case DIMSE_N_CREATE_RQ:
        cond = parseNCreateRQ(&msg->msg.NCreateRQ, obj);
        break;
    case DIMSE_N_CREATE_RSP:
        cond = parseNCreateRSP(&msg->msg.NCreateRSP, obj);
        break;
    case DIMSE_N_DELETE_RQ:
        cond = parseNDeleteRQ(&msg->msg.NDeleteRQ, obj);
        break;
    case DIMSE_N_DELETE_RSP:
        cond = parseNDeleteRSP(&msg->msg.NDeleteRSP, obj);
        break;
    default:
        {
          char buf[256];
          sprintf(buf, "DIMSE_parseCmdObject: Invalid Command Message: 0x%x", msg->CommandField);
          cond = makeDcmnetCondition(DIMSEC_BADCOMMANDTYPE, OF_error, buf);
        }
        break;
    }

    /* return result value */
    return cond;
}
