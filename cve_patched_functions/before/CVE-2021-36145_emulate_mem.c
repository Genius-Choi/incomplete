emulate_mem(struct vmctx *ctx, struct mmio_request *mmio_req)
{
	uint64_t paddr = mmio_req->address;
	int size = mmio_req->size;
	struct mmio_rb_range *hint, *entry = NULL;
	int err;

	pthread_rwlock_rdlock(&mmio_rwlock);

	/*
	 * First check the per-VM cache
	 */
	hint = mmio_hint;

	if (hint && paddr >= hint->mr_base && paddr <= hint->mr_end)
		entry = hint;
	else if (mmio_rb_lookup(&mmio_rb_root, paddr, &entry) == 0)
		/* Update the per-VM cache */
		mmio_hint = entry;
	else if (mmio_rb_lookup(&mmio_rb_fallback, paddr, &entry)) {
		pthread_rwlock_unlock(&mmio_rwlock);
		return -ESRCH;
	}

	pthread_rwlock_unlock(&mmio_rwlock);

	if (entry == NULL)
		return -EINVAL;

	if (mmio_req->direction == REQUEST_READ)
		err = mem_read(ctx, 0, paddr, (uint64_t *)&mmio_req->value,
				size, &entry->mr_param);
	else
		err = mem_write(ctx, 0, paddr, mmio_req->value,
				size, &entry->mr_param);

	return err;
}
