int ecall_set_video_send_state(struct ecall *ecall, enum icall_vstate vstate)
{
	int err = 0;

	if (!ecall)
		return EINVAL;

	info("ecall(%p): set_video_send_state %s econn %p update %d\n",
	     ecall,
	     icall_vstate_name(vstate),
	     ecall->econn,
	     ecall->update);

	const char *vstate_string;
	const char *sstate_string;
	switch (vstate) {
	case ICALL_VIDEO_STATE_STARTED:
		vstate_string = "true";
		sstate_string = "false";
		break;
	case ICALL_VIDEO_STATE_SCREENSHARE:
		vstate_string = "false";
		sstate_string = "true";
		break;
	case ICALL_VIDEO_STATE_PAUSED:
		vstate_string = "paused";
		sstate_string = "false";
		break;
	case ICALL_VIDEO_STATE_STOPPED:
	default:
		vstate_string = "false";
		sstate_string = "false";
		break;
	}
	err = econn_props_update(ecall->props_local, "videosend", vstate_string);
	if (err) {
		warning("ecall(%p): econn_props_update(videosend)",
			" failed (%m)\n", ecall, err);
		return err;
	}
	err = econn_props_update(ecall->props_local, "screensend", sstate_string);
	if (err) {
		warning("ecall(%p): econn_props_update(screensend)",
			" failed (%m)\n", ecall, err);
		return err;
	}

	ecall->vstate = vstate;
	if (ecall->conv_type == ICALL_CONV_TYPE_ONEONONE) {
		ICALL_CALL_CB(ecall->icall, vstate_changedh,
			      &ecall->icall, ecall->userid_self, ecall->clientid_self,
			      vstate, ecall->icall.arg);
	}

	/* if the call has video, update mediaflow */
	if (ecall->flow && ICALL_CALLE(ecall->flow, has_video)) {
		err = IFLOW_CALLE(ecall->flow, set_video_state, vstate);
		if (err) {
			warning("ecall(%p): set_video_send_active:"
				" failed to set mf->active (%m)\n", ecall, err);
			goto out;
		}
	}
	else if (ICALL_VIDEO_STATE_STARTED == vstate
		 || ICALL_VIDEO_STATE_SCREENSHARE == vstate) {
		/* If webapp sent us a SETUP for audio only call and we are escalating, */
		/* force an UPDATE so they can answer with video recvonly AUDIO-1549 */
		enum econn_state state = econn_current_state(ecall->econn);
		switch (state) {
		case ECONN_ANSWERED:
		case ECONN_DATACHAN_ESTABLISHED:
			ecall_restart(ecall, ICALL_CALL_TYPE_VIDEO);
			goto out;
			
		default:
			break;
		}
	}

	/* sync the properties to the remote peer */
	if (!ecall->devpair
	    && !ecall->update
	    && econn_can_send_propsync(ecall->econn)) {
		info("ecall(%p): set_video_send_state: setting props "
			"videosend:%s screensend:%s\n",
			ecall, vstate_string, sstate_string);

		err = econn_send_propsync(ecall->econn, false,
					  ecall->props_local);
		if (err) {
			warning("ecall: set_video: econn_send_propsync"
				" failed (%m)\n",
				err);
			goto out;
		}
	}

 out:
	return err;
}
