static int verify_custom_certificate_if_needed(TLS_IO_INSTANCE* tls_io_instance)
{
    int result;

    if (tls_io_instance->trustedCertificate == NULL)
    {
        // If there is no trusted certificate set by API caller, then we'll rely on implicit Windows certificate store to verify the certificate.
        result = 0;
    }
    else
    {
        PCERT_CONTEXT serverCertificateToVerify = NULL;

        SECURITY_STATUS status = QueryContextAttributes(&tls_io_instance->security_context, SECPKG_ATTR_REMOTE_CERT_CONTEXT, &serverCertificateToVerify);
        if (status != SEC_E_OK)
        {
            LogError("QueryContextAttributes failed: %x", status);
            result = MU_FAILURE;
        }
        else if (x509_verify_certificate_in_chain(tls_io_instance->trustedCertificate, serverCertificateToVerify) != 0)
        {
            LogError("Failed to verify trusted certificate in chain");
            result = MU_FAILURE;
        }
        else
        {
            result = 0;
        }

        if (serverCertificateToVerify)
        {
            CertFreeCertificateContext(serverCertificateToVerify);
        }
    }

    return result;
}
