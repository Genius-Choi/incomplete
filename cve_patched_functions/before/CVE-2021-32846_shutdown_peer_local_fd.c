static void shutdown_peer_local_fd(struct pci_vtsock_sock *s, uint32_t mode,
				       const char *ctx)
{
	int rc;
	int how;
	const char *how_str;
	uint32_t new = mode | s->peer_shutdown;
	uint32_t set = s->peer_shutdown ^ new;
	uint32_t new_local = s->local_shutdown;

	assert((mode & ~VIRTIO_VSOCK_FLAG_SHUTDOWN_ALL) == 0);
	assert(mode != 0);

	DPRINTF(("%s: PEER CUR %"PRIx32", MODE %"PRIx32", NEW %"PRIx32", SET %"PRIx32"\n",
		 ctx, s->peer_shutdown, mode, new, set));

	switch (set) {
	case 0:
		return;
	case VIRTIO_VSOCK_FLAG_SHUTDOWN_TX:
		if (sock_is_buffering(s))
		{
			PPRINTF(("%s: fd: %d SHUT_WR while buffering, deferring local shutdown\n", ctx, s->fd));
			how = 0;
			how_str = "none";
		} else  {
			how = SHUT_WR;
			how_str = "SHUT_WR";
			new_local |= VIRTIO_VSOCK_FLAG_SHUTDOWN_RX;
		}
		break;
	case VIRTIO_VSOCK_FLAG_SHUTDOWN_RX:
		how = SHUT_RD;
		how_str = "SHUT_RD";
		new_local = s->local_shutdown | VIRTIO_VSOCK_FLAG_SHUTDOWN_TX;
		break;
	case VIRTIO_VSOCK_FLAG_SHUTDOWN_ALL:
		if (sock_is_buffering(s)) {
			PPRINTF(("%s: fd: %d SHUT_RDWR while buffering, deferring local SHUT_WR\n", ctx, s->fd));
			how = SHUT_RD;
			how_str = "SHUT_RD";
			new_local |= VIRTIO_VSOCK_FLAG_SHUTDOWN_TX;
		} else {
			how = SHUT_RDWR;
			how_str = "SHUT_RDWR";
			new_local |= VIRTIO_VSOCK_FLAG_SHUTDOWN_ALL;
		}
		break;
	default:
		abort();
	}

	if (how) {
		rc = shutdown(s->fd, how);
		DPRINTF(("%s: shutdown_peer: shutdown(%d, %s)\n", ctx, s->fd, how_str));
		if (rc < 0 && errno != ENOTCONN) {
			DPRINTF(("%s: shutdown(%d, %s) for peer shutdown failed: %s\n",
				 ctx, s->fd, how_str, strerror(errno)));
			abort();
		}
	}

	s->local_shutdown = new_local;
	s->peer_shutdown = new;
}
