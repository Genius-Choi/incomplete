decode_mp_next_hop(tvbuff_t *tvb, proto_tree *tree, packet_info *pinfo, guint16 afi, guint8 safi, gint nhlen)
{
    proto_item    *ti;
    proto_tree    *next_hop_t;
    int            length, offset = 0;
    wmem_strbuf_t *strbuf;

    strbuf = wmem_strbuf_create(pinfo->pool);

    /* BGP Multiprotocol Next Hop Principles
     *
     * BGP Multiprotocol support is specified over a large variety of
     * RFCs for different <AFI, SAFI> pairs, which leaves some theoretical
     * pairings undefined (e.g., the Abstract of RFC 4760 contemplates
     * supporting the IPX address family) as well as leading to some
     * omissions, contradictions, and inconsistencies. However, some general
     * principles that apply across (nearly) all extant pairs exist.
     *
     * 1. Global IPv6 addresses can be followed by a link-local IPv6 address
     *
     * RFC 2545 specifies in section 3, "Constructing the Next Hop field,"
     * that when the next hop address type is IPv6, the address given should
     * be in global (or site-local) unicast address scope, and it shall be
     * followed by the link-local address if and only if the BGP speaker shares
     * a common subnet with the address and the peer the route is being
     * advertised to.
     *
     * The wording implies that this holds for any <AFI, SAFI> pair where
     * a IPv6 address is used, and RFCs 5549, 7752, and 8950 demonstrate that
     * this explicitly holds for the most common ones, including for VPN-IPv6
     * addresses (where the route distinguisher field also appears, see
     * RFC 4659). Sometimes the possibility is elided where it is known to
     * exist e.g. RFC 7606 7.11 MP_REACH_NLRI "For example, if RFC5549 is in
     * use, then the next hop would have to have a length of 4 or 16." Thus
     * it is possible that its omission in other RFCs covering new <AFI, SAFI>
     * pairs is an oversight.
     *
     * 2. [VPN-]IPv4 NLRI can have [VPN-]IPv6 Next Hop addresses
     *
     * RFCs 5549 and 8950 declare that the next hop address may not necessarily
     * belong to the address family specified by the AFI, updating RFC 2858,
     * specifically addressing the case of IPv6 islands across a IPv4 core
     * and vice versa.
     *
     * IPv4 addresses can easily be mapped into IPv6 addresses, and that
     * is the solution for one case, but in the other the Next Hop must be an
     * IPv6 (or VPN-IPv6) address even though the NLRI is IPv4.
     *
     * The wording of RFC 8950 strongly implies that the intent is to allow
     * IPv6 Net Hop addresses for any case of IPv4 or VPN-IPv4 NLRI, providing
     * a BGP Capability to declare that the BGP speakers supports a different
     * Next Hop AFI for <AFI, SAFI> pairs defined without this capability,
     * and noting those (like <1, 132>, SAFNUM_ROUTE_TARGET, RFC 4684) that
     * consider the possibility from the start.
     *
     * 3. Next Hop Route Distinguisher (RD) is 0 or omitted
     *
     * RDs do not have a meaning in the Next Hop network address. However, when
     * RFC 2547 introduced the VPN-IPv4 address family, at that point the Next
     * Hop address family had to be the same as the NLRI address family, so the
     * RD was set to all 0. Later defined <AFI, SAFI> pairs with RDs in their
     * NLRI have either used this custom of a 0 RD, or else omitted it and
     * only had the IP address in the Next Hop.
     */

    ti = proto_tree_add_item(tree, hf_bgp_update_path_attribute_mp_reach_nlri_next_hop, tvb, offset, nhlen + 1, ENC_NA);
    next_hop_t = proto_item_add_subtree(ti, ett_bgp_mp_nhna);
    offset += 1;

    switch (afi) {
        case AFNUM_INET:
            switch (safi) {
                case SAFNUM_UNICAST:       /* RFC 8950 */
                case SAFNUM_MULCAST:       /* RFC 8950 */
                case SAFNUM_UNIMULC:       /* Deprecated, but as above */
                case SAFNUM_MPLS_LABEL:    /* RFC 8277 */
                case SAFNUM_MCAST_VPN:     /* RFC 6514 */
                case SAFNUM_ENCAPSULATION: /* RFC 5512, but "never been used"
                                            * according to
                                            * draft-ietf-idr-tunnel-encaps-22
                                            */
                case SAFNUM_ROUTE_TARGET:  /* RFC 4684 */
                case SAFNUM_BGP_MUP:       /* draft-mpmz-bess-mup-safi-00 */
                    /* IPv4 or IPv6, differentiated by field length, according
                     * to the RFCs cited above. RFC 8950 explicitly addresses
                     * the possible link-local IPv6 address. RFC 6514 depending
                     * on the situation either the Next Hop MUST be the same
                     * as in the IP Address field lower in the network stack,
                     * or simply SHOULD be "a routeable address" of the ASBR/
                     * local PE. */
                    if ((length = decode_mp_next_hop_ipv4(tvb, next_hop_t, offset, pinfo, strbuf, nhlen)) == 0) {
                        length = decode_mp_next_hop_ipv6(tvb, next_hop_t, offset, pinfo, strbuf, nhlen);
                    }
                    break;
                case SAFNUM_TUNNEL:
                    /* Internet Draft draft-nalawade-kapoor-tunnel-safi-05
                     * long expired, but "[NLRI] network address... SHOULD be
                     * the same as the [Next Hop] network address."
                     */
                    length = decode_mp_next_hop_ipv4(tvb, next_hop_t, offset, pinfo, strbuf, nhlen);
                    break;
                case SAFNUM_LAB_VPNUNICAST: /* RFC 8950 */
                case SAFNUM_LAB_VPNMULCAST: /* RFC 8950 */
                case SAFNUM_LAB_VPNUNIMULC: /* Deprecated, but as above */
                    /* RFC 8950 indicates that the next hop can be VPN-IPv4 or
                     * VPN-IPv6 (with RD all 0), and in the latter case the
                     * link-local IPv6 address can be included. Note that RFC
                     * 5549 incorrectly did not include the RD in the Next Hop
                     * for VPN-IPv6 (see Erratum ID 5253), but according to
                     * RFC 8950 2. "Changes Compared to RFC 5549":
                     * "As all known and deployed implementations are
                     * interoperable today and use the new proposed encoding,
                     * the change does not break existing interoperability,"
                     * and thus we need not test for a missing RD.
                     */
                    if ((length = decode_mp_next_hop_vpn_ipv4(tvb, next_hop_t, offset, pinfo, strbuf, nhlen)) == 0) {
                        length = decode_mp_next_hop_vpn_ipv6(tvb, next_hop_t, offset, pinfo, strbuf, nhlen);
                    }
                    break;
                case SAFNUM_FSPEC_RULE:
                case SAFNUM_FSPEC_VPN_RULE:
                    length = 0;
                    /* When advertising Flow Specifications, the Length of the
                     * Next-Hop Address MUST be set 0. The Network Address of
                     * the Next-Hop field MUST be ignored.
                     */
                    if (nhlen != 0) {
                        expert_add_info_format(pinfo, ti, &ei_bgp_length_invalid,
                                               "The length (%d) of Next Hop (FlowSpec) is not zero", nhlen);
                        break;
                    }
                    length++;
                    break;
                default:
                    length = 0;
                    expert_add_info_format(pinfo, ti, &ei_bgp_unknown_safi,
                                    "Unknown SAFI (%u) for AFI %u", safi, afi);
                    break;
            } /* switch (safi) */
            break;
        case AFNUM_INET6:
            switch (safi) {
                case SAFNUM_UNICAST:       /* RFC 8950 */
                case SAFNUM_MULCAST:       /* RFC 8950 */
                case SAFNUM_UNIMULC:       /* Deprecated, but as above */
                case SAFNUM_MPLS_LABEL:    /* RFC 8277 */
                case SAFNUM_MCAST_VPN:     /* RFC 6514 */
                case SAFNUM_ENCAPSULATION: /* RFC 5512, but "never been used" */
                case SAFNUM_TUNNEL:        /* Expired Internet Draft */
                case SAFNUM_BGP_MUP:       /* draft-mpmz-bess-mup-safi-00 */
                    /* IPv6 address, possibly followed by link-local address */
                    length = decode_mp_next_hop_ipv6(tvb, next_hop_t, offset, pinfo, strbuf, nhlen);
                    break;
                case SAFNUM_LAB_VPNUNICAST: /* RFC 8950 */
                case SAFNUM_LAB_VPNMULCAST: /* RFC 8950 */
                case SAFNUM_LAB_VPNUNIMULC: /* Deprecated, but as above */
                    /* VPN-IPv6 address, possibly followed by link-local addr */
                    length = decode_mp_next_hop_vpn_ipv6(tvb, next_hop_t, offset, pinfo, strbuf, nhlen);
                    break;
                case SAFNUM_FSPEC_RULE:
                case SAFNUM_FSPEC_VPN_RULE:
                    length = 0;
                    /* When advertising Flow Specifications, the Length of the
                     * Next-Hop Address MUST be set 0. The Network Address of
                     * the Next-Hop field MUST be ignored.
                     */
                    if (nhlen != 0) {
                        expert_add_info_format(pinfo, ti, &ei_bgp_length_invalid,
                                               "The length (%d) of Next Hop (FlowSpec) is not zero", nhlen);
                        break;
                    }
                    length++;
                    break;
                default:
                    length = 0;
                    expert_add_info_format(pinfo, ti, &ei_bgp_unknown_safi,
                                    "Unknown SAFI (%u) for AFI %u", safi, afi);
                    break;
            } /* switch (safi) */
            break;
        case AFNUM_L2VPN:
        case AFNUM_L2VPN_OLD:
            switch (safi) {
                /* XXX: Do these first three really appear with L2VPN AFI? */
                case SAFNUM_LAB_VPNUNICAST:
                case SAFNUM_LAB_VPNMULCAST:
                case SAFNUM_LAB_VPNUNIMULC:
                case SAFNUM_VPLS: /* RFC 4761 (VPLS) and RFC 6074 (BGP-AD) */
                case SAFNUM_EVPN: /* RFC 7432 */
                    /* The RFCs above specify that the next-hop is simply the
                     * address of the PE (loopback address in some cases for
                     * BGP-AD), either IPv4 or IPv6, differentiated by length.
                     * A RD is included in the NLRI in these cases, but not in
                     * the Next Hop address unlike in AFI 1 or 2.
                     */
                    if ((length = decode_mp_next_hop_ipv4(tvb, next_hop_t, offset, pinfo, strbuf, nhlen)) == 0) {
                        length = decode_mp_next_hop_ipv6(tvb, next_hop_t, offset, pinfo, strbuf, nhlen);
                    }
                    break;
                default:
                    length = 0;
                    expert_add_info_format(pinfo, ti, &ei_bgp_unknown_safi,
                                    "Unknown SAFI (%u) for AFI %u", safi, afi);
                    break;
            } /* switch (safi) */
            break;
        case AFNUM_BGP_LS:
            /* RFC 7752 section 3.4 "BGP Next-Hop Information" explains that
             * the next-hop address length field specifes the next-hop address
             * family. "If the next-hop length is 4, then the next hop is an
             * IPv4 address; if the next-hop length is 16, then it is a global
             * IPv6 address; and if the next-hop length is 32, then there is
             * one global IPv6 address followed by a link-local IPv6 address"
             */
            switch (safi) {
                case SAFNUM_BGP_LS:
                    if ((length = decode_mp_next_hop_ipv4(tvb, next_hop_t, offset, pinfo, strbuf, nhlen)) == 0) {
                        length = decode_mp_next_hop_ipv6(tvb, next_hop_t, offset, pinfo, strbuf, nhlen);
                    }
                    break;
                case SAFNUM_BGP_LS_VPN:
                    /* RFC 7752 3.4: "For VPN SAFI, as per custom, an 8-byte
                     * Route Distinguisher set to all zero is prepended to the
                     * next hop."
                     */
                    if ((length = decode_mp_next_hop_vpn_ipv4(tvb, next_hop_t, offset, pinfo, strbuf, nhlen)) == 0) {
                        length = decode_mp_next_hop_vpn_ipv6(tvb, next_hop_t, offset, pinfo, strbuf, nhlen);
                    }
                    break;
                default:
                    length = 0;
                    expert_add_info_format(pinfo, ti, &ei_bgp_unknown_safi,
                                    "Unknown SAFI (%u) for AFI %u", safi, afi);
                    break;
            } /* switch (safi) */
            break;
        default:
            length = 0;
            expert_add_info(pinfo, ti, &ei_bgp_unknown_afi);
            break;
    } /* switch (af) */

    if (length) {
        proto_item_append_text(ti, ": %s", wmem_strbuf_get_str(strbuf));
    } else {
        expert_add_info_format(pinfo, ti, &ei_bgp_length_invalid, "Unknown Next Hop length (%u byte%s)", nhlen, plurality(nhlen, "", "s"));
        if (nhlen > 0) {
            proto_item_append_text(ti, ": %s", tvb_bytes_to_str(pinfo->pool, tvb, offset, nhlen));
        }
    }

    return length;
}
