mqtts_tcptran_pipe_qos_send_cb(void *arg)
{
	mqtts_tcptran_pipe *p = arg;
	nni_msg *           msg;
	nni_aio *           qsaio = p->qsaio;

	if (nni_aio_result(qsaio) != 0) {
		nni_msg_free(nni_aio_get_msg(qsaio));
		nni_aio_set_msg(qsaio, NULL);
		mqtts_tcptran_pipe_close(p);
		return;
	}
	nni_mtx_lock(&p->mtx);

	msg = nni_aio_get_msg(p->qsaio);
	nni_msg_free(msg);
	if (nni_lmq_get(&p->rslmq, &msg) == 0) {
		nni_iov iov;
		iov.iov_len = 4;
		iov.iov_buf = nni_msg_header(msg);
		nni_aio_set_msg(p->qsaio, msg);
		// send it down...
		nni_aio_set_iov(p->qsaio, 1, &iov);
		nng_stream_send(p->conn, p->qsaio);
		p->busy = true;
		nni_mtx_unlock(&p->mtx);
		return;
	}
	p->busy = false;
	nni_aio_set_msg(qsaio, NULL);
	nni_mtx_unlock(&p->mtx);
	return;
}
