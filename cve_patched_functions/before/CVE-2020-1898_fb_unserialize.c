Variant fb_unserialize(const char* str,
                       int len,
                       bool& success,
                       int64_t options) {
  try {
    if (options & k_FB_SERIALIZE_HACK_ARRAYS) {
      auto res = HPHP::serialize
        ::FBUnserializer<VariantControllerUsingHackArrays>
        ::unserialize(folly::StringPiece(str, len));
      success = true;
      return res;
    } else if (options & k_FB_SERIALIZE_HACK_ARRAYS_AND_KEYSETS) {
      auto res = HPHP::serialize
        ::FBUnserializer<VariantControllerUsingHackArraysAndKeyset>
        ::unserialize(folly::StringPiece(str, len));
      success = true;
      return res;
    } else if (options & k_FB_SERIALIZE_VARRAY_DARRAY) {
      auto res = HPHP::serialize
        ::FBUnserializer<VariantControllerUsingVarrayDarray>
        ::unserialize(folly::StringPiece(str, len));
      success = true;
      return res;
    } else {
      auto res = HPHP::serialize::FBUnserializer<VariantController>
        ::unserialize(folly::StringPiece(str, len));
      success = true;
      return res;
    }
  } catch (const HPHP::serialize::UnserializeError&) {
    success = false;
    return false;
  }
}
