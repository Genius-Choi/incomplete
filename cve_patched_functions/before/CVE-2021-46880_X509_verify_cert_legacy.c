X509_verify_cert_legacy(X509_STORE_CTX *ctx)
{
	int ok = 0, bad_chain;

	ctx->error = X509_V_OK; /* Initialize to OK */

	if (!X509_verify_cert_legacy_build_chain(ctx, &bad_chain, &ok))
		goto end;

	/* We have the chain complete: now we need to check its purpose */
	ok = check_chain_extensions(ctx);
	if (!ok)
		goto end;

	/* Check name constraints */
	ok = check_name_constraints(ctx);
	if (!ok)
		goto end;

#ifndef OPENSSL_NO_RFC3779
	ok = X509v3_asid_validate_path(ctx);
	if (!ok)
		goto end;

	ok = X509v3_addr_validate_path(ctx);
	if (!ok)
		goto end;
#endif

	ok = check_id(ctx);
	if (!ok)
		goto end;

	/*
	 * Check revocation status: we do this after copying parameters because
	 * they may be needed for CRL signature verification.
	 */
	ok = ctx->check_revocation(ctx);
	if (!ok)
		goto end;

	/* At this point, we have a chain and need to verify it */
	if (ctx->verify != NULL)
		ok = ctx->verify(ctx);
	else
		ok = internal_verify(ctx);
	if (!ok)
		goto end;

	/* If we get this far evaluate policies */
	if (!bad_chain && (ctx->param->flags & X509_V_FLAG_POLICY_CHECK))
		ok = ctx->check_policy(ctx);

 end:
	/* Safety net, error returns must set ctx->error */
	if (ok <= 0 && ctx->error == X509_V_OK)
		ctx->error = X509_V_ERR_UNSPECIFIED;

	return ok;
}
