static char * encrypt_token_if_required(struct _oidc_config * config, const char * token, json_t * j_client, int type, int * result) {
  char * token_out = NULL;
  jwe_t * jwe = NULL;
  jwa_alg alg = get_token_enc_alg(config, j_client, type);
  jwa_enc enc = get_token_enc(config, j_client, type);
  jwk_t * jwk = get_jwk_enc(config, j_client, alg, enc);

  if (alg != R_JWA_ALG_UNKNOWN && json_object_get(config->j_params, "oauth-fapi-allow-restrict-alg") == json_true() && !json_array_has_string(json_object_get(config->j_params, "oauth-fapi-restrict-alg"), r_jwa_alg_to_str(alg))) {
    *result = G_ERROR_UNAUTHORIZED;
  } else {
    if (j_client != NULL &&
        json_object_get(j_client, "confidential") == json_true() &&
        is_encrypt_token_allowed(config, j_client, type) &&
        json_object_get(config->j_params, "encrypt-out-token-allow") == json_true() &&
        jwk != NULL &&
        alg != R_JWA_ALG_UNKNOWN) {
      if (r_jwe_init(&jwe) == RHN_OK &&
          r_jwe_set_payload(jwe, (const unsigned char *)token, o_strlen(token)) == RHN_OK &&
          r_jwe_set_enc(jwe, enc) == RHN_OK &&
          r_jwe_set_alg(jwe, alg) == RHN_OK) {
        if (type == GLEWLWYD_TOKEN_TYPE_ACCESS_TOKEN) {
          r_jwe_set_header_str_value(jwe, "typ", "at+jwt");
        } else if (type == GLEWLWYD_TOKEN_TYPE_INTROSPECTION) {
          r_jwe_set_header_str_value(jwe, "typ", "token-introspection+jwt");
        } else if (type == GLEWLWYD_TOKEN_TYPE_USERINFO) {
          r_jwe_set_header_str_value(jwe, "typ", "token-userinfo+jwt");
        }
        if (type != GLEWLWYD_TOKEN_TYPE_REFRESH_TOKEN && type != GLEWLWYD_TOKEN_TYPE_CODE) {
          r_jwe_set_header_str_value(jwe, "cty", "JWT");
        }
        if (jwk != NULL) {
          token_out = r_jwe_serialize(jwe, jwk, 0);
          if (token_out == NULL) {
            y_log_message(Y_LOG_LEVEL_ERROR, "encrypt_token_if_required - Error r_jwe_serialize");
          }
        }
      } else {
        y_log_message(Y_LOG_LEVEL_DEBUG, "encrypt_token_if_required - Error setting values enc or alg for client_id %s", json_string_value(json_object_get(j_client, "client_id")));
      }
      r_jwe_free(jwe);
    } else {
      token_out = o_strdup(token);
    }
    *result = G_OK;
  }
  r_jwk_free(jwk);
  return token_out;
}
