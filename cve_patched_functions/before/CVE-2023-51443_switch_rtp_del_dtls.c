SWITCH_DECLARE(switch_status_t) switch_rtp_del_dtls(switch_rtp_t *rtp_session, dtls_type_t type)
{
	switch_status_t status = SWITCH_STATUS_SUCCESS;

	if (!rtp_session) {
		return SWITCH_STATUS_FALSE;
	}

	switch_mutex_lock(rtp_session->ice_mutex);

	if (!rtp_session->dtls && !rtp_session->rtcp_dtls) {
		switch_goto_status(SWITCH_STATUS_FALSE, done);
	}

	if ((type & DTLS_TYPE_RTP)) {
		if (rtp_session->dtls && rtp_session->dtls == rtp_session->rtcp_dtls) {
			rtp_session->rtcp_dtls = NULL;
		}

		if (rtp_session->dtls) {
			free_dtls(&rtp_session->dtls);
		}

		if (rtp_session->jb) {
			switch_jb_reset(rtp_session->jb);
		}

		if (rtp_session->vb) {
			switch_jb_reset(rtp_session->vb);
		}

		if (rtp_session->vbw) {
			switch_jb_reset(rtp_session->vbw);
		}

	}

	if ((type & DTLS_TYPE_RTCP) && rtp_session->rtcp_dtls) {
		free_dtls(&rtp_session->rtcp_dtls);
	}


#ifdef ENABLE_SRTP
	if (rtp_session->flags[SWITCH_RTP_FLAG_SECURE_SEND]) {
		int x;

		rtp_session->flags[SWITCH_RTP_FLAG_SECURE_SEND] = 0;

		for(x = 0; x < 2; x++) {
			if (rtp_session->send_ctx[x]) {
				srtp_dealloc(rtp_session->send_ctx[x]);
				rtp_session->send_ctx[x] = NULL;
			}
		}
	}

	if (rtp_session->flags[SWITCH_RTP_FLAG_SECURE_RECV]) {
		int x;

		rtp_session->flags[SWITCH_RTP_FLAG_SECURE_RECV] = 0;

		for (x = 0; x < 2; x++) {
			if (rtp_session->recv_ctx[x]) {
				srtp_dealloc(rtp_session->recv_ctx[x]);
				rtp_session->recv_ctx[x] = NULL;
			}
		}
	}
#endif

 done:

	switch_mutex_unlock(rtp_session->ice_mutex);

	return status;
}
