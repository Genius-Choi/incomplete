SWITCH_DECLARE(switch_status_t) switch_rtp_activate_jitter_buffer(switch_rtp_t *rtp_session,
																  uint32_t queue_frames,
																  uint32_t max_queue_frames,
																  uint32_t samples_per_packet,
																  uint32_t samples_per_second)
{
	switch_status_t status = SWITCH_STATUS_FALSE;

	if (!switch_rtp_ready(rtp_session)) {
		return SWITCH_STATUS_FALSE;
	}

	if (queue_frames < 1) {
		queue_frames = 3;
	}

	if (max_queue_frames < queue_frames) {
		max_queue_frames = queue_frames * 3;
	}



	if (rtp_session->jb) {
		status = switch_jb_set_frames(rtp_session->jb, queue_frames, max_queue_frames);
	} else {
		READ_INC(rtp_session);
		status = switch_jb_create(&rtp_session->jb, SJB_AUDIO, queue_frames, max_queue_frames, rtp_session->pool);
		switch_jb_set_session(rtp_session->jb, rtp_session->session);
		switch_jb_set_jitter_estimator(rtp_session->jb, &rtp_session->stats.rtcp.inter_jitter, samples_per_packet, samples_per_second);
		if (switch_true(switch_channel_get_variable_dup(switch_core_session_get_channel(rtp_session->session), "jb_use_timestamps", SWITCH_FALSE, -1))) {
			switch_jb_ts_mode(rtp_session->jb, samples_per_packet, samples_per_second);
		}
		//switch_jb_debug_level(rtp_session->jb, 10);
		READ_DEC(rtp_session);
	}



	return status;
}
