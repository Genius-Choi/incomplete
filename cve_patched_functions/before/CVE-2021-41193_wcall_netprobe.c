int wcall_netprobe(WUSER_HANDLE wuser,
		   size_t pkt_count, uint32_t pkt_interval_ms,
		   wcall_netprobe_h *netprobeh, void *arg)
{
	struct calling_instance *inst;
	struct zapi_ice_server *turnv = NULL;
	struct zapi_ice_server *turn;
	struct stun_uri uri;
	bool found = false;
	size_t turnc = 0;
	size_t i;
	int err;

	inst = wuser2inst(wuser);
	if (!inst) {
		warning("wcall: netprobe: invalid wuser=0x%08X\n", wuser);
		return EINVAL;
	}
	
	if (inst->netprobe)
		return EBUSY;

	inst->netprobeh = netprobeh;
	inst->netprobeh_arg = arg;

	turnv = config_get_iceservers(inst->cfg, &turnc);
	if (turnc == 0) {
		warning("wcall: netprobe: no turn servers\n");
		return ENOENT;
	}

	for (i = 0; i < turnc; ++i) {
		turn = &turnv[i];

		err = stun_uri_decode(&uri, turn->url);
		if (err)
			continue;

		if (STUN_SCHEME_TURN == uri.scheme) {
			found = true;
			break;
		}
	}
	if (!found) {
		warning("wcall: netprobe: no TURN servers found\n");
		return ENOENT;
	}

	info("wcall: running netprobe with TURN %J\n", &uri.addr);

	err = netprobe_alloc(&inst->netprobe, &uri.addr,
			     uri.proto, uri.secure,
			     turn->username, turn->credential,
			     pkt_count, pkt_interval_ms,
			     netprobe_handler, inst);
	if (err)
		return err;

	return 0;
}
