dynamic_monitor_data(intptr_t id, int chan_id, char *data, int bytes)
{
    int error = 0;
    struct stream ls;
    struct stream *s;
    int msg_type;
    int msg_length;
    struct xrdp_process *pro;
    struct xrdp_wm *wm;
    int monitor_layout_size;
    struct display_size_description *display_size_data;

    LOG_DEVEL(LOG_LEVEL_TRACE, "dynamic_monitor_data:");
    pro = (struct xrdp_process *) id;
    wm = pro->wm;

    if (OUTPUT_SUPPRESSED_FOR_REASON(wm->client_info,
                                     XSO_REASON_CLIENT_REQUEST))
    {
        LOG(LOG_LEVEL_INFO, "dynamic_monitor_data: Not allowing resize."
            " Suppress output requested by client");
        return error;
    }

    g_memset(&ls, 0, sizeof(ls));
    ls.data = data;
    ls.p = ls.data;
    ls.size = bytes;
    ls.end = ls.data + bytes;
    s = &ls;
    in_uint32_le(s, msg_type);
    in_uint32_le(s, msg_length);
    LOG_DEVEL(LOG_LEVEL_DEBUG,
              "dynamic_monitor_data: msg_type %d msg_length %d",
              msg_type, msg_length);

    if (msg_type != DISPLAYCONTROL_PDU_TYPE_MONITOR_LAYOUT
            && msg_length >= 0)
    {
        // Unsupported message types
        switch (msg_type)
        {
            case DISPLAYCONTROL_PDU_TYPE_CAPS:
                LOG(LOG_LEVEL_ERROR, "dynamic_monitor_data: Received"
                    " DISPLAYCONTROL_PDU_TYPE_CAPS. Per MS-RDPEDISP 2.2.2.1,"
                    " this is a server-to-client message, client should never"
                    " send this. Ignoring message");
                break;
            default:
                LOG(LOG_LEVEL_ERROR, "dynamic_monitor_data: Received neither"
                    " DISPLAYCONTROL_PDU_TYPE_MONITOR_LAYOUT nor"
                    " DISPLAYCONTROL_PDU_TYPE_CAPS. Ignoring message.");
                break;
        }
        return 0;
    }
    in_uint32_le(s, monitor_layout_size);
    if (monitor_layout_size != 40)
    {
        /* 2.2.2.2 DISPLAYCONTROL_MONITOR_LAYOUT_PDU */
        LOG(LOG_LEVEL_ERROR, "dynamic_monitor_data: monitor_layout_size"
            " is %d. Per spec ([MS-RDPEDISP] 2.2.2.2"
            " DISPLAYCONTROL_MONITOR_LAYOUT_PDU) it must be 40.",
            monitor_layout_size);
        return 1;
    }

    display_size_data = (struct display_size_description *)
                        g_malloc(sizeof(struct display_size_description), 1);
    if (!display_size_data)
    {
        return 1;
    }
    error = libxrdp_process_monitor_stream(s, display_size_data, 1);
    if (error)
    {
        LOG(LOG_LEVEL_ERROR, "dynamic_monitor_data:"
            " libxrdp_process_monitor_stream"
            " failed with error %d.", error);
        g_free(display_size_data);
        return error;
    }
    list_add_item(wm->mm->resize_queue, (tintptr)display_size_data);
    g_set_wait_obj(wm->mm->resize_ready);
    LOG(LOG_LEVEL_DEBUG, "dynamic_monitor_data:"
        " received width %d, received height %d.",
        display_size_data->session_width, display_size_data->session_height);
    return 0;
}
