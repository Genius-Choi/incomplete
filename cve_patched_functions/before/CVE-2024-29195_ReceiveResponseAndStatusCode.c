static HTTPAPI_RESULT ReceiveResponseAndStatusCode(HINTERNET requestHandle, unsigned int* statusCode)
{
    HTTPAPI_RESULT result;

    if (!WinHttpReceiveResponse(
        requestHandle,
        0))
    {
        result = HTTPAPI_RECEIVE_RESPONSE_FAILED;
        LogErrorWinHTTPWithGetLastErrorAsString("WinHttpReceiveResponse: (result = %" PRI_MU_ENUM ").", MU_ENUM_VALUE(HTTPAPI_RESULT, result));
    }
    else if (statusCode != NULL)
    {
        DWORD dwStatusCode = 0;
        DWORD dwBufferLength = sizeof(DWORD);
    
        if (!WinHttpQueryHeaders(
            requestHandle,
            WINHTTP_QUERY_STATUS_CODE | WINHTTP_QUERY_FLAG_NUMBER,
            WINHTTP_HEADER_NAME_BY_INDEX,
            &dwStatusCode,
            &dwBufferLength,
            WINHTTP_NO_HEADER_INDEX))
        {
            result = HTTPAPI_QUERY_HEADERS_FAILED;
            LogErrorWinHTTPWithGetLastErrorAsString("WinHttpQueryHeaders failed (result = %" PRI_MU_ENUM ")", MU_ENUM_VALUE(HTTPAPI_RESULT, result));
        }
        else
        {
            *statusCode = dwStatusCode;
            result = HTTPAPI_OK;
        }
    }
    else
    {
        result = HTTPAPI_OK;
    }

    return result;
}
