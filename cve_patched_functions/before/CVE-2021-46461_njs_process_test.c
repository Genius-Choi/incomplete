njs_process_test(njs_external_state_t *state, njs_opts_t *opts,
    njs_unit_test_t *expected)
{
    njs_int_t    ret;
    njs_str_t    s;
    njs_bool_t   success;
    njs_value_t  request;

    static const njs_str_t  handler_str = njs_str("main.handler");
    static const njs_str_t  request_str = njs_str("$r");

    switch (state->state) {
    case sw_start:
        state->state = sw_handler;

        ret = njs_vm_start(state->vm);
        if (ret != NJS_OK) {
            goto done;
        }

        if (opts->async) {
            return NJS_OK;
        }

        /* Fall through. */
    case sw_handler:
        state->state = sw_loop;

        if (opts->handler) {
            ret = njs_vm_value(state->vm, &request_str, &request);
            if (ret != NJS_OK) {
                njs_stderror("njs_vm_value(\"%V\") failed\n", &request_str);
                return NJS_ERROR;
            }

            ret = njs_external_call(state->vm, &handler_str, &request, 1);
            if (ret == NJS_ERROR) {
                goto done;
            }

            if (opts->async) {
                return NJS_OK;
            }
        }

        /* Fall through. */
    case sw_loop:
    default:
        for ( ;; ) {
            if (!njs_vm_pending(state->vm)) {
                break;
            }

            ret = njs_external_process_events(state->vm, state->env);
            if (ret != NJS_OK) {
                njs_stderror("njs_external_process_events() failed\n");
                return NJS_ERROR;
            }

            if (njs_vm_waiting(state->vm) && !njs_vm_posted(state->vm)) {
                /*TODO: async events. */

                njs_stderror("njs_process_test(): async events unsupported\n");
                return NJS_ERROR;
            }

            (void) njs_vm_run(state->vm);

            if (opts->async) {
                return NJS_OK;
            }
        }
    }

done:

    state->state = sw_done;

    if (njs_external_retval(state, &s) != NJS_OK) {
        njs_stderror("njs_external_retval() failed\n");
        return NJS_ERROR;
    }

    success = njs_strstr_eq(&expected->ret, &s);
    if (!success) {
        njs_stderror("njs(\"%V\")\nexpected: \"%V\"\n     got: \"%V\"\n",
                     &expected->script, &expected->ret, &s);

        return NJS_DECLINED;
    }

    njs_vm_destroy(state->vm);
    state->vm = NULL;

    return NJS_OK;
}
