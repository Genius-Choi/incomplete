FIO_FUNC void fio_malloc_test(void) {
  fprintf(stderr, "\n=== Testing facil.io memory allocator's system calls\n");
  char *mem = sys_alloc(FIO_MEMORY_BLOCK_SIZE, 0);
  FIO_ASSERT(mem, "sys_alloc failed to allocate memory!\n");
  FIO_ASSERT(!((uintptr_t)mem & FIO_MEMORY_BLOCK_MASK),
             "Memory allocation not aligned to FIO_MEMORY_BLOCK_SIZE!");
  mem[0] = 'a';
  mem[FIO_MEMORY_BLOCK_SIZE - 1] = 'z';
  fprintf(stderr, "* Testing reallocation from %p\n", (void *)mem);
  char *mem2 =
      sys_realloc(mem, FIO_MEMORY_BLOCK_SIZE, FIO_MEMORY_BLOCK_SIZE * 2);
  if (mem == mem2)
    fprintf(stderr, "* Performed system realloc without copy :-)\n");
  FIO_ASSERT(mem2[0] == 'a' && mem2[FIO_MEMORY_BLOCK_SIZE - 1] == 'z',
             "Reaclloc data was lost!");
  sys_free(mem2, FIO_MEMORY_BLOCK_SIZE * 2);
  fprintf(stderr, "=== Testing facil.io memory allocator's internal data.\n");
  FIO_ASSERT(arenas, "Missing arena data - library not initialized!");
  fio_free(NULL); /* fio_free(NULL) shouldn't crash... */
  mem = fio_malloc(1);
  FIO_ASSERT(mem, "fio_malloc failed to allocate memory!\n");
  FIO_ASSERT(!((uintptr_t)mem & 15), "fio_malloc memory not aligned!\n");
  FIO_ASSERT(((uintptr_t)mem & FIO_MEMORY_BLOCK_MASK) != 16,
             "small fio_malloc memory indicates system allocation!\n");
  mem[0] = 'a';
  FIO_ASSERT(mem[0] == 'a', "allocate memory wasn't written to!\n");
  mem = fio_realloc(mem, 1);
  FIO_ASSERT(mem, "fio_realloc failed!\n");
  FIO_ASSERT(mem[0] == 'a', "fio_realloc memory wasn't copied!\n");
  FIO_ASSERT(arena_last_used, "arena_last_used wasn't initialized!\n");
  fio_free(mem);
  block_s *b = arena_last_used->block;

  /* move arena to block's start */
  while (arena_last_used->block == b) {
    mem = fio_malloc(1);
    FIO_ASSERT(mem, "fio_malloc failed to allocate memory!\n");
    fio_free(mem);
  }
  /* make sure a block is assigned */
  fio_free(fio_malloc(1));
  b = arena_last_used->block;
  size_t count = 1;
  /* count allocations within block */
  do {
    FIO_ASSERT(mem, "fio_malloc failed to allocate memory!\n");
    FIO_ASSERT(!((uintptr_t)mem & 15),
               "fio_malloc memory not aligned at allocation #%zu!\n", count);
    FIO_ASSERT((((uintptr_t)mem & FIO_MEMORY_BLOCK_MASK) != 16),
               "fio_malloc memory indicates system allocation!\n");
#if __x86_64__
    fio_memcpy((size_t *)mem, (size_t *)"0123456789abcdefg", 1);
#else
    mem[0] = 'a';
#endif
    fio_free(mem); /* make sure we hold on to the block, so it rotates */
    mem = fio_malloc(1);
    ++count;
  } while (arena_last_used->block == b);
  {
    fprintf(stderr, "* Confirm block address: %p, last allocation was %p\n",
            (void *)arena_last_used->block, (void *)mem);
    fprintf(
        stderr,
        "* Performed %zu allocations out of expected %zu allocations per "
        "block.\n",
        count,
        (size_t)((FIO_MEMORY_BLOCK_SLICES - 2) - (sizeof(block_s) >> 4) - 1));
    fio_ls_embd_s old_memory_list = memory.available;
    fio_free(mem);
    FIO_ASSERT(fio_ls_embd_any(&memory.available),
               "memory pool empty (memory block wasn't freed)!\n");
    FIO_ASSERT(old_memory_list.next != memory.available.next ||
                   memory.available.prev != old_memory_list.prev,
               "memory pool not updated after block being freed!\n");
  }
  /* rotate block again */
  b = arena_last_used->block;
  mem = fio_realloc(mem, 1);
  do {
    mem2 = mem;
    mem = fio_malloc(1);
    fio_free(mem2); /* make sure we hold on to the block, so it rotates */
    FIO_ASSERT(mem, "fio_malloc failed to allocate memory!\n");
    FIO_ASSERT(!((uintptr_t)mem & 15),
               "fio_malloc memory not aligned at allocation #%zu!\n", count);
    FIO_ASSERT((((uintptr_t)mem & FIO_MEMORY_BLOCK_MASK) != 16),
               "fio_malloc memory indicates system allocation!\n");
#if __x86_64__
    fio_memcpy((size_t *)mem, (size_t *)"0123456789abcdefg", 1);
#else
    mem[0] = 'a';
#endif
    ++count;
  } while (arena_last_used->block == b);

  mem2 = mem;
  mem = fio_calloc(FIO_MEMORY_BLOCK_ALLOC_LIMIT - 64, 1);
  fio_free(mem2);
  FIO_ASSERT(mem,
             "failed to allocate FIO_MEMORY_BLOCK_ALLOC_LIMIT - 64 bytes!\n");
  FIO_ASSERT(((uintptr_t)mem & FIO_MEMORY_BLOCK_MASK) != 16,
             "fio_calloc (under limit) memory alignment error!\n");
  mem2 = fio_malloc(1);
  FIO_ASSERT(mem2, "fio_malloc(1) failed to allocate memory!\n");
  mem2[0] = 'a';

  for (uintptr_t i = 0; i < (FIO_MEMORY_BLOCK_ALLOC_LIMIT - 64); ++i) {
    FIO_ASSERT(mem[i] == 0,
               "calloc returned memory that wasn't initialized?!\n");
  }
  fio_free(mem);

  mem = fio_malloc(FIO_MEMORY_BLOCK_SIZE);
  FIO_ASSERT(mem, "fio_malloc failed to FIO_MEMORY_BLOCK_SIZE bytes!\n");
  FIO_ASSERT(((uintptr_t)mem & FIO_MEMORY_BLOCK_MASK) == 16,
             "fio_malloc (big) memory isn't aligned!\n");
  mem = fio_realloc(mem, FIO_MEMORY_BLOCK_SIZE * 2);
  FIO_ASSERT(mem,
             "fio_realloc (big) failed on FIO_MEMORY_BLOCK_SIZE X2 bytes!\n");
  fio_free(mem);
  FIO_ASSERT(((uintptr_t)mem & FIO_MEMORY_BLOCK_MASK) == 16,
             "fio_realloc (big) memory isn't aligned!\n");

  {
    void *m0 = fio_malloc(0);
    void *rm0 = fio_realloc(m0, 16);
    FIO_ASSERT(m0 != rm0, "fio_realloc(fio_malloc(0), 16) failed!\n");
    fio_free(rm0);
  }
  {
    size_t pool_size = 0;
    FIO_LS_EMBD_FOR(&memory.available, node) { ++pool_size; }
    mem = fio_mmap(512);
    FIO_ASSERT(mem, "fio_mmap allocation failed!\n");
    fio_free(mem);
    size_t new_pool_size = 0;
    FIO_LS_EMBD_FOR(&memory.available, node) { ++new_pool_size; }
    FIO_ASSERT(new_pool_size == pool_size,
               "fio_free of fio_mmap went to memory pool!\n");
  }

  fprintf(stderr, "* passed.\n");
}
