int CoreUserInputHandler::lastParamOverrun(const QString &cmd, const QList<QByteArray> &params)
{
    // the server will pass our message truncated to 512 bytes including CRLF with the following format:
    // ":prefix COMMAND param0 param1 :lastparam"
    // where prefix = "nickname!user@host"
    // that means that the last message can be as long as:
    // 512 - nicklen - userlen - hostlen - commandlen - sum(param[0]..param[n-1])) - 2 (for CRLF) - 4 (":!@" + 1space between prefix and command) - max(paramcount - 1, 0) (space for simple params) - 2 (space and colon for last param)
    IrcUser *me = network()->me();
    int maxLen = 480 - cmd.toLatin1().count(); // educated guess in case we don't know us (yet?)

    if (me)
        maxLen = 512 - serverEncode(me->nick()).count() - serverEncode(me->user()).count() - serverEncode(me->host()).count() - cmd.toLatin1().count() - 6;

    if (!params.isEmpty()) {
        for (int i = 0; i < params.count() - 1; i++) {
            maxLen -= (params[i].count() + 1);
        }
        maxLen -= 2; // " :" last param separator;

        if (params.last().count() > maxLen) {
            return params.last().count() - maxLen;
        }
        else {
            return 0;
        }
    }
    else {
        return 0;
    }
}
