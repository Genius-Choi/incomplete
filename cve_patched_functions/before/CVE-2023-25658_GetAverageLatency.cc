absl::Duration ApproximateLatencyEstimator::GetAverageLatency(Duration duration)
    TF_LOCKS_EXCLUDED(mu_) {
  UpdateRingBuffer();

  mutex_lock l(mu_);
  double interval_latency =
      static_cast<double>(latency_value_counter_ -
                          latency_value_[PrevSlot(static_cast<int>(duration))]);
  double interval_count =
      static_cast<double>(latency_count_counter_ -
                          latency_count_[PrevSlot(static_cast<int>(duration))]);
  return absl::Duration(absl::Microseconds(interval_latency)) / interval_count;
}
