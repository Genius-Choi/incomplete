static char * get_sub_pairwise(struct _oidc_config * config, const char * username, json_t * j_client) {
  json_t * j_query, * j_result;
  int res;
  char * sub = NULL;

  j_query = json_pack("{sss[s]s{ssss}}",
                      "table",
                      GLEWLWYD_PLUGIN_OIDC_TABLE_SUBJECT_IDENTIFIER,
                      "columns",
                        "gposi_sub",
                      "where",
                        "gposi_plugin_name",
                        config->name,
                        "gposi_username",
                        username);

  if (!json_string_null_or_empty(json_object_get(j_client, "sector_identifier_uri"))) {
    json_object_set(json_object_get(j_query, "where"), "gposi_sector_identifier_uri", json_object_get(j_client, "sector_identifier_uri"));
    json_object_set(json_object_get(j_query, "where"), "gposi_client_id", json_null());
  } else {
    json_object_set(json_object_get(j_query, "where"), "gposi_sector_identifier_uri", json_null());
    json_object_set(json_object_get(j_query, "where"), "gposi_client_id", json_object_get(j_client, "client_id"));
  }
  res = h_select(config->glewlwyd_config->glewlwyd_config->conn, j_query, &j_result, NULL);
  json_decref(j_query);
  if (res == H_OK) {
    if (json_array_size(j_result)) {
      sub = o_strdup(json_string_value(json_object_get(json_array_get(j_result, 0), "gposi_sub")));
    } else {
      sub = o_malloc((GLEWLWYD_SUB_LENGTH+1));
      if (sub != NULL) {
        *sub = '\0';
        if (rand_string(sub, GLEWLWYD_SUB_LENGTH) != NULL) {
          j_query = json_pack("{sss{ssssss}}",
                              "table",
                              GLEWLWYD_PLUGIN_OIDC_TABLE_SUBJECT_IDENTIFIER,
                              "values",
                                "gposi_plugin_name",
                                config->name,
                                "gposi_sub",
                                sub,
                                "gposi_username",
                                username);
          if (!json_string_null_or_empty(json_object_get(j_client, "sector_identifier_uri"))) {
            json_object_set(json_object_get(j_query, "values"), "gposi_sector_identifier_uri", json_object_get(j_client, "sector_identifier_uri"));
            json_object_set(json_object_get(j_query, "where"), "gposi_client_id", json_null());
          } else {
            json_object_set(json_object_get(j_query, "values"), "gposi_sector_identifier_uri", json_null());
            json_object_set(json_object_get(j_query, "where"), "gposi_client_id", json_object_get(j_client, "client_id"));
          }
          if (h_insert(config->glewlwyd_config->glewlwyd_config->conn, j_query, NULL) != H_OK) {
            y_log_message(Y_LOG_LEVEL_ERROR, "get_sub_pairwise - Error executing h_insert");
            o_free(sub);
            sub = NULL;
          }
          json_decref(j_query);
        } else {
          y_log_message(Y_LOG_LEVEL_ERROR, "get_sub_pairwise - Error rand_string");
        }
      } else {
        y_log_message(Y_LOG_LEVEL_ERROR, "get_sub_pairwise - Error allocating resources for sub");
      }
    }
    json_decref(j_result);
  } else {
    y_log_message(Y_LOG_LEVEL_ERROR, "get_sub_pairwise - Error executing h_select");
  }
  return sub;
}
