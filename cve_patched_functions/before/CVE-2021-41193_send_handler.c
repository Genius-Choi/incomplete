static int send_handler(struct econn *conn,
			struct econn_message *msg, void *arg)
{
	struct ecall *ecall = arg;
	int err = 0;
	int try_otr = 0, try_dce = 0;
	char convid_anon[ANON_ID_LEN];
	char userid_anon[ANON_ID_LEN];
	char clientid_anon[ANON_CLIENT_LEN];
	char dest_userid_anon[ANON_ID_LEN];
	char dest_clientid_anon[ANON_CLIENT_LEN];
	int silent = 0;

	assert(ECALL_MAGIC == ecall->magic);

	if (ecall->userid_self) {
		str_ncpy(msg->src_userid,
			 ecall->userid_self,
			 sizeof(msg->src_userid));
	}

	if (ecall->clientid_self) {
		str_ncpy(msg->src_clientid,
			 ecall->clientid_self,
			 sizeof(msg->src_clientid));
	}
	if (ecall->userid_peer) {
		str_ncpy(msg->dest_userid,
			 ecall->userid_peer,
			 sizeof(msg->dest_userid));
	}

	if (ecall->clientid_peer) {
		str_ncpy(msg->dest_clientid,
			 ecall->clientid_peer,
			 sizeof(msg->dest_clientid));
	}

	// todo: resolve transport-type instead ?

	switch (msg->msg_type) {

	case ECONN_SETUP:
	case ECONN_UPDATE:
	case ECONN_CANCEL:
	case ECONN_ALERT:
		try_dce = 0;
		try_otr = 1;
		break;

	case ECONN_PROPSYNC:
		try_dce = 1;
		try_otr = 1;
		break;

	case ECONN_HANGUP:
		try_dce = 1;
		try_otr = 0;
		break;

	case ECONN_PING:
		try_dce = 1;
		try_otr = 0;
		silent = 1;
		break;

	default:
		warning("ecall: send_handler: message not supported (%s)\n",
			econn_msg_name(msg->msg_type));
		err = EPROTO;
		goto out;
		break;
	}

	//if (try_dce && IFLOW_CALLE(ecall->flow, has_data)) {
	if (try_dce) {
		if (!silent) {
			info("ecall(%p): dce_message_send: convid=%s from=%s.%s to=%s.%s "
			     "msg=%H\n",
			     ecall, anon_id(convid_anon, ecall->convid),
			     anon_id(userid_anon, ecall->userid_self),
			     anon_client(clientid_anon, ecall->clientid_self),
			     anon_id(dest_userid_anon, ecall->userid_peer),
			     anon_client(dest_clientid_anon, ecall->clientid_peer),
			     econn_message_print, msg);
		}
		ecall_dce_sendmsg(ecall, msg);
	}
	else if (try_otr) {
		ecall_trace(ecall, msg, true, ECONN_TRANSP_BACKEND,
			    "SE %H\n", econn_message_brief, msg);
		err = ICALL_CALL_CBE(ecall->icall, sendh,
			&ecall->icall, ecall->userid_self, msg, NULL, ecall->icall.arg);
	}

out:
	return err;
}
