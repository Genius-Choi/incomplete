static int check_dpop_jti(struct _oidc_config * config,
                          const char * jti,
                          const char * htm,
                          const char * htu,
                          json_int_t iat,
                          const char * client_id,
                          const char * jkt,
                          const char * ip_source) {
  char * jti_hash = config->glewlwyd_config->glewlwyd_callback_generate_hash(config->glewlwyd_config, jti), * iat_clause;
  json_t * j_query, * j_result;
  int res, ret;

  if (jti_hash != NULL) {
    j_query = json_pack("{sss[s]s{ssssss}}",
                        "table", GLEWLWYD_PLUGIN_OIDC_TABLE_DPOP,
                        "columns",
                          "gpod_id",
                        "where",
                          "gpod_plugin_name", config->name,
                          "gpod_jti_hash", jti_hash,
                          "gpod_client_id", client_id);
    res = h_select(config->glewlwyd_config->glewlwyd_config->conn, j_query, &j_result, NULL);
    json_decref(j_query);
    if (res == H_OK) {
      if (!json_array_size(j_result)) {
        if (config->glewlwyd_config->glewlwyd_config->conn->type==HOEL_DB_TYPE_MARIADB) {
          iat_clause = msprintf("FROM_UNIXTIME(%"JSON_INTEGER_FORMAT")", iat);
        } else if (config->glewlwyd_config->glewlwyd_config->conn->type==HOEL_DB_TYPE_PGSQL) {
          iat_clause = msprintf("TO_TIMESTAMP(%"JSON_INTEGER_FORMAT")", iat);
        } else { // HOEL_DB_TYPE_SQLITE
          iat_clause = msprintf("%"JSON_INTEGER_FORMAT, iat);
        }
        j_query = json_pack("{sss{sssssssssssss{ss}}}",
                            "table", GLEWLWYD_PLUGIN_OIDC_TABLE_DPOP,
                            "values",
                              "gpod_plugin_name", config->name,
                              "gpod_client_id", client_id,
                              "gpod_jti_hash", jti_hash,
                              "gpod_jkt", jkt,
                              "gpod_htm", htm,
                              "gpod_htu", htu,
                              "gpod_iat",
                                "raw",
                                iat_clause);
        o_free(iat_clause);
        res = h_insert(config->glewlwyd_config->glewlwyd_config->conn, j_query, NULL);
        json_decref(j_query);
        if (res == H_OK) {
          ret = G_OK;
        } else {
          y_log_message(Y_LOG_LEVEL_ERROR, "check_dpop_jti - Error executing j_query (2)");
          config->glewlwyd_config->glewlwyd_plugin_callback_metrics_increment_counter(config->glewlwyd_config, GLWD_METRICS_DATABSE_ERROR, 1, NULL);
          ret = G_ERROR_DB;
        }
      } else {
        y_log_message(Y_LOG_LEVEL_WARNING, "jti already used for client %s at IP Address %s", client_id, ip_source);
        ret = G_ERROR_UNAUTHORIZED;
        config->glewlwyd_config->glewlwyd_plugin_callback_metrics_increment_counter(config->glewlwyd_config, GLWD_METRICS_OIDC_UNAUTHORIZED_CLIENT, 1, "plugin", config->name, NULL);
      }
      json_decref(j_result);
    } else {
      y_log_message(Y_LOG_LEVEL_ERROR, "check_dpop_jti - Error executing j_query (1)");
      config->glewlwyd_config->glewlwyd_plugin_callback_metrics_increment_counter(config->glewlwyd_config, GLWD_METRICS_DATABSE_ERROR, 1, NULL);
      ret = G_ERROR_DB;
    }
    o_free(jti_hash);
  } else {
    y_log_message(Y_LOG_LEVEL_ERROR, "check_dpop_jti - Error glewlwyd_callback_generate_hash");
    ret = G_ERROR;
  }
  return ret;
}
