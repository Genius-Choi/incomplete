static HRESULT SecurePerMachineCacheRoot(
    __in BURN_CACHE* pCache
    )
{
    HRESULT hr = S_OK;
    BOOL fRedirected = FALSE;
    LPWSTR sczCacheDirectory = NULL;

    if (!pCache->fPerMachineCacheRootVerified)
    {
        // If we are doing a permachine install but have not yet verified that the root cache folder
        // was created with the correct ACLs yet, do that now.
        hr = GetRootPath(pCache, TRUE, TRUE, &sczCacheDirectory);
        ExitOnFailure(hr, "Failed to get cache directory.");

        fRedirected = S_FALSE == hr;

        hr = DirEnsureExists(sczCacheDirectory, NULL);
        ExitOnFailure(hr, "Failed to create cache directory: %ls", sczCacheDirectory);

        hr = SecurePath(sczCacheDirectory);
        ExitOnFailure(hr, "Failed to secure cache directory: %ls", sczCacheDirectory);

        pCache->fPerMachineCacheRootVerified = TRUE;

        if (!fRedirected)
        {
            pCache->fOriginalPerMachineCacheRootVerified = TRUE;
        }
    }

    if (!pCache->fOriginalPerMachineCacheRootVerified)
    {
        // If we are doing a permachine install but have not yet verified that the original root cache folder
        // was created with the correct ACLs yet, do that now.
        hr = GetRootPath(pCache, TRUE, FALSE, &sczCacheDirectory);
        ExitOnFailure(hr, "Failed to get original cache directory.");

        hr = DirEnsureExists(sczCacheDirectory, NULL);
        ExitOnFailure(hr, "Failed to create original cache directory: %ls", sczCacheDirectory);

        hr = SecurePath(sczCacheDirectory);
        ExitOnFailure(hr, "Failed to secure original cache directory: %ls", sczCacheDirectory);

        pCache->fOriginalPerMachineCacheRootVerified = TRUE;
    }

LExit:
    ReleaseStr(sczCacheDirectory);

    return hr;
}
