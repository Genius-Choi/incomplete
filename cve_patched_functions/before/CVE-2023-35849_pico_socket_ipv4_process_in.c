static void pico_socket_ipv4_process_in(struct pico_frame *f)
{
    struct pico_tree_node *node;
    struct pico_ipv4_hdr *hdr = (struct pico_ipv4_hdr *)f->net_hdr;
    pico_tree_foreach(node, &f->dev->stack->IP4Sockets) {
        struct pico_socket_ipv4 *s;
        struct pico_frame *cp;
        s = (struct pico_socket_ipv4 *) node->keyValue;
        if (!s->hdr_included && ((s->proto != PICO_PROTO_IPV4) && (s->proto != hdr->proto)))
            continue;
        if ((s->sock.state | PICO_SOCKET_STATE_BOUND) != 0) {
            if (s->sock.dev != f->dev)
                continue;
            if ((s->sock.local_addr.ip4.addr != 0) && (s->sock.local_addr.ip4.addr != hdr->dst.addr))
                continue;
        }
        cp = pico_frame_copy(f);
        if (cp) {
            pico_enqueue(&s->sock.q_in, cp);
            if (s->sock.wakeup) {
                s->sock.wakeup(PICO_SOCK_EV_RD, &s->sock);
            }
        }
    }
}
