static int ncrush_move_encoder_windows(NCRUSH_CONTEXT* ncrush, BYTE* HistoryPtr)
{
	int i, j;
	int NewHash;
	int NewMatch;
	UINT32 HistoryOffset;

	WINPR_ASSERT(ncrush);
	WINPR_ASSERT(HistoryPtr);

	if (HistoryPtr < &ncrush->HistoryBuffer[32768])
		return -1;

	if (HistoryPtr > &ncrush->HistoryBuffer[65536])
		return -1;

	MoveMemory(ncrush->HistoryBuffer, HistoryPtr - 32768, 32768);
	const intptr_t hsize = HistoryPtr - 32768 - ncrush->HistoryBuffer;
	WINPR_ASSERT(hsize <= UINT32_MAX);
	WINPR_ASSERT(hsize >= 0);
	HistoryOffset = (UINT32)hsize;

	for (i = 0; i < 65536; i += 4)
	{
		NewHash = ncrush->HashTable[i + 0] - HistoryOffset;
		ncrush->HashTable[i + 0] = (NewHash <= 0) ? 0 : NewHash;
		NewHash = ncrush->HashTable[i + 1] - HistoryOffset;
		ncrush->HashTable[i + 1] = (NewHash <= 0) ? 0 : NewHash;
		NewHash = ncrush->HashTable[i + 2] - HistoryOffset;
		ncrush->HashTable[i + 2] = (NewHash <= 0) ? 0 : NewHash;
		NewHash = ncrush->HashTable[i + 3] - HistoryOffset;
		ncrush->HashTable[i + 3] = (NewHash <= 0) ? 0 : NewHash;
	}

	for (j = 0; j < 32768; j += 4)
	{
		NewMatch = ncrush->MatchTable[HistoryOffset + j + 0] - HistoryOffset;
		ncrush->MatchTable[j + 0] = (NewMatch <= 0) ? 0 : NewMatch;
		NewMatch = ncrush->MatchTable[HistoryOffset + j + 1] - HistoryOffset;
		ncrush->MatchTable[j + 1] = (NewMatch <= 0) ? 0 : NewMatch;
		NewMatch = ncrush->MatchTable[HistoryOffset + j + 2] - HistoryOffset;
		ncrush->MatchTable[j + 2] = (NewMatch <= 0) ? 0 : NewMatch;
		NewMatch = ncrush->MatchTable[HistoryOffset + j + 3] - HistoryOffset;
		ncrush->MatchTable[j + 3] = (NewMatch <= 0) ? 0 : NewMatch;
	}

	ZeroMemory(&ncrush->MatchTable[32768], 65536);
	return 1;
}
