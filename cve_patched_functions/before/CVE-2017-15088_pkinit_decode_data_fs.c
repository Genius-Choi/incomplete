pkinit_decode_data_fs(krb5_context context,
                      pkinit_identity_crypto_context id_cryptoctx,
                      const uint8_t *data, unsigned int data_len,
                      uint8_t **decoded_data, unsigned int *decoded_data_len)
{
    X509 *cert = sk_X509_value(id_cryptoctx->my_certs,
                               id_cryptoctx->cert_index);
    EVP_PKEY *pkey = id_cryptoctx->my_key;
    uint8_t *buf;
    int buf_len, decrypt_len;

    *decoded_data = NULL;
    *decoded_data_len = 0;

    if (cert != NULL && !X509_check_private_key(cert, pkey)) {
        pkiDebug("private key does not match certificate\n");
        return KRB5KDC_ERR_PREAUTH_FAILED;
    }

    buf_len = EVP_PKEY_size(pkey);
    buf = malloc(buf_len + 10);
    if (buf == NULL)
        return KRB5KDC_ERR_PREAUTH_FAILED;

    decrypt_len = EVP_PKEY_decrypt_old(buf, data, data_len, pkey);
    if (decrypt_len <= 0) {
        pkiDebug("unable to decrypt received data (len=%d)\n", data_len);
        free(buf);
        return KRB5KDC_ERR_PREAUTH_FAILED;
    }

    *decoded_data = buf;
    *decoded_data_len = decrypt_len;
    return 0;
}
