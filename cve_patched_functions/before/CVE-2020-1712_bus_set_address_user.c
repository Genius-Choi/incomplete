int bus_set_address_user(sd_bus *b) {
        const char *e;
        _cleanup_free_ char *ee = NULL, *s = NULL;

        assert(b);

        e = secure_getenv("DBUS_SESSION_BUS_ADDRESS");
        if (e)
                return sd_bus_set_address(b, e);

        e = secure_getenv("XDG_RUNTIME_DIR");
        if (!e)
                return -ENOENT;

        ee = bus_address_escape(e);
        if (!ee)
                return -ENOMEM;

        if (asprintf(&s, DEFAULT_USER_BUS_ADDRESS_FMT, ee) < 0)
                return -ENOMEM;

        b->address = TAKE_PTR(s);

        return 0;
}
