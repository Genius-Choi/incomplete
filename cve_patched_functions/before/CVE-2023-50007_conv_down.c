static void conv_down(double *in, int in_length, double *low, double *high,
                      int out_length, const double *lp, const double *hp,
                      int wavelet_length, int skip,
                      double *buffer, int buffer_length)
{
    double thigh = 0.0, tlow = 0.0;
    int buff_idx = 1 + skip;

    memcpy(buffer, in, buff_idx * sizeof(*buffer));
    memset(buffer + buff_idx, 0, (buffer_length - buff_idx) * sizeof(*buffer));

    for (int i = 0; i < out_length - 1; i++) {
        double thigh = 0.0, tlow = 0.0;

        for (int j = 0; j < wavelet_length; j++) {
            const int idx = mod_pow2(-j + buff_idx - 1, buffer_length);
            const double btemp = buffer[idx];

            thigh += btemp * hp[j];
            tlow += btemp * lp[j];
        }

        high[i] = thigh;
        low[i] = tlow;
        buffer[buff_idx++] = in[2 * i + 1 + skip];
        buffer[buff_idx++] = in[2 * i + 2 + skip];
        buff_idx = mod_pow2(buff_idx, buffer_length);
    }

    for (int i = 0; i < wavelet_length; i++) {
        const int idx = mod_pow2(-i + buff_idx - 1, buffer_length);
        const double btemp = buffer[idx];

        thigh += btemp * hp[i];
        tlow += btemp * lp[i];
    }

    high[out_length - 1] = thigh;
    low[out_length - 1] = tlow;
}
