do_arg(work, mangled, result)
struct work_stuff *work;
const char **mangled;
string *result;
{
	/* Remember where we started so that we can record the type, for
	   non-squangling type remembering.  */
	const char *start = *mangled;

	string_init(result);

	if (work->nrepeats > 0) {
		--work->nrepeats;

		if (work->previous_argument == 0)
			return 0;

		/* We want to reissue the previous type in this argument list.  */
		string_appends(result, work->previous_argument);
		return 1;
	}

	if (**mangled == 'n') {
		/* A squangling-style repeat.  */
		(*mangled)++;
		work->nrepeats = consume_count(mangled);

		if (work->nrepeats <= 0)
			/* This was not a repeat count after all.  */
			return 0;

		if (work->nrepeats > 9) {
			if (**mangled != '_')
				/* The repeat count should be followed by an '_' in this
				   case.  */
				return 0;
			else
				(*mangled)++;
		}

		/* Now, the repeat is all set up.  */
		return do_arg(work, mangled, result);
	}

	/* Save the result in WORK->previous_argument so that we can find it
	   if it's repeated.  Note that saving START is not good enough: we
	   do not want to add additional types to the back-referenceable
	   type vector when processing a repeated type.  */
	if (work->previous_argument)
		string_clear(work->previous_argument);
	else {
		work->previous_argument = (string *)malloc(sizeof(string));
		string_init(work->previous_argument);
	}

	if (!do_type(work, mangled, work->previous_argument))
		return 0;

	string_appends(result, work->previous_argument);

	remember_type(work, start, *mangled - start);
	return 1;
}
