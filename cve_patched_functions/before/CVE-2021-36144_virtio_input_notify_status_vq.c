virtio_input_notify_status_vq(void *vdev, struct virtio_vq_info *vq)
{
	struct virtio_input *vi;
	struct virtio_input_event event;
	struct input_event host_event;
	struct iovec iov;
	int n, len;
	uint16_t idx;

	vi = vdev;

	while (vq_has_descs(vq)) {
		n = vq_getchain(vq, &idx, &iov, 1, NULL);
		if (n < 0) {
			WPRINTF(("virtio_input: invalid descriptors\n"));
			return;
		}
		if (n == 0) {
			WPRINTF(("virtio_input: get no available descriptors\n"));
			return;
		}
		if (n != 1) {
			WPRINTF(("virtio_input: get wrong number of available descriptors\n"));
			vq_relchain(vq, idx, sizeof(event)); /* Release the chain */
			return;
		}

		if (vi->fd > 0) {
			memcpy(&event, iov.iov_base, sizeof(event));
			if (!virtio_input_ignore_event(&event)) {
				host_event.type = event.type;
				host_event.code = event.code;
				host_event.value = event.value;
				if (gettimeofday(&host_event.time, NULL)) {
					WPRINTF(("vtinput: gettimeofday failed\n"));
					break;
				}
				len = write(vi->fd, &host_event, sizeof(host_event));
				if (len == -1)
					WPRINTF(("%s: write failed, len = %d, "
						"errno = %d\n",
						__func__, len, errno));
			}
		}
		vq_relchain(vq, idx, sizeof(event)); /* Release the chain */
	}
	vq_endchains(vq, 1);	/* Generate interrupt if appropriate. */
}
