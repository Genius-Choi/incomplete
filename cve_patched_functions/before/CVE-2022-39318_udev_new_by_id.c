size_t udev_new_by_id(URBDRC_PLUGIN* urbdrc, libusb_context* ctx, UINT16 idVendor, UINT16 idProduct,
                      IUDEVICE*** devArray)
{
	LIBUSB_DEVICE** libusb_list;
	UDEVICE** array;
	ssize_t i, total_device;
	size_t num = 0;

	if (!urbdrc || !devArray)
		return 0;

	WLog_Print(urbdrc->log, WLOG_INFO, "VID: 0x%04" PRIX16 ", PID: 0x%04" PRIX16 "", idVendor,
	           idProduct);
	total_device = libusb_get_device_list(ctx, &libusb_list);
	array = (UDEVICE**)calloc(total_device, sizeof(UDEVICE*));

	if (!array)
		goto fail;

	for (i = 0; i < total_device; i++)
	{
		LIBUSB_DEVICE* dev = libusb_list[i];
		LIBUSB_DEVICE_DESCRIPTOR* descriptor = udev_new_descript(urbdrc, dev);

		if ((descriptor->idVendor == idVendor) && (descriptor->idProduct == idProduct))
		{
			array[num] = (PUDEVICE)udev_init(urbdrc, ctx, dev, libusb_get_bus_number(dev),
			                                 libusb_get_device_address(dev));

			if (array[num] != NULL)
				num++;
		}
		else
		{
			libusb_unref_device(dev);
		}

		free(descriptor);
	}

fail:
	libusb_free_device_list(libusb_list, 0);
	*devArray = (IUDEVICE**)array;
	return num;
}
