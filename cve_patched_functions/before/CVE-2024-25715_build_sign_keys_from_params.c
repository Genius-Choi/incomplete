static int build_sign_keys_from_params(struct _oidc_config * config) {
  int ret = G_OK;
  jwk_t * jwk = NULL, * jwk_pub;
  jwks_t * jwks_pub_export = NULL;
  jwa_alg alg;
  size_t i;
  int type;
  char * kid;

  do {
    if (r_jwks_init(&config->jwks_sign) != RHN_OK) {
      y_log_message(Y_LOG_LEVEL_ERROR, "build_sign_keys_from_params - Error r_jwks_init jwks_sign");
      ret = G_ERROR;
      break;
    }
    if (r_jwks_init(&config->jwks_public) != RHN_OK) {
      y_log_message(Y_LOG_LEVEL_ERROR, "build_sign_keys_from_params - Error r_jwks_init jwks_public");
      ret = G_ERROR;
      break;
    }
    if (r_jwks_init(&jwks_pub_export) != RHN_OK) {
      y_log_message(Y_LOG_LEVEL_ERROR, "build_sign_keys_from_params - Error r_jwks_init jwks_pub_export");
      ret = G_ERROR;
      break;
    }

    config->x5u_flags = R_FLAG_FOLLOW_REDIRECT|(json_object_get(config->j_params, "request-uri-allow-https-non-secure")==json_true()?R_FLAG_IGNORE_SERVER_CERTIFICATE:0);

    // Set specified alg in config parameters
    if (0 == o_strcmp("rsa", json_string_value(json_object_get(config->j_params, "jwt-type")))) {
      if (0 == o_strcmp("256", json_string_value(json_object_get(config->j_params, "jwt-key-size")))) {
        alg = R_JWA_ALG_RS256;
      } else if (0 == o_strcmp("384", json_string_value(json_object_get(config->j_params, "jwt-key-size")))) {
        alg = R_JWA_ALG_RS384;
      } else { // 512
        alg = R_JWA_ALG_RS512;
      }
      if (!json_string_null_or_empty(json_object_get(config->j_params, "key")) && !json_string_null_or_empty(json_object_get(config->j_params, "cert"))) {
        if ((jwk = r_jwk_quick_import(R_IMPORT_PEM, R_X509_TYPE_PRIVKEY, json_string_value(json_object_get(config->j_params, "key")), json_string_length(json_object_get(config->j_params, "key")))) == NULL) {
          y_log_message(Y_LOG_LEVEL_ERROR, "build_sign_keys_from_params - oidc - Error r_jwk_quick_import key rsa");
          ret = G_ERROR_PARAM;
        }
        r_jwk_set_property_str(jwk, "alg", r_jwa_alg_to_str(alg));
        if (r_jwks_append_jwk(config->jwks_sign, jwk) != RHN_OK) {
          y_log_message(Y_LOG_LEVEL_ERROR, "build_sign_keys_from_params - oidc - Error r_jwks_append_jwk jwks_sign rsa");
          ret = G_ERROR;
        }
        r_jwk_free(jwk);
        if (ret != G_OK) {
          break;
        }
        if ((jwk = r_jwk_quick_import(R_IMPORT_PEM, R_X509_TYPE_UNSPECIFIED, json_string_value(json_object_get(config->j_params, "cert")), json_string_length(json_object_get(config->j_params, "cert")))) == NULL) {
          y_log_message(Y_LOG_LEVEL_ERROR, "build_sign_keys_from_params - oidc - Error r_jwk_quick_import public rsa");
          ret = G_ERROR_PARAM;
        }
        r_jwk_set_property_str(jwk, "alg", r_jwa_alg_to_str(alg));
        if (r_jwks_append_jwk(config->jwks_public, jwk) != RHN_OK) {
          y_log_message(Y_LOG_LEVEL_ERROR, "build_sign_keys_from_params - oidc - Error r_jwks_append_jwk jwks_public rsa");
          ret = G_ERROR;
        }
        if (r_jwks_append_jwk(jwks_pub_export, jwk) != RHN_OK) {
          y_log_message(Y_LOG_LEVEL_ERROR, "build_sign_keys_from_params - oidc - Error r_jwks_append_jwk jwks_pub_export rsa");
          ret = G_ERROR;
        }
        r_jwk_free(jwk);
        if (ret != G_OK) {
          break;
        }
      }
    } else if (0 == o_strcmp("ecdsa", json_string_value(json_object_get(config->j_params, "jwt-type")))) {
      if (0 == o_strcmp("256", json_string_value(json_object_get(config->j_params, "jwt-key-size")))) {
        alg = R_JWA_ALG_ES256;
      } else if (0 == o_strcmp("256", json_string_value(json_object_get(config->j_params, "jwt-key-size")))) {
        alg = R_JWA_ALG_ES384;
      } else { // 512
        alg = R_JWA_ALG_ES512;
      }
      if (!json_string_null_or_empty(json_object_get(config->j_params, "key")) && !json_string_null_or_empty(json_object_get(config->j_params, "cert"))) {
        if ((jwk = r_jwk_quick_import(R_IMPORT_PEM, R_X509_TYPE_PRIVKEY, json_string_value(json_object_get(config->j_params, "key")), json_string_length(json_object_get(config->j_params, "key")))) == NULL) {
          y_log_message(Y_LOG_LEVEL_ERROR, "build_sign_keys_from_params - oidc - Error r_jwk_quick_import key ecdsa");
          ret = G_ERROR_PARAM;
        }
        r_jwk_set_property_str(jwk, "alg", r_jwa_alg_to_str(alg));
        if (r_jwks_append_jwk(config->jwks_sign, jwk) != RHN_OK) {
          y_log_message(Y_LOG_LEVEL_ERROR, "build_sign_keys_from_params - oidc - Error r_jwks_append_jwk jwks_sign ecdsa");
          ret = G_ERROR;
        }
        r_jwk_free(jwk);
        if (ret != G_OK) {
          break;
        }
        if ((jwk = r_jwk_quick_import(R_IMPORT_PEM, R_X509_TYPE_UNSPECIFIED, json_string_value(json_object_get(config->j_params, "cert")), json_string_length(json_object_get(config->j_params, "cert")))) == NULL) {
          y_log_message(Y_LOG_LEVEL_ERROR, "build_sign_keys_from_params - oidc - Error r_jwk_quick_import public ecdsa");
          ret = G_ERROR_PARAM;
        }
        r_jwk_set_property_str(jwk, "alg", r_jwa_alg_to_str(alg));
        if (r_jwks_append_jwk(config->jwks_public, jwk) != RHN_OK) {
          y_log_message(Y_LOG_LEVEL_ERROR, "build_sign_keys_from_params - oidc - Error r_jwks_append_jwk jwks_public ecdsa");
          ret = G_ERROR;
        }
        if (r_jwks_append_jwk(jwks_pub_export, jwk) != RHN_OK) {
          y_log_message(Y_LOG_LEVEL_ERROR, "build_sign_keys_from_params - oidc - Error r_jwks_append_jwk jwks_pub_export ecdsa");
          ret = G_ERROR;
        }
        r_jwk_free(jwk);
        if (ret != G_OK) {
          break;
        }
      }
    } else if (0 == o_strcmp("rsa-pss", json_string_value(json_object_get(config->j_params, "jwt-type")))) {
      if (0 == o_strcmp("256", json_string_value(json_object_get(config->j_params, "jwt-key-size")))) {
        alg = R_JWA_ALG_PS256;
      } else if (0 == o_strcmp("256", json_string_value(json_object_get(config->j_params, "jwt-key-size")))) {
        alg = R_JWA_ALG_PS384;
      } else { // 512
        alg = R_JWA_ALG_PS512;
      }
      if (!json_string_null_or_empty(json_object_get(config->j_params, "key")) && !json_string_null_or_empty(json_object_get(config->j_params, "cert"))) {
        if ((jwk = r_jwk_quick_import(R_IMPORT_PEM, R_X509_TYPE_PRIVKEY, json_string_value(json_object_get(config->j_params, "key")), json_string_length(json_object_get(config->j_params, "key")))) == NULL) {
          y_log_message(Y_LOG_LEVEL_ERROR, "build_sign_keys_from_params - oidc - Error r_jwk_quick_import key rsa-pss");
          ret = G_ERROR_PARAM;
        }
        r_jwk_set_property_str(jwk, "alg", r_jwa_alg_to_str(alg));
        if (r_jwks_append_jwk(config->jwks_sign, jwk) != RHN_OK) {
          y_log_message(Y_LOG_LEVEL_ERROR, "build_sign_keys_from_params - oidc - Error r_jwks_append_jwk jwks_sign rsa-pss");
          ret = G_ERROR;
        }
        r_jwk_free(jwk);
        if (ret != G_OK) {
          break;
        }
        if ((jwk = r_jwk_quick_import(R_IMPORT_PEM, R_X509_TYPE_UNSPECIFIED, json_string_value(json_object_get(config->j_params, "cert")), json_string_length(json_object_get(config->j_params, "cert")))) == NULL) {
          y_log_message(Y_LOG_LEVEL_ERROR, "build_sign_keys_from_params - oidc - Error r_jwk_quick_import public rsa-pss");
          ret = G_ERROR_PARAM;
        }
        r_jwk_set_property_str(jwk, "alg", r_jwa_alg_to_str(alg));
        if (r_jwks_append_jwk(config->jwks_public, jwk) != RHN_OK) {
          y_log_message(Y_LOG_LEVEL_ERROR, "build_sign_keys_from_params - oidc - Error r_jwks_append_jwk jwks_public rsa-pss");
          ret = G_ERROR;
        }
        if (r_jwks_append_jwk(jwks_pub_export, jwk) != RHN_OK) {
          y_log_message(Y_LOG_LEVEL_ERROR, "build_sign_keys_from_params - oidc - Error r_jwks_append_jwk jwks_pub_export rsa-pss");
          ret = G_ERROR;
        }
        r_jwk_free(jwk);
        if (ret != G_OK) {
          break;
        }
      }
    } else if (0 == o_strcmp("eddsa", json_string_value(json_object_get(config->j_params, "jwt-type")))) {
      alg = R_JWA_ALG_EDDSA;
      if (!json_string_null_or_empty(json_object_get(config->j_params, "key")) && !json_string_null_or_empty(json_object_get(config->j_params, "cert"))) {
        if ((jwk = r_jwk_quick_import(R_IMPORT_PEM, R_X509_TYPE_PRIVKEY, json_string_value(json_object_get(config->j_params, "key")), json_string_length(json_object_get(config->j_params, "key")))) == NULL) {
          y_log_message(Y_LOG_LEVEL_ERROR, "build_sign_keys_from_params - oidc - Error r_jwk_quick_import key eddsa");
          ret = G_ERROR_PARAM;
        }
        r_jwk_set_property_str(jwk, "alg", r_jwa_alg_to_str(alg));
        if (r_jwks_append_jwk(config->jwks_sign, jwk) != RHN_OK) {
          y_log_message(Y_LOG_LEVEL_ERROR, "build_sign_keys_from_params - oidc - Error r_jwks_append_jwk jwks_sign eddsa");
          ret = G_ERROR;
        }
        r_jwk_free(jwk);
        if (ret != G_OK) {
          break;
        }
        if ((jwk = r_jwk_quick_import(R_IMPORT_PEM, R_X509_TYPE_UNSPECIFIED, json_string_value(json_object_get(config->j_params, "cert")), json_string_length(json_object_get(config->j_params, "cert")))) == NULL) {
          y_log_message(Y_LOG_LEVEL_ERROR, "build_sign_keys_from_params - oidc - Error r_jwk_quick_import public eddsa");
          ret = G_ERROR_PARAM;
        }
        r_jwk_set_property_str(jwk, "alg", r_jwa_alg_to_str(alg));
        if (r_jwks_append_jwk(config->jwks_public, jwk) != RHN_OK) {
          y_log_message(Y_LOG_LEVEL_ERROR, "build_sign_keys_from_params - oidc - Error r_jwks_append_jwk jwks_public eddsa");
          ret = G_ERROR;
        }
        if (r_jwks_append_jwk(jwks_pub_export, jwk) != RHN_OK) {
          y_log_message(Y_LOG_LEVEL_ERROR, "build_sign_keys_from_params - oidc - Error r_jwks_append_jwk jwks_pub_export eddsa");
          ret = G_ERROR;
        }
        r_jwk_free(jwk);
        if (ret != G_OK) {
          break;
        }
      }
    } else { // SHA
      if (0 == o_strcmp("256", json_string_value(json_object_get(config->j_params, "jwt-key-size")))) {
        alg = R_JWA_ALG_HS256;
      } else if (0 == o_strcmp("256", json_string_value(json_object_get(config->j_params, "jwt-key-size")))) {
        alg = R_JWA_ALG_HS384;
      } else { // 512
        alg = R_JWA_ALG_HS512;
      }
      if (!json_string_null_or_empty(json_object_get(config->j_params, "key"))) {
        if ((jwk = r_jwk_quick_import(R_IMPORT_SYMKEY, json_string_value(json_object_get(config->j_params, "key")), json_string_length(json_object_get(config->j_params, "key")))) == NULL) {
          y_log_message(Y_LOG_LEVEL_ERROR, "build_sign_keys_from_params - oidc - Error r_jwk_quick_import sha");
          ret = G_ERROR_PARAM;
        }
        kid = r_jwk_thumbprint(jwk, R_JWK_THUMB_SHA256, 0);
        r_jwk_set_property_str(jwk, "alg", r_jwa_alg_to_str(alg));
        r_jwk_set_property_str(jwk, "kid", kid);
        o_free(kid);
        if (r_jwks_append_jwk(config->jwks_sign, jwk) != RHN_OK) {
          y_log_message(Y_LOG_LEVEL_ERROR, "build_sign_keys_from_params - oidc - Error r_jwks_append_jwk jwks_sign sha");
          ret = G_ERROR;
        }
        if (r_jwks_append_jwk(config->jwks_public, jwk) != RHN_OK) {
          y_log_message(Y_LOG_LEVEL_ERROR, "build_sign_keys_from_params - oidc - Error r_jwks_append_jwk jwks_public sha");
          ret = G_ERROR;
        }
        r_jwk_free(jwk);
        if (ret != G_OK) {
          break;
        }
      }
    }

    if (!json_string_null_or_empty(json_object_get(config->j_params, "jwks-private")) || !json_string_null_or_empty(json_object_get(config->j_params, "jwks-uri"))) {
      r_jwks_empty(config->jwks_sign);
      if (!json_string_null_or_empty(json_object_get(config->j_params, "jwks-uri"))) {
        if (r_jwks_import_from_uri(config->jwks_sign, json_string_value(json_object_get(config->j_params, "jwks-uri")), config->x5u_flags) != RHN_OK) {
          y_log_message(Y_LOG_LEVEL_ERROR, "build_sign_keys_from_params - oidc - Error importing jwks_sign from uri");
          ret = G_ERROR_PARAM;
          break;
        }
      } else {
        if (r_jwks_import_from_json_str(config->jwks_sign, json_string_value(json_object_get(config->j_params, "jwks-private"))) != RHN_OK) {
          y_log_message(Y_LOG_LEVEL_ERROR, "build_sign_keys_from_params - oidc - Error importing jwks_sign from data");
          ret = G_ERROR_PARAM;
          break;
        }
      }
      if (!r_jwks_size(config->jwks_sign)) {
        y_log_message(Y_LOG_LEVEL_ERROR, "build_sign_keys_from_params - oidc - Error jwks_sign is empty");
        ret = G_ERROR_PARAM;
        break;
      }
      for (i=0; ret == G_OK && i<r_jwks_size(config->jwks_sign); i++) {
        jwk = r_jwks_get_at(config->jwks_sign, i);
        type = r_jwk_key_type(jwk, NULL, config->x5u_flags);
        if (!(type & R_KEY_TYPE_PRIVATE) && !(type & R_KEY_TYPE_SYMMETRIC)) {
          y_log_message(Y_LOG_LEVEL_ERROR, "build_sign_keys_from_params - oidc - Error jwk at index %zu is not a private or a symmetric key", i);
          ret = G_ERROR_PARAM;
        } else if (o_strnullempty(r_jwk_get_property_str(jwk, "kid"))) {
          y_log_message(Y_LOG_LEVEL_ERROR, "build_sign_keys_from_params - oidc - Error jwk at index %zu is missing 'kid' property", i);
          ret = G_ERROR_PARAM;
        } else if (r_str_to_jwa_alg(r_jwk_get_property_str(jwk, "alg")) == R_JWA_ALG_UNKNOWN) {
          y_log_message(Y_LOG_LEVEL_ERROR, "build_sign_keys_from_params - oidc - Error jwk at index %zu invalid 'alg' property: '%s'", i, r_jwk_get_property_str(jwk, "alg"));
          ret = G_ERROR_PARAM;
        } else {
          if (!(type & R_KEY_TYPE_SYMMETRIC)) {
            jwk_pub = NULL;
            if (r_jwk_init(&jwk_pub) != RHN_OK || r_jwk_extract_pubkey(jwk, jwk_pub, config->x5u_flags) != RHN_OK) {
              y_log_message(Y_LOG_LEVEL_ERROR, "build_sign_keys_from_params - oidc - Error extracting public key at index %zu", i);
              ret = G_ERROR;
            } else {
              r_jwks_append_jwk(config->jwks_public, jwk_pub);
              r_jwks_append_jwk(jwks_pub_export, jwk_pub);
            }
            r_jwk_free(jwk_pub);
          } else {
            r_jwks_append_jwk(config->jwks_public, jwk);
          }
        }
        r_jwk_free(jwk);
      }
      if (ret != G_OK) {
        break;
      }
    }

    if (!json_string_null_or_empty(json_object_get(config->j_params, "jwks-public-uri")) || !json_string_null_or_empty(json_object_get(config->j_params, "jwks-public"))) {
      r_jwks_empty(jwks_pub_export);
      if (!json_string_null_or_empty(json_object_get(config->j_params, "jwks-public-uri"))) {
        if (r_jwks_import_from_uri(jwks_pub_export, json_string_value(json_object_get(config->j_params, "jwks-public-uri")), config->x5u_flags) != RHN_OK) {
          y_log_message(Y_LOG_LEVEL_ERROR, "build_sign_keys_from_params - oidc - Error importing jwks-public from uri");
          ret = G_ERROR;
          break;
        }
      } else {
        if (r_jwks_import_from_json_str(jwks_pub_export, json_string_value(json_object_get(config->j_params, "jwks-public"))) != RHN_OK) {
          y_log_message(Y_LOG_LEVEL_ERROR, "build_sign_keys_from_params - oidc - Error importing jwks-public from data");
          ret = G_ERROR;
          break;
        }
      }
    }

    if (!r_jwks_size(config->jwks_sign)) {
      y_log_message(Y_LOG_LEVEL_ERROR, "build_sign_keys_from_params - oidc - Error jwks_sign empty");
      ret = G_ERROR;
      break;
    }

    if (!r_jwks_size(config->jwks_public)) {
      y_log_message(Y_LOG_LEVEL_ERROR, "build_sign_keys_from_params - oidc - Error jwks_public empty");
      ret = G_ERROR;
      break;
    }

    if (r_jwks_size(jwks_pub_export)) {
      config->jwks_str = r_jwks_export_to_json_str(jwks_pub_export, 0);
    }
  } while (0);
  r_jwks_free(jwks_pub_export);
  return ret;
}
