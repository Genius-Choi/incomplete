  return runLight("popen", [&] (LightProcess* proc) -> FILE* {
      auto afdt_fd = proc->m_afdt_fd;
      lwp_write(afdt_fd, "popen", type, cmd, cwd ? cwd : "");

      std::string buf;
      lwp_read(afdt_fd, buf);
      if (buf == "error") {
        return nullptr;
      }

      pid_t pid;
      lwp_read(afdt_fd, pid);
      assert(pid);
      int fd = recv_fd(afdt_fd);
      if (fd < 0) {
        Logger::Error("Light process failed to send the file descriptor.");
        return nullptr;
      }
      FILE *f = fdopen(fd, type);
      if (f) {
        proc->m_popenMap[f] = pid;
      }
      return f;
    }, static_cast<FILE*>(nullptr));
