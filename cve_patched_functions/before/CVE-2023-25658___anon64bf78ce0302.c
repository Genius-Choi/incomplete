  absl::call_once(ordinal_selector_once_, [&]() {
    std::unique_ptr<Graph> graph(new Graph(flib_def_.get()));
    bool enable_spmd_xla_partitioning = false;
    TPUMetadata tpu_metadata;
    {
      absl::MutexLock l(&mu_);
      OP_REQUIRES_OK_ASYNC(
          ctx,
          GetGraphFromFunction(graph.get(), /*device_ordinal=*/0,
                               &enable_spmd_xla_partitioning, &tpu_metadata),
          done);
    }
    if (enable_spmd_xla_partitioning) {
      ordinal_selector_ = std::make_shared<tpu::TPUOrdinalSelector>(
          tpu_metadata.num_cores_per_replica);
    } else {
      ordinal_selector_ = std::make_shared<tpu::TPUOrdinalSelector>();
    }

    metrics::RecordTPUXlaSpmdCoresPerReplica(
        tpu_metadata.num_cores_per_replica);
  });
