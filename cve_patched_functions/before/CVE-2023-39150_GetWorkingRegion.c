SMALL_RECT CEAnsi::GetWorkingRegion(HANDLE hConsoleOutput, bool viewPort) const
{
	const short kFallback = 9999;
	SMALL_RECT region = {0, 0, kFallback, kFallback};
	// ReSharper disable once CppLocalVariableMayBeConst
	HANDLE hConOut = hConsoleOutput ? hConsoleOutput : GetStdHandle(STD_OUTPUT_HANDLE);
	CONSOLE_SCREEN_BUFFER_INFO csbi = {};
	// If function fails, we return {kFallback, kFallback}
	if (GetConsoleScreenBufferInfoCached(hConOut, &csbi, TRUE))
	{
		if (viewPort)
		{
			// Trick to avoid overflow of SHORT
			region = MakeSmallRect(
				std::min<WORD>(static_cast<WORD>(csbi.srWindow.Left), std::numeric_limits<SHORT>::max()),
				std::min<WORD>(static_cast<WORD>(csbi.srWindow.Top), std::numeric_limits<SHORT>::max()),
				std::min<WORD>(static_cast<WORD>(csbi.srWindow.Right), std::numeric_limits<SHORT>::max()),
				std::min<WORD>(static_cast<WORD>(csbi.srWindow.Bottom), std::numeric_limits<SHORT>::max())
			);
		}
		else
		{
			region = MakeSmallRect(
				0,
				0,
				std::min<WORD>(static_cast<WORD>(csbi.dwSize.X - 1), std::numeric_limits<SHORT>::max()),
				std::min<WORD>(static_cast<WORD>(csbi.dwSize.Y - 1), std::numeric_limits<SHORT>::max())
			);
		}
		// Last checks
		if (region.Right < region.Left)
			region.Right = region.Left;
		if (region.Bottom < region.Top)
			region.Bottom = region.Top;
	}
	return region;
}
