int CEXEBuild::set_target_architecture_data()
{
  build_strlist.setunicode(build_unicode), ubuild_strlist.setunicode(build_unicode);
  size_t t64 = is_target_64bit(), i;

  WORD dc = DefaultPEDllCharacteristics;
  if ((dc & IMAGE_DLLCHARACTERISTICS_DYNAMIC_BASE) && t64) dc |= IMAGE_DLLCHARACTERISTICS_HIGH_ENTROPY_VA;
  if (m_target_type == TARGET_ARM64) dc &= ~IMAGE_DLLCHARACTERISTICS_NO_SEH; // ARM64 forces exception directory?
  PEDllCharacteristics = dc;

  if (build_unicode)
  {
    definedlist.set(_T("NSIS_UNICODE"));
    definedlist.set(_T("NSIS_CHAR_SIZE"), _T("2"));
  }
  else
  {
    definedlist.del(_T("NSIS_UNICODE"));
    definedlist.set(_T("NSIS_CHAR_SIZE"), _T("1"));
  }
  definedlist.set(_T("NSIS_PTR_SIZE"), t64 ? _T("8") : _T("4"));

  const TCHAR* tsuff = get_target_suffix(m_target_type, _T(""));
  if (!*tsuff) return PS_ERROR;
  tstring cpu = get_string_prefix(tsuff, _T("-"));
  definedlist.set(_T("NSIS_CPU"), cpu.c_str()); // Used by Library.nsh to pick the correct RegTool

  struct { TARGETTYPE tt; const TCHAR *def; const TCHAR *val; } static const tdef[] = {
    { TARGET_X86ANSI,    _T("NSIS_IX86"),  _T("300") },
    { TARGET_X86UNICODE, _T("NSIS_IX86"),  _T("400") },
    { TARGET_AMD64,      _T("NSIS_AMD64"), _T("1")   },
    { TARGET_ARM64,      _T("NSIS_ARM64"), _T("1")   }
  };
  for (i = 0; i < COUNTOF(tdef); ++i) definedlist.del(tdef[i].def);
  unsigned int success = false;
  for (i = 0; i < COUNTOF(tdef); ++i) if (tdef[i].tt == m_target_type) definedlist.set(tdef[i].def, tdef[i].val), ++success;

  return success ? PS_OK : PS_ERROR;
}
