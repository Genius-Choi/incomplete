EVP_PKEY* generate_dh_peer_key(const std::vector<uint8_t>& buffer)
{
    DH* dh = DH_new();

    if(dh != nullptr)
    {
        const unsigned char* pointer = buffer.data();

        if((pointer = BN_deserialize(&dh->p, buffer.data(), pointer)) != nullptr)
        {
            if((pointer = BN_deserialize(&dh->g, buffer.data(), pointer)) != nullptr)
            {
                if((pointer = BN_deserialize(&dh->pub_key, buffer.data(), pointer)) != nullptr)
                {
                    EVP_PKEY* key = EVP_PKEY_new();

                    if(key != nullptr)
                    {
                        if(EVP_PKEY_assign_DH(key, dh) > 0)
                        {
                            return key;
                        }
                        else
                            logError(AUTHENTICATION, "OpenSSL library cannot set dh in pkey");

                        EVP_PKEY_free(key);
                    }
                    else
                        logError(AUTHENTICATION, "OpenSSL library cannot create pkey");
                }
                else
                    logError(AUTHENTICATION, "Cannot deserialize public key");
            }
            else
                logError(AUTHENTICATION, "Cannot deserialize g");
        }
        else
            logError(AUTHENTICATION, "Cannot deserialize p");

        DH_free(dh);
    }
    else
        logError(AUTHENTICATION, "OpenSSL library cannot create dh");

    return nullptr;
}
