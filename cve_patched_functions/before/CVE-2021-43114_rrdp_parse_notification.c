rrdp_parse_notification(struct rpki_uri *uri, bool log_operation, bool force,
    struct update_notification **result)
{
	long last_update;
	int error, vis_err;

	if (uri == NULL || uri_is_rsync(uri))
		pr_crit("Wrong call, trying to parse a non HTTPS URI");

	pr_val_debug("Processing notification '%s'.", uri_get_global(uri));
	last_update = 0;
	if (!force) {
		error = db_rrdp_uris_get_last_update(uri_get_global(uri), &last_update);
		if (error && error != -ENOENT)
			return error;
	}

	error = download_file(uri, last_update, log_operation);
	if (error < 0)
		return error;

	/* Request error, stop processing to handle as such */
	if (error == EREQFAILED)
		return error;

	/*
	 * Mark as visited, if it doesn't exists yet, there's no problem since
	 * this is probably the first time is visited (first run), so it will
	 * be marked as visited when the URI is stored at DB.
	 */
	vis_err = db_rrdp_uris_set_request_status(uri_get_global(uri),
	    RRDP_URI_REQ_VISITED);
	if (vis_err && vis_err != -ENOENT)
		return pr_val_err("Couldn't mark '%s' as visited",
		    uri_get_global(uri));

	/* No updates yet */
	if (error > 0) {
		delete_from_uri(uri, NULL);
		*result = NULL;
		return 0;
	}

	fnstack_push_uri(uri);
	error = parse_notification(uri, result);
	delete_from_uri(uri, NULL);
	if (error) {
		fnstack_pop();
		return error;
	}

	return 0;
}
