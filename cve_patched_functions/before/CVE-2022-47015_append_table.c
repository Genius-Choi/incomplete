int spider_db_mbase_util::append_table(
  ha_spider *spider,
  spider_fields *fields,
  spider_string *str,
  TABLE_LIST *table_list,
  TABLE_LIST **used_table_list,
  uint *current_pos,
  TABLE_LIST **cond_table_list_ptr,
  bool top_down,
  bool first
) {
  int error_num;
  bool use_cond_table_list = FALSE;
  spider_mbase_share *db_share;
  spider_mbase_handler *dbton_hdl;
  SPIDER_TABLE_HOLDER *table_holder;
  TABLE_LIST *cond_table_list = *cond_table_list_ptr;
  ha_spider *spd;
  DBUG_ENTER("spider_db_mbase_util::append_table");
  DBUG_PRINT("info",("spider table_list=%p", table_list));
  DBUG_PRINT("info",("spider table_list->outer_join=%u",
    table_list->outer_join));
  DBUG_PRINT("info",("spider table_list->on_expr=%p",
    table_list->on_expr));
  DBUG_PRINT("info",("spider table_list->join_using_fields=%p",
    table_list->join_using_fields));
  DBUG_PRINT("info",("spider table_list->table=%p",
    table_list->table));
  if (!top_down && table_list->embedding)
  {
    if ((error_num = append_embedding_tables(spider, fields, str,
      table_list->embedding, used_table_list, current_pos,
      cond_table_list_ptr)))
      DBUG_RETURN(error_num);
  } else if (!table_list->table)
  {
    if ((error_num = append_tables_top_down(spider, fields, str, table_list,
      used_table_list, current_pos, cond_table_list_ptr)))
      DBUG_RETURN(error_num);
  } else {
    if (
      table_list->outer_join ||
      table_list->on_expr ||
      table_list->join_using_fields
    ) {
      DBUG_PRINT("info",("spider use table_list"));
      if (table_list->outer_join & JOIN_TYPE_LEFT)
      {
        if (str)
        {
          if (str->reserve(SPIDER_SQL_LEFT_JOIN_LEN))
          {
            DBUG_RETURN(HA_ERR_OUT_OF_MEM);
          }
          str->q_append(SPIDER_SQL_LEFT_JOIN_STR, SPIDER_SQL_LEFT_JOIN_LEN);
        }
      } else {
        if (str)
        {
          if (str->reserve(SPIDER_SQL_JOIN_LEN))
          {
            DBUG_RETURN(HA_ERR_OUT_OF_MEM);
          }
          str->q_append(SPIDER_SQL_JOIN_STR, SPIDER_SQL_JOIN_LEN);
        }
      }
    } else if (
      cond_table_list &&
      (
        cond_table_list->outer_join ||
        cond_table_list->on_expr ||
        cond_table_list->join_using_fields
      )
    ) {
      DBUG_PRINT("info",("spider use cond_table_list"));
      if (cond_table_list->outer_join & (JOIN_TYPE_LEFT | JOIN_TYPE_RIGHT))
      {
        if (str)
        {
          if (str->reserve(SPIDER_SQL_LEFT_JOIN_LEN))
          {
            DBUG_RETURN(HA_ERR_OUT_OF_MEM);
          }
          str->q_append(SPIDER_SQL_LEFT_JOIN_STR, SPIDER_SQL_LEFT_JOIN_LEN);
        }
      } else {
        if (str)
        {
          if (str->reserve(SPIDER_SQL_JOIN_LEN))
          {
            DBUG_RETURN(HA_ERR_OUT_OF_MEM);
          }
          str->q_append(SPIDER_SQL_JOIN_STR, SPIDER_SQL_JOIN_LEN);
        }
      }
      use_cond_table_list = TRUE;
    } else if (*current_pos > 0 && !first)
    {
      DBUG_PRINT("info",("spider no condition"));
      if (top_down)
      {
        if (str)
        {
          if (str->reserve(SPIDER_SQL_JOIN_LEN))
          {
            DBUG_RETURN(HA_ERR_OUT_OF_MEM);
          }
          str->q_append(SPIDER_SQL_JOIN_STR, SPIDER_SQL_JOIN_LEN);
        }
      } else {
        if (str)
        {
          if (str->reserve(SPIDER_SQL_COMMA_LEN))
          {
            DBUG_RETURN(HA_ERR_OUT_OF_MEM);
          }
          str->q_append(SPIDER_SQL_COMMA_STR, SPIDER_SQL_COMMA_LEN);
        }
      }
    }

    if (str)
    {
      table_holder = fields->get_table_holder(table_list->table);
      spd = table_holder->spider;
      db_share = (spider_mbase_share *)
        spd->share->dbton_share[dbton_id];
      dbton_hdl = (spider_mbase_handler *)
        spd->dbton_handler[dbton_id];

      dbton_hdl->table_name_pos = str->length();

      if (str->reserve(
        db_share->db_nm_max_length +
        SPIDER_SQL_DOT_LEN + /* SPIDER_SQL_NAME_QUOTE_LEN */ 4 +
        db_share->table_nm_max_length + SPIDER_SQL_SPACE_LEN +
        table_holder->alias->length() - SPIDER_SQL_DOT_LEN
      )) {
        DBUG_RETURN(HA_ERR_OUT_OF_MEM);
      }

      if ((error_num = db_share->append_table_name_with_adjusting(str,
        spd->conn_link_idx[dbton_hdl->first_link_idx])))
      {
        DBUG_RETURN(error_num);
      }
      str->q_append(SPIDER_SQL_SPACE_STR, SPIDER_SQL_SPACE_LEN);
      str->q_append(table_holder->alias->ptr(),
        table_holder->alias->length() - SPIDER_SQL_DOT_LEN);
    }
    used_table_list[(*current_pos)++] = table_list;

    if (str)
    {
      List<String> *join_using_fields = table_list->join_using_fields;
      if (!join_using_fields && cond_table_list)
      {
        join_using_fields = cond_table_list->join_using_fields;
      }

      if (join_using_fields)
      {
        if (str->reserve(SPIDER_SQL_USING_LEN + SPIDER_SQL_OPEN_PAREN_LEN))
        {
          DBUG_RETURN(HA_ERR_OUT_OF_MEM);
        }
        str->q_append(SPIDER_SQL_USING_STR, SPIDER_SQL_USING_LEN);
        str->q_append(SPIDER_SQL_OPEN_PAREN_STR,
          SPIDER_SQL_OPEN_PAREN_LEN);
        List_iterator_fast<String> it2(*join_using_fields);
        String *ptr;
        while ((ptr = it2++))
        {
          if (str->reserve(ptr->length() + SPIDER_SQL_COMMA_LEN))
          {
            DBUG_RETURN(HA_ERR_OUT_OF_MEM);
          }
          str->q_append(ptr->ptr(), ptr->length());
          str->q_append(SPIDER_SQL_COMMA_STR, SPIDER_SQL_COMMA_LEN);
        }
        str->length(str->length() - SPIDER_SQL_COMMA_LEN);
        if (str->reserve(SPIDER_SQL_CLOSE_PAREN_LEN))
        {
          DBUG_RETURN(HA_ERR_OUT_OF_MEM);
        }
        str->q_append(SPIDER_SQL_CLOSE_PAREN_STR,
          SPIDER_SQL_CLOSE_PAREN_LEN);
      }
    }

    Item *on_expr = table_list->on_expr;
    if (!on_expr && cond_table_list)
    {
      on_expr = cond_table_list->on_expr;
    }

    if (on_expr)
    {
      if (str)
      {
        if (str->reserve(SPIDER_SQL_ON_LEN))
        {
          DBUG_RETURN(HA_ERR_OUT_OF_MEM);
        }
        str->q_append(SPIDER_SQL_ON_STR, SPIDER_SQL_ON_LEN);
      }
      if ((error_num = spider_db_print_item_type(on_expr, NULL,
        spider, str, NULL, 0, dbton_id, TRUE, fields)))
      {
        DBUG_RETURN(error_num);
      }
    }

    if (use_cond_table_list)
    {
      (*cond_table_list_ptr) = NULL;
      DBUG_PRINT("info",("spider cond_table_list=%p", (*cond_table_list_ptr)));
    }
  }
  DBUG_RETURN(0);
}
