uint8_t mobi_unicode_to_utf8(char *output, const size_t codepoint) {
    if (!output) {
        return 0;
    }
    unsigned char *bytes = (unsigned char *) output;
    
    if (codepoint < 0x80) {
        bytes[0] = (unsigned char) codepoint;
        return 1;
    }
    if (codepoint < 0x800) {
        bytes[1] = (unsigned char) ((2 << 6) | (codepoint & 0x3f));
        bytes[0] = (unsigned char) ((6 << 5) | (codepoint >> 6));
        return 2;
    }
    if (codepoint < 0x10000) {
        bytes[2] = (unsigned char) ((2 << 6) | (codepoint & 0x3f));
        bytes[1] = (unsigned char) ((2 << 6) | ((codepoint >> 6) & 0x3f));
        bytes[0] = (unsigned char) ((14 << 4) | (codepoint >> 12));
        return 3;
    }
    if (codepoint < 0x11000) {
        bytes[3] = (unsigned char) ((2 << 6) | (codepoint & 0x3f));
        bytes[2] = (unsigned char) ((2 << 6) | ((codepoint >> 6) & 0x3f));
        bytes[1] = (unsigned char) ((2 << 6) | ((codepoint >> 12) & 0x3f));
        bytes[0] = (unsigned char) ((30 << 3) | (codepoint >> 18));
        return 4;
    }
    return 0;
}
