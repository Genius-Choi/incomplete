fu_plugin_runner_coldplug(FuPlugin *self, FuProgress *progress, GError **error)
{
	FuPluginPrivate *priv = GET_PRIVATE(self);
	FuPluginVfuncs *vfuncs = fu_plugin_get_vfuncs(self);
	g_autoptr(GError) error_local = NULL;

	g_return_val_if_fail(FU_IS_PLUGIN(self), FALSE);

	/* progress */
	fu_progress_set_name(progress, fu_plugin_get_name(self));

	/* not enabled */
	if (fu_plugin_has_flag(self, FWUPD_PLUGIN_FLAG_DISABLED))
		return TRUE;

	/* no HwId */
	if (fu_plugin_has_flag(self, FWUPD_PLUGIN_FLAG_REQUIRE_HWID))
		return TRUE;

	/* optional */
	if (vfuncs->coldplug == NULL)
		return TRUE;
	g_debug("coldplug(%s)", fu_plugin_get_name(self));
	if (!vfuncs->coldplug(self, progress, &error_local)) {
		if (error_local == NULL) {
			g_critical("unset plugin error in coldplug(%s)", fu_plugin_get_name(self));
			g_set_error_literal(&error_local,
					    FWUPD_ERROR,
					    FWUPD_ERROR_INTERNAL,
					    "unspecified error");
		}
		/* coldplug failed, but we might have already added devices to the daemon... */
		if (priv->devices != NULL) {
			for (guint i = 0; i < priv->devices->len; i++) {
				FuDevice *device = g_ptr_array_index(priv->devices, i);
				g_warning("removing device %s due to failed coldplug",
					  fu_device_get_id(device));
				fu_plugin_device_remove(self, device);
			}
		}
		g_propagate_prefixed_error(error,
					   g_steal_pointer(&error_local),
					   "failed to coldplug using %s: ",
					   fu_plugin_get_name(self));
		return FALSE;
	}
	return TRUE;
}
