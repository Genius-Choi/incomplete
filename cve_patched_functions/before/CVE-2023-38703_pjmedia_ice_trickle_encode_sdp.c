PJ_DEF(pj_status_t) pjmedia_ice_trickle_encode_sdp(
                                            pj_pool_t *sdp_pool,
                                            pjmedia_sdp_session *sdp,
                                            const pj_str_t *mid,
                                            const pj_str_t *ufrag,
                                            const pj_str_t *passwd,
                                            unsigned cand_cnt,
                                            const pj_ice_sess_cand cand[],
                                            pj_bool_t end_of_cand)
{
    pjmedia_sdp_media *m = NULL;
    pjmedia_sdp_attr *a;
    unsigned i;

    PJ_ASSERT_RETURN(sdp_pool && sdp, PJ_EINVAL);

    /* Find media by checking "a=mid"*/
    for (i = 0; i < sdp->media_count; ++i) {
        m = sdp->media[i];
        a = pjmedia_sdp_media_find_attr2(m, "mid", NULL);
        if (a && pj_strcmp(&a->value, mid)==0)
            break;
    }

    /* Media not exist, try to add it */
    if (i == sdp->media_count) {
        if (sdp->media_count >= PJMEDIA_MAX_SDP_MEDIA) {
            PJ_LOG(3,(THIS_FILE,"Trickle ICE failed to encode candidates, "
                                "the specified SDP has too many media"));
            return PJ_ETOOMANY;
        }

        /* Add a new media to the SDP */
        m = PJ_POOL_ZALLOC_T(sdp_pool, pjmedia_sdp_media);
        m->desc.media = pj_str("audio");
        m->desc.fmt_count = 1;
        m->desc.fmt[0] = pj_str("0");
        m->desc.transport = pj_str("RTP/AVP");
        sdp->media[sdp->media_count++] = m;

        /* Add media ID attribute "a=mid" */
        a = pjmedia_sdp_attr_create(sdp_pool, "mid", mid);
        pjmedia_sdp_attr_add(&m->attr_count, m->attr, a);
    }

    /* Add "a=ice-options:trickle" in session level */
    a = pjmedia_sdp_attr_find(sdp->attr_count, sdp->attr, &STR_ICE_OPTIONS,
                              NULL);
    if (!a || !pj_strstr(&a->value, &STR_TRICKLE)) {
        a = pjmedia_sdp_attr_create(sdp_pool, STR_ICE_OPTIONS.ptr,
                                    &STR_TRICKLE);
        pjmedia_sdp_attr_add(&sdp->attr_count, sdp->attr, a);
    }

    /* Add "a=ice-options:trickle" in media level */
    /*
    a = pjmedia_sdp_attr_find(m->attr_count, m->attr, &STR_ICE_OPTIONS,
                              NULL);
    if (!a || !pj_strstr(&a->value, &STR_TRICKLE)) {
        a = pjmedia_sdp_attr_create(sdp_pool, STR_ICE_OPTIONS.ptr,
                                    &STR_TRICKLE);
        pjmedia_sdp_attr_add(&m->attr_count, m->attr, a);
    }
    */

    /* Add ice-ufrag & ice-pwd attributes */
    if (ufrag && passwd &&
        !pjmedia_sdp_attr_find(m->attr_count, m->attr, &STR_ICE_UFRAG, NULL))
    {
        a = pjmedia_sdp_attr_create(sdp_pool, STR_ICE_UFRAG.ptr, ufrag);
        pjmedia_sdp_attr_add(&m->attr_count, m->attr, a);

        a = pjmedia_sdp_attr_create(sdp_pool, STR_ICE_PWD.ptr, passwd);
        pjmedia_sdp_attr_add(&m->attr_count, m->attr, a);
    }

    /* Add candidates */
    for (i=0; i<cand_cnt; ++i) {
        enum {
            ATTR_BUF_LEN = 160, /* Max len of a=candidate attr */
            RATTR_BUF_LEN= 160  /* Max len of a=remote-candidates attr */
        };
        char attr_buf[ATTR_BUF_LEN];
        pj_str_t value;

        value.slen = print_sdp_cand_attr(attr_buf, ATTR_BUF_LEN, &cand[i]);
        if (value.slen < 0) {
            pj_assert(!"Not enough attr_buf to print candidate");
            return PJ_EBUG;
        }

        value.ptr = attr_buf;
        a = pjmedia_sdp_attr_create(sdp_pool, STR_CANDIDATE.ptr, &value);
        pjmedia_sdp_attr_add(&m->attr_count, m->attr, a);
    }

    /* Add "a=end-of-candidates" */
    if (end_of_cand) {
        a = pjmedia_sdp_attr_find(m->attr_count, m->attr, &STR_END_OF_CAND,
                                  NULL);
        if (!a) {
            a = pjmedia_sdp_attr_create(sdp_pool, STR_END_OF_CAND.ptr, NULL);
            pjmedia_sdp_attr_add(&m->attr_count, m->attr, a);
        }
    }

    return PJ_SUCCESS;
}
