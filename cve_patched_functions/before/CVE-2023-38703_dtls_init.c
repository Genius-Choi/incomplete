static pj_status_t dtls_init()
{
    /* Make sure OpenSSL library has been initialized */
    {
        pj_ssl_cipher ciphers[1];
        unsigned cipher_num = 1;
        pj_ssl_cipher_get_availables(ciphers, &cipher_num);
    }

    /* Generate cert if not yet */
    if (!dtls_cert) {
        pj_status_t status;
        status = ssl_generate_cert(&dtls_cert, &dtls_priv_key);
        if (status != PJ_SUCCESS) {
            pj_perror(4, "DTLS-SRTP", status,
                      "Failed generating DTLS certificate");
            return status;
        }
    }

    if (valid_profiles_cnt == 0) {
        unsigned n, j;
        int rc;
        char *p, *end, buf[OPENSSL_PROFILE_NUM*25];

        /* Create DTLS context */
        SSL_CTX *ctx = SSL_CTX_new(DTLS_method());
        if (ctx == NULL) {
            return PJ_ENOMEM;
        }

        p = buf;
        end = buf + sizeof(buf);
        for (j=0; j<PJ_ARRAY_SIZE(ossl_profiles); ++j) {
            rc = SSL_CTX_set_tlsext_use_srtp(ctx, ossl_profiles[j]);
            if (rc == 0) {
                valid_pj_profiles_list[valid_profiles_cnt] =
                    pj_profiles[j];
                valid_ossl_profiles_list[valid_profiles_cnt++] =
                    ossl_profiles[j];

                n = pj_ansi_snprintf(p, end - p, ":%s", pj_profiles[j]);
                p += n;
            }
        }
        SSL_CTX_free(ctx);

        if (valid_profiles_cnt > 0) {
            PJ_LOG(4,("DTLS-SRTP", "%s profile is supported", buf));
        } else {
            PJ_PERROR(4, ("DTLS-SRTP", PJMEDIA_SRTP_DTLS_ENOPROFILE,
                          "Error getting SRTP profile"));

            return PJMEDIA_SRTP_DTLS_ENOPROFILE;
        }
    }

    return PJ_SUCCESS;
}
