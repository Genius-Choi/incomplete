int CEXEBuild::AddVersionInfo()
{
  GrowBuf VerInfoStream;

  // Should probably check for (4 & version_fixedflags) here, but VIProductVersion without VIAddVersionKey
  // fails silently, so VIFileVersion does the same...
  if ( rVersionInfo.GetStringTablesCount() > 0 )
  {
    if ( !(1 & version_fixedflags) )
    {
      ERROR_MSG(_T("Error: VIProductVersion is required when other version information functions are used.\n"));
      return PS_ERROR;
    }
    else
    {
      if ( !(2 & version_fixedflags) )
      {
        // This error string should match the one used by the TOK_VI_SETFILEVERSION handler
        ERROR_MSG(_T("Error: invalid %") NPRIs _T(" format, should be X.X.X.X\n"),_T("VIProductVersion"));
        return PS_ERROR;
      }

      try
      {
        init_res_editor();
        for ( int i = 0; i < rVersionInfo.GetStringTablesCount(); i++ )
        {
          LANGID lang_id = rVersionInfo.GetLangID(i);
          int code_page = rVersionInfo.GetCodePage(i);

          const TCHAR *lang_name = GetLangNameAndCPForVersionResource(lang_id, NULL, false);

          const TCHAR *recverkeys = 
            _T("FileVersion\0")
            _T("FileDescription\0")
            _T("LegalCopyright\0");
          for(;;)
          {
            if ( !*recverkeys ) break;
            if ( !rVersionInfo.FindKey(lang_id, code_page, recverkeys) )
              warning(DW_VI_MISSINGSTDKEY, _T("Generating version information for language \"%04d-%") NPRIs _T("\" without standard key \"%") NPRIs _T("\""), lang_id, lang_name, recverkeys);
            recverkeys += _tcsclen(recverkeys) + 1;
          }

          rVersionInfo.ExportToStream(VerInfoStream, i);
          res_editor->UpdateResource(RT_VERSION, 1, lang_id, (BYTE*)VerInfoStream.get(), VerInfoStream.getlen());
        }
      }
      catch (exception& err) {
        ERROR_MSG(_T("Error adding version information: %") NPRIs _T("\n"), CtoTStrParam(err.what()));
        return PS_ERROR;
      }
    }
  }

  return PS_OK;
}
