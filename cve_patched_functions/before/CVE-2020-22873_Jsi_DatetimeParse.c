Jsi_RC Jsi_DatetimeParse(Jsi_Interp *interp, const char *str, const char *fmt, int isUtc, Jsi_Number *datePtr, bool noMsg)
{
    char fmt1[JSI_BUFSIZ];
    const char *rv = NULL;;
    Jsi_Number n = -1;
    int j = 0, tofs = 0;
    Jsi_RC rc = JSI_OK;
    Jsi_Number ms = 0;
    struct tm tm = {};
    tm.tm_isdst = -1;
    time_t t;
    if (!str || !Jsi_Strcmp("now", str)) {
        struct timeval tv;
        gettimeofday(&tv, NULL);
        n = tv.tv_sec*1000.0 + (tv.tv_usec)/1000.0;
        if (isUtc) {
            time_t t = time(NULL);
            struct tm lt = {0};
            lt.tm_isdst = -1;
            localtime_r(&t, &lt);
            
#ifdef __WIN32
            {
                time_t tt = 0;
                n += (int)time(&tt);
            }
#else
            n += (lt.tm_gmtoff)*1000.0;
#endif
        }
        if (datePtr)
            *datePtr = n;
        return rc;
    }
    if (fmt && fmt[0]) {
        const char *efp = Jsi_Strstr(fmt, "%f");
        if (efp && efp > fmt && efp[-1] != '%' && (Jsi_Strlen(fmt)+10)<(int)sizeof(fmt1)) {
            snprintf(fmt1, sizeof(fmt1), "%.*s:%%S.", (int)(efp-fmt), fmt);
            fmt = fmt1;
        }
        rv = strptime(str, fmt, &tm);
    } else {
        if (fmt) j++;
        while (timeFmts[j]) {
            rv = strptime(str, timeFmts[j], &tm);
            if (rv != NULL)
                break;
            j++;
        }
    }
    if (!rv) {
        rc = JSI_ERROR;
        if (!noMsg)
            Jsi_LogError("datetime parse failed");
    } else {
        if (*rv == '.' && isdigit(rv[1]) && isdigit(rv[2]) && isdigit(rv[3])) {
            ms = atof(rv+1);
            rv += 4;
        }
#if 0
        if (!isUtc) {
#ifdef __WIN32
#ifdef JSI_IS64BIT
            t = internal_timegm(&tm);
#else
            t = _mkgmtime(&tm); // TODO: undefined in mingw 64
#endif
#else
            t = timegm(&tm);
#endif
        } else
#endif
        {
            int th, ts;
            char ss[3];
            t = mktime(&tm);
            if (rv[0] == ' ') rv++;
            if (rv[0] && sscanf(rv, "%[+-]%2d:%2d", ss, &th, &ts) == 3) {
                int sign = (rv[0] == '-' ? 1 : -1);
                tofs = (3600*th+60*ts)*sign;
            }
            if (isUtc) {
#ifdef __WIN32
                time_t tt = 0;
                tofs += (int)time(&tt);
#else
                tofs += tm.tm_gmtoff;
#endif
            }
        }
        if (t==-1) {
            rc = JSI_ERROR;
            if (!noMsg)
                Jsi_LogError("mktime failed");
        }
        n = (Jsi_Number)(t+tofs)*1000.0 + ms;
    }
    if (rc == JSI_OK && datePtr)
        *datePtr = n;
    return rc;
}
