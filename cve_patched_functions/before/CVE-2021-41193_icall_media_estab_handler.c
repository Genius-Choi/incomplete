static void icall_media_estab_handler(struct icall *icall,
				      const char *userid,
				      const char *clientid,
				      bool update,
				      void *arg)
{
	int err;
	struct wcall *wcall = arg;
	struct calling_instance *inst = wcall ? wcall->inst : NULL;
	char peer_userid_anon[ANON_ID_LEN];
	char convid_anon[ANON_ID_LEN];

	if (!WCALL_VALID(wcall)) {
		warning("wcall(%p): ecall_media_estab_handler: invalid wcall "
			"inst=%p\n", wcall, inst);
		return;
	}

	info("wcall(%p): media established(video=%d): "
	     "convid=%s peer_userid=%s update=%d\n",
	     wcall, wcall->video.video_call,
	     anon_id(convid_anon, wcall->convid),
	     anon_id(peer_userid_anon, userid), update);
	
	set_state(wcall, WCALL_STATE_MEDIA_ESTAB);

	if (inst->mestabh) {
		inst->mestabh(wcall->convid, icall,
			      userid, clientid, inst->arg);
	}

	if (wcall->conv_type == WCALL_CONV_TYPE_ONEONONE) {
		if (inst->group.json.chgh) {
			call_group_change_json(inst, wcall);
		}
	}

	if (inst->mm) {
		enum mediamgr_state state;

		state = wcall->video.video_call ? MEDIAMGR_STATE_INVIDEOCALL
			                        : MEDIAMGR_STATE_INCALL;
		mediamgr_set_call_state(inst->mm, state);
	}
	else {
		err = ICALL_CALLE(icall, media_start);
		if (err) {
			warning("wcall(%p): icall_media_start failed (%m)\n",
				wcall, err);
		}
	}
}
