Status IteratorResource::Save(OpKernelContext* ctx,
                              ExternalStatePolicy external_state_policy,
                              IteratorStateWriter* writer) {
  std::shared_ptr<State> captured_state;
  {
    tf_shared_lock l(mu_);
    captured_state = iterator_state_;
  }
  auto iterator = captured_state->iterator();
  if (!iterator) {
    return errors::FailedPrecondition(
        "Save() failed because the iterator has not been initialized. Ensure "
        "that you have run the initializer operation for this iterator before "
        "saving it.");
  }
  auto* dataset = captured_state->dataset();
  if (SymbolicCheckpointEnabled(dataset->options())) {
    const auto& checkpoint = captured_state->checkpoint();
    if (!checkpoint.GetStatus().ok()) {
      return checkpoint.GetStatus();
    }
    TF_RETURN_IF_ERROR(checkpoint.Save(writer));
    return OkStatus();
  }
  SerializationContext::Params params(ctx);
  params.external_state_policy = external_state_policy;
  params.symbolic_checkpoint = SymbolicCheckpointEnabled(dataset->options());
  SerializationContext serialization_ctx(params);
  return iterator->Save(&serialization_ctx, writer);
}
