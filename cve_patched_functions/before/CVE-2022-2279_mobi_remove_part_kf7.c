MOBI_RET mobi_remove_part_kf7(MOBIData *m) {
    
    // move resource records to KF8 part
    
    size_t start_kf7 = MOBI_NOTSET;
    size_t start_kf8 = MOBI_NOTSET;
    size_t count_kf7 = MOBI_NOTSET;
    size_t count_kf8 = MOBI_NOTSET;
    
    // switch to KF7 data
    if (m->use_kf8) {
        mobi_swap_mobidata(m);
        m->use_kf8 = false;
    }
    if (m->mh == NULL) {
        debug_print("%s\n", "Mobi header for version 7 missing");
        return MOBI_INIT_FAILED;
    }
    if (m->mh->image_index) {
        start_kf7 = *m->mh->image_index;
    }
    MOBIExthHeader *exth = mobi_get_exthrecord_by_tag(m, EXTH_COUNTRESOURCES);
    if (exth) {
        count_kf7 = mobi_decode_exthvalue(exth->data, exth->size);
    }

    // switch back to KF8
    mobi_swap_mobidata(m);
    m->use_kf8 = true;

    if (m->mh == NULL || m->kf8_boundary_offset == MOBI_NOTSET) {
        debug_print("%s\n", "Mobi header for version 8 missing");
        return MOBI_INIT_FAILED;
    }
    
    if (m->mh->image_index) {
        start_kf8 = *m->mh->image_index;
    }
    
    MOBIExthHeader *exth_resources = mobi_get_exthrecord_by_tag(m, EXTH_COUNTRESOURCES);
    if (exth_resources) {
        count_kf8 = mobi_decode_exthvalue(exth_resources->data, exth_resources->size);
    }
    
    if (start_kf7 == MOBI_NOTSET || start_kf8 == MOBI_NOTSET ||
        count_kf7 == MOBI_NOTSET || count_kf8 == MOBI_NOTSET ||
        m->kf8_boundary_offset < count_kf7) {
        return MOBI_DATA_CORRUPT;
    }
            
    // move resources to KF8 part
    MOBIPdbRecord *extracted = mobi_extract_records_by_seqnumber(m, start_kf7, &count_kf7);

    m->kf8_boundary_offset -= count_kf7;
    start_kf8 += m->kf8_boundary_offset + 1;

    MOBI_RET ret = mobi_insert_records_by_seqnumber(m, extracted, start_kf8);
    if (ret != MOBI_SUCCESS) {
        return ret;
    }
    
    // delete records from beginning to boundary (inclusive)
    size_t count = m->kf8_boundary_offset + 1;

    ret = mobi_delete_records_by_seqnumber(m, 0, &count);
    if (ret != MOBI_SUCCESS) {
        return ret;
    }
    m->kf8_boundary_offset = MOBI_NOTSET;
    mobi_free_next(m);
    
    // update EXTH tags
    
    // update EXTH Count of Resources tag
    count_kf8 += count_kf7;
    if (exth_resources && exth_resources->size == 4 && count_kf8 <= UINT32_MAX) {
        uint32_t value = (uint32_t) count_kf8;
        unsigned char *p = exth_resources->data;
        *p++ = (uint8_t)((uint32_t)(value & 0xff000000U) >> 24);
        *p++ = (uint8_t)((uint32_t)(value & 0xff0000U) >> 16);
        *p++ = (uint8_t)((uint32_t)(value & 0xff00U) >> 8);
        *p = (uint8_t)((uint32_t)(value & 0xffU));
    }
    
    // check that EXTH Start Reading tag points to text, delete otherwise
    MOBIExthHeader *exth_start = NULL;
    while ((exth = mobi_next_exthrecord_by_tag(m, EXTH_STARTREADING, &exth_start))) {
        uint32_t offset = mobi_decode_exthvalue(exth->data, exth->size);
        if (offset > m->rh->text_record_count) {
            mobi_delete_exthrecord(m, exth);
        }
    }
    
    // reset KF8 related EXTH flags
    if (m->mh->exth_flags) {
        *m->mh->exth_flags &= 0x7ff;
        *m->mh->exth_flags |= 0x800;
    }
    
    // adjust record offsets
    if (m->mh->fdst_index && *m->mh->fdst_index + count_kf7 < UINT32_MAX) {
        *m->mh->fdst_index += count_kf7;
    }
    if (m->mh->fcis_index && *m->mh->fcis_index + count_kf7 < UINT32_MAX) {
        *m->mh->fcis_index += count_kf7;
    }
    if (m->mh->flis_index && *m->mh->flis_index + count_kf7 < UINT32_MAX) {
        *m->mh->flis_index += count_kf7;
    }
    if (m->mh->datp_index && *m->mh->datp_index + count_kf7 < UINT32_MAX) {
        *m->mh->datp_index += count_kf7;
    }
    if (m->mh->datp_rec_index && *m->mh->datp_rec_index + count_kf7 < UINT32_MAX) {
        *m->mh->datp_rec_index += count_kf7;
    }
    
    return MOBI_SUCCESS;
}
