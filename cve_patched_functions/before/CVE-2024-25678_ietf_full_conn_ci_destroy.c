ietf_full_conn_ci_destroy (struct lsquic_conn *lconn)
{
    struct ietf_full_conn *conn = (struct ietf_full_conn *) lconn;
    struct lsquic_stream **streamp, *stream;
    struct stream_id_to_ss *sits;
    struct dcid_elem **dcep, *dce;
    struct lsquic_hash_elem *el;
    unsigned i;

    if (!(conn->ifc_flags & IFC_SERVER))
    {
        for (streamp = conn->ifc_u.cli.crypto_streams; streamp <
                conn->ifc_u.cli.crypto_streams
                    + sizeof(conn->ifc_u.cli.crypto_streams)
                        / sizeof(conn->ifc_u.cli.crypto_streams[0]); ++streamp)
            if (*streamp)
                lsquic_stream_destroy(*streamp);
    }
    while ((el = lsquic_hash_first(conn->ifc_pub.all_streams)))
    {
        stream = lsquic_hashelem_getdata(el);
        lsquic_hash_erase(conn->ifc_pub.all_streams, el);
        lsquic_stream_destroy(stream);
    }
    if (conn->ifc_flags & IFC_HTTP)
    {
        lsquic_qdh_cleanup(&conn->ifc_qdh);
        lsquic_qeh_cleanup(&conn->ifc_qeh);
    }
    for (dcep = conn->ifc_dces; dcep < conn->ifc_dces + sizeof(conn->ifc_dces)
                                            / sizeof(conn->ifc_dces[0]); ++dcep)
        if (*dcep)
        {
            if ((*dcep)->de_hash_el.qhe_flags & QHE_HASHED)
                lsquic_hash_erase(conn->ifc_enpub->enp_srst_hash,
                                                        &(*dcep)->de_hash_el);
            lsquic_malo_put(*dcep);
        }
    while ((dce = TAILQ_FIRST(&conn->ifc_to_retire)))
    {
        TAILQ_REMOVE(&conn->ifc_to_retire, dce, de_next_to_ret);
        lsquic_malo_put(dce);
    }
    lsquic_send_ctl_cleanup(&conn->ifc_send_ctl);
    for (i = 0; i < N_PNS; ++i)
        lsquic_rechist_cleanup(&conn->ifc_rechist[i]);
    lsquic_malo_destroy(conn->ifc_pub.packet_out_malo);
    if (conn->ifc_flags & IFC_CREATED_OK)
        conn->ifc_enpub->enp_stream_if->on_conn_closed(&conn->ifc_conn);
    assert(conn->ifc_conn.cn_conn_ctx == NULL);
    if (conn->ifc_conn.cn_enc_session)
        conn->ifc_conn.cn_esf.i->esfi_destroy(conn->ifc_conn.cn_enc_session);
    while (!STAILQ_EMPTY(&conn->ifc_stream_ids_to_ss))
    {
        sits = STAILQ_FIRST(&conn->ifc_stream_ids_to_ss);
        STAILQ_REMOVE_HEAD(&conn->ifc_stream_ids_to_ss, sits_next);
        free(sits);
    }
    if (conn->ifc_flags & IFC_SERVER)
    {
        if (conn->ifc_pub.u.ietf.promises)
            lsquic_hash_destroy(conn->ifc_pub.u.ietf.promises);
    }
    for (i = 0; i < N_SITS; ++i)
        lsquic_set64_cleanup(&conn->ifc_closed_stream_ids[i]);
    if (conn->ifc_bpus)
    {
        for (el = lsquic_hash_first(conn->ifc_bpus); el;
                                        el = lsquic_hash_next(conn->ifc_bpus))
            free(lsquic_hashelem_getdata(el));
        lsquic_hash_destroy(conn->ifc_bpus);
    }
    lsquic_hash_destroy(conn->ifc_pub.all_streams);
#if LSQUIC_CONN_STATS
    if (conn->ifc_flags & IFC_CREATED_OK)
    {
        LSQ_NOTICE("# ticks: %lu", conn->ifc_stats.n_ticks);
        LSQ_NOTICE("sent %lu packets", conn->ifc_stats.out.packets);
        LSQ_NOTICE("received %lu packets, of which %lu were not decryptable, %lu were "
            "dups and %lu were errors; sent %lu packets, avg stream data per outgoing"
            " packet is %lu bytes",
            conn->ifc_stats.in.packets, conn->ifc_stats.in.undec_packets,
            conn->ifc_stats.in.dup_packets, conn->ifc_stats.in.err_packets,
            conn->ifc_stats.out.packets,
            conn->ifc_stats.out.stream_data_sz /
                (conn->ifc_stats.out.packets ? conn->ifc_stats.out.packets : 1));
        if (conn->ifc_flags & IFC_DELAYED_ACKS)
            LSQ_NOTICE("delayed ACKs settings: (%u/%.3f/%.3f/%.3f/%.3f/%.3f); "
                "packet tolerances sent: count: %u, min: %u, max: %u",
                conn->ifc_settings->es_ptpc_periodicity,
                conn->ifc_settings->es_ptpc_target,
                conn->ifc_settings->es_ptpc_prop_gain,
                conn->ifc_settings->es_ptpc_int_gain,
                conn->ifc_settings->es_ptpc_err_thresh,
                conn->ifc_settings->es_ptpc_err_divisor,
                conn->ifc_ack_freq_seqno,
                conn->ifc_min_pack_tol_sent, conn->ifc_max_pack_tol_sent);
        LSQ_NOTICE("ACKs: delayed acks on: %s; in: %lu; processed: %lu; merged: %lu",
            conn->ifc_flags & IFC_DELAYED_ACKS ? "yes" : "no",
            conn->ifc_stats.in.n_acks, conn->ifc_stats.in.n_acks_proc,
            conn->ifc_stats.in.n_acks_merged);
    }
    if (conn->ifc_last_stats)
        free(conn->ifc_last_stats);
#endif
    EV_LOG_CONN_EVENT(LSQUIC_LOG_CONN_ID, "full connection destroyed");
    free(conn->ifc_errmsg);
    free(conn);
}
