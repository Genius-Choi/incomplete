bool SrvAnsiImpl::WriteText(LPCWSTR lpBuffer, DWORD nNumberOfCharsToWrite, LPDWORD lpNumberOfCharsWritten)
{
	DWORD /*nWritten = 0,*/ nTotalWritten = 0;

	if (lpBuffer && nNumberOfCharsToWrite)
		m_Owner->m_LastWrittenChar = lpBuffer[nNumberOfCharsToWrite-1];

	LPCWSTR pszSrcBuffer = lpBuffer;
	wchar_t cvtBuf[400], *pcvtBuf = nullptr; CEStr szTemp;
	if (m_Owner->mCharSet && lpBuffer && nNumberOfCharsToWrite)
	{
		static wchar_t G0_DRAWING[31] = {
			0x2666 /*♦*/, 0x2592 /*▒*/, 0x2192 /*→*/, 0x21A8 /*↨*/, 0x2190 /*←*/, 0x2193 /*↓*/, 0x00B0 /*°*/, 0x00B1 /*±*/,
			0x00B6 /*¶*/, 0x2195 /*↕*/, 0x2518 /*┘*/, 0x2510 /*┐*/, 0x250C /*┌*/, 0x2514 /*└*/, 0x253C /*┼*/, 0x203E /*‾*/,
			0x207B /*⁻*/, 0x2500 /*─*/, 0x208B /*₋*/, 0x005F /*_*/, 0x251C /*├*/, 0x2524 /*┤*/, 0x2534 /*┴*/, 0x252C /*┬*/,
			0x2502 /*│*/, 0x2264 /*≤*/, 0x2265 /*≥*/, 0x03C0 /*π*/, 0x2260 /*≠*/, 0x00A3 /*£*/, 0x00B7 /*·*/
		};
		LPCWSTR pszMap = nullptr;
		// ReSharper disable once CppIncompleteSwitchStatement
		switch (m_Owner->mCharSet)
		{
		case SrvAnsi::VTCS_DRAWING:
			pszMap = G0_DRAWING;
			break;
		}
		if (pszMap)
		{
			wchar_t* dst = nullptr;
			for (DWORD i = 0; i < nNumberOfCharsToWrite; ++i)
			{
				if (pszSrcBuffer[i] >= 0x60 && pszSrcBuffer[i] < 0x7F)
				{
					if (!pcvtBuf)
					{
						if (nNumberOfCharsToWrite <= countof(cvtBuf))
						{
							pcvtBuf = cvtBuf;
						}
						else
						{
							if (!((pcvtBuf = szTemp.GetBuffer(nNumberOfCharsToWrite))))
								break;
						}
						lpBuffer = pcvtBuf;
						dst = pcvtBuf;
						if (i)
							memmove_s(dst, nNumberOfCharsToWrite * sizeof(*dst), pszSrcBuffer, i * sizeof(*dst));
					}
					dst[i] = pszMap[pszSrcBuffer[i] - 0x60];
				}
				else if (dst)
				{
					dst[i] = pszSrcBuffer[i];
				}
			}
		}
	}

	m_Table->Write(lpBuffer, nNumberOfCharsToWrite);

	if (lpNumberOfCharsWritten)
		*lpNumberOfCharsWritten = nNumberOfCharsToWrite;

	return true;
}
