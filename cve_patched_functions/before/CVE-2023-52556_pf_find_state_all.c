pf_find_state_all(struct pf_state_key_cmp *key, u_int dir, int *more)
{
	struct pf_state_key	*sk;
	struct pf_state_item	*si, *ret = NULL;

	pf_status.fcounters[FCNT_STATE_SEARCH]++;

	sk = RBT_FIND(pf_state_tree, &pf_statetbl, (struct pf_state_key *)key);

	if (sk != NULL) {
		TAILQ_FOREACH(si, &sk->sk_states, si_entry) {
			struct pf_state *sist = si->si_st;
			if (dir == PF_INOUT ||
			    (sk == (dir == PF_IN ? sist->key[PF_SK_WIRE] :
			    sist->key[PF_SK_STACK]))) {
				if (more == NULL)
					return (sist);

				if (ret)
					(*more)++;
				else
					ret = si;
			}
		}
	}
	return (ret ? ret->si_st : NULL);
}
