write_from_uri(char const *location, unsigned char *content, size_t content_len,
    struct visited_uris *visited_uris)
{
	struct rpki_uri *uri;
	struct stat stat;
	FILE *out;
	size_t written;
	int error;

	/* rfc8181#section-2.2 must be an rsync URI */
	error = uri_create_rsync_str_rrdp(&uri, location, strlen(location));
	if (error)
		return error;

	error = create_dir_recursive(uri_get_local(uri));
	if (error) {
		uri_refput(uri);
		return error;
	}

	error = file_write(uri_get_local(uri), &out, &stat);
	if (error) {
		uri_refput(uri);
		return error;
	}

	written = fwrite(content, sizeof(unsigned char), content_len, out);
	if (written != content_len) {
		uri_refput(uri);
		file_close(out);
		return pr_val_err("Couldn't write bytes to file %s",
		    uri_get_local(uri));
	}

	error = add_mft_to_list(visited_uris, uri_get_global(uri));
	if (error) {
		uri_refput(uri);
		file_close(out);
		return error;
	}

	uri_refput(uri);
	file_close(out);
	return 0;
}
