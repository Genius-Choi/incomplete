void CEAnsi::WriteAnsiLogFarPrompt()
{
	_ASSERTE(ghAnsiLogFile!=nullptr && "Caller must check this");
	// ReSharper disable once CppLocalVariableMayBeConst
	HANDLE hCon = GetStdHandle(STD_OUTPUT_HANDLE);
	CONSOLE_SCREEN_BUFFER_INFO csbi = {};
	if (!GetConsoleScreenBufferInfo(hCon, &csbi))
		return;
	CEStr buffer;
	DWORD nChars = csbi.dwSize.X;
	if (!buffer.GetBuffer(csbi.dwSize.X + 2))
		return;
	// We expect Far has already put "black user screen" and do CR/LF
	// if Far's keybar is hidden, we are on (csbi.dwSize.Y-1), otherwise - (csbi.dwSize.Y-2)
	_ASSERTE(csbi.dwCursorPosition.Y >= (csbi.dwSize.Y-2) && csbi.dwCursorPosition.Y <= (csbi.dwSize.Y-1));
	const COORD crFrom = {0, static_cast<SHORT>(csbi.dwCursorPosition.Y - 1)};
	if (ReadConsoleOutputCharacterW(hCon, buffer.data(), nChars, crFrom, &nChars)
		&& nChars)
	{
		wchar_t* pszBuf = buffer.data();
		// Do RTrim first
		while (nChars && (pszBuf[nChars - 1] == L' '))
			nChars--;
		// Add CR+LF
		pszBuf[nChars++] = L'\r'; pszBuf[nChars++] = L'\n';
		// And do the logging
		WriteAnsiLogW(pszBuf, nChars);
	}
}
