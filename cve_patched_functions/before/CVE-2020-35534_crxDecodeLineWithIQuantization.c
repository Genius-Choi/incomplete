int crxDecodeLineWithIQuantization(CrxSubband *subband)
{
  int32_t q_step_tbl[6] = {0x28, 0x2D, 0x33, 0x39, 0x40, 0x48};

  if (!subband->dataSize)
  {
    memset(subband->bandBuf, 0, subband->bandSize);
    return 0;
  }

  if (subband->supportsPartial)
  {
    uint32_t bitCode = crxBitstreamGetZeros(&subband->bandParam->bitStream);
    if (bitCode >= 23)
      bitCode = crxBitstreamGetBits(&subband->bandParam->bitStream, 8);
    else if (subband->paramK)
      bitCode =
          crxBitstreamGetBits(&subband->bandParam->bitStream, subband->paramK) |
          (bitCode << subband->paramK);

    subband->quantValue +=
        -(bitCode & 1) ^ (bitCode >> 1); // converting encoded to signed integer
    subband->paramK = crxPredictKParameter(subband->paramK, bitCode);
    if (subband->paramK > 7)
      return -1;
  }
  if (crxDecodeLine(subband->bandParam, subband->bandBuf))
    return -1;

  if (subband->width <= 0)
    return 0LL;

  // update subband buffers
  int32_t *bandBuf = (int32_t *)subband->bandBuf;
  int32_t qScale =
      q_step_tbl[subband->quantValue % 6] >> (6 - subband->quantValue / 6);
  if (subband->quantValue / 6 >= 6)
    qScale = q_step_tbl[subband->quantValue % 6] *
             (1 << (subband->quantValue / 6 + 26));

  if (qScale != 1)
    for (int32_t i = 0; i < subband->width; i++)
      bandBuf[i] *= qScale;

  return 0;
}
