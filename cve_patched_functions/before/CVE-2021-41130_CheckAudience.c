void AuthChecker::CheckAudience(bool cache_hit) {
  std::string audience = user_info_.audiences.empty()
                             ? std::string()
                             : user_info_.AudiencesAsString();
  context_->set_auth_issuer(user_info_.issuer);
  context_->set_auth_audience(audience);
  context_->set_auth_authorized_party(user_info_.authorized_party);

  context_->set_auth_claims(user_info_.claims);

  // Remove http/s header and trailing '/' for issuer.
  std::string issuer = utils::GetUrlContent(user_info_.issuer);
  if (!context_->method()->isIssuerAllowed(issuer)) {
    Unauthenticated("Issuer not allowed");
    return;
  }

  // The audience from the JWT must
  //   - Equals to service_name or
  //   - Explicitly allowed by the issuer in the method configuration.
  // Otherwise the JWT is rejected.
  const std::string &service_name = context_->service_context()->service_name();
  // Remove http/s header and trailing '/' for audiences.
  std::set<std::string> aud;
  for (auto &it : user_info_.audiences) {
    aud.insert(utils::GetUrlContent(it));
  }
  if (aud.find(service_name) == aud.end() &&
      !context_->method()->isAudienceAllowed(issuer, aud)) {
    Unauthorized("Audience not allowed");
    return;
  }
  if (cache_hit) {
    PassUserInfoOnSuccess();
  } else {
    InitKey();
  }
}
