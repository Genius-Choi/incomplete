void UpstreamRequest::onPoolFailure(ConnectionPool::PoolFailureReason reason,
                                    absl::string_view transport_failure_reason,
                                    Upstream::HostDescriptionConstSharedPtr host) {
  recordConnectionPoolCallbackLatency();
  Http::StreamResetReason reset_reason = [](ConnectionPool::PoolFailureReason reason) {
    switch (reason) {
    case ConnectionPool::PoolFailureReason::Overflow:
      return Http::StreamResetReason::Overflow;
    case ConnectionPool::PoolFailureReason::RemoteConnectionFailure:
      return Http::StreamResetReason::RemoteConnectionFailure;
    case ConnectionPool::PoolFailureReason::LocalConnectionFailure:
      return Http::StreamResetReason::LocalConnectionFailure;
    case ConnectionPool::PoolFailureReason::Timeout:
      return Http::StreamResetReason::ConnectionTimeout;
    }
    PANIC_DUE_TO_CORRUPT_ENUM;
  }(reason);

  stream_info_.upstreamInfo()->setUpstreamTransportFailureReason(transport_failure_reason);

  // Mimic an upstream reset.
  onUpstreamHostSelected(host, false);
  onResetStream(reset_reason, transport_failure_reason);
}
