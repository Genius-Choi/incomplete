static int legendre(BIGNUM *a, BIGNUM *p, BN_CTX *bnctx)
{
	int		symbol;
	unsigned int	mask;
	BIGNUM		*res, *pm1over2;

	pm1over2 = consttime_BN();
	res = consttime_BN();

	if (!BN_sub(pm1over2, p, BN_value_one()) ||
	    !BN_rshift1(pm1over2, pm1over2) ||
	    !BN_mod_exp_mont_consttime(res, a, pm1over2, p, bnctx, NULL)) {
		BN_free(pm1over2);
		BN_free(res);
		return -2;
	}

	symbol = -1;
	mask = const_time_eq(BN_is_word(res, 1), 1);
	symbol = const_time_select_int(mask, 1, symbol);
	mask = const_time_eq(BN_is_zero(res), 1);
	symbol = const_time_select_int(mask, -1, symbol);

	BN_free(pm1over2);
	BN_free(res);

	return symbol;
}
