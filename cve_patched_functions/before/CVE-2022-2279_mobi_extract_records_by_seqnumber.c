MOBIPdbRecord * mobi_extract_records_by_seqnumber(MOBIData *m, const size_t num, size_t *count) {
    if (m == NULL) {
        debug_print("%s", "Mobi structure not initialized\n");
        return NULL;
    }

    MOBIPdbRecord *root = NULL;
    MOBIPdbRecord *prev = NULL;
    MOBIPdbRecord *curr = NULL;
    if (num > 0) {
        root = mobi_get_record_by_seqnumber(m, num - 1);
        if (root) {
            curr = root->next;
        }
    } else {
        curr = m->rec;
    }
        
    MOBIPdbRecord *extracted = curr;

    size_t i = 0;
    while (curr != NULL && i < *count) {
        i++;
        prev = curr;
        curr = curr->next;
    }
    
    if (prev == NULL) {
        return NULL;
    }
    
    if (root == NULL) {
        m->rec = prev->next;
    } else {
        root->next = prev->next;
    }
    prev->next = NULL;
    
    *count = i;
    if (m->ph->rec_count >= i) {
        m->ph->rec_count -= i;
    } else {
        debug_print("%s\n", "Real record count differs from header value");
        m->ph->rec_count = 0;
    }

    debug_print("Extracted %zu records starting with index = %zu\n", *count, num);

    return extracted;
}
