static inline uint8_t encodeSample(adpcmState &state, int16_t sample)
{
	int step = stepTable[state.index];
	int diff = sample - state.previousValue;
	int vpdiff = step >> 3;
	uint8_t code = 0;
	if (diff < 0)
	{
		code = 8;
		diff = -diff;
	}
	if (diff >= step)
	{
		code |= 4;
		diff -= step;
		vpdiff += step;
	}
	step >>= 1;
	if (diff >= step)
	{
		code |= 2;
		diff -= step;
		vpdiff += step;
	}
	step >>= 1;
	if (diff >= step)
	{
		code |= 1;
		vpdiff += step;
	}

	if (code & 8)
		vpdiff = -vpdiff;
	state.previousValue = clamp(state.previousValue + vpdiff,
		MIN_INT16, MAX_INT16);

	state.index = clamp(state.index + indexTable[code], 0, 88);
	return code & 0xf;
}
