BOOL WINAPI DllMain(HINSTANCE hinstDLL, DWORD fdwReason, LPVOID lpvReserved)
{
  if (fdwReason != DLL_PROCESS_ATTACH)
    return 1;

  serv_ver= (const char *) GetProcAddress(0, "server_version");
#else
void __attribute__ ((constructor)) audit_plugin_so_init(void)
{
  serv_ver= server_version;
#endif /*_WIN32*/

  if (!serv_ver)
    goto exit;

  started_mariadb= strstr(serv_ver, "MariaDB") != 0;
  debug_server_started= strstr(serv_ver, "debug") != 0;

  if (started_mariadb)
  {
    if (serv_ver[0] == '1')
      use_event_data_for_disconnect= 1;
    else
      maria_55_started= 1;
  }
  else
  {
    /* Started MySQL. */
    if (serv_ver[0] == '5' && serv_ver[2] == '5')
    {
      int sc= serv_ver[4] - '0';
      if (serv_ver[5] >= '0' && serv_ver[5] <= '9')
        sc= sc * 10 + serv_ver[5] - '0';
      if (sc <= 10)
      {
        mysql_descriptor.interface_version= 0x0200;
        mysql_descriptor.event_notify= (void *) auditing_v8;
      }
      else if (sc < 14)
      {
        mysql_descriptor.interface_version= 0x0200;
        mysql_descriptor.event_notify= (void *) auditing_v13;
      }
    }
    else if (serv_ver[0] == '5' && serv_ver[2] == '6')
    {
      int sc= serv_ver[4] - '0';
      if (serv_ver[5] >= '0' && serv_ver[5] <= '9')
        sc= sc * 10 + serv_ver[5] - '0';
      if (sc >= 24)
        use_event_data_for_disconnect= 1;
    }
    else if ((serv_ver[0] == '5' && serv_ver[2] == '7') ||
             (serv_ver[0] == '8' && serv_ver[2] == '0'))
    {
      mysql_57_started= 1;
      _mysql_plugin_declarations_[0].info= mysql_v4_descriptor;
      use_event_data_for_disconnect= 1;
    }
    MYSQL_SYSVAR_NAME(loc_info).flags= PLUGIN_VAR_STR | PLUGIN_VAR_THDLOCAL |
      PLUGIN_VAR_READONLY | PLUGIN_VAR_MEMALLOC;
  }

  memset(locinfo_ini_value, 'O', sizeof(locinfo_ini_value)-1);
  locinfo_ini_value[sizeof(locinfo_ini_value)-1]= 0;

exit:
#ifdef _WIN32
  return 1;
#else
  return;
#endif
}
