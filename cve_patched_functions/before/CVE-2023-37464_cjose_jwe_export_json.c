char *cjose_jwe_export_json(cjose_jwe_t *jwe, cjose_err *err)
{

    if (!_cjose_convert_to_base64(jwe, err))
    {
        return NULL;
    }

    json_t *form = json_object();
    if (NULL == form)
    {
        CJOSE_ERROR(err, CJOSE_ERR_NO_MEMORY);
        return NULL;
    }

    if (!_cjose_add_json_part(form, "protected", &jwe->enc_header, err) || !_cjose_add_json_part(form, "iv", &jwe->enc_iv, err)
        || !_cjose_add_json_part(form, "ciphertext", &jwe->enc_ct, err)
        || !_cjose_add_json_part(form, "tag", &jwe->enc_auth_tag, err))
    {
        json_delete(form);
        return NULL;
    }

    json_object_set(form, "unprotected", jwe->shared_hdr);

    if (jwe->to_count == 1)
    {
        json_object_set(form, "header", jwe->to[0].unprotected);
        if (!_cjose_add_json_part(form, "encrypted_key", &jwe->to[0].enc_key, err))
        {
            json_delete(form);
            return NULL;
        }
    }
    else
    {

        json_t *recipients = json_array();
        if (NULL == recipients)
        {
            CJOSE_ERROR(err, CJOSE_ERR_NO_MEMORY);
            json_delete(form);
            return NULL;
        }

        json_object_set_new(form, "recipients", recipients);

        for (int i = 0; i < jwe->to_count; i++)
        {

            json_t *recipient = json_object();
            if (NULL == recipient)
            {
                CJOSE_ERROR(err, CJOSE_ERR_NO_MEMORY);
                json_delete(form);
                return NULL;
            }

            json_array_append_new(recipients, recipient);

            json_object_set(recipient, "header", jwe->to[i].unprotected);
            if (!_cjose_add_json_part(recipient, "encrypted_key", &jwe->to[i].enc_key, err))
            {
                json_delete(form);
                return NULL;
            }
        }
    }

    char *json_str = json_dumps(form, JSON_PRESERVE_ORDER);
    if (NULL == json_str)
    {
        CJOSE_ERROR(err, CJOSE_ERR_NO_MEMORY);
        json_delete(form);
        return NULL;
    }

    json_delete(form);
    return json_str;
}
