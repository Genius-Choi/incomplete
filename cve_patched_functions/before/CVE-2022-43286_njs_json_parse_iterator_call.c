njs_json_parse_iterator_call(njs_vm_t *vm, njs_json_parse_t *parse,
    njs_json_state_t *state)
{
    njs_int_t          ret;
    njs_value_t        arguments[3], *value;
    njs_object_prop_t  *prop;

    prop = state->prop;

    arguments[0] = state->value;
    arguments[1] = state->keys->start[state->index++];

    switch (prop->type) {
    case NJS_PROPERTY:
        arguments[2] = prop->value;

        ret = njs_function_apply(vm, parse->function, arguments, 3,
                                 &parse->retval);
        if (njs_slow_path(ret != NJS_OK)) {
            return ret;
        }

        if (njs_is_undefined(&parse->retval)) {
            prop->type = NJS_WHITEOUT;

        } else {
            prop->value = parse->retval;
        }

        break;

    case NJS_PROPERTY_REF:
        value = prop->value.data.u.value;
        arguments[2] = *value;

        ret = njs_function_apply(vm, parse->function, arguments, 3,
                                 &parse->retval);
        if (njs_slow_path(ret != NJS_OK)) {
            return ret;
        }

        if (njs_is_undefined(&parse->retval)) {
            ret = njs_value_property_i64_delete(vm, &state->value,
                                                state->index - 1, NULL);

        } else {
            ret = njs_value_property_i64_set(vm, &state->value,
                                             state->index - 1, &parse->retval);
        }

        if (njs_slow_path(ret == NJS_ERROR)) {
            return NJS_ERROR;
        }

        break;

    default:
        njs_internal_error(vm, "njs_json_parse_iterator_call() unexpected "
                         "property type:%s", njs_prop_type_string(prop->type));
    }

    return NJS_OK;
}
