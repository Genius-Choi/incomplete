static void bug31418_impl()
{
  MYSQL con;

  my_bool is_null;
  int rc= 0;

  /* Create a new connection. */

  DIE_UNLESS(mysql_client_init(&con));

  DIE_UNLESS(mysql_real_connect(&con,
                                opt_host,
                                opt_user,
                                opt_password,
                                opt_db ? opt_db : "test",
                                opt_port,
                                opt_unix_socket,
                                CLIENT_FOUND_ROWS));

  /***********************************************************************
    Check that lock is free:
      - IS_FREE_LOCK() should return 1;
      - IS_USED_LOCK() should return NULL;
  ***********************************************************************/

  is_null= query_int_variable(&con,
                              "IS_FREE_LOCK('bug31418')",
                              &rc);
  DIE_UNLESS(!is_null && rc);

  is_null= query_int_variable(&con,
                              "IS_USED_LOCK('bug31418')",
                              &rc);
  DIE_UNLESS(is_null);

  /***********************************************************************
    Acquire lock and check the lock status (the lock must be in use):
      - IS_FREE_LOCK() should return 0;
      - IS_USED_LOCK() should return non-zero thread id;
  ***********************************************************************/

  query_int_variable(&con, "GET_LOCK('bug31418', 1)", &rc);
  DIE_UNLESS(rc);

  is_null= query_int_variable(&con,
                              "IS_FREE_LOCK('bug31418')",
                              &rc);
  DIE_UNLESS(!is_null && !rc);

  is_null= query_int_variable(&con,
                              "IS_USED_LOCK('bug31418')",
                              &rc);
  DIE_UNLESS(!is_null && rc);

  /***********************************************************************
    Issue COM_CHANGE_USER command and check the lock status
    (the lock must be free):
      - IS_FREE_LOCK() should return 1;
      - IS_USED_LOCK() should return NULL;
  **********************************************************************/

  bug20023_change_user(&con);

  is_null= query_int_variable(&con,
                              "IS_FREE_LOCK('bug31418')",
                              &rc);
  DIE_UNLESS(!is_null && rc);

  is_null= query_int_variable(&con,
                              "IS_USED_LOCK('bug31418')",
                              &rc);
  DIE_UNLESS(is_null);

  /***********************************************************************
   That's it. Cleanup.
  ***********************************************************************/

  mysql_close(&con);
}
