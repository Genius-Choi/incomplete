static Jsi_RC SysPutsCmd_(Jsi_Interp *interp, Jsi_Value *args, Jsi_Value *_this, Jsi_Value **ret,
    Jsi_Func *funcPtr, bool stdErr, jsi_LogOptions *popts, const char *argStr, bool conLog)
{
    int i, cnt = 0, quote = (popts->file);
    const char *fn = NULL;
    Jsi_DString dStr, oStr;
    if (interp->noStderr)
        stdErr = 0;
    Jsi_Chan *chan = (stdErr ? jsi_Stderr : jsi_Stdout);
    Jsi_DSInit(&dStr);
    Jsi_DSInit(&oStr);
    if (popts->chan && !stdErr) {
        Jsi_UserObj *uobj = popts->chan->d.obj->d.uobj;
        jsi_UserObjToName(interp, uobj, &dStr);
        Jsi_Channel nchan = Jsi_FSNameToChannel(interp, Jsi_DSValue(&dStr));
        if (nchan)
            chan = nchan;
        Jsi_DSSetLength(&dStr, 0);
    }
    if (interp->curIp)
        jsi_SysPutsCmdPrefix(interp, popts, &dStr, &quote, &fn);
    if (!args)
        Jsi_DSAppend(&dStr, argStr?argStr:"", NULL);
    else {
        int argc = Jsi_ValueGetLength(interp, args);
        if (conLog && argc>0 && (argStr=Jsi_ValueString(interp, Jsi_ValueArrayIndex(interp, args, 0), NULL))) {
            if ((!interp->logOpts.Error && jsi_PrefixMatch(argStr, "ERROR: ")) 
                || (!interp->logOpts.Warn && jsi_PrefixMatch(argStr, "WARN: ")) 
                || (!interp->logOpts.Info && jsi_PrefixMatch(argStr, "INFO: ")))
                goto done;
        }
 
        for (i = 0; i < argc; ++i) {
            Jsi_Value *v = Jsi_ValueArrayIndex(interp, args, i);
            if (!v) continue;
            int len = 0;
            if (cnt++)
                Jsi_DSAppendLen(&dStr, " ", 1);
            const char *cp = Jsi_ValueString(interp, v, &len);
            if (cp) {
                Jsi_DSAppendLen(&dStr, cp, len);
                continue;
            }
            Jsi_DSSetLength(&oStr, 0);
            Jsi_ValueGetDString(interp, v, &oStr, 1);
            Jsi_DSAppend(&dStr, Jsi_DSValue(&oStr), NULL);
        }
    }
    if (quote)
        Jsi_DSAppendLen(&dStr, "\"", 1);
    if (popts->file && !popts->before) {
        Jsi_DSPrintf(&dStr, ", %s:%d", fn?fn:"", interp->curIp->Line);
    }
    if (popts->func) {
        // Note: could have looked this up on the stackFrame.
        if (!interp->prevActiveFunc || !((fn=interp->prevActiveFunc->name)))
            fn = "";
        Jsi_DSPrintf(&dStr, ", %s%s", fn[0]?fn:"", fn[0]?"()":"");
    }
    Jsi_DSAppend(&dStr, "\n", NULL);
    Jsi_Puts(interp, chan, Jsi_DSValue(&dStr), Jsi_DSLength(&dStr));
done:
    Jsi_DSFree(&dStr);
    Jsi_DSFree(&oStr);
    return JSI_OK;
}
