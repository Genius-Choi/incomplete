int main(int argc, const char* argv[])
{
    oe_result_t result;
    oe_enclave_t* enclave = NULL;

    if (argc != 2)
    {
        fprintf(stderr, "Usage: %s ENCLAVE\n", argv[0]);
        exit(1);
    }

    const uint32_t flags = oe_get_create_flags();

    result = oe_create_abi_enclave(
        argv[1], OE_ENCLAVE_TYPE_SGX, flags, NULL, 0, &enclave);
    if (result != OE_OK)
    {
        oe_put_err("oe_create_abi_enclave(): result=%u", result);
    }

    // oe_is_avx_enabled has already been setup by the host runtime.
    // Pass it along to the enclave.
    OE_TEST(enclave_set_oe_is_avx_enabled(enclave, oe_is_avx_enabled) == OE_OK);

    result = test_abi_roundtrip(enclave);
    OE_TEST(result == OE_OK || result == OE_UNSUPPORTED);

    test_mmx_abi_poison(enclave);
    test_fpu_stack_overflow(enclave);

    if ((result = oe_terminate_enclave(enclave)) != OE_OK)
    {
        oe_put_err("oe_terminate_enclave(): result=%u", result);
    }

    printf("=== passed all tests (%s)\n", argv[0]);

    return 0;
}
