static void logger(mailimap * imap, int log_type, const char * buffer, size_t size, void * context)
{
    IMAPSession * session = (IMAPSession *) context;
    session->lockConnectionLogger();

    if (session->connectionLoggerNoLock() == NULL) {
        session->unlockConnectionLogger();
        return;
    }
    
    ConnectionLogType type = getConnectionType(log_type);
    if ((int) type == -1) {
        session->unlockConnectionLogger();
        return;
    }
    
    bool isBuffer = isBufferFromLogType(log_type);

    if (isBuffer) {
        AutoreleasePool * pool = new AutoreleasePool();
        Data * data = Data::dataWithBytes(buffer, (unsigned int) size);
        session->connectionLoggerNoLock()->log(session, type, data);
        pool->release();
    }
    else {
        session->connectionLoggerNoLock()->log(session, type, NULL);
    }
    session->unlockConnectionLogger();
}
