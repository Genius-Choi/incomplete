void StelScriptMgr::stopScript()
{
	// Hack abusing stopScript for two different stops: it
	// will be called again after exit from the timer loop
	// which we kill here if it is running.
	if( waitEventLoop->isRunning() )
	{
		waitEventLoop->exit( 1 );
		return;
	}
	
#ifdef ENABLE_SCRIPT_QML
	if (!mutex.tryLock())
	{
		engine->setInterrupted(true);
		GETSTELMODULE(LabelMgr)->deleteAllLabels();
		GETSTELMODULE(MarkerMgr)->deleteAllMarkers();
		GETSTELMODULE(ScreenImageMgr)->deleteAllImages();
		QString msg = QString("INFO: asking running script to exit");
		emit scriptDebug(msg);
		//qDebug() << msg;
	}
	else
		mutex.unlock(); // all was OK, no script was running.
#else
	if (engine->isEvaluating())
	{
		GETSTELMODULE(LabelMgr)->deleteAllLabels();
		GETSTELMODULE(MarkerMgr)->deleteAllMarkers();
		GETSTELMODULE(ScreenImageMgr)->deleteAllImages();
		if (agent->getPauseScript()) {
			agent->setPauseScript(false);
		}
		QString msg = QString("INFO: asking running script to exit");
		emit scriptDebug(msg);
		//qDebug() << msg;
		engine->abortEvaluation();
	}
	// "Script finished..." is emitted after return from engine->evaluate().
#endif
}
