static int _consolefs_dup(oe_fd_t* file_, oe_fd_t** new_file_out)
{
    int ret = -1;
    file_t* file = _cast_file(file_);
    file_t* new_file = NULL;

    if (new_file_out)
        *new_file_out = NULL;

    if (!file || !new_file_out)
        OE_RAISE_ERRNO(OE_EINVAL);

    /* Allocate and initialize a new file structure. */
    {
        if (!(new_file = oe_calloc(1, sizeof(file_t))))
            OE_RAISE_ERRNO(OE_ENOMEM);

        new_file->base.type = OE_FD_TYPE_FILE;
        new_file->base.ops.file = _get_ops();
        new_file->magic = MAGIC;
    }

    /* Ask the host to perform this operation. */
    {
        oe_host_fd_t retval = -1;

        if (oe_syscall_dup_ocall(&retval, file->host_fd) != OE_OK)
            OE_RAISE_ERRNO(OE_EINVAL);

        if (retval == -1)
            OE_RAISE_ERRNO(oe_errno);

        new_file->host_fd = retval;
    }

    *new_file_out = (oe_fd_t*)new_file;

    ret = 0;
    new_file = NULL;

done:

    if (new_file)
        oe_free(new_file);

    return ret;
}
