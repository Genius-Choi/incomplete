output_binhex(FILE *rf, int32_t rf_len, const char *filename, FILE *f)
{
  int crc, len = strlen(filename);
  char buf[2048];

  if (len < 1 || len > 63)
    fatal_error("filename length must be between 1 and 63");
  store_one(len, buf+0);	/* filename length */
  memcpy(buf+1, filename, len);	/* filename */
  store_one(0, buf+1+len);	/* version */
  store_four(T1_FILETYPE, buf+2+len); /* file type */
  store_four(T1_FILECREATOR, buf+6+len); /* file creator */
  store_one(T1_FINDERFLAGS, buf+10+len); /* finder flags */
  store_one(0, buf+11+len);	/* extended finder flags */
  store_four(0, buf+12+len);	/* length of data fork */
  store_four(rf_len, buf+16+len); /* length of resource fork */
  store_two(crcbuf(0, 20+len, buf), buf+20+len); /* CRC */
  store_two(0, buf+22+len);	/* data fork CRC */

  /* output BinHex comment */
  fputs("(This file must be converted with BinHex 4.0)\n:", f);

  /* BinHex the header */
  binhex_buffer((const byte *)buf, 24+len, f);

  /* resource fork data */
  reposition(rf, 0);
  crc = 0;
  while (rf_len > 0) {
    int n = (rf_len < 2048 ? rf_len : 2048);
    fread(buf, 1, n, rf);
    crc = crcbuf(crc, n, buf);	/* update CRC */
    binhex_buffer((const byte *)buf, n, f);
    rf_len -= n;
  }
  store_two(crc, buf);		/* resource fork CRC */
  binhex_buffer((const byte *)buf, 2, f);
  binhex_buffer(0, 0, f);	/* get rid of any remaining bits */
  fputs(":\n", f);		/* trailer */
}
