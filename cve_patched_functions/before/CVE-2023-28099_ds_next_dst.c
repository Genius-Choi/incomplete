int ds_next_dst(struct sip_msg *msg, int mode, ds_partition_t *partition)
{
	struct socket_info *sock;
	struct usr_avp *avp;
	struct usr_avp *tmp_avp;
	struct usr_avp *attr_avp;
	int_str avp_value;
	int_str sock_avp_value;

	tmp_avp = search_first_avp(partition->dst_avp_type,
		partition->dst_avp_name, NULL, 0);
	if(tmp_avp==NULL)
		return -1; /* used avp deleted -- strange */

	/* get AVP with next destination URI */
	avp = search_next_avp(tmp_avp, &avp_value);
	destroy_avp(tmp_avp);

	/* remove old attribute AVP (from prev destination) */
	if (partition->attrs_avp_name >= 0) {
		attr_avp = search_first_avp(partition->attrs_avp_type,
				partition->attrs_avp_name, NULL, 0);
		if (attr_avp)
			destroy_avp(attr_avp);
	}
	if (partition->script_attrs_avp_name >= 0) {
		attr_avp = search_first_avp(partition->script_attrs_avp_type,
				partition->script_attrs_avp_name, NULL, 0);
		if (attr_avp)
			destroy_avp(attr_avp);
	}

	if(avp==NULL || !(avp->flags&AVP_VAL_STR))
		return -1; /* no more avps or value is int */

	/* get AVP with next destination socket */
	tmp_avp = search_first_avp(partition->sock_avp_type,
		partition->sock_avp_name, &sock_avp_value, 0);
	if (!tmp_avp) {
		/* this shuold not happen, it is a bogus state */
		sock = NULL;
	} else {
		if (sscanf( sock_avp_value.s.s, "%p", (void**)&sock ) != 1)
			sock = NULL;
		destroy_avp(tmp_avp);
	}

	LM_DBG("using [%.*s]\n", avp_value.s.len, avp_value.s.s);
	if( ds_update_dst(msg, &avp_value.s, sock, mode) != 0)
	{
		LM_ERR("cannot set dst addr\n");
		return -1;
	}

	return 1;
}
