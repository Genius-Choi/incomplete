pf_state_key_link_reverse(struct pf_state_key *sk, struct pf_state_key *skrev)
{
	struct pf_state_key *old_reverse;

	old_reverse = atomic_cas_ptr(&sk->sk_reverse, NULL, skrev);
	if (old_reverse != NULL)
		KASSERT(old_reverse == skrev);
	else {
		pf_state_key_ref(skrev);

		/*
		 * NOTE: if sk == skrev, then KASSERT() below holds true, we
		 * still want to grab a reference in such case, because
		 * pf_state_key_unlink_reverse() does not check whether keys
		 * are identical or not.
		 */
		old_reverse = atomic_cas_ptr(&skrev->sk_reverse, NULL, sk);
		if (old_reverse != NULL)
			KASSERT(old_reverse == sk);

		pf_state_key_ref(sk);
	}
}
