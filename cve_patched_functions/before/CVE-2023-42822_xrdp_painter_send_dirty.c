xrdp_painter_send_dirty(struct xrdp_painter *self)
{
    int cx;
    int cy;
    int bpp;
    int Bpp;
    int index;
    int jndex;
    int error;
    char *ldata;
    char *src;
    char *dst;
    struct xrdp_rect rect;

    LOG_DEVEL(LOG_LEVEL_DEBUG, "xrdp_painter_send_dirty:");

    bpp = self->wm->screen->bpp;
    Bpp = (bpp + 7) / 8;
    if (Bpp == 3)
    {
        Bpp = 4;
    }

    jndex = 0;
    error = xrdp_region_get_rect(self->dirty_region, jndex, &rect);
    while (error == 0)
    {
        cx = rect.right - rect.left;
        cy = rect.bottom - rect.top;
        ldata = (char *)g_malloc(cx * cy * Bpp, 0);
        if (ldata == 0)
        {
            return 1;
        }
        src = self->wm->screen->data;
        src += self->wm->screen->line_size * rect.top;
        src += rect.left * Bpp;
        dst = ldata;
        for (index = 0; index < cy; index++)
        {
            g_memcpy(dst, src, cx * Bpp);
            src += self->wm->screen->line_size;
            dst += cx * Bpp;
        }
        LOG_DEVEL(LOG_LEVEL_DEBUG, "xrdp_painter_send_dirty: x %d y %d cx %d cy %d",
                  rect.left, rect.top, cx, cy);
        libxrdp_send_bitmap(self->session, cx, cy, bpp,
                            ldata, rect.left, rect.top, cx, cy);
        g_free(ldata);

        jndex++;
        error = xrdp_region_get_rect(self->dirty_region, jndex, &rect);
    }

    xrdp_region_delete(self->dirty_region);
    self->dirty_region = xrdp_region_create(self->wm);

    return 0;
}
