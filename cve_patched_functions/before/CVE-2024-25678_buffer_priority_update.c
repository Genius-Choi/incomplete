buffer_priority_update (struct ietf_full_conn *conn,
        lsquic_stream_id_t stream_id, const struct lsquic_ext_http_prio *ehp)
{
    struct buffered_priority_update *bpu;
    struct lsquic_hash_elem *el;

    if (!conn->ifc_bpus)
    {
        conn->ifc_bpus = lsquic_hash_create();
        if (!conn->ifc_bpus)
        {
            ABORT_ERROR("cannot allocate BPUs hash");
            return -1;
        }
        goto insert_new;
    }

    el = lsquic_hash_find(conn->ifc_bpus, &stream_id, sizeof(stream_id));
    if (el)
    {
        bpu = lsquic_hashelem_getdata(el);
        bpu->ehp = *ehp;
        return 0;
    }

  insert_new:
    bpu = malloc(sizeof(*bpu));
    if (!bpu)
    {
        ABORT_ERROR("cannot allocate BPU");
        return -1;
    }

    bpu->hash_el.qhe_flags = 0;
    bpu->stream_id = stream_id;
    bpu->ehp = *ehp;
    if (!lsquic_hash_insert(conn->ifc_bpus, &bpu->stream_id,
                                sizeof(bpu->stream_id), bpu, &bpu->hash_el))
    {
        free(bpu);
        ABORT_ERROR("cannot insert BPU");
        return -1;
    }

    return 0;
}
