uint64_t Message_Hash(const upb_Message* msg, const upb_MessageDef* m,
                      uint64_t seed) {
  upb_Arena* arena = upb_Arena_New();
  const char* data;
  size_t size;

  // Hash a deterministically serialized payloads with no unknown fields.
  data = upb_Encode(msg, upb_MessageDef_MiniTable(m),
                    kUpb_Encode_SkipUnknown | kUpb_Encode_Deterministic, arena,
                    &size);

  if (data) {
    uint64_t ret = _upb_Hash(data, size, seed);
    upb_Arena_Free(arena);
    return ret;
  } else {
    upb_Arena_Free(arena);
    rb_raise(cParseError, "Error calculating hash");
  }
}
