MOBI_RET mobi_add_exthrecord(MOBIData *m, const MOBIExthTag tag, const uint32_t size, const void *value) {
    if (size == 0) {
        debug_print("%s\n", "Record size is zero");
        return MOBI_PARAM_ERR;
    }
    size_t count = 2;
    while (m && count--) {
        if (m->mh == NULL) {
            debug_print("%s\n", "Mobi header must be initialized");
            return MOBI_INIT_FAILED;
        }
        MOBIExthMeta meta = mobi_get_exthtagmeta_by_tag(tag);
        MOBIExthHeader *record = calloc(1, sizeof(MOBIExthHeader));
        if (record == NULL) {
            debug_print("%s\n", "Memory allocation for EXTH record failed");
            return MOBI_MALLOC_FAILED;
        }
        record->tag = tag;
        record->size = size;
        record->data = malloc(size);
        if (record->data == NULL) {
            debug_print("%s\n", "Memory allocation for EXTH data failed");
            free(record);
            return MOBI_MALLOC_FAILED;
        }
        if (meta.type == EXTH_STRING && mobi_is_cp1252(m)) {
            debug_print("%s\n", "Adding CP1252 string data");
            char *data = malloc(size + 1);
            if (data == NULL) {
                free(record->data);
                free(record);
                return MOBI_MALLOC_FAILED;
            }
            size_t data_size = size + 1;
            MOBI_RET ret = mobi_utf8_to_cp1252(data, value, &data_size, size);
            if (ret != MOBI_SUCCESS) {
                free(record->data);
                free(record);
                free(data);
                return ret;
            }
            memcpy(record->data, data, data_size);
            record->size = (uint32_t) data_size;
            free(data);
        } else if (meta.name && meta.type == EXTH_NUMERIC && size == sizeof(uint32_t)) {
            debug_print("%s\n", "Adding numeric data");
            MOBIBuffer *buf = mobi_buffer_init_null(record->data, size);
            if (buf == NULL) {
                free(record->data);
                free(record);
                return MOBI_MALLOC_FAILED;
            }
            mobi_buffer_add32(buf, *(uint32_t *) value);
            mobi_buffer_free_null(buf);
        } else {
            debug_print("%s\n", "Adding raw data");
            memcpy(record->data, value, size);
        }
        debug_print("Added record %u (%u bytes)\n", meta.tag, size);

        record->next = NULL;
        if (m->eh == NULL) {
            if (m->mh->exth_flags == NULL) {
                m->mh->exth_flags = malloc(sizeof(uint32_t));
                if (m->mh->exth_flags == NULL) {
                    debug_print("%s\n", "Memory allocation failed");
                    free(record->data);
                    free(record);
                    return MOBI_MALLOC_FAILED;
                }
            }
            *m->mh->exth_flags = 0x40;
            m->eh = record;
        } else {
            MOBIExthHeader *curr = m->eh;
            while(curr->next) {
                curr = curr->next;
            }
            curr->next = record;
        }
        m = m->next;
    }
    return MOBI_SUCCESS;
}
