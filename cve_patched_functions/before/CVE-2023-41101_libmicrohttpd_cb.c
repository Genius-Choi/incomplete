enum MHD_Result libmicrohttpd_cb(
	void *cls,
	struct MHD_Connection *connection,
	const char *url,
	const char *method,
	const char *version,
	const char *upload_data,
	size_t *upload_data_size,
	void **ptr) {

	t_client *client;
	char ip[INET6_ADDRSTRLEN+1];
	char mac[18];
	const char *dds = "../";
	const char *mhdstatus = "/mhdstatus";
	int rc = 0;
	char *msg;
	char *testcmd;
	s_config *config;

	config = config_get_config();

	debug(LOG_DEBUG, "client access: %s %s", method, url);

	// only allow get
	if (0 != strcmp(method, "GET")) {
		debug(LOG_DEBUG, "Unsupported http method %s, Network Authentication required (Error 511)", method);
		return send_error(connection, 511);
	}

	// block path traversal
	if (strstr(url, dds) != NULL) {
		debug(LOG_WARNING, "Probable Path Traversal Attack Detected - %s", url);
		return send_error(connection, 403);
	}

	// check for mhdstatus request
	if (strstr(url, mhdstatus) != NULL) {
		debug(LOG_DEBUG, "MHD Status Request - %s", url);
		return send_error(connection, 200);
	}


	/* switch between preauth, authenticated
	 * - always - set caching headers
	 * a) possible implementation - redirect first and serve them using a tempo redirect
	 * b) serve direct
	 * should all requests redirected? even those to .css, .js, ... or respond with 404/503/...
	 */

	rc = get_client_ip(ip, connection);
	if (rc != 0) {
		return send_error(connection, 503);
	}


	// check if client ip is on our subnet
	testcmd = safe_calloc(SMALL_BUF);
	safe_asprintf(&testcmd, "/usr/lib/opennds/libopennds.sh get_interface_by_ip \"%s\"", ip);
	msg = safe_calloc(SMALL_BUF);
	rc = execute_ret_url_encoded(msg, SMALL_BUF, testcmd);
	free(testcmd);

	if (rc == 0) {
		debug(LOG_DEBUG, "Interface used to route ip [%s] is [%s]", ip, msg);
		debug(LOG_DEBUG, "Gateway Interface is [%s]", config->gw_interface);

		if (strcmp(config->gw_interface, msg) == 0) {
			debug(LOG_DEBUG, "Client ip address [%s] is on our subnet using interface [%s]", ip, msg);
		} else {
			debug(LOG_NOTICE, "Client ip address [%s] is  NOT on our subnet and is using interface [%s]", ip, msg);
			return send_error(connection, 403);
		}
	} else {
		debug(LOG_DEBUG, "ip subnet test failed: Continuing...");
	}

	free (msg);

	rc = get_client_mac(mac, ip);
	if (rc != 0) {
		return send_error(connection, 503);
	}

	client = client_list_find(mac, ip);
	if (!client) {
		client = add_client(mac, ip);
		if (!client) {
			return send_error(connection, 403);
		}
	}

	if (client && (client->fw_connection_state == FW_MARK_AUTHENTICATED ||
			client->fw_connection_state == FW_MARK_TRUSTED)) {
		// client is already authenticated, maybe they clicked/tapped "back" on the CPD browser or maybe they want the info page.
		return authenticated(connection, url, client);
	}

	return preauthenticated(connection, url, client);
}
