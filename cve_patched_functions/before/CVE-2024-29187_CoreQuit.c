extern "C" void CoreQuit(
    __in BOOTSTRAPPER_ENGINE_CONTEXT* pEngineContext,
    __in DWORD dwExitCode
    )
{
    HRESULT hr = S_OK;
    BURN_ENGINE_STATE* pEngineState = pEngineContext->pEngineState;

    // Save engine state if resume mode is unequal to "none".
    if (BURN_RESUME_MODE_NONE != pEngineState->resumeMode)
    {
        hr = CoreSaveEngineState(pEngineState);
        if (FAILED(hr))
        {
            LogErrorId(hr, MSG_STATE_NOT_SAVED);
            hr = S_OK;
        }
    }

    LogId(REPORT_STANDARD, MSG_QUIT, dwExitCode);

    pEngineState->userExperience.dwExitCode = dwExitCode;

    ::EnterCriticalSection(&pEngineContext->csQueue);

    pEngineState->fQuit = TRUE;

    ::LeaveCriticalSection(&pEngineContext->csQueue);
}
