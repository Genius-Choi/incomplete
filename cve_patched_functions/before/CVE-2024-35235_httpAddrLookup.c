httpAddrLookup(
    const http_addr_t *addr,		// I - Address to lookup
    char              *name,		// I - Host name buffer
    int               namelen)		// I - Size of name buffer
{
  int			error;		// Any error from getnameinfo
  _cups_globals_t	*cg = _cupsGlobals();
					// Global data


  DEBUG_printf("httpAddrLookup(addr=%p, name=%p, namelen=%d)", (void *)addr, (void *)name, namelen);

  // Range check input...
  if (!addr || !name || namelen <= 2)
  {
    if (name && namelen >= 1)
      *name = '\0';

    return (NULL);
  }

#ifdef AF_LOCAL
  if (addr->addr.sa_family == AF_LOCAL)
  {
    cupsCopyString(name, addr->un.sun_path, (size_t)namelen);
    return (name);
  }
#endif // AF_LOCAL

  // Optimize lookups for localhost/loopback addresses...
  if (httpAddrLocalhost(addr))
  {
    cupsCopyString(name, "localhost", (size_t)namelen);
    return (name);
  }

#ifdef HAVE_RES_INIT
  // STR #2920: Initialize resolver after failure in cups-polld
  //
  // If the previous lookup failed, re-initialize the resolver to prevent
  // temporary network errors from persisting.  This *should* be handled by
  // the resolver libraries, but apparently the glibc folks do not agree.
  //
  // We set a flag at the end of this function if we encounter an error that
  // requires reinitialization of the resolver functions.  We then call
  // res_init() if the flag is set on the next call here or in httpAddrLookup().
  if (cg->need_res_init)
  {
    res_init();

    cg->need_res_init = 0;
  }
#endif // HAVE_RES_INIT

  // STR #2486: httpAddrLookup() fails when getnameinfo() returns EAI_AGAIN
  //
  // FWIW, I think this is really a bug in the implementation of
  // getnameinfo(), but falling back on httpAddrString() is easy to do...
  if ((error = getnameinfo(&addr->addr, (socklen_t)httpAddrLength(addr), name, (socklen_t)namelen, NULL, 0, 0)) != 0)
  {
    if (error == EAI_FAIL)
      cg->need_res_init = 1;

    return (httpAddrGetString(addr, name, (size_t)namelen));
  }

  DEBUG_printf("1httpAddrLookup: returning \"%s\"...", name);

  return (name);
}
