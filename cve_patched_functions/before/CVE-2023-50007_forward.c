static int forward(AudioFWTDNContext *s,
                   const double *in, int in_length,
                   double **out, int *out_length, int ch, uint64_t sn)
{
    ChannelParams *cp = &s->cp[ch];
    int levels = s->levels;
    int skip = sn ? s->wavelet_length - 1 : 1;
    int leftext, ret;

    ret = reallocate_inputs(out, out_length, in_length, levels, ch, sn);
    if (ret < 0)
        return ret;
    ret = reallocate_outputs(s, cp->filter_coefs, cp->filter_length,
                             in_length, levels, ch, sn);
    if (ret < 0)
        return ret;

    leftext = left_ext(s->wavelet_length, levels, sn);

    if (cp->temp_in_max_length < in_length + cp->max_left_ext + skip) {
        av_freep(&cp->temp_in);
        cp->temp_in_max_length = in_length + cp->max_left_ext + skip;
        cp->temp_in = av_calloc(cp->temp_in_max_length, sizeof(*cp->temp_in));
        if (!cp->temp_in) {
            cp->temp_in_max_length = 0;
            return AVERROR(ENOMEM);
        }
    }

    memset(cp->temp_in, 0, cp->temp_in_max_length * sizeof(*cp->temp_in));
    cp->temp_in_length = in_length + leftext;

    if (leftext)
        memcpy(cp->temp_in, cp->prev + s->prev_length - leftext, leftext * sizeof(*cp->temp_in));
    memcpy(cp->temp_in + leftext, in, in_length * sizeof(*in));

    if (levels == 1) {
        conv_down(cp->temp_in, cp->temp_in_length, out[1], out[0], out_length[1],
                 s->lp, s->hp, s->wavelet_length, skip,
                 cp->buffer, cp->buffer_length);
    } else {
        int discard = discard_left_ext(s->wavelet_length, levels, 1, sn);
        int tempa_length_prev;

        if (cp->tempa_len_max < (in_length + cp->max_left_ext + s->wavelet_length - 1) / 2) {
            av_freep(&cp->tempa);
            av_freep(&cp->tempd);
            cp->tempa_len_max = (in_length + cp->max_left_ext + s->wavelet_length - 1) / 2;
            cp->tempa = av_calloc(cp->tempa_len_max, sizeof(*cp->tempa));
            cp->tempd = av_calloc(cp->tempa_len_max, sizeof(*cp->tempd));
            if (!cp->tempa || !cp->tempd) {
                cp->tempa_len_max = 0;
                return AVERROR(ENOMEM);
            }
        }

        memset(cp->tempa, 0, cp->tempa_len_max * sizeof(*cp->tempa));
        memset(cp->tempd, 0, cp->tempa_len_max * sizeof(*cp->tempd));

        cp->tempa_length = out_length[0] + discard;
        conv_down(cp->temp_in, cp->temp_in_length,
                 cp->tempa, cp->tempd, cp->tempa_length,
                 s->lp, s->hp, s->wavelet_length, skip,
                 cp->buffer, cp->buffer_length);
        memcpy(out[0], cp->tempd + discard, out_length[0] * sizeof(**out));
        tempa_length_prev = cp->tempa_length;

        for (int level = 1; level < levels - 1; level++) {
            if (out_length[level] == 0)
                return 0;
            discard = discard_left_ext(s->wavelet_length, levels, level + 1, sn);
            cp->tempa_length = out_length[level] + discard;
            conv_down(cp->tempa, tempa_length_prev,
                     cp->tempa, cp->tempd, cp->tempa_length,
                     s->lp, s->hp, s->wavelet_length, skip,
                     cp->buffer, cp->buffer_length);
            memcpy(out[level], cp->tempd + discard, out_length[level] * sizeof(**out));
            tempa_length_prev = cp->tempa_length;
        }

        if (out_length[levels] == 0)
            return 0;
        conv_down(cp->tempa, cp->tempa_length, out[levels], out[levels - 1], out_length[levels],
                 s->lp, s->hp, s->wavelet_length, skip,
                 cp->buffer, cp->buffer_length);
    }

    if (s->prev_length < in_length) {
        memcpy(cp->prev, in + in_length - cp->max_left_ext, cp->max_left_ext * sizeof(*cp->prev));
    } else {
        memmove(cp->prev, cp->prev + in_length, (s->prev_length - in_length) * sizeof(*cp->prev));
        memcpy(cp->prev + s->prev_length - in_length, in, in_length * sizeof(*cp->prev));
    }

    return 0;
}
