native_adapter_create(int bus, uint16_t client_addr[], int n_client)
{
	int fd;
	struct native_i2c_adapter *native_adapter;
	char native_path[20];
	int i;

	if (bus < 0)
		return NULL;

	native_adapter = calloc(1, sizeof(struct native_i2c_adapter));
	if (native_adapter == NULL) {
		WPRINTF("i2c_core: failed to calloc struct virtio_i2c_vdev");
		return NULL;
	}

	snprintf(native_path, sizeof(native_path), "/dev/i2c-%d", bus);
	native_path[sizeof(native_path) - 1] = '\0';

	fd = open(native_path, O_RDWR);
	if (fd < 0) {
		WPRINTF("virtio_i2c: failed to open %s\n", native_path);
		goto fail;
	}
	native_adapter->fd = fd;
	native_adapter->bus = bus;
	for (i = 0; i < n_client; i++) {
		if (client_addr[i]) {
			if (native_client_access_ok(native_adapter, client_addr[i])) {
				if (native_adapter->i2cdev_enable[client_addr[i]]) {
					WPRINTF("client addr 0x%x repeat, not allowed.\n", client_addr[i]);
					goto fail;
				}
				native_adapter->i2cdev_enable[client_addr[i]] = true;
				DPRINTF("virtio_i2c: add client 0x%x\n", client_addr[i]);
			} else {
				goto fail;
			}
		}
	}
	return native_adapter;

fail:
	free(native_adapter);
	return NULL;
}
