int trilogy_build_auth_switch_response_packet(trilogy_builder_t *builder, const char *pass, size_t pass_len,
                                              const char *auth_plugin, const char *scramble)
{
    int rc = TRILOGY_OK;
    unsigned int auth_response_len = 0;
    uint8_t auth_response[EVP_MAX_MD_SIZE];

    if (!strcmp("caching_sha2_password", auth_plugin)) {
        trilogy_pack_scramble_sha2_hash(scramble, pass, pass_len, auth_response, &auth_response_len);
    } else {
        trilogy_pack_scramble_native_hash(scramble, pass, pass_len, auth_response, &auth_response_len);
    }

    CHECKED(trilogy_builder_write_buffer(builder, auth_response, auth_response_len));
    trilogy_builder_finalize(builder);

    return TRILOGY_OK;
fail:
    return rc;
}
