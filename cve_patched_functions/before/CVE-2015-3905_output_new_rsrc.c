output_new_rsrc(const char *rtype, int rid, int attrs,
		const char *data, uint32_t len)
{
  Rsrc *r;
  if (nrsrc >= rsrc_cap) {
    rsrc_cap = (rsrc_cap ? rsrc_cap * 2 : 256);
    r = (Rsrc *)malloc(sizeof(Rsrc) * rsrc_cap);
    if (!r)
      fatal_error("out of memory");
    memcpy(r, rsrc, sizeof(Rsrc) * nrsrc);
    free(rsrc);
    rsrc = r;
  }
  r = &rsrc[nrsrc];
  nrsrc++;

  /* prepare resource record */
  {
    const unsigned char *b = (const unsigned char *)rtype;
    r->type = (b[0] << 24) | (b[1] << 16) | (b[2] << 8) | b[3];
  }
  r->id = rid;
  r->attrs = attrs;
  if (nrsrc == 1)
    r->data_offset = 0;
  else
    r->data_offset = rsrc[nrsrc-2].data_offset + rsrc[nrsrc-2].data_len + 4;
  r->data_len = len;
  r->next_in_type = r->next_type = -2;

  /* resource consists of length, then data */
  write_four(r->data_len, rfork_f);
  fwrite(data, 1, len, rfork_f);
}
