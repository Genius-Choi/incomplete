belle_sip_dialog_t *belle_sip_dialog_new(belle_sip_transaction_t *t){
	belle_sip_dialog_t *obj;
	belle_sip_header_from_t *from;
	const char *from_tag;
	belle_sip_header_to_t *to;
	const char *to_tag=NULL;
	belle_sip_header_call_id_t *call_id=belle_sip_message_get_header_by_type(t->request,belle_sip_header_call_id_t);
	belle_sip_dialog_type_t type;

	from=belle_sip_message_get_header_by_type(t->request,belle_sip_header_from_t);
	if (from==NULL){
		belle_sip_error("belle_sip_dialog_new(): no from!");
		return NULL;
	}
	from_tag=belle_sip_header_from_get_tag(from);
	if (from_tag==NULL){
		belle_sip_error("belle_sip_dialog_new(): no from tag!");
		return NULL;
	}

	to = belle_sip_message_get_header_by_type(t->request,belle_sip_header_to_t);
	if (to == NULL){
		belle_sip_error("belle_sip_dialog_new(): no to in request!");
		return NULL;
	}
	to_tag = belle_sip_header_to_get_tag(to);
	if (to_tag){
		belle_sip_error("belle_sip_dialog_new(): there is a to tag in the request. This is not allowed"
			" to create a dialog on such a transaction.");
		return NULL;
	}
	if (!call_id){
		belle_sip_error("No call-id in response.");
		return NULL;
	}

	if (t->last_response) {
		to=belle_sip_message_get_header_by_type(t->last_response,belle_sip_header_to_t);
		if (to==NULL){
			belle_sip_error("belle_sip_dialog_new(): no to!");
			return NULL;
		}
		to_tag = belle_sip_header_to_get_tag(to);
	}

	if (strcmp(belle_sip_request_get_method(t->request),"INVITE") == 0){
		type = BELLE_SIP_DIALOG_INVITE;
	}else if (strcmp(belle_sip_request_get_method(t->request),"SUBSCRIBE") == 0){
		type = BELLE_SIP_DIALOG_SUBSCRIBE_NOTIFY;
	}else{
		belle_sip_error("belle_sip_dialog_new(): unsupported request [%s] for creating a dialog.", belle_sip_request_get_method(t->request));
		return NULL;
	}

	if (type == BELLE_SIP_DIALOG_SUBSCRIBE_NOTIFY) {
		belle_sip_header_expires_t *expires = belle_sip_message_get_header_by_type(t->request,belle_sip_header_expires_t);
		if (expires && belle_sip_header_expires_get_expires(expires) < 1) {
			belle_sip_error("belle_sip_dialog_new(): cannot create SUBSCRIBE/NOTIFY dialog with expiration <1 for transaction [%p]",t);
			return NULL;
		}
	}
	obj=belle_sip_object_new(belle_sip_dialog_t);
	obj->terminate_on_bye=1;
	obj->provider=t->provider;
	obj->pending_trans_checking_enabled=1;
	obj->call_id=(belle_sip_header_call_id_t*)belle_sip_object_ref(call_id);
	obj->type=type;

	belle_sip_object_ref(t);
	obj->last_transaction=t;

	if (BELLE_SIP_OBJECT_IS_INSTANCE_OF(t,belle_sip_server_transaction_t)){
		obj->remote_tag=belle_sip_strdup(from_tag);
		obj->local_tag=belle_sip_strdup(BELLE_SIP_SERVER_TRANSACTION(t)->to_tag);
		obj->remote_party=(belle_sip_header_address_t*)belle_sip_object_ref(from);
		obj->is_server=TRUE;
		belle_sip_dialog_init_as_uas(obj,belle_sip_transaction_get_request(t));
	}else{
		const belle_sip_list_t *predefined_routes=NULL;
		obj->local_tag=belle_sip_strdup(from_tag);
		obj->remote_tag=to_tag?belle_sip_strdup(to_tag):NULL; /*might be null at dialog creation*/
		obj->local_party=(belle_sip_header_address_t*)belle_sip_object_ref(from);
		obj->is_server=FALSE;
		for(predefined_routes=belle_sip_message_get_headers((belle_sip_message_t*)t->request,BELLE_SIP_ROUTE);
			predefined_routes!=NULL;predefined_routes=predefined_routes->next){
			obj->route_set=belle_sip_list_append(obj->route_set,belle_sip_object_ref(predefined_routes->data));
		}
		belle_sip_dialog_init_as_uac(obj,belle_sip_transaction_get_request(t));
	}


	belle_sip_message("New %s dialog [%p] , local tag [%s], remote tag [%s]"
			,obj->is_server?"server":"client"
			,obj
			,obj->local_tag?obj->local_tag:""
			,obj->remote_tag?obj->remote_tag:"");
	set_state(obj,BELLE_SIP_DIALOG_NULL);
	return obj;
}
