MOBI_RET mobi_decode_audio_resource(unsigned char **decoded_resource, size_t *decoded_size, MOBIPart *part) {
    if (part->size < MEDIA_HEADER_LEN) {
        debug_print("Audio resource record too short (%zu)\n", part->size);
        return MOBI_DATA_CORRUPT;
    }
    MOBIBuffer *buf = mobi_buffer_init_null(part->data, part->size);
    if (buf == NULL) {
        debug_print("%s\n", "Memory allocation failed");
        return MOBI_MALLOC_FAILED;
    }
    char magic[5];
    mobi_buffer_getstring(magic, buf, 4);
    if (strncmp(magic, AUDI_MAGIC, 4) != 0) {
        debug_print("Wrong magic for audio resource: %s\n", magic);
        mobi_buffer_free_null(buf);
        return MOBI_DATA_CORRUPT;
    }
    uint32_t offset = mobi_buffer_get32(buf);
    mobi_buffer_setpos(buf, offset);
    *decoded_size = buf->maxlen - buf->offset;
    *decoded_resource = mobi_buffer_getpointer(buf, *decoded_size);
    mobi_buffer_free_null(buf);
    return MOBI_SUCCESS;
}
