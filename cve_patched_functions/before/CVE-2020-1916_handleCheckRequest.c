bool AdminRequestHandler::handleCheckRequest(const std::string &cmd,
                                             Transport *transport) {
  if (cmd == "check-load") {
    int count = HttpServer::Server->getPageServer()->getActiveWorker();
    transport->sendString(folly::to<std::string>(count));
    return true;
  }
  if (cmd == "check-ev") {
    int count =
      HttpServer::Server->getPageServer()->getLibEventConnectionCount();
    transport->sendString(folly::to<string>(count));
    return true;
  }
  if (cmd == "check-queued") {
    int count = HttpServer::Server->getPageServer()->getQueuedJobs();
    transport->sendString(folly::to<string>(count));
    return true;
  }
  if (cmd == "check-health") {
    std::stringstream out;
    bool first = true;
    out << "{" << endl;
    auto const appendStat = [&](folly::StringPiece name, int64_t value) {
       out << folly::format("{} \"{}\":{}\n", first ? "" : ",", name, value);
       first = false;
    };
    appendStat("hhbc-roarena-capac", hhbc_arena_capacity());
    appendStat("hhbc-size", g_hhbc_size->getSum());
    appendStat("rds", rds::usedBytes());
    appendStat("rds-local", rds::usedLocalBytes());
    appendStat("rds-persistent", rds::usedPersistentBytes());
    appendStat("catch-traces", jit::numCatchTraces());
    appendStat("fixups", jit::FixupMap::size());
    appendStat("units", numLoadedUnits());
    appendStat("funcs", Func::maxFuncIdNum());
    appendStat("named-entities", NamedEntity::tableSize());
    for (auto& pair : NamedEntity::tableStats()) {
      appendStat(folly::sformat("named-entities-{}", pair.first), pair.second);
    }
    appendStat("static-strings", makeStaticStringCount());
    appendStat("request-count", requestCount());
    appendStat("jit-des", jit::ProfData::triedDeserialization());
    appendStat("jit-des-succ", jit::ProfData::wasDeserialized());

    /*
     * We're only using globalProfData() here because admin requests don't call
     * requestInitProfData(). Normal request threads should always use
     * profData() which provides much better guarantees about the lifetime of
     * the returned object.
     */
    if (auto profData = jit::globalProfData()) {
      appendStat("prof-funcs", profData->profilingFuncs());
      appendStat("prof-bc", profData->profilingBCSize());
      appendStat("opt-funcs", profData->optimizedFuncs());
    }

    if (RuntimeOption::EvalEnableReusableTC) {
      auto const memInfos = jit::tc::getTCMemoryUsage();
      for (auto const info : memInfos) {
        appendStat(folly::format("tc-{}-allocs", info.name).str(), info.allocs);
        appendStat(folly::format("tc-{}-frees", info.name).str(), info.frees);
        appendStat(folly::format("tc-{}-free-size", info.name).str(),
                   info.free_size);
        appendStat(folly::format("tc-{}-free-blocks", info.name).str(),
                   info.free_blocks);
      }
      appendStat("tc-recorded-funcs", jit::tc::recordedFuncs());
      appendStat("tc-smashed-calls", jit::tc::smashedCalls());
      appendStat("tc-smashed-branches", jit::tc::smashedBranches());
    }

    out << "}" << endl;
    transport->sendString(out.str());
    return true;
  }
  if (cmd == "check-pl-load") {
    int count = PageletServer::GetActiveWorker();
    transport->sendString(folly::to<string>(count));
    return true;
  }
  if (cmd == "check-pl-queued") {
    int count = PageletServer::GetQueuedJobs();
    transport->sendString(folly::to<string>(count));
    return true;
  }
  if (cmd == "check-sat") {
    std::vector<std::pair<std::string, int>> stats;
    HttpServer::Server->getSatelliteStats(&stats);
    std::stringstream out;
    bool first = true;
    out << "{" << endl;
    auto appendStat = [&](const std::string &name, int value) {
       out << (!first ? "," : "") << "  \"" << name << "\":" << value << endl;
       first = false;
    };
    for (auto i : stats) {
      appendStat(i.first, i.second);
    }
    out << "}" << endl;
    transport->sendString(out.str());
    return true;
  }
  if (cmd == "check-sql") {
    string stats = "<?xml version=\"1.0\" encoding=\"utf-8\"?>\n";
    stats += "<SQL>\n";
#ifdef ENABLE_EXTENSION_MYSQL
    stats += MySqlStats::ReportStats();
#endif
    stats += "</SQL>\n";
    transport->sendString(stats);
    return true;
  }
  return false;
}
