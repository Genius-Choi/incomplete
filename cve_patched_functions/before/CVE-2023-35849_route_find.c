static struct pico_ipv4_route *route_find(struct pico_stack *S, const struct pico_ip4 *addr)
{
    struct pico_ipv4_route *r;
    struct pico_tree_node *index;

    if (addr->addr == PICO_IP4_ANY) {
        return NULL;
    }

    if (addr->addr != PICO_IP4_BCAST) {
        pico_tree_foreach_reverse(index, &S->Routes) {
            r = index->keyValue;
            if ((addr->addr & (r->netmask.addr)) == (r->dest.addr)) {
                return r;
            }
        }
        return NULL;
    }

    return route_find_default_bcast(S);
}
