njs_interactive_test(njs_unit_test_t tests[], size_t num, njs_str_t *name,
    njs_opts_t *opts, njs_stat_t *stat)
{
    u_char        *start, *last, *end;
    njs_vm_t      *vm;
    njs_int_t     ret;
    njs_str_t     s;
    njs_uint_t    i;
    njs_stat_t    prev;
    njs_bool_t    success;
    njs_vm_opt_t  options;

    vm = NULL;

    prev = *stat;

    ret = NJS_ERROR;

    for (i = 0; i < num; i++) {

        if (opts->verbose) {
            njs_printf("\"%V\"\n", &tests[i].script);
        }

        njs_vm_opt_init(&options);

        options.init = 1;
        options.interactive = 1;
        options.backtrace = 1;

        vm = njs_vm_create(&options);
        if (vm == NULL) {
            njs_printf("njs_vm_create() failed\n");
            goto done;
        }

        if (opts->externals) {
            ret = njs_externals_shared_init(vm);
            if (ret != NJS_OK) {
                goto done;
            }

            ret = njs_externals_init(vm);
            if (ret != NJS_OK) {
                goto done;
            }
        }

        start = tests[i].script.start;
        last = start + tests[i].script.length;
        end = NULL;

        for ( ;; ) {
            start = (end != NULL) ? end + njs_length(ENTER) : start;
            if (start >= last) {
                break;
            }

            end = (u_char *) strstr((char *) start, ENTER);

            ret = njs_vm_compile(vm, &start, end);
            if (ret == NJS_OK) {
                if (opts->disassemble) {
                    njs_disassembler(vm);
                }

                ret = njs_vm_start(vm);
            }
        }

        if (njs_vm_retval_string(vm, &s) != NJS_OK) {
            njs_printf("njs_vm_retval_string() failed\n");
            goto done;
        }

        success = njs_strstr_eq(&tests[i].ret, &s);

        if (!success) {
            njs_printf("njs(\"%V\")\nexpected: \"%V\"\n     got: \"%V\"\n",
                       &tests[i].script, &tests[i].ret, &s);

            stat->failed++;

        } else {
            stat->passed++;
        }

        njs_vm_destroy(vm);
        vm = NULL;
    }

    ret = NJS_OK;

done:

    if (vm != NULL) {
        njs_vm_destroy(vm);
    }

    njs_unit_test_report(name, &prev, stat);

    return ret;
}
