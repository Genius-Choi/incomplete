  void requestWithBodyTest(const std::string& typed_dns_resolver_config = "") {
    int64_t original_usec = dispatcher_->timeSource().monotonicTime().time_since_epoch().count();

    config_helper_.prependFilter(fmt::format(R"EOF(
  name: stream-info-to-headers-filter
)EOF"));

    initializeWithArgs(1024, 1024, "", typed_dns_resolver_config);
    codec_client_ = makeHttpConnection(lookupPort("http"));
    default_request_headers_.setHost(
        fmt::format("localhost:{}", fake_upstreams_[0]->localAddress()->ip()->port()));

    auto response = sendRequestAndWaitForResponse(default_request_headers_, 1024,
                                                  default_response_headers_, 1024);
    checkSimpleRequestSuccess(1024, 1024, response.get());
    testConnectionTiming(response, false, original_usec);
    EXPECT_EQ(1, test_server_->counter("dns_cache.foo.dns_query_attempt")->value());
    EXPECT_EQ(1, test_server_->counter("dns_cache.foo.host_added")->value());

    // Now send another request. This should hit the DNS cache.
    response = sendRequestAndWaitForResponse(default_request_headers_, 512,
                                             default_response_headers_, 512);
    checkSimpleRequestSuccess(512, 512, response.get());
    testConnectionTiming(response, true, original_usec);
    EXPECT_EQ(1, test_server_->counter("dns_cache.foo.dns_query_attempt")->value());
    EXPECT_EQ(1, test_server_->counter("dns_cache.foo.host_added")->value());
    // Make sure dns timings are tracked for cache-hits.
    ASSERT_FALSE(response->headers().get(Http::LowerCaseString("dns_start")).empty());
    ASSERT_FALSE(response->headers().get(Http::LowerCaseString("dns_end")).empty());

    if (upstream_tls_) {
      const Extensions::TransportSockets::Tls::SslHandshakerImpl* ssl_socket =
          dynamic_cast<const Extensions::TransportSockets::Tls::SslHandshakerImpl*>(
              fake_upstream_connection_->connection().ssl().get());
      EXPECT_STREQ("localhost", SSL_get_servername(ssl_socket->ssl(), TLSEXT_NAMETYPE_host_name));
    }
  }
