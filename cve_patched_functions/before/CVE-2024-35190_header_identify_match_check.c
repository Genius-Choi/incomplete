static int header_identify_match_check(void *obj, void *arg, int flags)
{
	struct ip_identify_match *identify = obj;
	struct pjsip_rx_data *rdata = arg;
	pjsip_hdr *header;
	pj_str_t pj_header_name;
	int header_present;

	if (ast_strlen_zero(identify->match_header)) {
		return 0;
	}

	pj_header_name = pj_str((void *) identify->match_header_name);

	/* Check all headers of the given name for a match. */
	header_present = 0;
	for (header = NULL;
		(header = pjsip_msg_find_hdr_by_name(rdata->msg_info.msg, &pj_header_name, header));
		header = header->next) {
		char *pos;
		int len;
		char buf[PATH_MAX];

		header_present = 1;

		/* Print header line to buf */
		len = pjsip_hdr_print_on(header, buf, sizeof(buf) - 1);
		if (len < 0) {
			/* Buffer not large enough or no header vptr! */
			ast_assert(0);
			continue;
		}
		buf[len] = '\0';

		/* Remove header name from pj_buf and trim blanks. */
		pos = strchr(buf, ':');
		if (!pos) {
			/* No header name?  Bug in PJPROJECT if so. */
			ast_assert(0);
			continue;
		}
		pos = ast_strip(pos + 1);

		/* Does header value match what we are looking for? */
		if (identify->is_header_regex) {
			if (!regexec(&identify->regex_header_buf, pos, 0, NULL, 0)) {
				return CMP_MATCH;
			}
		} else if (!strcmp(identify->match_header_value, pos)) {
			return CMP_MATCH;
		}

		ast_debug(3, "Identify '%s': SIP message has '%s' header but value '%s' does not match '%s'.\n",
			ast_sorcery_object_get_id(identify),
			identify->match_header_name,
			pos,
			identify->match_header_value);
	}
	if (!header_present) {
		ast_debug(3, "Identify '%s': SIP message does not have '%s' header.\n",
			ast_sorcery_object_get_id(identify),
			identify->match_header_name);
	}
	return 0;
}
