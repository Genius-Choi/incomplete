ssize_t clif_get_attr(const char *input, size_t input_len, clif_attr_t *attr)
{
    assert(input);
    assert(attr);
    const char *pos = input;
    const char *end = input + input_len;
    bool quoted = false;
    bool scan_value = false;

    /* initialize attr */
    attr->value = NULL;
    attr->key = NULL;

    /* an attribute should start with the separator */
    if (*pos != LF_ATTR_SEPARATOR_C) {
        DEBUG("Attribute should start with separator, found %c\n", *pos);
        return CLIF_NOT_FOUND;
    }
    pos++;
    attr->key = pos;

    /* iterate over key */
    while (pos < end) {
        if (*pos == LF_ATTR_SEPARATOR_C || *pos == LF_LINK_SEPARATOR_C) {
            /* key ends, no value */
            attr->key_len = pos - attr->key;
            break;
        }
        if (*pos == LF_ATTR_VAL_SEPARATOR_C) {
            /* key ends, has value */
            attr->key_len = pos - attr->key;
            /* check if the value is quoted and prepare pointer for value scan */
            pos++;
            if (pos == end) {
                break;
            }
            else if (*pos == '"') {
                quoted = true;
                pos++;
            }
            attr->value = (char *)pos;
            scan_value = true;
            break;
        }
        pos++;
    }

    if (scan_value) {
        /* iterate over value */
        while (pos < end) {
            if (quoted) {
                if (*pos == '"' && *(pos - 1) != '\\') {
                    /* found unescaped quote */
                    attr->value_len = pos - attr->value;
                    pos++;
                    break;
                }
            }
            else {
                if (*pos == LF_ATTR_SEPARATOR_C || *pos == LF_LINK_SEPARATOR_C) {
                    /* value ends */
                    attr->value_len = pos - attr->value;
                    break;
                }
            }
            pos++;
        }
    }
    else {
        /* buffer exhausted and no special character found, calculate length of
        * attribute and exit */
        attr->key_len = pos - attr->key;
    }

    return pos - input;
}
