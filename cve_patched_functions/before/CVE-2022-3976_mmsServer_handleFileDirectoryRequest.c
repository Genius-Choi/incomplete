mmsServer_handleFileDirectoryRequest(
    MmsServerConnection connection,
    uint8_t* buffer, int bufPos, int maxBufPos,
    uint32_t invokeId,
    ByteBuffer* response)
{
    if (DEBUG_MMS_SERVER)
        printf("MMS_SERVER: handleFileDirectoryRequest bufPos:%i, maxBufPus:%i\n", bufPos, maxBufPos);

    char filename[256] = "";

    char continueAfterFileName[256];

    char* continueAfter = NULL;

    while (bufPos < maxBufPos) {
        uint8_t tag = buffer[bufPos++];
        int length;

        bufPos = BerDecoder_decodeLength(buffer, &length, bufPos, maxBufPos);

        if (bufPos < 0) {
            mmsMsg_createMmsRejectPdu(&invokeId, MMS_ERROR_REJECT_INVALID_PDU, response);
            return;
        }

        switch(tag) {
        case 0xa0: /* filename */
            if (!mmsMsg_parseFileName(filename, buffer, &bufPos, bufPos + length, invokeId, response))
                return;

            /* check for wildcard character(*) */
            if ((strcmp(filename, "*") == 0) || (strcmp(filename, "/") == 0) || (strcmp(filename, "\\") == 0))
            	filename[0] = 0;

            break;

        case 0xa1: /* continue-after */
            if (!mmsMsg_parseFileName(continueAfterFileName, buffer, &bufPos, bufPos + length, invokeId, response))
                return;

            continueAfter = continueAfterFileName;

            break;

        case 0x00: /* indefinite length end tag -> ignore */
            break;

        default: /* unrecognized parameter */
            if (DEBUG_MMS_SERVER)
                printf("MMS_SERVER: handleFileDirectoryRequest: unrecognized parameter\n");
            mmsMsg_createMmsRejectPdu(&invokeId, MMS_ERROR_REJECT_INVALID_PDU, response);
            return;
        }


    }

    int maxPduSize = connection->maxPduSize;

    /* Call user to check if access is allowed */
    if (connection->server->fileAccessHandler != NULL) {
        MmsError access = connection->server->fileAccessHandler(connection->server->fileAccessHandlerParameter,
                            connection, MMS_FILE_ACCESS_TYPE_READ_DIRECTORY, filename, continueAfter);

        if (access != MMS_ERROR_NONE) {
            mmsMsg_createServiceErrorPdu(invokeId, response, access);
            return;
        }
    }

    createFileDirectoryResponse(MmsServerConnection_getFilesystemBasepath(connection),
            invokeId, response, maxPduSize, filename, continueAfter);
}
