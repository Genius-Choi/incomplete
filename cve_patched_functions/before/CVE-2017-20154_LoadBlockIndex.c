bool LoadBlockIndex(bool fAllowNew) {

    if(fTestNet) {
        pchMessageStart[0] = 0xFF;
        pchMessageStart[1] = 0xC4;
        pchMessageStart[2] = 0xBA;
        pchMessageStart[3] = 0xDF;
        pchMessageStartNew[0] = 0xFE;
        pchMessageStartNew[1] = 0xD0;
        pchMessageStartNew[2] = 0xD8;
        pchMessageStartNew[3] = 0xD4;
        hashGenesisBlock = uint256("0xecd47eee16536f7d03d64643cfc8c61b22093f8bf2c9358bf8b6f4dcb5f13192");
        nBaseMaturity = BASE_MATURITY_TESTNET;
    }

    //
    // Load block index
    //
    CTxDB txdb("cr");
    if (!txdb.LoadBlockIndex())
        return false;
    txdb.Close();

    //
    // Init with genesis block
    //
    if(mapBlockIndex.empty()) {

        if(!fAllowNew) return false;

        CTransaction txNew;
        CBlock block;

        if(!fTestNet) {

            // The Phoenixcoin genesis block:
            // CBlock(hash=be2f30f9e8db8f430056, PoW=00000e9c6e417d3d8068, ver=1, hashPrevBlock=00000000000000000000, hashMerkleRoot=ff2aa75842, nTime=1317972665, nBits=1e0ffff0, nNonce=2084931085, vtx=1)
            //  CTransaction(hash=ff2aa75842, ver=1, vin.size=1, vout.size=1, nLockTime=0)
            //    CTxIn(COutPoint(0000000000, -1), coinbase 04ffff001d010446552e532e204973205765696768696e672057696465204f7665726861756c206f662057697265746170204c617773202d204e592054696d6573202d204d617920382032303133)
            //    CTxOut(error)
            //  vMerkleTree: ff2aa75842

            const char* pszTimestamp = "U.S. Is Weighing Wide Overhaul of Wiretap Laws - NY Times - May 8 2013";
            txNew.vin.resize(1);
            txNew.vout.resize(1);
            txNew.vin[0].scriptSig = CScript() << 486604799 << CBigNum(4) << vector<unsigned char>((const unsigned char*)pszTimestamp, (const unsigned char*)pszTimestamp + strlen(pszTimestamp));
            txNew.vout[0].nValue = 50 * COIN;
            txNew.vout[0].scriptPubKey = CScript() << 0x00 << OP_CHECKSIG;
            block.vtx.push_back(txNew);
            block.hashPrevBlock = 0;
            block.hashMerkleRoot = block.BuildMerkleTree();
            block.nVersion = 1;
            block.nTime    = 1317972665;
            block.nBits    = 0x1e0ffff0;
            block.nNonce   = 2084931085;

        } else {

            // The Phoenixcoin testnet genesis block:
            // CBlock(hash=ecd47eee16536f7d03d6, PoW=000004b4022863f9ecf0, ver=1, hashPrevBlock=00000000000000000000, hashMerkleRoot=9bf4ade403, nTime=1383768000, nBits=1e0ffff0, nNonce=1029893, vtx=1)
            //  CTransaction(hash=9bf4ade403, ver=1, vin.size=1, vout.size=1, nLockTime=0)
            //    CTxIn(COutPoint(0000000000, -1), coinbase 04ffff001d01044a57656220466f756e6465722044656e6f756e636573204e534120456e6372797074696f6e20437261636b696e67202d2054686520477561726469616e202d2030362f4e6f762f32303133)
            //    CTxOut(nValue=500.00000000, scriptPubKey=049023f10bccda76f971d6417d420c)
            //  vMerkleTree: 9bf4ade403 

            const char* pszTimestamp = "Web Founder Denounces NSA Encryption Cracking - The Guardian - 06/Nov/2013";
            txNew.vin.resize(1);
            txNew.vout.resize(1);
            txNew.vin[0].scriptSig = CScript() << 486604799 << CBigNum(4) << vector<unsigned char>((const unsigned char*)pszTimestamp, (const unsigned char*)pszTimestamp + strlen(pszTimestamp));
            txNew.vout[0].nValue = 500 * COIN;
            txNew.vout[0].scriptPubKey = CScript() << ParseHex("049023F10BCCDA76F971D6417D420C6BB5735D3286669CE03B49C5FEA07078F0E07B19518EE1C0A4F81BCF56A5497AD7D8200CE470EEA8C6E2CF65F1EE503F0D3E") << OP_CHECKSIG;
            block.vtx.push_back(txNew);
            block.hashPrevBlock = 0;
            block.hashMerkleRoot = block.BuildMerkleTree();
            block.nVersion = 1;
            block.nTime    = 1383768000;
            block.nBits    = 0x1e0ffff0;
            block.nNonce   = 1029893;

        }

        //// debug print
        printf("%s\n", block.GetHash().ToString().c_str());
        printf("%s\n", hashGenesisBlock.ToString().c_str());
        printf("%s\n", block.hashMerkleRoot.ToString().c_str());

        if(!fTestNet) assert(block.hashMerkleRoot == uint256("0xff2aa75842fae1bfb100b656c57229ce37b03643434da2043ddab7a11cfe69a6"));
        else assert(block.hashMerkleRoot == uint256("0x9bf4ade403d775b44e872935609367aee5bd7df698e0f4c73e5f30f46b30a537"));

        // If genesis block hash does not match, then generate new genesis hash.
        if (false && block.GetHash() != hashGenesisBlock)
        {
            printf("Searching for genesis block...\n");
            // This will figure out a valid hash and Nonce if you're
            // creating a different genesis block:
            uint profile = fNeoScrypt ? 0x0 : 0x3;
            uint256 hashTarget = CBigNum().SetCompact(block.nBits).getuint256();
            uint256 hash;

            while(true) {
                neoscrypt((uchar *) &block.nVersion, (uchar *) &hash, profile);
                if(hash <= hashTarget) break;
                if ((block.nNonce & 0xFFF) == 0)
                {
                    printf("nonce %08X: hash = %s (target = %s)\n", block.nNonce, hash.ToString().c_str(), hashTarget.ToString().c_str());
                }
                ++block.nNonce;
                if (block.nNonce == 0)
                {
                    printf("NONCE WRAPPED, incrementing time\n");
                    ++block.nTime;
                }
            }
            printf("block.nTime = %u \n", block.nTime);
            printf("block.nNonce = %u \n", block.nNonce);
            printf("block.GetHash = %s\n", block.GetHash().ToString().c_str());
        }

        block.print();
        assert(block.GetHash() == hashGenesisBlock);

        // Start new block file
        unsigned int nFile;
        unsigned int nBlockPos;
        if (!block.WriteToDisk(nFile, nBlockPos))
            return error("LoadBlockIndex() : writing genesis block to disk failed");
        if (!block.AddToBlockIndex(nFile, nBlockPos))
            return error("LoadBlockIndex() : genesis block not accepted");

        // Initialise advanced checkpointing
        if (!WriteSyncCheckpoint(hashGenesisBlock))
            return error("LoadBlockIndex() : failed to initialise advanced checkpointing");
    }

    // Verify the master public key and reset advanced checkpointing if changed
    if (!CheckCheckpointPubKey())
        return error("LoadBlockIndex() : failed to reset advanced checkpointing");

    return true;
}
