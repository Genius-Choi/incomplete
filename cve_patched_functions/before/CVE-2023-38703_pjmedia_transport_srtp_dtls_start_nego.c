PJ_DEF(pj_status_t) pjmedia_transport_srtp_dtls_start_nego(
                                pjmedia_transport *tp,
                                const pjmedia_srtp_dtls_nego_param *param)
{
    transport_srtp *srtp = (transport_srtp*)tp;
    dtls_srtp *ds = NULL;
    unsigned j;
    pjmedia_transport_attach_param ap;
    pj_status_t status;

    PJ_ASSERT_RETURN(tp && param, PJ_EINVAL);
    PJ_ASSERT_RETURN(pj_sockaddr_has_addr(&param->rem_addr), PJ_EINVAL);

    /* Find DTLS keying and destroy any other keying. */
    for (j = 0; j < srtp->all_keying_cnt; ++j) {
        if (srtp->all_keying[j]->op == &dtls_op)
            ds = (dtls_srtp*)srtp->all_keying[j];
        else
            pjmedia_transport_close(srtp->all_keying[j]);
    }

    /* DTLS-SRTP is not enabled */
    if (!ds)
        return PJ_ENOTSUP;

    /* Set SRTP keying to DTLS-SRTP only */
    srtp->keying_cnt = 1;
    srtp->keying[0] = &ds->base;
    srtp->keying_pending_cnt = 0;

    /* Apply param to DTLS-SRTP internal states */
    pj_strdup(ds->pool, &ds->rem_fingerprint, &param->rem_fingerprint);
    ds->rem_fprint_status = PJ_EPENDING;
    ds->rem_addr = param->rem_addr;
    ds->rem_rtcp = param->rem_rtcp;
    ds->setup = param->is_role_active? DTLS_SETUP_ACTIVE:DTLS_SETUP_PASSIVE;

    /* Pending start SRTP */
    ds->pending_start = PJ_TRUE;
    srtp->keying_pending_cnt++;

    /* Attach member transport, so we can send/receive DTLS init packets */
    pj_bzero(&ap, sizeof(ap));
    ap.user_data = ds->srtp;
    pj_sockaddr_cp(&ap.rem_addr, &ds->rem_addr);
    pj_sockaddr_cp(&ap.rem_rtcp, &ds->rem_rtcp);
    if (pj_sockaddr_cmp(&ds->rem_addr, &ds->rem_rtcp) == 0)
        ds->srtp->use_rtcp_mux = PJ_TRUE;
    ap.addr_len = pj_sockaddr_get_len(&ap.rem_addr);
    status = pjmedia_transport_attach2(&ds->srtp->base, &ap);
    if (status != PJ_SUCCESS)
        goto on_return;

#if DTLS_DEBUG
    {
        char addr[PJ_INET6_ADDRSTRLEN];
        PJ_LOG(2,(ds->base.name, "Attached transport, remote addr=%s:%d",
                  pj_sockaddr_print(&ap.rem_addr, addr, sizeof(addr), 2),
                  pj_sockaddr_get_port(&ap.rem_addr)));
    }
#endif

    /* Start DTLS handshake */
    pj_bzero(&srtp->srtp_ctx.rx_policy_neg,
             sizeof(srtp->srtp_ctx.rx_policy_neg));
    pj_bzero(&srtp->srtp_ctx.tx_policy_neg,
             sizeof(srtp->srtp_ctx.tx_policy_neg));
    status = ssl_handshake(ds);
    if (status != PJ_SUCCESS)
        goto on_return;

on_return:
    if (status != PJ_SUCCESS) {
        ssl_destroy(ds, RTP_CHANNEL);
        ssl_destroy(ds, RTCP_CHANNEL);
    }
    return status;
}
