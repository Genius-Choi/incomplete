gerb_find_file(char const * filename, char **paths)
{
    char *curr_path = NULL;
    char *complete_path = NULL;
    int	 i;

#ifdef DEBUG
    if( DEBUG > 0 ) {
        for (i = 0; paths[i] != NULL; i++) {
            printf("%s():  paths[%d] = \"%s\"\n", __FUNCTION__, i, paths[i]);
        }
    }
#endif

    for (i = 0; paths[i] != NULL; i++) {
        dprintf("%s():  Try paths[%d] = \"%s\"\n", __FUNCTION__, i, paths[i]);

	/*
	 * Environment variables start with a $ sign 
	 */
	if (paths[i][0] == '$') {
	    char *env_name, *env_value, *tmp;
	    int len;

	    /* Extract environment name. Remember we start with a $ */
        
   	    tmp = strchr(paths[i], G_DIR_SEPARATOR);
	    if (tmp == NULL) 
		len = strlen(paths[i]) - 1;
	    else
		len = tmp - paths[i] - 1;
	    env_name = (char *)g_malloc(len + 1);
	    if (env_name == NULL)
		return NULL;
	    strncpy(env_name, (char *)(paths[i] + 1), len);
	    env_name[len] = '\0';

	    env_value = getenv(env_name);
            dprintf("%s():  Trying \"%s\" = \"%s\" from the environment\n",
                __FUNCTION__, env_name,
                env_value == NULL ? "(null)" : env_value);

	    if (env_value == NULL) {
	      curr_path = NULL;
	    } else {
	      curr_path = (char *)g_malloc(strlen(env_value) + strlen(&paths[i][len + 1]) + 1);
	      if (curr_path == NULL)
		return NULL;
	      strcpy(curr_path, env_value);
	      strcat(curr_path, &paths[i][len + 1]);
	      g_free(env_name);
	    }
	} else {
	    curr_path = paths[i];
	}

	if (curr_path != NULL) {
	  /*
	   * Build complete path (inc. filename) and check if file exists.
	   */
	  complete_path = g_build_filename(curr_path, filename, NULL);
	  if (complete_path == NULL)
	    return NULL;
	  
	  if (paths[i][0] == '$') {
	    g_free(curr_path);
	    curr_path = NULL;
	  }
	  
	  dprintf("%s():  Tring to access \"%s\"\n", __FUNCTION__,
		  complete_path);
	  
	  if (access(complete_path, R_OK) != -1)
	    break;
	  
	  g_free(complete_path);
	  complete_path = NULL;
	}
    }
	
    if (complete_path == NULL)
      errno = ENOENT;
    
    dprintf("%s():  returning complete_path = \"%s\"\n", __FUNCTION__,
	    complete_path == NULL ? "(null)" : complete_path);
    
    return complete_path;
} /* gerb_find_file */
