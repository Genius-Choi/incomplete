check_or_schedule_mtu_probe (struct ietf_full_conn *conn, lsquic_time_t now)
{
    struct conn_path *const cpath = CUR_CPATH(conn);
    struct dplpmtud_state *const ds = &cpath->cop_dplpmtud;
    struct lsquic_packet_out *packet_out;
    unsigned short saved_packet_sz, avail, mtu_ceiling, net_header_sz, probe_sz;
    int sz;

    if (ds->ds_flags & DS_PROBE_SENT)
    {
        assert(ds->ds_probe_sent + conn->ifc_enpub->enp_mtu_probe_timer < now);
        LSQ_DEBUG("MTU probe of %hu bytes lost", ds->ds_probed_size);
        ds->ds_flags &= ~DS_PROBE_SENT;
        conn->ifc_mflags |= MF_CHECK_MTU_PROBE;
        if (ds->ds_probe_count >= 3)
        {
            LSQ_DEBUG("MTU probe of %hu bytes lost after %hhu tries",
                ds->ds_probed_size, ds->ds_probe_count);
            ds->ds_failed_size = ds->ds_probed_size;
            ds->ds_probe_count = 0;
        }
    }

    assert(0 == ds->ds_probe_sent
        || ds->ds_probe_sent + conn->ifc_enpub->enp_mtu_probe_timer < now);

    if (!(conn->ifc_conn.cn_flags & LSCONN_HANDSHAKE_DONE)
        || (conn->ifc_flags & IFC_CLOSING)
        || ~0ull == lsquic_senhist_largest(&conn->ifc_send_ctl.sc_senhist)
        || lsquic_senhist_largest(&conn->ifc_send_ctl.sc_senhist) < 30
        || lsquic_send_ctl_in_recovery(&conn->ifc_send_ctl)
        || !lsquic_send_ctl_can_send_probe(&conn->ifc_send_ctl,
                                                        &cpath->cop_path))
    {
        return;
    }

    if (ds->ds_failed_size)
        mtu_ceiling = ds->ds_failed_size;
    else if (conn->ifc_settings->es_max_plpmtu)
        mtu_ceiling = conn->ifc_settings->es_max_plpmtu;
    else
    {
        net_header_sz = TRANSPORT_OVERHEAD(NP_IS_IPv6(&cpath->cop_path));
        mtu_ceiling = 1500 - net_header_sz;
    }

    if (conn->ifc_max_udp_payload < mtu_ceiling)
    {
        LSQ_DEBUG("cap MTU ceiling to peer's max_udp_payload_size TP of %hu "
            "bytes", conn->ifc_max_udp_payload);
        mtu_ceiling = conn->ifc_max_udp_payload;
    }

    if (cpath->cop_path.np_pack_size >= mtu_ceiling
        || (float) cpath->cop_path.np_pack_size / (float) mtu_ceiling >= 0.99)
    {
        LSQ_DEBUG("stop MTU probing on path %hhu having achieved about "
            "%.1f%% efficiency (detected MTU: %hu; failed MTU: %hu)",
            cpath->cop_path.np_path_id,
            100. * (float) cpath->cop_path.np_pack_size / (float) mtu_ceiling,
            cpath->cop_path.np_pack_size, ds->ds_failed_size);
        conn->ifc_mflags &= ~MF_CHECK_MTU_PROBE;
        return;
    }

    LSQ_DEBUG("MTU ratio: %hu / %hu = %.4f",
        cpath->cop_path.np_pack_size, mtu_ceiling,
        (float) cpath->cop_path.np_pack_size / (float) mtu_ceiling);

    if (!ds->ds_failed_size && mtu_ceiling < 1500)
        /* Try the largest ethernet MTU immediately */
        probe_sz = mtu_ceiling;
    else if (cpath->cop_path.np_pack_size * 2 >= mtu_ceiling)
        /* Pick half-way point */
        probe_sz = (mtu_ceiling + cpath->cop_path.np_pack_size) / 2;
    else
        probe_sz = cpath->cop_path.np_pack_size * 2;

    /* XXX Changing np_pack_size is action at a distance */
    saved_packet_sz = cpath->cop_path.np_pack_size;
    cpath->cop_path.np_pack_size = probe_sz;
    packet_out = lsquic_send_ctl_new_packet_out(&conn->ifc_send_ctl,
                                                        0, PNS_APP, CUR_NPATH(conn));
    if (!packet_out)
        goto restore_packet_size;
    sz = conn->ifc_conn.cn_pf->pf_gen_ping_frame(
                            packet_out->po_data + packet_out->po_data_sz,
                            lsquic_packet_out_avail(packet_out));
    if (sz < 0) {
        ABORT_ERROR("gen_ping_frame failed");
        goto restore_packet_size;
    }
    /* We don't record frame records for MTU probes as they are never
     * resized, only discarded.
     */
    lsquic_send_ctl_incr_pack_sz(&conn->ifc_send_ctl, packet_out, sz);
    packet_out->po_frame_types |= 1 << QUIC_FRAME_PING;
    avail = lsquic_packet_out_avail(packet_out);
    if (avail)
    {
        memset(packet_out->po_data + packet_out->po_data_sz, 0, avail);
        lsquic_send_ctl_incr_pack_sz(&conn->ifc_send_ctl, packet_out, avail);
        packet_out->po_frame_types |= 1 << QUIC_FRAME_PADDING;
    }
    packet_out->po_flags |= PO_MTU_PROBE;
    lsquic_send_ctl_scheduled_one(&conn->ifc_send_ctl, packet_out);
    LSQ_DEBUG("generated MTU probe of %hu bytes in packet %"PRIu64,
                        cpath->cop_path.np_pack_size, packet_out->po_packno);
#ifndef NDEBUG
    ds->ds_probe_sent = now;
#endif
    ds->ds_probe_packno = packet_out->po_packno;
    ds->ds_probed_size = probe_sz;
    ds->ds_flags |= DS_PROBE_SENT;
    ++ds->ds_probe_count;
    conn->ifc_mflags &= ~MF_CHECK_MTU_PROBE;
    assert(!lsquic_alarmset_is_set(&conn->ifc_alset, AL_MTU_PROBE));
    lsquic_alarmset_set(&conn->ifc_alset, AL_MTU_PROBE,
                                now + conn->ifc_enpub->enp_mtu_probe_timer);
  restore_packet_size:
    cpath->cop_path.np_pack_size = saved_packet_sz;
}
