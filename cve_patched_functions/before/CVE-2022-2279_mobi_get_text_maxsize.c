size_t mobi_get_text_maxsize(const MOBIData *m) {
    if (m && m->rh) {
        /* FIXME: is it safe to use data from Record 0 header? */
        if (m->rh->text_record_count > 0) {
            uint16_t max_record_size = mobi_get_textrecord_maxsize(m);
            size_t maxsize = (size_t) m->rh->text_record_count * (size_t) max_record_size;
            if (mobi_exists_mobiheader(m) && mobi_get_fileversion(m) <= 3) {
                /* workaround for some old files with records larger than declared record size */
                if (m->rh->text_length > maxsize) {
                    maxsize = m->rh->text_length;
                }
            }
            if (maxsize > RAWTEXT_SIZEMAX) {
                debug_print("Raw text too large (%zu)\n", maxsize);
                return MOBI_NOTSET;
            }
            return maxsize;
        }
    }
    return MOBI_NOTSET;
}
