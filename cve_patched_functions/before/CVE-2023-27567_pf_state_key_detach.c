pf_state_key_detach(struct pf_state *st, int idx)
{
	struct pf_state_item	*si;
	struct pf_state_key	*sk;

	PF_ASSERT_LOCKED();

	sk = st->key[idx];
	if (sk == NULL)
		return;

	TAILQ_FOREACH(si, &sk->sk_states, si_entry) {
		if (si->si_st == st)
			break;
	}
	if (si == NULL)
		return;

	TAILQ_REMOVE(&sk->sk_states, si, si_entry);
	pool_put(&pf_state_item_pl, si);

	if (TAILQ_EMPTY(&sk->sk_states)) {
		RBT_REMOVE(pf_state_tree, &pf_statetbl, sk);
		sk->sk_removed = 1;
		pf_state_key_unlink_reverse(sk);
		pf_state_key_unlink_inpcb(sk);
		pf_state_key_unref(sk);
	}

	pf_state_unref(st);
}
