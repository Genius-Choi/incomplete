static void build_auth_response(struct _oidc_config * config, struct _u_response * response, int response_mode, json_t * j_client, const char * redirect_uri, struct _u_map * map_query) {
  const char ** keys, * value, * sep;
  size_t i;
  char * redirect_url = NULL, * key_encoded, * value_encoded, * token = NULL;
  int enc_res = G_OK, has_param = 0;

  if (!o_strnullempty(redirect_uri)) {
    if (response_mode == GLEWLWYD_RESPONSE_MODE_QUERY_JWT || response_mode == GLEWLWYD_RESPONSE_MODE_FRAGMENT_JWT || response_mode == GLEWLWYD_RESPONSE_MODE_FORM_POST_JWT) {
      token = build_jwt_auth_response(config, j_client, map_query, &enc_res);
    }
    switch (response_mode) {
      case GLEWLWYD_RESPONSE_MODE_QUERY:
        redirect_url = o_strdup(redirect_uri);
        if (json_object_get(config->j_params, "oauth-as-iss-id") == json_true()) {
          value_encoded = ulfius_url_encode(json_string_value(json_object_get(config->j_params, "iss")));
          redirect_url = mstrcatf(redirect_url, "%ciss=%s", (o_strchr(redirect_url, '?')!=NULL?'&':'?'), value_encoded);
          o_free(value_encoded);
        }
        keys = u_map_enum_keys(map_query);
        for (i=0; keys[i]!=NULL; i++) {
          value = u_map_get(map_query, keys[i]);
          if (!o_strnullempty(value)) {
            value_encoded = ulfius_url_encode(value);
            redirect_url = mstrcatf(redirect_url, "%c%s=%s", (o_strchr(redirect_url, '?')!=NULL?'&':'?'), keys[i], value_encoded);
            o_free(value_encoded);
          } else {
            redirect_url = mstrcatf(redirect_url, "%c%s", (o_strchr(redirect_url, '?')!=NULL?'&':'?'), keys[i]);
          }
        }
        response->status = 302;
        ulfius_add_header_to_response(response, "Location", redirect_url);
        o_free(redirect_url);
        break;
      case GLEWLWYD_RESPONSE_MODE_FRAGMENT:
        redirect_url = msprintf("%s#", redirect_uri);
        if (json_object_get(config->j_params, "oauth-as-iss-id") == json_true()) {
          value_encoded = ulfius_url_encode(json_string_value(json_object_get(config->j_params, "iss")));
          redirect_url = mstrcatf(redirect_url, "iss=%s", value_encoded);
          o_free(value_encoded);
          has_param = 1;
        }
        keys = u_map_enum_keys(map_query);
        for (i=0; keys[i]!=NULL; i++) {
          value = u_map_get(map_query, keys[i]);
          if (has_param) {
            sep = "&";
          } else {
            sep = "";
            has_param = 1;
          }
          if (!o_strnullempty(value)) {
            value_encoded = ulfius_url_encode(value);
            redirect_url = mstrcatf(redirect_url, "%s%s=%s", sep, keys[i], value_encoded);
            o_free(value_encoded);
          } else {
            redirect_url = mstrcatf(redirect_url, "%s%s", sep, keys[i]);
          }
        }
        response->status = 302;
        ulfius_add_header_to_response(response, "Location", redirect_url);
        o_free(redirect_url);
        break;
      case GLEWLWYD_RESPONSE_MODE_FORM_POST:
        redirect_url = msprintf("<html><head><title>Glewlwyd</title></head><body onload=\"javascript:document.forms[0].submit()\"><form method=\"post\" action=\"%s\">", redirect_uri);

        if (json_object_get(config->j_params, "oauth-as-iss-id") == json_true()) {
          value_encoded = ulfius_url_encode(json_string_value(json_object_get(config->j_params, "iss")));
          redirect_url = mstrcatf(redirect_url, "<input type=\"hidden\" name=\"iss\" value=\"%s\"/>", value_encoded);
          o_free(value_encoded);
        }
        keys = u_map_enum_keys(map_query);
        for (i=0; keys[i]!=NULL; i++) {
          value = u_map_get(map_query, keys[i]);
          key_encoded = ulfius_url_encode(keys[i]);
          if (!o_strnullempty(value)) {
            value_encoded = ulfius_url_encode(value);
            redirect_url = mstrcatf(redirect_url, "<input type=\"hidden\" name=\"%s\" value=\"%s\"/>", key_encoded, value_encoded);
            o_free(value_encoded);
          } else {
            redirect_url = mstrcatf(redirect_url, "<input type=\"hidden\" name=\"%s\" value=\"\"/>", key_encoded);
          }
          o_free(key_encoded);
        }
        redirect_url = mstrcatf(redirect_url, "</form></body></html>");
        ulfius_set_string_body_response(response, 200, redirect_url);
        o_free(redirect_url);
        break;
      case GLEWLWYD_RESPONSE_MODE_QUERY_JWT:
        if (token != NULL) {
          redirect_url = msprintf("%s%cresponse=%s", redirect_uri, (o_strchr(redirect_uri, '?')!=NULL?'&':'?'), token);
          response->status = 302;
          ulfius_add_header_to_response(response, "Location", redirect_url);
          o_free(redirect_url);
        } else if (enc_res == G_ERROR_UNAUTHORIZED) {
          redirect_url = msprintf("%s%cerror=invalid_request&error_description=invalid+encryption+parameters", redirect_uri, (o_strchr(redirect_uri, '?')!=NULL?'&':'?'));
          response->status = 302;
          ulfius_add_header_to_response(response, "Location", redirect_url);
          o_free(redirect_url);
        } else {
          redirect_url = msprintf("%s%cerror=server_error", redirect_uri, (o_strchr(redirect_uri, '?')!=NULL?'&':'?'));
          response->status = 302;
          ulfius_add_header_to_response(response, "Location", redirect_url);
          o_free(redirect_url);
        }
        break;
      case GLEWLWYD_RESPONSE_MODE_FRAGMENT_JWT:
        if (token != NULL) {
          redirect_url = msprintf("%s#response=%s", redirect_uri, token);
          response->status = 302;
          ulfius_add_header_to_response(response, "Location", redirect_url);
          o_free(redirect_url);
        } else if (enc_res == G_ERROR_UNAUTHORIZED) {
          redirect_url = msprintf("%s#error=invalid_request&error_description=invalid+encryption+parameters", redirect_uri);
          response->status = 302;
          ulfius_add_header_to_response(response, "Location", redirect_url);
          o_free(redirect_url);
        } else {
          redirect_url = msprintf("%s#error=server_error", redirect_uri, token);
          response->status = 302;
          ulfius_add_header_to_response(response, "Location", redirect_url);
          o_free(redirect_url);
        }
        break;
      case GLEWLWYD_RESPONSE_MODE_FORM_POST_JWT:
        if (token != NULL) {
          redirect_url = msprintf("<html><head><title>Glewlwyd</title></head><body onload=\"javascript:document.forms[0].submit()\"><form method=\"post\" action=\"%s\"><input type=\"hidden\" name=\"response\" value=\"%s\"/></form></body></html>", redirect_uri, token);
          ulfius_set_string_body_response(response, 200, redirect_url);
          o_free(redirect_url);
        } else if (enc_res == G_ERROR_UNAUTHORIZED) {
          redirect_url = msprintf("<html><head><title>Glewlwyd</title></head><body onload=\"javascript:document.forms[0].submit()\"><form method=\"post\" action=\"%s\"><input type=\"hidden\" name=\"error\" value=\"invalid_request\"/><input type=\"hidden\" name=\"error_description\" value=\"invalid encryption parameters\"/></form></body></html>", redirect_uri);
          ulfius_set_string_body_response(response, 200, redirect_url);
          o_free(redirect_url);
        } else {
          redirect_url = msprintf("<html><head><title>Glewlwyd</title></head><body onload=\"javascript:document.forms[0].submit()\"><form method=\"post\" action=\"%s\"><input type=\"hidden\" name=\"error\" value=\"server_error\"/></form></body></html>", redirect_uri);
          ulfius_set_string_body_response(response, 200, redirect_url);
          o_free(redirect_url);
        }
        break;
    }
  } else {
    ulfius_set_string_body_response(response, 403, "<html><head><title>Glewlwyd</title></head><body><h1>Invalid request</h1></body></html>");
    response->status = 403;
  }
  o_free(token);
}
