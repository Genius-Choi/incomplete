int belle_sip_dialog_establish(belle_sip_dialog_t *obj, belle_sip_request_t *req, belle_sip_response_t *resp){
	belle_sip_header_to_t *to=belle_sip_message_get_header_by_type(resp,belle_sip_header_to_t);
	belle_sip_header_via_t *via=belle_sip_message_get_header_by_type(req,belle_sip_header_via_t);
	belle_sip_uri_t *requri=belle_sip_request_get_uri(req);

	if (obj->state != BELLE_SIP_DIALOG_NULL) {
		belle_sip_error("Dialog [%p] already established.",obj);
		return -1;
	}
	if (!to){
		belle_sip_error("No to in response.");
		return -1;
	}

	if (!obj->is_server) {
		belle_sip_header_contact_t *ct=belle_sip_message_get_header_by_type(resp,belle_sip_header_contact_t);
		const belle_sip_list_t* elem;
		/*contact might be provided later*/
		if (ct)
			obj->remote_target=(belle_sip_header_address_t*)belle_sip_object_ref(ct);

		/**12.1.2
		 *  The route set MUST be set to the list of URIs in the Record-Route
		 *header field from the response, taken in reverse order and preserving
		 *all URI parameters.  If no Record-Route header field is present in
		 *the response, the route set MUST be set to the empty set.
		 **/
		obj->route_set=belle_sip_list_free_with_data(obj->route_set,belle_sip_object_unref);
		for(elem=belle_sip_message_get_headers((belle_sip_message_t*)resp,BELLE_SIP_RECORD_ROUTE);elem!=NULL;elem=elem->next){
			obj->route_set=belle_sip_list_prepend(obj->route_set,belle_sip_object_ref(belle_sip_header_route_create(
																													(belle_sip_header_address_t*)elem->data)));
		}

		check_route_set(obj->route_set);
		/*via might be unknown at dialog creation*/
		if (strcasecmp(belle_sip_header_via_get_protocol(via),"TLS")==0
			&& belle_sip_uri_is_secure(requri)){
			obj->is_secure=TRUE;
		}

	}

	set_to_tag(obj,to);

	return 0;
}
