PJ_DEF(pj_status_t) pjmedia_ice_trickle_decode_sdp(
                                            const pjmedia_sdp_session *sdp,
                                            unsigned media_index,
                                            pj_str_t *mid,
                                            pj_str_t *ufrag,
                                            pj_str_t *passwd,
                                            unsigned *cand_cnt,
                                            pj_ice_sess_cand cand[],
                                            pj_bool_t *end_of_cand)
{
    const pjmedia_sdp_media *m;
    const pjmedia_sdp_attr *a;

    PJ_ASSERT_RETURN(sdp && media_index < sdp->media_count, PJ_EINVAL);

    m = sdp->media[media_index];

    if (mid) {
        a = pjmedia_sdp_attr_find2(m->attr_count, m->attr, "mid", NULL);
        if (a) {
            *mid = a->value;
        } else {
            pj_bzero(mid, sizeof(*mid));
        }
    }

    if (ufrag && passwd) {
        const pjmedia_sdp_attr *a_ufrag, *a_pwd;
        get_ice_attr(sdp, m, &a_ufrag, &a_pwd);
        if (a_ufrag && a_pwd) {
            *ufrag = a_ufrag->value;
            *passwd = a_pwd->value;
        } else {
            pj_bzero(ufrag, sizeof(*ufrag));
            pj_bzero(passwd, sizeof(*passwd));
        }
    }

    if (cand_cnt && cand && *cand_cnt > 0) {
        pj_status_t status;
        unsigned i, cnt = 0;

        for (i=0; i<m->attr_count && cnt<*cand_cnt; ++i) {
            a = m->attr[i];
            if (pj_strcmp(&a->name, &STR_CANDIDATE)!=0)
                continue;

            /* Parse candidate */
            status = parse_cand("trickle-ice", NULL, &a->value, &cand[cnt]);
            if (status != PJ_SUCCESS) {
                PJ_PERROR(4,("trickle-ice", status,
                             "Error in parsing SDP candidate attribute '%.*s', "
                             "candidate is ignored",
                             (int)a->value.slen, a->value.ptr));
                continue;
            }
            ++cnt;
        }
        *cand_cnt = cnt;
    }

    if (end_of_cand) {
        a = pjmedia_sdp_attr_find(m->attr_count, m->attr, &STR_END_OF_CAND,
                                  NULL);
        if (!a) {
            a = pjmedia_sdp_attr_find(sdp->attr_count, sdp->attr,
                                      &STR_END_OF_CAND, NULL);
        }
        *end_of_cand = (a != NULL);
    }
    return PJ_SUCCESS;
}
