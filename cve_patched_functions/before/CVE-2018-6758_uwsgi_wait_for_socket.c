int uwsgi_wait_for_socket(char *socket_name) {
        if (!uwsgi.wait_for_socket_timeout) {
                uwsgi.wait_for_socket_timeout = 60;
        }
        uwsgi_log("waiting for %s (max %d seconds) ...\n", socket_name, uwsgi.wait_for_socket_timeout);
        int counter = 0;
        for (;;) {
                if (counter > uwsgi.wait_for_socket_timeout) {
                        uwsgi_log("%s unavailable after %d seconds\n", socket_name, counter);
                        return -1;
                }
		// wait for 1 second to respect uwsgi.wait_for_fs_timeout
		int fd = uwsgi_connect(socket_name, 1, 0);
		if (fd < 0) goto retry;
		close(fd);
                uwsgi_log_verbose("%s ready\n", socket_name);
                return 0;
retry:
                sleep(1);
                counter++;
        }
	return -1;
}
