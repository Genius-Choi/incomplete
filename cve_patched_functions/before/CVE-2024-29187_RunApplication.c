static HRESULT RunApplication(
    __in BURN_ENGINE_STATE* pEngineState,
    __out BOOL* pfReloadApp,
    __out BOOL* pfSkipCleanup
    )
{
    HRESULT hr = S_OK;
    BOOTSTRAPPER_ENGINE_CONTEXT engineContext = { };
    BOOL fStartupCalled = FALSE;
    BOOTSTRAPPER_SHUTDOWN_ACTION shutdownAction = BOOTSTRAPPER_SHUTDOWN_ACTION_NONE;
    BOOTSTRAPPER_ENGINE_ACTION* pAction = NULL;

    // Setup the bootstrapper engine.
    engineContext.pEngineState = pEngineState;

    ::InitializeCriticalSection(&engineContext.csQueue);

    engineContext.hQueueSemaphore = ::CreateSemaphoreW(NULL, 0, LONG_MAX, NULL);
    ExitOnNullWithLastError(engineContext.hQueueSemaphore, hr, "Failed to create semaphore for queue.");

    hr = QueCreate(&engineContext.hQueue);
    ExitOnFailure(hr, "Failed to create queue for bootstrapper engine.");

    // Load the bootstrapper application.
    hr = UserExperienceLoad(&pEngineState->userExperience, &engineContext, &pEngineState->command);
    ExitOnFailure(hr, "Failed to load BA.");

    fStartupCalled = TRUE;
    hr = UserExperienceOnStartup(&pEngineState->userExperience);
    ExitOnFailure(hr, "Failed to start bootstrapper application.");

    while (!pEngineState->fQuit)
    {
        hr = AppWaitForSingleObject(engineContext.hQueueSemaphore, INFINITE);
        ExitOnFailure(hr, "Failed to wait on queue event.");

        ::EnterCriticalSection(&engineContext.csQueue);

        hr = QueDequeue(engineContext.hQueue, reinterpret_cast<void**>(&pAction));

        ::LeaveCriticalSection(&engineContext.csQueue);

        ExitOnFailure(hr, "Failed to dequeue action.");

        ProcessMessage(&engineContext, pAction);

        CoreBootstrapperEngineActionUninitialize(pAction);
        MemFree(pAction);
    }

LExit:
    if (fStartupCalled)
    {
        UserExperienceOnShutdown(&pEngineState->userExperience, &shutdownAction);
        if (BOOTSTRAPPER_SHUTDOWN_ACTION_RESTART == shutdownAction)
        {
            LogId(REPORT_STANDARD, MSG_BA_REQUESTED_RESTART, LoggingBoolToString(pEngineState->fRestart));
            pEngineState->fRestart = TRUE;
        }
        else if (BOOTSTRAPPER_SHUTDOWN_ACTION_RELOAD_BOOTSTRAPPER == shutdownAction)
        {
            LogId(REPORT_STANDARD, MSG_BA_REQUESTED_RELOAD);
            *pfReloadApp = SUCCEEDED(hr);
        }
        else if (BOOTSTRAPPER_SHUTDOWN_ACTION_SKIP_CLEANUP == shutdownAction)
        {
            LogId(REPORT_STANDARD, MSG_BA_REQUESTED_SKIP_CLEANUP);
            *pfSkipCleanup = TRUE;
        }
    }

    // Unload BA.
    UserExperienceUnload(&pEngineState->userExperience, *pfReloadApp);

    ::DeleteCriticalSection(&engineContext.csQueue);
    ReleaseHandle(engineContext.hQueueSemaphore);
    ReleaseQueue(engineContext.hQueue, FreeQueueItem, &engineContext);

    return hr;
}
