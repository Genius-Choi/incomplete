static ssize_t comp_write(zckCtx *zck, const char *src, const size_t src_size) {
    VALIDATE_WRITE_INT(zck);

    if(src_size == 0)
        return 0;

    char *dst = NULL;
    size_t dst_size = 0;
    if(zck->comp.compress(zck, &(zck->comp), src, src_size, &dst,
                          &dst_size, 1) < 0)
        return -1;
    zck->comp.dc_data_size += src_size;

    if(zck->no_write == 0 && dst_size > 0 && !write_data(zck, zck->temp_fd, dst, dst_size)) {
        free(dst);
        return -1;
    }
    if(!index_add_to_chunk(zck, dst, dst_size, src_size)) {
        free(dst);
        return -1;
    }
    if(zck->has_uncompressed_source && !hash_update(zck, &(zck->work_index_hash_uncomp), src, src_size))
        return -1;
    free(dst);
    return src_size;
}
