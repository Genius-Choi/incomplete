ssize_t ConnectionImpl::packMetadata(int32_t stream_id, uint8_t* buf, size_t len) {
  ENVOY_CONN_LOG(trace, "pack METADATA frame on stream {}", connection_, stream_id);

  StreamImpl* stream = getStream(stream_id);
  ASSERT(stream != nullptr);

  MetadataEncoder& encoder = stream->getMetadataEncoder();
  const uint64_t payload_size = encoder.packNextFramePayload(buf, len);
  return static_cast<ssize_t>(payload_size);
}
