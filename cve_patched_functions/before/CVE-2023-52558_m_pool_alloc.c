m_pool_alloc(struct pool *pp, int flags, int *slowdown)
{
	void *v;

	if (atomic_add_long_nv(&mbuf_mem_alloc, pp->pr_pgsize) > mbuf_mem_limit)
		goto fail;

	v = (*pool_allocator_multi.pa_alloc)(pp, flags, slowdown);
	if (v != NULL)
		return (v);

 fail:
	atomic_sub_long(&mbuf_mem_alloc, pp->pr_pgsize);
	return (NULL);
}
