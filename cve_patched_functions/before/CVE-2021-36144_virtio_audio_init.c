virtio_audio_init(struct vmctx *ctx, struct pci_vdev *dev, char *opts)
{
	struct virtio_audio *virt_audio;

	pthread_mutexattr_t attr;
	int rc;

	virt_audio = calloc(1, sizeof(struct virtio_audio));
	if (!virt_audio) {
		WPRINTF(("virtio_audio: calloc returns NULL\n"));
		return -1;
	}
	virt_audio->vbs_k.kstatus = VIRTIO_DEV_INITIAL;
	virt_audio->vbs_k.audio_fd = -1;

	/* init mutex attribute properly */
	rc = pthread_mutexattr_init(&attr);
	if (rc)
		DPRINTF(("mutexattr init failed with erro %d!\n", rc));

	if (virtio_uses_msix()) {
		rc = pthread_mutexattr_settype(&attr, PTHREAD_MUTEX_DEFAULT);
		if (rc)
			DPRINTF(("virtio_msix: mutexattr_settype "
				 "failed with error %d!\n", rc));
	} else {
		rc = pthread_mutexattr_settype(&attr, PTHREAD_MUTEX_RECURSIVE);
		if (rc)
			DPRINTF(("virtio_intx: mutexattr_settype "
				 "failed with error %d!\n", rc));
	}

	rc = pthread_mutex_init(&virt_audio->mtx, &attr);
	if (rc)
		DPRINTF(("mutex init failed with error %d!\n", rc));

	virtio_linkup(&virt_audio->base,
		      &virtio_audio_ops_k,
		      virt_audio,
		      dev,
		      virt_audio->vq,
		      BACKEND_VBSK);

	rc = virtio_audio_kernel_init(virt_audio);
	if (rc < 0) {
		WPRINTF(("virtio_audio: VBS-K init failed,error %d!\n", rc));
		virt_audio->vbs_k.kstatus = VIRTIO_DEV_INIT_FAILED;
		free(virt_audio);
		return -1;
	}
	virt_audio->vbs_k.kstatus = VIRTIO_DEV_INIT_SUCCESS;
	virt_audio->base.mtx = &virt_audio->mtx;

	/* vq[0] and vq[1] are for interrupt and messages */
	virt_audio->vq[0].qsize = VIRTIO_AUDIO_RINGSZ;
	virt_audio->vq[1].qsize = VIRTIO_AUDIO_RINGSZ;
	virt_audio->vq[2].qsize = VIRTIO_AUDIO_RINGSZ;
	virt_audio->vq[3].qsize = VIRTIO_AUDIO_RINGSZ;

	/* initialize config space */
	pci_set_cfgdata16(dev, PCIR_DEVICE, VIRTIO_DEV_AUDIO);
	pci_set_cfgdata16(dev, PCIR_VENDOR, INTEL_VENDOR_ID);
	pci_set_cfgdata8(dev, PCIR_CLASS, PCIC_MULTIMEDIA);
	pci_set_cfgdata8(dev, PCIR_SUBCLASS, PCIS_MULTIMEDIA_AUDIO);
	pci_set_cfgdata16(dev, PCIR_SUBDEV_0, VIRTIO_TYPE_AUDIO);
	pci_set_cfgdata16(dev, PCIR_SUBVEND_0, INTEL_VENDOR_ID);

	if (virtio_interrupt_init(&virt_audio->base, virtio_uses_msix())) {
		free(virt_audio);
		return -1;
	}
	virtio_set_io_bar(&virt_audio->base, 0);

	return 0;
}
