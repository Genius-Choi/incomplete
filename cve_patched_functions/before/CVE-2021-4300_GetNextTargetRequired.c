uint GetNextTargetRequired(const CBlockIndex* pindexLast, bool fProofOfStake,
  bool fPrettyPrint) {
    CBigNum bnTargetLimit, bnNew;

    /* Separate range limits */
    if(fTestNet) {
        if(fProofOfStake) bnTargetLimit = bnProofOfStakeLimitTestNet;
        else bnTargetLimit = bnProofOfWorkLimitTestNet;
    } else {
        if(fProofOfStake) bnTargetLimit = bnProofOfStakeLimit;
        else bnTargetLimit = bnProofOfWorkLimit;
    }

    /* The genesis block */
    if(pindexLast == NULL) return(bnTargetLimit.GetCompact());
    const CBlockIndex* pindexPrev = GetLastBlockIndex(pindexLast, fProofOfStake);
    /* The 1st block */
    if(pindexPrev->pprev == NULL) return(bnTargetLimit.GetCompact());
    const CBlockIndex* pindexPrevPrev = GetLastBlockIndex(pindexPrev->pprev, fProofOfStake);
    /* The 2nd block */
    if(pindexPrevPrev->pprev == NULL) return(bnTargetLimit.GetCompact());
    /* The next block */
    int nHeight = pindexLast->nHeight + 1;

    if(!fTestNet && (nHeight < nForkOne)) {

        /* Legacy every block retargets of the PPC style */

        int64 nTargetTimespan = 20 * 60;
        int64 nTargetSpacing = 2 * nBaseTargetSpacing;
        int64 nInterval, nActualSpacing;

        nActualSpacing = (int64)pindexPrev->nTime - (int64)pindexPrevPrev->nTime;
        if(nActualSpacing < 0)
          nActualSpacing = nTargetSpacing;

        if(fPrettyPrint) {
            fProofOfStake? printf("RETARGET PoS ") : printf("RETARGET PoW ");
            printf("heights: pindexLast = %d, pindexPrev = %d, pindexPrevPrev = %d\n",
              pindexLast->nHeight, pindexPrev->nHeight, pindexPrevPrev->nHeight);
            printf("RETARGET time stamps: pindexLast = %u, pindexPrev = %u, pindexPrevPrev = %u\n",
              pindexLast->nTime, pindexPrev->nTime, pindexPrevPrev->nTime);
        }

        nInterval = nTargetTimespan / nTargetSpacing;

        bnNew.SetCompact(pindexPrev->nBits);
        bnNew *= ((nInterval - 1) * nTargetSpacing + nActualSpacing + nActualSpacing);
        bnNew /= ((nInterval + 1) * nTargetSpacing);

        if((bnNew <= 0) || (bnNew > bnTargetLimit))
          bnNew = bnTargetLimit;

        if(fPrettyPrint)
          printf("RETARGET nTargetTimespan = %"PRI64d", nTargetSpacing = %"PRI64d", "
            "nInterval = %"PRI64d"\n", nTargetTimespan, nTargetSpacing, nInterval);

    } else {

        if(!fTestNet) {
            /* The hard fork to NeoScrypt */
            if(!fNeoScrypt) fNeoScrypt = true;
            /* PoW difficulty reset after the switch */
            if(!fProofOfStake && (pindexPrev->nHeight < nForkOne))
              return(bnNeoScryptSwitch.GetCompact());
        }

        /* Orbitcoin Super Shield (OSS);
         * retargets every block using two averaging windows of 5 and 20 blocks,
         * 0.25 damping and +1% to -2% limiting */

        int64 nIntervalShort = 5, nIntervalLong = 20, nTargetSpacing, nTargetTimespan,
              nActualTimespan, nActualTimespanShort, nActualTimespanLong, nActualTimespanAvg,
              nActualTimespanMax, nActualTimespanMin;
        uint i;

        if(fProofOfStake)
          nTargetSpacing = 5 * nBaseTargetSpacing;
        else
          nTargetSpacing = 20 * nBaseTargetSpacing;

        nTargetTimespan = nTargetSpacing * nIntervalLong;

        /* The short averaging window */
        const CBlockIndex* pindexShort = pindexPrev;
        for(i = 0; i < nIntervalShort; i++) {
            if(pindexShort->pprev)
              pindexShort = GetLastBlockIndex(pindexShort->pprev, fProofOfStake);
            else
              return(bnTargetLimit.GetCompact());
        }
        nActualTimespanShort = (int64)pindexPrev->nTime - (int64)pindexShort->nTime;

        /* The long averaging window */
        const CBlockIndex* pindexLong = pindexShort;
        for(i = 0; i < (nIntervalLong - nIntervalShort); i++) {
           if(pindexLong->pprev)
             pindexLong = GetLastBlockIndex(pindexLong->pprev, fProofOfStake);
           else
             return(bnTargetLimit.GetCompact());
        }
        nActualTimespanLong = (int64)pindexPrev->nTime - (int64)pindexLong->nTime;

        /* Time warp protection */
        nActualTimespanShort = max(nActualTimespanShort, (nTargetSpacing * nIntervalShort * 3 / 4));
        nActualTimespanShort = min(nActualTimespanShort, (nTargetSpacing * nIntervalShort * 4 / 3));
        nActualTimespanLong  = max(nActualTimespanLong,  (nTargetSpacing * nIntervalLong  * 3 / 4));
        nActualTimespanLong  = min(nActualTimespanLong,  (nTargetSpacing * nIntervalLong  * 4 / 3));

        /* The average of both windows */
        nActualTimespanAvg = (nActualTimespanShort * (nIntervalLong / nIntervalShort) + nActualTimespanLong) / 2;

        /* 0.25 damping */
        nActualTimespan = nActualTimespanAvg + 3 * nTargetTimespan;
        nActualTimespan /= 4;

        if(fPrettyPrint) {
            fProofOfStake? printf("RETARGET PoS ") : printf("RETARGET PoW ");
            printf("heights: Last = %d, Prev = %d, Short = %d, Long = %d\n",
              pindexLast->nHeight, pindexPrev->nHeight, pindexShort->nHeight, pindexLong->nHeight);
            printf("RETARGET time stamps: Last = %u, Prev = %u, Short = %u, Long = %u\n",
              pindexLast->nTime, pindexPrev->nTime, pindexShort->nTime, pindexLong->nTime);
            printf("RETARGET windows: short = %"PRI64d" (%"PRI64d"), long = %"PRI64d", "
              "average = %"PRI64d", damped = %"PRI64d"\n",
              nActualTimespanShort, nActualTimespanShort * (nIntervalLong / nIntervalShort),
              nActualTimespanLong, nActualTimespanAvg, nActualTimespan);
        }

        /* Difficulty limiters */
        nActualTimespanMax = nTargetTimespan * 102 / 100;
        nActualTimespanMin = nTargetTimespan * 100 / 101;
        if(nActualTimespan < nActualTimespanMin) nActualTimespan = nActualTimespanMin;
        if(nActualTimespan > nActualTimespanMax) nActualTimespan = nActualTimespanMax;

        /* Retarget */
        bnNew.SetCompact(pindexPrev->nBits);
        bnNew *= nActualTimespan;
        bnNew /= nTargetTimespan;

        if((bnNew <= 0) || (bnNew > bnTargetLimit))
          bnNew = bnTargetLimit;

        if(fPrettyPrint)
          printf("RETARGET nTargetTimespan = %"PRI64d", nActualTimespan = %"PRI64d", "
            "nTargetTimespan / nActualTimespan = %.4f\n",
            nTargetTimespan, nActualTimespan, (float)nTargetTimespan / (float)nActualTimespan);

    }

    if(fPrettyPrint) {
        printf("Before: %08x  %s\n", pindexPrev->nBits,
          CBigNum().SetCompact(pindexPrev->nBits).getuint256().ToString().c_str());
        printf("After:  %08x  %s\n", bnNew.GetCompact(), bnNew.getuint256().ToString().c_str());
    }

    return(bnNew.GetCompact());
}
