qboolean FS_WriteToTemporaryFile( const void *data, size_t dataLength, char **tempFilePath )
{
#if defined(_WIN32)
	DWORD error;
	TCHAR tempPath[MAX_PATH];
	DWORD tempPathResult = GetTempPath(MAX_PATH, tempPath);
	if ( tempPathResult )
	{
		TCHAR tempFileName[MAX_PATH];
		UINT tempFileNameResult = GetTempFileName(tempPath, "OJK", 0, tempFileName);
		if ( tempFileNameResult )
		{
			HANDLE file = CreateFile(
				tempFileName, GENERIC_WRITE, 0, NULL,
				CREATE_ALWAYS, FILE_ATTRIBUTE_NORMAL, 0);
			if ( file != INVALID_HANDLE_VALUE )
			{
				DWORD bytesWritten = 0;
				if (WriteFile(file, data, dataLength, &bytesWritten, NULL))
				{
					int deletesRemaining = ARRAY_LEN(fs_temporaryFileNames);

					CloseHandle(file);

					while ( deletesRemaining > 0 &&
							fs_temporaryFileNames[fs_temporaryFileWriteIdx][0] != '\0' )
					{
						// Delete old temporary file as we need to
						if ( DeleteFile(fs_temporaryFileNames[fs_temporaryFileWriteIdx]) )
						{
							break;
						}

						error = GetLastError();
						Com_DPrintf("FS_WriteToTemporaryFile failed for '%s'. "
									"Win32 error code: 0x%08x\n",
									fs_temporaryFileNames[fs_temporaryFileWriteIdx],
									error);

						// Failed to delete, possibly because DLL was still in use. This can
						// happen when running a listen server and you continually restart
						// the map. The game DLL is reloaded, but cgame and ui DLLs are not.
						fs_temporaryFileWriteIdx =
							(fs_temporaryFileWriteIdx + 1) % ARRAY_LEN(fs_temporaryFileNames);
						deletesRemaining--;
					}

					// If this happened, then all slots are used and we some how have 8 DLLs
					// loaded at once?!
					assert(deletesRemaining > 0);

					Q_strncpyz(fs_temporaryFileNames[fs_temporaryFileWriteIdx],
								tempFileName, sizeof(fs_temporaryFileNames[0]));
					fs_temporaryFileWriteIdx =
						(fs_temporaryFileWriteIdx + 1) % ARRAY_LEN(fs_temporaryFileNames);

					if ( tempFilePath )
					{
						size_t fileNameLen = strlen(tempFileName);
						*tempFilePath = (char *)Z_Malloc(fileNameLen + 1, TAG_FILESYS);
						Q_strncpyz(*tempFilePath, tempFileName, fileNameLen + 1);
					}

					return qtrue;
				}
				else
				{
					error = GetLastError();
					Com_DPrintf("FS_WriteToTemporaryFile failed to write '%s'. "
								"Win32 error code: 0x%08x\n",
								tempFileName, error);
				}
			}
			else
			{
				error = GetLastError();
				Com_DPrintf("FS_WriteToTemporaryFile failed to create '%s'. "
							"Win32 error code: 0x%08x\n",
							tempFileName, error);
			}
		}
		else
		{
			error = GetLastError();
			Com_DPrintf("FS_WriteToTemporaryFile failed to generate temporary file name. "
						"Win32 error code: 0x%08x\n", error);
		}
	}
	else
	{
		error = GetLastError();
		Com_DPrintf("FS_WriteToTemporaryFile failed to get temporary file folder. "
						"Win32 error code: 0x%08x\n", error);
	}
#endif

	return qfalse;
}
