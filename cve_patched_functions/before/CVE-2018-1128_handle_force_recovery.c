void OSD::handle_force_recovery(Message *m)
{
  MOSDForceRecovery *msg = static_cast<MOSDForceRecovery*>(m);
  assert(msg->get_type() == MSG_OSD_FORCE_RECOVERY);

  vector<PGRef> local_pgs;
  local_pgs.reserve(msg->forced_pgs.size());

  {
    RWLock::RLocker l(pg_map_lock);
    for (auto& i : msg->forced_pgs) {
      spg_t locpg;
      if (osdmap->get_primary_shard(i, &locpg)) {
	auto pg_map_entry = pg_map.find(locpg);
	if (pg_map_entry != pg_map.end()) {
	  local_pgs.push_back(pg_map_entry->second);
	}
      }
    }
  }

  if (local_pgs.size()) {
    service.adjust_pg_priorities(local_pgs, msg->options);
  }

  msg->put();
}
