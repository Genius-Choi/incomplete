json_stack_push(struct json_stack *stack, struct json_item_list *items,
    struct json_object *frame, enum json_value_type type, char *name,
    unsigned int lineno)
{
    struct json_item *item;
    debug_decl(json_stack_push, SUDO_DEBUG_UTIL);

    /* We limit the stack size rather than expanding it. */
    if (stack->depth >= stack->maxdepth) {
	sudo_warnx(U_("json stack exhausted (max %u frames)"), stack->maxdepth);
	debug_return_ptr(NULL);
    }

    /* Allocate a new item and insert it into the list. */
    if ((item = new_json_item(type, name, lineno)) == NULL)
	debug_return_ptr(NULL);
    TAILQ_INIT(&item->u.child.items);
    item->u.child.parent = item;
    TAILQ_INSERT_TAIL(items, item, entries);

    /* Push the current frame onto the stack (depth check performed above). */
    stack->frames[stack->depth++] = frame;

    /* Return the new frame */
    debug_return_ptr(&item->u.child);
}
