setup_document_index(EpubDocument *epub_document,gchar *containeruri)
{
    GString *tocpath = g_string_new(epub_document->documentdir);
    gchar *tocfilename = get_toc_file_name(containeruri);
    GList *index = NULL;

    if (tocfilename == NULL) {
        tocfilename = epub_document_get_nav_file(containeruri);

        //Apparently, sometimes authors don't even care to add a TOC!! Guess standards are just guidelines.

        if (tocfilename == NULL) {
            //We didn't even find a nav file.The document has no TOC.
            g_string_free(tocpath,TRUE);
            return NULL;
        }

        g_string_append_printf (tocpath,"/%s",tocfilename);
        index = setup_index_from_navfile(tocpath->str);
        g_string_free(tocpath,TRUE);
        g_free (tocfilename);
        return index;
    }

    g_string_append_printf (tocpath,"/%s",tocfilename);
    g_free (tocfilename);

    GString *pagelink;
    open_xml_document(tocpath->str);
    g_string_free(tocpath,TRUE);
    set_xml_root_node((xmlChar*)"ncx");

    xmlNodePtr docTitle = xml_get_pointer_to_node((xmlChar*)"docTitle",NULL,NULL);
    xmlretval = NULL;
    xml_parse_children_of_node(docTitle,(xmlChar*)"text",NULL,NULL);

    while (epub_document->docTitle == NULL && xmlretval != NULL) {
        epub_document->docTitle = (gchar*)xml_get_data_from_node(xmlretval,XML_KEYWORD,NULL);
        xmlretval = xmlretval->next;
    }
    xmlNodePtr navMap = xml_get_pointer_to_node((xmlChar*)"navMap",NULL,NULL);
    xmlretval = NULL;
    xml_parse_children_of_node(navMap,(xmlChar*)"navPoint",NULL,NULL);

    xmlNodePtr navPoint = xmlretval;

    while(navPoint != NULL) {

        if ( !xmlStrcmp(navPoint->name,(xmlChar*)"navPoint")) {
            xmlretval = NULL;
            xml_parse_children_of_node(navPoint,(xmlChar*)"navLabel",NULL,NULL);
            xmlNodePtr navLabel = xmlretval;
            xmlretval = NULL;
            gchar *fragment=NULL,*end=NULL;
            GString *uri = NULL;

            xml_parse_children_of_node(navLabel,(xmlChar*)"text",NULL,NULL);
            linknode *newnode = g_new0(linknode,1);
            newnode->linktext = NULL;
            while (newnode->linktext == NULL) {
                newnode->linktext = (gchar*)xml_get_data_from_node(xmlretval,XML_KEYWORD,NULL);
                xmlretval = xmlretval->next;
            }
            xmlretval = NULL;
            xml_parse_children_of_node(navPoint,(xmlChar*)"content",NULL,NULL);
            pagelink = g_string_new(epub_document->documentdir);
            newnode->pagelink = (gchar*)xml_get_data_from_node(xmlretval,XML_ATTRIBUTE,(xmlChar*)"src");
            g_string_append_printf(pagelink,"/%s",newnode->pagelink);
            xmlFree(newnode->pagelink);

            gchar *escaped = g_strdup(pagelink->str);

            //unescaping any special characters
            pagelink->str = g_uri_unescape_string (escaped,NULL);
            g_free(escaped);

            if ((end = g_strrstr(pagelink->str,"#")) != NULL) {
                fragment = g_strdup(g_strrstr(pagelink->str,"#"));
                *end = '\0';
            }
            uri = g_string_new(g_filename_to_uri(pagelink->str,NULL,NULL));
            g_string_free(pagelink,TRUE);

            if (fragment) {
                g_string_append(uri,fragment);
            }

            newnode->pagelink = g_strdup(uri->str);
            g_string_free(uri,TRUE);
            index = g_list_prepend(index,newnode);
        }

        navPoint = navPoint->next;

    }

    xml_free_doc();

    return g_list_reverse(index);
}
