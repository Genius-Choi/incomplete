upb_Message* Message_deep_copy(const upb_Message* msg, const upb_MessageDef* m,
                               upb_Arena* arena) {
  // Serialize and parse.
  upb_Arena* tmp_arena = upb_Arena_New();
  const upb_MiniTable* layout = upb_MessageDef_MiniTable(m);
  size_t size;

  char* data = upb_Encode(msg, layout, 0, tmp_arena, &size);
  upb_Message* new_msg = upb_Message_New(m, arena);

  if (!data || upb_Decode(data, size, new_msg, layout, NULL, 0, arena) !=
                   kUpb_DecodeStatus_Ok) {
    upb_Arena_Free(tmp_arena);
    rb_raise(cParseError, "Error occurred copying proto");
  }

  upb_Arena_Free(tmp_arena);
  return new_msg;
}
