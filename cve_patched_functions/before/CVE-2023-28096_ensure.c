static unsigned char* ensure(printbuffer *p, size_t needed)
{
    unsigned char *newbuffer = NULL;
    size_t newsize = 0;
	int written;
	int flushed = 0;

    if (needed > INT_MAX)
    {
        /* sizes bigger than INT_MAX are currently not supported */
        return NULL;
    }

    if (!p || !p->buffer)
    {
        return NULL;
    }

retry:
    if (p->offset + needed <= p->length)
    {
        return p->buffer + p->offset;
    }

    if (p->noalloc) {
		if (!p->flush)
			return NULL;
		/* we will try to flush everything, so we can re-use the same buffer */
		if (flushed)
			return NULL; /* TODO: cannot flush what's in here - shall we "remember" the error? */
		written = (p->flush)(p->buffer, p->offset, p->flush_p);
		if (written <= 0)
			return NULL;
		memmove(p->buffer, p->buffer + written, p->offset - written);
		p->offset -= written;
		flushed = 1;
		goto retry;
    }

    needed += p->offset;
    newsize = (size_t) pow2gt((int)needed);
    newbuffer = (unsigned char*)cJSON_malloc(newsize);
    if (!newbuffer)
    {
        cJSON_free(p->buffer);
        p->length = 0;
        p->buffer = NULL;

        return NULL;
    }
    if (newbuffer)
    {
        memcpy(newbuffer, p->buffer, p->length);
    }
    cJSON_free(p->buffer);
    p->length = newsize;
    p->buffer = newbuffer;

    return newbuffer + p->offset;
}
