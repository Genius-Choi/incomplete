test_reload_removed (TestCase *tc,
                     gconstpointer data)
{
  const Fixture *fixture = data;
  const gchar *datadir;

  cockpit_bridge_data_dirs = (const gchar **)fixture->datadirs;
  datadir = cockpit_bridge_data_dirs[0];

  setup_reload_packages (datadir, "new");
  tc->packages = cockpit_packages_new ();

  assert_manifest_checksum (tc, NULL,  CHECKSUM_RELOAD_NEW);
  assert_manifest_checksum (tc, "old", CHECKSUM_RELOAD_NEW);
  assert_manifest_checksum (tc, "new", CHECKSUM_RELOAD_NEW);

  setup_reload_packages (datadir, "old");
  cockpit_packages_reload (tc->packages);

  assert_manifest_checksum (tc, NULL,  CHECKSUM_RELOAD_NEW);
  assert_manifest_checksum (tc, "old", CHECKSUM_RELOAD_NEW);
  assert_manifest_checksum (tc, "new", NULL);

  teardown_reload_packages (datadir);
}
