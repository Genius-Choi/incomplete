static double calc_media_experience_score(struct ast_rtp_instance *instance,
	double normdevrtt, double normdev_rxjitter, double stdev_rxjitter,
	double normdev_rxlost)
{
	double r_value;
	double pseudo_mos;
	double mes = 0;

	/*
	 * While the media itself might be okay, a significant enough delay could make
	 * for an unpleasant user experience.
	 *
	 * Calculate the effective latency by using the given round trip time, and adding
	 * jitter scaled according to its standard deviation. The scaling is done in order
	 * to increase jitter's weight since a higher deviation can result in poorer overall
	 * quality.
	 */
	double effective_latency = (normdevrtt * 1000)
		+ ((normdev_rxjitter * 2) * (stdev_rxjitter / 3))
		+ 10;

	/*
	 * Using the defaults for the standard transmission rating factor ("R" value)
	 * one arrives at 93.2 (see ITU-T G.107 for more details), so we'll use that
	 * as the starting value and subtract deficiencies that could affect quality.
	 *
	 * Calculate the impact of the effective latency. Influence increases with
	 * values over 160 as the significant "lag" can degrade user experience.
	 */
	if (effective_latency < 160) {
		r_value = 93.2 - (effective_latency / 40);
	} else {
		r_value = 93.2 - (effective_latency - 120) / 10;
	}

	/* Next evaluate the impact of lost packets */
	r_value = r_value - (normdev_rxlost * 2.0);

	/*
	 * Finally convert the "R" value into a opinion/quality score between 1 (really anything
	 * below 3 should be considered poor) and 4.5 (the highest achievable for VOIP).
	 */
	if (r_value < 0) {
		pseudo_mos = 1.0;
	} else if (r_value > 100) {
		pseudo_mos = 4.5;
	} else {
		pseudo_mos = 1 + (0.035 * r_value) + (r_value * (r_value - 60) * (100 - r_value) * 0.0000007);
	}

	/*
	 * We're going to rescale the 0.0->5.0 pseudo_mos to the 0.0->100.0 MES.
	 * For those ranges, we could actually just multiply the pseudo_mos
	 * by 20 but we may want to change the scale later.
	 */
	mes = RESCALE(pseudo_mos, 0.0, 5.0, 0.0, 100.0);

	return mes;
}
