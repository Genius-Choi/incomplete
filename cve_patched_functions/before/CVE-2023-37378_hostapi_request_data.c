bool CEXEBuild::hostapi_request_data(MakensisAPI::datatransfer_e operation, UINT minver, HOSTAPIREQUESTDATAPROC proc, void*cookie, const void* input, size_t inputsize) const
{
  using namespace MakensisAPI;
#ifdef _WIN32
  struct helper {
    static INT_PTR CALLBACK Proc(HWND hWnd, UINT Msg, WPARAM wParam, LPARAM lParam)
    {
      size_t *data = (size_t*) GetWindowLongPtr(hWnd, DWLP_USER);
      if (Msg == WM_CLOSE)
      {
        if (lParam) SendMessage((HWND) wParam, WM_COPYDATA, (SIZE_T) hWnd, lParam);
        return DestroyWindow(hWnd) | PostMessage(NULL, WM_QUIT, 0, 0);
      }
      return data && ((CEXEBuild::HOSTAPIREQUESTDATAPROC)data[0])((void*) data[1], hWnd, Msg, wParam, lParam); // We don't set DWLP_MSGRESULT nor care about the return value
    }
  };
  if (!notify_hwnd || (minver && (UINT) SendMessage(notify_hwnd, QUERYHOST, QH_SUPPORTEDVERSION, 0) < minver)) return false;
  size_t data[] = { (size_t) proc, (size_t) cookie };
  COPYDATASTRUCT cds = { (DWORD) operation, (DWORD) inputsize, (void*) input };
  HWND hWnd = CreateWindowEx(WS_EX_TOOLWINDOW, WC_DIALOG, NULL, WS_POPUP|WS_DISABLED, 0, 0, 0, 0, NULL, NULL, NULL, NULL);
  SetWindowLongPtr(hWnd, DWLP_USER, (LONG_PTR) data);
  SetWindowLongPtr(hWnd, DWLP_DLGPROC, (LONG_PTR) helper::Proc);
  SendMessage(hWnd, WM_CLOSE, (SIZE_T) notify_hwnd, (SIZE_T) &cds);
  if (hWnd) for (MSG msg; (int) GetMessage(&msg, NULL, 0, 0) > 0;) DispatchMessage(&msg);
  return !!hWnd;
#else
  return false;
#endif
}
