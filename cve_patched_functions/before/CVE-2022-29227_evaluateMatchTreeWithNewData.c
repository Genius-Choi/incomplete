void FilterMatchState::evaluateMatchTreeWithNewData(MatchDataUpdateFunc update_func) {
  if (match_tree_evaluated_ || !matching_data_) {
    return;
  }

  update_func(*matching_data_);

  const auto match_result = Matcher::evaluateMatch<HttpMatchingData>(*match_tree_, *matching_data_);

  match_tree_evaluated_ = match_result.match_state_ == Matcher::MatchState::MatchComplete;

  if (match_tree_evaluated_ && match_result.result_) {
    const auto result = match_result.result_();
    if (SkipAction().typeUrl() == result->typeUrl()) {
      skip_filter_ = true;
    } else {
      filter_->onMatchCallback(*result);
    }
  }
}
