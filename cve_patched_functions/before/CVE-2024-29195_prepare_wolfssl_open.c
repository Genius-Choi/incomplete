static int prepare_wolfssl_open(TLS_IO_INSTANCE* tls_io_instance)
{
    int result;

    if (enable_domain_check(tls_io_instance))
    {
        LogError("Failed to configure domain name verification");
        result = MU_FAILURE;
    }
    else if (add_certificate_to_store(tls_io_instance) != 0)
    {
        LogError("Failed to add certificates to store");
        result = MU_FAILURE;
    }
    /*x509 authentication can only be build before underlying connection is realized*/
    else if ((tls_io_instance->x509certificate != NULL) &&
        (tls_io_instance->x509privatekey != NULL) &&
        (x509_wolfssl_add_credentials(tls_io_instance->ssl, tls_io_instance->x509certificate, tls_io_instance->x509privatekey) != 0))
    {
        destroy_wolfssl_instance(tls_io_instance);
        LogError("unable to use x509 authentication");
        result = MU_FAILURE;
    }
    else
    {
        result = 0;
    }
    return result;
}
