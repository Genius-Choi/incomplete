static int read_param(void *obj)
{
	struct param_data *data = obj;
	struct ast_sip_session *session = data->channel->session;
	pj_str_t param_name;

	pjsip_fromto_hdr *dlg_info;
	pjsip_name_addr *dlg_info_name_addr;
	pjsip_sip_uri *dlg_info_uri;
	pjsip_param *param;
	size_t param_len;

	dlg_info = session->inv_session->dlg->remote.info; /* Remote dialog for incoming */
	dlg_info_name_addr = (pjsip_name_addr *) dlg_info->uri;
	dlg_info_uri = pjsip_uri_get_uri(dlg_info_name_addr);

	pj_cstr(&param_name, data->param_name);

	if (data->paramtype == PARAMETER_URI) { /* URI parameter */
		param = pjsip_param_find(&dlg_info_uri->other_param, &param_name);
	} else { /* Header parameter */
		param = pjsip_param_find(&dlg_info->other_param, &param_name);
	}

	if (!param) {
		ast_debug(1, "No %s parameter found named %s\n",
			data->paramtype == PARAMETER_URI ? "URI" : "header", data->param_name);
		return -1;
	}

	param_len = pj_strlen(&param->value);
	if (param_len >= data->len) {
		ast_log(LOG_ERROR, "Buffer is too small for parameter value (%zu > %zu)\n", param_len, data->len);
		return -1;
	}

	ast_debug(2, "Successfully read %s parameter %s (length %zu)\n",
		data->paramtype == PARAMETER_URI ? "URI" : "header", data->param_name, param_len);
	if (param_len) {
		ast_copy_string(data->buf, pj_strbuf(&param->value), data->len);
	}
	data->buf[param_len] = '\0';

	return 0;
}
