static HTTPAPI_RESULT SetProxyIfNecessary(HTTP_HANDLE_DATA* handleData, HINTERNET requestHandle)
{
    HTTPAPI_RESULT result;

    // Set proxy host if needed
    if (handleData->proxy_host != NULL)
    {
        WINHTTP_PROXY_INFO winhttp_proxy;
        wchar_t wproxy[MAX_HOSTNAME_LEN];
        winhttp_proxy.dwAccessType = WINHTTP_ACCESS_TYPE_NAMED_PROXY;
        if (mbstowcs_s(NULL, wproxy, MAX_HOSTNAME_LEN, handleData->proxy_host, MAX_HOSTNAME_LEN-1) != 0)
        {
            LogError("Error during proxy host conversion");
            result = HTTPAPI_ERROR;
        }
        else
        {
            winhttp_proxy.lpszProxy = wproxy;
            winhttp_proxy.lpszProxyBypass = NULL;
            if (WinHttpSetOption(requestHandle,
                WINHTTP_OPTION_PROXY,
                &winhttp_proxy,
                (DWORD)sizeof(WINHTTP_PROXY_INFO)) != TRUE)
            {
                LogError("failure setting proxy address (%i)", GetLastError());
                result = HTTPAPI_ERROR;
            }
            else
            {
                //Set username and password if needed
                if (handleData->proxy_username != NULL && handleData->proxy_password != NULL)
                {
                    wchar_t wusername[MAX_USERNAME_LEN];
                    if (mbstowcs_s(NULL, wusername, MAX_USERNAME_LEN, handleData->proxy_username, MAX_USERNAME_LEN-1) != 0)
                    {
                        LogError("Error during proxy username conversion");
                        result = HTTPAPI_ERROR;
                    }
                    else
                    {
                        wchar_t wpassword[MAX_PASSWORD_LEN];
                        if (mbstowcs_s(NULL, wpassword, MAX_PASSWORD_LEN, handleData->proxy_password, MAX_PASSWORD_LEN-1) != 0)
                        {
                            LogError("Error during proxy password conversion");
                            result = HTTPAPI_ERROR;
                        }
                        else
                        {
                            if (WinHttpSetCredentials(requestHandle,
                                WINHTTP_AUTH_TARGET_PROXY,
                                WINHTTP_AUTH_SCHEME_BASIC,
                                wusername,
                                wpassword,
                                NULL) != TRUE)
                            {
                                LogErrorWinHTTPWithGetLastErrorAsString("Failure setting proxy credentials");
                                result = HTTPAPI_ERROR;
                            }
                            else
                            {
                                result = HTTPAPI_OK;
                            }
                        }
                    }
                }
                else
                {
                    result = HTTPAPI_OK;
                }
            }
        }
    }
    else
    {
        result = HTTPAPI_OK;
    }

    return result;
}
