OFCondition UserIdentityNegotiationSubItemAC::stream(unsigned char *targetBuffer,
                                                     unsigned long& lengthWritten) const
{
  if (OFstatic_cast(unsigned long, m_rspLength) + 2 > (unsigned long)65535 /* for response length field */)
  {
    char errbuf[500];
    sprintf(errbuf, "Length of User Identity response (%lu bytes) exceeds upper limit of 65535 bytes", (unsigned long)m_rspLength + 2);
    return makeDcmnetCondition(ASCC_CODINGERROR, OF_error, errbuf);
  }
  // compute total length of item when streamed
  streamedLength(lengthWritten);

  *targetBuffer++ = getItemType();
  *targetBuffer++ = getReserved();
  // value for item length field is = length of response value + length of length field (2)
  COPY_SHORT_BIG(OFstatic_cast(unsigned short, 2 + m_rspLength), targetBuffer);
  targetBuffer += 2;

  COPY_SHORT_BIG(m_rspLength, targetBuffer);
  targetBuffer += 2;

  (void) memcpy(targetBuffer, m_serverRsp, m_rspLength);
  targetBuffer += m_rspLength;

  return EC_Normal;
}
