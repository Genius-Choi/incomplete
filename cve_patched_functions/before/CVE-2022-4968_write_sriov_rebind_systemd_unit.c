write_sriov_rebind_systemd_unit(GHashTable* pfs, const char* rootdir, GError** error)
{
    g_autofree gchar* id_escaped = NULL;
    g_autofree char* link = g_strjoin(NULL, rootdir ?: "", "/run/systemd/system/multi-user.target.wants/netplan-sriov-rebind.service", NULL);
    g_autofree char* path = g_strjoin(NULL, "/run/systemd/system/netplan-sriov-rebind.service", NULL);

    GHashTableIter iter;
    gpointer key;
    GString* interfaces = g_string_new("");

    GString* s = g_string_new("[Unit]\n");
    g_string_append(s, "Description=(Re-)bind SR-IOV Virtual Functions to their driver\n");
    g_string_append_printf(s, "After=network.target\n");
    g_string_append_printf(s, "After=netplan-sriov-apply.service\n");

    /* Run after udev */
    g_hash_table_iter_init(&iter, pfs);
    while (g_hash_table_iter_next (&iter, &key, NULL)) {
        const gchar* id = key;
        g_string_append_printf(s, "After=sys-subsystem-net-devices-%s.device\n", id);
        g_string_append_printf(interfaces, "%s ", id);
    }

    g_string_append(s, "\n[Service]\nType=oneshot\n");
    g_string_truncate(interfaces, interfaces->len-1); /* cut trailing whitespace */
    g_string_append_printf(s, "ExecStart=" SBINDIR "/netplan rebind --debug %s\n", interfaces->str);

    _netplan_g_string_free_to_file(s, rootdir, path, NULL);
    g_string_free(interfaces, TRUE);

    _netplan_safe_mkdir_p_dir(link);
    if (symlink(path, link) < 0 && errno != EEXIST) {
        // LCOV_EXCL_START
        g_set_error(error, NETPLAN_FILE_ERROR, errno,
                    "failed to create enablement symlink: %m");
        return FALSE;
        // LCOV_EXCL_STOP
    }
    return TRUE;
}
