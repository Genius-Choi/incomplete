ngx_pcre2_exec(ngx_regex_t*   re,
               unsigned char* str,
               unsigned int   len,
               ngx_int_t      tmp_idx,
               int*           captures,
               ngx_uint_t     size)
{
  size_t*    ov;
  ngx_int_t  rc;
  ngx_uint_t n, i;

  /*
   * The pcre2_match() function might allocate memory for backtracking
   * frames, typical allocations are from 40k and above.  So the allocator
   * is configured to do direct allocations from heap during matching.
   */

  if (ngx_pcre2_match_data == NULL || size > ngx_pcre2_match_data_size) {
    /*
     * Allocate a match data if not yet allocated or smaller than
     * needed.
     */

    if (ngx_pcre2_match_data) {
      pcre2_match_data_free(ngx_pcre2_match_data);
    }

    ngx_pcre2_match_data_size = size;
    ngx_pcre2_match_data      = pcre2_match_data_create(size / 3, NULL);

    if (ngx_pcre2_match_data == NULL) {
      rc = PCRE2_ERROR_NOMEMORY;
      goto failed;
    }
  }

  rc = pcre2_match(re, str, len, tmp_idx, 0, ngx_pcre2_match_data, NULL);

  if (rc < 0) {
    goto failed;
  }

  n  = pcre2_get_ovector_count(ngx_pcre2_match_data);
  ov = pcre2_get_ovector_pointer(ngx_pcre2_match_data);

  if (n > size / 3) {
    n = size / 3;
  }

  for (i = 0; i < n; i++) {
    captures[i * 2]     = ov[i * 2];
    captures[i * 2 + 1] = ov[i * 2 + 1];
  }

failed:

  return rc;
}
