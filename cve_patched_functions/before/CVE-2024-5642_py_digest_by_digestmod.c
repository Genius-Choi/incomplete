py_digest_by_digestmod(PyObject *module, PyObject *digestmod) {
    const EVP_MD* evp;
    PyObject *name_obj = NULL;
    const char *name;

    if (PyUnicode_Check(digestmod)) {
        name_obj = digestmod;
    } else {
        _hashlibstate *state = get_hashlib_state(module);
        // borrowed ref
        name_obj = PyDict_GetItem(state->constructs, digestmod);
    }
    if (name_obj == NULL) {
        _hashlibstate *state = get_hashlib_state(module);
        PyErr_Clear();
        PyErr_Format(
            state->unsupported_digestmod_error,
            "Unsupported digestmod %R", digestmod);
        return NULL;
    }

    name = PyUnicode_AsUTF8(name_obj);
    if (name == NULL) {
        return NULL;
    }

    evp = py_digest_by_name(name);
    if (evp == NULL) {
        return NULL;
    }

    return evp;
}
