MOBI_RET mobi_get_embedded_source(unsigned char **data, size_t *size, const MOBIData *m) {
    *data = NULL;
    *size = 0;
    if (m == NULL) {
        return MOBI_INIT_FAILED;
    }
    MOBIMobiHeader *header = m->mh;
    if (mobi_is_hybrid(m) && m->use_kf8 && m->next) {
        /* SRCS index is in KF7 header */
        header = m->next->mh;
    }
    if (header == NULL || header->srcs_index == NULL || header->srcs_count == NULL ||
        *header->srcs_index == MOBI_NOTSET || *header->srcs_count == 0) {
        return MOBI_SUCCESS;
    }
    uint32_t index = *header->srcs_index;
    
    const MOBIPdbRecord *srcs_record = mobi_get_record_by_seqnumber(m, index);
    if (srcs_record == NULL) {
        return MOBI_SUCCESS;
    }
    const size_t archive_offset = 16;
    
    if (srcs_record->size <= archive_offset) {
        debug_print("Wrong size of SRCS resource: %zu\n", srcs_record->size);
        return MOBI_DATA_CORRUPT;
    }

    if (memcmp(srcs_record->data, SRCS_MAGIC, 4) != 0) {
        debug_print("Wrong magic for SRCS resource: %c%c%c%c\n",
                    srcs_record->data[0], srcs_record->data[1], srcs_record->data[2], srcs_record->data[3]);
        return MOBI_DATA_CORRUPT;
    }
    
    *data = srcs_record->data + archive_offset;
    *size = srcs_record->size - archive_offset;

    return MOBI_SUCCESS;
}
