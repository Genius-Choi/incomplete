int r_jws_verify_signature(jws_t * jws, jwk_t * jwk_pubkey, int x5u_flags) {
  int ret, res;
  jwk_t * jwk = NULL, * cur_jwk;
  const char * kid;
  json_t * j_signature = NULL, * j_header;
  size_t index = 0, i;

  if (jws != NULL) {
    if (jwk_pubkey != NULL) {
      jwk = r_jwk_copy(jwk_pubkey);
    } else {
      if ((kid = r_jws_get_header_str_value(jws, "kid")) != NULL || (jws->token_mode == R_JSON_MODE_FLATTENED && (kid = json_string_value(json_object_get(json_object_get(jws->j_json_serialization, "header"), "kid"))) != NULL)) {
        jwk = r_jwks_get_by_kid(jws->jwks_pubkey, kid);
      } else if (r_jwks_size(jws->jwks_pubkey) == 1) {
        jwk = r_jwks_get_at(jws->jwks_pubkey, 0);
      }
    }
  }

  if (jws != NULL) {
    if (jws->token_mode == R_JSON_MODE_GENERAL) {
      ret = RHN_ERROR_INVALID;
      o_free(jws->header_b64url);
      o_free(jws->signature_b64url);
      json_array_foreach(json_object_get(jws->j_json_serialization, "signatures"), index, j_signature) {
        jws->header_b64url = (unsigned char *)json_string_value(json_object_get(j_signature, "protected"));
        jws->signature_b64url = (unsigned char *)json_string_value(json_object_get(j_signature, "signature"));
        kid = json_string_value(json_object_get(json_object_get(j_signature, "header"), "kid"));
        if ((j_header = r_jws_parse_protected((const unsigned char *)json_string_value(json_object_get(j_signature, "protected")))) != NULL) {
          res = r_jws_extract_header(jws, j_header, R_PARSE_NONE, x5u_flags);
          json_decref(j_header);
          if (res == RHN_OK) {
            if (!o_strnullempty(kid)) {
              if (jwk_pubkey != NULL) {
                ret = _r_verify_signature(jws, jwk, jws->alg, x5u_flags);
              } else {
                if ((cur_jwk = r_jwks_get_by_kid(jws->jwks_pubkey, kid)) != NULL) {
                  ret = _r_verify_signature(jws, cur_jwk, jws->alg, x5u_flags);
                  r_jwk_free(cur_jwk);
                }
              }
              if (ret != RHN_ERROR_INVALID) {
                break;
              }
            } else {
              if (jwk_pubkey != NULL) {
                if ((ret = _r_verify_signature(jws, jwk_pubkey, jws->alg, x5u_flags)) != RHN_ERROR_INVALID) {
                  break;
                }
              } else if (r_jwks_size(jws->jwks_pubkey)) {
                for (i=0; i<r_jwks_size(jws->jwks_pubkey); i++) {
                  cur_jwk = r_jwks_get_at(jws->jwks_pubkey, i);
                  ret = _r_verify_signature(jws, cur_jwk, jws->alg, x5u_flags);
                  r_jwk_free(cur_jwk);
                  if (ret != RHN_ERROR_INVALID) {
                    break;
                  }
                }
                if (ret != RHN_ERROR_INVALID) {
                  break;
                }
              }
            }
          } else {
            ret = RHN_ERROR;
            break;
          }
        } else {
          ret = RHN_ERROR;
          break;
        }
      }
      jws->header_b64url = NULL;
      jws->signature_b64url = NULL;
    } else {
      if (r_jws_set_token_values(jws, 0) == RHN_OK && jws->signature_b64url != NULL) {
        if (jwk != NULL) {
          ret = _r_verify_signature(jws, jwk, jws->alg, x5u_flags);
        } else {
          ret = RHN_ERROR_INVALID;
        }
      } else {
        ret = RHN_ERROR_PARAM;
      }
    }
  } else {
    ret = RHN_ERROR_PARAM;
  }
  r_jwk_free(jwk);
  return ret;
}
