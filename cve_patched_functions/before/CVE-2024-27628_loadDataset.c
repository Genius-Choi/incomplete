OFCondition EctEnhancedCT::loadDataset(DcmDataset& dataset, EctEnhancedCT*& ct)
{
    OFCondition result;
    OFString sopClass;
    if (dataset.findAndGetOFStringArray(DCM_SOPClassUID, sopClass).good())
    {
        if (sopClass == UID_EnhancedCTImageStorage)
        {
            result = decompress(dataset);
            if (result.good())
            {

                DcmElement* elem = NULL;
                if (dataset.findAndGetElement(DCM_PixelData, elem).good())
                {
                    Uint16 pr = 0;
                    if (dataset.findAndGetUint16(DCM_PixelRepresentation, pr).good())
                    {
                        if (pr == 0)
                        {
                            ct = new EctEnhancedCT(OFin_place<IODImagePixelModule<Uint16> >);
                        }
                        else
                        {
                            ct = new EctEnhancedCT(OFin_place<IODImagePixelModule<Sint16> >);
                        }
                    }
                    else
                    {
                        DCMECT_WARN("Pixel Data element found but no Pixel Presentation set, assuming 16 bit unsigned "
                                    "integer data");
                        ct = new EctEnhancedCT(OFin_place<IODImagePixelModule<Uint16> >);
                    }
                }
                else
                {
                    return ECT_NoPixelData;
                }
                if (ct == NULL)
                {
                    return EC_MemoryExhausted;
                }
            }
            else
            {
                return result;
            }
        }
        else
        {
            DCMECT_ERROR("Invalid SOP Class: "
                         << sopClass << ", only Enhanced CT Image Storage (1.2.840.10008.5.1.4.1.1.2.1) supported");
            return ECT_InvalidSOPClass;
        }
    }
    result = OFvisit<OFCondition>(ReadVisitor(dataset, *ct), ct->getImagePixel());
    if (result.bad())
    {
        delete ct;
        ct = NULL;
    }
    return result;
}
