health_status_t Monitor::get_health_status(
  bool want_detail,
  Formatter *f,
  std::string *plain,
  const char *sep1,
  const char *sep2)
{
  health_status_t r = HEALTH_OK;
  bool compat = g_conf->mon_health_preluminous_compat;
  bool compat_warn = g_conf->get_val<bool>("mon_health_preluminous_compat_warning");
  if (f) {
    f->open_object_section("health");
    f->open_object_section("checks");
  }

  string summary;
  string *psummary = f ? nullptr : &summary;
  for (auto& svc : paxos_service) {
    r = std::min(r, svc->get_health_checks().dump_summary(
		   f, psummary, sep2, want_detail));
  }

  if (f) {
    f->close_section();
    f->dump_stream("status") << r;
  } else {
    // one-liner: HEALTH_FOO[ thing1[; thing2 ...]]
    *plain = stringify(r);
    if (summary.size()) {
      *plain += sep1;
      *plain += summary;
    }
    *plain += "\n";
  }

  const std::string old_fields_message = "'ceph health' JSON format has "
    "changed in luminous. If you see this your monitoring system is "
    "scraping the wrong fields. Disable this with 'mon health preluminous "
    "compat warning = false'";

  if (f && (compat || compat_warn)) {
    health_status_t cr = compat_warn ? min(HEALTH_WARN, r) : r;
    f->open_array_section("summary");
    if (compat_warn) {
      f->open_object_section("item");
      f->dump_stream("severity") << HEALTH_WARN;
      f->dump_string("summary", old_fields_message);
      f->close_section();
    }
    if (compat) {
      for (auto& svc : paxos_service) {
        svc->get_health_checks().dump_summary_compat(f);
      }
    }
    f->close_section();
    f->dump_stream("overall_status") << cr;
  }

  if (want_detail) {
    if (f && (compat || compat_warn)) {
      f->open_array_section("detail");
      if (compat_warn) {
	f->dump_string("item", old_fields_message);
      }
    }

    for (auto& svc : paxos_service) {
      svc->get_health_checks().dump_detail(f, plain, compat);
    }

    if (f && (compat || compat_warn)) {
      f->close_section();
    }
  }
  if (f) {
    f->close_section();
  }
  return r;
}
