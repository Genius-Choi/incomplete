static int PrefsSubSet_Ok(GGadget *g, GEvent *e) {
    GWindow gw = GGadgetGetWindow(g);
    struct pref_data *p = GDrawGetUserData(GGadgetGetWindow(g));
    struct prefs_list* plist = p->plist;
    struct prefs_list* pl = plist;
    int i=0,j=0;
    int err=0, enc;
    const unichar_t *ret;

    p->done = true;

    for ( i=0, pl=plist; pl->name; ++i, ++pl ) {
	switch( pl->type ) {
	case pr_int:
	    *((int *) (pl->val)) = GetInt8(gw,j*CID_PrefsOffset+CID_PrefsBase+i,pl->name,&err);
	    break;
	case pr_unicode:
	    *((int *) (pl->val)) = GetUnicodeChar8(gw,j*CID_PrefsOffset+CID_PrefsBase+i,pl->name,&err);
	    break;
	case pr_bool:
	    *((int *) (pl->val)) = GGadgetIsChecked(GWidgetGetControl(gw,j*CID_PrefsOffset+CID_PrefsBase+i));
	    break;
	case pr_real:
	    *((float *) (pl->val)) = GetReal8(gw,j*CID_PrefsOffset+CID_PrefsBase+i,pl->name,&err);
	    break;
	case pr_encoding:
	{ Encoding *e;
		e = ParseEncodingNameFromList(GWidgetGetControl(gw,j*CID_PrefsOffset+CID_PrefsBase+i));
		if ( e!=NULL )
		    *((Encoding **) (pl->val)) = e;
		enc = 1;	/* So gcc doesn't complain about unused. It is unused, but why add the ifdef and make the code even messier? Sigh. icc complains anyway */
	}
	break;
	case pr_namelist:
	{ NameList *nl;
	    GTextInfo *ti = GGadgetGetListItemSelected(GWidgetGetControl(gw,j*CID_PrefsOffset+CID_PrefsBase+i));
	    if ( ti!=NULL ) {
		char *name = u2utf8_copy(ti->text);
		nl = NameListByName(name);
		free(name);
		if ( nl!=NULL && nl->uses_unicode && !allow_utf8_glyphnames)
		    ff_post_error(_("Namelist contains non-ASCII names"),_("Glyph names should be limited to characters in the ASCII character set, but there are names in this namelist which use characters outside that range."));
		else if ( nl!=NULL )
		    *((NameList **) (pl->val)) = nl;
	    }
	}
	break;
	case pr_string: case pr_file:
	    ret = _GGadgetGetTitle(GWidgetGetControl(gw,j*CID_PrefsOffset+CID_PrefsBase+i));
	    if ( pl->val!=NULL ) {
		free( *((char **) (pl->val)) );
		*((char **) (pl->val)) = NULL;
		if ( ret!=NULL && *ret!='\0' )
		    *((char **) (pl->val)) = /* u2def_*/ cu_copy(ret);
	    } else {
		char *cret = cu_copy(ret);
		(pl->set)(cret);
		free(cret);
	    }
	    break;
	case pr_angle:
	    *((float *) (pl->val)) = GetReal8(gw,j*CID_PrefsOffset+CID_PrefsBase+i,pl->name,&err)/RAD2DEG;
	    break;
	}
    }

    return( true );
}
