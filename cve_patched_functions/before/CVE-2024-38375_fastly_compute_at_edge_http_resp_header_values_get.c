bool fastly_compute_at_edge_http_resp_header_values_get(
    fastly_compute_at_edge_http_types_response_handle_t h, fastly_world_string_t *name,
    fastly_world_option_list_list_u8_t *ret, fastly_compute_at_edge_types_error_t *err) {
  size_t str_max = LIST_ALLOC_SIZE;
  fastly_world_list_u8_t *strs = static_cast<fastly_world_list_u8_t *>(
      cabi_malloc(str_max * sizeof(fastly_world_list_u8_t), 1));
  size_t str_cnt = 0;
  size_t nwritten;
  uint8_t *buf = static_cast<uint8_t *>(cabi_malloc(HOSTCALL_BUFFER_LEN, 1));
  uint32_t cursor = 0;
  int64_t next_cursor = 0;
  while (true) {
    if (!convert_result(fastly::resp_header_values_get(h, reinterpret_cast<char *>(name->ptr),
                                                       name->len, buf, HEADER_MAX_LEN, cursor,
                                                       &next_cursor, &nwritten),
                        err)) {
      cabi_free(buf);
      return false;
    }
    if (nwritten == 0)
      break;
    uint32_t offset = 0;
    for (size_t i = 0; i < nwritten; i++) {
      if (buf[i] != '\0')
        continue;
      if (str_cnt == str_max) {
        strs = static_cast<fastly_world_list_u8_t *>(
            cabi_realloc(strs, str_max * sizeof(fastly_world_list_u8_t), 1,
                         (str_max + LIST_ALLOC_SIZE) * sizeof(fastly_world_list_u8_t)));
        str_max += LIST_ALLOC_SIZE;
      }
      strs[str_cnt].ptr = static_cast<uint8_t *>(cabi_malloc(i - offset + 1, 1));
      strs[str_cnt].len = i - offset;
      memcpy(strs[str_cnt].ptr, buf + offset, i - offset + 1);
      offset = i + 1;
      str_cnt++;
    }
    if (next_cursor < 0)
      break;
    cursor = static_cast<uint32_t>(next_cursor);
  }
  cabi_free(buf);
  if (str_cnt > 0) {
    ret->is_some = true;
    ret->val.ptr = strs;
    ret->val.len = str_cnt;
    strs = static_cast<fastly_world_list_u8_t *>(
        cabi_realloc(strs, str_max * sizeof(fastly_world_list_u8_t), 1,
                     str_cnt * sizeof(fastly_world_list_u8_t)));
  } else {
    ret->is_some = false;
    cabi_free(strs);
  }
  return true;
}
