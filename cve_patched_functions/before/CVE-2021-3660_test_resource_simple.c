test_resource_simple (TestResourceCase *tc,
                      gconstpointer data)
{
  CockpitWebResponse *response;
  GError *error = NULL;
  GBytes *bytes;
  gconstpointer str;
  const gchar *url = "/@localhost/another/test.html";
  const gchar *expected =
    "HTTP/1.1 200 OK\r\n"
    STATIC_HEADERS
    "Content-Security-Policy: default-src 'self' http://localhost; connect-src 'self' http://localhost ws://localhost; form-action 'self' http://localhost; base-uri 'self' http://localhost; object-src 'none'; font-src 'self' http://localhost data:; img-src 'self' http://localhost data:; block-all-mixed-content\r\n"
    "Content-Type: text/html\r\n"
    "Cache-Control: no-cache, no-store\r\n"
    "Access-Control-Allow-Origin: http://localhost\r\n"
    "Transfer-Encoding: chunked\r\n"
    "Vary: Cookie\r\n"
    "\r\n"
    "52\r\n"
    "<html>\n"
    "<head>\n"
    "<title>In home dir</title>\n"
    "</head>\n"
    "<body>In home dir</body>\n"
    "</html>\n"
    "\r\n"
    "0\r\n\r\n";


  response = cockpit_web_response_new (tc->io, url, url, NULL, NULL, COCKPIT_WEB_RESPONSE_NONE);

  cockpit_channel_response_serve (tc->service, tc->headers, response, "@localhost", "/another/test.html");

  while (cockpit_web_response_get_state (response) != COCKPIT_WEB_RESPONSE_SENT)
    g_main_context_iteration (NULL, TRUE);

  g_output_stream_close (G_OUTPUT_STREAM (tc->output), NULL, &error);
  g_assert_no_error (error);

  bytes = g_memory_output_stream_steal_as_bytes (tc->output);
  str = g_bytes_get_data (bytes, NULL);
  g_assert (str_contains_strv (str, expected, "\n"));
  cockpit_assert_strmatch (str,
                           "*\r\n"
                           "52\r\n"
                           "<html>\n"
                           "<head>\n"
                           "<title>In home dir</title>\n"
                           "</head>\n"
                           "<body>In home dir</body>\n"
                           "</html>\n"
                           "\r\n"
                           "0\r\n\r\n");

  g_bytes_unref (bytes);
  g_object_unref (response);
}
