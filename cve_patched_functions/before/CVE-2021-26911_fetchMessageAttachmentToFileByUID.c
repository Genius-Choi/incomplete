void IMAPSession::fetchMessageAttachmentToFileByUID(String * folder, uint32_t uid, String * partID,
                                                    Encoding encoding, String * outputFile,
                                                    IMAPProgressCallback * progressCallback, ErrorCode * pError)
{
    DataStreamDecoder * decoder = new DataStreamDecoder();
    decoder->setEncoding(encoding);
    decoder->setFilename(outputFile);

    ErrorCode error = ErrorNone;
    selectIfNeeded(folder, &error);
    if (error != ErrorNone) {
        * pError = error;
        return;
    }

    mailimap_set_msg_body_handler(mImap, msg_body_handler, decoder);

    fetchNonDecodedMessageAttachment(folder, true, uid, partID, true, 0, 0, encoding, progressCallback, &error);

    mailimap_set_msg_body_handler(mImap, NULL, NULL);

    if (error == ErrorNone) {
        error = decoder->flushData();
    }

    MC_SAFE_RELEASE(decoder);

    * pError = error;
}
