static int get_session_token(struct _oidc_config * config, const struct _u_request * request, struct _u_response * response, char * sid) {
  int ret = G_OK;
  char expires[129];
  time_t now;
  struct tm ts;

  time(&now);
  now += (time_t)json_integer_value(json_object_get(config->j_params, "session-cookie-expiration"));
  gmtime_r(&now, &ts);
  strftime(expires, 128, "%a, %d %b %Y %T %Z", &ts);

  if (json_object_get(config->j_params, "session-management-allowed") == json_true()) {
    if (u_map_get(request->map_cookie, json_string_value(json_object_get(config->j_params, "session-cookie-name"))) != NULL &&
        o_strlen(u_map_get(request->map_cookie, json_string_value(json_object_get(config->j_params, "session-cookie-name")))) == OIDC_SID_LENGTH) {
      if (o_strncpy(sid, u_map_get(request->map_cookie, json_string_value(json_object_get(config->j_params, "session-cookie-name"))), OIDC_SID_LENGTH) == NULL) {
        y_log_message(Y_LOG_LEVEL_ERROR, "get_session_token - Error o_strncpy");
        ret = G_ERROR;
      } else {
        if (ulfius_add_same_site_cookie_to_response(response, json_string_value(json_object_get(config->j_params, "session-cookie-name")), sid, expires, 0, config->glewlwyd_config->glewlwyd_config->cookie_domain, "/", (int)config->glewlwyd_config->glewlwyd_config->cookie_secure, 0, (int)config->glewlwyd_config->glewlwyd_config->cookie_same_site) != U_OK) {
          y_log_message(Y_LOG_LEVEL_DEBUG, "get_session_token - Error ulfius_add_same_site_cookie_to_response (1)");
          ret = G_ERROR;
        }
      }
    } else {
      if (rand_string_nonce(sid, OIDC_SID_LENGTH) == NULL) {
        ret = G_ERROR;
      } else {
        if (ulfius_add_same_site_cookie_to_response(response, json_string_value(json_object_get(config->j_params, "session-cookie-name")), sid, expires, 0, config->glewlwyd_config->glewlwyd_config->cookie_domain, "/", (int)config->glewlwyd_config->glewlwyd_config->cookie_secure, 0, (int)config->glewlwyd_config->glewlwyd_config->cookie_same_site) != U_OK) {
          y_log_message(Y_LOG_LEVEL_DEBUG, "get_session_token - Error ulfius_add_same_site_cookie_to_response (2)");
          ret = G_ERROR;
        }
      }
    }
  }
  return ret;
}
