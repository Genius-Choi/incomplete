Jsi_RC Jsi_InterpAccess(Jsi_Interp *interp, Jsi_Value* resource, int aflag)
{
    switch (aflag) {
        case JSI_INTACCESS_NETWORK:
            return (interp->noNetwork?JSI_ERROR:JSI_OK);
        case JSI_INTACCESS_MAININTERP:
            return (interp->parent?JSI_ERROR:JSI_OK);
        case JSI_INTACCESS_SETSSL:
            interp->hasOpenSSL = 1;
            return JSI_OK;
        case JSI_INTACCESS_CREATE:
            return (interp->isSafe && interp->safeMode==jsi_safe_Lockdown?JSI_ERROR: JSI_OK);
        case JSI_INTACCESS_WRITE:
        case JSI_INTACCESS_READ:
            break;
        default:
            return JSI_ERROR;
    }
    if (!resource)
        return JSI_ERROR;
    Jsi_Value *v, *dirs = ((aflag==JSI_INTACCESS_WRITE) ? interp->safeWriteDirs : interp->safeReadDirs);
    if (!interp->isSafe)
        return JSI_OK;
    if (!dirs)
        return JSI_ERROR;
    char pbuf[PATH_MAX];
    int i, m, argc = Jsi_ValueGetLength(interp, dirs);
    char *str, *dstr = Jsi_Realpath(interp, resource, pbuf);
    if (!dstr)
        return JSI_ERROR;
    for (i=0; i<argc; i++) {
        v = Jsi_ValueArrayIndex(interp, dirs, i);
        if (!v) continue;
        str = Jsi_ValueString(interp, v, &m);
        if (!str || m<=0) continue;
        if (!Jsi_Strcmp(str, dstr)) // Exact match.
            return JSI_OK;
        if (Jsi_Strncmp(str, dstr, m))
            continue;
        if (m>1 && str[m-1]=='/')
            return JSI_OK;
        if (dstr[m] == '/')
            return JSI_OK;
    }
    return JSI_ERROR;
}
