append_wpa_auth_conf(GString* s, const NetplanAuthenticationSettings* auth, const char* id, GError** error)
{
    switch (auth->key_management) {
        case NETPLAN_AUTH_KEY_MANAGEMENT_NONE:
            g_string_append(s, "  key_mgmt=NONE\n");
            break;

        case NETPLAN_AUTH_KEY_MANAGEMENT_WPA_PSK:
            if (auth->pmf_mode == NETPLAN_AUTH_PMF_MODE_OPTIONAL)
                /* Case where the user only provided the password.
                 * We enable support for WPA2 and WPA3 personal.
                 */
                g_string_append(s, "  key_mgmt=WPA-PSK WPA-PSK-SHA256 SAE\n");
            else
                g_string_append(s, "  key_mgmt=WPA-PSK\n");
            break;

        case NETPLAN_AUTH_KEY_MANAGEMENT_WPA_EAP:
            g_string_append(s, "  key_mgmt=WPA-EAP\n");
            break;

        case NETPLAN_AUTH_KEY_MANAGEMENT_WPA_EAPSHA256:
            g_string_append(s, "  key_mgmt=WPA-EAP WPA-EAP-SHA256\n");
            break;

        case NETPLAN_AUTH_KEY_MANAGEMENT_WPA_EAPSUITE_B_192:
            g_string_append(s, "  key_mgmt=WPA-EAP-SUITE-B-192\n");
            break;

        case NETPLAN_AUTH_KEY_MANAGEMENT_WPA_SAE:
            g_string_append(s, "  key_mgmt=SAE\n");
            break;

        case NETPLAN_AUTH_KEY_MANAGEMENT_8021X:
            g_string_append(s, "  key_mgmt=IEEE8021X\n");
            break;

        default: break; // LCOV_EXCL_LINE
    }

    switch (auth->eap_method) {
        case NETPLAN_AUTH_EAP_NONE:
            break;

        case NETPLAN_AUTH_EAP_TLS:
            g_string_append(s, "  eap=TLS\n");
            break;

        case NETPLAN_AUTH_EAP_PEAP:
            g_string_append(s, "  eap=PEAP\n");
            break;

        case NETPLAN_AUTH_EAP_TTLS:
            g_string_append(s, "  eap=TTLS\n");
            break;

        case NETPLAN_AUTH_EAP_LEAP:
            g_string_append(s, "  eap=LEAP\n");
            break;

        case NETPLAN_AUTH_EAP_PWD:
            g_string_append(s, "  eap=PWD\n");
            break;

        default: break; // LCOV_EXCL_LINE
    }

    switch (auth->pmf_mode) {
        case NETPLAN_AUTH_PMF_MODE_NONE:
        case NETPLAN_AUTH_PMF_MODE_DISABLED:
            break;

        case NETPLAN_AUTH_PMF_MODE_OPTIONAL:
            g_string_append(s, "  ieee80211w=1\n");
            break;

        case NETPLAN_AUTH_PMF_MODE_REQUIRED:
            g_string_append(s, "  ieee80211w=2\n");
            break;
    }

    if (auth->identity) {
        g_string_append_printf(s, "  identity=\"%s\"\n", auth->identity);
    }
    if (auth->anonymous_identity) {
        g_string_append_printf(s, "  anonymous_identity=\"%s\"\n", auth->anonymous_identity);
    }

    char* psk = NULL;
    if (auth->psk)
        psk = auth->psk;
    else if (auth->password && _is_auth_key_management_psk(auth))
        psk = auth->password;

    if (psk) {
        size_t len = strlen(psk);
        if (len == 64) {
            /* must be a hex-digit key representation */
            for (unsigned i = 0; i < 64; ++i)
                if (!isxdigit(psk[i])) {
                    g_set_error(error, NETPLAN_BACKEND_ERROR, NETPLAN_ERROR_UNSUPPORTED, "ERROR: %s: PSK length of 64 is only supported for hex-digit representation\n", id);
                    return FALSE;
                }
            /* this is required to be unquoted */
            g_string_append_printf(s, "  psk=%s\n", psk);
        } else if (len < 8 || len > 63) {
            /* per wpa_supplicant spec, passphrase needs to be between 8 and 63 characters */
            g_set_error(error, NETPLAN_BACKEND_ERROR, NETPLAN_ERROR_VALIDATION, "ERROR: %s: ASCII passphrase must be between 8 and 63 characters (inclusive)\n", id);
            return FALSE;
        } else {
            g_string_append_printf(s, "  psk=\"%s\"\n", psk);
        }
    }

    if (auth->password
        && (!_is_auth_key_management_psk(auth) || auth->eap_method != NETPLAN_AUTH_EAP_NONE)) {
        if (strncmp(auth->password, "hash:", 5) == 0) {
            g_string_append_printf(s, "  password=%s\n", auth->password);
        } else {
            g_string_append_printf(s, "  password=\"%s\"\n", auth->password);
        }
    }
    if (auth->ca_certificate) {
        g_string_append_printf(s, "  ca_cert=\"%s\"\n", auth->ca_certificate);
    }
    if (auth->client_certificate) {
        g_string_append_printf(s, "  client_cert=\"%s\"\n", auth->client_certificate);
    }
    if (auth->client_key) {
        g_string_append_printf(s, "  private_key=\"%s\"\n", auth->client_key);
    }
    if (auth->client_key_password) {
        g_string_append_printf(s, "  private_key_passwd=\"%s\"\n", auth->client_key_password);
    }
    if (auth->phase2_auth) {
        g_string_append_printf(s, "  phase2=\"auth=%s\"\n", auth->phase2_auth);
    }
    return TRUE;
}
