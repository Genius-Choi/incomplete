generate_ping_frame (struct ietf_full_conn *conn, lsquic_time_t now)
{
    struct lsquic_packet_out *packet_out;
    int pns;
    int sz;

    if (conn->ifc_conn.cn_flags & LSCONN_HANDSHAKE_DONE)
        packet_out = get_writeable_packet(conn, 1);
    else
    {
        conn->ifc_ping_period += HSK_PING_TIMEOUT;
        lsquic_alarmset_set(&conn->ifc_alset, AL_PING,
                            now + conn->ifc_ping_period);
        if (iquic_esf_is_enc_level_ready(conn->ifc_conn.cn_enc_session,
                                         ENC_LEV_HSK))
            pns = PNS_HSK;
        else
            pns = PNS_INIT;
        packet_out = lsquic_send_ctl_new_packet_out(&conn->ifc_send_ctl, 0, pns,
                                                    CUR_NPATH(conn));
        if (packet_out)
            lsquic_send_ctl_scheduled_one(&conn->ifc_send_ctl, packet_out);

    }
    if (!packet_out)
    {
        LSQ_DEBUG("cannot get writeable packet for PING frame");
        return;
    }
    sz = conn->ifc_conn.cn_pf->pf_gen_ping_frame(
                            packet_out->po_data + packet_out->po_data_sz,
                            lsquic_packet_out_avail(packet_out));
    if (sz < 0) {
        ABORT_ERROR("gen_ping_frame failed");
        return;
    }
    if (0 != lsquic_packet_out_add_frame(packet_out, conn->ifc_pub.mm, 0,
                            QUIC_FRAME_PING, packet_out->po_data_sz, sz))
    {
        ABORT_ERROR("adding frame to packet failed: %d", errno);
        return;
    }
    lsquic_send_ctl_incr_pack_sz(&conn->ifc_send_ctl, packet_out, sz);
    packet_out->po_frame_types |= 1 << QUIC_FRAME_PING;
    LSQ_DEBUG("wrote PING frame");
    conn->ifc_send_flags &= ~SF_SEND_PING;
    if (!(conn->ifc_flags & IFC_SERVER))
        log_conn_flow_control(conn);
}
