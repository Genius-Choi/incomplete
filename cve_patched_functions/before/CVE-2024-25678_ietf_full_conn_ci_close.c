ietf_full_conn_ci_close (struct lsquic_conn *lconn)
{
    struct ietf_full_conn *conn = (struct ietf_full_conn *) lconn;
    struct lsquic_stream *stream;
    struct lsquic_hash_elem *el;
    enum stream_dir sd;

    if (!(conn->ifc_flags & IFC_CLOSING))
    {
        for (el = lsquic_hash_first(conn->ifc_pub.all_streams); el;
                             el = lsquic_hash_next(conn->ifc_pub.all_streams))
        {
            stream = lsquic_hashelem_getdata(el);
            sd = (stream->id >> SD_SHIFT) & 1;
            if (SD_BIDI == sd)
                lsquic_stream_maybe_reset(stream, 0, 1);
        }
        conn->ifc_flags |= IFC_CLOSING;
        if (conn_ok_to_close(conn))
        {
            conn->ifc_send_flags |= SF_SEND_CONN_CLOSE;
            LSQ_DEBUG("ietf_full_conn_ci_close: ok to close: "
                      "schedule to send CONNECTION_CLOSE");
        }
        lsquic_engine_add_conn_to_tickable(conn->ifc_enpub, lconn);
    }
}
