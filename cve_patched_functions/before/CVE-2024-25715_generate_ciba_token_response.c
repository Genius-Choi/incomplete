static json_t * generate_ciba_token_response(struct _oidc_config * config, json_t * j_client, json_t * j_user, json_t * j_ciba_request, const char * scope_list, const char * sid, const char * dpop_jkt) {
  json_t * j_return, * j_refresh_token, * j_amr, * j_refresh;
  time_t now;
  char * refresh_token,
       * refresh_token_out = NULL,
       * access_token,
       * access_token_out = NULL,
       * id_token,
       * id_token_out = NULL,
       jti_r[OIDC_JTI_LENGTH+1] = {0},
       jti[OIDC_JTI_LENGTH+1] = {0},
       ** scope_array = NULL;
  const char * client_id = json_string_value(json_object_get(j_client, "client_id")),
             * x5t_s256 = json_string_value(json_object_get(j_ciba_request, "x5t_s256")),
             * username = json_string_value(json_object_get(j_user, "username")),
             * token_type = dpop_jkt!=NULL?GLEWLWYD_TOKEN_TYPE_DPOP:GLEWLWYD_TOKEN_TYPE_BEARER;
  int has_openid = 0, r_enc_res = G_OK, a_enc_res = G_OK, i_enc_res = G_OK;

  if (split_string(scope_list, " ", &scope_array)) {
    has_openid = string_array_has_value((const char **)scope_array, "openid");
  }
  free_string_array(scope_array);
  j_refresh = get_refresh_token_duration_rolling(config, scope_list);
  time(&now);
  if (check_result_value(j_refresh, G_OK)) {
    if ((refresh_token = generate_refresh_token()) != NULL) {
      y_log_message(Y_LOG_LEVEL_INFO, "Event oidc - Plugin '%s' - Refresh token generated for client '%s' granted by user '%s' with scope list '%s'", config->name, client_id, username, scope_list);
      j_refresh_token = serialize_refresh_token(config,
                                                GLEWLWYD_AUTHORIZATION_TYPE_RESOURCE_OWNER_PASSWORD_CREDENTIALS,
                                                0,
                                                username,
                                                client_id,
                                                scope_list,
                                                NULL,
                                                now,
                                                json_integer_value(json_object_get(json_object_get(j_refresh, "refresh-token"), "refresh-token-duration")),
                                                json_object_get(json_object_get(j_refresh, "refresh-token"), "refresh-token-rolling")==json_true(),
                                                NULL,
                                                refresh_token,
                                                json_string_value(json_object_get(j_ciba_request, "issued_for")),
                                                json_string_value(json_object_get(j_ciba_request, "user_agent")),
                                                jti_r,
                                                dpop_jkt,
                                                NULL);
      if (check_result_value(j_refresh_token, G_OK)) {
          if ((access_token = generate_access_token(config,
                                                    username,
                                                    j_client,
                                                    j_user,
                                                    scope_list,
                                                    NULL,
                                                    NULL,
                                                    now,
                                                    jti,
                                                    x5t_s256,
                                                    dpop_jkt,
                                                    NULL,
                                                    json_string_value(json_object_get(j_ciba_request, "issued_for")))) != NULL) {
            if (serialize_access_token(config,
                                       GLEWLWYD_AUTHORIZATION_TYPE_RESOURCE_OWNER_PASSWORD_CREDENTIALS,
                                       json_integer_value(json_object_get(j_refresh_token, "gpgr_id")),
                                       username,
                                       client_id,
                                       scope_list,
                                       NULL,
                                       now,
                                       json_string_value(json_object_get(j_ciba_request, "issued_for")),
                                       json_string_value(json_object_get(j_ciba_request, "user_agent")),
                                       access_token,
                                       jti,
                                       NULL) == G_OK) {
              if (has_openid) {
                j_amr = json_object_get(j_ciba_request, "amr");
                if ((id_token = generate_id_token(config,
                                                  username,
                                                  json_object_get(j_user, "user"),
                                                  j_client,
                                                  now,
                                                  now,
                                                  NULL,
                                                  j_amr,
                                                  access_token,
                                                  NULL,
                                                  scope_list,
                                                  NULL,
                                                  json_string_value(json_object_get(j_ciba_request, "auth_req_id")),
                                                  refresh_token,
                                                  NULL,
                                                  sid,
                                                  json_string_value(json_object_get(j_ciba_request, "issued_for")))) != NULL) {
                  if (serialize_id_token(config,
                                         GLEWLWYD_AUTHORIZATION_TYPE_RESOURCE_OWNER_PASSWORD_CREDENTIALS,
                                         id_token,
                                         username,
                                         client_id,
                                         sid,
                                         0,
                                         json_integer_value(json_object_get(j_refresh_token, "gpgr_id")),
                                         now,
                                         json_string_value(json_object_get(j_ciba_request, "issued_for")),
                                         json_string_value(json_object_get(j_ciba_request, "user_agent"))) == G_OK) {
                    if ((access_token_out = encrypt_token_if_required(config, access_token, j_client, GLEWLWYD_TOKEN_TYPE_ACCESS_TOKEN, &a_enc_res)) != NULL &&
                        (refresh_token_out = encrypt_token_if_required(config, refresh_token, j_client, GLEWLWYD_TOKEN_TYPE_REFRESH_TOKEN, &r_enc_res)) != NULL &&
                        (id_token_out = encrypt_token_if_required(config, id_token, j_client, GLEWLWYD_TOKEN_TYPE_ID_TOKEN, &i_enc_res)) != NULL) {
                      j_return = json_pack("{sis{sOsssssssssisIss}}",
                                           "result", G_OK,
                                           "token",
                                             "auth_req_id", json_object_get(j_ciba_request, "auth_req_id"),
                                             "token_type", token_type,
                                             "access_token", access_token_out,
                                             "refresh_token", refresh_token_out,
                                             "id_token", id_token_out,
                                             "iat", now,
                                             "expires_in", config->access_token_duration,
                                             "scope", scope_list);
                      config->glewlwyd_config->glewlwyd_plugin_callback_metrics_increment_counter(config->glewlwyd_config, GLWD_METRICS_OIDC_ID_TOKEN, 1, "plugin", config->name, "response_type", "ciba", NULL);
                      config->glewlwyd_config->glewlwyd_plugin_callback_metrics_increment_counter(config->glewlwyd_config, GLWD_METRICS_OIDC_ID_TOKEN, 1, "plugin", config->name, NULL);
                      config->glewlwyd_config->glewlwyd_plugin_callback_metrics_increment_counter(config->glewlwyd_config, GLWD_METRICS_OIDC_REFRESH_TOKEN, 1, "plugin", config->name, "response_type", "ciba", NULL);
                      config->glewlwyd_config->glewlwyd_plugin_callback_metrics_increment_counter(config->glewlwyd_config, GLWD_METRICS_OIDC_REFRESH_TOKEN, 1, "plugin", config->name, NULL);
                      config->glewlwyd_config->glewlwyd_plugin_callback_metrics_increment_counter(config->glewlwyd_config, GLWD_METRICS_OIDC_USER_ACCESS_TOKEN, 1, "plugin", config->name, "response_type", "ciba", NULL);
                      config->glewlwyd_config->glewlwyd_plugin_callback_metrics_increment_counter(config->glewlwyd_config, GLWD_METRICS_OIDC_USER_ACCESS_TOKEN, 1, "plugin", config->name, NULL);
                    } else if (r_enc_res == G_ERROR_UNAUTHORIZED || a_enc_res == G_ERROR_UNAUTHORIZED || i_enc_res == G_ERROR_UNAUTHORIZED) {
                      j_return = json_pack("{si}", "result", G_ERROR_PARAM);
                    } else {
                      y_log_message(Y_LOG_LEVEL_ERROR, "oidc check_auth_type_resource_owner_pwd_cred - Error encrypt_token_if_required");
                      j_return = json_pack("{si}", "result", G_ERROR);
                    }
                    o_free(access_token_out);
                    o_free(refresh_token_out);
                    o_free(id_token_out);
                  } else {
                    y_log_message(Y_LOG_LEVEL_ERROR, "oidc check_auth_type_resource_owner_pwd_cred - Error serialize_id_token");
                    j_return = json_pack("{si}", "result", G_ERROR);
                  }
                } else {
                  y_log_message(Y_LOG_LEVEL_ERROR, "oidc check_auth_type_resource_owner_pwd_cred - Error generate_id_token");
                  j_return = json_pack("{si}", "result", G_ERROR);
                }
                o_free(id_token);
              } else {
                if ((access_token_out = encrypt_token_if_required(config, access_token, j_client, GLEWLWYD_TOKEN_TYPE_ACCESS_TOKEN, &a_enc_res)) != NULL &&
                    (refresh_token_out = encrypt_token_if_required(config, refresh_token, j_client, GLEWLWYD_TOKEN_TYPE_REFRESH_TOKEN, &r_enc_res)) != NULL) {
                  j_return = json_pack("{sis{sOsssssssisIss}}",
                                       "result", G_OK,
                                       "token",
                                         "auth_req_id", json_object_get(j_ciba_request, "auth_req_id"),
                                         "token_type", token_type,
                                         "access_token", access_token_out,
                                         "refresh_token", refresh_token_out,
                                         "iat", now,
                                         "expires_in", config->access_token_duration,
                                         "scope", scope_list);
                  config->glewlwyd_config->glewlwyd_plugin_callback_metrics_increment_counter(config->glewlwyd_config, GLWD_METRICS_OIDC_REFRESH_TOKEN, 1, "plugin", config->name, "response_type", "password", NULL);
                  config->glewlwyd_config->glewlwyd_plugin_callback_metrics_increment_counter(config->glewlwyd_config, GLWD_METRICS_OIDC_REFRESH_TOKEN, 1, "plugin", config->name, NULL);
                  config->glewlwyd_config->glewlwyd_plugin_callback_metrics_increment_counter(config->glewlwyd_config, GLWD_METRICS_OIDC_USER_ACCESS_TOKEN, 1, "plugin", config->name, "response_type", "password", NULL);
                  config->glewlwyd_config->glewlwyd_plugin_callback_metrics_increment_counter(config->glewlwyd_config, GLWD_METRICS_OIDC_USER_ACCESS_TOKEN, 1, "plugin", config->name, NULL);
                } else if (r_enc_res == G_ERROR_UNAUTHORIZED || a_enc_res == G_ERROR_UNAUTHORIZED) {
                  j_return = json_pack("{si}", "result", G_ERROR_PARAM);
                } else {
                  y_log_message(Y_LOG_LEVEL_ERROR, "oidc check_auth_type_resource_owner_pwd_cred - Error encrypt_token_if_required");
                  j_return = json_pack("{si}", "result", G_ERROR);
                }
                o_free(access_token_out);
                o_free(refresh_token_out);
              }
            } else {
              y_log_message(Y_LOG_LEVEL_ERROR, "oidc check_auth_type_resource_owner_pwd_cred - Error serialize_access_token");
              j_return = json_pack("{si}", "result", G_ERROR);
            }
          } else {
            y_log_message(Y_LOG_LEVEL_ERROR, "oidc check_auth_type_resource_owner_pwd_cred - Error generate_access_token");
            j_return = json_pack("{si}", "result", G_ERROR);
          }
          o_free(access_token);
      } else {
        y_log_message(Y_LOG_LEVEL_ERROR, "oidc check_auth_type_resource_owner_pwd_cred - Error serialize_refresh_token");
        j_return = json_pack("{si}", "result", G_ERROR);
      }
      json_decref(j_refresh_token);
      o_free(refresh_token);
    } else {
      y_log_message(Y_LOG_LEVEL_ERROR, "oidc check_auth_type_resource_owner_pwd_cred - Error generate_refresh_token");
      j_return = json_pack("{si}", "result", G_ERROR);
    }
  } else {
    y_log_message(Y_LOG_LEVEL_ERROR, "oidc check_auth_type_resource_owner_pwd_cred - Error get_refresh_token_duration_rolling");
    j_return = json_pack("{si}", "result", G_ERROR);
  }
  json_decref(j_refresh);
  return j_return;
}
