MOBI_RET mobi_set_fullname(MOBIData *m, const char *fullname) {
    if (mobi_exists_mobiheader(m) && m->mh->full_name) {
        size_t title_length = min(strlen(fullname), MOBI_TITLE_SIZEMAX);
        char *new_title = malloc(title_length + 1);
        if (new_title == NULL) {
            return MOBI_MALLOC_FAILED;
        }
        if (mobi_is_cp1252(m)) {
            size_t new_size = title_length + 1;
            MOBI_RET ret = mobi_utf8_to_cp1252(new_title, fullname, &new_size, title_length);
            if (ret != MOBI_SUCCESS) {
                free(new_title);
                return ret;
            }
        } else {
            memcpy(new_title, fullname, title_length);
            new_title[title_length] = '\0';
        }
        free(m->mh->full_name);
        m->mh->full_name = new_title;
        if (mobi_is_hybrid(m) && mobi_exists_mobiheader(m->next) && m->next->mh->full_name) {
            char *new_title2 = strdup(new_title);
            if (new_title2 == NULL) {
                return MOBI_MALLOC_FAILED;
            }
            free(m->next->mh->full_name);
            m->next->mh->full_name = new_title2;
        }
    }
    return MOBI_SUCCESS;
}
