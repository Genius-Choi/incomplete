static void rtcp_generate_report_block(switch_rtp_t *rtp_session, struct switch_rtcp_report_block *rtcp_report_block, 
		int16_t extra_expected)
{
#ifdef DEBUG_RTCP
	switch_core_session_t *session = switch_core_memory_pool_get_data(rtp_session->pool, "__session");
#endif
	switch_rtcp_numbers_t * stats=&rtp_session->stats.rtcp;
	uint32_t expected_pkt, dlsr = 0;
	int32_t pkt_lost;

	/* Packet loss */
	if (stats->rtcp_rtp_count == 0) {
		expected_pkt = stats->high_ext_seq_recv - stats->base_seq + 1;
	} else {
		expected_pkt = stats->high_ext_seq_recv - stats->last_rpt_ext_seq + extra_expected;
	}

	pkt_lost = expected_pkt - stats->period_pkt_count;
	if (pkt_lost < 0) pkt_lost = 0;

	stats->cum_lost=stats->cum_lost+pkt_lost;
	if (expected_pkt > 0 && pkt_lost > 0) {
		rtcp_report_block->fraction = (pkt_lost == expected_pkt ? 255 : (uint8_t) (pkt_lost * 256 / expected_pkt));             /* if X packets were expected and X was lost, we want 0xff to be reported, not 0 */
	} else {
		rtcp_report_block->fraction = 0;
	}
#if SWITCH_BYTE_ORDER == __BIG_ENDIAN
	rtcp_report_block->lost = stats->cum_lost;
#else
	/* Reversing byte order for 24bits */
	rtcp_report_block->lost = htonl(stats->cum_lost) >> 8;
#endif

#ifdef DEBUG_RTCP
			if (rtp_session->flags[SWITCH_RTP_FLAG_VIDEO])
				switch_log_printf(SWITCH_CHANNEL_SESSION_LOG(session), SWITCH_LOG_CRIT, "rtcp_generate_sr: stats_ssrc[%u]\nreceived[%d]\nexpected[%d]\ncum[%d]\nlost[%d|%d/256]pkt\nlast_seq[%d]\ncyc[%d]\nlast_rpt_seq[%d]\ncyc[%d]\nssrc[%d]\n",
						rtp_session->remote_ssrc, stats->period_pkt_count, expected_pkt,
						stats->cum_lost, pkt_lost, rtcp_report_block->fraction, stats->high_ext_seq_recv&0x0000ffff,
						stats->cycle, stats->last_rpt_ext_seq&0x0000ffff, stats->last_rpt_cycle, rtp_session->stats.rtcp.peer_ssrc
						);
#endif
	rtcp_report_block->highest_sequence_number_received = htonl(stats->high_ext_seq_recv);

	/* Jitter */
	rtcp_report_block->jitter = htonl((uint32_t)stats->inter_jitter);

	/* Delay since Last Sender Report (DLSR) : 32bits, 1/65536 seconds */
	if (stats->last_recv_lsr_local) {
		uint32_t lsr_now = calc_local_lsr_now();
		/* check lsr_now: what we just read from clock may be in the past (race cond), don't send huge dlsr due to uint wrap around */
		if (lsr_now > stats->last_recv_lsr_local) {
			dlsr = lsr_now - stats->last_recv_lsr_local;
		}
	}
	rtcp_report_block->lsr = stats->last_recv_lsr_peer;
	rtcp_report_block->dlsr = htonl(dlsr);
	if (rtp_session->stats.rtcp.peer_ssrc) {
		rtcp_report_block->ssrc = htonl(rtp_session->stats.rtcp.peer_ssrc);
	} else {
		/* if remote is not sending rtcp reports, take ssrc as assigned from rtp */
		rtcp_report_block->ssrc = htonl(rtp_session->remote_ssrc);
	}
	
	stats->rtcp_rtp_count++;
}
