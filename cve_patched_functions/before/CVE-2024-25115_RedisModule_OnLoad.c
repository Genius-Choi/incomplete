int RedisModule_OnLoad(RedisModuleCtx *ctx, RedisModuleString **argv, int argc) {
    if (RedisModule_Init(ctx, "bf", REBLOOM_MODULE_VERSION, REDISMODULE_APIVER_1) !=
        REDISMODULE_OK) {
        return REDISMODULE_ERR;
    }

    // Print version string!
    RedisModule_Log(ctx, "notice", "RedisBloom version %d.%d.%d (Git=%s)", REBLOOM_VERSION_MAJOR,
                    REBLOOM_VERSION_MINOR, REBLOOM_VERSION_PATCH, REDISBLOOM_GIT_SHA);

    if (argc == 1) {
        RedisModule_Log(ctx, "notice", "Found empty string. Assuming ramp-packer validation");
        // Hack for ramp-packer which gives us an empty string.
        size_t tmp;
        RedisModule_StringPtrLen(argv[0], &tmp);
        if (tmp == 0) {
            argc = 0;
        }
    }

    if (argc % 2) {
        BAIL("Invalid number of arguments passed");
    }

    for (int ii = 0; ii < argc; ii += 2) {
        if (!rsStrcasecmp(argv[ii], "initial_size")) {
            long long v;
            if (RedisModule_StringToLongLong(argv[ii + 1], &v) == REDISMODULE_ERR) {
                BAIL("Invalid argument for 'INITIAL_SIZE'");
            }
            if (v > 0) {
                BFDefaultInitCapacity = v;
            } else {
                BAIL("INITIAL_SIZE must be > 0");
            }
        } else if (!rsStrcasecmp(argv[ii], "error_rate")) {
            double d;
            if (RedisModule_StringToDouble(argv[ii + 1], &d) == REDISMODULE_ERR) {
                BAIL("Invalid argument for 'ERROR_RATE'");
            } else if (d <= 0) {
                BAIL("ERROR_RATE must be > 0");
            } else if (d >= 1) {
                BAIL("ERROR_RATE must be < 1");
            } else {
                BFDefaultErrorRate = d;
            }
        } else if (!rsStrcasecmp(argv[ii], "cf_max_expansions")) {
            long long l;
            if (RedisModule_StringToLongLong(argv[ii + 1], &l) == REDISMODULE_ERR) {
                BAIL("Invalid argument for 'CF_MAX_EXPANSIONS'");
            } else if (l < 1) {
                BAIL("CF_MAX_EXPANSIONS must be an integer >= 1");
            }
            CFMaxExpansions = l;
        } else {
            BAIL("Unrecognized option");
        }
    }

#define CREATE_CMD(name, tgt, attr)                                                                \
    do {                                                                                           \
        if (RedisModule_CreateCommand(ctx, name, tgt, attr, 1, 1, 1) != REDISMODULE_OK) {          \
            return REDISMODULE_ERR;                                                                \
        }                                                                                          \
    } while (0)
#define CREATE_WRCMD(name, tgt) CREATE_CMD(name, tgt, "write deny-oom")
#define CREATE_ROCMD(name, tgt) CREATE_CMD(name, tgt, "readonly fast")

    CREATE_WRCMD("bf.reserve", BFReserve_RedisCommand);
    CREATE_WRCMD("bf.add", BFAdd_RedisCommand);
    CREATE_WRCMD("bf.madd", BFAdd_RedisCommand);
    CREATE_WRCMD("bf.insert", BFInsert_RedisCommand);
    CREATE_ROCMD("bf.exists", BFCheck_RedisCommand);
    CREATE_ROCMD("bf.mexists", BFCheck_RedisCommand);
    CREATE_ROCMD("bf.info", BFInfo_RedisCommand);
    CREATE_ROCMD("bf.card", BFCard_RedisCommand);

    // Bloom - Debug
    CREATE_ROCMD("bf.debug", BFDebug_RedisCommand);

    // Bloom - AOF
    CREATE_ROCMD("bf.scandump", BFScanDump_RedisCommand);
    CREATE_WRCMD("bf.loadchunk", BFLoadChunk_RedisCommand);

    // Cuckoo Filter commands
    CREATE_WRCMD("cf.reserve", CFReserve_RedisCommand);
    CREATE_WRCMD("cf.add", CFAdd_RedisCommand);
    CREATE_WRCMD("cf.addnx", CFAdd_RedisCommand);
    CREATE_WRCMD("cf.insert", CFInsert_RedisCommand);
    CREATE_WRCMD("cf.insertnx", CFInsert_RedisCommand);
    CREATE_ROCMD("cf.exists", CFCheck_RedisCommand);
    CREATE_ROCMD("cf.mexists", CFCheck_RedisCommand);
    CREATE_ROCMD("cf.count", CFCheck_RedisCommand);

    // Technically a write command, but doesn't change memory profile
    CREATE_CMD("cf.del", CFDel_RedisCommand, "write fast");

    CREATE_ROCMD("cf.compact", CFCompact_RedisCommand);
    // AOF:
    CREATE_ROCMD("cf.scandump", CFScanDump_RedisCommand);
    CREATE_WRCMD("cf.loadchunk", CFLoadChunk_RedisCommand);

    CREATE_ROCMD("cf.info", CFInfo_RedisCommand);
    CREATE_ROCMD("cf.debug", CFDebug_RedisCommand);

    CMSModule_onLoad(ctx, argv, argc);
    TopKModule_onLoad(ctx, argv, argc);
    if (TDigestModule_onLoad(ctx, argv, argc) == REDISMODULE_ERR)
        return REDISMODULE_ERR;

    static RedisModuleTypeMethods typeprocs = {.version = REDISMODULE_TYPE_METHOD_VERSION,
                                               .rdb_load = BFRdbLoad,
                                               .rdb_save = BFRdbSave,
                                               .aof_rewrite = BFAofRewrite,
                                               .free = BFFree,
                                               .mem_usage = BFMemUsage};
    BFType = RedisModule_CreateDataType(ctx, "MBbloom--", BF_MIN_GROWTH_ENC, &typeprocs);
    if (BFType == NULL) {
        return REDISMODULE_ERR;
    }

    static RedisModuleTypeMethods cfTypeProcs = {.version = REDISMODULE_TYPE_METHOD_VERSION,
                                                 .rdb_load = CFRdbLoad,
                                                 .rdb_save = CFRdbSave,
                                                 .aof_rewrite = CFAofRewrite,
                                                 .free = CFFree,
                                                 .mem_usage = CFMemUsage};
    CFType = RedisModule_CreateDataType(ctx, "MBbloomCF", CF_MIN_EXPANSION_VERSION, &cfTypeProcs);
    if (CFType == NULL) {
        return REDISMODULE_ERR;
    }
    return REDISMODULE_OK;
}
