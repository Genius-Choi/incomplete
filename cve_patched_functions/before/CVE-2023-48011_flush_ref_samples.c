void flush_ref_samples(GF_ISOFile *movie, u64 *out_seg_size, Bool use_seg_marker)
{
	u32 i=0;
	if (movie->in_sidx_write) return;
	u32 trun_count = gf_list_count(movie->moof->trun_list);
	for (i=0; i<trun_count; i++) {
		GF_TrackFragmentRunBox *trun = gf_list_get(movie->moof->trun_list, i);
		u32 s_count = gf_list_count(trun->sample_refs);
		while (s_count) {
			if (!use_seg_marker && movie->on_last_block_start && (i+1==trun_count) && (s_count==1)) {
				movie->on_last_block_start(movie->on_block_out_usr_data);
			}
			GF_TrafSampleRef *sref = gf_list_pop_front(trun->sample_refs);
			movie->on_block_out(movie->on_block_out_usr_data, sref->data, sref->len, sref->ref, sref->ref_offset);
			if (out_seg_size) *out_seg_size += sref->len;
			if (!sref->ref) gf_free(sref->data);
			gf_free(sref);
			s_count--;
		}
	}
}
