static pj_status_t transport_send_rtp( pjmedia_transport *tp,
				       const void *pkt,
				       pj_size_t size)
{
    pj_status_t status;
    transport_srtp *srtp = (transport_srtp*) tp;
    int len = (int)size;
    srtp_err_status_t err;

    if (srtp->bypass_srtp)
	return pjmedia_transport_send_rtp(srtp->member_tp, pkt, size);

    if (size > sizeof(srtp->rtp_tx_buffer) - MAX_TRAILER_LEN)
	return PJ_ETOOBIG;

    pj_memcpy(srtp->rtp_tx_buffer, pkt, size);

    pj_lock_acquire(srtp->mutex);
    if (!srtp->session_inited) {
	pj_lock_release(srtp->mutex);
	return PJMEDIA_SRTP_EKEYNOTREADY;
    }

    /* Save outgoing SSRC */
    srtp->tx_ssrc = ntohl(((pjmedia_rtp_hdr*)pkt)->ssrc);

#if TEST_ROC
    if (srtp->setting.tx_roc.ssrc == 0) {
	srtp_err_status_t status;
    	status = srtp_set_stream_roc(srtp->srtp_tx_ctx, srtp->tx_ssrc,
    			    	     (srtp->offerer_side? 1: 2));
    	if (status == srtp_err_status_ok) {
    	    srtp->setting.tx_roc.ssrc = srtp->tx_ssrc;
    	    srtp->setting.tx_roc.roc = (srtp->offerer_side? 1: 2);
	    PJ_LOG(4, (THIS_FILE, "Setting TX ROC to SSRC %d to %d",
		   srtp->tx_ssrc, srtp->setting.tx_roc.roc));
	}
    }
#endif

    err = srtp_protect(srtp->srtp_tx_ctx, srtp->rtp_tx_buffer, &len);
    pj_lock_release(srtp->mutex);

    if (err == srtp_err_status_ok) {
	status = pjmedia_transport_send_rtp(srtp->member_tp,
					    srtp->rtp_tx_buffer, len);
    } else {
	status = PJMEDIA_ERRNO_FROM_LIBSRTP(err);
    }

    return status;
}
