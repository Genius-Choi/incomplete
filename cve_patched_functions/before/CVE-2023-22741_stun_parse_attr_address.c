int stun_parse_attr_address(stun_attr_t *attr,
			    const unsigned char *p,
			    unsigned len)
{
  su_sockaddr_t *addr;
  int addrlen;
  char ipaddr[SU_ADDRSIZE + 2];

  if (len != 8) {
    return -1;
  }

  addrlen = sizeof(su_sockaddr_t);
  addr = (su_sockaddr_t *) malloc(addrlen);

  if (*(p+1) == 1) { /* expected value for IPv4 */
    addr->su_sin.sin_family = AF_INET;
  }
  else {
    free(addr);
    return -1;
  }
  memcpy(&addr->su_sin.sin_port, p + 2, 2);
  memcpy(&addr->su_sin.sin_addr.s_addr, p + 4, 4);

  SU_DEBUG_5(("%s: address attribute: %s:%d\n", __func__,
	      su_inet_ntop(addr->su_family, SU_ADDR(addr), ipaddr, sizeof(ipaddr)),
	      (unsigned) ntohs(addr->su_sin.sin_port)));

  attr->pattr = addr;
  stun_init_buffer(&attr->enc_buf);

  return 0;
}
