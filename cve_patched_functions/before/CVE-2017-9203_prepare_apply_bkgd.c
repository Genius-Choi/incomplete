static void prepare_apply_bkgd(struct iw_context *ctx)
{
	struct iw_color bkgd1; // Main background color in linear colorspace
	struct iw_color bkgd2; // Secondary background color ...
	int i;

	if(!ctx->apply_bkgd) return;

	// Start with a default background color.
	bkgd1.c[0]=1.0; bkgd1.c[1]=0.0; bkgd1.c[2]=1.0; bkgd1.c[3]=1.0;
	bkgd2.c[0]=0.0; bkgd2.c[1]=0.0; bkgd2.c[2]=0.0; bkgd2.c[3]=1.0;

	// Possibly overwrite it with the background color from the appropriate
	// source.
	if(ctx->bkgd_color_source == IW_BKGD_COLOR_SOURCE_FILE) {
		bkgd1 = ctx->img1_bkgd_label_lin; // sructure copy
		ctx->bkgd_checkerboard = 0;
	}
	else if(ctx->bkgd_color_source == IW_BKGD_COLOR_SOURCE_REQ) {
		bkgd1 = ctx->req.bkgd;
		if(ctx->req.bkgd_checkerboard) {
			bkgd2 = ctx->req.bkgd2;
		}
	}

	// Set up the channelinfo (and ctx->bkgd*alpha) as needed according to the
	// target image type, and whether we are applying the background before or
	// after resizing.

	if(ctx->apply_bkgd_strategy==IW_BKGD_STRATEGY_EARLY) {
		ctx->bkgd1alpha = 1.0;
	}
	else {
		ctx->bkgd1alpha = bkgd1.c[3];
		ctx->bkgd2alpha = bkgd2.c[3];
	}

	if(ctx->apply_bkgd_strategy==IW_BKGD_STRATEGY_LATE && (ctx->img2.imgtype==IW_IMGTYPE_RGB ||
		ctx->img2.imgtype==IW_IMGTYPE_RGBA))
	{
		for(i=0;i<3;i++) {
			ctx->img2_ci[i].bkgd1_color_lin = bkgd1.c[i];
		}
		if(ctx->bkgd_checkerboard) {
			for(i=0;i<3;i++) {
				ctx->img2_ci[i].bkgd2_color_lin = bkgd2.c[i];
			}
		}
	}
	else if(ctx->apply_bkgd_strategy==IW_BKGD_STRATEGY_LATE && (ctx->img2.imgtype==IW_IMGTYPE_GRAY ||
		ctx->img2.imgtype==IW_IMGTYPE_GRAYA))
	{
		ctx->img2_ci[0].bkgd1_color_lin = iw_color_to_grayscale(ctx,bkgd1.c[0],bkgd1.c[1],bkgd1.c[2]);
		if(ctx->bkgd_checkerboard) {
			ctx->img2_ci[0].bkgd2_color_lin = iw_color_to_grayscale(ctx,bkgd2.c[0],bkgd2.c[1],bkgd2.c[2]);
		}
	}
	else if(ctx->apply_bkgd_strategy==IW_BKGD_STRATEGY_EARLY && ctx->img2.imgtype==IW_IMGTYPE_RGB) {
		for(i=0;i<3;i++) {
			ctx->intermed_ci[i].bkgd_color_lin = bkgd1.c[i];
		}
	}
	else if(ctx->apply_bkgd_strategy==IW_BKGD_STRATEGY_EARLY && ctx->img2.imgtype==IW_IMGTYPE_GRAY) {
		ctx->intermed_ci[0].bkgd_color_lin = iw_color_to_grayscale(ctx,bkgd1.c[0],bkgd1.c[1],bkgd1.c[2]);
	}
}
