void send_v2_notification(struct state *p1st, u_int16_t type,
			  struct state *encst,
			  u_char *icookie,
			  u_char *rcookie,
			  chunk_t *n_data)
{
	u_char buffer[1024];
	pb_stream reply;
	pb_stream rbody;
	chunk_t child_spi, notify_data;

	/* this function is not generic enough yet just enough for 6msg
	 * TBD accept HDR FLAGS as arg. default ISAKMP_FLAGS_R
	 * TBD when there is a child SA use that SPI in the notify paylod.
	 * TBD support encrypted notifications payloads.
	 * TBD accept Critical bit as an argument. default is set.
	 * TBD accept exchange type as an arg, default is ISAKMP_v2_SA_INIT
	 * do we need to send a notify with empty data?
	 * do we need to support more Protocol ID? more than PROTO_ISAKMP
	 */

	libreswan_log("sending %s notification %s to %s:%u",
		      encst ? "encrypted " : "",
		      enum_name(&ikev2_notify_names, type),
		      ip_str(&p1st->st_remoteaddr),
		      p1st->st_remoteport);
#if 0
/* Empty notification data section should be fine? */
	if (n_data == NULL) {
		DBG(DBG_CONTROLMORE,
		    DBG_log("don't send packet when notification data empty"));
		return;
	}
#endif

	memset(buffer, 0, sizeof(buffer));
	init_pbs(&reply, buffer, sizeof(buffer), "notification msg");

	/* HDR out */
	{
		struct isakmp_hdr n_hdr;
		zero(&n_hdr);                           /* default to 0 */  /* AAA should we copy from MD? */
		/* Impair function will raise major/minor by 1 for testing */
		n_hdr.isa_version = build_ike_version();
		memcpy(n_hdr.isa_rcookie, rcookie, COOKIE_SIZE);
		memcpy(n_hdr.isa_icookie, icookie, COOKIE_SIZE);
		n_hdr.isa_xchg = ISAKMP_v2_SA_INIT;
		n_hdr.isa_np = ISAKMP_NEXT_v2N;
		n_hdr.isa_flags &= ~ISAKMP_FLAGS_I;
		n_hdr.isa_flags  |=  ISAKMP_FLAGS_R;
#warning check msgid code here
		/* PAUL: shouldn't we set n_hdr.isa_msgid = [htonl](p1st->st_msgid); */
		if (!out_struct(&n_hdr, &isakmp_hdr_desc, &reply, &rbody)) {
			libreswan_log(
				"error initializing hdr for notify message");
			return;
		}

	}
	child_spi.ptr = NULL;
	child_spi.len = 0;

	/* build and add v2N payload to the packet */
	memset(&child_spi, 0, sizeof(child_spi));
	memset(&notify_data, 0, sizeof(notify_data));
	ship_v2N(ISAKMP_NEXT_v2NONE, DBGP(
			 IMPAIR_SEND_BOGUS_ISAKMP_FLAG) ?
		 (ISAKMP_PAYLOAD_NONCRITICAL | ISAKMP_PAYLOAD_LIBRESWAN_BOGUS) :
		 ISAKMP_PAYLOAD_NONCRITICAL, PROTO_ISAKMP,
		 &child_spi,
		 type, n_data, &rbody);

	close_message(&rbody, p1st);
	close_output_pbs(&reply);

	clonetochunk(p1st->st_tpacket, reply.start, pbs_offset(&reply),
		     "notification packet");

	send_ike_msg(p1st, __FUNCTION__);
}
