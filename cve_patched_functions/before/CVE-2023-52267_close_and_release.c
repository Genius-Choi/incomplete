int EpollSocket::close_and_release(epoll_event &epoll_event) {
    if (epoll_event.data.ptr == NULL) {
        return 0;
    }
    LOG_DEBUG("connect close");

    EpollContext *hc = (EpollContext *) epoll_event.data.ptr;
    if (_watcher) {
        _watcher->on_close(*hc);
    }

    int fd = hc->fd;
    epoll_event.events = EPOLLIN | EPOLLOUT;
    if (_epollfd > 0) {
        epoll_ctl(_epollfd, EPOLL_CTL_DEL, fd, &epoll_event);
    }
    
    remove_client(hc);
    if (_clients == 0 && _status == S_REJECT_CONN) {
        _status = S_STOP;
        LOG_INFO("client is empty and ready for stop server!");
    }

    delete (EpollContext *) epoll_event.data.ptr;
    epoll_event.data.ptr = NULL;

    int ret = 0;
    if (fd > 0) {
        ret = close(fd);
    }

    LOG_DEBUG("connect close complete which fd:%d, ret:%d", fd, ret);
    return ret;
}
