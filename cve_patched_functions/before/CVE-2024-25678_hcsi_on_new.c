hcsi_on_new (void *stream_if_ctx, struct lsquic_stream *stream)
{
    struct ietf_full_conn *const conn = (void *) stream_if_ctx;
    const struct hcsi_callbacks *callbacks;

    conn->ifc_mflags |= MF_HAVE_HCSI;

    switch ((!!(conn->ifc_flags & IFC_SERVER) << 8) | conn->ifc_conn.cn_version)
    {
        case (0 << 8) | LSQVER_ID27:
            callbacks = &hcsi_callbacks_client_27;
            break;
        case (1 << 8) | LSQVER_ID27:
            callbacks = &hcsi_callbacks_server_27;
            break;
        case (0 << 8) | LSQVER_ID29:
        case (0 << 8) | LSQVER_I001:
        case (0 << 8) | LSQVER_I002:
            callbacks = &hcsi_callbacks_client_29;
            break;
        default:
            assert(0);
            /* fallthru */
        case (1 << 8) | LSQVER_ID29:
        case (1 << 8) | LSQVER_I001:
        case (1 << 8) | LSQVER_I002:
            callbacks = &hcsi_callbacks_server_29;
            break;
    }
    lsquic_hcsi_reader_init(&conn->ifc_hcsi.reader, &conn->ifc_conn,
                                                            callbacks, conn);
    lsquic_stream_wantread(stream, 1);
    return stream_if_ctx;
}
