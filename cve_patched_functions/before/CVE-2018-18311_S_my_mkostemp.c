S_my_mkostemp(char *templte, int flags) {
    dTHX;
    STRLEN len = strlen(templte);
    int fd;
    int attempts = 0;

    if (len < 6 ||
        templte[len-1] != 'X' || templte[len-2] != 'X' || templte[len-3] != 'X' ||
        templte[len-4] != 'X' || templte[len-5] != 'X' || templte[len-6] != 'X') {
        SETERRNO(EINVAL, LIB_INVARG);
        return -1;
    }

    do {
        int i;
        for (i = 1; i <= 6; ++i) {
            templte[len-i] = TEMP_FILE_CH[(int)(Perl_internal_drand48() * TEMP_FILE_CH_COUNT)];
        }
        fd = PerlLIO_open3(templte, O_RDWR | O_CREAT | O_EXCL | flags, 0600);
    } while (fd == -1 && errno == EEXIST && ++attempts <= 100);

    return fd;
}
