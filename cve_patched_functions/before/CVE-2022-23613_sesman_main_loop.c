sesman_main_loop(void)
{
    int error;
    int robjs_count;
    int wobjs_count;
    int cont;
    int timeout;
    int index;
    intptr_t robjs[32];
    intptr_t wobjs[32];
    struct sesman_con *scon;

    g_con_list = list_create();
    if (g_con_list == NULL)
    {
        LOG(LOG_LEVEL_ERROR, "sesman_main_loop: list_create failed");
        return 1;
    }
    g_list_trans = trans_create(TRANS_MODE_TCP, 8192, 8192);
    if (g_list_trans == NULL)
    {
        LOG(LOG_LEVEL_ERROR, "sesman_main_loop: trans_create failed");
        list_delete(g_con_list);
        return 1;
    }

    LOG(LOG_LEVEL_DEBUG, "sesman_main_loop: address %s port %s",
        g_cfg->listen_address, g_cfg->listen_port);
    error = trans_listen_address(g_list_trans, g_cfg->listen_port,
                                 g_cfg->listen_address);
    if (error != 0)
    {
        LOG(LOG_LEVEL_ERROR, "sesman_main_loop: trans_listen_address "
            "failed");
        trans_delete(g_list_trans);
        list_delete(g_con_list);
        return 1;
    }
    g_list_trans->trans_conn_in = sesman_listen_conn_in;
    cont = 1;
    while (cont)
    {
        timeout = -1;
        robjs_count = 0;
        robjs[robjs_count++] = g_term_event;
        wobjs_count = 0;
        for (index = 0; index < g_con_list->count; index++)
        {
            scon = (struct sesman_con *)list_get_item(g_con_list, index);
            if (scon != NULL)
            {
                error = trans_get_wait_objs_rw(scon->t,
                                               robjs, &robjs_count,
                                               wobjs, &wobjs_count, &timeout);
                if (error != 0)
                {
                    LOG(LOG_LEVEL_ERROR, "sesman_main_loop: "
                        "trans_get_wait_objs_rw failed");
                    break;
                }
            }
        }
        if (error != 0)
        {
            break;
        }
        error = trans_get_wait_objs_rw(g_list_trans, robjs, &robjs_count,
                                       wobjs, &wobjs_count, &timeout);
        if (error != 0)
        {
            LOG(LOG_LEVEL_ERROR, "sesman_main_loop: "
                "trans_get_wait_objs_rw failed");
            break;
        }

        error = g_obj_wait(robjs, robjs_count, wobjs, wobjs_count, timeout);
        if (error != 0)
        {
            /* error, should not get here */
            g_sleep(100);
        }

        if (g_is_wait_obj_set(g_term_event)) /* term */
        {
            break;
        }

        for (index = 0; index < g_con_list->count; index++)
        {
            scon = (struct sesman_con *)list_get_item(g_con_list, index);
            if (scon != NULL)
            {
                error = trans_check_wait_objs(scon->t);
                if (error != 0)
                {
                    LOG(LOG_LEVEL_ERROR, "sesman_main_loop: "
                        "trans_check_wait_objs failed, removing trans");
                    delete_connection(scon);
                    list_remove_item(g_con_list, index);
                    index--;
                    continue;
                }
            }
        }
        error = trans_check_wait_objs(g_list_trans);
        if (error != 0)
        {
            LOG(LOG_LEVEL_ERROR, "sesman_main_loop: "
                "trans_check_wait_objs failed");
            break;
        }
    }
    for (index = 0; index < g_con_list->count; index++)
    {
        scon = (struct sesman_con *) list_get_item(g_con_list, index);
        delete_connection(scon);
    }
    list_delete(g_con_list);
    trans_delete(g_list_trans);
    return 0;
}
