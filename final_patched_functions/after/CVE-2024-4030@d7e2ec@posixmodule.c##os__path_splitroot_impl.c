os__path_splitroot_impl(PyObject *module, path_t *path)
/*[clinic end generated code: output=ab7f1a88b654581c input=dc93b1d3984cffb6]*/
{
    wchar_t *buffer;
    wchar_t *end;
    PyObject *result = NULL;

    buffer = (wchar_t*)PyMem_Malloc(sizeof(wchar_t) * (wcslen(path->wide) + 1));
    if (!buffer) {
        return NULL;
    }
    wcscpy(buffer, path->wide);
    for (wchar_t *p = wcschr(buffer, L'/'); p; p = wcschr(p, L'/')) {
        *p = L'\\';
    }

    Py_BEGIN_ALLOW_THREADS
    if (buffer[0] && buffer[1] == L':') {
        if (buffer[2] == L'\\') {
            end = &buffer[3];
        } else {
            end = &buffer[2];
        }
    } else {
        end = PathSkipRootW(buffer);
    }
    Py_END_ALLOW_THREADS
    if (!end || end == buffer) {
        result = Py_BuildValue("sO", "", path->object);
    } else if (!*end) {
        result = Py_BuildValue("Os", path->object, "");
    } else {
        size_t rootLen = (size_t)(end - buffer);
        result = Py_BuildValue("NN",
            PyUnicode_FromWideChar(path->wide, rootLen),
            PyUnicode_FromWideChar(path->wide + rootLen, -1)
        );
    }
    PyMem_Free(buffer);

    return result;
}
