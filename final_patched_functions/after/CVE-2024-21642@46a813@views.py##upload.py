def upload():
    if not request.files:
        raise Exception("No file data loaded!")
    for filename in request.files:
        contents = request.files[filename]
        _, ext = os.path.splitext(filename)
        if ext in [".csv", ".tsv"]:
            kwargs = build_csv_kwargs(request)
            df = pd.read_csv(
                StringIO(contents.read().decode()), engine="python", **kwargs
            )
            return load_new_data(
                df, "df = pd.read_csv('{}', engine='python', sep=None)".format(filename)
            )
        if ext in [".xls", ".xlsx"]:
            engine = "xlrd" if ext == ".xls" else "openpyxl"
            dfs = pd.read_excel(contents, sheet_name=None, engine=engine)

            def build_xls_code(sheet_name):
                return "df = pd.read_excel('{}', sheet_name='{}', engine='{}')".format(
                    filename, sheet_name, engine
                )

            dfs = {
                sheet_name: (df, build_xls_code(sheet_name))
                for sheet_name, df in dfs.items()
            }
            return handle_excel_upload(dfs)
        if "parquet" in filename:
            df = pd.read_parquet(contents)
            return load_new_data(df, "df = pd.read_parquet('{}')".format(filename))
        raise Exception("File type of {} is not supported!".format(ext))
