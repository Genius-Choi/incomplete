static int var_files_tmp_contents_generate(modsec_rec *msr, msre_var *var,
    msre_rule *rule, apr_table_t *vartab, apr_pool_t *mptmp)
{
    multipart_part **parts = NULL;
    int i, count = 0;

    if (msr->mpd == NULL) return 0;

    parts = (multipart_part **)msr->mpd->parts->elts;
    for (i = 0; i < msr->mpd->parts->nelts; i++)
    {
        if ((parts[i]->type == MULTIPART_FILE) &&
                (parts[i]->tmp_file_name != NULL))
        {
            int match = 0;

            /* Figure out if we want to include this variable. */
            if (var->param == NULL)
            {
                match = 1;
            }
            else
            {
                if (var->param_data != NULL)
                {
                    /* Regex. */
                    char *my_error_msg = NULL;
                    if (!(msc_regexec((msc_regex_t *)var->param_data,
                        parts[i]->name, strlen(parts[i]->name),
                        &my_error_msg) == PCRE_ERROR_NOMATCH)) 
                    {
                        match = 1;
                    }
                }
                else
                {
                    /* Simple comparison. */
                    if (strcasecmp(parts[i]->name, var->param) == 0)
                    {
                        match = 1;
                    }
                }
            }
            /* If we had a match add this argument to the collection. */
            if (match) {
                char buf[1024];
                FILE *file;
                size_t nread;
                char *full_content = NULL;
                char *full_content_tmp_ptr = NULL;
                size_t total_lenght = 0;
                msre_var *rvar = NULL;

                file = fopen(parts[i]->tmp_file_name, "r");
                if (file == NULL)
                {
                    continue;
                }

                full_content = (char *)apr_pcalloc(mptmp, (sizeof(char)*parts[i]->length) + 1);
                if (full_content == NULL) {
                    if (msr->txcfg->debuglog_level >= 3) {
                        msr_log(msr, 3, "Variable FILES_TMP_CONTENT will not be created, not " \
                            "enough memory available.");
                    }
                    goto files_tmp_content_not_enough_mem;
                }
                full_content_tmp_ptr = full_content;

                while ((nread = fread(buf, 1, 1023, file)) > 0)
                {   
                    full_content_tmp_ptr = memcpy(full_content_tmp_ptr, buf, nread);
                    full_content_tmp_ptr += nread;
                    total_lenght         += nread;
                }
                full_content_tmp_ptr[total_lenght] = '\0';
                fclose(file);

                rvar = apr_pmemdup(mptmp, var, sizeof(msre_var));
                rvar->value = full_content;
                rvar->value_len = total_lenght;
                rvar->name = apr_psprintf(mptmp, "FILES_TMP_CONTENT:%s",
                    log_escape_nq(mptmp, parts[i]->name));
                apr_table_addn(vartab, rvar->name, (void *)rvar);

                count++;
            }
        }
    }

files_tmp_content_not_enough_mem:
    return count;
}
