extern "C" HRESULT CacheBundleToCleanRoom(
    __in BOOL fElevated,
    __in BURN_CACHE* pCache,
    __in BURN_SECTION* pSection,
    __deref_out_z_opt LPWSTR* psczCleanRoomBundlePath
    )
{
    HRESULT hr = S_OK;
    LPWSTR sczSourcePath = NULL;
    LPWSTR wzExecutableName = NULL;

    hr = PathForCurrentProcess(&sczSourcePath, NULL);
    ExitOnFailure(hr, "Failed to get current path for process to cache to clean room.");

    wzExecutableName = PathFile(sczSourcePath);

    hr = CopyEngineToWorkingFolder(fElevated, pCache, sczSourcePath, BUNDLE_CLEAN_ROOM_WORKING_FOLDER_NAME, wzExecutableName, pSection, psczCleanRoomBundlePath);
    ExitOnFailure(hr, "Failed to cache bundle to clean room.");

LExit:
    ReleaseStr(sczSourcePath);

    return hr;
}
