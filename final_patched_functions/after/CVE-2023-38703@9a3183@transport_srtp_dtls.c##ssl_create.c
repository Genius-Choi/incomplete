static pj_status_t ssl_create(dtls_srtp *ds, unsigned idx)
{
    SSL_CTX *ctx;
    unsigned i;
    int mode, rc;

    /* Check if it is already instantiated */
    if (ds->ossl_ssl[idx])
        return PJ_SUCCESS;

    /* Create DTLS context */
    ctx = SSL_CTX_new(DTLS_method());
    if (ctx == NULL) {
        return GET_SSL_STATUS(ds);
    }

    if (valid_profiles_cnt == 0) {
        SSL_CTX_free(ctx);
        return PJMEDIA_SRTP_DTLS_ENOPROFILE;
    }

    /* Set crypto */
    if (1) {
        char *p, *end, buf[PJ_ARRAY_SIZE(ossl_profiles)*25];
        unsigned n;

        p = buf;
        end = buf + sizeof(buf);
        for (i=0; i<ds->srtp->setting.crypto_count && p < end; ++i) {
            pjmedia_srtp_crypto *crypto = &ds->srtp->setting.crypto[i];
            unsigned j;
            for (j=0; j < valid_profiles_cnt; ++j) {
                if (!pj_ansi_strcmp(crypto->name.ptr,
                                    valid_pj_profiles_list[j]))
                {
                    n = pj_ansi_snprintf(p, end-p, ":%s",
                                         valid_ossl_profiles_list[j]);
                    p += n;
                    break;
                }
            }

        }
        rc = SSL_CTX_set_tlsext_use_srtp(ctx, buf+1);
        PJ_LOG(4,(ds->base.name, "Setting crypto [%s], errcode=%d", buf, rc));
        if (rc != 0) {
            SSL_CTX_free(ctx);
            return GET_SSL_STATUS(ds);
        }
    }

    /* Set ciphers */
    SSL_CTX_set_cipher_list(ctx, PJMEDIA_SRTP_DTLS_OSSL_CIPHERS);

    /* Set cert & private key */
    rc = SSL_CTX_use_certificate(ctx, dtls_cert);
    pj_assert(rc);
    rc = SSL_CTX_use_PrivateKey(ctx, dtls_priv_key);
    pj_assert(rc);
    rc = SSL_CTX_check_private_key(ctx);
    pj_assert(rc);

    /* Create SSL instance */
    ds->ossl_ctx[idx] = ctx;
    ds->ossl_ssl[idx] = SSL_new(ds->ossl_ctx[idx]);
    if (ds->ossl_ssl[idx] == NULL) {
        SSL_CTX_free(ctx);
        return GET_SSL_STATUS(ds);
    }

    /* Set MTU */
#ifdef DTLS_CTRL_SET_LINK_MTU
    if (!SSL_ctrl(ds->ossl_ssl[idx], DTLS_CTRL_SET_LINK_MTU, PJMEDIA_MAX_MTU,
                  NULL))
    {
        PJ_LOG(4, (ds->base.name,
                  "Ignored failure in setting MTU to %d (too small?)",
                  PJMEDIA_MAX_MTU));
    }
#endif

    /* SSL verification options, must be mutual auth */
    mode = SSL_VERIFY_PEER | SSL_VERIFY_FAIL_IF_NO_PEER_CERT;
    SSL_set_verify(ds->ossl_ssl[idx], mode, &verify_cb);

    /* Setup SSL BIOs */
    ds->ossl_rbio[idx] = BIO_new(BIO_s_mem());
    ds->ossl_wbio[idx] = BIO_new(BIO_s_mem());
    (void)BIO_set_close(ds->ossl_rbio[idx], BIO_CLOSE);
    (void)BIO_set_close(ds->ossl_wbio[idx], BIO_CLOSE);
    SSL_set_bio(ds->ossl_ssl[idx], ds->ossl_rbio[idx], ds->ossl_wbio[idx]);

    return PJ_SUCCESS;
}
