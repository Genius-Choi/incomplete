def test_check_rebuild_refcounts(archiver):
    cmd(archiver, "rcreate", RK_ENCRYPTION)
    create_src_archive(archiver, "archive_tam")
    archive_id_pre_check = cmd(archiver, "rlist", "--format='{name} {id}{NL}'")
    repository = Repository(archiver.repository_path, exclusive=True)
    with repository:
        write_archive_without_tam(repository, "archive_no_tam")
    output = cmd(archiver, "rlist", "--format='{name} tam:{tam}{NL}'")
    assert "archive_tam tam:verified" in output  # good
    assert "archive_no_tam tam:none" in output  # could be borg < 1.0.9 archive or fake
    cmd(archiver, "check", "--repair")
    output = cmd(archiver, "rlist", "--format='{name} tam:{tam}{NL}'")
    assert "archive_tam tam:verified" in output  # TAM-verified archive still there
    assert "archive_no_tam" not in output  # check got rid of untrusted not TAM-verified archive
    archive_id_post_check = cmd(archiver, "rlist", "--format='{name} {id}{NL}'")
    assert archive_id_post_check == archive_id_pre_check  # rebuild_refcounts didn't change archive_tam archive id
