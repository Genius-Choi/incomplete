  def notification
    amz_message_type = request.headers['x-amz-sns-message-type']

    if amz_message_type.to_s.downcase == 'subscriptionconfirmation'
      if send_subscription_confirmation request.raw_post
        head :ok and return
      else
        head :bad_request and return
      end
    end

    if amz_message_type.to_s.downcase == 'notification'
      msg = JSON.parse(request.raw_post)
      # Sometimes amazon sends notifications more wrapped than other times
      msg = JSON.load(msg['Message']) unless msg['Message'].nil?
      type = msg['notificationType']

      if type == 'Bounce'
        handle_bounces(msg)
      elsif type == 'Complaint'
        handle_complaints(msg)
      else
        logger.warn "\nUnrecognized message from Amazon SNS notification center:"
        logger.warn msg.to_s
      end
    end
    head :ok
  end
