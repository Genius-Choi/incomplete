void strbuf_utf8_replace(struct strbuf *sb_src, int pos, int width,
			 const char *subst)
{
	const char *src = sb_src->buf, *end = sb_src->buf + sb_src->len;
	struct strbuf dst;
	int w = 0;

	strbuf_init(&dst, sb_src->len);

	while (src < end) {
		const char *old;
		int glyph_width;
		size_t n;

		while ((n = display_mode_esc_sequence_len(src))) {
			strbuf_add(&dst, src, n);
			src += n;
		}

		if (src >= end)
			break;

		old = src;
		glyph_width = utf8_width((const char**)&src, NULL);
		if (!src) /* broken utf-8, do nothing */
			goto out;

		/*
		 * In case we see a control character we copy it into the
		 * buffer, but don't add it to the width.
		 */
		if (glyph_width < 0)
			glyph_width = 0;

		if (glyph_width && w >= pos && w < pos + width) {
			if (subst) {
				strbuf_addstr(&dst, subst);
				subst = NULL;
			}
		} else {
			strbuf_add(&dst, old, src - old);
		}

		w += glyph_width;
	}

	strbuf_swap(sb_src, &dst);
out:
	strbuf_release(&dst);
}
