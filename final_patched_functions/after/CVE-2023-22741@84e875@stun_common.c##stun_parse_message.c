int stun_parse_message(stun_msg_t *msg)
{
  unsigned len;
  int i;
  unsigned char *p;

  /* parse header first */
  p = msg->enc_buf.data;

  if (get16(p, 2) > (msg->enc_buf.size - 20))
  {
    SU_DEBUG_3(("%s: Error STUN Message Length is too big.\n", __func__));
    return -1;
  }

  msg->stun_hdr.msg_type = get16(p, 0);
  msg->stun_hdr.msg_len = get16(p, 2);
  memcpy(msg->stun_hdr.tran_id, p + 4, STUN_TID_BYTES);

  SU_DEBUG_5(("%s: Parse STUN message: Length = %d\n", __func__,
	      msg->stun_hdr.msg_len));

  /* parse attributes */
  len = msg->stun_hdr.msg_len;
  p = msg->enc_buf.data + 20;
  msg->stun_attr = NULL;
  while (len >= 4) {  // Type (2) + Length (2) + Value (variable) min attribute size
    i = stun_parse_attribute(msg, p, len);
    if (i <= 0 || i > len) {
      SU_DEBUG_3(("%s: Error parsing attribute.\n", __func__));
      return -1;
    }
    p += i;
    len -= i;
  }

  return 0;
}
