static int _git_ssh_session_create(
	LIBSSH2_SESSION **session,
	LIBSSH2_KNOWNHOSTS **hosts,
	const char *hostname,
	int port,
	git_stream *io)
{
	int rc = 0;
	LIBSSH2_SESSION *s;
	LIBSSH2_KNOWNHOSTS *known_hosts;
	git_socket_stream *socket = GIT_CONTAINER_OF(io, git_socket_stream, parent);
	const char *keytype = NULL;

	GIT_ASSERT_ARG(session);
	GIT_ASSERT_ARG(hosts);

	s = libssh2_session_init();
	if (!s) {
		git_error_set(GIT_ERROR_NET, "failed to initialize SSH session");
		return -1;
	}

	if ((rc = load_known_hosts(&known_hosts, s)) < 0) {
		ssh_error(s, "error loading known_hosts");
		libssh2_session_free(s);
		return -1;
	}

	if ((keytype = find_hostkey_preference(known_hosts, hostname, port)) != NULL) {
		do {
			rc = libssh2_session_method_pref(s, LIBSSH2_METHOD_HOSTKEY, keytype);
		} while (LIBSSH2_ERROR_EAGAIN == rc || LIBSSH2_ERROR_TIMEOUT == rc);
		if (rc != LIBSSH2_ERROR_NONE) {
			ssh_error(s, "failed to set hostkey preference");
			goto on_error;
		}
	}


	do {
		rc = libssh2_session_handshake(s, socket->s);
	} while (LIBSSH2_ERROR_EAGAIN == rc || LIBSSH2_ERROR_TIMEOUT == rc);

	if (rc != LIBSSH2_ERROR_NONE) {
		ssh_error(s, "failed to start SSH session");
		goto on_error;
	}

	libssh2_session_set_blocking(s, 1);

	*session = s;
	*hosts = known_hosts;

	return 0;

on_error:
	libssh2_knownhost_free(known_hosts);
	libssh2_session_free(s);
	return -1;
}
