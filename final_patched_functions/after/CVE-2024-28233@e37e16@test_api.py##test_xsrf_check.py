async def test_xsrf_check(app, username, method, path, xsrf_in_url):
    cookies = await app.login_user(username)
    xsrf = cookies['_xsrf']
    if xsrf_in_url == "invalid":
        cookies.pop("_xsrf")
        # a valid old-style tornado xsrf token is no longer valid
        xsrf = cookies['_xsrf'] = (
            "2|7329b149|d837ced983e8aac7468bc7a61ce3d51a|1708610065"
        )

    url = path.format(username=username)
    if xsrf_in_url:
        url = f"{url}?_xsrf={xsrf}"

    r = await api_request(
        app,
        url,
        noauth=True,
        cookies=cookies,
    )
    if xsrf_in_url is True:
        assert r.status_code == 200
    else:
        assert r.status_code == 403
