static int show_preauthpage(struct MHD_Connection *connection, const char *query)
{
	s_config *config = config_get_config();

	char *msg;
	const char *user_agent;
	char *enc_user_agent;
	char *preauthpath;
	char *cmd;
	char *enc_query;

	int rc;
	int ret;
	struct MHD_Response *response;

	if ( strlen(query) < 1 ) {
		// query string is blank, too long or corrupt
		return send_error(connection, 511);
	} else {	
		preauthpath = safe_calloc(SMALL_BUF);
		safe_asprintf(&preauthpath, "/%s/", config->preauthdir);

		if (strcmp(preauthpath, config->fas_path) == 0) {
			free (preauthpath);

			user_agent = safe_calloc(USER_AGENT);
			debug(LOG_DEBUG, "PreAuth: User Agent ptr is [ %d ]", &user_agent);
			enc_user_agent = safe_calloc(ENC_USER_AGENT);

			MHD_get_connection_values(connection, MHD_HEADER_KIND, get_user_agent_callback, &user_agent);
			debug(LOG_DEBUG, "PreAuth: MHD User Agent ptr is [ %d ]", &user_agent);

			if (user_agent == NULL) {
				return send_error(connection, 403);
			}

			uh_urlencode(enc_user_agent, ENC_USER_AGENT, user_agent, strlen(user_agent));
			debug(LOG_DEBUG, "PreAuth: Encoded User Agent is [ %s ]", enc_user_agent);

			enc_query = safe_calloc(ENC_QUERYSTR);
			uh_urlencode(enc_query, ENC_QUERYSTR, query, strlen(query));
			debug(LOG_DEBUG, "PreAuth: Encoded query: %s", enc_query);

			msg = safe_calloc(HTMLMAXSIZE);

			if (!msg) {
				ret = send_error(connection, 503);
				free(msg);
				free(enc_user_agent);
				free(enc_query);
				return ret;
			}

			cmd = safe_calloc(QUERYMAXLEN);
			safe_asprintf(&cmd, "%s '%s' '%s' '%d' '%s'", config->preauth, enc_query, enc_user_agent, config->login_option_enabled, config->themespec_path);
			rc = execute_ret_url_encoded(msg, HTMLMAXSIZE - 1, cmd);
			free(cmd);

			if (rc != 0) {
				debug(LOG_WARNING, "Preauth script - failed to execute: %s, Query[%s]", config->preauth, query);
				free(msg);
				free(enc_user_agent);
				free(enc_query);

				return send_error(connection, 511);
			}

			// serve the script output (in msg)
			response = MHD_create_response_from_buffer(strlen(msg), (char *)msg, MHD_RESPMEM_MUST_FREE);

			if (!response) {
				return send_error(connection, 503);
			}

			MHD_add_response_header(response, "Content-Type", "text/html; charset=utf-8");
			ret = MHD_queue_response(connection, MHD_HTTP_OK, response);
			MHD_destroy_response(response);

			free(enc_user_agent);
			free(enc_query);
			return ret;
		} else {
			free (preauthpath);
			return send_error(connection, 404);
		}
	}
}
