    def patched_apply_xheaders(self, headers: "tornado.httputil.HTTPHeaders") -> None:
        """Rewrite the ``remote_ip`` and ``protocol`` fields."""

        # other than the default implementation, we only use "X-Forwarded-For" here, not "X-Real-Ip"
        ip = octoprint.util.net.get_http_client_ip(
            self.remote_ip, headers.get("X-Forwarded-For"), self.trusted_downstream
        )
        if tornado.netutil.is_valid_ip(ip):
            self.remote_ip = ip

        # also fetch scheme from "X-Forwarded-Proto" if available
        proto_header = headers.get("X-Scheme", headers.get("X-Forwarded-Proto"))
        if proto_header:
            # use only the last proto entry if there is more than one
            proto_header = proto_header.split(",")[-1].strip()
        if proto_header in ("http", "https"):
            self.protocol = proto_header
