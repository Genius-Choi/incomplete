static int security_handshake_failed(struct nvnc_client* client,
		const char* username, const char* reason_string)
{
	if (username)
		nvnc_log(NVNC_LOG_INFO, "Security handshake failed for \"%s\": %s",
				username, reason_string);
	else
		nvnc_log(NVNC_LOG_INFO, "Security handshake: %s",
				username, reason_string);

	char buffer[256];

	client->state = VNC_CLIENT_STATE_ERROR;

	uint32_t* result = (uint32_t*)buffer;

	struct rfb_error_reason* reason =
	        (struct rfb_error_reason*)(buffer + sizeof(*result));

	*result = htonl(RFB_SECURITY_HANDSHAKE_FAILED);
	reason->length = htonl(strlen(reason_string));
	strcpy(reason->message, reason_string);

	size_t len = sizeof(*result) + sizeof(*reason) + strlen(reason_string);
	stream_write(client->net_stream, buffer, len, close_after_write,
			client);

	return 0;
}
