async def test_add_multi_user_admin(app, create_user_with_scopes, is_admin):
    db = app.db
    requester = create_user_with_scopes("admin:users")
    requester.admin = is_admin
    db.commit()
    names = ['c', 'd']
    r = await api_request(
        app,
        'users',
        method='post',
        data=json.dumps({'usernames': names, 'admin': True}),
        name=requester.name,
    )
    if is_admin:
        assert r.status_code == 201
    else:
        assert r.status_code == 403
        return
    reply = r.json()
    r_names = [user['name'] for user in reply]
    assert names == r_names

    for name in names:
        user = find_user(db, name)
        assert user is not None
        assert user.name == name
        assert user.admin
        assert orm.Role.find(db, 'user') in user.roles
        assert orm.Role.find(db, 'admin') in user.roles
