def process_managed_item_histories(object_queue, machine):
    histories = machine.manageditemhistory_set.all()
    for managed_item in object_queue["managed_items"]:
        item_histories = histories.filter(
            name=managed_item.name, management_source=managed_item.management_source
        )
        if _history_creation_needed(managed_item, item_histories.first()):
            object_queue["managed_item_histories"].append(
                ManagedItemHistory(
                    name=managed_item.name,
                    status=managed_item.status,
                    management_source=managed_item.management_source,
                    machine=machine,
                    recorded=managed_item.date_managed,
                )
            )

    return object_queue
