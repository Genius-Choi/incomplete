def generate_key_if_missing(key):
    value = env.str(key, "")

    if value == "":
        print(f'Warning: {key} not found in environment variables will generate a random key.')
        value = get_random_secret_key()
        try:
            with open(env_file, 'a') as f:
                f.write(f'\n{key}={value}\n')
        except Exception as e:
            print(f'Warning: failed to write {key} to .env file: {e}, new key will be regenerated on every server restart. If this key is used for signing, it will invalidate all existing sessions or tokens. Please set {key} in your environment variables to avoid this warning.')

        os.environ[key] = value

    return value
