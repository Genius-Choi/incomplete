def upgrade() -> None:
    """Upgrade database schema and/or data, creating a new revision."""
    # ### commands auto generated by Alembic - please adjust! ###
    bind = op.get_bind()
    session = sqlmodel.Session(bind=bind)

    with op.batch_alter_table("user", schema=None) as batch_op:
        batch_op.add_column(
            sa.Column(
                "is_admin",
                sa.Boolean(),
                nullable=False,
                server_default=sa.sql.expression.false(),
            )
        )

    # during migration we treat all users as admin for backward compatibility
    # this should be adjusted by server admins after upgrade
    session.execute(
        sa.text(
            """
            UPDATE user
            SET is_admin = true
            WHERE NOT is_service_account AND external_user_id IS NULL
            """
        )
    )
