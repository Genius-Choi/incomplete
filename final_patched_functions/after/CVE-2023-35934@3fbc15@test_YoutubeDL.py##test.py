        def test(encoded_cookies, cookies, headers=False, round_trip=None, error=None):
            def _test():
                ydl.cookiejar.clear()
                ydl._load_cookies(encoded_cookies, from_headers=headers)
                if headers:
                    ydl._apply_header_cookies(_test_url)
                data = {'url': _test_url}
                ydl._calc_headers(data)
                self.assertCountEqual(
                    map(vars, ydl.cookiejar), map(vars, cookies),
                    'Extracted cookiejar.Cookie is not the same')
                if not headers:
                    self.assertEqual(
                        data.get('cookies'), round_trip or encoded_cookies,
                        'Cookie is not the same as round trip')
                ydl.__dict__['_YoutubeDL__header_cookies'] = []

            with self.subTest(msg=encoded_cookies):
                if not error:
                    _test()
                    return
                with self.assertRaisesRegex(Exception, error):
                    _test()
