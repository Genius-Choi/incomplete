    def handle(data)
      if data[-1] == "\r"
        @cr_present = true
        data = data.chop # remove last character (\r)
      else
        Postal.logger.debug("\e[33m   WARN: Detected line with invalid line ending (missing <CR>)\e[0m", id: id)
        @cr_present = false
      end

      Postal.logger.tagged(id: id) do
        if @state == :preauth
          return proxy(data)
        end

        log "\e[32m<= #{sanitize_input_for_log(data.strip)}\e[0m"
        if @proc
          @proc.call(data)
        else
          handle_command(data)
        end
      end
    ensure
      @previous_cr_present = @cr_present
    end
