def make_environment_file(environment_file_directory, unit_name, environment_variables):
    """Make a systemd environment file

    - ensures environment directory exists and is private
    - writes private environment file
    - returns path to created environment file
    """
    ensure_environment_directory(environment_file_directory)
    env_file = os.path.join(environment_file_directory, f"{unit_name}.env")
    env_lines = []
    for key, value in sorted(environment_variables.items()):
        assert env_pat.match(key), f"{key} not a valid environment variable"
        env_lines.append(f"{key}={shlex.quote(value)}")
    env_lines.append("")  # trailing newline
    with open(env_file, mode="w") as f:
        # make the file itself private as well
        os.fchmod(f.fileno(), 0o400)
        f.write("\n".join(env_lines))

    return env_file
