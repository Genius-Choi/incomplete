def test_check_rebuild_manifest(archiver):
    cmd(archiver, "rcreate", RK_ENCRYPTION)
    create_src_archive(archiver, "archive_tam")
    repository = Repository(archiver.repository_path, exclusive=True)
    with repository:
        write_archive_without_tam(repository, "archive_no_tam")
        repository.delete(Manifest.MANIFEST_ID)  # kill manifest, so check has to rebuild it
        repository.commit(compact=False)
    cmd(archiver, "check", "--repair")
    output = cmd(archiver, "rlist", "--format='{name} tam:{tam}{NL}'")
    assert "archive_tam tam:verified" in output  # TAM-verified archive is in rebuilt manifest
    assert "archive_no_tam" not in output  # check got rid of untrusted not TAM-verified archive
