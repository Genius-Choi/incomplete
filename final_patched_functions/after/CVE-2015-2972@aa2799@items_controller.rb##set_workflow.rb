  def set_workflow
    Log.add_info(request, params.inspect)

    return unless request.post?

    @item = Item.find(params[:id])

    orders_hash = params.dup
    orders_hash.reject! { |key, value|
      key.index(/order-/) != 0
    }
    orders_hash.sort_by { |key, value|
      key.split('-').last.to_i
    }

    orders = []
    orders_hash.each do |key, value|
      user_ids = value.split(',')
      SqlHelper.validate_token([user_ids])

      orders << '|' + user_ids.join('|') + '|'
    end
    @item.workflow.update_attribute(:users, orders.join(','))

    render(:partial => 'ajax_item_workflow', :layout => false)

  rescue => evar
    Log.add_error(request, evar)

    render(:partial => 'ajax_item_workflow', :layout => false)
  end
