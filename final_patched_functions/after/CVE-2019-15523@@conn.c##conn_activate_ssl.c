int conn_activate_ssl(int server_role)
{
	gnutls_alert_description_t alrt;
	char *ssl_keyfile;
	char *ssl_certfile;
	int err;
	int handshake_repeat = 0;

	if (csync_conn_usessl)
		return 0;

	ASPRINTF(&ssl_keyfile, "%s/csync2_ssl_key.pem", systemdir);
	ASPRINTF(&ssl_certfile, "%s/csync2_ssl_cert.pem", systemdir);

	gnutls_global_init();
	gnutls_global_set_log_function(ssl_log);
	gnutls_global_set_log_level(10);

	gnutls_certificate_allocate_credentials(&conn_x509_cred);

	err = gnutls_certificate_set_x509_key_file(conn_x509_cred, ssl_certfile, ssl_keyfile, GNUTLS_X509_FMT_PEM);
	if(err != GNUTLS_E_SUCCESS) {
		gnutls_certificate_free_credentials(conn_x509_cred);
		gnutls_global_deinit();

		csync_fatal(
			"SSL: failed to use key file %s and/or certificate file %s: %s (%s)\n",
			ssl_keyfile,
			ssl_certfile,
			gnutls_strerror(err),
			gnutls_strerror_name(err)
		);
	}

	if(server_role) {
		gnutls_certificate_free_cas(conn_x509_cred);

		if(gnutls_certificate_set_x509_trust_file(conn_x509_cred, ssl_certfile, GNUTLS_X509_FMT_PEM) < 1) {
			gnutls_certificate_free_credentials(conn_x509_cred);
			gnutls_global_deinit();

			csync_fatal(
				"SSL: failed to use certificate file %s as CA.\n",
				ssl_certfile
			);
		}
	} else
		gnutls_certificate_free_ca_names(conn_x509_cred);

	gnutls_init(&conn_tls_session, (server_role ? GNUTLS_SERVER : GNUTLS_CLIENT));
	gnutls_priority_set_direct(conn_tls_session, "PERFORMANCE", NULL);
	gnutls_credentials_set(conn_tls_session, GNUTLS_CRD_CERTIFICATE, conn_x509_cred);

	if(server_role) {
		gnutls_certificate_send_x509_rdn_sequence(conn_tls_session, 0);
		gnutls_certificate_server_set_request(conn_tls_session, GNUTLS_CERT_REQUIRE);
	}

	gnutls_transport_set_ptr2(
		conn_tls_session,
		(gnutls_transport_ptr_t)(long)conn_fd_in,
		(gnutls_transport_ptr_t)(long)conn_fd_out
	);


	do {
		handshake_repeat = 0;
		err = gnutls_handshake(conn_tls_session);
		switch(err) {
		case GNUTLS_E_SUCCESS:
			break;

		case GNUTLS_E_WARNING_ALERT_RECEIVED:
			alrt = gnutls_alert_get(conn_tls_session);
			fprintf(
				csync_debug_out,
				"SSL: warning alert received from peer: %d (%s).\n",
				alrt, gnutls_alert_get_name(alrt)
			);
			handshake_repeat = 1;
			break;

		case GNUTLS_E_FATAL_ALERT_RECEIVED:
			alrt = gnutls_alert_get(conn_tls_session);
			fprintf(
				csync_debug_out,
				"SSL: fatal alert received from peer: %d (%s).\n",
				alrt, gnutls_alert_get_name(alrt)
			);
			// fall-through!

		default:
			gnutls_bye(conn_tls_session, GNUTLS_SHUT_RDWR);
			gnutls_deinit(conn_tls_session);
			gnutls_certificate_free_credentials(conn_x509_cred);
			gnutls_global_deinit();

			csync_fatal(
				"SSL: handshake failed: %s (%s)\n",
				gnutls_strerror(err),
				gnutls_strerror_name(err)
			);
		}
	} while (handshake_repeat);

	csync_conn_usessl = 1;

	return 0;
}
