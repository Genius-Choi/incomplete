check_mime_type(const gchar* uri,GError** error)
{
    GError * err = NULL;
    const gchar* mimeFromFile;

    mimeFromFile = ev_file_get_mime_type(uri, FALSE, &err);
    if (mimeFromFile)
    {
        const gchar* mimetypes[] = {"application/epub+zip", "application/x-booki+zip", NULL};
        guint i;

        for (i = 0; i < g_strv_length (mimetypes); i++) {
           if (strcmp(mimeFromFile, mimetypes[i]) == 0)
                return TRUE;
        }

        /* fallback for malformed epub files */
        if (strcmp (mimeFromFile, "application/zip") == 0)
        {
            mimeFromFile = ev_file_get_mime_type (uri, TRUE, &err);
            if (mimeFromFile)
            {
                for (i = 0; i < g_strv_length (mimetypes); i++) {
                    if (g_strcmp0(mimeFromFile, mimetypes[i]) == 0)
                        return TRUE;
                }

                /*We didn't find a match*/
                g_set_error_literal (error,
                                     EV_DOCUMENT_ERROR,
                                     EV_DOCUMENT_ERROR_INVALID,
                                     _("Not an ePub document"));

                return FALSE;
            }
        }
    }

    if (err)
        g_propagate_error (error, err);
    else
        g_set_error_literal (error,
                             EV_DOCUMENT_ERROR,
                             EV_DOCUMENT_ERROR_INVALID,
                             _("Unknown MIME Type"));

    return FALSE;
}
