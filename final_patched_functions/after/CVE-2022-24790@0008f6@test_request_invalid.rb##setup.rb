  def setup
    @host = '127.0.0.1'

    @ios = []

    # this app should never be called, used for debugging
    app = ->(env) {
      body = ''.dup
      env.each do |k,v|
        body << "#{k} = #{v}\n"
        if k == 'rack.input'
          body << "#{v.read}\n"
        end
      end
      [200, {}, [body]]
    }

    @log_writer = Puma::LogWriter.strings
    events = Puma::Events.new
    @server = Puma::Server.new app, @log_writer, events
    @port = (@server.add_tcp_listener @host, 0).addr[1]
    @server.run
    sleep 0.15 if Puma.jruby?
  end
