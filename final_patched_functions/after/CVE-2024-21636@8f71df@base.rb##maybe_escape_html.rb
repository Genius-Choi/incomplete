    def maybe_escape_html(text)
      return text if request && !request.format.html?
      return text if text.nil? || text.empty?

      if text.html_safe?
        text
      else
        yield
        html_escape(text)
      end
    end
