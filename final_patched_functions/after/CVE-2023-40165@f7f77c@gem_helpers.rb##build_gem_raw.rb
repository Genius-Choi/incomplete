  def build_gem_raw(file_name:, spec:, contents_writer: nil)
    package = Gem::Package.new file_name

    File.open(file_name, "wb") do |file|
      Gem::Package::TarWriter.new(file) do |gem|
        gem.add_file "metadata.gz", 0o444 do |io|
          package.gzip_to(io) do |gz_io|
            gz_io.write spec
          end
        end
        gem.add_file "data.tar.gz", 0o444 do |io|
          package.gzip_to io do |gz_io|
            Gem::Package::TarWriter.new gz_io do |data_tar|
              contents_writer[data_tar] if contents_writer
            end
          end
        end
      end
    end
  end
