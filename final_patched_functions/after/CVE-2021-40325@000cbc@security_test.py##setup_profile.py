def setup_profile(try_connect, create_kernel_initrd, fk_kernel, fk_initrd):
    cobbler_api = try_connect("http://localhost/cobbler_api")
    shared_secret = get_shared_secret()
    token = cobbler_api.login("", shared_secret)
    folder = create_kernel_initrd(fk_kernel, fk_initrd)
    kernel_path = os.path.join(folder, fk_kernel)
    initrd_path = os.path.join(folder, fk_kernel)
    # Create a test Distro
    distro = cobbler_api.new_distro(token)
    cobbler_api.modify_distro(distro, "name", "security_test_distro", token)
    cobbler_api.modify_distro(distro, "arch", "x86_64", token)
    cobbler_api.modify_distro(distro, "kernel", str(kernel_path), token)
    cobbler_api.modify_distro(distro, "initrd", str(initrd_path), token)
    cobbler_api.save_distro(distro, token)
    # Create a test Profile
    profile = cobbler_api.new_profile(token)
    cobbler_api.modify_profile(profile, "name", "security_test_profile", token)
    cobbler_api.modify_profile(profile, "distro", "security_test_distro", token)
    cobbler_api.save_profile(profile, token)

    yield

    cobbler_api.remove_profile("security_test_profile", token)
    cobbler_api.remove_distro("security_test_distro", token)
