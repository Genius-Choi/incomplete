  def day
    Log.add_info(request, params.inspect)

    date_s = params[:date]

    if date_s.blank?
      @date = Date.today
    else
      @date = Date.parse(date_s)
    end

    if params[:user_id].blank?
      user_id = @login_user.id unless @login_user.nil?
      @schedules = Schedule.get_user_day(@login_user, @date)
    else
      user_id = params[:user_id].to_i
      @schedules = Schedule.get_somebody_day(@login_user, user_id, @date)
    end

    schedule_id = nil
    schedule_id = params[:show_id] unless params[:show_id].nil?
    schedule_id = params[:edit_id] unless params[:edit_id].nil?
    unless schedule_id.nil?
      begin
        @schedule = Schedule.find(schedule_id)

        unless @schedule.check_user_auth(@login_user, 'r', true)

          Log.add_check(request, '[Schedule.check_user_auth]'+request.to_s)

          if @login_user.nil?
            check_login
          else
            redirect_to(:controller => 'frames', :action => 'http_error', :id => '401')
          end
          return
        end
      rescue
      end
    end

    if !@login_user.nil? and user_id == @login_user.id and !@schedules.nil?
      equip_ary = []
      @schedules.each do |schedule|
        equip_ary = equip_ary | schedule.get_equipment_a
      end
      overlap_h = {}
      equip_ary.each do |equip_id|
        schedule_ary = Schedule.get_equipment_day(equip_id, @date)
        overlaps = Schedule.check_overlap_equipment(equip_id, schedule_ary, @date)
        unless overlaps.empty?
          overlap_h[equip_id] = overlaps
        end
      end
      unless overlap_h.empty?
        flash[:notice] = 'ERROR:' + t('schedule.conflict_equipment')
        flash[:notice] << '<br/>'
        overlap_h.each do |equip_id, schedule_ary|
          flash[:notice] << '&laquo;' + Equipment.get_name(equip_id) + '&raquo;<br/>'
          flash[:notice] << '<ul style=\'padding-left:40px;\'>'
          schedule_ary.each do |schedule_id|
            flash[:notice] << '<li>' + Schedule.get_title(schedule_id) + '</li>'
          end
          flash[:notice] << '</ul>'
        end
      end
    end

    params[:display] = 'day'
  end
