unregister_mem_int(struct mmio_rb_tree *rbt, struct mem_range *memp)
{
	struct mem_range *mr;
	struct mmio_rb_range *entry = NULL;
	int err;

	pthread_rwlock_wrlock(&mmio_rwlock);
	err = mmio_rb_lookup(rbt, memp->base, &entry);
	if (err == 0) {
		mr = &entry->mr_param;
		if (strncmp(mr->name, memp->name, MEMNAMESZ)
			|| (mr->base != memp->base) || (mr->size != memp->size)
			|| ((mr->flags & MEM_F_IMMUTABLE) != 0)) {
			err = -1;
		} else {
			RB_REMOVE(mmio_rb_tree, rbt, entry);

			/* flush Per-VM cache */
			if (mmio_hint == entry)
				mmio_hint = NULL;

			if (entry)
				free(entry);
		}
	}
	pthread_rwlock_unlock(&mmio_rwlock);

	return err;
}
