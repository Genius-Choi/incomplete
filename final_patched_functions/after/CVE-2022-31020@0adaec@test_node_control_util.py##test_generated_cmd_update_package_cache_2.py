def test_generated_cmd_update_package_cache_2(monkeypatch):
    run_shell_script_counter = 0
    commands = []

    def _run_shell_script(command, *args, **kwargs):
        nonlocal run_shell_script_counter
        run_shell_script_counter += 1
        commands.append(command)

        if run_shell_script_counter == 1:
            raise Exception("Command 'apt update' returned non-zero exit status")

        return ''

    def _f(command, *args, **kwargs):
        commands.append(command)
        return ''

    monkeypatch.setattr(NodeControlUtil, 'run_shell_script', _run_shell_script)
    monkeypatch.setattr(NodeControlUtil, 'run_shell_script_extended', _f)
    monkeypatch.setattr(NodeControlUtil, 'run_shell_command', _f)

    NodeControlUtil.update_package_cache()
    assert len(commands) == 4
    assert commands[0] == "apt update"
    assert commands[1] == "apt-key adv --keyserver keyserver.ubuntu.com --recv-keys CE7709D068DB5E88"
    assert commands[2] == "apt list --upgradable"
    assert commands[3] == "apt update"
