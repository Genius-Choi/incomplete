static uint8_t check_client_direct_request_ip(struct ip_addr *client_req_ip, uint8_t *hwaddr)
{
	int ip_addr4 = 0, i;

#if (debug_dhcps)	
#if LWIP_VERSION_MAJOR >= 2
	printf("\r\n%s: ip %d.%d.%d.%d, hwaddr 0x%02x:0x%02x:0x%02x:0x%02x:0x%02x:0x%02x\n", __func__,
			ip4_addr1(ip_2_ip4(client_req_ip)), ip4_addr2(ip_2_ip4(client_req_ip)), ip4_addr3(ip_2_ip4(client_req_ip)), ip4_addr4(ip_2_ip4(client_req_ip)),
			hwaddr[0], hwaddr[1], hwaddr[2], hwaddr[3], hwaddr[4], hwaddr[5]);
#else
	printf("\r\n%s: ip %d.%d.%d.%d, hwaddr 0x%02x:0x%02x:0x%02x:0x%02x:0x%02x:0x%02x\n", __func__,
			ip4_addr1(client_req_ip), ip4_addr2(client_req_ip), ip4_addr3(client_req_ip), ip4_addr4(client_req_ip),
			hwaddr[0], hwaddr[1], hwaddr[2], hwaddr[3], hwaddr[4], hwaddr[5]);
#endif	
#endif

#if LWIP_VERSION_MAJOR >= 2
	if( (ip4_addr1(ip_2_ip4(&dhcps_network_id)) != ip4_addr1(ip_2_ip4(client_req_ip))) ||
		(ip4_addr2(ip_2_ip4(&dhcps_network_id)) != ip4_addr2(ip_2_ip4(client_req_ip))) ||
		(ip4_addr3(ip_2_ip4(&dhcps_network_id)) != ip4_addr3(ip_2_ip4(client_req_ip))))
#else
	if( (ip4_addr1(&dhcps_network_id) != ip4_addr1(client_req_ip)) ||
		(ip4_addr2(&dhcps_network_id) != ip4_addr2(client_req_ip)) ||
		(ip4_addr3(&dhcps_network_id) != ip4_addr3(client_req_ip)))
#endif

	{
		ip_addr4 = 0;
		goto Exit;
	}

	// check if the requested ip is available
#if LWIP_VERSION_MAJOR >= 2
	ip_addr4 = ip4_addr4(ip_2_ip4(client_req_ip));
#else
	ip_addr4 = ip4_addr4(client_req_ip);
#endif

	if (ip_addr4 < DHCP_POOL_START || ip_addr4 > DHCP_POOL_END) {
		ip_addr4 = 0;
		goto Exit;
	}
	xSemaphoreTake(dhcps_ip_table_semaphore, portMAX_DELAY);
	printf("ip_table[%d] = %x,%x,%x,%x,%x,%x\n",ip_addr4,ip_table.client_mac[ip_addr4][0],
										  			     ip_table.client_mac[ip_addr4][1],
										  				 ip_table.client_mac[ip_addr4][2],
										  				 ip_table.client_mac[ip_addr4][3],
										  				 ip_table.client_mac[ip_addr4][4],
										  				 ip_table.client_mac[ip_addr4][5]);
	if(	(	ip_table.client_mac[ip_addr4][0] == 0 &&
			ip_table.client_mac[ip_addr4][1] == 0 &&
			ip_table.client_mac[ip_addr4][2] == 0 &&
			ip_table.client_mac[ip_addr4][3] == 0 &&
			ip_table.client_mac[ip_addr4][4] == 0 &&
			ip_table.client_mac[ip_addr4][5] == 0) ||
		(	ip_table.client_mac[ip_addr4][0] == hwaddr[0] &&
			ip_table.client_mac[ip_addr4][1] == hwaddr[1] &&
			ip_table.client_mac[ip_addr4][2] == hwaddr[2] &&
			ip_table.client_mac[ip_addr4][3] == hwaddr[3] &&
			ip_table.client_mac[ip_addr4][4] == hwaddr[4] &&
			ip_table.client_mac[ip_addr4][5] == hwaddr[5]))
	{
		// the ip is available or already allocated to this client
	}
	else
	{
		ip_addr4 = 0; // the ip is used
	}
	
	xSemaphoreGive(dhcps_ip_table_semaphore);

Exit:
	return ip_addr4;
}
