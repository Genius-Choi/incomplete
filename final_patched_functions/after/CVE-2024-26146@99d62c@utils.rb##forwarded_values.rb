    def forwarded_values(forwarded_header)
      return nil unless forwarded_header
      forwarded_header = forwarded_header.to_s.gsub("\n", ";")

      forwarded_header.split(';').each_with_object({}) do |field, values|
        field.split(',').each do |pair|
          pair = pair.split('=').map(&:strip).join('=')
          return nil unless pair =~ /\A(by|for|host|proto)="?([^"]+)"?\Z/i
          (values[$1.downcase.to_sym] ||= []) << $2
        end
      end
    end
