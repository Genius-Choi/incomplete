  def get_mail_attachment
    Log.add_info(request, params.inspect)

    attached_id = params[:id].to_i
    begin
      mail_attach = MailAttachment.find(attached_id)
    rescue => evar
    end

    if mail_attach.nil?
      redirect_to(THETIS_RELATIVE_URL_ROOT + '/404.html')
      return
    end

    begin
      email = Email.find(mail_attach.email_id)
    rescue => evar
    end
    if email.nil? or email.user_id != @login_user.id
      render(:text => '')
      return
    end

    mail_attach_name = mail_attach.name

    agent = request.env['HTTP_USER_AGENT']
    unless agent.nil?
      ie_ver = nil
      agent.scan(/\sMSIE\s?(\d+)[.](\d+)/){|m|
                  ie_ver = m[0].to_i + (0.1 * m[1].to_i)
                }
      mail_attach_name = CGI::escape(mail_attach_name) unless ie_ver.nil?
    end

    filepath = mail_attach.get_path
    if FileTest.exist?(filepath)
      send_file(filepath, :filename => mail_attach_name, :stream => true, :disposition => 'attachment')
    else
      send_data('', :type => 'application/octet-stream;', :disposition => 'attachment;filename="'+mail_attach_name+'"')
    end
  end
