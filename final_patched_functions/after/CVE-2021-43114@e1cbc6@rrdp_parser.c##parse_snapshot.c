parse_snapshot(struct rpki_uri *uri, struct proc_upd_args *args)
{
	struct rdr_snapshot_ctx ctx;
	struct snapshot *snapshot;
	int error;

	fnstack_push_uri(uri);
	/* Hash validation */
	error = hash_validate_file("sha256", uri, args->parent->snapshot.hash,
	    args->parent->snapshot.hash_len);
	if (error)
		goto pop;

	error = snapshot_create(&snapshot);
	if (error)
		goto pop;

	ctx.snapshot = snapshot;
	ctx.parent = args->parent;
	ctx.visited_uris = args->visited_uris;
	error = relax_ng_parse(uri_get_local(uri), xml_read_snapshot, &ctx);

	/* Error 0 is ok */
	snapshot_destroy(snapshot);
pop:
	fnstack_pop();
	return error;
}
