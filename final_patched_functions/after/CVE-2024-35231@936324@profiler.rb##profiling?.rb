      def profiling?(env)
        return if @profile && @profile.running?

        request = Rack::Request.new(env.clone)
        if mode = request.params.delete('profile')
          if ::RubyProf.const_defined?(mode.upcase)
            mode
          else
            env['rack.errors'].write "Invalid RubyProf measure_mode: " +
              "#{mode}. Use one of #{MODES.to_a.join(', ')}"
            false
          end
        end
      end
