def opds_download_link(book_id, book_format):
    # I gave up with this: With enabled ldap login, the user doesn't get logged in, therefore it's always guest
    # workaround, loading the user from the request and checking its download rights here
    # in case of anonymous browsing user is None
    user = load_user_from_request(request) or current_user
    if not user.role_download():
        return abort(403)
    if "Kobo" in request.headers.get('User-Agent'):
        client = "kobo"
    else:
        client = ""
    return get_download_link(book_id, book_format.lower(), client)
