  def create
    topic = Topic.new(setup_topic_params)

    validate_visibility!(topic)
    setup_tags(topic)

    if fields = @opts[:custom_fields]
      topic.custom_fields.merge!(fields)
    end

    DiscourseEvent.trigger(:before_create_topic, topic, self)

    setup_auto_close_time(topic)
    process_private_message(topic)
    save_topic(topic)
    create_warning(topic)
    watch_topic(topic)
    create_shared_draft(topic)
    UserActionManager.topic_created(topic)

    topic
  end
