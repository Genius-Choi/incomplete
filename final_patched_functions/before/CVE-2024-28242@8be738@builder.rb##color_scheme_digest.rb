  def color_scheme_digest
    cs = @color_scheme || theme&.color_scheme

    categories_updated =
      Stylesheet::Manager
        .cache
        .defer_get_set("categories_updated") do
          Category.where("uploaded_background_id IS NOT NULL").pluck(:updated_at).map(&:to_i).sum
        end

    fonts = "#{SiteSetting.base_font}-#{SiteSetting.heading_font}"

    digest_string = "#{current_hostname}-"
    if cs || categories_updated > 0
      theme_color_defs = resolve_baked_field(:common, :color_definitions)
      digest_string +=
        "#{RailsMultisite::ConnectionManagement.current_db}-#{cs&.id}-#{cs&.version}-#{theme_color_defs}-#{Stylesheet::Manager.fs_asset_cachebuster}-#{categories_updated}-#{fonts}"
    else
      digest_string += "defaults-#{Stylesheet::Manager.fs_asset_cachebuster}-#{fonts}"

      if cdn_url = GlobalSetting.cdn_url
        digest_string += "-#{cdn_url}"
      end
    end
    Digest::SHA1.hexdigest digest_string
  end
