parse_delta(struct rpki_uri *uri, struct delta_head *parents_data,
    struct proc_upd_args *args)
{
	struct rdr_delta_ctx ctx;
	struct delta *delta;
	struct doc_data *expected_data;
	int error;

	expected_data = &parents_data->doc_data;

	fnstack_push_uri(uri);
	error = hash_validate_file("sha256", uri, expected_data->hash,
	    expected_data->hash_len);
	if (error)
		goto pop_fnstack;

	error = delta_create(&delta);
	if (error)
		goto pop_fnstack;

	ctx.delta = delta;
	ctx.parent = args->parent;
	ctx.visited_uris = args->visited_uris;
	ctx.expected_serial = parents_data->serial;
	error = relax_ng_parse(uri_get_local(uri), xml_read_delta, &ctx);

	/* Error 0 is ok */
	delta_destroy(delta);
pop_fnstack:
	fnstack_pop();
	return error;
}
