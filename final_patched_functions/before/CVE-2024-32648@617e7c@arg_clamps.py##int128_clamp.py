def int128_clamp(lll_node):
    if version_check(begin="constantinople"):
        return [
            "with",
            "_val",
            lll_node,
            [
                "seq",
                # if _val is in bounds,
                # _val >>> 127 == 0 for positive _val
                # _val >>> 127 == -1 for negative _val
                # -1 and 0 are the only numbers which are unchanged by sar,
                # so sar'ing (_val>>>127) one more bit should leave it unchanged.
                ["assert", ["eq", ["sar", 128, "_val"], ["sar", 127, "_val"]]],
                "_val",
            ],
        ]
    else:
        return [
            "clamp",
            ["mload", MemoryPositions.MIN_INT128],
            lll_node,
            ["mload", MemoryPositions.MAX_INT128],
        ]
