order_notification_deltas(struct rdr_notification_ctx *ctx)
{
	struct delta_head **ptr;
	array_index i;
	int error;

	error = deltas_head_set_size(ctx->notification->deltas_list,
	    ctx->deltas.len);
	if (error)
		return error;

	ARRAYLIST_FOREACH(&ctx->deltas, ptr, i) {
		error = deltas_head_add(ctx->notification->deltas_list,
		    ctx->notification->global_data.serial,
		    (*ptr)->serial,
		    (*ptr)->doc_data.uri,
		    (*ptr)->doc_data.hash,
		    (*ptr)->doc_data.hash_len);

		if (!error)
			continue;

		if (error == -EINVAL)
			return pr_val_err("Serial '%lu' at delta elements isn't part of a contiguous list of serials.",
			    (*ptr)->serial);

		if (error == -EEXIST)
			return pr_val_err("Duplicated serial '%lu' at delta elements.",
			    (*ptr)->serial);

		return error;
	}

	/*
	 * "If delta elements are included, they MUST form a contiguous
	 * sequence of serial numbers starting at a revision determined by
	 * the Repository Server, up to the serial number mentioned in the
	 * notification element."
	 *
	 * If all expected elements are set, everything is ok.
	 */
	if (!deltas_head_values_set(ctx->notification->deltas_list))
		return pr_val_err("Deltas listed don't have a contiguous sequence of serial numbers");

	return 0;
}
