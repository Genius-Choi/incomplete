  def using_test_webserver
    started = false
    server = WEBrick::HTTPServer.new(
      BindAddress: '127.0.0.1',
      Port: 0,
      StartCallback: -> { started = true },
      AccessLog: [],
    )

    server.mount_proc '/hello.json' do |_, res|
      res.body = '{"message": "Hello, world!"}'
    end

    Thread.new { server.start }
    Timeout.timeout(1) { :wait until started }

    begin
      yield server.config[:BindAddress], server.config[:Port]
    ensure
      server.shutdown
    end
  end
