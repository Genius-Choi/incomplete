fp_read(CBORDecoderObject *self, char *buf, const Py_ssize_t size)
{
    PyObject *obj, *size_obj;
    char *data;
    int ret = -1;

    size_obj = PyLong_FromSsize_t(size);
    if (size_obj) {
        obj = PyObject_CallFunctionObjArgs(self->read, size_obj, NULL);
        if (obj) {
            assert(PyBytes_CheckExact(obj));
            if (PyBytes_GET_SIZE(obj) == (Py_ssize_t) size) {
                data = PyBytes_AS_STRING(obj);
                memcpy(buf, data, size);
                ret = 0;
            } else {
                PyErr_Format(
                    _CBOR2_CBORDecodeEOF,
                    "premature end of stream (expected to read %zd bytes, "
                    "got %zd instead)", size, PyBytes_GET_SIZE(obj));
            }
            Py_DECREF(obj);
        }
        Py_DECREF(size_obj);
    }
    return ret;
}
