def test_verify_rhsm_installed(submgr_installed, keep_rhsm, critical_string, monkeypatch, caplog):
    if keep_rhsm:
        monkeypatch.setattr(tool_opts, "keep_rhsm", keep_rhsm)

    if submgr_installed:
        monkeypatch.setattr(
            pkghandler,
            "get_installed_pkg_objects",
            lambda _: [namedtuple("Pkg", ["name"])("subscription-manager")],
        )

        subscription.verify_rhsm_installed()

        assert "subscription-manager installed correctly." in caplog.text

    else:
        monkeypatch.setattr(pkghandler, "get_installed_pkg_objects", lambda _: None)

        with pytest.raises(SystemExit):
            subscription.verify_rhsm_installed()

        assert critical_string in caplog.text
