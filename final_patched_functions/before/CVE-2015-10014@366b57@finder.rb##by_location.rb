  def by_location
    return nil if @q.strip[0..3] != 'loc:' || (@location = Geocoder.search(@q.gsub('loc:', '').strip).first).nil?

    bounds_ne = @location.geometry['bounds']['northeast']
    bounds_sw = @location.geometry['bounds']['southwest']
    @location_radius = (distance_between_points([bounds_ne['lat'], bounds_ne['lng']], [bounds_sw['lat'], bounds_sw['lng']])/1000).round(0)
    
    sql = <<-SQL
         SELECT DISTINCT us.id,
                (3959 * acos(cos(radians(:lat))*cos(radians(lat))*cos(radians(lon)-radians(:lon))+sin(radians(:lat))*sin(radians(lat)))) AS distance
           FROM uke_stations AS us
          WHERE us.uke_import_id = :uke_import_id
             AND lat BETWEEN :lat_sw AND :lat_ne
             AND lon BETWEEN :lon_sw AND :lon_ne
       ORDER BY distance ASC
    SQL

    sql.gsub!(':uke_import_id', @active_import.id.to_s)
    sql.gsub!(':lat_ne', conn.quote_string(bounds_ne['lat'].to_s))
    sql.gsub!(':lat_sw', conn.quote_string(bounds_sw['lat'].to_s))
    sql.gsub!(':lon_ne', conn.quote_string(bounds_ne['lng'].to_s))
    sql.gsub!(':lon_sw', conn.quote_string(bounds_sw['lng'].to_s))
    sql.gsub!(':lat', conn.quote_string(@location.latitude.to_s))
    sql.gsub!(':lon', conn.quote_string(@location.longitude.to_s))

    result_to_hash select_using_uke_stations_result(sql)
  end
