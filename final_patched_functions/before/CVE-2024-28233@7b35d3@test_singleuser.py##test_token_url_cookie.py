async def test_token_url_cookie(app, user, full_spawn):
    await user.spawn()
    token = user.new_api_token(scopes=["access:servers!user"])
    url = url_path_join(public_url(app, user), user.spawner.default_url or "/tree/")

    # first request: auth with token in URL
    r = await async_requests.get(url + f"?token={token}", allow_redirects=False)
    print(r.url, r.status_code)
    assert r.status_code == 200
    assert r.cookies
    # second request, use cookies set by first response,
    # no token in URL
    r = await async_requests.get(url, cookies=r.cookies, allow_redirects=False)
    assert r.status_code == 200
    await user.stop()
