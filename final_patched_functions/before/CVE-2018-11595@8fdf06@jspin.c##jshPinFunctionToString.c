void jshPinFunctionToString(JshPinFunction pinFunc, JshPinFunctionToStringFlags flags, char *buf, size_t bufSize) {
  const char *devStr = "";
  JshPinFunction info = JSH_MASK_INFO & pinFunc;
  JshPinFunction firstDevice = 0;
  const char *infoStr = 0;
  char infoStrBuf[5];
  buf[0]=0;
  if (JSH_PINFUNCTION_IS_USART(pinFunc)) {
    devStr=(flags&JSPFTS_JS_NAMES)?"Serial":"USART";
    firstDevice=JSH_USART1;
    if (info==JSH_USART_RX) infoStr="RX";
    else if (info==JSH_USART_TX) infoStr="TX";
    else if (info==JSH_USART_CK) infoStr="CK";
  } else if (JSH_PINFUNCTION_IS_SPI(pinFunc)) {
    devStr="SPI";
    firstDevice=JSH_SPI1;
    if (info==JSH_SPI_MISO) infoStr="MISO";
    else if (info==JSH_SPI_MOSI) infoStr="MOSI";
    else if (info==JSH_SPI_SCK) infoStr="SCK";
  } else if (JSH_PINFUNCTION_IS_I2C(pinFunc)) {
    devStr="I2C";
    firstDevice=JSH_I2C1;
    if (info==JSH_I2C_SCL) infoStr="SCL";
    else if (info==JSH_I2C_SDA) infoStr="SDA";
  } else if (JSH_PINFUNCTION_IS_DAC(pinFunc)) {
     devStr="DAC";
     firstDevice=JSH_DAC;
     if (info==JSH_DAC_CH1) infoStr="CH1";
     else if (info==JSH_DAC_CH2) infoStr="CH2";
  } else if (JSH_PINFUNCTION_IS_TIMER(pinFunc)) {
     devStr="TIM";
     firstDevice=JSH_TIMER1;
     infoStr = &infoStrBuf[0];
     infoStrBuf[0] = 'C';
     infoStrBuf[1] = 'H';
     infoStrBuf[2] = (char)('1' + ((info&JSH_MASK_TIMER_CH)>>JSH_SHIFT_INFO));
     if (info & JSH_TIMER_NEGATED) {
       infoStrBuf[3]='N';
       infoStrBuf[4] = 0;
     } else {
       infoStrBuf[3] = 0;
     }
   }
  int devIdx = 1 + ((((pinFunc&JSH_MASK_TYPE) - firstDevice) >> JSH_SHIFT_TYPE));

  if (!devStr) {
    jsiConsolePrintf("Couldn't convert pin function %d\n", pinFunc);
    return;
  }
  if (flags & JSPFTS_DEVICE) strncat(buf, devStr, bufSize);
  if (flags & JSPFTS_DEVICE_NUMBER) itostr(devIdx, &buf[strlen(buf)], 10);
  if (flags & JSPFTS_SPACE) strncat(buf, " ", bufSize);
  if (infoStr && (flags & JSPFTS_TYPE)) strncat(buf, infoStr, bufSize);
}
