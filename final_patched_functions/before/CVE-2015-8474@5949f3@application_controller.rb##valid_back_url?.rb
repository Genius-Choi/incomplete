  def valid_back_url?(back_url)
    if CGI.unescape(back_url).include?('..')
      return false
    end

    begin
      uri = URI.parse(back_url)
    rescue URI::InvalidURIError
      return false
    end

    if uri.host.present? && uri.host != request.host
      return false
    end

    if uri.path.match(%r{/(login|account/register)})
      return false
    end

    if relative_url_root.present? && !uri.path.starts_with?(relative_url_root)
      return false
    end

    return true
  end
