mmsServer_handleFileRenameRequest(
        MmsServerConnection connection,
        uint8_t* buffer, int bufPos, int maxBufPos,
        uint32_t invokeId,
        ByteBuffer* response)
{
    char currentFileName[256] = "";
    char newFileName[256] = "";

    while (bufPos < maxBufPos) {
        uint8_t tag = buffer[bufPos++];
        int length;

        bufPos = BerDecoder_decodeLength(buffer, &length, bufPos, maxBufPos);

        if (bufPos < 0) {
            mmsMsg_createMmsRejectPdu(&invokeId, MMS_ERROR_REJECT_INVALID_PDU, response);
            return;
        }

        switch(tag) {
        case 0xa0: /* currentFilename */
            if (!mmsMsg_parseFileName(currentFileName, buffer, &bufPos, bufPos + length, invokeId, response))
                return;

            if (DEBUG_MMS_SERVER)
                printf("MMS_SERVER: currentFileName: (%s)\n", currentFileName);

            break;

        case 0xa1: /* newFilename */
            if (!mmsMsg_parseFileName(newFileName, buffer, &bufPos, bufPos + length, invokeId, response))
                return;

            if (DEBUG_MMS_SERVER)
                printf("MMS_SERVER: newFileName: (%s)\n", newFileName);

            break;
        case 0x00: /* indefinite length end tag -> ignore */
            break;
        default: /* ignore unknown tag */
            if (DEBUG_MMS_SERVER)
                printf("MMS_SERVER: unknown tag: (%02x)\n", tag);

            bufPos += length;
            break;
        }
    }

    if ((strlen(currentFileName) != 0) && (strlen(newFileName) != 0)) {

        /* Call user to check if access is allowed */
        if (connection->server->fileAccessHandler != NULL) {
            MmsError access = connection->server->fileAccessHandler(connection->server->fileAccessHandlerParameter,
                                connection, MMS_FILE_ACCESS_TYPE_RENAME, currentFileName, newFileName);

            if (access != MMS_ERROR_NONE) {
                mmsMsg_createServiceErrorPdu(invokeId, response, access);
                return;
            }
        }

        if (renameFile(MmsServerConnection_getFilesystemBasepath(connection), currentFileName, newFileName)){
            /* send positive response */
            createNullResponseExtendedTag(invokeId, response, 0x4b);
        }
        else
        {
            if (DEBUG_MMS_SERVER)
                printf("MMS_SERVER: rename file failed!\n");

            mmsMsg_createServiceErrorPdu(invokeId, response, MMS_ERROR_FILE_OTHER);
        }
    }
    else
        mmsMsg_createMmsRejectPdu(&invokeId, MMS_ERROR_REJECT_INVALID_PDU, response);

}
