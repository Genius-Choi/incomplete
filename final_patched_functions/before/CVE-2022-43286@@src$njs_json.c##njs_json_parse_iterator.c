njs_json_parse_iterator(njs_vm_t *vm, njs_json_parse_t *parse,
    njs_value_t *object)
{
    njs_int_t             ret;
    njs_value_t           *key, wrapper;
    njs_object_t          *obj;
    njs_json_state_t      *state;
    njs_object_prop_t     *prop;
    njs_property_query_t  pq;

    obj = njs_json_wrap_value(vm, &wrapper, object);
    if (njs_slow_path(obj == NULL)) {
        return NJS_ERROR;
    }

    state = njs_json_push_parse_state(vm, parse, &wrapper);
    if (njs_slow_path(state == NULL)) {
        return NJS_ERROR;
    }

    for ( ;; ) {
        if (state->index < state->keys->length) {
            njs_property_query_init(&pq, NJS_PROPERTY_QUERY_SET, 0);

            key = &state->keys->start[state->index];

            ret = njs_property_query(vm, &pq, &state->value, key);
            if (njs_slow_path(ret != NJS_OK)) {
                if (ret == NJS_DECLINED) {
                    state->index++;
                    continue;
                }

                return NJS_ERROR;
            }

            prop = pq.lhq.value;

            if (prop->type == NJS_WHITEOUT) {
                state->index++;
                continue;
            }

            state->prop = prop;

            if (prop->type == NJS_PROPERTY && njs_is_object(&prop->value)) {
                state = njs_json_push_parse_state(vm, parse, &prop->value);
                if (state == NULL) {
                    return NJS_ERROR;
                }

                continue;
            }

            if (prop->type == NJS_PROPERTY_REF
                && njs_is_object(prop->value.data.u.value))
            {
                state = njs_json_push_parse_state(vm, parse,
                                                  prop->value.data.u.value);
                if (state == NULL) {
                    return NJS_ERROR;
                }

                continue;
            }

        } else {
            state = njs_json_pop_parse_state(vm, parse);
            if (state == NULL) {
                vm->retval = parse->retval;
                return NJS_OK;
            }
        }

        ret = njs_json_parse_iterator_call(vm, parse, state);
        if (njs_slow_path(ret != NJS_OK)) {
            return ret;
        }
    }
}
