http_parse_host(const char * buf, struct vapor_urlparser_url *u, int found_at) {
    enum http_host_state s;

    const char *p;
    size_t buflen = u->field_data[UF_HOST].off + u->field_data[UF_HOST].len;

    assert(u->field_set & (1 << UF_HOST));

    u->field_data[UF_HOST].len = 0;

    s = found_at ? s_http_userinfo_start : s_http_host_start;

    for (p = buf + u->field_data[UF_HOST].off; p < buf + buflen; p++) {
        enum http_host_state new_s = http_parse_host_char(s, *p);

        if (new_s == s_http_host_dead) {
            return 1;
        }

        switch(new_s) {
            case s_http_host:
            if (s != s_http_host) {
                u->field_data[UF_HOST].off = (uint16_t)(p - buf);
            }
            u->field_data[UF_HOST].len++;
            break;

            case s_http_host_v6:
            if (s != s_http_host_v6) {
                u->field_data[UF_HOST].off = (uint16_t)(p - buf);
            }
            u->field_data[UF_HOST].len++;
            break;

            case s_http_host_v6_zone_start:
            case s_http_host_v6_zone:
            u->field_data[UF_HOST].len++;
            break;

            case s_http_host_port:
            if (s != s_http_host_port) {
                u->field_data[UF_PORT].off = (uint16_t)(p - buf);
                u->field_data[UF_PORT].len = 0;
                u->field_set |= (1 << UF_PORT);
            }
            u->field_data[UF_PORT].len++;
            break;

            case s_http_userinfo:
            if (s != s_http_userinfo) {
                u->field_data[UF_USERINFO].off = (uint16_t)(p - buf);
                u->field_data[UF_USERINFO].len = 0;
                u->field_set |= (1 << UF_USERINFO);
            }
            u->field_data[UF_USERINFO].len++;
            break;

            default:
            break;
        }
        s = new_s;
    }

    /* Make sure we don't end somewhere unexpected */
    switch (s) {
        case s_http_host_start:
        case s_http_host_v6_start:
        case s_http_host_v6:
        case s_http_host_v6_zone_start:
        case s_http_host_v6_zone:
        case s_http_host_port_start:
        case s_http_userinfo:
        case s_http_userinfo_start:
        return 1;
        default:
        break;
    }

    return 0;
}
