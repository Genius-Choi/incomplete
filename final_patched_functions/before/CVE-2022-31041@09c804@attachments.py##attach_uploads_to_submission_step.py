def attach_uploads_to_submission_step(submission_step: SubmissionStep) -> list:
    # circular import
    from .tasks import resize_submission_attachment

    components = list(submission_step.form_step.iter_components(recursive=True))

    uploads = resolve_uploads_from_data(components, submission_step.data)

    result = list()
    for key, (component, uploads) in uploads.items():
        # grab resize settings
        resize_apply = glom(component, "of.image.resize.apply", default=False)
        resize_size = (
            glom(component, "of.image.resize.width", default=DEFAULT_IMAGE_MAX_SIZE[0]),
            glom(
                component, "of.image.resize.height", default=DEFAULT_IMAGE_MAX_SIZE[1]
            ),
        )
        file_max_size = file_size_cast(
            glom(component, "fileMaxSize", default="") or settings.MAX_FILE_UPLOAD_SIZE
        )

        base_name = glom(component, "file.name", default="")

        # formio sends a list of uploads even with multiple=False
        for i, upload in enumerate(uploads, start=1):
            if upload.file_size > file_max_size:
                raise RequestEntityTooLarge(
                    _(
                        "Upload {uuid} exceeds the maximum upload size of {max_size}b"
                    ).format(
                        uuid=upload.uuid,
                        max_size=file_max_size,
                    ),
                )

            file_name = append_file_num_postfix(
                upload.file_name, base_name, i, len(uploads)
            )

            attachment, created = SubmissionFileAttachment.objects.create_from_upload(
                submission_step, key, upload, file_name=file_name
            )
            result.append((attachment, created))

            if created and resize_apply and resize_size:
                # NOTE there is a possible race-condition if user completes a submission before this resize task is done
                # see https://github.com/open-formulieren/open-forms/issues/507
                resize_submission_attachment.delay(attachment.id, resize_size)

    return result
