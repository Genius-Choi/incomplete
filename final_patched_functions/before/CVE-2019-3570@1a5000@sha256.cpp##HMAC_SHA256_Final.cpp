HMAC_SHA256_Final(unsigned char digest[32], struct HMAC_SHA256_CTX * ctx)
{
  unsigned char ihash[32];

  /* Finish the inner SHA256 operation. */
  scrypt_SHA256_Final(ihash, &ctx->ictx);

  /* Feed the inner hash to the outer SHA256 operation. */
  scrypt_SHA256_Update(&ctx->octx, ihash, 32);

  /* Finish the outer SHA256 operation. */
  scrypt_SHA256_Final(digest, &ctx->octx);

  /* Clean the stack. */
  memset(ihash, 0, 32);
}
