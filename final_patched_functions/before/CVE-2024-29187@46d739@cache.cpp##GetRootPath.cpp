static HRESULT GetRootPath(
    __in BOOL fPerMachine,
    __in BOOL fAllowRedirect,
    __deref_out_z LPWSTR* psczRootPath
    )
{
    HRESULT hr = S_OK;
    LPWSTR sczAppData = NULL;
    int nCompare = 0;

    // Cache paths are initialized once so they cannot be changed while the engine is caching payloads.
    if (fPerMachine)
    {
        // Always construct the default machine package cache path so we can determine if we're redirected.
        if (!vsczDefaultMachinePackageCache)
        {
            hr = PathGetKnownFolder(CSIDL_COMMON_APPDATA, &sczAppData);
            ExitOnFailure1(hr, "Failed to find local %hs appdata directory.", "per-machine");

            hr = PathConcat(sczAppData, PACKAGE_CACHE_FOLDER_NAME, &vsczDefaultMachinePackageCache);
            ExitOnFailure1(hr, "Failed to construct %hs package cache directory name.", "per-machine");

            hr = PathBackslashTerminate(&vsczDefaultMachinePackageCache);
            ExitOnFailure1(hr, "Failed to backslash terminate default %hs package cache directory name.", "per-machine");
        }

        if (!vsczCurrentMachinePackageCache)
        {
            hr = PolcReadString(POLICY_BURN_REGISTRY_PATH, L"PackageCache", NULL, &vsczCurrentMachinePackageCache);
            ExitOnFailure(hr, "Failed to read PackageCache policy directory.");

            if (vsczCurrentMachinePackageCache)
            {
                hr = PathBackslashTerminate(&vsczCurrentMachinePackageCache);
                ExitOnFailure(hr, "Failed to backslash terminate redirected per-machine package cache directory name.");
            }
            else
            {
                hr = StrAllocString(&vsczCurrentMachinePackageCache, vsczDefaultMachinePackageCache, 0);
                ExitOnFailure(hr, "Failed to copy default package cache directory to current package cache directory.");
            }
        }

        hr = StrAllocString(psczRootPath, fAllowRedirect ? vsczCurrentMachinePackageCache : vsczDefaultMachinePackageCache, 0);
        ExitOnFailure1(hr, "Failed to copy %hs package cache root directory.", "per-machine");

        hr = PathCompare(vsczDefaultMachinePackageCache, *psczRootPath, &nCompare);
        ExitOnFailure(hr, "Failed to compare default and current package cache directories.");

        // Return S_FALSE if the current location is not the default location (redirected).
        hr = CSTR_EQUAL == nCompare ? S_OK : S_FALSE;
    }
    else
    {
        if (!vsczDefaultUserPackageCache)
        {
            hr = PathGetKnownFolder(CSIDL_LOCAL_APPDATA, &sczAppData);
            ExitOnFailure1(hr, "Failed to find local %hs appdata directory.", "per-user");

            hr = PathConcat(sczAppData, PACKAGE_CACHE_FOLDER_NAME, &vsczDefaultUserPackageCache);
            ExitOnFailure1(hr, "Failed to construct %hs package cache directory name.", "per-user");

            hr = PathBackslashTerminate(&vsczDefaultUserPackageCache);
            ExitOnFailure1(hr, "Failed to backslash terminate default %hs package cache directory name.", "per-user");
        }

        hr = StrAllocString(psczRootPath, vsczDefaultUserPackageCache, 0);
        ExitOnFailure1(hr, "Failed to copy %hs package cache root directory.", "per-user");
    }

LExit:
    ReleaseStr(sczAppData);

    return hr;
}
