  def create
    Log.add_info(request, params.inspect)

    attrs = _process_user_attrs(nil, params[:user])
    password = attrs[:password]
    attrs.delete(:password)

    @user = UsersHelper.get_initialized_user(attrs.permit(User::PERMIT_BASE))
    @user.auth = User::AUTH_ALL if User.count <= 0

    begin
      @user.save!
    rescue
      render(:controller => 'users', :action => 'new')
      return
    end

    @user.setup

    flash[:notice] = t('msg.register_success')

    if params[:from] == 'users_list'
      redirect_to(:controller => 'users', :action => 'list')
    else
      NoticeMailer.welcome(@user, password, ApplicationHelper.root_url(request)).deliver
      flash[:notice] << '<br/><span class=\'font_msg_bold\' style=\'color:firebrick;\'>'+t('user.initial_password')+'</span>'+t('msg.sent_by')+'<span class=\'font_msg_bold\'>'+t('email.name')+'</span>'+t('msg.check_it')
      redirect_to(:controller => 'login', :action => 'index')
    end
  end
