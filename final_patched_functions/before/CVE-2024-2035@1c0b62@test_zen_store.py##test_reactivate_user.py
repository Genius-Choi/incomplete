def test_reactivate_user():
    """Tests that reactivating a user with a new password works."""
    client = Client()
    store = client.zen_store

    if store.type == StoreType.SQL:
        pytest.skip("SQL Zen Stores do not support user activation")

    with UserContext(password="password") as user:
        assert user.active
        assert user.activation_token is None

        with LoginContext(user_name=user.name, password="password"):
            new_store = Client().zen_store
            assert new_store.get_user().id == user.id

        response_body = store.put(
            f"{USERS}/{str(user.id)}{DEACTIVATE}",
        )
        deactivated_user = UserResponse.parse_obj(response_body)
        assert not deactivated_user.active
        assert deactivated_user.activation_token is not None

        with pytest.raises(AuthorizationException):
            with LoginContext(user_name=user.name, password="password"):
                pass

        with pytest.raises(AuthorizationException):
            response_body = store.put(
                f"{USERS}/{str(user.id)}{ACTIVATE}",
                body=UserUpdate(password="newpassword"),
            )

        with pytest.raises(AuthorizationException):
            with LoginContext(user_name=user.name, password="password"):
                pass

        with pytest.raises(AuthorizationException):
            with LoginContext(user_name=user.name, password="newpassword"):
                pass

        response_body = store.put(
            f"{USERS}/{str(user.id)}{ACTIVATE}",
            body=UserUpdate(
                password="newpassword",
                activation_token=deactivated_user.activation_token,
            ),
        )
        activated_user = UserResponse.parse_obj(response_body)
        assert activated_user.active
        assert activated_user.name == user.name
        assert activated_user.id == user.id

        with pytest.raises(AuthorizationException):
            with LoginContext(user_name=user.name, password="password"):
                pass

        with LoginContext(user_name=user.name, password="newpassword"):
            new_store = Client().zen_store
            assert new_store.get_user().id == user.id
