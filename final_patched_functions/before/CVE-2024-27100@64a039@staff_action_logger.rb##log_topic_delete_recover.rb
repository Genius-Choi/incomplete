  def log_topic_delete_recover(topic, action = "delete_topic", opts = {})
    raise Discourse::InvalidParameters.new(:topic) unless topic && topic.is_a?(Topic)

    user = topic.user ? "#{topic.user.username} (#{topic.user.name})" : "(deleted user)"

    details = [
      "id: #{topic.id}",
      "created_at: #{topic.created_at}",
      "user: #{user}",
      "title: #{topic.title}",
    ]

    if first_post = topic.ordered_posts.with_deleted.first
      details << "raw: #{first_post.raw}"
    end

    UserHistory.create!(
      params(opts).merge(
        action: UserHistory.actions[action.to_sym],
        topic_id: topic.id,
        details: details.join("\n"),
      ),
    )
  end
