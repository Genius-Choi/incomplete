def _prepopulate_context(context: Optional[Context]) -> Context:
    if context is None:
        context = {}
    context.setdefault('model', model)
    context.setdefault('session', model.Session)

    try:
        user = g.user
    except AttributeError:
        # g.user not set
        user = ""
    except RuntimeError:
        # Outside of request context
        user = ""
    except TypeError:
        # g not registered
        user = ""

    context.setdefault('user', user)
    return context
