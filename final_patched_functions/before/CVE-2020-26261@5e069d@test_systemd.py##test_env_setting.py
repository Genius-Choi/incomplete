async def test_env_setting():
    unit_name = 'systemdspawner-unittest-' + str(time.time())
    with tempfile.TemporaryDirectory() as d:
        await systemd.start_transient_service(
            unit_name,
            ['/bin/bash'],
            ['-c', 'env > {}/env'.format(d)],
            working_dir='/',
            environment_variables={
                'TESTING_SYSTEMD_ENV_1': 'TEST_1',
                'TESTING_SYSTEMD_ENV_2': 'TEST_2'
            }
        )

        # Wait a tiny bit for the systemd unit to complete running
        await asyncio.sleep(0.1)
        with open(os.path.join(d, 'env')) as f:
            text = f.read()
            assert 'TESTING_SYSTEMD_ENV_1=TEST_1' in text
            assert 'TESTING_SYSTEMD_ENV_2=TEST_2' in text
