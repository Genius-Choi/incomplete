blockmix_salsa8(__m128i * Bin, __m128i * Bout, __m128i * X, size_t r)
{
  size_t i;

  /* 1: X <-- B_{2r - 1} */
  blkcpy(X, &Bin[8 * r - 4], 64);

  /* 2: for i = 0 to 2r - 1 do */
  for (i = 0; i < r; i++) {
    /* 3: X <-- H(X \xor B_i) */
    blkxor(X, &Bin[i * 8], 64);
    salsa20_8(X);

    /* 4: Y_i <-- X */
    /* 6: B' <-- (Y_0, Y_2 ... Y_{2r-2}, Y_1, Y_3 ... Y_{2r-1}) */
    blkcpy(&Bout[i * 4], X, 64);

    /* 3: X <-- H(X \xor B_i) */
    blkxor(X, &Bin[i * 8 + 4], 64);
    salsa20_8(X);

    /* 4: Y_i <-- X */
    /* 6: B' <-- (Y_0, Y_2 ... Y_{2r-2}, Y_1, Y_3 ... Y_{2r-1}) */
    blkcpy(&Bout[(r + i) * 4], X, 64);
  }
}
