  def update
    Log.add_info(request, '')   # Not to show passwords.

    @mail_account = MailAccount.find(params[:id])

    if params[:mail_account][:smtp_auth].nil? or params[:mail_account][:smtp_auth] != '1'
      params[:mail_account].delete(:smtp_username)
      params[:mail_account].delete(:smtp_password)
    end

    if @mail_account.update_attributes(params.require(:mail_account).permit(MailAccount::PERMIT_BASE))

      flash[:notice] = t('msg.update_success')
      if request.xhr?
        render(:partial => 'common/flash_notice', :layout => false)
      else
        prms = ApplicationHelper.get_fwd_params(params)
        prms[:controller] = 'mail_folders'
        prms[:action] = 'show_tree'
        redirect_to(prms)
      end
    else
      Log.add_error(request, nil, @mail_account.errors.inspect)
      if request.xhr?
        render(:partial => 'mail_account_error', :layout => false)
      else
        prms = ApplicationHelper.get_fwd_params(params)
        prms[:controller] = 'mail_folders'
        prms[:action] = 'show_tree'
        redirect_to(prms)
      end
    end
  end
