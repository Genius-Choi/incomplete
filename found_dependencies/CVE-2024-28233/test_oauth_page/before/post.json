[
    {
        "line": 10,
        "fullcodeline": "service_role = create_temp_role(user_scopes)"
    },
    {
        "line": 11,
        "fullcodeline": "service = mockservice_url"
    },
    {
        "line": 12,
        "fullcodeline": "user = create_user_with_scopes(\"access:services\")"
    },
    {
        "line": 13,
        "fullcodeline": "roles.grant_role(app.db, user, service_role)"
    },
    {
        "line": 14,
        "fullcodeline": "oauth_client = ("
    },
    {
        "line": 19,
        "fullcodeline": "oauth_client.allowed_scopes = sorted(roles.roles_to_scopes([service_role]))"
    },
    {
        "line": 22,
        "fullcodeline": "service_url = url_path_join(public_url(app, service) + 'owhoami/?arg=x')"
    },
    {
        "line": 23,
        "fullcodeline": "await browser.goto(service_url)"
    },
    {
        "line": 25,
        "fullcodeline": "expected_redirect_url = url_path_join("
    },
    {
        "line": 28,
        "fullcodeline": "expected_client_id = f\"service-{service.name}\""
    },
    {
        "line": 31,
        "fullcodeline": "query_params = parse_qs(urlparse(browser.url).query)"
    },
    {
        "line": 32,
        "fullcodeline": "query_params = parse_qs(urlparse(query_params['next'][0]).query)"
    },
    {
        "line": 35,
        "fullcodeline": "assert expected_client_id == query_params['client_id'][0]"
    },
    {
        "line": 36,
        "fullcodeline": "assert expected_redirect_url == query_params['redirect_uri'][0]"
    },
    {
        "line": 39,
        "fullcodeline": "await login(browser, user.name, password=str(user.name))"
    },
    {
        "line": 40,
        "fullcodeline": "auth_btn = browser.locator('//input[@type=\"submit\"]')"
    },
    {
        "line": 42,
        "fullcodeline": "text_permission = browser.get_by_role(\"paragraph\")"
    },
    {
        "line": 48,
        "fullcodeline": "oauth_form = browser.locator('//form')"
    },
    {
        "line": 49,
        "fullcodeline": "scopes_elements = await oauth_form.locator("
    },
    {
        "line": 54,
        "fullcodeline": "scope_list_oauth_page = ["
    },
    {
        "line": 59,
        "fullcodeline": "scope_list_oauth_page = ["
    },
    {
        "line": 63,
        "fullcodeline": "assert all(x in scope_list_oauth_page for x in user_scopes)"
    },
    {
        "line": 64,
        "fullcodeline": "assert f\"access:services!service={service.name}\" in scope_list_oauth_page"
    },
    {
        "line": 67,
        "fullcodeline": "check_boxes = await oauth_form.get_by_role('checkbox', name=\"raw-scopes\").all()"
    },
    {
        "line": 74,
        "fullcodeline": "descriptions = await oauth_form.locator('//span').all()"
    },
    {
        "line": 75,
        "fullcodeline": "desc_list_form = [await description.text_content() for description in descriptions]"
    },
    {
        "line": 76,
        "fullcodeline": "desc_list_form = [\" \".join(desc.split()) for desc in desc_list_form]"
    },
    {
        "line": 79,
        "fullcodeline": "scope_descriptions = scopes.describe_raw_scopes("
    },
    {
        "line": 82,
        "fullcodeline": "desc_list_expected = ["
    },
    {
        "line": 90,
        "fullcodeline": "assert sorted(desc_list_form) == sorted(desc_list_expected)"
    },
    {
        "line": 93,
        "fullcodeline": "await auth_btn.click()"
    },
    {
        "line": 99,
        "fullcodeline": "text = await browser.locator(\"//body\").text_content()"
    },
    {
        "line": 100,
        "fullcodeline": "user_model = json.loads(text)"
    },
    {
        "line": 101,
        "fullcodeline": "authorized_scopes = user_model[\"scopes\"]"
    },
    {
        "line": 104,
        "fullcodeline": "expected_scopes = scopes.expand_scopes(user_scopes, owner=user.orm_user)"
    },
    {
        "line": 105,
        "fullcodeline": "expected_scopes |= scopes.access_scopes(oauth_client)"
    },
    {
        "line": 106,
        "fullcodeline": "expected_scopes |= scopes.identify_scopes(user.orm_user)"
    },
    {
        "line": 109,
        "fullcodeline": "assert sorted(authorized_scopes) == sorted(expected_scopes)"
    },
    {
        "line": 20,
        "fullcodeline": "app.db.commit()"
    },
    {
        "line": 41,
        "fullcodeline": "await expect(auth_btn).to_be_enabled()"
    },
    {
        "line": 43,
        "fullcodeline": "await expect(text_permission).to_contain_text(f\"JupyterHub service {service.name}\")"
    },
    {
        "line": 44,
        "fullcodeline": "await expect(text_permission).to_contain_text(f\"oauth URL: {expected_redirect_url}\")"
    },
    {
        "line": 68,
        "fullcodeline": "for check_box in check_boxes:"
    },
    {
        "line": 95,
        "fullcodeline": "await expect(browser).to_have_url(service_url)"
    },
    {
        "line": 15,
        "fullcodeline": "app.db.query(orm.OAuthClient)"
    },
    {
        "line": 26,
        "fullcodeline": "app.base_url + f\"services/{service.name}/oauth_callback\""
    },
    {
        "line": 80,
        "fullcodeline": "user_scopes or ['(no_scope)'], user.name"
    },
    {
        "line": 69,
        "fullcodeline": "await expect(check_box).not_to_be_editable()"
    },
    {
        "line": 70,
        "fullcodeline": "await expect(check_box).to_be_disabled()"
    },
    {
        "line": 71,
        "fullcodeline": "await expect(check_box).to_have_value(\"title\", \"This authorization is required\")"
    },
    {
        "line": 60,
        "fullcodeline": "await scopes_element.get_attribute(\"value\")"
    },
    {
        "line": 84,
        "fullcodeline": "f\"{sd['description']} Applies to {sd['filter']}.\""
    },
    {
        "line": 55,
        "fullcodeline": "await expect(scopes_element).not_to_be_visible()"
    },
    {
        "line": 85,
        "fullcodeline": "if sd.get('filter')"
    }
]