[
    {
        "line": 3,
        "fullcodeline": "book = calibre_db.get_filtered_book(book_id, allow_show_archived=True)"
    },
    {
        "line": 2,
        "fullcodeline": "book_format = book_format.split(\".\")[0]"
    },
    {
        "line": 5,
        "fullcodeline": "data1 = calibre_db.get_book_format(book.id, book_format.upper())"
    },
    {
        "line": 7,
        "fullcodeline": "log.error(\"Book id {} not found for downloading\".format(book_id))"
    },
    {
        "line": 8,
        "fullcodeline": "abort(404)"
    },
    {
        "line": 13,
        "fullcodeline": "file_name = book.title"
    },
    {
        "line": 16,
        "fullcodeline": "file_name = get_valid_filename(file_name, replace_whitespace=False)"
    },
    {
        "line": 17,
        "fullcodeline": "headers = Headers()"
    },
    {
        "line": 18,
        "fullcodeline": "headers[\"Content-Type\"] = mimetypes.types_map.get('.' + book_format, \"application/octet-stream\")"
    },
    {
        "line": 19,
        "fullcodeline": "headers[\"Content-Disposition\"] = \"attachment; filename=%s.%s; filename*=UTF-8''%s.%s\" % ("
    },
    {
        "line": 23,
        "fullcodeline": "abort(404)"
    },
    {
        "line": 14,
        "fullcodeline": "if len(book.authors) > 0:"
    },
    {
        "line": 21,
        "fullcodeline": "return do_download_file(book, book_format, client, data1, headers)"
    },
    {
        "line": 12,
        "fullcodeline": "ub.update_download(book_id, int(current_user.id))"
    },
    {
        "line": 15,
        "fullcodeline": "file_name = file_name + ' - ' + book.authors[0].name"
    },
    {
        "line": 20,
        "fullcodeline": "quote(file_name.encode('utf-8')), book_format, quote(file_name.encode('utf-8')), book_format)"
    }
]