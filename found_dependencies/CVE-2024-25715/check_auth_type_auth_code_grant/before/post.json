[
    {
        "line": 2,
        "fullcodeline": "struct _oauth2_config * config = (struct _oauth2_config *)user_data;"
    },
    {
        "line": 3,
        "fullcodeline": "char * authorization_code = NULL, * redirect_url, * issued_for, * state_param = NULL, * state_encoded, code_challenge_stored[GLEWLWYD_CODE_CHALLENGE_MAX_LENGTH + 1] = {0};"
    },
    {
        "line": 4,
        "fullcodeline": "const char * ip_source = get_ip_source(request, config->glewlwyd_config->glewlwyd_config->originating_ip_header);"
    },
    {
        "line": 5,
        "fullcodeline": "json_t * j_session, * j_client = check_client_valid(config, u_map_get(request->map_url, \"client_id\"), request->auth_basic_user, request->auth_basic_password, u_map_get(request->map_url, \"redirect_uri\"), GLEWLWYD_AUTHORIZATION_TYPE_AUTHORIZATION_CODE, 1, ip_source);"
    },
    {
        "line": 122,
        "fullcodeline": "o_free(state_param);"
    },
    {
        "line": 123,
        "fullcodeline": "json_decref(j_client);"
    },
    {
        "line": 8,
        "fullcodeline": "if (u_map_get(request->map_url, \"state\") != NULL) {"
    },
    {
        "line": 16,
        "fullcodeline": "if (check_result_value(j_client, G_OK)) {"
    },
    {
        "line": 9,
        "fullcodeline": "state_encoded = ulfius_url_encode(u_map_get(request->map_url, \"state\"));"
    },
    {
        "line": 10,
        "fullcodeline": "state_param = msprintf(\"&state=%s\", state_encoded);"
    },
    {
        "line": 11,
        "fullcodeline": "o_free(state_encoded);"
    },
    {
        "line": 13,
        "fullcodeline": "state_param = o_strdup(\"\");"
    },
    {
        "line": 18,
        "fullcodeline": "if (u_map_has_key(request->map_url, \"g_continue\")) {"
    },
    {
        "line": 116,
        "fullcodeline": "response->status = 302;"
    },
    {
        "line": 117,
        "fullcodeline": "redirect_url = msprintf(\"%s%serror=unauthorized_client%s%s\", u_map_get(request->map_url, \"redirect_uri\"), (o_strchr(u_map_get(request->map_url, \"redirect_uri\"), '?')!=NULL?\"&\":\"?\"), (u_map_get(request->map_url, \"state\")!=NULL?\"&state=\":\"\"), (u_map_get(request->map_url, \"state\")!=NULL?u_map_get(request->map_url, \"state\"):\"\"));"
    },
    {
        "line": 118,
        "fullcodeline": "ulfius_add_header_to_response(response, \"Location\", redirect_url);"
    },
    {
        "line": 119,
        "fullcodeline": "o_free(redirect_url);"
    },
    {
        "line": 120,
        "fullcodeline": "config->glewlwyd_config->glewlwyd_plugin_callback_metrics_increment_counter(config->glewlwyd_config, GLWD_METRICS_OAUTH2_UNAUTHORIZED_CLIENT, 1, \"plugin\", config->name, NULL);"
    },
    {
        "line": 19,
        "fullcodeline": "if (!o_strnullempty(u_map_get(request->map_url, \"scope\"))) {"
    },
    {
        "line": 109,
        "fullcodeline": "redirect_url = get_login_url(config, request, \"auth\", u_map_get(request->map_url, \"client_id\"), u_map_get(request->map_url, \"scope\"), NULL);"
    },
    {
        "line": 110,
        "fullcodeline": "ulfius_add_header_to_response(response, \"Location\", redirect_url);"
    },
    {
        "line": 111,
        "fullcodeline": "o_free(redirect_url);"
    },
    {
        "line": 112,
        "fullcodeline": "response->status = 302;"
    },
    {
        "line": 20,
        "fullcodeline": "j_session = validate_session_client_scope(config, request, u_map_get(request->map_url, \"client_id\"), u_map_get(request->map_url, \"scope\"));"
    },
    {
        "line": 98,
        "fullcodeline": "json_decref(j_session);"
    },
    {
        "line": 21,
        "fullcodeline": "if (check_result_value(j_session, G_OK)) {"
    },
    {
        "line": 101,
        "fullcodeline": "y_log_message(Y_LOG_LEVEL_DEBUG, \"check_auth_type_auth_code_grant - oauth2 - scope list is missing or empty, origin: %s\", ip_source);"
    },
    {
        "line": 102,
        "fullcodeline": "response->status = 302;"
    },
    {
        "line": 103,
        "fullcodeline": "redirect_url = msprintf(\"%s%serror=invalid_scope%s\", u_map_get(request->map_url, \"redirect_uri\"), (o_strchr(u_map_get(request->map_url, \"redirect_uri\"), '?')!=NULL?\"&\":\"?\"), state_param);"
    },
    {
        "line": 104,
        "fullcodeline": "ulfius_add_header_to_response(response, \"Location\", redirect_url);"
    },
    {
        "line": 105,
        "fullcodeline": "o_free(redirect_url);"
    },
    {
        "line": 22,
        "fullcodeline": "if (json_object_get(json_object_get(j_session, \"session\"), \"authorization_required\") == json_false()) {"
    },
    {
        "line": 25,
        "fullcodeline": "issued_for = get_client_hostname(request, config->glewlwyd_config->glewlwyd_config->originating_ip_header);"
    },
    {
        "line": 70,
        "fullcodeline": "o_free(issued_for);"
    },
    {
        "line": 78,
        "fullcodeline": "} else if (check_result_value(j_session, G_ERROR_NOT_FOUND)) {"
    },
    {
        "line": 26,
        "fullcodeline": "if (issued_for != NULL) {"
    },
    {
        "line": 73,
        "fullcodeline": "redirect_url = get_login_url(config, request, \"auth\", u_map_get(request->map_url, \"client_id\"), u_map_get(request->map_url, \"scope\"), NULL);"
    },
    {
        "line": 74,
        "fullcodeline": "ulfius_add_header_to_response(response, \"Location\", redirect_url);"
    },
    {
        "line": 75,
        "fullcodeline": "o_free(redirect_url);"
    },
    {
        "line": 76,
        "fullcodeline": "response->status = 302;"
    },
    {
        "line": 80,
        "fullcodeline": "redirect_url = get_login_url(config, request, \"auth\", u_map_get(request->map_url, \"client_id\"), u_map_get(request->map_url, \"scope\"), NULL);"
    },
    {
        "line": 81,
        "fullcodeline": "ulfius_add_header_to_response(response, \"Location\", redirect_url);"
    },
    {
        "line": 82,
        "fullcodeline": "o_free(redirect_url);"
    },
    {
        "line": 83,
        "fullcodeline": "response->status = 302;"
    },
    {
        "line": 27,
        "fullcodeline": "if (config->glewlwyd_config->glewlwyd_callback_trigger_session_used(config->glewlwyd_config, request, json_string_value(json_object_get(json_object_get(j_session, \"session\"), \"scope_filtered\"))) == G_OK) {"
    },
    {
        "line": 64,
        "fullcodeline": "redirect_url = msprintf(\"%s%serror=server_error\", u_map_get(request->map_url, \"redirect_uri\"), (o_strchr(u_map_get(request->map_url, \"redirect_uri\"), '?')!=NULL?\"&\":\"?\"));"
    },
    {
        "line": 65,
        "fullcodeline": "ulfius_add_header_to_response(response, \"Location\", redirect_url);"
    },
    {
        "line": 66,
        "fullcodeline": "o_free(redirect_url);"
    },
    {
        "line": 67,
        "fullcodeline": "y_log_message(Y_LOG_LEVEL_ERROR, \"check_auth_type_auth_code_grant - oauth2 - Error get_client_hostname\");"
    },
    {
        "line": 68,
        "fullcodeline": "response->status = 302;"
    },
    {
        "line": 84,
        "fullcodeline": "} else if (check_result_value(j_session, G_ERROR_UNAUTHORIZED)) {"
    },
    {
        "line": 86,
        "fullcodeline": "response->status = 302;"
    },
    {
        "line": 87,
        "fullcodeline": "y_log_message(Y_LOG_LEVEL_DEBUG, \"check_auth_type_auth_code_grant - oauth2 - scope list '%s' is invalid for user '%s', origin: %s\", u_map_get(request->map_url, \"scope\"), json_string_value(json_object_get(json_object_get(json_object_get(j_session, \"session\"), \"user\"), \"username\")), ip_source);"
    },
    {
        "line": 88,
        "fullcodeline": "redirect_url = msprintf(\"%s%serror=invalid_scope%s\", u_map_get(request->map_url, \"redirect_uri\"), (o_strchr(u_map_get(request->map_url, \"redirect_uri\"), '?')!=NULL?\"&\":\"?\"), state_param);"
    },
    {
        "line": 89,
        "fullcodeline": "ulfius_add_header_to_response(response, \"Location\", redirect_url);"
    },
    {
        "line": 90,
        "fullcodeline": "o_free(redirect_url);"
    },
    {
        "line": 28,
        "fullcodeline": "if ((res = is_code_challenge_valid(config, u_map_get(request->map_url, \"code_challenge\"), u_map_get(request->map_url, \"code_challenge_method\"), code_challenge_stored)) == G_OK) {"
    },
    {
        "line": 57,
        "fullcodeline": "redirect_url = msprintf(\"%s%serror=server_error\", u_map_get(request->map_url, \"redirect_uri\"), (o_strchr(u_map_get(request->map_url, \"redirect_uri\"), '?')!=NULL?\"&\":\"?\"));"
    },
    {
        "line": 58,
        "fullcodeline": "ulfius_add_header_to_response(response, \"Location\", redirect_url);"
    },
    {
        "line": 59,
        "fullcodeline": "o_free(redirect_url);"
    },
    {
        "line": 60,
        "fullcodeline": "y_log_message(Y_LOG_LEVEL_ERROR, \"check_auth_type_auth_code_grant - oauth2 - Error glewlwyd_callback_trigger_session_used\");"
    },
    {
        "line": 61,
        "fullcodeline": "response->status = 302;"
    },
    {
        "line": 92,
        "fullcodeline": "redirect_url = msprintf(\"%s%serror=server_error\", u_map_get(request->map_url, \"redirect_uri\"), (o_strchr(u_map_get(request->map_url, \"redirect_uri\"), '?')!=NULL?\"&\":\"?\"));"
    },
    {
        "line": 93,
        "fullcodeline": "ulfius_add_header_to_response(response, \"Location\", redirect_url);"
    },
    {
        "line": 94,
        "fullcodeline": "o_free(redirect_url);"
    },
    {
        "line": 95,
        "fullcodeline": "y_log_message(Y_LOG_LEVEL_ERROR, \"check_auth_type_auth_code_grant - oauth2 - Error validate_session_client_scope\");"
    },
    {
        "line": 96,
        "fullcodeline": "response->status = 302;"
    },
    {
        "line": 42,
        "fullcodeline": "o_free(authorization_code);"
    },
    {
        "line": 29,
        "fullcodeline": "if ((authorization_code = generate_authorization_code(config, json_string_value(json_object_get(json_object_get(json_object_get(j_session, \"session\"), \"user\"), \"username\")), u_map_get(request->map_url, \"client_id\"), json_string_value(json_object_get(json_object_get(j_session, \"session\"), \"scope_filtered\")), u_map_get(request->map_url, \"redirect_uri\"), issued_for, u_map_get_case(request->map_header, \"user-agent\"), code_challenge_stored)) != NULL) {"
    },
    {
        "line": 30,
        "fullcodeline": "redirect_url = msprintf(\"%s%scode=%s%s\", u_map_get(request->map_url, \"redirect_uri\"), (o_strchr(u_map_get(request->map_url, \"redirect_uri\"), '?')!=NULL?\"&\":\"?\"), authorization_code, state_param);"
    },
    {
        "line": 31,
        "fullcodeline": "ulfius_add_header_to_response(response, \"Location\", redirect_url);"
    },
    {
        "line": 32,
        "fullcodeline": "response->status = 302;"
    },
    {
        "line": 33,
        "fullcodeline": "o_free(redirect_url);"
    },
    {
        "line": 34,
        "fullcodeline": "config->glewlwyd_config->glewlwyd_plugin_callback_metrics_increment_counter(config->glewlwyd_config, GLWD_METRICS_OAUTH2_CODE, 1, \"plugin\", config->name, NULL);"
    },
    {
        "line": 43,
        "fullcodeline": "} else if (res == G_ERROR_PARAM) {"
    },
    {
        "line": 36,
        "fullcodeline": "redirect_url = msprintf(\"%s%serror=server_error\", u_map_get(request->map_url, \"redirect_uri\"), (o_strchr(u_map_get(request->map_url, \"redirect_uri\"), '?')!=NULL?\"&\":\"?\"));"
    },
    {
        "line": 37,
        "fullcodeline": "ulfius_add_header_to_response(response, \"Location\", redirect_url);"
    },
    {
        "line": 38,
        "fullcodeline": "o_free(redirect_url);"
    },
    {
        "line": 39,
        "fullcodeline": "y_log_message(Y_LOG_LEVEL_ERROR, \"check_auth_type_auth_code_grant - oauth2 - Error generate_authorization_code\");"
    },
    {
        "line": 40,
        "fullcodeline": "response->status = 302;"
    },
    {
        "line": 44,
        "fullcodeline": "redirect_url = msprintf(\"%s%serror=invalid_request\", u_map_get(request->map_url, \"redirect_uri\"), (o_strchr(u_map_get(request->map_url, \"redirect_uri\"), '?')!=NULL?\"&\":\"?\"));"
    },
    {
        "line": 45,
        "fullcodeline": "ulfius_add_header_to_response(response, \"Location\", redirect_url);"
    },
    {
        "line": 46,
        "fullcodeline": "o_free(redirect_url);"
    },
    {
        "line": 47,
        "fullcodeline": "y_log_message(Y_LOG_LEVEL_DEBUG, \"check_auth_type_auth_code_grant - oauth2 - Invalid code_challenge or code_challenge_method, origin: %s\", get_ip_source(request, config->glewlwyd_config->glewlwyd_config->originating_ip_header));"
    },
    {
        "line": 48,
        "fullcodeline": "response->status = 302;"
    },
    {
        "line": 50,
        "fullcodeline": "redirect_url = msprintf(\"%s%serror=server_error\", u_map_get(request->map_url, \"redirect_uri\"), (o_strchr(u_map_get(request->map_url, \"redirect_uri\"), '?')!=NULL?\"&\":\"?\"));"
    },
    {
        "line": 51,
        "fullcodeline": "ulfius_add_header_to_response(response, \"Location\", redirect_url);"
    },
    {
        "line": 52,
        "fullcodeline": "o_free(redirect_url);"
    },
    {
        "line": 53,
        "fullcodeline": "y_log_message(Y_LOG_LEVEL_ERROR, \"check_auth_type_auth_code_grant - oauth2 - Error is_code_challenge_valid\");"
    },
    {
        "line": 54,
        "fullcodeline": "response->status = 302;"
    }
]