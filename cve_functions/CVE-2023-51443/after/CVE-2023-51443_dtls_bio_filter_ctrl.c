static long dtls_bio_filter_ctrl(BIO *bio, int cmd, long num, void *ptr) {
#if OPENSSL_VERSION_NUMBER < 0x10100000L
	dtls_bio_filter *filter = (dtls_bio_filter *)bio->ptr;
#else
	dtls_bio_filter *filter = (dtls_bio_filter *)BIO_get_data(bio);
#endif

	switch(cmd) {
	case BIO_CTRL_DGRAM_GET_FALLBACK_MTU:
		return 1200;
	case BIO_CTRL_DGRAM_SET_MTU:
		filter->mtu = num;
		switch_log_printf(SWITCH_CHANNEL_LOG, SWITCH_LOG_DEBUG1, "Setting MTU: %ld\n", filter->mtu);
		return num;
	case BIO_CTRL_FLUSH:
		return 1;
	case BIO_CTRL_DGRAM_QUERY_MTU:
		switch_log_printf(SWITCH_CHANNEL_LOG, SWITCH_LOG_DEBUG1, "Advertizing MTU: %ld\n", filter->mtu);
		return filter->mtu;
	case BIO_CTRL_WPENDING:
		return 0L;
	case BIO_CTRL_PENDING: {
		int pending = 0;
		packet_list_t *top;

		if (filter == NULL) {
			return 0;
		}

		switch_mutex_lock(filter->mutex);
		if ((top = filter->packets)) {
			filter->packets = filter->packets->next;
			
			if (top == filter->tail || !filter->packets) {
				filter->tail = NULL;
			}
			
			pending = top->size;
			top->next = filter->unused;
			filter->unused = top;
		}
		switch_mutex_unlock(filter->mutex);

		return pending;
	}
	default:
		//switch_log_printf(SWITCH_CHANNEL_LOG, SWITCH_LOG_ERROR, "dtls_bio_filter_ctrl: %d\n", cmd);
		break;
	}
	return 0;
}
