static switch_status_t process_rtcp_report(switch_rtp_t *rtp_session, rtcp_msg_t *msg, switch_size_t bytes)
{
	switch_status_t status = SWITCH_STATUS_FALSE;

	switch_log_printf(SWITCH_CHANNEL_SESSION_LOG(rtp_session->session), SWITCH_LOG_DEBUG3,
					  "RTCP packet bytes %" SWITCH_SIZE_T_FMT " type %d pad %d\n",
					  bytes, msg->header.type, msg->header.p);

	if (rtp_session->flags[SWITCH_RTP_FLAG_VIDEO] && (msg->header.type == _RTCP_PT_RTPFB || msg->header.type == _RTCP_PT_PSFB || msg->header.type < 200)) {
		rtcp_ext_msg_t *extp = (rtcp_ext_msg_t *) msg;

		if (extp->header.fmt != 15) { // <---- REMOVE WHEN BRIA STOPS SENDING UNSOLICITED REMB
			switch_log_printf(SWITCH_CHANNEL_SESSION_LOG(rtp_session->session), SWITCH_LOG_DEBUG2, "%s PICKED UP %s XRTCP type: %d fmt: %d\n",
							  switch_core_session_get_name(rtp_session->session), rtp_type(rtp_session), msg->header.type, extp->header.fmt);
		}

		if (msg->header.type == _RTCP_PT_FIR ||
			(msg->header.type == _RTCP_PT_PSFB && (extp->header.fmt == _RTCP_PSFB_FIR || extp->header.fmt == _RTCP_PSFB_PLI))) {
#if 0
			if (msg->header.type == _RTCP_PT_FIR) {
				switch_log_printf(SWITCH_CHANNEL_SESSION_LOG(rtp_session->session), SWITCH_LOG_WARNING, "Ancient FIR Received. Hello from 1996!\n");

				if (!switch_rtp_test_flag(rtp_session, SWITCH_RTP_FLAG_OLD_FIR)) {
					switch_rtp_set_flag(rtp_session, SWITCH_RTP_FLAG_OLD_FIR);
					switch_core_session_request_video_refresh(rtp_session->session);
				}
			}
#endif
			
			if (switch_core_session_media_flow(rtp_session->session, SWITCH_MEDIA_TYPE_VIDEO) == SWITCH_MEDIA_FLOW_RECVONLY) {
				switch_log_printf(SWITCH_CHANNEL_SESSION_LOG(rtp_session->session), SWITCH_LOG_DEBUG2, "%s Ignoring FIR/PLI from a sendonly stream.\n", 
								  switch_core_session_get_name(rtp_session->session));
			} else {
				switch_core_media_gen_key_frame(rtp_session->session);
				switch_core_session_request_video_refresh(rtp_session->session);
				switch_log_printf(SWITCH_CHANNEL_SESSION_LOG(rtp_session->session), SWITCH_LOG_DEBUG2, "%s Got FIR/PLI\n", 
								  switch_core_session_get_name(rtp_session->session));
				switch_channel_set_flag(switch_core_session_get_channel(rtp_session->session), CF_VIDEO_REFRESH_REQ);
			}
		}

		if (msg->header.type == _RTCP_PT_RTPFB && extp->header.fmt == _RTCP_RTPFB_NACK) {
			uint32_t *nack = (uint32_t *) extp->body;
			int i;

			switch_log_printf(SWITCH_CHANNEL_SESSION_LOG(rtp_session->session), SWITCH_LOG_DEBUG2, "%s Got NACK count %d\n", 
							  switch_core_session_get_name(rtp_session->session), ntohs(extp->header.length) - 2);


			for (i = 0; i < ntohs(extp->header.length) - 2; i++) {
				handle_nack(rtp_session, nack[i]);
			}

			//switch_core_media_gen_key_frame(rtp_session->session);
		}
		
	} else {
		struct switch_rtcp_report_block *report;

		if (msg->header.type == _RTCP_PT_SR || msg->header.type == _RTCP_PT_RR) {
			int i;
#ifdef DEBUG_RTCP
			switch_time_t now = switch_micro_time_now();
#endif 
			uint32_t lsr_now;
			uint32_t lsr;
			uint32_t packet_ssrc;
			double rtt_now = 0;
			uint8_t rtt_valid = 0;
			int rtt_increase = 0, packet_loss_increase=0;

			//if (msg->header.type == _RTCP_PT_SR && rtp_session->ice.ice_user) {
			//	rtp_session->send_rr = 1;
			//}

			lsr_now = calc_local_lsr_now();

			if (msg->header.type == _RTCP_PT_SR) { /* Sender report */
				struct switch_rtcp_sender_report* sr = (struct switch_rtcp_sender_report*)msg->body;

				rtp_session->stats.rtcp.packet_count = ntohl(sr->sender_info.pc);
				rtp_session->stats.rtcp.octet_count = ntohl(sr->sender_info.oc);
				packet_ssrc = sr->ssrc;
				/* Extracting LSR from NTP timestamp and save it */
				lsr = (ntohl(sr->sender_info.ntp_lsw)&0xffff0000)>>16 | (ntohl(sr->sender_info.ntp_msw)&0x0000ffff)<<16; /* The middle 32 bits out of 64 in the NTP timestamp */
				rtp_session->stats.rtcp.last_recv_lsr_peer = htonl(lsr);  /* Save it include it in the next SR */
				rtp_session->stats.rtcp.last_recv_lsr_local = lsr_now;    /* Save it to calculate DLSR when generating next SR */
				switch_log_printf(SWITCH_CHANNEL_SESSION_LOG(rtp_session->session), SWITCH_LOG_DEBUG3,"Received a SR with %d report blocks, " \
								  "length in words = %d, " \
								  "SSRC = 0x%X, " \
								  "NTP MSW = %u, " \
								  "NTP LSW = %u, " \
								  "RTP timestamp = %u, " \
								  "Sender Packet Count = %u, " \
								  "Sender Octet Count = %u\n",
								  msg->header.count,
								  ntohs((uint16_t)msg->header.length),
								  ntohl(sr->ssrc),
								  ntohl(sr->sender_info.ntp_msw),
								  ntohl(sr->sender_info.ntp_lsw),
								  ntohl(sr->sender_info.ts),
								  ntohl(sr->sender_info.pc),
								  ntohl(sr->sender_info.oc));


				rtp_session->rtcp_frame.ssrc = ntohl(sr->ssrc);
				rtp_session->rtcp_frame.packet_type = (uint16_t)rtp_session->rtcp_recv_msg_p->header.type;
				rtp_session->rtcp_frame.ntp_msw = ntohl(sr->sender_info.ntp_msw);
				rtp_session->rtcp_frame.ntp_lsw = ntohl(sr->sender_info.ntp_lsw);
				rtp_session->rtcp_frame.timestamp = ntohl(sr->sender_info.ts);
				rtp_session->rtcp_frame.packet_count =  ntohl(sr->sender_info.pc);
				rtp_session->rtcp_frame.octect_count = ntohl(sr->sender_info.oc);

				report = &sr->report_block;
			} else { /* Receiver report */
				struct switch_rtcp_receiver_report* rr = (struct switch_rtcp_receiver_report*)msg->body;
				packet_ssrc = rr->ssrc;
				//memset(&rtp_session->rtcp_frame, 0, sizeof(rtp_session->rtcp_frame));
				report = &rr->report_block;

				switch_log_printf(SWITCH_CHANNEL_SESSION_LOG(rtp_session->session), SWITCH_LOG_DEBUG3,"Received a RR with %d report blocks, " \
								  "length in words = %d, " \
								  "SSRC = 0x%X, ",
								  msg->header.count,
								  ntohs((uint16_t)msg->header.length),
								  ntohl(rr->ssrc));

			}
			

			for (i = 0; i < (int)msg->header.count && i < MAX_REPORT_BLOCKS ; i++) {
				uint32_t old_avg = rtp_session->rtcp_frame.reports[i].loss_avg;
				uint8_t percent_fraction = (uint8_t)((uint16_t/* prevent overflow when '* 100' */)(uint8_t)report->fraction * 100 / 255);
				if (!rtp_session->rtcp_frame.reports[i].loss_avg) {
					rtp_session->rtcp_frame.reports[i].loss_avg = percent_fraction;
				} else {
					rtp_session->rtcp_frame.reports[i].loss_avg = (uint32_t)(((float)rtp_session->rtcp_frame.reports[i].loss_avg * .7) +
																			 ((float)percent_fraction * .3));
				}

				rtp_session->rtcp_frame.reports[i].ssrc = ntohl(report->ssrc);
				rtp_session->rtcp_frame.reports[i].fraction = (uint8_t)report->fraction;
#if SWITCH_BYTE_ORDER == __BIG_ENDIAN
				rtp_session->rtcp_frame.reports[i].lost = report->lost; // signed 24bit will extended signess to int32_t automatically
#else
				rtp_session->rtcp_frame.reports[i].lost = ntohl(report->lost)>>8; // signed 24bit casted to uint32_t need >>8 after ntohl()...
				rtp_session->rtcp_frame.reports[i].lost = rtp_session->rtcp_frame.reports[i].lost | ((rtp_session->rtcp_frame.reports[i].lost & 0x00800000) ? 0xff000000 : 0x00000000); // ...and signess compensation
#endif
				rtp_session->rtcp_frame.reports[i].highest_sequence_number_received = ntohl(report->highest_sequence_number_received);
				rtp_session->rtcp_frame.reports[i].jitter = ntohl(report->jitter);
				rtp_session->rtcp_frame.reports[i].lsr = ntohl(report->lsr);
				rtp_session->rtcp_frame.reports[i].dlsr = ntohl(report->dlsr);
				
				if (rtp_session->rtcp_frame.reports[i].lsr && !rtp_session->flags[SWITCH_RTP_FLAG_RTCP_PASSTHRU]) {

					/* Calculating RTT = A - DLSR - LSR */
					rtt_now = ((double)(((int64_t)lsr_now) - rtp_session->rtcp_frame.reports[i].dlsr - rtp_session->rtcp_frame.reports[i].lsr))/65536;

					/* Only account RTT if it didn't overflow. */
					if (lsr_now > rtp_session->rtcp_frame.reports[i].dlsr + rtp_session->rtcp_frame.reports[i].lsr) {
#ifdef DEBUG_RTCP
						switch_time_exp_t now_hr;
						switch_time_exp_gmt(&now_hr,now);
						switch_log_printf(SWITCH_CHANNEL_SESSION_LOG(rtp_session->session), SWITCH_LOG_DEBUG3,
								"Receiving an RTCP packet\n[%04d-%02d-%02d %02d:%02d:%02d.%d] SSRC[0x%x]\n"
								"RTT[%f] = A[%u] - DLSR[%u] - LSR[%u]\n",
								1900 + now_hr.tm_year, now_hr.tm_mday, now_hr.tm_mon, now_hr.tm_hour, now_hr.tm_min, now_hr.tm_sec, now_hr.tm_usec,
								rtp_session->rtcp_frame.reports[i].ssrc, rtt_now,
								lsr_now, rtp_session->rtcp_frame.reports[i].dlsr, rtp_session->rtcp_frame.reports[i].lsr);
#endif 
						rtt_valid = 1;
						if (!rtp_session->rtcp_frame.reports[i].rtt_avg) {
							rtp_session->rtcp_frame.reports[i].rtt_avg = rtt_now;
						} else {
							rtp_session->rtcp_frame.reports[i].rtt_avg = (double)((rtp_session->rtcp_frame.reports[i].rtt_avg * .7) + (rtt_now * .3 ));
						}
					} else {
#ifdef DEBUG_RTCP
						switch_time_exp_t now_hr;
						switch_time_exp_gmt(&now_hr,now);
						switch_log_printf(SWITCH_CHANNEL_SESSION_LOG(rtp_session->session), SWITCH_LOG_WARNING,
								"Receiving RTCP packet\n[%04d-%02d-%02d %02d:%02d:%02d.%d] SSRC[0x%x]\n"
								"Ignoring erroneous RTT[%f] = A[%u] - DLSR[%u] - LSR[%u]\n",
								1900 + now_hr.tm_year, now_hr.tm_mday, now_hr.tm_mon, now_hr.tm_hour, now_hr.tm_min, now_hr.tm_sec, now_hr.tm_usec,
								rtp_session->rtcp_frame.reports[i].ssrc, rtt_now,
								lsr_now, rtp_session->rtcp_frame.reports[i].dlsr, rtp_session->rtcp_frame.reports[i].lsr);
#endif
						rtt_valid = 0;
						rtt_now = 0;
					}


					switch_log_printf(SWITCH_CHANNEL_SESSION_LOG(rtp_session->session), SWITCH_LOG_DEBUG3, "RTT average %f\n",
							rtp_session->rtcp_frame.reports[i].rtt_avg);
				}

				if (rtp_session->flags[SWITCH_RTP_FLAG_ADJ_BITRATE_CAP] && rtp_session->flags[SWITCH_RTP_FLAG_ESTIMATORS] && !rtp_session->flags[SWITCH_RTP_FLAG_VIDEO]) {

					/* SWITCH_RTP_FLAG_ADJ_BITRATE_CAP : Can the codec change its bitrate on the fly per API command ? */
#ifdef DEBUG_ESTIMATORS_
					switch_log_printf(SWITCH_CHANNEL_SESSION_LOG(rtp_session->session), SWITCH_LOG_DEBUG3, "Current packet loss: [%d %%] Current RTT: [%f ms]\n", percent_fraction, rtt_now);
#endif

					if (rtt_valid) {

						switch_kalman_estimate(rtp_session->estimators[EST_RTT], rtt_now, EST_RTT);

						if (switch_kalman_cusum_detect_change(rtp_session->detectors[EST_RTT], rtt_now, rtp_session->estimators[EST_RTT]->val_estimate_last)) {
							/* sudden change in the mean value of RTT */
#ifdef DEBUG_ESTIMATORS_
							switch_log_printf(SWITCH_CHANNEL_SESSION_LOG(rtp_session->session), SWITCH_LOG_DEBUG3,"Sudden change in the mean value of RTT !\n");
#endif
							rtt_increase = 1;
						}
					}

					switch_kalman_estimate(rtp_session->estimators[EST_LOSS], percent_fraction, EST_LOSS);

					if (switch_kalman_cusum_detect_change(rtp_session->detectors[EST_LOSS], percent_fraction, rtp_session->estimators[EST_LOSS]->val_estimate_last)){
						/* sudden change in the mean value of packet loss */
#ifdef DEBUG_ESTIMATORS_
						switch_log_printf(SWITCH_CHANNEL_SESSION_LOG(rtp_session->session), SWITCH_LOG_DEBUG3,"Sudden change in the mean value of packet loss!\n");
#endif
						packet_loss_increase = 1;
					}
#ifdef DEBUG_ESTIMATORS_
					switch_log_printf(SWITCH_CHANNEL_SESSION_LOG(rtp_session->session), SWITCH_LOG_DEBUG3, "ESTIMATORS: Packet loss will be: [%f] RTT will be: [%f ms]\n",
									  rtp_session->estimators[EST_LOSS]->val_estimate_last, rtp_session->estimators[EST_RTT]->val_estimate_last);
#endif

					if (rtp_session->rtcp_frame.reports[i].loss_avg != old_avg) {
						/*getting bad*/
						if (switch_kalman_is_slow_link(rtp_session->estimators[EST_LOSS],
													   rtp_session->estimators[EST_RTT])) {
							/* going to minimum bitrate */
#ifdef DEBUG_ESTIMATORS_
							switch_log_printf(SWITCH_CHANNEL_SESSION_LOG(rtp_session->session), SWITCH_LOG_DEBUG3, "Slow link conditions: Loss average: [%d %%], Previous loss: [%d %%]. \
																	Going to minimum bitrate!",rtp_session->rtcp_frame.reports[i].loss_avg, old_avg);
#endif
							switch_core_media_codec_control(rtp_session->session, SWITCH_MEDIA_TYPE_AUDIO,
															SWITCH_IO_WRITE, SCC_AUDIO_ADJUST_BITRATE, SCCT_STRING, "minimum", SCCT_NONE, NULL, NULL, NULL);
							/* if after going to minimum bitrate we still have packet loss then we increase ptime. TODO */

						} else if (packet_loss_increase && (rtp_session->estimators[EST_LOSS]->val_estimate_last >= 5)) {
							/* sudden change in the mean value of packet loss percentage */
							switch_core_media_codec_control(rtp_session->session, SWITCH_MEDIA_TYPE_AUDIO,
															SWITCH_IO_WRITE, SCC_AUDIO_ADJUST_BITRATE,
															SCCT_STRING, "decrease",
															SCCT_NONE, NULL, NULL, NULL);
#ifdef DEBUG_ESTIMATORS_
							switch_log_printf(SWITCH_CHANNEL_SESSION_LOG(rtp_session->session), SWITCH_LOG_DEBUG3,"Sudden change in the mean value of packet loss percentage !\n");
#endif
							switch_core_media_codec_control(rtp_session->session, SWITCH_MEDIA_TYPE_AUDIO,
															SWITCH_IO_WRITE, SCC_AUDIO_PACKET_LOSS, SCCT_INT,
															(void *)&rtp_session->rtcp_frame.reports[i].loss_avg,
															SCCT_NONE, NULL, NULL, NULL);

						} else if (rtt_valid && !rtt_increase && rtp_session->estimators[EST_LOSS]->val_estimate_last >= rtp_session->rtcp_frame.reports[i].loss_avg ) {
							/* lossy because of congestion (queues full somewhere -> some packets are dropped , but RTT is good ), packet loss with many small gaps */
#ifdef DEBUG_ESTIMATORS_
							switch_log_printf(SWITCH_CHANNEL_SESSION_LOG(rtp_session->session), SWITCH_LOG_DEBUG3, "packet loss, but RTT is not bad\n");
#endif
							switch_core_media_codec_control(rtp_session->session, SWITCH_MEDIA_TYPE_AUDIO,
															SWITCH_IO_WRITE, SCC_AUDIO_PACKET_LOSS, SCCT_INT,
															(void *)&rtp_session->rtcp_frame.reports[i].loss_avg,
															SCCT_NONE, NULL, NULL, NULL);

						} else if ((rtp_session->estimators[EST_LOSS]->val_estimate_last < 1) && packet_loss_increase) {
#ifdef DEBUG_ESTIMATORS_
							switch_log_printf(SWITCH_CHANNEL_SESSION_LOG(rtp_session->session), SWITCH_LOG_DEBUG3, "small packet loss average\n");
#endif
							/*small loss_avg*/
							switch_core_media_codec_control(rtp_session->session, SWITCH_MEDIA_TYPE_AUDIO,
															SWITCH_IO_WRITE, SCC_AUDIO_ADJUST_BITRATE,
															SCCT_STRING, "default",
															SCCT_NONE, NULL, NULL, NULL);

							switch_core_media_codec_control(rtp_session->session, SWITCH_MEDIA_TYPE_AUDIO,
															SWITCH_IO_WRITE, SCC_AUDIO_PACKET_LOSS, SCCT_INT,
															(void *)&rtp_session->rtcp_frame.reports[i].loss_avg,
															SCCT_NONE, NULL, NULL, NULL);

						} else if ((rtp_session->estimators[EST_LOSS]->val_estimate_last < 5) &&
								   (rtp_session->rtcp_frame.reports[i].rtt_avg < rtp_session->estimators[EST_RTT]->val_estimate_last))  {

							/* estimate that packet loss will decrease, we can increase the bitrate */
							switch_core_media_codec_control(rtp_session->session, SWITCH_MEDIA_TYPE_AUDIO,
															SWITCH_IO_WRITE, SCC_AUDIO_ADJUST_BITRATE,
															SCCT_STRING, "increase",
															SCCT_NONE, NULL, NULL, NULL);

							switch_core_media_codec_control(rtp_session->session, SWITCH_MEDIA_TYPE_AUDIO,
															SWITCH_IO_WRITE, SCC_AUDIO_PACKET_LOSS, SCCT_INT,
															(void *)&rtp_session->rtcp_frame.reports[i].loss_avg,
															SCCT_NONE, NULL, NULL, NULL);

						} else {
							/* *do nothing about bitrate, just pass the packet loss to the codec */
#ifdef DEBUG_ESTIMATORS_
							switch_log_printf(SWITCH_CHANNEL_SESSION_LOG(rtp_session->session), SWITCH_LOG_DEBUG3,"do nothing about bitrate, just pass the packet loss to the codec\n");
#endif
							switch_core_media_codec_control(rtp_session->session, SWITCH_MEDIA_TYPE_AUDIO,
															SWITCH_IO_WRITE, SCC_AUDIO_PACKET_LOSS, SCCT_INT,
															(void *)&rtp_session->rtcp_frame.reports[i].loss_avg,
															SCCT_NONE, NULL, NULL, NULL);
						}
					}
				} else {
					if (!rtp_session->flags[SWITCH_RTP_FLAG_VIDEO] && rtp_session->rtcp_frame.reports[i].loss_avg != old_avg) {
						switch_core_media_codec_control(rtp_session->session, SWITCH_MEDIA_TYPE_AUDIO,
														SWITCH_IO_WRITE, SCC_AUDIO_PACKET_LOSS, SCCT_INT,
														(void *)&rtp_session->rtcp_frame.reports[i].loss_avg,
														SCCT_NONE, NULL, NULL, NULL);
					}
				}

				report++;
			}
			rtp_session->rtcp_frame.report_count = (uint16_t)i;
				




			rtp_session->rtcp_fresh_frame = 1;
			rtp_session->stats.rtcp.peer_ssrc = ntohl(packet_ssrc);
		}
	}

	if (msg->header.type > 194 && msg->header.type < 255) {
		status = SWITCH_STATUS_SUCCESS;
	}

	return status;
}
