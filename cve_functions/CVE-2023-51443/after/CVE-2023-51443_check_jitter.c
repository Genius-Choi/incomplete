static void check_jitter(switch_rtp_t *rtp_session)
{
	switch_time_t current_time;
	int64_t diff_time = 0, cur_diff = 0;
	int seq;

	current_time = switch_micro_time_now() / 1000;

	if (rtp_session->flags[SWITCH_RTP_FLAG_PAUSE] || rtp_session->flags[SWITCH_RTP_FLAG_DTMF_ON] || rtp_session->dtmf_data.in_digit_ts) {
		reset_jitter_seq(rtp_session);
		return;
	}

	if (++rtp_session->jitter_lead < JITTER_LEAD_FRAMES || !rtp_session->stats.inbound.last_proc_time) {
		rtp_session->stats.inbound.last_proc_time = current_time;
		return;
	}

	diff_time = (current_time - rtp_session->stats.inbound.last_proc_time);
	seq = (int)(uint16_t) ntohs((uint16_t) rtp_session->last_rtp_hdr.seq);

	/* Burst and Packet Loss */
	rtp_session->stats.inbound.recved++;

	if (rtp_session->stats.inbound.last_processed_seq > 0 && seq > (int)(rtp_session->stats.inbound.last_processed_seq + 1)) {
		int lost = (seq - rtp_session->stats.inbound.last_processed_seq - 1);

		switch_log_printf(SWITCH_CHANNEL_SESSION_LOG(rtp_session->session), SWITCH_LOG_DEBUG1, "%s Got: %s seq %d but expected: %d lost: %d\n",
						  rtp_session_name(rtp_session),
						  rtp_type(rtp_session),
						  seq,
						  (rtp_session->stats.inbound.last_processed_seq + 1), lost);
		rtp_session->stats.inbound.last_loss++;

		if (rtp_session->flags[SWITCH_RTP_FLAG_VIDEO]) {
			switch_core_session_request_video_refresh(rtp_session->session);
		}

		if (rtp_session->stats.inbound.last_loss > 0 && rtp_session->stats.inbound.last_loss < LOST_BURST_CAPTURE) {
			rtp_session->stats.inbound.loss[rtp_session->stats.inbound.last_loss] += lost;
		}

		rtp_session->bad_stream++;
		rtp_session->stats.inbound.flaws += lost;

		if (rtp_session->stats.inbound.error_log) {
			rtp_session->stats.inbound.error_log->flaws += lost;
		}

	} else {
		rtp_session->stats.inbound.last_loss = 0;
	}

	rtp_session->stats.inbound.last_processed_seq = seq;

	/* Burst and Packet Loss */

	if (current_time > rtp_session->next_stat_check_time) {
		rtp_session->next_stat_check_time = current_time + 5000;
		burstr_calculate(rtp_session->stats.inbound.loss, rtp_session->stats.inbound.recved,
						 &(rtp_session->stats.inbound.burstrate), &(rtp_session->stats.inbound.lossrate));
		do_mos(rtp_session);
	} else {
		do_mos(rtp_session);
	}

	if (rtp_session->stats.inbound.last_loss || rtp_session->bad_stream) {
		if (rtp_session->session && (!rtp_session->stats.inbound.error_log || rtp_session->stats.inbound.error_log->stop)) {
			struct error_period *error = switch_core_session_alloc(rtp_session->session, sizeof(*error));
			error->start = switch_micro_time_now();
			error->next = rtp_session->stats.inbound.error_log;
			rtp_session->stats.inbound.error_log = error;
		}

		if (!rtp_session->stats.inbound.last_loss) {
			if (++rtp_session->recovering_stream > (rtp_session->one_second * 3)) {
				if (rtp_session->session && rtp_session->stats.inbound.error_log) {
					rtp_session->stats.inbound.error_log->stop = switch_micro_time_now();
				}

				rtp_session->bad_stream = 0;
			}
		} else {
			rtp_session->recovering_stream = 0;
			rtp_session->bad_stream++;
		}
	} else {
		rtp_session->recovering_stream = 0;
		rtp_session->clean_stream++;
	}


	if ( diff_time < 0 ) {
		diff_time = -diff_time;
	}

	rtp_session->stats.inbound.jitter_n++;
	rtp_session->stats.inbound.jitter_add += diff_time;

	if (rtp_session->stats.inbound.mean_interval) {
		cur_diff = (int64_t)(diff_time - rtp_session->stats.inbound.mean_interval);
	} else {
		cur_diff = 0;
	}

	rtp_session->stats.inbound.jitter_addsq += (cur_diff * cur_diff);
	rtp_session->stats.inbound.last_proc_time = current_time;

	if (rtp_session->stats.inbound.jitter_n > 0) {
		double ipdv;

		rtp_session->stats.inbound.mean_interval = (double)rtp_session->stats.inbound.jitter_add / (double)rtp_session->stats.inbound.jitter_n;

		if (!rtp_session->old_mean) {
			rtp_session->old_mean = rtp_session->stats.inbound.mean_interval;
		}

		rtp_session->stats.inbound.variance = (double)rtp_session->stats.inbound.jitter_addsq / (double)rtp_session->stats.inbound.jitter_n;

		//printf("CHECK %d +%ld +%ld %f %f\n", rtp_session->write_timer.samplecount, diff_time, (diff_time * diff_time), rtp_session->stats.inbound.mean_interval, rtp_session->stats.inbound.variance);

		ipdv = rtp_session->old_mean - rtp_session->stats.inbound.mean_interval;

		if ( ipdv > IPDV_THRESHOLD ) { /* It shows Increasing Delays */
			switch_log_printf(SWITCH_CHANNEL_LOG, SWITCH_LOG_DEBUG3, "Calculated Instantaneous Packet Delay Variation: %s packet %lf\n",
							  rtp_type(rtp_session), ipdv);
		}

		if ( rtp_session->stats.inbound.variance < rtp_session->stats.inbound.min_variance || rtp_session->stats.inbound.min_variance == 0 ) {
			rtp_session->stats.inbound.min_variance = rtp_session->stats.inbound.variance;
		}

		if ( rtp_session->stats.inbound.variance > rtp_session->stats.inbound.max_variance ) {
			rtp_session->stats.inbound.max_variance = rtp_session->stats.inbound.variance;
		}

		rtp_session->old_mean = rtp_session->stats.inbound.mean_interval;
	}
}
