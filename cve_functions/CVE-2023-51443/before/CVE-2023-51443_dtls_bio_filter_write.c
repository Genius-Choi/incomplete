static int dtls_bio_filter_write(BIO *bio, const char *in, int inl) {
	long ret;
	dtls_bio_filter *filter;
	
	switch_log_printf(SWITCH_CHANNEL_LOG, SWITCH_LOG_DEBUG1, "dtls_bio_filter_write: %p, %d\n", (void *)in, inl);
	/* Forward data to the write BIO */
#if OPENSSL_VERSION_NUMBER < 0x10100000L
	ret = BIO_write(bio->next_bio, in, inl);
#else
	ret = BIO_write(BIO_next(bio), in, inl);
#endif
	
	switch_log_printf(SWITCH_CHANNEL_LOG, SWITCH_LOG_DEBUG1, "  -- %ld\n", ret);
 
	/* Keep track of the packet, as we'll advertize them one by one after a pending check */
#if OPENSSL_VERSION_NUMBER < 0x10100000L
	filter = (dtls_bio_filter *)bio->ptr;
#else
	filter = (dtls_bio_filter *)BIO_get_data(bio);
#endif

	if (filter != NULL) {
		packet_list_t *node;

		switch_mutex_lock(filter->mutex);
		if (filter->unused) {
			node = filter->unused;
			node->next = NULL;
			filter->unused = filter->unused->next;
		} else {
			node = switch_core_alloc(filter->pool, sizeof(*node));
		}

		node->size = ret;

		if (filter->tail) {
			filter->tail->next = node;
		} else {
			filter->packets = node;
		}

		filter->tail = node;

		switch_mutex_unlock(filter->mutex);
		//switch_log_printf(SWITCH_CHANNEL_LOG, SWITCH_LOG_ERROR, "New list length: %d\n", g_list_length(filter->packets));
	}
	return ret;
}
