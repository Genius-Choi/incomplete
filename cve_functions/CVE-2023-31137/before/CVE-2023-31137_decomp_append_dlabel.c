int decomp_append_dlabel(js_string *compressed, js_string *uncompressed,
                         unsigned int compressed_offset) {

    js_string *dlabel;
    int length = 0;

    /* Sanity checks */
    if(js_has_sanity(compressed) != JS_SUCCESS) {
        return JS_ERROR;
        }
    if(js_has_sanity(uncompressed) != JS_SUCCESS) {
        return JS_ERROR;
        }
     if(compressed->unit_size != 1) {
        return JS_ERROR;
        }
     if(uncompressed->unit_size != 1) {
        return JS_ERROR;
        }
     if(compressed_offset >= compressed->unit_count) {
        return JS_ERROR;
        }

    /* Get and process the actual compressed dname to append */
    dlabel = decomp_get_label(compressed, compressed_offset);
    if(dlabel == 0) {
        return JS_ERROR;
        }
    length = dlabel_length(compressed,compressed_offset);
    if(length == JS_ERROR) {
        js_destroy(dlabel);
        return JS_ERROR;
        }

    /* Append the label in question */
    if(js_append(dlabel,uncompressed) == JS_ERROR) {
        js_destroy(dlabel);
        return JS_ERROR;
        }

    /* Success! */
    js_destroy(dlabel);
    return length;
    }
