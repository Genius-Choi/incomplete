void tport_hup_event(tport_t *self)
{
  SU_DEBUG_4(("%s(%p) " TPN_FORMAT "\n", __func__, (void *)self, TPN_ARGS(self->tp_name)));

  if (self->tp_msg) {
    su_time_t now = su_now();
    msg_recv_commit(self->tp_msg, 0, 1);
    tport_parse(self, 1, now);
  }

  if (!tport_is_secondary(self))
    return;

  /* Shutdown completely if there are no queued messages */
  /* Problem reported by Arsen Chaloyan */
  tport_shutdown0(self, tport_has_queued(self) ? 0 : 2);
  tport_set_secondary_timer(self);
}
