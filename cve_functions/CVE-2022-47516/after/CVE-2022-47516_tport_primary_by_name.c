tport_t *tport_primary_by_name(tport_t const *tp, tp_name_t const *tpn)
{
  char const *ident = tpn->tpn_ident;
  char const *proto = tpn->tpn_proto;
  char const *comp = tpn->tpn_comp;
  int family = 0;
  const tport_t* tport_default = NULL;
  tport_t* tport_best_match = NULL;
  int octet_count = 0;

  tport_primary_t const *self, *nocomp = NULL;

  self = tp ? tp->tp_master->mr_primaries : NULL;

  if (ident && strcmp(ident, tpn_any) == 0)
    ident = NULL;

  if (tpn->tpn_host == NULL)
    family = 0;
#if SU_HAVE_IN6
  else if (host_is_ip6_address(tpn->tpn_host))
    family = AF_INET6;
#endif
  else if (host_is_ip4_address(tpn->tpn_host))
    family = AF_INET;
  else
    family = 0;

  if (proto && strcmp(proto, tpn_any) == 0)
    proto = NULL;

  if (!ident && !proto && !family && !comp)
    return (tport_t *)self;   /* Anything goes */

  comp = tport_canonize_comp(comp);

  for (; self; self = self->pri_next) {
    const tport_t* current = (tport_t *) self;
    char szRemote[64];
    char szLocal[64];

    tp = self->pri_primary;

    if (ident && strcmp(ident, tp->tp_ident))
      continue;
    if (family) {
      if (family == AF_INET && !tport_has_ip4(tp)) 
  continue;
#if SU_HAVE_IN6
      if (family == AF_INET6 && !tport_has_ip6(tp))
  continue;
#endif
    }
    if (proto && !su_casematch(proto, tp->tp_protoname))
      continue;

    if (comp && comp != tp->tp_name->tpn_comp) {
      if (tp->tp_name->tpn_comp == NULL && nocomp == NULL)
  nocomp = self;
      continue;
    }

    //break;
    if (!tport_default) tport_default = tp ;

    strncpy(szRemote, tpn->tpn_host, 64);
    strncpy(szLocal, current->tp_name->tpn_host, 64);

    char *pLocal[4] = {0,0,0,0};
    char *pRemote[4] = {0,0,0,0};

    int i = 0;
    char* rest = szLocal;
    char* token ;
    while (NULL != (token = strtok_r(rest, ".", &rest)) && i < 4) {
       pLocal[i++] = token;
    }

    i = 0;
    rest = szRemote;
    while (NULL != (token = strtok_r(rest, ".", &rest)) && i < 4) {
       pRemote[i++] = token;
    }

    int count = 0;
    int j = 0;
    for (j = 0; j < 4; j++) {
      if (NULL == pLocal[j] || NULL == pRemote[j]) break;
      if (0 != strcmp(pLocal[j], pRemote[j])) break;
      count++;
    }

    if (count > octet_count) {
      octet_count = count;
      tport_best_match = (tport_t *) current;
    }
  }

  if (tport_best_match) return (tport_t *) tport_best_match;
  if (tport_default) return (tport_t *) tport_default;

  return (tport_t *)nocomp;
}
