void bgp_capability_send(struct peer *peer, afi_t afi, safi_t safi,
			 int capability_code, int action)
{
	struct stream *s;
	iana_afi_t pkt_afi = IANA_AFI_IPV4;
	iana_safi_t pkt_safi = IANA_SAFI_UNICAST;
	unsigned long cap_len;
	uint16_t len;
	uint32_t gr_restart_time;
	uint8_t addpath_afi_safi_count = 0;
	bool adv_addpath_tx = false;
	unsigned long number_of_orfs_p;
	uint8_t number_of_orfs = 0;
	const char *capability = lookup_msg(capcode_str, capability_code,
					    "Unknown");
	const char *hostname = cmd_hostname_get();
	const char *domainname = cmd_domainname_get();

	if (!peer_established(peer->connection))
		return;

	if (!CHECK_FLAG(peer->cap, PEER_CAP_DYNAMIC_RCV) &&
	    !CHECK_FLAG(peer->cap, PEER_CAP_DYNAMIC_ADV))
		return;

	/* Convert AFI, SAFI to values for packet. */
	bgp_map_afi_safi_int2iana(afi, safi, &pkt_afi, &pkt_safi);

	s = stream_new(peer->max_packet_size);

	/* Make BGP update packet. */
	bgp_packet_set_marker(s, BGP_MSG_CAPABILITY);

	/* Encode MP_EXT capability. */
	switch (capability_code) {
	case CAPABILITY_CODE_SOFT_VERSION:
		SET_FLAG(peer->cap, PEER_CAP_SOFT_VERSION_ADV);
		stream_putc(s, action);
		stream_putc(s, CAPABILITY_CODE_SOFT_VERSION);
		cap_len = stream_get_endp(s);
		stream_putc(s, 0); /* Capability Length */

		/* The Capability Length SHOULD be no greater than 64.
		 * This is the limit to allow other capabilities as much
		 * space as they require.
		 */
		const char *soft_version = cmd_software_version_get();

		len = strlen(soft_version);
		if (len > BGP_MAX_SOFT_VERSION)
			len = BGP_MAX_SOFT_VERSION;

		stream_putc(s, len);
		stream_put(s, soft_version, len);

		/* Software Version capability Len. */
		len = stream_get_endp(s) - cap_len - 1;
		stream_putc_at(s, cap_len, len);

		if (bgp_debug_neighbor_events(peer))
			zlog_debug("%pBP sending CAPABILITY has %s %s for afi/safi: %s/%s",
				   peer,
				   action == CAPABILITY_ACTION_SET
					   ? "Advertising"
					   : "Removing",
				   capability, iana_afi2str(pkt_afi),
				   iana_safi2str(pkt_safi));
		break;
	case CAPABILITY_CODE_MP:
		stream_putc(s, action);
		stream_putc(s, CAPABILITY_CODE_MP);
		stream_putc(s, CAPABILITY_CODE_MP_LEN);
		stream_putw(s, pkt_afi);
		stream_putc(s, 0);
		stream_putc(s, pkt_safi);

		if (bgp_debug_neighbor_events(peer))
			zlog_debug("%pBP sending CAPABILITY has %s %s for afi/safi: %s/%s",
				   peer,
				   action == CAPABILITY_ACTION_SET
					   ? "Advertising"
					   : "Removing",
				   capability, iana_afi2str(pkt_afi),
				   iana_safi2str(pkt_safi));
		break;
	case CAPABILITY_CODE_RESTART:
		if (!CHECK_FLAG(peer->flags, PEER_FLAG_GRACEFUL_RESTART) &&
		    !CHECK_FLAG(peer->flags, PEER_FLAG_GRACEFUL_RESTART_HELPER))
			return;

		SET_FLAG(peer->cap, PEER_CAP_RESTART_ADV);
		stream_putc(s, action);
		stream_putc(s, CAPABILITY_CODE_RESTART);
		cap_len = stream_get_endp(s);
		stream_putc(s, 0);
		gr_restart_time = peer->bgp->restart_time;

		if (peer->bgp->t_startup) {
			SET_FLAG(gr_restart_time, GRACEFUL_RESTART_R_BIT);
			SET_FLAG(peer->cap, PEER_CAP_GRACEFUL_RESTART_R_BIT_ADV);
		}

		if (CHECK_FLAG(peer->bgp->flags,
			       BGP_FLAG_GRACEFUL_NOTIFICATION)) {
			SET_FLAG(gr_restart_time, GRACEFUL_RESTART_N_BIT);
			SET_FLAG(peer->cap, PEER_CAP_GRACEFUL_RESTART_N_BIT_ADV);
		}

		stream_putw(s, gr_restart_time);

		if (CHECK_FLAG(peer->flags, PEER_FLAG_GRACEFUL_RESTART)) {
			FOREACH_AFI_SAFI (afi, safi) {
				if (!peer->afc[afi][safi])
					continue;

				bgp_map_afi_safi_int2iana(afi, safi, &pkt_afi,
							  &pkt_safi);
				stream_putw(s, pkt_afi);
				stream_putc(s, pkt_safi);
				if (CHECK_FLAG(peer->bgp->flags,
					       BGP_FLAG_GR_PRESERVE_FWD))
					stream_putc(s, GRACEFUL_RESTART_F_BIT);
				else
					stream_putc(s, 0);
			}
		}

		len = stream_get_endp(s) - cap_len - 1;
		stream_putc_at(s, cap_len, len);

		if (bgp_debug_neighbor_events(peer))
			zlog_debug("%pBP sending CAPABILITY has %s %s for afi/safi: %s/%s",
				   peer,
				   action == CAPABILITY_ACTION_SET
					   ? "Advertising"
					   : "Removing",
				   capability, iana_afi2str(pkt_afi),
				   iana_safi2str(pkt_safi));

		break;
	case CAPABILITY_CODE_LLGR:
		if (!CHECK_FLAG(peer->cap, PEER_CAP_RESTART_ADV))
			return;

		SET_FLAG(peer->cap, PEER_CAP_LLGR_ADV);

		stream_putc(s, action);
		stream_putc(s, CAPABILITY_CODE_LLGR);
		cap_len = stream_get_endp(s);
		stream_putc(s, 0);

		FOREACH_AFI_SAFI (afi, safi) {
			if (!peer->afc[afi][safi])
				continue;

			bgp_map_afi_safi_int2iana(afi, safi, &pkt_afi,
						  &pkt_safi);

			stream_putw(s, pkt_afi);
			stream_putc(s, pkt_safi);
			stream_putc(s, LLGR_F_BIT);
			stream_put3(s, peer->bgp->llgr_stale_time);

			SET_FLAG(peer->af_cap[afi][safi], PEER_CAP_LLGR_AF_ADV);
		}

		len = stream_get_endp(s) - cap_len - 1;
		stream_putc_at(s, cap_len, len);

		if (bgp_debug_neighbor_events(peer))
			zlog_debug("%pBP sending CAPABILITY has %s %s for afi/safi: %s/%s",
				   peer,
				   action == CAPABILITY_ACTION_SET
					   ? "Advertising"
					   : "Removing",
				   capability, iana_afi2str(pkt_afi),
				   iana_safi2str(pkt_safi));
		break;
	case CAPABILITY_CODE_ADDPATH:
		SET_FLAG(peer->cap, PEER_CAP_ADDPATH_ADV);

		FOREACH_AFI_SAFI (afi, safi) {
			if (peer->afc[afi][safi]) {
				addpath_afi_safi_count++;

				/* Only advertise addpath TX if a feature that
				* will use it is
				* configured */
				if (peer->addpath_type[afi][safi] !=
				    BGP_ADDPATH_NONE)
					adv_addpath_tx = true;

				/* If we have enabled labeled unicast, we MUST check
				* against unicast SAFI because addpath IDs are
				* allocated under unicast SAFI, the same as the RIB
				* is managed in unicast SAFI.
				*/
				if (safi == SAFI_LABELED_UNICAST)
					if (peer->addpath_type[afi][SAFI_UNICAST] !=
					    BGP_ADDPATH_NONE)
						adv_addpath_tx = true;
			}
		}

		stream_putc(s, action);
		stream_putc(s, CAPABILITY_CODE_ADDPATH);
		stream_putc(s, CAPABILITY_CODE_ADDPATH_LEN *
				       addpath_afi_safi_count);

		FOREACH_AFI_SAFI (afi, safi) {
			if (peer->afc[afi][safi]) {
				bool adv_addpath_rx =
					!CHECK_FLAG(peer->af_flags[afi][safi],
						    PEER_FLAG_DISABLE_ADDPATH_RX);
				uint8_t flags = 0;

				/* Convert AFI, SAFI to values for packet. */
				bgp_map_afi_safi_int2iana(afi, safi, &pkt_afi,
							  &pkt_safi);

				stream_putw(s, pkt_afi);
				stream_putc(s, pkt_safi);

				if (adv_addpath_rx) {
					SET_FLAG(flags, BGP_ADDPATH_RX);
					SET_FLAG(peer->af_cap[afi][safi],
						 PEER_CAP_ADDPATH_AF_RX_ADV);
				} else {
					UNSET_FLAG(peer->af_cap[afi][safi],
						   PEER_CAP_ADDPATH_AF_RX_ADV);
				}

				if (adv_addpath_tx) {
					SET_FLAG(flags, BGP_ADDPATH_TX);
					SET_FLAG(peer->af_cap[afi][safi],
						 PEER_CAP_ADDPATH_AF_TX_ADV);
					if (safi == SAFI_LABELED_UNICAST)
						SET_FLAG(peer->af_cap[afi]
								     [SAFI_UNICAST],
							 PEER_CAP_ADDPATH_AF_TX_ADV);
				} else {
					UNSET_FLAG(peer->af_cap[afi][safi],
						   PEER_CAP_ADDPATH_AF_TX_ADV);
				}

				stream_putc(s, flags);
			}
		}

		if (bgp_debug_neighbor_events(peer))
			zlog_debug("%pBP sending CAPABILITY has %s %s for afi/safi: %s/%s",
				   peer,
				   action == CAPABILITY_ACTION_SET
					   ? "Advertising"
					   : "Removing",
				   capability, iana_afi2str(pkt_afi),
				   iana_safi2str(pkt_safi));

		break;
	case CAPABILITY_CODE_ORF:
		/* Convert AFI, SAFI to values for packet. */
		bgp_map_afi_safi_int2iana(afi, safi, &pkt_afi, &pkt_safi);

		stream_putc(s, action);
		stream_putc(s, CAPABILITY_CODE_ORF);
		cap_len = stream_get_endp(s);
		stream_putc(s, 0);

		stream_putw(s, pkt_afi); /* Address Family Identifier */
		stream_putc(s, 0);	 /* Reserved */
		stream_putc(s,
			    pkt_safi); /* Subsequent Address Family Identifier */

		number_of_orfs_p =
			stream_get_endp(s); /* Number of ORFs pointer */
		stream_putc(s, 0);	    /* Number of ORFs */

		/* Address Prefix ORF */
		if (CHECK_FLAG(peer->af_flags[afi][safi],
			       PEER_FLAG_ORF_PREFIX_SM) ||
		    CHECK_FLAG(peer->af_flags[afi][safi],
			       PEER_FLAG_ORF_PREFIX_RM)) {
			stream_putc(s, ORF_TYPE_PREFIX);

			if (CHECK_FLAG(peer->af_flags[afi][safi],
				       PEER_FLAG_ORF_PREFIX_SM) &&
			    CHECK_FLAG(peer->af_flags[afi][safi],
				       PEER_FLAG_ORF_PREFIX_RM)) {
				SET_FLAG(peer->af_cap[afi][safi],
					 PEER_CAP_ORF_PREFIX_SM_ADV);
				SET_FLAG(peer->af_cap[afi][safi],
					 PEER_CAP_ORF_PREFIX_RM_ADV);
				stream_putc(s, ORF_MODE_BOTH);
			} else if (CHECK_FLAG(peer->af_flags[afi][safi],
					      PEER_FLAG_ORF_PREFIX_SM)) {
				SET_FLAG(peer->af_cap[afi][safi],
					 PEER_CAP_ORF_PREFIX_SM_ADV);
				UNSET_FLAG(peer->af_cap[afi][safi],
					   PEER_CAP_ORF_PREFIX_RM_ADV);
				stream_putc(s, ORF_MODE_SEND);
			} else {
				SET_FLAG(peer->af_cap[afi][safi],
					 PEER_CAP_ORF_PREFIX_RM_ADV);
				UNSET_FLAG(peer->af_cap[afi][safi],
					   PEER_CAP_ORF_PREFIX_SM_ADV);
				stream_putc(s, ORF_MODE_RECEIVE);
			}
			number_of_orfs++;
		} else {
			UNSET_FLAG(peer->af_cap[afi][safi],
				   PEER_CAP_ORF_PREFIX_SM_ADV);
			UNSET_FLAG(peer->af_cap[afi][safi],
				   PEER_CAP_ORF_PREFIX_RM_ADV);
		}

		/* Total Number of ORFs. */
		stream_putc_at(s, number_of_orfs_p, number_of_orfs);

		len = stream_get_endp(s) - cap_len - 1;
		stream_putc_at(s, cap_len, len);

		if (bgp_debug_neighbor_events(peer))
			zlog_debug("%pBP sending CAPABILITY has %s %s for afi/safi: %s/%s",
				   peer,
				   action == CAPABILITY_ACTION_SET
					   ? "Advertising"
					   : "Removing",
				   capability, iana_afi2str(pkt_afi),
				   iana_safi2str(pkt_safi));
		break;
	case CAPABILITY_CODE_FQDN:
		if (hostname) {
			SET_FLAG(peer->cap, PEER_CAP_HOSTNAME_ADV);
			stream_putc(s, action);
			stream_putc(s, CAPABILITY_CODE_FQDN);
			cap_len = stream_get_endp(s);
			stream_putc(s, 0); /* Capability Length */

			len = strlen(hostname);
			if (len > BGP_MAX_HOSTNAME)
				len = BGP_MAX_HOSTNAME;

			stream_putc(s, len);
			stream_put(s, hostname, len);

			if (domainname) {
				len = strlen(domainname);
				if (len > BGP_MAX_HOSTNAME)
					len = BGP_MAX_HOSTNAME;

				stream_putc(s, len);
				stream_put(s, domainname, len);
			} else
				stream_putc(s, 0);

			len = stream_get_endp(s) - cap_len - 1;
			stream_putc_at(s, cap_len, len);

			if (bgp_debug_neighbor_events(peer))
				zlog_debug("%pBP sending CAPABILITY has %s %s for afi/safi: %s/%s",
					   peer,
					   action == CAPABILITY_ACTION_SET
						   ? "Advertising"
						   : "Removing",
					   capability, iana_afi2str(pkt_afi),
					   iana_safi2str(pkt_safi));
		}
		break;
	case CAPABILITY_CODE_REFRESH:
	case CAPABILITY_CODE_AS4:
	case CAPABILITY_CODE_DYNAMIC:
	case CAPABILITY_CODE_ENHANCED_RR:
	case CAPABILITY_CODE_ENHE:
	case CAPABILITY_CODE_EXT_MESSAGE:
		break;
	case CAPABILITY_CODE_ROLE:
		if (peer->local_role != ROLE_UNDEFINED) {
			SET_FLAG(peer->cap, PEER_CAP_ROLE_ADV);
			stream_putc(s, action);
			stream_putc(s, CAPABILITY_CODE_ROLE);
			stream_putc(s, CAPABILITY_CODE_ROLE_LEN);
			stream_putc(s, peer->local_role);
		}
		break;
	default:
		break;
	}

	/* Set packet size. */
	bgp_packet_set_size(s);

	/* Add packet to the peer. */
	bgp_packet_add(peer->connection, peer, s);

	bgp_writes_on(peer->connection);
}
