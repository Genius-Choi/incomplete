CEAnsi* CEAnsi::Object()
{
	CLastErrorGuard errGuard;

	if (!gAnsiTlsIndex)
	{
		gAnsiTlsIndex = TlsAlloc();
	}

	if ((!gAnsiTlsIndex) || (gAnsiTlsIndex == TLS_OUT_OF_INDEXES))
	{
		_ASSERTEX(gAnsiTlsIndex && gAnsiTlsIndex != TLS_OUT_OF_INDEXES);
		return nullptr;
	}

	// Don't use thread_local, it doesn't work in WinXP in dynamically loaded dlls
	CEAnsi* obj = static_cast<CEAnsi*>(TlsGetValue(gAnsiTlsIndex));
	if (!obj)
	{
		obj = new CEAnsi;
		if (obj)
			obj->GetDefaultTextAttr(); // Initialize "default attributes"
		TlsSetValue(gAnsiTlsIndex, obj);
	}

	return obj;
}
