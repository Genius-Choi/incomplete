extern "C" HRESULT CoreCreateProcess(
    __in_opt LPCWSTR wzApplicationName,
    __inout_opt LPWSTR sczCommandLine,
    __in BOOL fInheritHandles,
    __in DWORD dwCreationFlags,
    __in_opt LPCWSTR wzCurrentDirectory,
    __in WORD wShowWindow,
    __out LPPROCESS_INFORMATION pProcessInformation
    )
{
    HRESULT hr = S_OK;
    STARTUPINFOW si = { };
    size_t cchCurrentDirectory = 0;

    // CreateProcessW has undocumented MAX_PATH restriction for lpCurrentDirectory even when long path support is enabled.
    if (wzCurrentDirectory && FAILED(::StringCchLengthW(wzCurrentDirectory, MAX_PATH - 1, &cchCurrentDirectory)))
    {
        wzCurrentDirectory = NULL;
    }

    si.cb = sizeof(si);
    si.wShowWindow = wShowWindow;

    if (!vpfnCreateProcessW(wzApplicationName, sczCommandLine, NULL, NULL, fInheritHandles, dwCreationFlags, NULL, wzCurrentDirectory, &si, pProcessInformation))
    {
        ExitWithLastError(hr, "CreateProcessW failed with return code: %d", Dutil_er);
    }

LExit:
    return hr;
}
