static HRESULT GetSanitizedCommandLine(
    __in BURN_ENGINE_COMMAND* pInternalCommand,
    __in BOOTSTRAPPER_COMMAND* pCommand,
    __in BURN_VARIABLES* pVariables,
    __inout_z LPWSTR* psczSanitizedCommandLine
    )
{
    HRESULT hr = S_OK;
    DWORD dwUnknownArgIndex = 0;
    DWORD dwSecretArgIndex = 0;
    BOOL fHidden = FALSE;
    LPWSTR sczSanitizedArgument = NULL;
    LPWSTR sczVariableName = NULL;
    int argc = pInternalCommand->argc;
    LPWSTR* argv = pInternalCommand->argv;
    DWORD cUnknownArgs = pInternalCommand->cUnknownArgs;
    int* rgUnknownArgs = pInternalCommand->rgUnknownArgs;
    DWORD cSecretArgs = pInternalCommand->cSecretArgs;
    int* rgSecretArgs = pInternalCommand->rgSecretArgs;

    for (int i = 0; i < argc; ++i)
    {
        fHidden = FALSE;

        if (dwUnknownArgIndex < cUnknownArgs && rgUnknownArgs[dwUnknownArgIndex] == i)
        {
            ++dwUnknownArgIndex;

            if (argv[i][0] != L'-' && argv[i][0] != L'/')
            {
                const wchar_t* pwc = wcschr(argv[i], L'=');
                if (pwc)
                {
                    hr = StrAllocString(&sczVariableName, argv[i], pwc - argv[i]);
                    ExitOnFailure(hr, "Failed to copy variable name.");

                    fHidden = VariableIsHiddenCommandLine(pVariables, sczVariableName);

                    if (fHidden)
                    {
                        hr = StrAllocFormatted(&sczSanitizedArgument, L"%ls=*****", sczVariableName);
                        ExitOnFailure(hr, "Failed to copy sanitized unknown argument.");
                    }
                }
            }

            // Remember command-line switch to pass off to BA.
            AppAppendCommandLineArgument(&pCommand->wzCommandLine, argv[i]);
        }
        else if (dwSecretArgIndex < cSecretArgs && rgSecretArgs[dwSecretArgIndex] == i)
        {
            ++dwSecretArgIndex;
            fHidden = TRUE;

            hr = StrAllocString(&sczSanitizedArgument, L"*****", 0);
            ExitOnFailure(hr, "Failed to copy sanitized secret argument.");
        }

        if (fHidden)
        {
            AppAppendCommandLineArgument(psczSanitizedCommandLine, sczSanitizedArgument);
        }
        else
        {
            AppAppendCommandLineArgument(psczSanitizedCommandLine, argv[i]);
        }
    }

LExit:
    ReleaseStr(sczVariableName);
    ReleaseStr(sczSanitizedArgument);

    return hr;
}
