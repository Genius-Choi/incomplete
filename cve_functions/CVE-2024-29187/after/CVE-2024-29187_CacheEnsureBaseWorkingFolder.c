extern "C" HRESULT CacheEnsureBaseWorkingFolder(
    __in BOOL fElevated,
    __in BURN_CACHE* pCache,
    __deref_out_z_opt LPWSTR* psczBaseWorkingFolder
    )
{
    Assert(pCache->fInitializedCache);

    HRESULT hr = S_OK;
    LPWSTR sczPotential = NULL;
    PSECURITY_DESCRIPTOR psd = NULL;
    LPSECURITY_ATTRIBUTES pWorkingFolderAcl = NULL;

    if (!pCache->fInitializedBaseWorkingFolder)
    {
        // If elevated, allocate the pWorkingFolderAcl to protect the working folder to only SYSTEM and Admins.
        if (fElevated)
        {
            LPCWSTR wzSddl = L"D:PAI(A;;FA;;;BA)(A;OICIIO;GA;;;BA)(A;;FA;;;SY)(A;OICIIO;GA;;;SY)";
            if (!::ConvertStringSecurityDescriptorToSecurityDescriptorW(wzSddl, SDDL_REVISION_1, &psd, NULL))
            {
                ExitWithLastError(hr, "Failed to create the security descriptor for the working folder.");
            }

            pWorkingFolderAcl = reinterpret_cast<LPSECURITY_ATTRIBUTES>(MemAlloc(sizeof(SECURITY_ATTRIBUTES), TRUE));
            pWorkingFolderAcl->nLength = sizeof(SECURITY_ATTRIBUTES);
            pWorkingFolderAcl->lpSecurityDescriptor = psd;
            pWorkingFolderAcl->bInheritHandle = FALSE;
        }

        for (DWORD i = 0; i < pCache->cPotentialBaseWorkingFolders; ++i)
        {
            hr = PathConcatRelativeToFullyQualifiedBase(pCache->rgsczPotentialBaseWorkingFolders[i], pCache->wzGuid, &sczPotential);
            if (SUCCEEDED(hr))
            {
                hr = DirEnsureExists(sczPotential, pWorkingFolderAcl);
                if (SUCCEEDED(hr))
                {
                    pCache->sczBaseWorkingFolder = sczPotential;
                    sczPotential = NULL;
                    break;
                }
            }

            LogErrorId(hr, MSG_INVALID_BASE_WORKING_FOLDER, sczPotential, NULL, NULL);
        }

        ExitOnNull(pCache->sczBaseWorkingFolder, hr, E_INVALIDSTATE, "No usable base working folder found.");

        pCache->fInitializedBaseWorkingFolder = TRUE;
    }

    // Best effort to ensure our working folder is not encrypted.
    ::DecryptFileW(pCache->sczBaseWorkingFolder, 0);

    if (psczBaseWorkingFolder)
    {
        hr = StrAllocString(psczBaseWorkingFolder, pCache->sczBaseWorkingFolder, 0);
        ExitOnFailure(hr, "Failed to copy working folder.");
    }

LExit:
    ReleaseMem(pWorkingFolderAcl);
    if (psd)
    {
        ::LocalFree(psd);
    }
    ReleaseStr(sczPotential);

    return hr;
}
