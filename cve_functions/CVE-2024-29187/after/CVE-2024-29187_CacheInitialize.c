extern "C" HRESULT CacheInitialize(
    __in BURN_CACHE* pCache,
    __in BURN_ENGINE_COMMAND* pInternalCommand
    )
{
    Assert(!pCache->fInitializedCache);

    HRESULT hr = S_OK;
    LPWSTR sczAppData = NULL;
    BOOL fPathEqual = FALSE;

    // Cache paths are initialized once so they cannot be changed while the engine is caching payloads.
    // Always construct the default machine package cache path so we can determine if we're redirected.
    hr = ShelGetFolder(&sczAppData, CSIDL_COMMON_APPDATA);
    ExitOnFailure(hr, "Failed to find local %hs appdata directory.", "per-machine");

    hr = PathConcat(sczAppData, PACKAGE_CACHE_FOLDER_NAME, &pCache->sczDefaultMachinePackageCache);
    ExitOnFailure(hr, "Failed to construct %hs package cache directory name.", "per-machine");

    hr = PathBackslashTerminate(&pCache->sczDefaultMachinePackageCache);
    ExitOnFailure(hr, "Failed to backslash terminate default %hs package cache directory name.", "per-machine");


    // The machine package cache can be redirected through policy.
    hr = PolcReadString(POLICY_BURN_REGISTRY_PATH, L"PackageCache", NULL, &pCache->sczCurrentMachinePackageCache);
    ExitOnFailure(hr, "Failed to read PackageCache policy directory.");

    if (pCache->sczCurrentMachinePackageCache && PathIsFullyQualified(pCache->sczCurrentMachinePackageCache))
    {
        hr = PathBackslashTerminate(&pCache->sczCurrentMachinePackageCache);
        ExitOnFailure(hr, "Failed to backslash terminate redirected per-machine package cache directory name.");
    }
    else
    {
        if (pCache->sczCurrentMachinePackageCache)
        {
            LogErrorId(E_INVALIDARG, MSG_INVALID_POLICY_MACHINE_PACKAGE_CACHE, pCache->sczCurrentMachinePackageCache, NULL, NULL);
        }

        hr = StrAllocString(&pCache->sczCurrentMachinePackageCache, pCache->sczDefaultMachinePackageCache, 0);
        ExitOnFailure(hr, "Failed to copy default package cache directory to current package cache directory.");
    }

    hr = PathCompareCanonicalized(pCache->sczDefaultMachinePackageCache, pCache->sczCurrentMachinePackageCache, &fPathEqual);
    ExitOnFailure(hr, "Failed to compare default and current package cache directories.");

    pCache->fCustomMachinePackageCache = !fPathEqual;


    hr = ShelGetFolder(&sczAppData, CSIDL_LOCAL_APPDATA);
    ExitOnFailure(hr, "Failed to find local %hs appdata directory.", "per-user");

    hr = PathConcat(sczAppData, PACKAGE_CACHE_FOLDER_NAME, &pCache->sczDefaultUserPackageCache);
    ExitOnFailure(hr, "Failed to construct %hs package cache directory name.", "per-user");

    hr = PathBackslashTerminate(&pCache->sczDefaultUserPackageCache);
    ExitOnFailure(hr, "Failed to backslash terminate default %hs package cache directory name.", "per-user");


    hr = CalculateWorkingFolders(pCache, pInternalCommand);

    pCache->fInitializedCache = TRUE;

LExit:
    ReleaseStr(sczAppData);

    return hr;
}
