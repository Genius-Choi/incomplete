static HRESULT CalculatePotentialBaseWorkingFolders(
    __in BURN_CACHE* pCache,
    __in BURN_ENGINE_COMMAND* pInternalCommand,
    __in LPCWSTR wzAcquisitionFolder
    )
{
    Assert(!pCache->rgsczPotentialBaseWorkingFolders && !pCache->cPotentialBaseWorkingFolders);
    HRESULT hr = S_OK;
    LPWSTR sczTemp = NULL;
    LPWSTR sczPolicy = NULL;
    BOOL fNeedsExpansion = FALSE;

    hr = MemEnsureArraySize(reinterpret_cast<LPVOID*>(&pCache->rgsczPotentialBaseWorkingFolders), 6, sizeof(LPWSTR), 6);
    ExitOnFailure(hr, "Failed to initialize array.");

    // The value from the command line takes precedence.
    if (pInternalCommand->sczEngineWorkingDirectory)
    {
        hr = PathExpand(&sczTemp, pInternalCommand->sczEngineWorkingDirectory, PATH_EXPAND_FULLPATH);
        ExitOnFailure(hr, "Failed to expand engine working directory from command-line: '%ls'", pInternalCommand->sczEngineWorkingDirectory);

        pCache->rgsczPotentialBaseWorkingFolders[pCache->cPotentialBaseWorkingFolders] = sczTemp;
        sczTemp = NULL;
        ++pCache->cPotentialBaseWorkingFolders;
    }

    // The base working folder can be specified through policy,
    // but only use it if elevated because it should be secured against non-admin users.
    if (pInternalCommand->fInitiallyElevated)
    {
        hr = PolcReadUnexpandedString(POLICY_BURN_REGISTRY_PATH, L"EngineWorkingDirectory", NULL, &fNeedsExpansion, &sczPolicy);
        ExitOnFailure(hr, "Failed to read EngineWorkingDirectory policy directory.");

        if (S_FALSE != hr)
        {
            if (fNeedsExpansion)
            {
                hr = EnvExpandEnvironmentStringsForUser(NULL, sczPolicy, &sczTemp, NULL);
                ExitOnFailure(hr, "Failed to expand EngineWorkingDirectory policy directory.");
            }
            else
            {
                sczTemp = sczPolicy;
                sczPolicy = NULL;
            }

            pCache->rgsczPotentialBaseWorkingFolders[pCache->cPotentialBaseWorkingFolders] = sczTemp;
            sczTemp = NULL;
            ++pCache->cPotentialBaseWorkingFolders;
        }
    }

    // Default to the acquisition folder, but need to use system temp path for security reasons if running elevated.
    if (pInternalCommand->fInitiallyElevated)
    {
        hr = PathGetSystemTempPaths(&pCache->rgsczPotentialBaseWorkingFolders, &pCache->cPotentialBaseWorkingFolders);
        ExitOnFailure(hr, "Failed to get system temp folder paths for base working folder.");
    }
    else
    {
        hr = StrAllocString(&sczTemp, wzAcquisitionFolder, 0);
        ExitOnFailure(hr, "Failed to copy acquisition folder path for base working folder.");

        pCache->rgsczPotentialBaseWorkingFolders[pCache->cPotentialBaseWorkingFolders] = sczTemp;
        sczTemp = NULL;
        ++pCache->cPotentialBaseWorkingFolders;
    }

LExit:
    ReleaseStr(sczTemp);
    ReleaseStr(sczPolicy);

    return hr;
}
