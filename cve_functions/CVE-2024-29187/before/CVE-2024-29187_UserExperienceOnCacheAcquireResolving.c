EXTERN_C BAAPI UserExperienceOnCacheAcquireResolving(
    __in BURN_USER_EXPERIENCE* pUserExperience,
    __in_z_opt LPCWSTR wzPackageOrContainerId,
    __in_z_opt LPCWSTR wzPayloadId,
    __in_z LPWSTR* rgSearchPaths,
    __in DWORD cSearchPaths,
    __in BOOL fFoundLocal,
    __in DWORD* pdwChosenSearchPath,
    __in_z_opt LPWSTR* pwzDownloadUrl,
    __in_z_opt LPCWSTR wzPayloadContainerId,
    __inout BOOTSTRAPPER_CACHE_RESOLVE_OPERATION* pCacheOperation
    )
{
    HRESULT hr = S_OK;
    BA_ONCACHEACQUIRERESOLVING_ARGS args = { };
    BA_ONCACHEACQUIRERESOLVING_RESULTS results = { };

    args.cbSize = sizeof(args);
    args.wzPackageOrContainerId = wzPackageOrContainerId;
    args.wzPayloadId = wzPayloadId;
    args.rgSearchPaths = const_cast<LPCWSTR*>(rgSearchPaths);
    args.cSearchPaths = cSearchPaths;
    args.fFoundLocal = fFoundLocal;
    args.dwRecommendedSearchPath = *pdwChosenSearchPath;
    args.wzDownloadUrl = *pwzDownloadUrl;
    args.recommendation = *pCacheOperation;

    results.cbSize = sizeof(results);
    results.dwChosenSearchPath = *pdwChosenSearchPath;
    results.action = *pCacheOperation;

    hr = SendBAMessageFromInactiveEngine(pUserExperience, BOOTSTRAPPER_APPLICATION_MESSAGE_ONCACHEACQUIRERESOLVING, &args, &results);
    ExitOnFailure(hr, "BA OnCacheAcquireResolving failed.");

    if (results.fCancel)
    {
        hr = HRESULT_FROM_WIN32(ERROR_INSTALL_USEREXIT);
    }
    else
    {
        // Verify the BA requested an action that is possible.
        if (BOOTSTRAPPER_CACHE_RESOLVE_DOWNLOAD == results.action && *pwzDownloadUrl && **pwzDownloadUrl ||
            BOOTSTRAPPER_CACHE_RESOLVE_CONTAINER == results.action && wzPayloadContainerId ||
            BOOTSTRAPPER_CACHE_RESOLVE_RETRY == results.action ||
            BOOTSTRAPPER_CACHE_RESOLVE_NONE == results.action)
        {
            *pCacheOperation = results.action;
        }
        else if (BOOTSTRAPPER_CACHE_RESOLVE_LOCAL == results.action && results.dwChosenSearchPath < cSearchPaths)
        {
            *pdwChosenSearchPath = results.dwChosenSearchPath;
            *pCacheOperation = results.action;
        }
    }

LExit:
    return hr;
}
