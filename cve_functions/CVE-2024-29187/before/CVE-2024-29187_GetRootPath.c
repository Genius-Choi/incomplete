static HRESULT GetRootPath(
    __in BURN_CACHE* pCache,
    __in BOOL fPerMachine,
    __in BOOL fAllowRedirect,
    __deref_out_z LPWSTR* psczRootPath
    )
{
    Assert(pCache->fInitializedCache);

    HRESULT hr = S_OK;

    if (fPerMachine)
    {
        BOOL fRedirect = fAllowRedirect && pCache->fCustomMachinePackageCache;

        hr = StrAllocString(psczRootPath, fRedirect ? pCache->sczCurrentMachinePackageCache : pCache->sczDefaultMachinePackageCache, 0);
        ExitOnFailure(hr, "Failed to copy %hs package cache root directory.", "per-machine");

        // Return S_FALSE if the current location is not the default location (redirected).
        hr = fRedirect ? S_FALSE : S_OK;
    }
    else
    {
        hr = StrAllocString(psczRootPath, pCache->sczDefaultUserPackageCache, 0);
        ExitOnFailure(hr, "Failed to copy %hs package cache root directory.", "per-user");
    }

LExit:
    return hr;
}
