static HRESULT CacheTransferFileWithRetry(
    __in_z LPCWSTR wzSourcePath,
    __in_z LPCWSTR wzDestinationPath,
    __in BOOL fMove,
    __in BURN_CACHE_STEP cacheStep,
    __in DWORD64 qwFileSize,
    __in PFN_BURNCACHEMESSAGEHANDLER pfnCacheMessageHandler,
    __in LPPROGRESS_ROUTINE /*pfnProgress*/,
    __in LPVOID pContext
    )
{
    HRESULT hr = S_OK;

    hr = SendCacheBeginMessage(pfnCacheMessageHandler, pContext, cacheStep);
    ExitOnFailure(hr, "Aborted cache file transfer begin.");

    // TODO: send progress during the file transfer.
    if (fMove)
    {
        hr = FileEnsureMoveWithRetry(wzSourcePath, wzDestinationPath, TRUE, TRUE, FILE_OPERATION_RETRY_COUNT, FILE_OPERATION_RETRY_WAIT);
        ExitOnFailure(hr, "Failed to move %ls to %ls", wzSourcePath, wzDestinationPath);
    }
    else
    {
        hr = FileEnsureCopyWithRetry(wzSourcePath, wzDestinationPath, TRUE, FILE_OPERATION_RETRY_COUNT, FILE_OPERATION_RETRY_WAIT);
        ExitOnFailure(hr, "Failed to copy %ls to %ls", wzSourcePath, wzDestinationPath);
    }

    hr = SendCacheSuccessMessage(pfnCacheMessageHandler, pContext, qwFileSize);

LExit:
    SendCacheCompleteMessage(pfnCacheMessageHandler, pContext, hr);

    return hr;
}
