extern "C" HRESULT DAPI CoreCloseElevatedLoggingThread(
    __in BURN_ENGINE_STATE* pEngineState
    )
{
    HRESULT hr = S_OK;

    if (INVALID_HANDLE_VALUE == pEngineState->elevatedLoggingContext.hThread)
    {
        ExitFunction();
    }

    if (!::SetEvent(pEngineState->elevatedLoggingContext.hFinishedEvent))
    {
        ExitWithLastError(hr, "Failed to set log finished event.");
    }

    hr = AppWaitForSingleObject(pEngineState->elevatedLoggingContext.hThread, 5 * 60 * 1000); // TODO: is 5 minutes good?
    ExitOnFailure(hr, "Failed to wait for elevated logging thread.");

LExit:
    return hr;
}
