extern "C" HRESULT UserExperienceUnload(
    __in BURN_USER_EXPERIENCE* pUserExperience,
    __in BOOL fReload
    )
{
    HRESULT hr = S_OK;
    BOOTSTRAPPER_DESTROY_ARGS args = { };
    BOOTSTRAPPER_DESTROY_RESULTS results = { };

    args.cbSize = sizeof(BOOTSTRAPPER_DESTROY_ARGS);
    args.fReload = fReload;

    results.cbSize = sizeof(BOOTSTRAPPER_DESTROY_RESULTS);

    if (pUserExperience->hUXModule)
    {
        // Get BootstrapperApplicationDestroy entry-point and call it if it exists.
        PFN_BOOTSTRAPPER_APPLICATION_DESTROY pfnDestroy = (PFN_BOOTSTRAPPER_APPLICATION_DESTROY)::GetProcAddress(pUserExperience->hUXModule, "BootstrapperApplicationDestroy");
        if (pfnDestroy)
        {
            pfnDestroy(&args, &results);
        }

        // Free BA DLL if it supports it.
        if (!results.fDisableUnloading && !::FreeLibrary(pUserExperience->hUXModule))
        {
            hr = HRESULT_FROM_WIN32(::GetLastError());
            TraceError(hr, "Failed to unload BA DLL.");
        }
        pUserExperience->hUXModule = NULL;
    }

//LExit:
    return hr;
}
