void CScreencopyPortal::startFrameCopy(CScreencopyPortal::SSession* pSession) {
    const auto POUTPUT = g_pPortalManager->getOutputFromName(pSession->selection.output);

    if (!pSession->sharingData.active) {
        Debug::log(TRACE, "[sc] startFrameCopy: not copying, inactive session");
        return;
    }

    if (!POUTPUT && (pSession->selection.type == TYPE_GEOMETRY || pSession->selection.type == TYPE_OUTPUT)) {
        Debug::log(ERR, "[screencopy] Output {} not found??", pSession->selection.output);
        return;
    }

    if ((pSession->sharingData.frameCallback && (pSession->selection.type == TYPE_GEOMETRY || pSession->selection.type == TYPE_OUTPUT)) ||
        (pSession->sharingData.windowFrameCallback && pSession->selection.type == TYPE_WINDOW)) {
        Debug::log(ERR, "[screencopy] tried scheduling on already scheduled cb (type {})", (int)pSession->selection.type);
        return;
    }

    if (pSession->selection.type == TYPE_GEOMETRY) {
        pSession->sharingData.frameCallback = zwlr_screencopy_manager_v1_capture_output_region(m_sState.screencopy, pSession->cursorMode, POUTPUT->output, pSession->selection.x,
                                                                                               pSession->selection.y, pSession->selection.w, pSession->selection.h);
        pSession->sharingData.transform     = POUTPUT->transform;
    } else if (pSession->selection.type == TYPE_OUTPUT) {
        pSession->sharingData.frameCallback = zwlr_screencopy_manager_v1_capture_output(m_sState.screencopy, pSession->cursorMode, POUTPUT->output);
        pSession->sharingData.transform     = POUTPUT->transform;
    } else if (pSession->selection.type == TYPE_WINDOW) {
        if (!pSession->selection.windowHandle) {
            Debug::log(ERR, "[screencopy] selected invalid window?");
            return;
        }
        pSession->sharingData.windowFrameCallback =
            hyprland_toplevel_export_manager_v1_capture_toplevel_with_wlr_toplevel_handle(m_sState.toplevel, pSession->cursorMode, pSession->selection.windowHandle);
        pSession->sharingData.transform = WL_OUTPUT_TRANSFORM_NORMAL;
    } else {
        Debug::log(ERR, "[screencopy] Unsupported selection {}", (int)pSession->selection.type);
        return;
    }

    pSession->sharingData.status = FRAME_QUEUED;

    if (pSession->sharingData.frameCallback)
        zwlr_screencopy_frame_v1_add_listener(pSession->sharingData.frameCallback, &wlrFrameListener, pSession);
    else if (pSession->sharingData.windowFrameCallback)
        hyprland_toplevel_export_frame_v1_add_listener(pSession->sharingData.windowFrameCallback, &hyprlandFrameListener, pSession);

    Debug::log(TRACE, "[screencopy] frame callbacks initialized");
}
