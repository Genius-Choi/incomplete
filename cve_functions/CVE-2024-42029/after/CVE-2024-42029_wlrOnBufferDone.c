static void wlrOnBufferDone(void* data, zwlr_screencopy_frame_v1* frame) {
    const auto PSESSION = (CScreencopyPortal::SSession*)data;

    Debug::log(TRACE, "[sc] wlrOnBufferDone for {}", (void*)PSESSION);

    const auto PSTREAM = g_pPortalManager->m_sPortals.screencopy->m_pPipewire->streamFromSession(PSESSION);

    if (!PSTREAM) {
        Debug::log(TRACE, "[sc] wlrOnBufferDone: no stream");
        zwlr_screencopy_frame_v1_destroy(frame);
        PSESSION->sharingData.frameCallback = nullptr;
        PSESSION->sharingData.status        = FRAME_NONE;
        return;
    }

    Debug::log(TRACE, "[sc] pw format {} size {}x{}", (int)PSTREAM->pwVideoInfo.format, PSTREAM->pwVideoInfo.size.width, PSTREAM->pwVideoInfo.size.height);
    Debug::log(TRACE, "[sc] wlr format {} size {}x{}", (int)PSESSION->sharingData.frameInfoSHM.fmt, PSESSION->sharingData.frameInfoSHM.w, PSESSION->sharingData.frameInfoSHM.h);
    Debug::log(TRACE, "[sc] wlr format dma {} size {}x{}", (int)PSESSION->sharingData.frameInfoDMA.fmt, PSESSION->sharingData.frameInfoDMA.w, PSESSION->sharingData.frameInfoDMA.h);

    const auto FMT = PSTREAM->isDMA ? PSESSION->sharingData.frameInfoDMA.fmt : PSESSION->sharingData.frameInfoSHM.fmt;
    if ((PSTREAM->pwVideoInfo.format != pwFromDrmFourcc(FMT) && PSTREAM->pwVideoInfo.format != pwStripAlpha(pwFromDrmFourcc(FMT))) ||
        (PSTREAM->pwVideoInfo.size.width != PSESSION->sharingData.frameInfoDMA.w || PSTREAM->pwVideoInfo.size.height != PSESSION->sharingData.frameInfoDMA.h)) {
        Debug::log(LOG, "[sc] Incompatible formats, renegotiate stream");
        PSESSION->sharingData.status = FRAME_RENEG;
        zwlr_screencopy_frame_v1_destroy(frame);
        g_pPortalManager->m_sPortals.screencopy->m_pPipewire->updateStreamParam(PSTREAM);
        g_pPortalManager->m_sPortals.screencopy->queueNextShareFrame(PSESSION);
        PSESSION->sharingData.status = FRAME_NONE;
        return;
    }

    if (!PSTREAM->currentPWBuffer) {
        Debug::log(TRACE, "[sc] wlrOnBufferDone: dequeue, no current buffer");
        g_pPortalManager->m_sPortals.screencopy->m_pPipewire->dequeue(PSESSION);
    }

    if (!PSTREAM->currentPWBuffer) {
        zwlr_screencopy_frame_v1_destroy(frame);
        PSESSION->sharingData.frameCallback = nullptr;
        Debug::log(LOG, "[screencopy/pipewire] Out of buffers");
        PSESSION->sharingData.status = FRAME_NONE;
        return;
    }

    zwlr_screencopy_frame_v1_copy_with_damage(frame, PSTREAM->currentPWBuffer->wlBuffer);

    Debug::log(TRACE, "[sc] wlr frame copied");
}
