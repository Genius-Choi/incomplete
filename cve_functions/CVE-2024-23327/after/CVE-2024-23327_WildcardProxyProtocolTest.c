  WildcardProxyProtocolTest()
      : api_(Api::createApiForTest(stats_store_)),
        dispatcher_(api_->allocateDispatcher("test_thread")),
        socket_(std::make_shared<Network::Test::TcpListenSocketImmediateListen>(
            Network::Test::getAnyAddress(GetParam()))),
        local_dst_address_(Network::Utility::getAddressWithPort(
            *Network::Test::getCanonicalLoopbackAddress(GetParam()),
            socket_->connectionInfoProvider().localAddress()->ip()->port())),
        connection_handler_(new Server::ConnectionHandlerImpl(*dispatcher_, absl::nullopt)),
        name_("proxy"), filter_chain_(Network::Test::createEmptyFilterChainWithRawBufferSockets()),
        init_manager_(nullptr),
        listener_info_(std::make_shared<NiceMock<Network::MockListenerInfo>>()) {
    socket_factories_.emplace_back(std::make_unique<Network::MockListenSocketFactory>());
    EXPECT_CALL(*static_cast<Network::MockListenSocketFactory*>(socket_factories_[0].get()),
                socketType())
        .WillOnce(Return(Network::Socket::Type::Stream));
    EXPECT_CALL(*static_cast<Network::MockListenSocketFactory*>(socket_factories_[0].get()),
                localAddress())
        .WillRepeatedly(ReturnRef(socket_->connectionInfoProvider().localAddress()));
    EXPECT_CALL(*static_cast<Network::MockListenSocketFactory*>(socket_factories_[0].get()),
                getListenSocket(_))
        .WillOnce(Return(socket_));
    connection_handler_->addListener(absl::nullopt, *this, runtime_, random_);
    conn_ = dispatcher_->createClientConnection(
        local_dst_address_, Network::Address::InstanceConstSharedPtr(),
        Network::Test::createRawBufferSocket(), nullptr, nullptr);
    conn_->addConnectionCallbacks(connection_callbacks_);

    EXPECT_CALL(factory_, createListenerFilterChain(_))
        .WillOnce(Invoke([&](Network::ListenerFilterManager& filter_manager) -> bool {
          filter_manager.addAcceptFilter(
              nullptr,
              std::make_unique<Filter>(std::make_shared<Config>(
                  listenerScope(),
                  envoy::extensions::filters::listener::proxy_protocol::v3::ProxyProtocol())));
          return true;
        }));
  }
