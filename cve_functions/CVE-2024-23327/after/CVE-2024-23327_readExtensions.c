ReadOrParseState Filter::readExtensions(Network::ListenerFilterBuffer& buffer) {
  auto raw_slice = buffer.rawSlice();
  // waiting for more data if there is no enough data for extensions.
  if (raw_slice.len_ < (proxy_protocol_header_.value().wholeHeaderLength())) {
    return ReadOrParseState::TryAgainLater;
  }

  if (proxy_protocol_header_.value().local_command_) {
    // Ignores the extensions if this is a local command.
    // Those will drained from the buffer in the end.
    return ReadOrParseState::Done;
  }

  const uint8_t* buf = static_cast<const uint8_t*>(raw_slice.mem_) +
                       proxy_protocol_header_.value().headerLengthWithoutExtension();
  if (!parseTlvs(buf, proxy_protocol_header_.value().extensions_length_)) {
    return ReadOrParseState::Error;
  }

  return ReadOrParseState::Done;
}
