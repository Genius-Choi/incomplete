rec_parse_record (rec_parser_t parser,
                  rec_record_t *record)
{
  rec_record_t new;
  rec_field_t field;
  bool ret;
  int ci;
  char c;
  rec_comment_t comment;
  size_t char_location;

  /* Sanity check */
  if (rec_parser_eof (parser)
      || rec_parser_error (parser))
    return false;

  new = rec_record_new ();
  if (!new)
    {
      parser->error = REC_PARSER_ENOMEM;
      return false;
    }

  /* Localize the potential record.  */
  rec_record_set_source (new, parser->source);
  rec_record_set_location (new, parser->line);
  char_location = parser->character;

  if (char_location != 0)
    char_location++;
  rec_record_set_char_location (new, char_location);

  /* A record is a list of mixed fields and comments, containing at
   * least one field starting it:
   *
   *  FIELD (FIELD|COMMENT)*
   */
  if (rec_parse_field (parser, &field))
    /* Add the field to the record */
    rec_mset_append (rec_record_mset (new), MSET_FIELD, (void *) field, MSET_ANY);
  else
    {
      /* Expected a field.  */
      parser->error = REC_PARSER_EFIELD;
      rec_record_destroy (new);
      *record = NULL;
      return false;
    }

  ret = true;
  while ((ci = rec_parser_getc (parser)) != EOF)
    {
      c = (char) ci;

      if (c == '#')
        {
          rec_parser_ungetc (parser, ci);
          if (rec_parse_comment (parser, &comment))
            /* Add the comment to the record.  */
            rec_mset_append (rec_record_mset (new), MSET_COMMENT, (void *) comment, MSET_ANY);
        }
      else if ((c == ' ') || (c == '\t'))
        {
          /* A line composed just by blanks acts like an end of record
             separator. */

          while ((ci != EOF) && ((c == ' ') || (c == '\t')))
            {
              ci = rec_parser_getc (parser);
              c = (char) ci;
            }

          if ((ci == EOF) || (c == '\n'))
            /* End of record */
            break;
          else
            {
              /* Parse error: field expected */
              parser->error = REC_PARSER_EFIELD;
              ret = false;
              break;
            }
        }
      else if (c == '\n')
        /* End of record */
        break;
      else
        {
          /* Try to parse a field */
          rec_parser_ungetc (parser, ci);
          if (rec_parse_field (parser, &field))
            /* Add the field to the record */
            rec_mset_append (rec_record_mset (new), MSET_FIELD, (void *) field, MSET_ANY);
          else
            {
              /* Parse error: field expected */
              parser->error = REC_PARSER_EFIELD;
              ret = false;
              break;
            }
        }
    }

  if (ret)
    *record = new;
  else
    {
      rec_record_destroy (new);
      *record = NULL;
    }

  return ret;
}
