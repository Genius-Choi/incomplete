generate_ack_frequency_frame (struct ietf_full_conn *conn, lsquic_time_t unused)
{
    struct lsquic_packet_out *packet_out;
    unsigned need;
    int sz;
    /* We tell the peer to ignore reordering because we skip packet numbers to
     * detect optimistic ACK attacks.
     */
    const int ignore = 1;

    need = conn->ifc_conn.cn_pf->pf_ack_frequency_frame_size(
                        conn->ifc_ack_freq_seqno, conn->ifc_last_calc_pack_tol,
                        conn->ifc_pub.max_peer_ack_usec);
    packet_out = get_writeable_packet(conn, need);
    if (!packet_out)
    {
        LSQ_DEBUG("cannot get writeable packet for ACK_FREQUENCY frame");
        return;
    }

    sz = conn->ifc_conn.cn_pf->pf_gen_ack_frequency_frame(
                            packet_out->po_data + packet_out->po_data_sz,
                            lsquic_packet_out_avail(packet_out),
                            conn->ifc_ack_freq_seqno, conn->ifc_last_calc_pack_tol,
                            conn->ifc_pub.max_peer_ack_usec, ignore);
    if (sz < 0)
    {
        ABORT_ERROR("gen_ack_frequency_frame failed");
        return;
    }
    if (0 != lsquic_packet_out_add_frame(packet_out, conn->ifc_pub.mm, 0,
                        QUIC_FRAME_ACK_FREQUENCY, packet_out->po_data_sz, sz))
    {
        ABORT_ERROR("adding frame to packet failed: %d", errno);
        return;
    }
    conn->ifc_last_pack_tol = conn->ifc_last_calc_pack_tol;
    lsquic_send_ctl_incr_pack_sz(&conn->ifc_send_ctl, packet_out, sz);
    packet_out->po_frame_types |= QUIC_FTBIT_ACK_FREQUENCY;
    EV_LOG_CONN_EVENT(LSQUIC_LOG_CONN_ID,
        "Generated ACK_FREQUENCY(seqno: %u; pack_tol: %u; "
        "upd: %u; ignore: %d)", conn->ifc_ack_freq_seqno,
        conn->ifc_last_pack_tol, conn->ifc_pub.max_peer_ack_usec, ignore);
    LSQ_DEBUG("Generated ACK_FREQUENCY(seqno: %u; pack_tol: %u; "
        "upd: %u; ignore: %d)", conn->ifc_ack_freq_seqno,
        conn->ifc_last_pack_tol, conn->ifc_pub.max_peer_ack_usec, ignore);
    ++conn->ifc_ack_freq_seqno;
    conn->ifc_send_flags &= ~SF_SEND_ACK_FREQUENCY;
#if LSQUIC_CONN_STATS
    if (conn->ifc_last_pack_tol > conn->ifc_max_pack_tol_sent)
        conn->ifc_max_pack_tol_sent = conn->ifc_last_pack_tol;
    if (conn->ifc_last_pack_tol < conn->ifc_min_pack_tol_sent
                                    || 0 == conn->ifc_min_pack_tol_sent)
        conn->ifc_min_pack_tol_sent = conn->ifc_last_pack_tol;
#endif
}
