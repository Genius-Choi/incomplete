process_streams_write_events (struct ietf_full_conn *conn, int high_prio)
{
    struct lsquic_stream *stream;
    union prio_iter pi;

    conn->ifc_pii->pii_init(&pi, TAILQ_FIRST(&conn->ifc_pub.write_streams),
        TAILQ_LAST(&conn->ifc_pub.write_streams, lsquic_streams_tailq),
        (uintptr_t) &TAILQ_NEXT((lsquic_stream_t *) NULL, next_write_stream),
        &conn->ifc_pub,
        high_prio ? "write-high" : "write-low", NULL, NULL);

    if (high_prio)
        conn->ifc_pii->pii_drop_non_high(&pi);
    else
        conn->ifc_pii->pii_drop_high(&pi);

    for (stream = conn->ifc_pii->pii_first(&pi);
                        stream && write_is_possible(conn);
                                    stream = conn->ifc_pii->pii_next(&pi))
        if (stream->sm_qflags & SMQF_WRITE_Q_FLAGS)
            lsquic_stream_dispatch_write_events(stream);
    conn->ifc_pii->pii_cleanup(&pi);

    maybe_conn_flush_special_streams(conn);
}
