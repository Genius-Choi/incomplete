process_connection_close_frame (struct ietf_full_conn *conn,
        struct lsquic_packet_in *packet_in, const unsigned char *p, size_t len)
{
    uint64_t error_code;
    uint16_t reason_len;
    uint8_t reason_off;
    int parsed_len, app_error;
    const char *ua;

    parsed_len = conn->ifc_conn.cn_pf->pf_parse_connect_close_frame(p, len,
                            &app_error, &error_code, &reason_len, &reason_off);
    if (parsed_len < 0)
        return 0;
    EV_LOG_CONNECTION_CLOSE_FRAME_IN(LSQUIC_LOG_CONN_ID, error_code,
                            (int) reason_len, (const char *) p + reason_off);
    if (LSQ_LOG_ENABLED(LSQ_LOG_NOTICE)
        && !(   (!app_error && is_benign_transport_error_code(error_code))
              ||( app_error && is_benign_application_error_code(error_code))))
    {
        if (conn->ifc_flags & IFC_HTTP)
        {
            ua = lsquic_qdh_get_ua(&conn->ifc_qdh);
            if (!ua)
                ua = "unknown peer";
        }
        else
            ua = "non-HTTP/3 peer";
        LSQ_NOTICE("Received CONNECTION_CLOSE from <%s> with %s-level error "
            "code %"PRIu64", reason: `%.*s'", ua,
            app_error ? "application" : "transport", error_code,
            (int) reason_len, (const char *) p + reason_off);
    }
    else
        LSQ_INFO("Received CONNECTION_CLOSE frame (%s-level code: %"PRIu64"; "
            "reason: %.*s)", app_error ? "application" : "transport",
                error_code, (int) reason_len, (const char *) p + reason_off);
    if (conn->ifc_enpub->enp_stream_if->on_conncloseframe_received)
        conn->ifc_enpub->enp_stream_if->on_conncloseframe_received(
            &conn->ifc_conn, app_error, error_code, (const char *) p + reason_off, reason_len);
    conn->ifc_flags |= IFC_RECV_CLOSE|IFC_CLOSING;
    return parsed_len;
}
