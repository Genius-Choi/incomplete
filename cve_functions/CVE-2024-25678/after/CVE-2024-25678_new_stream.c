new_stream (struct ietf_full_conn *conn, lsquic_stream_id_t stream_id,
            enum stream_ctor_flags flags)
{
    const struct lsquic_stream_if *iface;
    struct buffered_priority_update *bpu;
    struct lsquic_hash_elem *el;
    void *stream_ctx;
    struct lsquic_stream *stream;
    unsigned initial_window;
    const int call_on_new = flags & SCF_CALL_ON_NEW;

    flags &= ~SCF_CALL_ON_NEW;
    flags |= SCF_DI_AUTOSWITCH|SCF_IETF;

    if ((conn->ifc_flags & IFC_HTTP) && ((stream_id >> SD_SHIFT) & 1) == SD_UNI)
    {
        iface = unicla_if_ptr;
        stream_ctx = conn;
#if CLIENT_PUSH_SUPPORT
        /* FIXME: This logic does not work for push streams.  Perhaps one way
         * to address this is to reclassify them later?
         */
#endif
        if (stream_id < MAX_CRITICAL_STREAM_ID)
        {
            flags |= SCF_CRITICAL;
            ++conn->ifc_pub.n_special_streams;
        }
    }
    else
    {
        iface = conn->ifc_enpub->enp_stream_if;
        stream_ctx = conn->ifc_enpub->enp_stream_if_ctx;
        if (conn->ifc_enpub->enp_settings.es_rw_once)
            flags |= SCF_DISP_RW_ONCE;
        if (conn->ifc_enpub->enp_settings.es_delay_onclose)
            flags |= SCF_DELAY_ONCLOSE;
        if (conn->ifc_flags & IFC_HTTP)
        {
            flags |= SCF_HTTP;
            if (conn->ifc_pii == &ext_prio_iter_if)
                flags |= SCF_HTTP_PRIO;
        }
    }

    if (((stream_id >> SD_SHIFT) & 1) == SD_UNI)
        initial_window = conn->ifc_enpub->enp_settings
                                        .es_init_max_stream_data_uni;
    else
        initial_window = conn->ifc_enpub->enp_settings
                                        .es_init_max_stream_data_bidi_remote;

    stream = lsquic_stream_new(stream_id, &conn->ifc_pub,
                               iface, stream_ctx, initial_window,
                               conn->ifc_cfg.max_stream_send, flags);
    if (stream)
    {
        if (conn->ifc_bpus)
        {
            el = lsquic_hash_find(conn->ifc_bpus, &stream->id,
                                                        sizeof(stream->id));
            if (el)
            {
                LSQ_DEBUG("apply buffered PRIORITY_UPDATE to stream %"PRIu64,
                                                                stream->id);
                lsquic_hash_erase(conn->ifc_bpus, el);
                bpu = lsquic_hashelem_getdata(el);
                (void) lsquic_stream_set_http_prio(stream, &bpu->ehp);
                free(bpu);
            }
        }
        if (lsquic_hash_insert(conn->ifc_pub.all_streams, &stream->id,
                            sizeof(stream->id), stream, &stream->sm_hash_el))
        {
            if (call_on_new)
                lsquic_stream_call_on_new(stream);
        }
        else
        {
            lsquic_stream_destroy(stream);
            stream = NULL;
        }
    }
    return stream;
}
