process_ack_frequency_frame (struct ietf_full_conn *conn,
    struct lsquic_packet_in *packet_in, const unsigned char *p, size_t len)
{
    uint64_t seqno, pack_tol, upd_mad;
    int parsed_len, ignore;

    if (!conn->ifc_settings->es_delayed_acks
        && !(conn->ifc_flags & IFC_DELAYED_ACKS))
    {
        ABORT_QUIETLY(0, TEC_PROTOCOL_VIOLATION,
            "Received unexpected ACK_FREQUENCY frame (not negotiated)");
        return 0;
    }

    parsed_len = conn->ifc_conn.cn_pf->pf_parse_ack_frequency_frame(p, len,
                                        &seqno, &pack_tol, &upd_mad, &ignore);
    if (parsed_len < 0)
        return 0;

    EV_LOG_CONN_EVENT(LSQUIC_LOG_CONN_ID, "RX ACK_FREQUENCY frame: (seqno: %"PRIu64"; "
        "pack_tol: %"PRIu64"; upd: %"PRIu64"; ignore: %d)", seqno,
        pack_tol, upd_mad, ignore);
    LSQ_DEBUG("RX ACK_FREQUENCY frame: (seqno: %"PRIu64"; pack_tol: %"PRIu64"; "
        "upd: %"PRIu64"; ignore: %d)", seqno, pack_tol, upd_mad,
        ignore);

    if (pack_tol == 0)
    {
        ABORT_QUIETLY(0, TEC_PROTOCOL_VIOLATION,
            "Packet Tolerance of zero is invalid");
        return 0;
    }

    if (upd_mad < TP_MIN_ACK_DELAY)
    {
        ABORT_QUIETLY(0, TEC_PROTOCOL_VIOLATION,
            "Update Max Ack Delay value of %"PRIu64" usec is invalid, as it "
            "is smaller than the advertised min_ack_delay of %u usec",
            upd_mad, TP_MIN_ACK_DELAY);
        return 0;
    }

    if (conn->ifc_max_ack_freq_seqno > 0
                                    && seqno <= conn->ifc_max_ack_freq_seqno)
    {
        LSQ_DEBUG("ignore old ACK_FREQUENCY frame");
        return parsed_len;
    }
    conn->ifc_max_ack_freq_seqno = seqno;

    if (pack_tol < UINT_MAX)
    {
        LSQ_DEBUG("set packet tolerance to %"PRIu64, pack_tol);
        conn->ifc_max_retx_since_last_ack = pack_tol;
    }

    if (upd_mad != conn->ifc_max_ack_delay)
    {
        conn->ifc_max_ack_delay = upd_mad;
        LSQ_DEBUG("set Max Ack Delay to new value of %"PRIu64" usec",
            conn->ifc_max_ack_delay);
    }
    else
        LSQ_DEBUG("keep Max Ack Delay unchanged at %"PRIu64" usec",
            conn->ifc_max_ack_delay);

    if (ignore)
    {
        conn->ifc_mflags |= MF_IGNORE_MISSING;
        conn->ifc_flags &= ~IFC_ACK_HAD_MISS;
    }
    else
        conn->ifc_mflags &= ~MF_IGNORE_MISSING;

    return parsed_len;
}
