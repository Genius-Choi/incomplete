switch_path_to (struct ietf_full_conn *conn, unsigned char path_id)
{
    const unsigned char old_path_id = conn->ifc_cur_path_id;
    const int keep_path_properties = conn->ifc_settings->es_optimistic_nat
                    && only_peer_port_changed(CUR_NPATH(conn),
                                    &conn->ifc_paths[path_id].cop_path);

    assert(conn->ifc_cur_path_id != path_id);

    EV_LOG_CONN_EVENT(LSQUIC_LOG_CONN_ID, "switched paths");
    if (keep_path_properties)
    {
        conn->ifc_paths[path_id].cop_path.np_pack_size
                                        = CUR_NPATH(conn)->np_pack_size;
        LSQ_DEBUG("keep path properties: set MTU to %hu",
                        conn->ifc_paths[path_id].cop_path.np_pack_size);
    }
    lsquic_send_ctl_repath(&conn->ifc_send_ctl,
        CUR_NPATH(conn), &conn->ifc_paths[path_id].cop_path,
        keep_path_properties);
    maybe_retire_dcid(conn, &CUR_NPATH(conn)->np_dcid);
    conn->ifc_cur_path_id = path_id;
    conn->ifc_pub.path = CUR_NPATH(conn);
    conn->ifc_conn.cn_cur_cce_idx = CUR_CPATH(conn)->cop_cce_idx;
    conn->ifc_send_flags &= ~(SF_SEND_PATH_CHAL << old_path_id);
    conn->ifc_send_flags &= ~(SF_SEND_PATH_RESP << old_path_id);
    lsquic_alarmset_unset(&conn->ifc_alset, AL_PATH_CHAL + old_path_id);
    if (conn->ifc_flags & IFC_SERVER)
        wipe_path(conn, old_path_id);
}
