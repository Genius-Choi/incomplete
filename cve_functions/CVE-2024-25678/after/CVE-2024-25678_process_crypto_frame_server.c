process_crypto_frame_server (struct ietf_full_conn *conn,
    struct lsquic_packet_in *packet_in, const unsigned char *p, size_t len)
{
    struct stream_frame stream_frame;
    enum enc_level enc_level;
    int parsed_len;

    parsed_len = conn->ifc_conn.cn_pf->pf_parse_crypto_frame(p, len,
                                                                &stream_frame);
    if (parsed_len < 0)
        return 0;

    enc_level = lsquic_packet_in_enc_level(packet_in);
    EV_LOG_CRYPTO_FRAME_IN(LSQUIC_LOG_CONN_ID, &stream_frame, enc_level);
    LSQ_DEBUG("Got CRYPTO frame for enc level #%u", enc_level);
    if (!(conn->ifc_flags & IFC_PROC_CRYPTO))
    {
        LSQ_DEBUG("discard %d-byte CRYPTO frame: handshake has been confirmed",
                                                                    parsed_len);
        return (unsigned) parsed_len;
    }
    if (enc_level < ENC_LEV_HSK)
    {   /* Must be dup */
        LSQ_DEBUG("discard %d-byte CRYPTO frame on level %s", parsed_len,
                                                lsquic_enclev2str[enc_level]);
        return (unsigned) parsed_len;
    }

    if (0 != conn->ifc_conn.cn_esf.i->esfi_data_in(
                    conn->ifc_conn.cn_enc_session,
                    lsquic_packet_in_enc_level(packet_in),
                    stream_frame.data_frame.df_data,
                    stream_frame.data_frame.df_size))
    {
        LSQ_DEBUG("feeding CRYPTO frame to enc session failed");
        return 0;
    }

    if (!conn->ifc_conn.cn_esf.i->esfi_in_init(conn->ifc_conn.cn_enc_session))
    {
        LSQ_DEBUG("handshake confirmed: send HANDSHAKE_DONE");
        conn->ifc_flags &= ~IFC_PROC_CRYPTO;
        conn->ifc_send_flags |= SF_SEND_HANDSHAKE_DONE;

        lsquic_alarmset_init_alarm(&conn->ifc_alset, AL_RET_CIDS,
                                                ret_cids_alarm_expired, conn);
        lsquic_alarmset_set(&conn->ifc_alset, AL_RET_CIDS,
                                      lsquic_time_now() + RET_CID_TIMEOUT);
    }

    return (unsigned) parsed_len;
}
