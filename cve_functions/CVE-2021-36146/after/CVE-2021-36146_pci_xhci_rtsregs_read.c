pci_xhci_rtsregs_read(struct pci_xhci_vdev *xdev, uint64_t offset)
{
	uint32_t value;
	struct timespec t;
	uint64_t time_diff;

	offset -= xdev->rtsoff;
	value = 0;

	if (offset == XHCI_MFINDEX) {
		clock_gettime(CLOCK_MONOTONIC, &t);
		/*
		 * let delta seconds be ds, delta nanoseconds be dns,
		 * the following calculation is derived from:
		 *
		 *     ds * 1000000 / 125 + dns / 1000 / 125
		 */
		time_diff = (t.tv_sec - xdev->init_time.tv_sec) * 8000
			+ (t.tv_nsec - xdev->init_time.tv_nsec) / 125000;

		value = XHCI_MFINDEX_GET(time_diff);
	} else if (offset >= XHCI_RT_IR_BASE) {
		int item;
		uint32_t *p;

		offset -= XHCI_RT_IR_BASE;
		item = offset % 32;

		p = &xdev->rtsregs.intrreg.iman;
		p += item / sizeof(uint32_t);
		value = *p;
	}

	UPRINTF(LDBG, "rtsregs read offset 0x%lx -> 0x%x\r\n",
		offset, value);

	return value;
}
