static int write_unicode(buffer_t buffer, PyObject* py_string) {
    Py_ssize_t string_length;
    const char* string;
    PyObject* encoded = PyUnicode_AsUTF8String(py_string);
    if (!encoded) {
        return 0;
    }
    string = PyBytes_AsString(encoded);
    if (!string) {
        Py_DECREF(encoded);
        return 0;
    }
    string_length = PyBytes_Size(encoded) + 1;
    if (!buffer_write_bytes(buffer, (const char*)&string_length, 4)) {
        Py_DECREF(encoded);
        return 0;
    }
    if (!buffer_write_bytes(buffer, string, string_length)) {
        Py_DECREF(encoded);
        return 0;
    }
    Py_DECREF(encoded);
    return 1;
}
