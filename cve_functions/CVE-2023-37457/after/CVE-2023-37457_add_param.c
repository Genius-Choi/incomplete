static int add_param(void *obj)
{
	struct param_data *data = obj;
	struct ast_sip_session *session = data->channel->session;
	pj_pool_t *pool = session->inv_session->dlg->pool;

	pjsip_fromto_hdr *dlg_info;
	pjsip_name_addr *dlg_info_name_addr;
	pjsip_sip_uri *dlg_info_uri;

	dlg_info = session->inv_session->dlg->local.info; /* Local for outgoing */
	dlg_info_name_addr = (pjsip_name_addr *) dlg_info->uri;
	dlg_info_uri = pjsip_uri_get_uri(dlg_info_name_addr);
	if (!PJSIP_URI_SCHEME_IS_SIP(dlg_info_uri) && !PJSIP_URI_SCHEME_IS_SIPS(dlg_info_uri)) {
		ast_log(LOG_WARNING, "Non SIP/SIPS URI\n");
		return -1;
	}

	ast_debug(1, "Adding custom %s param %s = %s\n",
		data->paramtype == PARAMETER_URI ? "URI" : "header", data->param_name, data->param_value);

	/* This works the same as doing this in set_from_header in res_pjsip_session.c
	 * The way that this maps to pjproject is a little confusing.
	 * Say we have <sip:foo@bar.com;p1=abc;p2=def?h1=qrs&h2=tuv>;o1=foo;o2=bar
	 * p1 and p2 are URI parameters.
	 * (h1 and h2 are URI headers)
	 * o1 and o2 are header parameters (and don't have anything to do with the URI)
	 * In pjproject, other_param is used for adding all custom parameters.
	 * We use the URI for URI stuff, including URI parameters, and the header directly for header parameters.
	 */

#define param_add(pool, list, pname, pvalue) { \
	pjsip_param *param; \
	param = PJ_POOL_ALLOC_T(pool, pjsip_param); \
	pj_strdup2(pool, &param->name, pname); \
	pj_strdup2(pool, &param->value, pvalue); \
	pj_list_insert_before(list, param); \
}

	if (data->paramtype == PARAMETER_URI) { /* URI parameter */
		param_add(pool, &dlg_info_uri->other_param, data->param_name, S_OR(data->param_value, ""));
	} else { /* Header parameter */
		param_add(pool, &dlg_info->other_param, data->param_name, S_OR(data->param_value, ""));
	}

	return 0;
}
