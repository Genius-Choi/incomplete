    bool CFileBinary::OpenTempFile(std::wstring *pwsName, FILE **ppFile, wchar_t *wsMode, wchar_t *wsExt, wchar_t *wsFolder, wchar_t* wsName)
    {
        // TODO: Реализовать когда wsName != NULL

        std::wstring wsTemp, wsFileName;
        FILE *pTempFile = NULL;
#if defined(_WIN32) || defined (_WIN64)
        wchar_t *wsTempDir = NULL;
        size_t sz = 0;
        if ( (0 == _wdupenv_s(&wsTempDir, &sz, L"TEMP")) && (wsFolder == NULL))
        {
            wsTemp = std::wstring(wsTempDir, sz-1);
#else
        char *wsTempDirA;
        if ((wsTempDirA = getenv("TEMP")) && (wsFolder == NULL))
        {
            std::wstring wsTempDir = NSFile::CUtf8Converter::GetUnicodeStringFromUTF8((BYTE*)wsTempDirA, strlen(wsTempDirA));
            wsTemp = wsTempDir.c_str();
#endif
            wsTemp += L"/";
        }
        else if (wsFolder != NULL)
        {
            wsTemp = std::wstring(wsFolder);
            wsTemp += L"/";
        }
        else
        {
            wsTemp = L"";
        }
        wsTemp += L"x";
        int nTime = (int)time(NULL);
        for (int nIndex = 0; nIndex < 1000; ++nIndex)
        {
            wsFileName = wsTemp;
            wsFileName.append(std::to_wstring(nTime + nIndex));

            if (wsExt)
            {
                wsFileName.append(wsExt);
            }
#if defined (_WIN32) || defined (_WIN64)
            if ( 0 != _wfopen_s(&pTempFile, wsFileName.c_str(), L"r") )
            {
                if (0 != _wfopen_s(&pTempFile, wsFileName.c_str(), wsMode))
#else
            std::string sFileName = U_TO_UTF8(wsFileName);
            if (!(pTempFile = fopen(sFileName.c_str(), "r")))
            {
                std::wstring strMode(wsMode);
                std::string sMode = U_TO_UTF8(strMode);
                if (!(pTempFile = fopen(sFileName.c_str(), sMode.c_str())))
#endif
                {
                    return FALSE;
                }
                *pwsName = wsFileName;
                *ppFile = pTempFile;
                return TRUE;
            }

            fclose(pTempFile);
        }

        return FALSE;
    }
