    void CUtf8Converter::GetUtf16StringFromUnicode_4bytes(const wchar_t* pUnicodes, LONG lCount, BYTE*& pData, int& lOutputCount, bool bIsBOM)
    {
        if (NULL == pData)
        {
            pData = new BYTE[4 * lCount + 3 + 2];
        }

        BYTE* pCodesCur = pData;
        if (bIsBOM)
        {
            pCodesCur[0] = 0xEF;
            pCodesCur[1] = 0xBB;
            pCodesCur[2] = 0xBF;
            pCodesCur += 3;
        }

        const wchar_t* pEnd = pUnicodes + lCount;
        const wchar_t* pCur = pUnicodes;

        while (pCur < pEnd)
        {
            unsigned int code = (unsigned int)*pCur++;

            if (code <= 0xFFFF)
            {
                USHORT usCode = (USHORT)(code & 0xFFFF);
                memcpy(pCodesCur, &usCode, 2);
                pCodesCur += 2;
            }
            else
            {
                code -= 0x10000;
                code &= 0xFFFFF;

                USHORT us1 = 0xD800 | ((code >> 10) & 0x03FF);
                USHORT us2 = 0xDC00 | (code & 0x03FF);

                memcpy(pCodesCur, &us1, 2);
                pCodesCur += 2;

                memcpy(pCodesCur, &us2, 2);
                pCodesCur += 2;
            }
        }

        lOutputCount = (LONG)(pCodesCur - pData);
        *pCodesCur++ = 0;
        *pCodesCur++ = 0;
    }
