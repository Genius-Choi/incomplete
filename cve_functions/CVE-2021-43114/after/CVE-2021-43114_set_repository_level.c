set_repository_level(bool is_ta, struct validation *state,
    struct rpki_uri *cert_uri, struct sia_ca_uris *sia_uris, bool *updated)
{
	char *parent_server, *current_server;
	size_t parent_server_len, current_server_len;
	unsigned int new_level;
	bool update;
	int error;

	new_level = 0;
	if (is_ta || cert_uri == NULL) {
		working_repo_push_level(new_level);
		return 0;
	}

	/* Warning killer */
	parent_server = NULL;
	current_server = NULL;
	parent_server_len = 0;
	current_server_len = 0;

	/* Both are rsync URIs, check the server part */
	error = get_rsync_server_uri(cert_uri, &parent_server,
	    &parent_server_len);
	if (error)
		return error;

	error = get_rsync_server_uri(sia_uris->caRepository.uri,
	    &current_server, &current_server_len);
	if (error) {
		free(parent_server);
		return error;
	}

	if (parent_server_len != current_server_len) {
		update = true;
		goto end;
	}

	update = (strcmp(parent_server, current_server) != 0);
end:
	new_level = x509stack_peek_level(validation_certstack(state));
	if (update)
		new_level++;

	working_repo_push_level(new_level);

	free(parent_server);
	free(current_server);

	(*updated) = update;
	return 0;
}
