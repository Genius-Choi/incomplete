rrdp_parse_snapshot(struct update_notification *parent,
    struct visited_uris *visited_uris, bool log_operation)
{
	struct proc_upd_args args;
	struct rpki_uri *uri;
	int error;

	args.parent = parent;
	args.visited_uris = visited_uris;

	pr_val_debug("Processing snapshot '%s'.", parent->snapshot.uri);
	error = uri_create_https_str_rrdp(&uri, parent->snapshot.uri,
	    strlen(parent->snapshot.uri));
	if (error)
		return error;

	error = download_file(uri, 0, log_operation);
	if (error)
		goto release_uri;

	error = parse_snapshot(uri, &args);

	delete_from_uri(uri, NULL);
	/* Error 0 is ok */
release_uri:
	uri_refput(uri);
	return error;
}
