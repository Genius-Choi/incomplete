void bgp_packet_process_error(struct event *thread)
{
	struct peer_connection *connection;
	struct peer *peer;
	int code;

	connection = EVENT_ARG(thread);
	peer = connection->peer;
	code = EVENT_VAL(thread);

	if (bgp_debug_neighbor_events(peer))
		zlog_debug("%s [Event] BGP error %d on fd %d", peer->host, code,
			   connection->fd);

	/* Closed connection or error on the socket */
	if (peer_established(connection)) {
		if ((CHECK_FLAG(peer->flags, PEER_FLAG_GRACEFUL_RESTART)
		     || CHECK_FLAG(peer->flags,
				   PEER_FLAG_GRACEFUL_RESTART_HELPER))
		    && CHECK_FLAG(peer->sflags, PEER_STATUS_NSF_MODE)) {
			peer->last_reset = PEER_DOWN_NSF_CLOSE_SESSION;
			SET_FLAG(peer->sflags, PEER_STATUS_NSF_WAIT);
		} else
			peer->last_reset = PEER_DOWN_CLOSE_SESSION;
	}

	bgp_event_update(connection, code);
}
