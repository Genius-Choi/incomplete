static void bgp_dynamic_capability_graceful_restart(uint8_t *pnt, int action,
						    struct capability_header *hdr,
						    struct peer *peer)
{
#define GRACEFUL_RESTART_CAPABILITY_PER_AFI_SAFI_SIZE 4
	uint16_t gr_restart_flag_time;
	uint8_t *data = pnt + 3;
	uint8_t *end = pnt + hdr->length;
	size_t len = end - data;
	afi_t afi;
	safi_t safi;

	if (action == CAPABILITY_ACTION_SET) {
		if (len < sizeof(gr_restart_flag_time)) {
			zlog_err("%pBP: Received invalid Graceful-Restart capability length %d",
				 peer, hdr->length);
			return;
		}

		SET_FLAG(peer->cap, PEER_CAP_RESTART_RCV);
		ptr_get_be16(data, &gr_restart_flag_time);
		data += sizeof(gr_restart_flag_time);

		if (CHECK_FLAG(gr_restart_flag_time, GRACEFUL_RESTART_R_BIT))
			SET_FLAG(peer->cap, PEER_CAP_GRACEFUL_RESTART_R_BIT_RCV);
		else
			UNSET_FLAG(peer->cap,
				   PEER_CAP_GRACEFUL_RESTART_R_BIT_RCV);

		if (CHECK_FLAG(gr_restart_flag_time, GRACEFUL_RESTART_N_BIT))
			SET_FLAG(peer->cap, PEER_CAP_GRACEFUL_RESTART_N_BIT_RCV);
		else
			UNSET_FLAG(peer->cap,
				   PEER_CAP_GRACEFUL_RESTART_N_BIT_RCV);

		UNSET_FLAG(gr_restart_flag_time, 0xF000);
		peer->v_gr_restart = gr_restart_flag_time;

		while (data + GRACEFUL_RESTART_CAPABILITY_PER_AFI_SAFI_SIZE <=
		       end) {
			afi_t afi;
			safi_t safi;
			iana_afi_t pkt_afi;
			iana_safi_t pkt_safi;
			struct graceful_restart_af graf;

			memcpy(&graf, data, sizeof(graf));
			pkt_afi = ntohs(graf.afi);
			pkt_safi = safi_int2iana(graf.safi);

			/* Convert AFI, SAFI to internal values, check. */
			if (bgp_map_afi_safi_iana2int(pkt_afi, pkt_safi, &afi,
						      &safi)) {
				if (bgp_debug_neighbor_events(peer))
					zlog_debug("%pBP: Addr-family %s/%s(afi/safi) not supported. Ignore the Graceful Restart capability for this AFI/SAFI",
						   peer, iana_afi2str(pkt_afi),
						   iana_safi2str(pkt_safi));
			} else if (!peer->afc[afi][safi]) {
				if (bgp_debug_neighbor_events(peer))
					zlog_debug("%pBP: Addr-family %s/%s(afi/safi) not enabled. Ignore the Graceful Restart capability",
						   peer, iana_afi2str(pkt_afi),
						   iana_safi2str(pkt_safi));
			} else {
				if (bgp_debug_neighbor_events(peer))
					zlog_debug("%pBP: Address family %s is%spreserved",
						   peer,
						   get_afi_safi_str(afi, safi,
								    false),
						   CHECK_FLAG(peer->af_cap[afi]
									  [safi],
							      PEER_CAP_RESTART_AF_PRESERVE_RCV)
							   ? " "
							   : " not ");

				SET_FLAG(peer->af_cap[afi][safi],
					 PEER_CAP_RESTART_AF_RCV);
				if (CHECK_FLAG(graf.flag,
					       GRACEFUL_RESTART_F_BIT))
					SET_FLAG(peer->af_cap[afi][safi],
						 PEER_CAP_RESTART_AF_PRESERVE_RCV);
			}

			data += GRACEFUL_RESTART_CAPABILITY_PER_AFI_SAFI_SIZE;
		}
	} else {
		FOREACH_AFI_SAFI (afi, safi) {
			UNSET_FLAG(peer->af_cap[afi][safi],
				   PEER_CAP_RESTART_AF_RCV);
			UNSET_FLAG(peer->af_cap[afi][safi],
				   PEER_CAP_RESTART_AF_PRESERVE_RCV);
		}

		UNSET_FLAG(peer->cap, PEER_CAP_GRACEFUL_RESTART_R_BIT_RCV);
		UNSET_FLAG(peer->cap, PEER_CAP_GRACEFUL_RESTART_N_BIT_RCV);
		UNSET_FLAG(peer->cap, PEER_CAP_RESTART_RCV);
	}
}
