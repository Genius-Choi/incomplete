HttpStateData::blockSwitchingProtocols(const HttpReply &reply) const
{
    if (!upgradeHeaderOut)
        return "Squid offered no Upgrade at all, but server switched to a tunnel";

    // See RFC 7230 section 6.7 for the corresponding MUSTs

    if (!reply.header.has(Http::HdrType::UPGRADE))
        return "server did not send an Upgrade header field";

    if (!reply.header.hasListMember(Http::HdrType::CONNECTION, "upgrade", ','))
        return "server did not send 'Connection: upgrade'";

    const auto acceptedProtos = reply.header.getList(Http::HdrType::UPGRADE);
    const char *pos = nullptr;
    const char *accepted = nullptr;
    int acceptedLen = 0;
    while (strListGetItem(&acceptedProtos, ',', &accepted, &acceptedLen, &pos)) {
        debugs(11, 5, "server accepted at least" << Raw(nullptr, accepted, acceptedLen));
        return nullptr; // OK: let the client validate server's selection
    }

    return "server sent an essentially empty Upgrade header field";
}
