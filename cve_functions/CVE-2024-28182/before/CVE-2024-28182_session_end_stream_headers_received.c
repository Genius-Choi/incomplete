static int session_end_stream_headers_received(nghttp2_session *session,
                                               nghttp2_frame *frame,
                                               nghttp2_stream *stream) {
  int rv;

  assert(frame->hd.type == NGHTTP2_HEADERS);

  if (session->server && session_enforce_http_messaging(session) &&
      frame->headers.cat == NGHTTP2_HCAT_REQUEST &&
      (stream->flags & NGHTTP2_STREAM_FLAG_NO_RFC7540_PRIORITIES) &&
      !(stream->flags & NGHTTP2_STREAM_FLAG_IGNORE_CLIENT_PRIORITIES) &&
      (stream->http_flags & NGHTTP2_HTTP_FLAG_PRIORITY)) {
    rv = session_update_stream_priority(session, stream, stream->http_extpri);
    if (rv != 0) {
      assert(nghttp2_is_fatal(rv));
      return rv;
    }
  }

  if ((frame->hd.flags & NGHTTP2_FLAG_END_STREAM) == 0) {
    return 0;
  }

  nghttp2_stream_shutdown(stream, NGHTTP2_SHUT_RD);
  rv = nghttp2_session_close_stream_if_shut_rdwr(session, stream);
  if (nghttp2_is_fatal(rv)) {
    return rv;
  }

  return 0;
}
