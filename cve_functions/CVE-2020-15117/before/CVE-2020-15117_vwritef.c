ProtocolUtil::vwritef(synergy::IStream* stream,
                const char* fmt, UInt32 size, va_list args)
{
    assert(stream != NULL);
    assert(fmt != NULL);

    // done if nothing to write
    if (size == 0) {
        return;
    }

    // fill buffer
    UInt8* buffer = new UInt8[size];
    writef(buffer, fmt, args);

    try {
        // write buffer
        stream->write(buffer, size);
        LOG((CLOG_DEBUG2 "wrote %d bytes", size));

        delete[] buffer;
    }
    catch (XBase&) {
        delete[] buffer;
        throw;
    }
}
