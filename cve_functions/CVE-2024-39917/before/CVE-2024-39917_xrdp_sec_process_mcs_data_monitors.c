xrdp_sec_process_mcs_data_monitors(struct xrdp_sec *self, struct stream *s)
{
    int flags;
    int error = 0;
    struct xrdp_client_info *client_info = &(self->rdp_layer->client_info);

    LOG_DEVEL(LOG_LEVEL_TRACE, "xrdp_sec_process_mcs_data_monitors:");

    /* this is an option set in xrdp.ini */
    if (client_info->multimon != 1) /* are multi-monitors allowed ? */
    {
        LOG(LOG_LEVEL_INFO,
            "xrdp_sec_process_mcs_data_monitors:"
            " Multi-monitor is disabled by server config");
        return 0;
    }
    if (!s_check_rem_and_log(s, 4,
                             "xrdp_sec_process_mcs_data_monitors:"
                             " Parsing [MS-RDPBCGR] TS_UD_CS_MONITOR"))
    {
        return SEC_PROCESS_MONITORS_ERR;
    }
    in_uint32_le(s, flags); /* flags */

    //verify flags - must be 0x0
    if (flags != 0)
    {
        LOG(LOG_LEVEL_ERROR,
            "xrdp_sec_process_mcs_data_monitors: [MS-RDPBCGR]"
            " Protocol error: TS_UD_CS_MONITOR flags MUST be zero,"
            " received: 0x%8.8x", flags);
        return SEC_PROCESS_MONITORS_ERR;
    }

    struct display_size_description *description =
        (struct display_size_description *)
        g_malloc(sizeof(struct display_size_description), 1);

    error = libxrdp_process_monitor_stream(s, description, 0);
    if (error == 0)
    {
        client_info->display_sizes.monitorCount = description->monitorCount;

        LOG_DEVEL(LOG_LEVEL_TRACE, "xrdp_sec_process_mcs_data_monitors:"
                  " Received [MS-RDPBCGR] TS_UD_CS_MONITOR"
                  " flags 0x%8.8x, monitorCount %d",
                  flags, description->monitorCount);

        client_info->display_sizes.session_width = description->session_width;
        client_info->display_sizes.session_height = description->session_height;
        g_memcpy(client_info->display_sizes.minfo, description->minfo, sizeof(struct monitor_info) * CLIENT_MONITOR_DATA_MAXIMUM_MONITORS);
        g_memcpy(client_info->display_sizes.minfo_wm, description->minfo_wm, sizeof(struct monitor_info) * CLIENT_MONITOR_DATA_MAXIMUM_MONITORS);
    }

    g_free(description);

    return error;
}
