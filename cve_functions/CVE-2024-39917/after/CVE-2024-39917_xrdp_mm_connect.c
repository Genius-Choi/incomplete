xrdp_mm_connect(struct xrdp_mm *self)
{
    const char *port = xrdp_mm_get_value(self, "port");
    const char *gw_username = xrdp_mm_get_value(self, "pamusername");

    /* make sure we start in correct state */
    cleanup_states(self);

    self->code = xrdp_mm_get_value_int(self, "code", 0);

    /* Look at our module parameters to decide if we need to connect
     * to sesman or not */

    if (port != NULL && g_strcmp(port, "-1") == 0)
    {
        self->use_sesman = 1;
        /* Connecting to a remote sesman is no longer supported. For purely
         * local session types, this setting could be removed.
         * The 'ip' value is still used for Xvnc sessions, to find the TCP
         * address that the X server is listening on */
        if (xrdp_mm_get_value(self, "ip") != NULL)
        {
            if (self->code == XORG_SESSION_CODE)
            {
                xrdp_wm_log_msg(self->wm,
                                LOG_LEVEL_WARNING,
                                "'ip' is not needed for this connection"
                                " - please remove");
            }
        }
    }

    if (gw_username != NULL)
    {
        /* Connecting to a remote sesman is no longer supported */
        if (xrdp_mm_get_value(self, "pamsessionmng") != NULL)
        {
            xrdp_wm_log_msg(self->wm,
                            LOG_LEVEL_WARNING,
                            "Parameter 'pamsessionmng' is obsolete."
                            " Please remove from config");
        }
        self->use_gw_login = 1;
    }

    /* Will we need chansrv ? We use it unconditionally for a
     * sesman session, but the user can also request it separately */
    if (self->use_sesman)
    {
        self->use_chansrv = 1;
    }
    else
    {
        const char *csp = xrdp_mm_get_value(self, "chansrvport");
        /* It's defined, but is it a valid string? */
        if (csp != NULL && parse_chansrvport(csp, NULL, 0, -1) == 0)
        {
            self->use_chansrv = 1;
        }
    }

    xrdp_mm_connect_sm(self);
}
