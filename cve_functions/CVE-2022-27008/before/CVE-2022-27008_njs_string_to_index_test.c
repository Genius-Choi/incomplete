njs_string_to_index_test(njs_vm_t *vm, njs_opts_t *opts, njs_stat_t *stat)
{
    njs_str_t   s, string;
    njs_int_t   ret;
    njs_bool_t  success, is_integer_index;
    njs_uint_t  i;

    static const struct {
        njs_value_t  value;
        njs_str_t    expected;
        njs_bool_t   is_integer_index;
    } tests[] = {
        { njs_string(" 1"), njs_str("NaN"), 0 },
        { njs_string(""), njs_str("NaN"), 0 },
        { njs_string("+0"), njs_str("NaN"), 0 },
        { njs_string("-"), njs_str("NaN"), 0 },

        { njs_string("-0"), njs_str("-0"), 0 },
        { njs_value(NJS_NUMBER, 0, -0.0), njs_str("-0"), 1 },

        { njs_string("-1"), njs_str("-1"), 0 },
        { njs_string("0"), njs_str("0"), 1 },
        { njs_string("0."), njs_str("NaN"), 0 },
        { njs_string("0.0"), njs_str("NaN"), 0 },
        { njs_string("0x1"), njs_str("NaN"), 0 },
        { njs_string("1 "), njs_str("NaN"), 0 },
        { njs_string("1"), njs_str("1"), 1 },
        { njs_string("1."), njs_str("NaN"), 0 },
        { njs_string("1.1"), njs_str("1.1"), 0 },
        { njs_string("100"), njs_str("100"), 1 },
        { njs_string("1a"), njs_str("NaN"), 0 },
        { njs_string("1e+19"), njs_str("NaN"), 0 },
        { njs_string("1e+22"), njs_str("1e+22"), 0 },
        { njs_string("1e22"), njs_str("NaN"), 0 },
        { njs_string("4294967296"), njs_str("4294967296"), 0 },
    };

    for (i = 0; i < njs_nitems(tests); i++) {
        if (njs_is_string(&tests[i].value)) {
            njs_set_number(&vm->retval, njs_string_to_index(&tests[i].value));

            ret = njs_vm_retval_dump(vm, &s, 0);
            if (ret != NJS_OK) {
                njs_printf("njs_string_to_index_test: "
                           "njs_vm_retval_dump() failed\n");
                return NJS_ERROR;
            }

            success = njs_strstr_eq(&tests[i].expected, &s);

            if (!success) {
                njs_string_get(&tests[i].value, &string);
                njs_printf("njs_string_to_index_test(\"%V\"):\n"
                           "expected: \"%V\"\n     got: \"%V\"\n",
                           &string, &tests[i].expected, &s);

                stat->failed++;
                continue;
            }
        }

        is_integer_index = njs_key_is_integer_index(njs_number(&vm->retval),
                                                    &tests[i].value);

        if (tests[i].is_integer_index != is_integer_index) {
            njs_string_get(&tests[i].value, &string);
            njs_printf("njs_string_to_index_test2(\"%V\"):\n"
                       "expected: %b\n     got: %b\n",
                       &string, tests[i].is_integer_index, is_integer_index);

            stat->failed++;
            continue;
        }

        stat->passed++;
    }

    return NJS_OK;
}
