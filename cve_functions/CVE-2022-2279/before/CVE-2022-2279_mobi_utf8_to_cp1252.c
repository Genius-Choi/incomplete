MOBI_RET mobi_utf8_to_cp1252(char *output, const char *input, size_t *outsize, const size_t insize) {
    if (!output || !input) {
        return MOBI_PARAM_ERR;
    }
    const unsigned char *in = (unsigned char *) input;
    unsigned char *out = (unsigned char *) output;
    const unsigned char *outend = out + *outsize - 1; /* leave space for null terminator */
    const unsigned char *inend = in + insize;
    while (in < inend && out < outend && *in) {
        /* one byte */
        if (*in < 0x80) {
            *out++ = *in++;
        }
        /* two bytes */
        else if ((*in & 0xe0) == 0xc0) {
            if (in > inend - 2) { break; }
            if (in[0] == 0xc2 && (in[1] >= 0xa0 && in[1] <= 0xbf)) {
                *out++ = in[1];
            } else if (in[0] == 0xc3 && (in[1] >= 0x80 && in[1] <= 0xbf)) {
                *out++ = in[1] + 0x40;
            } else if (in[0] == 0xc5) {
                switch (in[1]) {
                    case 0xa0:
                        *out++ = 0x8a;
                        break;
                    case 0x92:
                        *out++ = 0x8c;
                        break;
                    case 0xbd:
                        *out++ = 0x8e;
                        break;
                    case 0xa1:
                        *out++ = 0x9a;
                        break;
                    case 0x93:
                        *out++ = 0x9c;
                        break;
                    case 0xbe:
                        *out++ = 0x9e;
                        break;
                    case 0xb8:
                        *out++ = 0x9f;
                        break;
                    default:
                        *out++ = '?';
                        break;
                }
            } else if (in[0] == 0xc6 && in[1] == 0x92) {
                *out++ = 0x83;
            } else if (in[0] == 0xcb && in[1] == 0x86) {
                *out++ = 0x88;
            } else {
                *out++ = '?';
            }
            in += 2;
        }
        /* three bytes */
        else if ((*in & 0xf0) == 0xe0) {
            if (in > inend - 3) { break; }
            if (in[0] == 0xe2 && in[1] == 0x80) {
                switch (in[2]) {
                    case 0x9a:
                        *out++ = 0x82;
                        break;
                    case 0x9e:
                        *out++ = 0x84;
                        break;
                    case 0xa6:
                        *out++ = 0x85;
                        break;
                    case 0xa0:
                        *out++ = 0x86;
                        break;
                    case 0xb0:
                        *out++ = 0x89;
                        break;
                    case 0xb9:
                        *out++ = 0x8b;
                        break;
                    case 0x98:
                        *out++ = 0x91;
                        break;
                    case 0x99:
                        *out++ = 0x92;
                        break;
                    case 0x9c:
                        *out++ = 0x93;
                        break;
                    case 0x9d:
                        *out++ = 0x94;
                        break;
                    case 0xa2:
                        *out++ = 0x95;
                        break;
                    case 0x93:
                        *out++ = 0x86;
                        break;
                    case 0x94:
                        *out++ = 0x97;
                        break;
                    case 0xba:
                        *out++ = 0x9b;
                        break;
                    default:
                        *out++ = '?';
                        break;
                }
            } else if (in[0] == 0xe2 && in[1] == 0x82 && in[2] == 0xac) {
                *out++ = 0x80;
            } else if (in[0] == 0xe2 && in[1] == 0x84 && in[2] == 0xa2) {
                *out++ = 0x99;
            } else {
                *out++ = '?';
            }
            in += 3;
        }
        /* four bytes */
        else if ((*in & 0xf8) == 0xf0) {
            if (in > inend - 4) { break; }
            *out++ = '?';
            in += 4;
        }
        /* skip error */
        else {
            *out++ = '?';
            in++;
        }
    }
    *out = '\0';
    *outsize = (size_t) (out - (unsigned char *) output);
    return MOBI_SUCCESS;
}
