MOBI_RET mobi_remove_part_kf8(MOBIData *m) {
        
    if (m->use_kf8) {
        mobi_swap_mobidata(m);
        m->use_kf8 = false;
    }
    
    if (m->mh == NULL) {
        debug_print("%s\n", "Mobi header missing");
        return MOBI_INIT_FAILED;
    }

    // delete records from boundary (inclusive) up to last eof (exclusive)
    size_t start = m->kf8_boundary_offset;
    size_t count = mobi_get_records_count(m);
    if (start == MOBI_NOTSET || count <= start) {
        debug_print("%s\n", "Bad records range data");
        return MOBI_DATA_CORRUPT;
    }
    count -= start + 1;
    MOBI_RET ret = mobi_delete_records_by_seqnumber(m, start, &count);
    if (ret != MOBI_SUCCESS) {
        return ret;
    }
    
    // delete source and logs records
    if (m->mh->srcs_index && m->mh->srcs_count) {
        start = *m->mh->srcs_index;
        count = *m->mh->srcs_count;
        if (start != MOBI_NOTSET && count != MOBI_NOTSET) {
            ret = mobi_delete_records_by_seqnumber(m, start, &count);
            if (ret != MOBI_SUCCESS) {
                return ret;
            }
            *m->mh->srcs_index = MOBI_NOTSET;
            *m->mh->srcs_count = 0;
        }
    }
    
    // truncate obsolete FONT, RESC records
    if (m->mh->image_index && (start = *m->mh->image_index) != MOBI_NOTSET) {
        MOBIPdbRecord *curr = mobi_get_record_by_seqnumber(m, start);
        while (curr != NULL) {
            if (curr->data && curr->size > 4 &&
                (memcmp(curr->data, FONT_MAGIC, 4) == 0 ||
                 memcmp(curr->data, RESC_MAGIC, 4) == 0)) {
                unsigned char *tmp = realloc(curr->data, 4);
                if (tmp == NULL) {
                    debug_print("%s\n", "Memory allocation failed");
                    return MOBI_MALLOC_FAILED;
                }
                curr->data = tmp;
                curr->size = 4;
            }
            curr = curr->next;
        }
    }
    
    mobi_free_next(m);
    
    // update EXTH tags
    MOBIExthHeader *exth = mobi_get_exthrecord_by_tag(m, EXTH_KF8BOUNDARY);
    if (exth != NULL && exth->size == sizeof(uint32_t)) {
        const uint32_t value = MOBI_NOTSET;
        memcpy(exth->data, &value, exth->size);
    }
    
    ret = mobi_delete_exthrecord_by_tag(m, EXTH_KF8COVERURI);
    if (ret != MOBI_SUCCESS) {
        return ret;
    }
    
    // reset KF8 related EXTH flags
    if (m->mh->exth_flags){
        *m->mh->exth_flags &= 0x7ff;
    }
    
    return MOBI_SUCCESS;
}
