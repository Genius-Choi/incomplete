pid_t do_fork_and_execve_helper(int afdt_fd) {
  std::string path, cwd;
  std::vector<std::string> argv, envp;
  int flags, pgid;
  size_t fd_count;

  lwp_read(afdt_fd, path, cwd, argv, envp, flags, pgid, fd_count);
  std::map<int, int> fds;
  for (size_t i = 0; i < fd_count; ++i) {
    int target_fd;
    lwp_read(afdt_fd, target_fd);
    int current_fd = recv_fd(afdt_fd);
    fds[target_fd] = current_fd;
  }

  pid_t pid = Process::ForkAndExecve(path, argv, envp, cwd, fds, flags, pgid);
  if (pid> 0) {
    lwp_write(afdt_fd, "success", pid);
  } else {
    lwp_write(afdt_fd, "error", (int) pid, (int) errno);
  }

  for (auto [_target, fd] : fds) {
    close(fd);
  }
  return pid;
}
