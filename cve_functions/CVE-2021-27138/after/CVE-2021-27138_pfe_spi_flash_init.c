int pfe_spi_flash_init(void)
{
	struct spi_flash *pfe_flash;
	struct udevice *new;
	int ret = 0;
	void *addr = malloc(CONFIG_SYS_LS_PFE_FW_LENGTH);

	if (!addr)
		return -ENOMEM;

	ret = spi_flash_probe_bus_cs(CONFIG_ENV_SPI_BUS,
				     CONFIG_ENV_SPI_CS,
				     CONFIG_ENV_SPI_MAX_HZ,
				     CONFIG_ENV_SPI_MODE,
				     &new);
	if (ret) {
		printf("SF: failed to probe spi\n");
		free(addr);
		device_remove(new, DM_REMOVE_NORMAL);
		return ret;
	}


	pfe_flash = dev_get_uclass_priv(new);
	if (!pfe_flash) {
		printf("SF: probe for pfe failed\n");
		free(addr);
		device_remove(new, DM_REMOVE_NORMAL);
		return -ENODEV;
	}

	ret = spi_flash_read(pfe_flash,
			     CONFIG_SYS_LS_PFE_FW_ADDR,
			     CONFIG_SYS_LS_PFE_FW_LENGTH,
			     addr);
	if (ret) {
		printf("SF: read for pfe failed\n");
		free(addr);
		spi_flash_free(pfe_flash);
		return ret;
	}

#ifdef CONFIG_CHAIN_OF_TRUST
	void *hdr_addr = malloc(CONFIG_SYS_LS_PFE_ESBC_LENGTH);

	if (!hdr_addr) {
		free(addr);
		spi_flash_free(pfe_flash);
		return -ENOMEM;
	}

	ret = spi_flash_read(pfe_flash,
			     CONFIG_SYS_LS_PFE_ESBC_ADDR,
			     CONFIG_SYS_LS_PFE_ESBC_LENGTH,
			     hdr_addr);
	if (ret) {
		printf("SF: failed to read pfe esbc header\n");
		free(addr);
		free(hdr_addr);
		spi_flash_free(pfe_flash);
		return ret;
	}

	pfe_esbc_hdr_addr = hdr_addr;
#endif
	pfe_fit_addr = addr;
	spi_flash_free(pfe_flash);

	return ret;
}
