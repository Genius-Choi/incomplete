Array * /* IMAPFolder */ IMAPSession::fetchAllFolders(ErrorCode * pError)
{
    int r;
    clist * imap_folders;
    
    loginIfNeeded(pError);
    if (* pError != ErrorNone)
        return NULL;
    
    if (mDelimiter == 0) {
        char delimiter;
        
        delimiter = fetchDelimiterIfNeeded(mDelimiter, pError);
        if (* pError != ErrorNone)
            return NULL;
        
        //setDelimiter(delimiter);
        mDelimiter = delimiter;
    }
    
    String * prefix = NULL;
    if (defaultNamespace()) {
        prefix = defaultNamespace()->mainPrefix();
    }
    if (prefix == NULL) {
        prefix = MCSTR("");
    }
    if (prefix->length() > 0) {
        if (!prefix->hasSuffix(String::stringWithUTF8Format("%c", mDelimiter))) {
            prefix = prefix->stringByAppendingUTF8Format("%c", mDelimiter);
        }
    }
    
    if (mXListEnabled) {
        r = mailimap_xlist(mImap, MCUTF8(prefix), "*", &imap_folders);
    }
    else {
        r = mailimap_list(mImap, MCUTF8(prefix), "*", &imap_folders);
    }
    Array * result = resultsWithError(r, imap_folders, pError);
    if (* pError == ErrorConnection || * pError == ErrorParse)
        mShouldDisconnect = true;
    
    if (result != NULL) {
        bool hasInbox = false;
        mc_foreacharray(IMAPFolder, folder, result) {
            if (folder->path()->isEqual(MCSTR("INBOX"))) {
                hasInbox = true;
            }
        }

        if (!hasInbox) {
            mc_foreacharray(IMAPFolder, folder, result) {
                if (folder->flags() & IMAPFolderFlagInbox) {
                    // some mail providers use non-standart name for inbox folder
                    hasInbox = true;
                    folder->setPath(MCSTR("INBOX"));
                    break;
                }
            }

            if (!hasInbox) {
                r = mailimap_list(mImap, "", "INBOX", &imap_folders);
                Array * inboxResult = resultsWithError(r, imap_folders, pError);
                if (* pError == ErrorConnection || * pError == ErrorParse)
                    mShouldDisconnect = true;
                result->addObjectsFromArray(inboxResult);
                hasInbox = true;
            }
        }
    }
    
    return result;
}
