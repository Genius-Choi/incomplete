static struct mailimap_search_key * searchKeyFromSearchExpression(IMAPSearchExpression * expression)
{
    switch (expression->kind()) {
        case IMAPSearchKindAll:
        {
            return mailimap_search_key_new_all();
        }
        case IMAPSearchKindFrom:
        {
            return mailimap_search_key_new_from(strdup(expression->value()->UTF8Characters()));
        }
        case IMAPSearchKindTo:
        {
            return mailimap_search_key_new_to(strdup(expression->value()->UTF8Characters()));
        }
        case IMAPSearchKindCc:
        {
            return mailimap_search_key_new_cc(strdup(expression->value()->UTF8Characters()));
        }
        case IMAPSearchKindBcc:
        {
            return mailimap_search_key_new_bcc(strdup(expression->value()->UTF8Characters()));
        }
        case IMAPSearchKindRecipient:
        {
            struct mailimap_search_key * to_search;
            struct mailimap_search_key * cc_search;
            struct mailimap_search_key * bcc_search;
            struct mailimap_search_key * or_search1;
            struct mailimap_search_key * or_search2;
            
            to_search = mailimap_search_key_new_to(strdup(expression->value()->UTF8Characters()));
            cc_search = mailimap_search_key_new_cc(strdup(expression->value()->UTF8Characters()));
            bcc_search = mailimap_search_key_new_bcc(strdup(expression->value()->UTF8Characters()));
            
            or_search1 = mailimap_search_key_new_or(to_search, cc_search);
            or_search2 = mailimap_search_key_new_or(or_search1, bcc_search);
            
            return or_search2;
        }
        case IMAPSearchKindSubject:
        {
            return mailimap_search_key_new_subject(strdup(expression->value()->UTF8Characters()));
        }
        case IMAPSearchKindContent:
        {
            return mailimap_search_key_new_text(strdup(expression->value()->UTF8Characters()));
        }
        case IMAPSearchKindBody:
        {
            return mailimap_search_key_new_body(strdup(expression->value()->UTF8Characters()));
        }
        case IMAPSearchKindUIDs:
        {
            return mailimap_search_key_new_uid(setFromIndexSet(expression->uids()));
        }
        case IMAPSearchKindNumbers:
        {
            return mailimap_search_key_new_set(setFromIndexSet(expression->numbers()));
        }
        case IMAPSearchKindHeader:
        {
            return mailimap_search_key_new_header(strdup(expression->header()->UTF8Characters()), strdup(expression->value()->UTF8Characters()));
        }
        case IMAPSearchKindBeforeDate:
        {
            time_t date = expression->date();
            struct tm timeinfo;
            localtime_r(&date, &timeinfo);
            return mailimap_search_key_new_sentbefore(mailimap_date_new(timeinfo.tm_mday, timeinfo.tm_mon+1, timeinfo.tm_year+1900));
        }
        case IMAPSearchKindOnDate:
        {
            time_t date = expression->date();
            struct tm timeinfo;
            localtime_r(&date, &timeinfo);
            return mailimap_search_key_new_senton(mailimap_date_new(timeinfo.tm_mday, timeinfo.tm_mon+1, timeinfo.tm_year+1900));
        }
        case IMAPSearchKindSinceDate:
        {
            time_t date = expression->date();
            struct tm timeinfo;
            localtime_r(&date, &timeinfo);
            return mailimap_search_key_new_sentsince(mailimap_date_new(timeinfo.tm_mday, timeinfo.tm_mon+1, timeinfo.tm_year+1900));
        }
        case IMAPSearchKindBeforeReceivedDate:
        {
            time_t date = expression->date();
            struct tm timeinfo;
            localtime_r(&date, &timeinfo);
            return mailimap_search_key_new_before(mailimap_date_new(timeinfo.tm_mday, timeinfo.tm_mon+1, timeinfo.tm_year+1900));
        }
        case IMAPSearchKindOnReceivedDate:
        {
            time_t date = expression->date();
            struct tm timeinfo;
            localtime_r(&date, &timeinfo);
            return mailimap_search_key_new_on(mailimap_date_new(timeinfo.tm_mday, timeinfo.tm_mon+1, timeinfo.tm_year+1900));
        }
        case IMAPSearchKindSinceReceivedDate:
        {
            time_t date = expression->date();
            struct tm timeinfo;
            localtime_r(&date, &timeinfo);
            return mailimap_search_key_new_since(mailimap_date_new(timeinfo.tm_mday, timeinfo.tm_mon+1, timeinfo.tm_year+1900));
        }
        case IMAPSearchKindGmailThreadID:
        {
            return mailimap_search_key_new_xgmthrid(expression->longNumber());
        }
        case IMAPSearchKindGmailMessageID:
        {
            return mailimap_search_key_new_xgmmsgid(expression->longNumber());
        }
        case IMAPSearchKindRead:
        {
            return mailimap_search_key_new(MAILIMAP_SEARCH_KEY_SEEN, 
                                           NULL, NULL, NULL, NULL, NULL, 
                                           NULL, NULL, NULL, NULL, NULL, 
                                           NULL, NULL, NULL, NULL, 0, 
                                           NULL, NULL, NULL, NULL, NULL, 
                                           NULL, 0, NULL, NULL, NULL);
        }
        case IMAPSearchKindUnread:
        {
            return mailimap_search_key_new(MAILIMAP_SEARCH_KEY_UNSEEN, 
                                           NULL, NULL, NULL, NULL, NULL, 
                                           NULL, NULL, NULL, NULL, NULL, 
                                           NULL, NULL, NULL, NULL, 0, 
                                           NULL, NULL, NULL, NULL, NULL, 
                                           NULL, 0, NULL, NULL, NULL);
        }
        case IMAPSearchKindFlagged:
        {
            return mailimap_search_key_new(MAILIMAP_SEARCH_KEY_FLAGGED, 
                                           NULL, NULL, NULL, NULL, NULL, 
                                           NULL, NULL, NULL, NULL, NULL, 
                                           NULL, NULL, NULL, NULL, 0, 
                                           NULL, NULL, NULL, NULL, NULL, 
                                           NULL, 0, NULL, NULL, NULL);
        }
        case IMAPSearchKindUnflagged:
        {
            return mailimap_search_key_new(MAILIMAP_SEARCH_KEY_UNFLAGGED, 
                                           NULL, NULL, NULL, NULL, NULL, 
                                           NULL, NULL, NULL, NULL, NULL, 
                                           NULL, NULL, NULL, NULL, 0, 
                                           NULL, NULL, NULL, NULL, NULL, 
                                           NULL, 0, NULL, NULL, NULL);
        }
        case IMAPSearchKindAnswered:
        {
            return mailimap_search_key_new(MAILIMAP_SEARCH_KEY_ANSWERED, 
                                           NULL, NULL, NULL, NULL, NULL, 
                                           NULL, NULL, NULL, NULL, NULL, 
                                           NULL, NULL, NULL, NULL, 0, 
                                           NULL, NULL, NULL, NULL, NULL, 
                                           NULL, 0, NULL, NULL, NULL);
        }
        case IMAPSearchKindUnanswered:
        {
            return mailimap_search_key_new(MAILIMAP_SEARCH_KEY_UNANSWERED, 
                                           NULL, NULL, NULL, NULL, NULL, 
                                           NULL, NULL, NULL, NULL, NULL, 
                                           NULL, NULL, NULL, NULL, 0, 
                                           NULL, NULL, NULL, NULL, NULL, 
                                           NULL, 0, NULL, NULL, NULL);
        }
        case IMAPSearchKindDraft:
        {
            return mailimap_search_key_new(MAILIMAP_SEARCH_KEY_DRAFT, 
                                           NULL, NULL, NULL, NULL, NULL, 
                                           NULL, NULL, NULL, NULL, NULL, 
                                           NULL, NULL, NULL, NULL, 0, 
                                           NULL, NULL, NULL, NULL, NULL, 
                                           NULL, 0, NULL, NULL, NULL);
        }
        case IMAPSearchKindUndraft:
        {
            return mailimap_search_key_new(MAILIMAP_SEARCH_KEY_UNDRAFT, 
                                           NULL, NULL, NULL, NULL, NULL, 
                                           NULL, NULL, NULL, NULL, NULL, 
                                           NULL, NULL, NULL, NULL, 0, 
                                           NULL, NULL, NULL, NULL, NULL, 
                                           NULL, 0, NULL, NULL, NULL);
        }
        case IMAPSearchKindDeleted:
        {
            return mailimap_search_key_new(MAILIMAP_SEARCH_KEY_DELETED, 
                                           NULL, NULL, NULL, NULL, NULL, 
                                           NULL, NULL, NULL, NULL, NULL, 
                                           NULL, NULL, NULL, NULL, 0, 
                                           NULL, NULL, NULL, NULL, NULL, 
                                           NULL, 0, NULL, NULL, NULL);
        }
        case IMAPSearchKindSpam:
        {
            return mailimap_search_key_new(MAILIMAP_SEARCH_KEY_KEYWORD, 
                                           NULL, NULL, NULL, NULL, NULL, 
                                           strdup("Junk"), NULL, NULL, NULL, NULL, 
                                           NULL, NULL, NULL, NULL, 0, 
                                           NULL, NULL, NULL, NULL, NULL, 
                                           NULL, 0, NULL, NULL, NULL);
        }
        case IMAPSearchKindSizeLarger:
        {
            return mailimap_search_key_new_larger( (uint32_t) expression->longNumber());
        }
        case IMAPSearchKindSizeSmaller:
        {
            return mailimap_search_key_new_smaller( (uint32_t) expression->longNumber());
        }
        case IMAPSearchKindGmailRaw:
        {
            return mailimap_search_key_new_xgmraw(strdup(expression->value()->UTF8Characters()));
        }
        case IMAPSearchKindOr:
        {
            return mailimap_search_key_new_or(searchKeyFromSearchExpression(expression->leftExpression()), searchKeyFromSearchExpression(expression->rightExpression()));
        }
        case IMAPSearchKindAnd:
        {
            clist * list;
            list = clist_new();
            clist_append(list, searchKeyFromSearchExpression(expression->leftExpression()));
            clist_append(list, searchKeyFromSearchExpression(expression->rightExpression()));
            return mailimap_search_key_new_multiple(list);
        }
        case IMAPSearchKindNot:
        {
            return mailimap_search_key_new_not(searchKeyFromSearchExpression(expression->leftExpression()));
        }

        default:
        MCAssert(0);
        return NULL;
    }
}
