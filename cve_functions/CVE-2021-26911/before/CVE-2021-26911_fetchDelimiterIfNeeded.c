char IMAPSession::fetchDelimiterIfNeeded(char defaultDelimiter, ErrorCode * pError)
{
    int r;
    clist * imap_folders;
    IMAPFolder * folder;
    Array * folders;
    
    if (defaultDelimiter != 0)
        return defaultDelimiter;
    
    r = mailimap_list(mImap, "", "", &imap_folders);
    folders = resultsWithError(r, imap_folders, pError);
    if (* pError == ErrorConnection || * pError == ErrorParse)
        mShouldDisconnect = true;
    if (* pError != ErrorNone)
        return 0;
    
    if (folders->count() > 0) {
        folder = (IMAPFolder *) folders->objectAtIndex(0);
    }
    else {
        folder = NULL;
    }
    if (folder == NULL)
        return 0;
    
    * pError = ErrorNone;
    return folder->delimiter();
}
