String * IMAPSession::customCommand(String * command, ErrorCode * pError)
{
    int r;
    
    loginIfNeeded(pError);
    if (* pError != ErrorNone)
        return NULL;

    r = mailimap_custom_command(mImap, MCUTF8(command));
    if (r == MAILIMAP_ERROR_STREAM) {
        mShouldDisconnect = true;
        * pError = ErrorConnection;
        return NULL;
    }
    else if (r == MAILIMAP_ERROR_PARSE) {
        mShouldDisconnect = true;
        * pError = ErrorParse;
        return NULL;
    }
    else if (hasError(r)) {
        * pError = ErrorCustomCommand;
        return NULL;
    }
    
    String *response = String::stringWithUTF8Characters(mImap->imap_response);
    return response;
}
