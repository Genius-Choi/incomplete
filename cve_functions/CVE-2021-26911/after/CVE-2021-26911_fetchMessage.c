Data * IMAPSession::fetchMessage(String * folder, bool identifier_is_uid, uint32_t identifier,
                                 IMAPProgressCallback * progressCallback, ErrorCode * pError)
{
    char * rfc822;
    size_t rfc822_len;
    int r;
    Data * data;
    
    selectIfNeeded(folder, pError);
    if (* pError != ErrorNone)
        return NULL;
    
    mProgressItemsCount = 0;
    mProgressCallback = progressCallback;
    
    rfc822 = NULL;
    r = fetch_rfc822(mImap, identifier_is_uid, identifier, &rfc822, &rfc822_len);
    if (r == MAILIMAP_NO_ERROR) {
        size_t len;
        
        len = 0;
        if (rfc822 != NULL) {
            len = strlen(rfc822);
        }
        bodyProgress((unsigned int) len, (unsigned int) len);
    }
    mProgressCallback = NULL;
    
    if (r == MAILIMAP_ERROR_STREAM) {
        mShouldDisconnect = true;
        * pError = ErrorConnection;
        return NULL;
    }
    else if (r == MAILIMAP_ERROR_PARSE) {
        mShouldDisconnect = true;
        * pError = ErrorParse;
        return NULL;
    }
    else if (hasError(r)) {
        * pError = ErrorFetch;
        return NULL;
    }
    
    if (rfc822 == NULL) {
        data = Data::data();
    }
    else {
        data = Data::dataWithBytes(rfc822, (unsigned int) rfc822_len);
    }
    
    mailimap_nstring_free(rfc822);
    * pError = ErrorNone;
    
    return data;
}
