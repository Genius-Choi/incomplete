int ff_evc_parse_pps(GetBitContext *gb, EVCParamSets *ps)
{
    EVCParserPPS *pps;
    unsigned pps_pic_parameter_set_id;
    int ret;

    pps_pic_parameter_set_id = get_ue_golomb(gb);
    if (pps_pic_parameter_set_id >= EVC_MAX_PPS_COUNT)
        return AVERROR_INVALIDDATA;

    pps = av_mallocz(sizeof(*pps));
    if (!pps)
        return AVERROR(ENOMEM);

    pps->pps_pic_parameter_set_id = pps_pic_parameter_set_id;

    pps->pps_seq_parameter_set_id = get_ue_golomb(gb);
    if (pps->pps_seq_parameter_set_id >= EVC_MAX_SPS_COUNT) {
        ret = AVERROR_INVALIDDATA;
        goto fail;
    }

    pps->num_ref_idx_default_active_minus1[0] = get_ue_golomb(gb);
    pps->num_ref_idx_default_active_minus1[1] = get_ue_golomb(gb);
    pps->additional_lt_poc_lsb_len = get_ue_golomb(gb);
    pps->rpl1_idx_present_flag = get_bits1(gb);
    pps->single_tile_in_pic_flag = get_bits1(gb);

    if (!pps->single_tile_in_pic_flag) {
        pps->num_tile_columns_minus1 = get_ue_golomb(gb);
        pps->num_tile_rows_minus1 = get_ue_golomb(gb);
        if (pps->num_tile_columns_minus1 >= EVC_MAX_TILE_COLUMNS ||
            pps->num_tile_rows_minus1 >= EVC_MAX_TILE_ROWS) {
            ret = AVERROR_INVALIDDATA;
            goto fail;
        }
        pps->uniform_tile_spacing_flag = get_bits1(gb);

        if (!pps->uniform_tile_spacing_flag) {
            for (int i = 0; i < pps->num_tile_columns_minus1; i++)
                pps->tile_column_width_minus1[i] = get_ue_golomb(gb);

            for (int i = 0; i < pps->num_tile_rows_minus1; i++)
                pps->tile_row_height_minus1[i] = get_ue_golomb(gb);
        }
        pps->loop_filter_across_tiles_enabled_flag = get_bits1(gb);
        pps->tile_offset_len_minus1 = get_ue_golomb(gb);
    }

    pps->tile_id_len_minus1 = get_ue_golomb(gb);
    if (pps->tile_id_len_minus1 > 15U) {
        ret = AVERROR_INVALIDDATA;
        goto fail;
    }
    pps->explicit_tile_id_flag = get_bits1(gb);

    if (pps->explicit_tile_id_flag) {
        for (int i = 0; i <= pps->num_tile_rows_minus1; i++) {
            for (int j = 0; j <= pps->num_tile_columns_minus1; j++)
                pps->tile_id_val[i][j] = get_bits(gb, pps->tile_id_len_minus1 + 1);
        }
    }

    pps->pic_dra_enabled_flag = 0;
    pps->pic_dra_enabled_flag = get_bits1(gb);

    if (pps->pic_dra_enabled_flag)
        pps->pic_dra_aps_id = get_bits(gb, 5);

    pps->arbitrary_slice_present_flag = get_bits1(gb);
    pps->constrained_intra_pred_flag = get_bits1(gb);
    pps->cu_qp_delta_enabled_flag = get_bits1(gb);

    if (pps->cu_qp_delta_enabled_flag)
        pps->log2_cu_qp_delta_area_minus6 = get_ue_golomb(gb);

    av_freep(&ps->pps[pps_pic_parameter_set_id]);
    ps->pps[pps_pic_parameter_set_id] = pps;

    return 0;
fail:
    av_free(pps);
    return ret;
}
