os__path_islink_impl(PyObject *module, PyObject *path)
/*[clinic end generated code: output=6d8640b1a390c054 input=38a3cb937ccf59bf]*/
{
    HANDLE hfile;
    BOOL close_file = TRUE;
    FILE_ATTRIBUTE_TAG_INFO info;
    path_t _path = PATH_T_INITIALIZE("islink", "path", 0, 1);
    int result;
    BOOL slow_path = TRUE;
    FILE_STAT_BASIC_INFORMATION statInfo;

    if (!path_converter(path, &_path)) {
        path_cleanup(&_path);
        if (PyErr_ExceptionMatches(PyExc_ValueError)) {
            PyErr_Clear();
            Py_RETURN_FALSE;
        }
        return NULL;
    }

    Py_BEGIN_ALLOW_THREADS
    if (_path.wide) {
        if (_Py_GetFileInformationByName(_path.wide, FileStatBasicByNameInfo,
                                         &statInfo, sizeof(statInfo))) {
            slow_path = FALSE;
            if (statInfo.FileAttributes & FILE_ATTRIBUTE_REPARSE_POINT) {
                result = (statInfo.ReparseTag == IO_REPARSE_TAG_SYMLINK);
            }
            else {
                result = 0;
            }
        } else if (_Py_GetFileInformationByName_ErrorIsTrustworthy(GetLastError())) {
                    slow_path = FALSE;
                    result = 0;
        }
    }
    if (slow_path) {
        if (_path.fd != -1) {
            hfile = _Py_get_osfhandle_noraise(_path.fd);
            close_file = FALSE;
        }
        else {
            hfile = CreateFileW(_path.wide, FILE_READ_ATTRIBUTES, 0, NULL,
                                OPEN_EXISTING,
                                FILE_FLAG_OPEN_REPARSE_POINT | FILE_FLAG_BACKUP_SEMANTICS,
                                NULL);
        }
        if (hfile != INVALID_HANDLE_VALUE) {
            if (GetFileInformationByHandleEx(hfile, FileAttributeTagInfo, &info,
                                            sizeof(info)))
            {
                result = (info.ReparseTag == IO_REPARSE_TAG_SYMLINK);
            }
            else {
                result = 0;
            }
            if (close_file) {
                CloseHandle(hfile);
            }
        }
        else {
            STRUCT_STAT st;
            switch (GetLastError()) {
            case ERROR_ACCESS_DENIED:
            case ERROR_SHARING_VIOLATION:
            case ERROR_CANT_ACCESS_FILE:
            case ERROR_INVALID_PARAMETER:
                if (LSTAT(_path.wide, &st)) {
                    result = 0;
                }
                else {
                    result = S_ISLNK(st.st_mode);
                }
                break;
            default:
                result = 0;
            }
        }
    }
    Py_END_ALLOW_THREADS

    path_cleanup(&_path);
    if (result) {
        Py_RETURN_TRUE;
    }
    Py_RETURN_FALSE;
}
