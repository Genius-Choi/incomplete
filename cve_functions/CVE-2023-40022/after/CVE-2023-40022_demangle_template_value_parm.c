demangle_template_value_parm(work, mangled, s, tk)
struct work_stuff *work;
const char **mangled;
string *s;
type_kind_t tk;
{
	int success = 1;

	if (**mangled == 'Y') {
		/* The next argument is a template parameter. */
		int idx;

		(*mangled)++;
		idx = consume_count_with_underscores(mangled);
		if (idx == -1 || (work->tmpl_argvec && idx >= work->ntmpl_args) || consume_count_with_underscores(mangled) == -1)
			return -1;
		if (work->tmpl_argvec)
			string_append(s, work->tmpl_argvec[idx]);
		else {
			char buf[10];
			sprintf(buf, "T%d", idx);
			string_append(s, buf);
		}
	} else if (tk == tk_integral)
		success = demangle_integral_value(work, mangled, s);
	else if (tk == tk_char) {
		char tmp[2];
		int val;
		if (**mangled == 'm') {
			string_appendn(s, "-", 1);
			(*mangled)++;
		}
		string_appendn(s, "'", 1);
		val = consume_count(mangled);
		if (val <= 0)
			success = 0;
		else {
			tmp[0] = (char)val;
			tmp[1] = '\0';
			string_appendn(s, &tmp[0], 1);
			string_appendn(s, "'", 1);
		}
	} else if (tk == tk_bool) {
		int val = consume_count(mangled);
		if (val == 0)
			string_appendn(s, "false", 5);
		else if (val == 1)
			string_appendn(s, "true", 4);
		else
			success = 0;
	} else if (tk == tk_real) {
		if (**mangled == 'm') {
			string_appendn(s, "-", 1);
			(*mangled)++;
		}
		while (isdigit((unsigned char)**mangled)) {
			string_appendn(s, *mangled, 1);
			(*mangled)++;
		}
		if (**mangled == '.') /* fraction */
		{
			string_appendn(s, ".", 1);
			(*mangled)++;
			while (isdigit((unsigned char)**mangled)) {
				string_appendn(s, *mangled, 1);
				(*mangled)++;
			}
		}
		if (**mangled == 'e') /* exponent */
		{
			string_appendn(s, "e", 1);
			(*mangled)++;
			while (isdigit((unsigned char)**mangled)) {
				string_appendn(s, *mangled, 1);
				(*mangled)++;
			}
		}
	} else if (tk == tk_pointer || tk == tk_reference) {
		if (**mangled == 'Q')
			success = demangle_qualified(work, mangled, s,
				/*isfuncname=*/0,
				/*append=*/1);
		else {
			int symbol_len = consume_count(mangled);
			if (symbol_len == -1)
				return -1;
			if (symbol_len == 0)
				string_appendn(s, "0", 1);
			else {
				char *p = malloc(symbol_len + 1), *q;
				strncpy(p, *mangled, symbol_len);
				p[symbol_len] = '\0';
				/* We use cplus_demangle_v2 here, rather than
				   internal_cplus_demangle, because the name of the entity
				   mangled here does not make use of any of the squangling
				   or type-code information we have built up thus far; it is
				   mangled independently.  */
				q = cplus_demangle_v2(p, work->options);
				if (tk == tk_pointer)
					string_appendn(s, "&", 1);
				/* FIXME: Pointer-to-member constants should get a
				   qualifying class name here.  */
				if (q) {
					string_append(s, q);
					free(q);
				} else
					string_append(s, p);
				free(p);
			}
			*mangled += symbol_len;
		}
	}

	return success;
}
