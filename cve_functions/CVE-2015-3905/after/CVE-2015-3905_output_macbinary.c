output_macbinary(FILE *rf, int32_t rf_len, const char *filename, FILE *f)
{
  int i, len = strlen(filename);
  char buf[128];
  if (len < 1 || len > 63)
    fatal_error("filename length must be between 1 and 63");
  store_one(0, buf+0);		/* old version number */
  store_one(len, buf+1);	/* filename length */
  memset(buf+2, 0, 63);		/* filename padding */
  memcpy(buf+2, filename, len);	/* filename */
  store_four(T1_FILETYPE, buf+65); /* file type */
  store_four(T1_FILECREATOR, buf+69); /* file creator */
  store_one(T1_FINDERFLAGS, buf+73); /* finder flags */
  store_one(0, buf+74);		/* zero byte */
  store_two(0, buf+75);		/* vertical position in window */
  store_two(0, buf+77);		/* horizontal position in window */
  store_two(0, buf+79);		/* window or folder ID */
  store_one(0, buf+81);		/* protected flag */
  store_one(0, buf+82);		/* zero byte */
  store_four(0, buf+83);	/* data fork length */
  store_four(rf_len, buf+87);	/* resource fork length */
  {
    time_t t = time(0) + MAC_TIME_DELTA;
    store_four(t, buf+91);	/* creation date */
    store_four(t, buf+95);	/* modification date */
  }
  store_two(0, buf+99);		/* GetInfo comment length */
  store_one(0, buf+101);	/* finder flags part 2 */
  memset(buf+102, 0, 116 - 102); /* padding */
  store_four(0, buf+116);	/* total length when unpacked */
  store_two(0, buf+120);	/* length of secondary header */
  store_one(129, buf+122);	/* version number */
  store_one(129, buf+123);	/* minimum acceptable version number */
  store_two(crcbuf(0, 124, buf), buf+124); /* CRC */
  store_two(0, buf+126);	/* padding to 128 bytes */

  /* write out the header */
  fwrite(buf, 1, 128, f);

  /* now write resource fork */
  output_raw(rf, rf_len, f);
  for (i = rf_len % 128; i && i < 128; i++)
    putc(0, f);
}
