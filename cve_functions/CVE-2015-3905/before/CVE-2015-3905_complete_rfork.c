complete_rfork(void)
{
  uint32_t reflist_offset, total_data_len;
  uint32_t typelist_len;
  int i, j, ntypes;

  /* analyze resources */
  {
    int last_type = -1;
    ntypes = 0;
    for (i = 0; i < nrsrc; i++)
      if (rsrc[i].next_in_type == -2) {
	int last = -1;
	if (last_type >= 0)
	  rsrc[last_type].next_type = i;
	for (j = i; j < nrsrc; j++)
	  if (rsrc[j].type == rsrc[i].type) {
	    if (last >= 0)
	      rsrc[last].next_in_type = j;
	    last = j;
	  }
	rsrc[last].next_in_type = -1;
	last_type = i;
	ntypes++;
      }
  }

  /* have just finished writing data */
  /* now write resource map */
  for (i = 0; i < RFORK_MAP_RESERVEDLEN; i++)
    putc(0, rfork_f);		/* reserved */
  write_two(0, rfork_f);	/* resource fork attributes */
  typelist_len = ntypes * RFORK_RTYPE_LEN + 2;
  write_two(RFORK_MAP_HEADERLEN, rfork_f); /* offset from start of map to typelist */
  write_two(RFORK_MAP_HEADERLEN + typelist_len + nrsrc * RFORK_RSRC_LEN, rfork_f); /* offset from start of map to namelist */

  /* output type map */
  write_two(ntypes - 1, rfork_f);/* number of types - 1 */
  reflist_offset = typelist_len;
  for (i = 0; i >= 0; i = rsrc[i].next_type) {
    int n_in_type = 0;
    for (j = i; j >= 0; j = rsrc[j].next_in_type)
      n_in_type++;
    write_four(rsrc[i].type, rfork_f);	/* resource type */
    write_two(n_in_type - 1, rfork_f);	/* number in type - 1 */
    write_two(reflist_offset, rfork_f);	/* offset to reflist from start of typelist */
    reflist_offset += n_in_type * RFORK_RSRC_LEN;
  }

  /* output reference list */
  for (i = 0; i >= 0; i = rsrc[i].next_type)
    for (j = i; j >= 0; j = rsrc[j].next_in_type) {
      write_two(rsrc[j].id, rfork_f);	/* ID */
      write_two(-1, rfork_f);		/* offset to name */
      write_one(rsrc[j].attrs, rfork_f); /* attributes */
      write_three(rsrc[j].data_offset, rfork_f); /* offset to data from start of data */
      write_four(0, rfork_f);		/* reserved */
    }

  /* finally, patch up resource fork header */
  {
    total_data_len = rsrc[nrsrc-1].data_offset + rsrc[nrsrc-1].data_len + 4;
    reposition(rfork_f, 0);
    write_four(RFORK_HEADERLEN, rfork_f); /* offset from rfork to data */
    write_four(RFORK_HEADERLEN + total_data_len, rfork_f); /* offset from rfork to map */
    write_four(total_data_len, rfork_f); /* length of data */
    write_four(RFORK_MAP_HEADERLEN + reflist_offset, rfork_f); /* length of map */
  }

  return RFORK_HEADERLEN + total_data_len + RFORK_MAP_HEADERLEN + reflist_offset;
}
