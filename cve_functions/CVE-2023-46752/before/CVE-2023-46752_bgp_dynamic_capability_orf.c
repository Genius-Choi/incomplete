static void bgp_dynamic_capability_orf(uint8_t *pnt, int action,
				       struct capability_header *hdr,
				       struct peer *peer)
{
	uint8_t *data = pnt + 3;
	uint8_t *end = data + hdr->length;
	size_t len = end - data;

	struct capability_mp_data mpc;
	uint8_t num;
	iana_afi_t pkt_afi;
	afi_t afi;
	iana_safi_t pkt_safi;
	safi_t safi;
	uint8_t type;
	uint8_t mode;
	uint16_t sm_cap = PEER_CAP_ORF_PREFIX_SM_RCV;
	uint16_t rm_cap = PEER_CAP_ORF_PREFIX_RM_RCV;
	int i;

	if (data + CAPABILITY_CODE_ORF_LEN > end) {
		flog_warn(EC_BGP_CAPABILITY_INVALID_LENGTH,
			  "ORF: Received invalid length %zu, less than %d", len,
			  CAPABILITY_CODE_ORF_LEN);
		return;
	}

	/* ORF Entry header */
	memcpy(&mpc, data, sizeof(mpc));
	data += sizeof(mpc);
	num = *data++;
	pkt_afi = ntohs(mpc.afi);
	pkt_safi = mpc.safi;

	/* Convert AFI, SAFI to internal values, check. */
	if (bgp_map_afi_safi_iana2int(pkt_afi, pkt_safi, &afi, &safi)) {
		zlog_info("%pBP Addr-family %d/%d not supported. Ignoring the ORF capability",
			  peer, pkt_afi, pkt_safi);
		return;
	}

	/* validate number field */
	if (CAPABILITY_CODE_ORF_LEN + (num * 2) > hdr->length) {
		zlog_info("%pBP ORF Capability entry length error, Cap length %u, num %u",
			  peer, hdr->length, num);
		return;
	}

	if (action == CAPABILITY_ACTION_UNSET) {
		UNSET_FLAG(peer->af_cap[afi][safi], sm_cap);
		UNSET_FLAG(peer->af_cap[afi][safi], rm_cap);
		return;
	}

	for (i = 0; i < num; i++) {
		if (data + 1 > end) {
			flog_err(EC_BGP_CAPABILITY_INVALID_LENGTH,
				 "%pBP ORF Capability entry length (type) error, Cap length %u, num %u",
				 peer, hdr->length, num);
			return;
		}
		type = *data++;

		if (data + 1 > end) {
			flog_err(EC_BGP_CAPABILITY_INVALID_LENGTH,
				 "%pBP ORF Capability entry length (mode) error, Cap length %u, num %u",
				 peer, hdr->length, num);
			return;
		}
		mode = *data++;

		/* ORF Mode error check */
		switch (mode) {
		case ORF_MODE_BOTH:
		case ORF_MODE_SEND:
		case ORF_MODE_RECEIVE:
			break;
		default:
			if (bgp_debug_neighbor_events(peer))
				zlog_debug("%pBP Addr-family %d/%d has ORF type/mode %d/%d not supported",
					   peer, afi, safi, type, mode);
			continue;
		}

		if (!((afi == AFI_IP && safi == SAFI_UNICAST) ||
		      (afi == AFI_IP && safi == SAFI_MULTICAST) ||
		      (afi == AFI_IP6 && safi == SAFI_UNICAST))) {
			if (bgp_debug_neighbor_events(peer))
				zlog_debug("%pBP Addr-family %d/%d unsupported AFI/SAFI received",
					   peer, afi, safi);
			continue;
		}

		if (bgp_debug_neighbor_events(peer))
			zlog_debug("%pBP OPEN has %s ORF capability as %s for afi/safi: %s/%s",
				   peer, lookup_msg(orf_type_str, type, NULL),
				   lookup_msg(orf_mode_str, mode, NULL),
				   iana_afi2str(pkt_afi),
				   iana_safi2str(pkt_safi));

		switch (mode) {
		case ORF_MODE_BOTH:
			SET_FLAG(peer->af_cap[afi][safi], sm_cap);
			SET_FLAG(peer->af_cap[afi][safi], rm_cap);
			break;
		case ORF_MODE_SEND:
			SET_FLAG(peer->af_cap[afi][safi], sm_cap);
			UNSET_FLAG(peer->af_cap[afi][safi], rm_cap);
			break;
		case ORF_MODE_RECEIVE:
			SET_FLAG(peer->af_cap[afi][safi], rm_cap);
			UNSET_FLAG(peer->af_cap[afi][safi], sm_cap);
			break;
		}
	}
}
