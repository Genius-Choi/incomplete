int HTPFileClose(HtpState *s, HtpTxUserData *tx, const uint8_t *data, uint32_t data_len,
        uint8_t flags, uint8_t direction)
{
    SCEnter();

    SCLogDebug("flags %04x FILE_TRUNCATED %s", flags, (flags & FILE_TRUNCATED) ? "true" : "false");

    int retval = 0;
    int result = 0;
    FileContainer *files = NULL;

    if (direction & STREAM_TOCLIENT) {
        files = &tx->files_tc;
    } else {
        files = &tx->files_ts;
    }

    SCLogDebug("files %p data %p data_len %" PRIu32, files, data, data_len);

    if (files == NULL) {
        retval = -1;
        goto end;
    }

    result = FileCloseFile(files, &htp_sbcfg, data, data_len, flags);
    if (result == -1) {
        retval = -1;
    } else if (result == -2) {
        retval = -2;
    }
    SCLogDebug("result %u", result);

    if (tx->file_range != NULL) {
        bool added =
                HTPFileCloseHandleRange(&htp_sbcfg, files, flags, tx->file_range, data, data_len);
        if (added) {
            tx->tx_data.files_opened++;
        }
        HttpRangeFreeBlock(tx->file_range);
        tx->file_range = NULL;
    }

end:
    SCReturnInt(retval);
}
