    bool DrachtioController::setupLegForIncomingRequest( const string& transactionId, const string& tag ) {
        //DR_LOG(log_debug) << "DrachtioController::setupLegForIncomingRequest - entering"  ;
        std::shared_ptr<PendingRequest_t> p = m_pPendingRequestController->findAndRemove( transactionId ) ;
        if( !p ) {
            return false ;
        }
        if (p->isCanceled()) {
            DR_LOG(log_notice) << "DrachtioController::setupLegForIncomingRequest - app provided a response but INVITE has already been canceled" ;
            return false;
        }
        sip_t* sip = p->getSipObject() ;
        msg_t* msg = p->getMsg() ;
        tport_t* tp = p->getTport() ;

        if (tport_is_shutdown(tp)) {
            DR_LOG(log_notice) << "DrachtioController::setupLegForIncomingRequest - tport has been closed: " << std::hex << (void *) tp ;
            return false;
        }

        if( sip_method_invite == sip->sip_request->rq_method || sip_method_subscribe == sip->sip_request->rq_method ) {

            nta_incoming_t* irq = nta_incoming_create( m_nta, NULL, msg, sip, NTATAG_TPORT(tp), TAG_END() ) ;
            if( NULL == irq ) {
                DR_LOG(log_error) << "DrachtioController::setupLegForIncomingRequest - Error creating a transaction for new incoming invite" ;
                return false ;
            }

            nta_leg_t* leg = nta_leg_tcreate(m_nta, legCallback, this,
                                           SIPTAG_CALL_ID(sip->sip_call_id),
                                           SIPTAG_CSEQ(sip->sip_cseq),
                                           SIPTAG_TO(sip->sip_from),
                                           SIPTAG_FROM(sip->sip_to),
                                           TAG_END());
            if( NULL == leg ) {
                DR_LOG(log_error) << "DrachtioController::setupLegForIncomingRequest - Error creating a leg for new incoming invite"  ;
                return false ;
            }

            DR_LOG(log_debug) << "DrachtioController::setupLegForIncomingRequest - created leg: " << hex << leg << ", irq: " << irq << 
                ", for transactionId: " << transactionId << ", tag: " << tag;


            std::shared_ptr<SipDialog> dlg = std::make_shared<SipDialog>( leg, irq, sip, msg ) ;
            dlg->setTransactionId( transactionId ) ;

            string contactStr ;
            nta_leg_server_route( leg, sip->sip_record_route, sip->sip_contact ) ;

            m_pDialogController->addIncomingInviteTransaction( leg, irq, sip, transactionId, dlg, tag ) ;            
        }
        else {
            nta_incoming_t* irq = nta_incoming_create( m_nta, NULL, msg, sip, NTATAG_TPORT(tp), TAG_END() ) ;
            if( NULL == irq ) {
                DR_LOG(log_error) << "DrachtioController::setupLegForIncomingRequest - Error creating a transaction for new incoming invite or subscribe" ;
                return false ;
            }
            m_pDialogController->addIncomingRequestTransaction( irq, transactionId ) ;
        }
        msg_ref_create( msg ) ; // we need to add a reference to the original request message
        return true ;
    }
