Array VariableUnserializer::unserializeVArray() {
  if (m_dvOverrides) m_dvOverrides->push_back(true);

  int64_t size = readInt();
  expectChar(':');
  expectChar('{');

  auto provTag = unserializeProvenanceTag();
  if (!RO::EvalArrProvDVArrays) provTag = {};

  if (size == 0) {
    expectChar('}');
    if (m_type != Type::Serialize) {
      return Array::attach(provTag
        ? arrprov::tagStaticArr(staticEmptyVArray(), provTag)
        : staticEmptyVArray()
      );
    }
    return m_forceDArrays
      ? Array::attach(provTag
          ? arrprov::tagStaticArr(staticEmptyDArray(), provTag)
          : staticEmptyDArray()
        )
      : Array::attach(provTag
          ? arrprov::tagStaticArr(staticEmptyVArray(), provTag)
          : staticEmptyVArray()
        );
  }
  if (UNLIKELY(size < 0 || size > std::numeric_limits<int>::max())) {
    throwArraySizeOutOfBounds();
  }

  auto const oomCheck = [&](size_t allocsz) {
    // For large arrays, do a naive pre-check for OOM.
    if (UNLIKELY(allocsz > kMaxSmallSize && tl_heap->preAllocOOM(allocsz))) {
      check_non_safepoint_surprise();
    }
  };

  auto arr = Array{};
  if (m_forceDArrays && m_type == Type::Serialize) {
    // Deserialize to vector-ish darray. Use direct calls to MixedArray.
    oomCheck(MixedArray::computeAllocBytesFromMaxElms(size));

    arr = DArrayInit(size).toArray();
    reserveForAdd(size);

    for (int64_t i = 0; i < size; i++) {
      unserializeVariant(MixedArray::LvalInPlace(arr.get(), i));
      if (i < size - 1) checkElemTermination();
    }
  } else {
    // Deserialize to varray. Use direct calls to MixedArray.
    auto const index = PackedArray::capacityToSizeIndex(size);
    oomCheck(MemoryManager::sizeIndex2Size(index));

    arr = VArrayInit(size).toArray();
    reserveForAdd(size);

    for (int64_t i = 0; i < size; i++) {
      unserializeVariant(PackedArray::LvalNewInPlace(arr.get()));
      if (i < size - 1) checkElemTermination();
    }
  }

  check_non_safepoint_surprise();
  expectChar('}');
  if (provTag) arrprov::setTag<arrprov::Mode::Emplace>(arr.get(), provTag);
  return arr;
}
