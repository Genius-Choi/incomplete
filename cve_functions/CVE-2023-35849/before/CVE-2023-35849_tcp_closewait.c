static int tcp_closewait(struct pico_socket *s, struct pico_frame *f)
{
    struct pico_socket_tcp *t = (struct pico_socket_tcp *)s;
    struct pico_tcp_hdr *hdr = (struct pico_tcp_hdr *) (f->transport_hdr);

    if (f->payload_len > 0)
        tcp_data_in(s, f);

    if (hdr->flags & PICO_TCP_ACK)
        tcp_ack(s, f);

    tcp_dbg("called close_wait (%p), in state %08x, f->flags: 0x%02x, hdr->flags: 0x%02x\n", tcp_closewait, s->state, f->flags, hdr->flags);
    tcp_attempt_closewait(s, f);

    /* Ensure that the notification given to the socket
     * did not put us in LAST_ACK state before sending the ACK: i.e. if
     * pico_socket_close() has been called in the socket callback, we don't need to send
     * an ACK here.
     *
     */
    if (((s->state & PICO_SOCKET_STATE_TCP) == PICO_SOCKET_STATE_TCP_CLOSE_WAIT) ||
        ((s->state & PICO_SOCKET_STATE_TCP) == PICO_SOCKET_STATE_TCP_ESTABLISHED))
    {
        tcp_dbg("In closewait: Sending ack! (state is %08x)\n", s->state);
        tcp_send_ack(t);
    }

    return 0;
}
