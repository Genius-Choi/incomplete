int pico_socket_ipv4_recvfrom(struct pico_socket *s, void *buf, uint32_t len, void *orig,
                                  uint16_t *remote_port)
{
    struct pico_frame *f;
    uint8_t *data;
    uint16_t real_len;
    struct pico_socket_ipv4 *s4 = (struct pico_socket_ipv4 *)s;

    f = pico_dequeue(&s->q_in);
    if (!f)
        return 0;
    if (s4->hdr_included) {
        data = f->net_hdr;
        real_len = f->net_len;
    } else {
        data = f->transport_hdr;
        real_len = f->transport_len;
    }
    if (real_len < len) {
        len = real_len;
    }
    if (len == 0)
        return 0;
    memcpy(buf, data, (size_t)len);
    if (!s4->hdr_included && orig) {
        struct pico_ipv4_hdr *hdr = (struct pico_ipv4_hdr *)f->net_hdr;
        memcpy(orig, &hdr->src, sizeof(struct pico_ip4));
        *remote_port = 0;
    }
    pico_frame_discard(f);
    return (int)len;
}
