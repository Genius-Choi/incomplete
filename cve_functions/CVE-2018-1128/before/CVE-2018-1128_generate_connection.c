  void generate_connection() {
    Mutex::Locker l(lock);
    if (!can_create_connection())
      return ;

    Messenger *server, *client;
    {
      boost::uniform_int<> choose(0, available_servers.size() - 1);
      int index = choose(rng);
      set<Messenger*>::iterator i = available_servers.begin();
      for (; index > 0; --index, ++i) ;
      server = *i;
    }
    {
      boost::uniform_int<> choose(0, available_clients.size() - 1);
      int index = choose(rng);
      set<Messenger*>::iterator i = available_clients.begin();
      for (; index > 0; --index, ++i) ;
      client = *i;
    }

    pair<Messenger*, Messenger*> p;
    {
      boost::uniform_int<> choose(0, available_servers.size() - 1);
      if (server->get_default_policy().server) {
        p = make_pair(client, server);
      } else {
        ConnectionRef conn = client->get_connection(server->get_myinst());
        if (available_connections.count(conn) || choose(rng) % 2)
          p = make_pair(client, server);
        else
          p = make_pair(server, client);
      }
    }
    ConnectionRef conn = p.first->get_connection(p.second->get_myinst());
    available_connections[conn] = p;
  }
