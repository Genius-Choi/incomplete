int CMerkleTx::SetMerkleBranch(const CBlock *pblock) {

    CBlock blockTmp;
    if(pblock == NULL) {
        // Load the block this tx is in
        CTxIndex txindex;
        if(!CTxDB("r").ReadTxIndex(GetHash(), txindex))
          return(0);
        if(!blockTmp.ReadFromDisk(txindex.pos.nFile, txindex.pos.nBlockPos))
          return(0);
        pblock = &blockTmp;
    }

    // Update the tx's hashBlock
    hashBlock = pblock->GetHash();

    // Locate the transaction
    for(nIndex = 0; nIndex < (int)pblock->vtx.size(); nIndex++)
      if(pblock->vtx[nIndex] == *(CTransaction *)this) break;

    if(nIndex == (int)pblock->vtx.size()) {
        vMerkleBranch.clear();
        nIndex = -1;
        printf("ERROR: SetMerkleBranch() : couldn't find tx in block\n");
        return(0);
    }

    // Fill in merkle branch
    vMerkleBranch = pblock->GetMerkleBranch(nIndex);

    // Is the tx in a block that's in the main chain
    map<uint256, CBlockIndex*>::iterator mi = mapBlockIndex.find(hashBlock);
    if (mi == mapBlockIndex.end())
        return 0;
    CBlockIndex* pindex = (*mi).second;
    if (!pindex || !pindex->IsInMainChain())
        return 0;

    return pindexBest->nHeight - pindex->nHeight + 1;
}
