char* convert_processed_string_to_ansi(char *out, const TCHAR *in, WORD codepage)
{
    const TCHAR *p=in;
    for (;;)
    {
        _TUCHAR i = (_TUCHAR)*p++;
        if (NS_IS_CODE(i)) // Note: this includes '\0'
        {
            // convert all character up to, and including this code
            int c = (int)(p-in), cb = WideCharToMultiByte(codepage, 0, in, c, out, c*2, NULL, NULL);
            if (!cb && i) return 0;
            out += cb;
            if (i == _T('\0'))
                break;
            else if (i == NS_SKIP_CODE)
                // BUGBUG: Shouldn't the escaped code be converted from wchar_t to codepage as well?
                *out++ = (char) *in++; // simply copy escaped code (01..04)
            else
            {
                WORD w = *p++; // special NSIS code is following by a WORD we need to output unchanged
                *out++ = LOBYTE(w);
                *out++ = HIBYTE(w);
            }
            in = p;
        }
    }
    return out;
}
