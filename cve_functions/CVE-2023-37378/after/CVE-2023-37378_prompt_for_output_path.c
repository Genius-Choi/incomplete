bool CEXEBuild::prompt_for_output_path(TCHAR*path, UINT pathcap) const
{
  using namespace MakensisAPI;
#ifdef _WIN32
  struct handler {
    static bool CALLBACK proc(void*cookie, HWND hWnd, UINT Msg, WPARAM wParam, LPARAM lParam)
    {
      size_t *io = (size_t*) cookie;
      COPYDATASTRUCT*pCDS = (COPYDATASTRUCT*) lParam;
      if (Msg == WM_COPYDATA && pCDS->cbData > sizeof(TCHAR) && pCDS->cbData <= io[2] * sizeof(TCHAR))
      {
        _tcscpy((TCHAR*) io[1], (TCHAR*) ((COPYDATASTRUCT*)lParam)->lpData);
        return (io[0] = (pCDS->dwData == MakensisAPI::PROMPT_FILEPATH));
      }
      return false;
    }
  };
  size_t io[] = { false, (size_t) path, pathcap }, cb;
  TinyGrowBuf inputbuf((IGrowBuf::size_type) (cb = FIELD_OFFSET(PROMPT_FILEPATH_DATA, Path[pathcap])));
  PROMPT_FILEPATH_DATA *p = (PROMPT_FILEPATH_DATA*) inputbuf.get();
  p->Platform = (sizeof(void*) * 8) | sizeof(TCHAR), p->Reserved = 0;
  _tcscpy(p->Path, path);
  return hostapi_request_data(PROMPT_FILEPATH, 0x03006000, handler::proc, io, p, cb) && io[0];
#else
  return false;
#endif
}
