bool CEXEBuild::datablock_finddata(IMMap&mmap, int mmstart, int size, int*ofs)
{
  const int first_int = size;
  size &= ~ 0x80000000;
#ifdef DEBUG
  assert(dynamic_cast<MMapBuf*>(cur_datablock));
#endif
  MMapBuf *db = static_cast<MMapBuf*>(cur_datablock);
  cached_db_size *db_sizes = (cached_db_size *) this->cur_datablock_cache->get();
  int db_sizes_num = this->cur_datablock_cache->getlen() / sizeof(cached_db_size);
  for (int i = 0; i < db_sizes_num; i++)
  {
    if (db_sizes[i].first_int != first_int) continue;
    int left = size, oldpos = db_sizes[i].start_offset;
    while (left > 0)
    {
      int cbCmp = min(left, build_filebuflen);
      void *newstuff = mmap.get(mmstart + size - left, cbCmp);
      void *oldstuff = db->get(sizeof(int) + oldpos + size - left, cbCmp);
      int res = memcmp(newstuff, oldstuff, cbCmp);
      mmap.release(), db->release();
      if (res) break;
      left -= cbCmp;
    }
    if (!left)
    {
      if (ofs) *ofs = oldpos;
      return true;
    }
  }
  return false;
}
