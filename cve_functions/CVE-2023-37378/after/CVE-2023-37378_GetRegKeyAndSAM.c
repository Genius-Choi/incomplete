HKEY NSISCALL GetRegKeyAndSAM(HKEY hKey, REGSAM*pRS)
{
  const REGSAM samviewmask = (KEY_WOW64_32KEY|KEY_WOW64_64KEY);
  const REGSAM incompatsamview = SystemSupportsAltRegView() ? 0 : GetAltViewREGSAM();
  REGSAM sam = *pRS, incompatsam = incompatsamview;
#ifdef C_ASSERT
  {C_ASSERT(REGROOTVIEWTOSAMVIEW(REGROOTVIEW32|REGROOTVIEW64) == (KEY_WOW64_32KEY|KEY_WOW64_64KEY));}
#endif
  if ((sam & KEY_FORCEVIEW) && IsRegRootkeyForcedView(hKey))
  {
    REGSAM keysamview = REGROOTVIEWTOSAMVIEW(hKey);
    if (keysamview == samviewmask) keysamview = (g_exec_flags.alter_reg_view & ~incompatsamview); // HKxxANY tries to honor SetRegView
    sam &= ~samviewmask, sam |= (keysamview & ~(sizeof(void*) > 4 ? 0 : KEY_WOW64_32KEY)); // HKxx32 has the *_32KEY bit set but WinNT4&2000 cannot handle any KEY_WOW64_xxKEY flags.
    hKey = (HKEY) ( (UINT_PTR) hKey & ~(REGROOTVIEW32|REGROOTVIEW64) );
  }
  else if (sam & KEY_ALTERVIEW)
  {
    sam |= g_exec_flags.alter_reg_view; // We don't mask away the incompatsamview bits because the operation is supposed to fail if the view is not supported.
  }
  *pRS = sam & ~(NSIS_REGSAM_PRIVATEMASK); // Filter away internal flags
  return (incompatsam & sam) ? NULL : hKey; // Fail if the requested view is not supported
}
