void CEXEBuild::warninghelper(DIAGCODE dc, bool fl, const TCHAR *fmt, va_list args)
{
  bool showcode = dc != DIAGCODE_INTERNAL_HIDEDIAGCODE;
  if (diagstate.is_disabled(dc)) return ;
  bool aserror = diagstate.is_error(dc);

  TCHAR codbuf[11+2+!0];
  _stprintf(codbuf, showcode ? _T("%u: ") : _T(""), static_cast<unsigned int>(dc));
  ExpandoString<TCHAR, COUNTOF(codbuf) + NSIS_MAX_STRLEN + 100> msgbuf;
  ExpandoString<TCHAR, COUNTOF(codbuf) + 200> fmtbuf;
  fmtbuf.StrFmt(_T("%") NPRIs _T("%") NPRIs, codbuf, fmt);
  size_t cchMsg = msgbuf.StrVFmt(fmtbuf.GetPtr(), args);
  if (fl)
  {
    msgbuf.Reserve(cchMsg+2+_tcslen(curfilename)+1+11+1+!0);
    _stprintf(&msgbuf[cchMsg], _T(" (%") NPRIs _T(":%u)"), curfilename, linecnt);
  }
  const TCHAR *msg = msgbuf.GetPtr();

  m_warnings.add(msg,0); // Add to list of warnings to display at the end

  MakensisAPI::datatransfer_e hostevent = MakensisAPI::NOTIFY_WARNING;
  if (aserror)
    hostevent = MakensisAPI::NOTIFY_ERROR, display_warnings = display_errors;

  notify(hostevent, msg); // Notify the host

  if (display_warnings) // Print "warning %msgwithcodeprefix%" or "warning: %msg%"
    PrintColorFmtMsg_WARN(_T("warning%") NPRIs _T("%") NPRIs _T("\n"), showcode ? _T(" ") : _T(": "), msg);

  if (aserror)
  {
    ERROR_MSG(_T("Error: warning treated as error\n"));
    extern int g_display_errors;
    if (!has_called_write_output) g_display_errors = false; // This is a hack to avoid the "stale file in %temp%" warning.
    extern void quit(); quit();
  }
}
