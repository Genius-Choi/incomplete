int CEXEBuild::SetManifest()
{
  try {
    init_res_editor();
    manifest::SPECIFICATION spec = { (manifest::flags) manifest_flags, manifest_dpiaware, manifest_dpiawareness.c_str(), manifest_lpaware, &manifest_sosl, manifest_maxversiontested.c_str() };
    string manifest = manifest::generate(manifest_comctl, manifest_exec_level, spec);

    if (manifest == "")
      return PS_OK;

    if (!build_unicode && manifest_lpaware >= manifest::lpaware_true)
      throw std::runtime_error("Incompatible option");

    // TODO: Ideally we should allow this but we must be sure that the manifest is custom and not a manifest from the stub
    //if (res_editor->ResourceExists(MAKEINTRESOURCE(24), 1, CResourceEditor::ANYLANGID))
    //  return PS_OK; // Allow user to completely override the manifest with PEAddResource

    // Saved directly as binary into the exe.
    res_editor->UpdateResource(MAKEINTRESOURCE(24), 1, NSIS_DEFAULT_LANG, (LPBYTE) const_cast<char*>(manifest.c_str()), (DWORD) manifest.length());
  }
  catch (exception& err) {
    ERROR_MSG(_T("Error setting manifest: %") NPRIs _T("\n"), CtoTStrParam(err.what()));
    return PS_ERROR;
  }

  return PS_OK;
}
