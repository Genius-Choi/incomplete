nmq_connack_encode(nng_msg *msg, conn_param *cparam, uint8_t reason)
{
	uint8_t ack_flag = 0x00;
	nni_msg_append(msg, &ack_flag, 1);
	nni_msg_append(msg, &reason, 1);

	if (cparam->pro_ver == MQTT_PROTOCOL_VERSION_v5) {
		// TODO set properties if necessary
		encode_properties(msg, cparam->properties, CMD_CONNACK);
	}

	size_t         msg_len    = nng_msg_len(msg);
	uint8_t        var_len[4] = { 0 };
	struct pos_buf buf = { .curpos = &var_len[0], .endpos = &var_len[4] };

	int     bytes = write_variable_length_value(msg_len, &buf);
	uint8_t cmd   = CMD_CONNACK;
	nng_msg_header_append(msg, &cmd, 1);
	nng_msg_header_append(msg, var_len, bytes);
}
