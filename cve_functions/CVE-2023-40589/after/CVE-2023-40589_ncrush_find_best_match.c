static int ncrush_find_best_match(NCRUSH_CONTEXT* ncrush, UINT16 HistoryOffset,
                                  UINT32* pMatchOffset)
{
	int i, j;
	int Length;
	int MatchLength;
	BYTE* MatchPtr;
	UINT16 Offset;
	UINT16 NextOffset;
	UINT16 MatchOffset;
	BYTE* HistoryBuffer;

	WINPR_ASSERT(ncrush);
	WINPR_ASSERT(pMatchOffset);

	if (!ncrush->MatchTable[HistoryOffset])
		return -1;

	MatchLength = 2;
	Offset = HistoryOffset;
	HistoryBuffer = (BYTE*)ncrush->HistoryBuffer;
	ncrush->MatchTable[0] = HistoryOffset;
	MatchOffset = ncrush->MatchTable[HistoryOffset];
	NextOffset = ncrush->MatchTable[Offset];
	MatchPtr = &HistoryBuffer[MatchLength];

	for (i = 0; i < 4; i++)
	{
		j = -1;

		if (j < 0)
		{
			Offset = ncrush->MatchTable[NextOffset];

			if (MatchPtr[NextOffset] == HistoryBuffer[HistoryOffset + MatchLength])
				j = 0;
		}

		if (j < 0)
		{
			NextOffset = ncrush->MatchTable[Offset];

			if (MatchPtr[Offset] == HistoryBuffer[HistoryOffset + MatchLength])
				j = 1;
		}

		if (j < 0)
		{
			Offset = ncrush->MatchTable[NextOffset];

			if (MatchPtr[NextOffset] == HistoryBuffer[HistoryOffset + MatchLength])
				j = 2;
		}

		if (j < 0)
		{
			NextOffset = ncrush->MatchTable[Offset];

			if (MatchPtr[Offset] == HistoryBuffer[HistoryOffset + MatchLength])
				j = 3;
		}

		if (j < 0)
		{
			Offset = ncrush->MatchTable[NextOffset];

			if (MatchPtr[NextOffset] == HistoryBuffer[HistoryOffset + MatchLength])
				j = 4;
		}

		if (j < 0)
		{
			NextOffset = ncrush->MatchTable[Offset];

			if (MatchPtr[Offset] == HistoryBuffer[HistoryOffset + MatchLength])
				j = 5;
		}

		if (j >= 0)
		{
			if ((j % 2) == 0)
				Offset = NextOffset;

			if ((Offset != HistoryOffset) && Offset)
			{
				Length = ncrush_find_match_length(&HistoryBuffer[HistoryOffset + 2],
				                                  &HistoryBuffer[Offset + 2], ncrush->HistoryPtr) +
				         2;

				if (Length < 2)
					return -1;

				if (Length > 16)
					break;

				if (Length > MatchLength)
				{
					MatchLength = Length;
					MatchOffset = Offset;
				}

				if ((Length <= MatchLength) ||
				    (&HistoryBuffer[HistoryOffset + 2] < ncrush->HistoryPtr))
				{
					NextOffset = ncrush->MatchTable[Offset];
					MatchPtr = &HistoryBuffer[MatchLength];
					continue;
				}
			}

			break;
		}
	}

	ncrush->MatchTable[0] = 0;
	*pMatchOffset = MatchOffset;
	return MatchLength;
}
