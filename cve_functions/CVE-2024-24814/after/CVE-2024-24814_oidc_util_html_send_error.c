int oidc_util_html_send_error(request_rec *r, const char *html_template, const char *error, const char *description,
			      int status_code) {

	char *html = "";
	int rc = status_code;

	if (html_template != NULL) {

		if (_oidc_strcmp(html_template, "deprecated") != 0) {

			rc = oidc_util_html_send_in_template(r, html_template, &html_error_template_contents, error,
							     OIDC_POST_PRESERVE_ESCAPE_HTML, description,
							     OIDC_POST_PRESERVE_ESCAPE_HTML, status_code);

		} else {

			if (error != NULL) {
				html = apr_psprintf(r->pool, "%s<p>Error: <pre>%s</pre></p>", html,
						    oidc_util_html_escape(r->pool, error));
			}
			if (description != NULL) {
				html = apr_psprintf(r->pool, "%s<p>Description: <pre>%s</pre></p>", html,
						    oidc_util_html_escape(r->pool, description));
			}

			rc = oidc_util_html_send(r, "Error", NULL, NULL, html, status_code);
		}
	}

	oidc_debug(r, "setting " OIDC_ERROR_ENVVAR " environment variable to: %s", error);
	apr_table_set(r->subprocess_env, OIDC_ERROR_ENVVAR, error ? error : "");

	oidc_debug(r, "setting " OIDC_ERROR_DESC_ENVVAR " environment variable to: %s", description);
	apr_table_set(r->subprocess_env, OIDC_ERROR_DESC_ENVVAR, description ? description : "");

	return rc;
}
