pf_set_protostate(struct pf_state *st, int which, u_int8_t newstate)
{
	if (which == PF_PEER_DST || which == PF_PEER_BOTH)
		st->dst.state = newstate;
	if (which == PF_PEER_DST)
		return;

	if (st->src.state == newstate)
		return;
	if (st->creatorid == pf_status.hostid &&
	    st->key[PF_SK_STACK]->proto == IPPROTO_TCP &&
	    !(TCPS_HAVEESTABLISHED(st->src.state) ||
	    st->src.state == TCPS_CLOSED) &&
	    (TCPS_HAVEESTABLISHED(newstate) || newstate == TCPS_CLOSED))
		pf_status.states_halfopen--;

	st->src.state = newstate;
}
