pf_anchor_stack_push(struct pf_ruleset *rs, struct pf_rule *r,
    struct pf_anchor *child, int jump_target)
{
	struct pf_anchor_stackframe *stack;
	struct pf_anchor_stackframe *top_sf = pf_anchor_stack_top();

	top_sf++;
	if (pf_anchor_stack_is_full(top_sf))
		return (-1);

	top_sf->sf_rs = rs;
	top_sf->sf_r = r;
	top_sf->sf_child = child;
	top_sf->sf_jump_target = jump_target;

	stack = (struct pf_anchor_stackframe *)cpumem_enter(pf_anchor_stack);

	if ((top_sf <= &stack[0]) || (top_sf >= &stack[PF_ANCHOR_STACK_MAX]))
		panic("%s: top frame outside of anchor stack range", __func__);

	stack[PF_ANCHOR_STACK_MAX].sf_stack_top = top_sf;
	cpumem_leave(pf_anchor_stack, stack);

	return (0);
}
