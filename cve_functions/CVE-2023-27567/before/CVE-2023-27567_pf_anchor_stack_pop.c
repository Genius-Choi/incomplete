pf_anchor_stack_pop(struct pf_ruleset **rs, struct pf_rule **r,
    struct pf_anchor **child, int *jump_target)
{
	struct pf_anchor_stackframe *top_sf = pf_anchor_stack_top();
	struct pf_anchor_stackframe *stack;
	int on_top;

	stack = (struct pf_anchor_stackframe *)cpumem_enter(pf_anchor_stack);
	if (pf_anchor_stack_is_empty(top_sf)) {
		on_top = -1;
	} else {
		if ((top_sf <= &stack[0]) ||
		    (top_sf >= &stack[PF_ANCHOR_STACK_MAX]))
			panic("%s: top frame outside of anchor stack range",
			    __func__);

		*rs = top_sf->sf_rs;
		*r = top_sf->sf_r;
		*child = top_sf->sf_child;
		*jump_target = top_sf->sf_jump_target;
		top_sf--;
		stack[PF_ANCHOR_STACK_MAX].sf_stack_top = top_sf;
		on_top = 0;
	}
	cpumem_leave(pf_anchor_stack, stack);

	return (on_top);
}
