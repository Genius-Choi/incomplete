std::string ExtractClientIP(std::string serverConfig, std::string remote_ip,
                            std::map<std::string, std::string> headers) {
  std::unique_ptr<ApiManagerEnvInterface> env(new MockApiManagerEnvironment());

  std::shared_ptr<context::GlobalContext> global_context(
      new context::GlobalContext(std::move(env), serverConfig));

  std::unique_ptr<Config> config =
      Config::Create(global_context->env(), std::string(kServiceConfig1));

  std::shared_ptr<context::ServiceContext> service_context(
      new context::ServiceContext(global_context, std::move(config)));

  std::unique_ptr<MockRequest> request(new MockRequest(remote_ip, headers));

  RequestContext context(service_context, std::move(request));

  service_control::CheckRequestInfo info;

  context.FillCheckRequestInfo(&info);

  return info.client_ip;
}
