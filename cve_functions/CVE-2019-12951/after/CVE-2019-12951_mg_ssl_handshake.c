MG_INTERNAL void mg_ssl_handshake(struct mg_connection *nc) {
  int err = 0;
  int server_side = (nc->listener != NULL);
  enum mg_ssl_if_result res;
  if (nc->flags & MG_F_SSL_HANDSHAKE_DONE) return;
  res = mg_ssl_if_handshake(nc);

  if (res == MG_SSL_OK) {
    nc->flags |= MG_F_SSL_HANDSHAKE_DONE;
    nc->flags &= ~(MG_F_WANT_READ | MG_F_WANT_WRITE);
    if (server_side) {
      mg_call(nc, NULL, nc->user_data, MG_EV_ACCEPT, &nc->sa);
    } else {
      mg_call(nc, NULL, nc->user_data, MG_EV_CONNECT, &err);
    }
  } else if (res == MG_SSL_WANT_READ) {
    nc->flags |= MG_F_WANT_READ;
  } else if (res == MG_SSL_WANT_WRITE) {
    nc->flags |= MG_F_WANT_WRITE;
  } else {
    if (!server_side) {
      err = res;
      mg_call(nc, NULL, nc->user_data, MG_EV_CONNECT, &err);
    }
    nc->flags |= MG_F_CLOSE_IMMEDIATELY;
  }
}
