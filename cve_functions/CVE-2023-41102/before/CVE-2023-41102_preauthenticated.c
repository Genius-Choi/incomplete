static int preauthenticated(struct MHD_Connection *connection, const char *url, t_client *client)
{
	s_config *config = config_get_config();
	const char *host = config->gw_address;
	const char *accept = NULL;
	const char *redirect_url;
	char *query;
	char *querystr;
	char *originurl;
	char *originurl_raw = NULL;
	char *captive_json = NULL;

	int ret;

	ret = MHD_get_connection_values(connection, MHD_HEADER_KIND, get_host_value_callback, &host);

	if (ret < 1) {
		debug(LOG_ERR, "preauthenticated: Error getting host");
		return MHD_NO;
	}

	debug(LOG_DEBUG, "preauthenticated: host [%s] url [%s]", host, url);

	if (host == NULL) {
		debug(LOG_ERR, "preauthenticated: Error getting host");
		host = config->gw_address;
	}

	// check if this is an RFC8910 login request
	if (strcmp(url, "/login") == 0) {
		debug(LOG_INFO, "preauthenticated: RFC8910 login request received from client at [%s] [%s]", client->ip, client->mac);
		client->client_type = "cpi_url";
		return redirect_to_splashpage(connection, client, host, "/login");
	}

	// Is it an RFC8908 type request? - check Accept: header
	ret = MHD_get_connection_values(connection, MHD_HEADER_KIND, get_accept_callback, &accept);

	if (ret < 1) {
		debug(LOG_ERR, "preauthenticated: Error getting Accept header");
		return MHD_NO;
	}

	if (accept && strcmp(accept, "application/captive+json") == 0) {
		debug(LOG_DEBUG, "preauthenticated: Accept header [%s]", accept);
		debug(LOG_NOTICE, "preauthenticated: RFC 8908 captive+json request received from client at [%s] [%s]", client->ip, client->mac);

		client->client_type = "cpi_api";

		originurl_raw = safe_calloc(REDIRECT_URL);

		if (strcmp(config->gw_fqdn, "disable") == 0 || strcmp(config->gw_fqdn, "disabled") == 0) {
			safe_snprintf(originurl_raw, REDIRECT_URL, "http://%s", config->gw_ip);
		} else {
			safe_snprintf(originurl_raw, REDIRECT_URL, "http://%s", config->gw_fqdn);
		}

		originurl = safe_calloc(REDIRECT_URL_ENC_BUF);
		uh_urlencode(originurl, REDIRECT_URL_ENC_BUF, originurl_raw, strlen(originurl_raw));
		debug(LOG_DEBUG, "originurl: %s", originurl);

		querystr = safe_calloc(QUERYMAXLEN);

		if (!querystr) {
			ret = send_error(connection, 503);
			free(originurl);
			free(originurl_raw);
			free(querystr);
			return ret;
		}

		querystr=construct_querystring(connection, client, originurl, querystr);
		debug(LOG_DEBUG, "Constructed query string [%s]", querystr);
		debug(LOG_DEBUG, "FAS url [%s]", config->fas_url);

		captive_json = safe_calloc(QUERYMAXLEN);

		if (!captive_json) {
			ret = send_error(connection, 503);
			free(originurl);
			free(originurl_raw);
			free(querystr);
			free(captive_json);
			return ret;
		}

		safe_snprintf(captive_json, QUERYMAXLEN, "{ \"captive\": true, \"user-portal-url\": \"%s%s\" }", config->fas_url, querystr);

		debug(LOG_DEBUG, "captive_json [%s]", captive_json);
		ret = send_json(connection, captive_json);

		free(originurl);
		free(originurl_raw);
		free(querystr);
		free(captive_json);
		return ret;
	}

	// Did user just access gatewayaddress:gatewayport directly or by redirect
	if (strcmp(url, "/") == 0) {
		if (strcmp(host, config->gw_address) == 0 || strcmp(host, config->gw_ip) == 0 || strcmp(host, config->gw_fqdn) == 0) {
			return send_error(connection, 511);
		}
	}

	// Check for preauthdir
	if (check_authdir_match(url, config->preauthdir)) {

		debug(LOG_DEBUG, "preauthdir url detected: %s", url);
		query = safe_calloc(QUERYMAXLEN);

		if (!query) {
			ret = send_error(connection, 503);
			free(query);
			return ret;
		}

		get_query(connection, &query, QUERYSEPARATOR);
		debug(LOG_DEBUG, "preauthenticated: show_preauthpage [%s]", query);
		ret = show_preauthpage(connection, query);
		free(query);
		return ret;
	}

	// Check for denydir
	if (check_authdir_match(url, config->denydir)) {
		debug(LOG_DEBUG, "denydir url detected: %s", url);
		return send_error(connection, 511);
	}

	debug(LOG_DEBUG, "preauthenticated: Requested Host is [ %s ], url is [%s]", host, url);

	// check if this is a redirect query with a foreign host as target
	if (is_foreign_hosts(connection, host)) {
		debug(LOG_DEBUG, "preauthenticated: foreign host [%s] detected", host);
		return redirect_to_splashpage(connection, client, host, url);
	}

	// request is directed to us, check if client wants to be authenticated
	if (check_authdir_match(url, config->authdir)) {
		debug(LOG_DEBUG, "authdir url detected: %s", url);

		redirect_url = safe_calloc(REDIRECT_URL);

		redirect_url = MHD_lookup_connection_value(connection, MHD_GET_ARGUMENT_KIND, "redir");

		if (redirect_url == NULL) {
			return send_error(connection, 403);
		}

		if (!try_to_authenticate(connection, client, host, url)) {
			// user used an invalid token, redirect to splashpage but hold query "redir" intact
			originurl = safe_calloc(REDIRECT_URL_ENC_BUF);
			uh_urlencode(originurl, REDIRECT_URL_ENC_BUF, redirect_url, strlen(redirect_url));

			querystr = safe_calloc(QUERYMAXLEN);

			if (!querystr) {
				ret = send_error(connection, 503);
				free(originurl);
				free(querystr);
				return ret;
			}

			querystr = construct_querystring(connection, client, originurl, querystr);

			ret = encode_and_redirect_to_splashpage(connection, client, originurl, querystr);
			free(originurl);
			free(querystr);
			return ret;
		}

		ret = authenticate_client(connection, redirect_url, client);
		return ret;
	}

	// no special handling left - try to serve static content to the user
	return serve_file(connection, client, url);
}
