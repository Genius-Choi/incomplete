static int http_websocketServer(lua_State *L) {
    if (config.serverMode) return 0;
    Computer * comp = get_comp(L);
    int port = luaL_checkinteger(L, 1);
    if (port < 0 || port > 65535) luaL_error(L, "bad argument #1 (port out of range)");
    if (comp->openWebsocketServers.find(port) != comp->openWebsocketServers.end()) {
        // if there's already an open server, reuse that
        lua_pushnil(L);
        lua_pushliteral(L, "Port already in use");
        return 2;
    }
    std::unordered_map<std::string, std::string> headers;
    if (lua_istable(L, 2)) {
        lua_pushvalue(L, 2);
        lua_pushnil(L);
        for (int i = 0; lua_next(L, -2); i++) {
            size_t keyn = 0, valn = 0;
            const char * key = lua_tolstring(L, -2, &keyn), *val = lua_tolstring(L, -1, &valn);
            if (key && val) headers[std::string(key, keyn)] = std::string(val, valn);
            lua_pop(L, 2);
        }
        lua_pop(L, 1);
    } else if (!lua_isnoneornil(L, 2)) luaL_error(L, "bad argument #2 (expected table, got %s)", lua_typename(L, lua_type(L, 2)));
    websocket_server::Factory * f = new websocket_server::Factory(comp, headers);
    try {f->srv = new HTTPServer(f, port);}
    catch (Poco::Exception& e) {
        fprintf(stderr, "Could not open server: %s\n", e.displayText().c_str());
        lua_pushnil(L);
        lua_pushstring(L, e.displayText().c_str());
        return 2;
    }
    comp->openWebsocketServers.insert(port);
    f->srv->start();
    lua_createtable(L, 0, 2);
    *(websocket_server::Factory**)lua_newuserdata(L, sizeof(websocket_server::Factory*)) = f;
    lua_createtable(L, 0, 1);
    lua_pushcfunction(L, websocket_server_free);
    lua_setfield(L, -2, "__gc");
    lua_setmetatable(L, -2);
    luaL_setfuncs(L, websocket_server_funcs, 1);
    return 1;
}
