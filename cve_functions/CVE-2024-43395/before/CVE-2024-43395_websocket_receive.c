static int websocket_receive(lua_State *L) {
    lastCFunction = __func__;
    ws_handle * ws = *(ws_handle**)lua_touserdata(L, lua_upvalueindex(1));
    int tm = 0;
    if (lua_getctx(L, &tm) == LUA_YIELD) {
        if (lua_isstring(L, 1)) {
            // haha, another string scoping issue :DDD
            // can M$ PLEASE fix this? (maybe I need to repro & report? :thinking:)
            if (ws == NULL) {
                lua_pushnil(L);
                return 1;
            }
            std::string * ev = new std::string(lua_tostring(L, 1));
            std::string * url = new std::string();
            int tmid = 0;
            if (lua_isnumber(L, 2)) tmid = lua_tointeger(L, 2);
            else if (lua_isstring(L, 2)) {
                delete url;
                url = new std::string(lua_tostring(L, 2));
            }
            if (*ev == "websocket_message" && !ws->isServer && *url == ws->url) {
                lua_pushvalue(L, 3);
                lua_pushvalue(L, 4);
                delete ev;
                delete url;
                return 2;
            } else if (*ev == "websocket_server_message" && ws->isServer && lua_touserdata(L, 2) == ws->clientID) {
                lua_pushvalue(L, 3);
                lua_pushvalue(L, 4);
                delete ev;
                delete url;
                return 2;
            } else if ((*ev == "websocket_closed" && !ws->isServer && *url == ws->url && ws->ws == NULL) ||
                       (*ev == "websocket_server_closed" && ws->isServer && lua_touserdata(L, 2) == ws->clientID && ws->ws == NULL) ||
                       (tm > 0 && *ev == "timer" && lua_isnumber(L, 2) && tmid == tm)) {
                lua_pushnil(L);
                delete ev;
                delete url;
                return 1;
            } else if (*ev == "terminate") {
                delete ev;
                delete url;
                return luaL_error(L, "Terminated");
            }
            delete ev;
            delete url;
        }
    } else {
        if (ws == NULL || ws->ws == NULL) luaL_error(L, "attempt to use a closed file");
        // instead of using native timer routines, we're using os.startTimer so we can be resumed
        if (!lua_isnoneornil(L, 1)) {
            luaL_checknumber(L, 1);
            lua_pushcfunction(L, os_startTimer);
            lua_pushvalue(L, 1);
            lua_call(L, 1, 1);
            tm = lua_tointeger(L, -1);
            lua_pop(L, 1);
        } else tm = -1;
    }
    lua_settop(L, 0);
    return lua_yieldk(L, 0, tm, websocket_receive);
}
