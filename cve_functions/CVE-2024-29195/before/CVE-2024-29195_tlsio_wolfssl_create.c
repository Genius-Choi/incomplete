CONCRETE_IO_HANDLE tlsio_wolfssl_create(void* io_create_parameters)
{
    TLS_IO_INSTANCE* result;

    if (io_create_parameters == NULL)
    {
        LogError("NULL io_create_parameters");
        result = NULL;
    }
    else
    {
        TLSIO_CONFIG* tls_io_config = io_create_parameters;

        result = (TLS_IO_INSTANCE*)malloc(sizeof(TLS_IO_INSTANCE));
        if (result == NULL)
        {
            LogError("Failed allocating memory for the TLS IO instance.");
        }
        else
        {
            (void)memset(result, 0, sizeof(TLS_IO_INSTANCE));
            result->tlsio_state = TLSIO_STATE_NOT_OPEN;

            result->ssl_context = wolfSSL_CTX_new(wolfTLSv1_2_client_method());
            if (result->ssl_context == NULL)
            {
                LogError("Cannot create the wolfSSL context");
                free(result);
                result = NULL;
            }
            else if (mallocAndStrcpy_s(&result->hostname, tls_io_config->hostname) != 0)
            {
                LogError("Failed copying the target hostname.");
                free(result);
                result = NULL;
            }
            else
            {
                // Set the recv and send function on the wolfssl context object
                wolfSSL_SetIOSend(result->ssl_context, on_io_send);
                wolfSSL_SetIORecv(result->ssl_context, on_io_recv);

                SOCKETIO_CONFIG socketio_config;
                const IO_INTERFACE_DESCRIPTION* underlying_io_interface;
                void* io_interface_parameters;

                if (tls_io_config->underlying_io_interface != NULL)
                {
                    underlying_io_interface = tls_io_config->underlying_io_interface;
                    io_interface_parameters = tls_io_config->underlying_io_parameters;
                }
                else
                {
                    socketio_config.hostname = tls_io_config->hostname;
                    socketio_config.port = tls_io_config->port;
                    socketio_config.accepted_socket = NULL;

                    underlying_io_interface = socketio_get_interface_description();
                    io_interface_parameters = &socketio_config;
                }

                if (underlying_io_interface == NULL)
                {
                    LogError("Failed getting socket IO interface description.");
                    wolfSSL_CTX_free(result->ssl_context);
                    free(result->hostname);
                    free(result);
                    result = NULL;
                }
                else
                {
                    result->socket_io = xio_create(underlying_io_interface, io_interface_parameters);
                    if (result->socket_io == NULL)
                    {
                        LogError("Failure connecting to underlying socket_io");
                        wolfSSL_CTX_free(result->ssl_context);
                        free(result->hostname);
                        free(result);
                        result = NULL;
                    }
                    else if (create_wolfssl_instance(result) != 0)
                    {
                        LogError("Failure connecting to underlying socket_io");
                        wolfSSL_CTX_free(result->ssl_context);
                        free(result->hostname);
                        free(result);
                        result = NULL;
                    }
                }
            }
        }
    }

    return result;
}
