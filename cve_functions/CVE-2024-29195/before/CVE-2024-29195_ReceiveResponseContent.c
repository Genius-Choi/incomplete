static HTTPAPI_RESULT ReceiveResponseContent(HINTERNET requestHandle, BUFFER_HANDLE responseContent)
{
    HTTPAPI_RESULT result;
    DWORD responseBytesAvailable;

    while (true)
    {
        /*from MSDN: If no data is available and the end of the file has not been reached, one of two things happens. If the session is synchronous, the request waits until data becomes available.*/
        if (!WinHttpQueryDataAvailable(requestHandle, &responseBytesAvailable))
        {
            result = HTTPAPI_QUERY_DATA_AVAILABLE_FAILED;
            LogErrorWinHTTPWithGetLastErrorAsString("WinHttpQueryDataAvailable failed (result = %" PRI_MU_ENUM ").", MU_ENUM_VALUE(HTTPAPI_RESULT, result));
            break;
        }
        else if (responseBytesAvailable == 0)
        {
            /*end of the stream, go out*/
            result = HTTPAPI_OK;
            break;
        }
        else if (BUFFER_enlarge(responseContent, responseBytesAvailable) != 0)
        {
            result = HTTPAPI_ALLOC_FAILED;
            LogError("(result = %" PRI_MU_ENUM ")", MU_ENUM_VALUE(HTTPAPI_RESULT, result));
            break;
        }
        else
        {
            /*Add the read bytes to the response buffer*/
            size_t bufferSize;
            const unsigned char* bufferContent;

            if (BUFFER_content(responseContent, &bufferContent) != 0)
            {
                result = HTTPAPI_ERROR;
                LogError("(result = %" PRI_MU_ENUM ")", MU_ENUM_VALUE(HTTPAPI_RESULT, result));
                break;
            }
            else if (BUFFER_size(responseContent, &bufferSize) != 0)
            {
                result = HTTPAPI_ERROR;
                LogError("(result = %" PRI_MU_ENUM ")", MU_ENUM_VALUE(HTTPAPI_RESULT, result));
                break;
            }
            else
            {
                DWORD bytesReceived;
                if (!WinHttpReadData(requestHandle, (LPVOID)(bufferContent + bufferSize - responseBytesAvailable), responseBytesAvailable, &bytesReceived))
                {
                    result = HTTPAPI_READ_DATA_FAILED;
                    LogErrorWinHTTPWithGetLastErrorAsString("WinHttpReadData failed (result = %" PRI_MU_ENUM ")", MU_ENUM_VALUE(HTTPAPI_RESULT, result));
                    break;
                }
                /*if for some reason bytesReceived is zero If you are using WinHttpReadData synchronously, and the return value is TRUE and the number of bytes read is zero, the transfer has been completed and there are no more bytes to read on the handle.*/
                else if (bytesReceived == 0)
                {
                    /*end of everything, but this looks like an error still, or a non-conformance between WinHttpQueryDataAvailable and WinHttpReadData*/
                    result = HTTPAPI_READ_DATA_FAILED;
                    LogError("bytesReceived was unexpectedly zero (result = %" PRI_MU_ENUM ")", MU_ENUM_VALUE(HTTPAPI_RESULT, result));
                    break;
                }
                else
                {
                    /*all is fine, keep going*/
                }
            }
        }
    } 

    return result;
}
