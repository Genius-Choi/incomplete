int tlsio_mbedtls_send(CONCRETE_IO_HANDLE tls_io, const void *buffer, size_t size, ON_SEND_COMPLETE on_send_complete_callback, void *callback_context)
{
    int result = 0;

    if (tls_io == NULL || (buffer == NULL) || (size == 0))
    {
        LogError("Invalid parameter specified tls_io: %p, buffer: %p, size: %ul", tls_io, buffer, (unsigned int)size);
        result = MU_FAILURE;
    }
    else
    {
        TLS_IO_INSTANCE *tls_io_instance = (TLS_IO_INSTANCE *)tls_io;
        if (tls_io_instance->tlsio_state != TLSIO_STATE_OPEN)
        {
            LogError("Invalid state specified %d", tls_io_instance->tlsio_state);
            result = MU_FAILURE;
        }
        else
        {
            tls_io_instance->send_complete_info.on_send_complete = on_send_complete_callback;
            tls_io_instance->send_complete_info.on_send_complete_callback_context = callback_context;
            tls_io_instance->send_complete_info.last_fragmented_req_status = IO_SEND_OK;
            int out_left = (int)size;
            result = 0;

            do
            {
                tls_io_instance->send_complete_info.is_fragmented_req = is_fragmented_send_request(tls_io_instance, out_left);
                unsigned char *buf = (unsigned char *)buffer + size - out_left;
                int ret = mbedtls_ssl_write(&tls_io_instance->ssl, buf, out_left);

                if (ret < 0)
                {
                    LogError("Unexpected data size returned from  mbedtls_ssl_write %d/%d", ret, (int)size);
                    result = MU_FAILURE;
                    break;
                }
                else if (tls_io_instance->send_complete_info.last_fragmented_req_status != IO_SEND_OK)
                {
                    LogError("Failed to send last fragment with error:0x%0x, aborting whole send",
                             tls_io_instance->send_complete_info.last_fragmented_req_status);
                    result = MU_FAILURE;
                    break;
                }

                out_left -= ret;
            } while (out_left > 0);

            // remove on send complete info
            memset((void*)&tls_io_instance->send_complete_info, 0, sizeof(tls_io_instance->send_complete_info));
        }
    }

    return result;
}
