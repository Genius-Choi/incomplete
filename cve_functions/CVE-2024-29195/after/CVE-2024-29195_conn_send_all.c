static HTTPAPI_RESULT conn_send_all(HTTP_HANDLE_DATA* http_instance, const unsigned char* buf, size_t bufLen)
{
    HTTPAPI_RESULT result;

    http_instance->send_completed = 0;
    http_instance->is_io_error = 0;
    if (xio_send(http_instance->xio_handle, buf, bufLen, on_send_complete, http_instance) != 0)
    {
        /*Codes_SRS_HTTPAPI_COMPACT_21_028: [ If the HTTPAPI_ExecuteRequest cannot send the request header, it shall return HTTPAPI_HTTP_HEADERS_FAILED. ]*/
        result = HTTPAPI_SEND_REQUEST_FAILED;
    }
    else
    {
        /*Codes_SRS_HTTPAPI_COMPACT_21_079: [ The HTTPAPI_ExecuteRequest shall wait, at least, 20 seconds to send a buffer using the SSL connection. ]*/
        int countRetry = MAX_SEND_RETRY;
        /*Codes_SRS_HTTPAPI_COMPACT_21_033: [ If the whole process succeed, the HTTPAPI_ExecuteRequest shall retur HTTPAPI_OK. ]*/
        result = HTTPAPI_OK;
        while ((http_instance->send_completed == 0) && (result == HTTPAPI_OK))
        {
            xio_dowork(http_instance->xio_handle);
            if (http_instance->is_io_error != 0)
            {
                /*Codes_SRS_HTTPAPI_COMPACT_21_028: [ If the HTTPAPI_ExecuteRequest cannot send the request header, it shall return HTTPAPI_HTTP_HEADERS_FAILED. ]*/
                result = HTTPAPI_SEND_REQUEST_FAILED;
            }
            else if ((countRetry--) <= 0)
            {
                /*Codes_SRS_HTTPAPI_COMPACT_21_080: [ If the HTTPAPI_ExecuteRequest retries to send the message for 20 seconds without success, it shall fail and return HTTPAPI_SEND_REQUEST_FAILED. ]*/
                LogError("Send timeout. The HTTP request is incomplete");
                /*Codes_SRS_HTTPAPI_COMPACT_21_028: [ If the HTTPAPI_ExecuteRequest cannot send the request header, it shall return HTTPAPI_HTTP_HEADERS_FAILED. ]*/
                result = HTTPAPI_SEND_REQUEST_FAILED;
            }
            else
            {
                /*Codes_SRS_HTTPAPI_COMPACT_21_083: [ The HTTPAPI_ExecuteRequest shall wait, at least, 100 milliseconds between retries. ]*/
                ThreadAPI_Sleep(RETRY_INTERVAL_IN_MS);
            }
        }
    }

    return result;
}
