  return runLight("proc_open", [&] (LightProcess* proc) -> pid_t {
      auto fout = proc->m_afdt_fd;
      lwp_write(fout, "proc_open", cmd, cwd ? cwd : "",
                env, desired);

      bool error_send = false;
      int save_errno = 0;
      for (auto cfd : created) {
        if (!send_fd(proc->m_afdt_fd, cfd)) {
          error_send = true;
          save_errno = errno;
          break;
        }
      }

      std::string buf;
      auto fin = proc->m_afdt_fd;
      lwp_read(fin, buf);
      if (buf == "error") {
        lwp_read(fin, errno);
        if (error_send) {
          // On this error, the receiver side returns dummy errno,
          // use the sender side errno here.
          errno = save_errno;
        }
        return -1;
      }
      always_assert_flog(buf == "success",
                         "Unexpected message from light process: `{}'", buf);
      pid_t pid = -1;
      lwp_read(fin, pid);
      always_assert(pid);
      return pid;
    }, static_cast<pid_t>(-1));
