static void get_attributes(Array &ret, LDAP *ldap,
                           LDAPMessage *ldap_result_entry, bool to_lower) {
  int num_attrib = 0;
  BerElement *ber;
  char *attribute = ldap_first_attribute(ldap, ldap_result_entry, &ber);

  while (attribute != nullptr) {
    struct berval **ldap_value =
      ldap_get_values_len(ldap, ldap_result_entry, attribute);
    int num_values = ldap_count_values_len(ldap_value);

    Array tmp;
    tmp.set(s_count, num_values);
    for (int i = 0; i < num_values; i++) {
      auto const val = ldap_value[i];
      tmp.set(i, String(val->bv_val, val->bv_len, CopyString));
    }
    ldap_value_free_len(ldap_value);

    String sAttribute = to_lower ? String(toLower(attribute))
                                 : String(attribute, CopyString);
    ret.set(sAttribute, tmp);
    ret.set(num_attrib, sAttribute);

    num_attrib++;
    ldap_memfree(attribute);
    attribute = ldap_next_attribute(ldap, ldap_result_entry, ber);
  }

  if (ber != nullptr) {
    ber_free(ber, 0);
  }

  ret.set(s_count, num_attrib);
}
