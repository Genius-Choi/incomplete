FILE *LightProcess::HeavyPopenImpl(const char *cmd, const char *type,
                                   const char *cwd) {
  int fd = -1;
  pid_t pid;
  Lock lock(s_mutex);
  if (cwd && *cwd) {
    auto old_cwd = Process::GetCurrentDirectory();
    if (old_cwd != cwd) {
      if (chdir(cwd)) {
        Logger::Warning("Failed to chdir to %s.", cwd);
      }
      fd = popen_impl(cmd, type, &pid);
      if (chdir(old_cwd.c_str())) {
        // error occurred changing cwd back
      }
      if (fd < 0) return nullptr;
    }
  }
  if (fd < 0) {
    fd = popen_impl(cmd, type, &pid);
  }
  if (fd < 0) return nullptr;
  auto f = fdopen(fd, type);
  if (f) {
    s_popenMap[f] = pid;
  }
  return f;
}
