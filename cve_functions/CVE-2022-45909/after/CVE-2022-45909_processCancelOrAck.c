    int SipDialogController::processCancelOrAck( nta_incoming_magic_t* p, nta_incoming_t* irq, sip_t const *sip ) {
        std::shared_ptr<IIP> iip ;
        if( !sip ) {
            DR_LOG(log_debug) << "SipDialogController::processCancel with null sip pointer; irq " << 
                hex << (void*) irq << ", most probably timerH indicating end of final response retransmissions" ;
            //nta_incoming_destroy(irq);
            std::shared_ptr<IIP> iip ;
            if (!IIP_FindByIrq(m_invitesInProgress, irq, iip)) {
                DR_LOG(log_error) << "Unable to find invite-in-progress for irq " << hex << (void*) irq;
            }
            else {
                DR_LOG(log_debug) << "SipDialogController::processCancelOrAck - clearing IIP for leg " << hex << (void*) iip->leg();   ;
                IIP_Clear(m_invitesInProgress, iip);
            }
            return -1 ;
        }
        DR_LOG(log_debug) << "SipDialogController::processCancelOrAck: " << sip->sip_request->rq_method_name  ;
        string transactionId ;
        generateUuid( transactionId ) ;

        if( sip->sip_request->rq_method == sip_method_cancel ) {
            if (!IIP_FindByIrq(m_invitesInProgress, irq, iip)) {
                DR_LOG(log_error) << "Unable to find invite-in-progress for CANCEL with call-id " << sip->sip_call_id->i_id  ;
                return 0 ;
            }
            std::shared_ptr<SipDialog> dlg = iip->dlg() ;

            if( !dlg ) {
                DR_LOG(log_error) << "No dialog exists for invite-in-progress for CANCEL with call-id " << sip->sip_call_id->i_id  ;
                return 0 ;
            }

            DR_LOG(log_debug) << "SipDialogController::processCancelOrAck - Received CANCEL for call-id " << sip->sip_call_id->i_id << ", sending to client"  ;

            string encodedMessage ;
            msg_t* msg = nta_incoming_getrequest( irq ) ;   // adds a reference
            EncodeStackMessage( sip, encodedMessage ) ;
            SipMsgData_t meta( msg, irq ) ;
            Cdr::postCdr( std::make_shared<CdrStop>( msg, "network", Cdr::call_canceled ) );
            msg_destroy(msg);                               // releases reference

            m_pClientController->route_request_inside_invite( encodedMessage, meta, irq, sip, iip->getTransactionId(), dlg->getDialogId() ) ;
            
            //TODO: sofia has already sent 200 OK to cancel and 487 to INVITE.  Do we need to keep this irq around?
            //addIncomingRequestTransaction( irq, transactionId) ;

            DR_LOG(log_debug) << "SipDialogController::processCancelOrAck - clearing IIP "   ;
            IIP_Clear(m_invitesInProgress, iip);
            DR_LOG(log_debug) << "SipDialogController::processCancelOrAck - done clearing IIP "   ;

        }
        else if( sip->sip_request->rq_method == sip_method_ack ) {
            if (!IIP_FindByIrq(m_invitesInProgress, irq, iip)) {
                DR_LOG(log_error) << "Unable to find invite-in-progress for ACK with call-id " << sip->sip_call_id->i_id  ;
                return 0 ;
            }
            std::shared_ptr<SipDialog> dlg = iip->dlg(); 
            IIP_Clear(m_invitesInProgress, iip);
            this->clearSipTimers(dlg);

            string transactionId ;
            generateUuid( transactionId ) ;

            string encodedMessage ;
            msg_t* msg = nta_incoming_getrequest( irq ) ;  // adds a reference
            EncodeStackMessage( sip, encodedMessage ) ;
            SipMsgData_t meta( msg, irq ) ;
            msg_destroy( msg ) ;    //release the reference

            m_pController->getClientController()->route_ack_request_inside_dialog( encodedMessage, meta, irq, sip, transactionId, dlg->getTransactionId(), dlg->getDialogId() ) ;   
            
            //NB: when we get a CANCEL sofia sends the 487 response to the INVITE itself, so our latest sip status will be a provisional
            //not sure that we need to do anything particular about that however....though it we write cdrs we would want to capture the 487 final response
        
            //another issue is that on any non-success response sent to an incoming INVITE the subsequent ACK is not sent to the client
            //because there is no dialog created and thus no routing available.  Should fix this.
        }
        else {
            DR_LOG(log_debug) << "Received " << sip->sip_request->rq_method_name << " for call-id " << sip->sip_call_id->i_id << ", discarding"  ;
        }
        return 0 ;
    }
