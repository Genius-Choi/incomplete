    void SipDialogController::notifyTerminateStaleDialog( std::shared_ptr<SipDialog> dlg, bool ackbye ) {
        nta_leg_t* leg = const_cast<nta_leg_t *>(dlg->getNtaLeg()) ;
        const char* reason = ackbye ? "SIP ;cause=200 ;text=\"ACK-BYE due to cancel race condition\"" : "SIP ;cause=200 ;text=\"Session timer expired\"";
        if( leg ) {
            nta_outgoing_t* orq = nta_outgoing_tcreate( leg, NULL, NULL,
                                            NULL,
                                            SIP_METHOD_BYE,
                                            NULL,
                                            SIPTAG_REASON_STR(reason),
                                            TAG_END() ) ;
            msg_t* m = nta_outgoing_getrequest(orq) ;    // adds a reference
            sip_t* sip = sip_object( m ) ;

            DR_LOG(log_info) << "SipDialogController::notifyTerminateStaleDialog - created orq " << std::hex << (void *) orq;

            string byeTransactionId  = "unsolicited";

            string encodedMessage ;
            EncodeStackMessage( sip, encodedMessage ) ;
            SipMsgData_t meta(m, orq) ;
            string s ;
            meta.toMessageFormat(s) ;
            string data = s + "|" + byeTransactionId + "|Msg sent:|" + DR_CRLF + encodedMessage ;
            msg_destroy(m) ;    // releases reference::process

            // this is slightly inaccurate: we are telling the app we received a BYE when we are in fact generating it
            // the impact is minimal though, and currently there is no message type to inform the app we generated a BYE on our own
            bool routed = m_pController->getClientController()->route_request_inside_dialog( encodedMessage, meta, sip, byeTransactionId, dlg->getDialogId() ) ;

            Cdr::postCdr( std::make_shared<CdrStop>( m, "application", ackbye ? Cdr::ackbye : Cdr::session_expired ) );
            nta_outgoing_destroy(orq) ;

            STATS_COUNTER_INCREMENT(STATS_COUNTER_SIP_REQUESTS_OUT, {{"method", "BYE"}})
        }
        SD_Clear(m_dialogs, dlg) ;
    }
