int uwsgi_wait_for_fs(char *filename, int type) {
	if (!uwsgi.wait_for_fs_timeout) {
        	uwsgi.wait_for_fs_timeout = 60;
        }
        uwsgi_log("waiting for %s (max %d seconds) ...\n", filename, uwsgi.wait_for_fs_timeout);
        int counter = 0;
        for (;;) {
        	if (counter > uwsgi.wait_for_fs_timeout) {
                	uwsgi_log("%s unavailable after %d seconds\n", filename, counter);
			return -1;
                }
		struct stat st;
		if (stat(filename, &st)) goto retry;
		if (type == 1 && !S_ISREG(st.st_mode)) goto retry;
		if (type == 2 && !S_ISDIR(st.st_mode)) goto retry;
                uwsgi_log_verbose("%s found\n", filename);
		return 0;
retry:
                sleep(1);
                counter++;
	}
	return -1;
}
