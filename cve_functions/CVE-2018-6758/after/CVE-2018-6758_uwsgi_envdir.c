void uwsgi_envdir(char *edir) {
	DIR *d = opendir(edir);
	if (!d) {
		uwsgi_error("[uwsgi-envdir] opendir()");
		exit(1);
	}
	struct dirent *de;
	while ((de = readdir(d)) != NULL) {
		// skip hidden files
		if (de->d_name[0] == '.')
			continue;
		struct stat st;
		char *filename = uwsgi_concat3(edir, "/", de->d_name);
		if (stat(filename, &st)) {
			uwsgi_log("[uwsgi-envdir] error stating %s\n", filename);
			uwsgi_error("[uwsgi-envdir] stat()");
			exit(1);
		}

		if (!S_ISREG(st.st_mode)) {
			free(filename);
			continue;
		}

		// unsetenv
		if (st.st_size == 0) {
#ifdef UNSETENV_VOID
			unsetenv(de->d_name);
#else
			if (unsetenv(de->d_name)) {
				uwsgi_log("[uwsgi-envdir] unable to unset %s\n", de->d_name);
				uwsgi_error("[uwsgi-envdir] unsetenv");
				exit(1);
			}
#endif
			free(filename);
			continue;
		}

		// read the content of the file
		size_t size = 0;
		char *content = uwsgi_open_and_read(filename, &size, 1, NULL);
		if (!content) {
			uwsgi_log("[uwsgi-envdir] unable to open %s\n", filename);
			uwsgi_error_open(filename);
			exit(1);
		}
		free(filename);

		// HACK, envdir states we only need to strip the end of the string ....
		uwsgi_chomp2(content);
		// ... and substitute 0 with \n
		size_t slen = strlen(content);
		size_t i;
		for (i = 0; i < slen; i++) {
			if (content[i] == 0) {
				content[i] = '\n';
			}
		}

		if (setenv(de->d_name, content, 1)) {
			uwsgi_log("[uwsgi-envdir] unable to set %s\n", de->d_name);
			uwsgi_error("[uwsgi-envdir] setenv");
			exit(1);
		}

		free(content);
	}
	closedir(d);
}
