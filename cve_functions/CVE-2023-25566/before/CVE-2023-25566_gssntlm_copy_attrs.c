int gssntlm_copy_attrs(const struct gssntlm_name_attribute *src,
                       struct gssntlm_name_attribute **dst)
{
    struct gssntlm_name_attribute *copied_attrs;
    size_t attrs_count = gssntlm_get_attrs_count(src);

    *dst = NULL;
    if (attrs_count == 0) {
        return 0;
    }

    copied_attrs = calloc(attrs_count + 1, /* +1 for terminator entry */
                          sizeof(struct gssntlm_name_attribute));
    if (copied_attrs == NULL) {
        return ENOMEM;
    }

    for (size_t i = 0; i < attrs_count; i++) {
        copied_attrs[i].attr_name = strdup(src[i].attr_name);
        if (copied_attrs[i].attr_name == NULL) {
            gssntlm_release_attrs(&copied_attrs);
            return ENOMEM;
        }
        copied_attrs[i].attr_value.length = src[i].attr_value.length;
        copied_attrs[i].attr_value.value = malloc(src[i].attr_value.length);
        if (copied_attrs[i].attr_value.value == NULL) {
            gssntlm_release_attrs(&copied_attrs);
            return ENOMEM;
        }
        memcpy(copied_attrs[i].attr_value.value, src[i].attr_value.value,
               src[i].attr_value.length);
    }
    /* terminator entry is filled with zeroes by calloc */

    *dst = copied_attrs;
    return 0;
}
