int sss_unique_file_ex(TALLOC_CTX *owner,
                       char *path_tmpl,
                       mode_t file_umask,
                       errno_t *_err)
{
    size_t tmpl_len;
    errno_t ret;
    int fd = -1;
    mode_t old_umask;
    struct tmpfile_watch *tw = NULL;

    tmpl_len = strlen(path_tmpl);
    if (tmpl_len < 6 || strcmp(path_tmpl + (tmpl_len - 6), "XXXXXX") != 0) {
        DEBUG(SSSDBG_OP_FAILURE,
              "Template too short or doesn't end with XXXXXX!\n");
        ret = EINVAL;
        goto done;
    }

    old_umask = umask(file_umask);
    fd = mkstemp(path_tmpl);
    umask(old_umask);
    if (fd == -1) {
        ret = errno;
        DEBUG(SSSDBG_OP_FAILURE,
              "mkstemp(\"%s\") failed [%d]: %s!\n",
              path_tmpl, ret, strerror(ret));
        goto done;
    }

    if (owner != NULL) {
        tw = tmpfile_watch_set(owner, path_tmpl);
        if (tw == NULL) {
            unlink_dbg(path_tmpl);
            ret = ENOMEM;
            goto done;
        }
    }

    ret = EOK;
done:
    if (_err) {
        *_err = ret;
    }
    return fd;
}
