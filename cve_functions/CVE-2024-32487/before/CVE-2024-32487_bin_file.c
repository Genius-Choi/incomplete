public int bin_file(int f, ssize_t *n)
{
	int bin_count = 0;
	char data[256];
	constant char* p;
	constant char* edata;

	if (!seekable(f))
		return (0);
	if (less_lseek(f, (less_off_t)0, SEEK_SET) == BAD_LSEEK)
		return (0);
	*n = read(f, data, sizeof(data));
	if (*n <= 0)
		return (0);
	edata = &data[*n];
	for (p = data;  p < edata;  )
	{
		if (utf_mode && !is_utf8_well_formed(p, (int) ptr_diff(edata,p)))
		{
			bin_count++;
			utf_skip_to_lead(&p, edata);
		} else 
		{
			LWCHAR c = step_charc(&p, +1, edata);
			struct ansi_state *pansi;
			if (ctldisp == OPT_ONPLUS && (pansi = ansi_start(c)) != NULL)
			{
				skip_ansi(pansi, &p, edata);
				ansi_done(pansi);
			} else if (binary_char(c))
				bin_count++;
		}
	}
	/*
	 * Call it a binary file if there are more than 5 binary characters
	 * in the first 256 bytes of the file.
	 */
	return (bin_count > 5);
}
