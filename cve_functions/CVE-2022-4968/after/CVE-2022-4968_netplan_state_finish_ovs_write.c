netplan_state_finish_ovs_write(const NetplanState* np_state, const char* rootdir, GError** error)
{
    const NetplanOVSSettings* settings = &np_state->ovs_settings;
    GString* cmds = g_string_new(NULL);

    /* Global external-ids and other-config settings */
    if (settings->external_ids && g_hash_table_size(settings->external_ids) > 0)
        write_ovs_additional_data(settings->external_ids, "open_vswitch",
                                  ".", cmds, "external-ids");

    if (settings->other_config && g_hash_table_size(settings->other_config) > 0)
        write_ovs_additional_data(settings->other_config, "open_vswitch",
                                  ".", cmds, "other-config");

    if (settings->ssl.client_key && settings->ssl.client_certificate &&
        settings->ssl.ca_certificate) {
        GString* value = g_string_new(NULL);
        g_string_printf(value, "%s %s %s",
                        settings->ssl.client_key,
                        settings->ssl.client_certificate,
                        settings->ssl.ca_certificate);
        append_systemd_cmd(cmds, OPENVSWITCH_OVS_VSCTL " set-ssl %s", value->str);
        write_ovs_tag_setting(".", "open_vswitch", "global", "set-ssl", value->str, cmds);
        g_string_free(value, TRUE);
    }

    gboolean ret = TRUE;
    if (cmds->len > 0)
        ret = write_ovs_systemd_unit("global", cmds, rootdir, FALSE, FALSE, NULL, error);
    g_string_free(cmds, TRUE);
    if (!ret)
        return FALSE; // LCOV_EXCL_LINE

    /* Clear all netplan=true tagged ports/bonds and bridges, via 'netplan apply --only-ovs-cleanup' */
    cmds = g_string_new(NULL);
    append_systemd_cmd(cmds, SBINDIR "/netplan apply %s", "--only-ovs-cleanup");
    ret = write_ovs_systemd_unit("cleanup", cmds, rootdir, FALSE, TRUE, NULL, error);
    g_string_free(cmds, TRUE);
    return ret;
}
