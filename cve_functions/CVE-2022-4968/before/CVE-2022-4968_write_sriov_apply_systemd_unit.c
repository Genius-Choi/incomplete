write_sriov_apply_systemd_unit(GHashTable* pfs, const char* rootdir, GError** error)
{
    g_autofree gchar* id_escaped = NULL;
    g_autofree char* link = g_strjoin(NULL, rootdir ?: "", "/run/systemd/system/multi-user.target.wants/netplan-sriov-apply.service", NULL);
    g_autofree char* path = g_strjoin(NULL, "/run/systemd/system/netplan-sriov-apply.service", NULL);
    GHashTableIter iter;
    gpointer key;

    GString* s = g_string_new("[Unit]\n");
    g_string_append(s, "Description=Apply SR-IOV configuration\n");
    g_string_append(s, "DefaultDependencies=no\n");
    g_string_append(s, "Before=network-pre.target\n");

    g_hash_table_iter_init(&iter, pfs);
    while (g_hash_table_iter_next (&iter, &key, NULL)) {
        g_string_append_printf(s, "After=sys-subsystem-net-devices-%s.device\n", (gchar*) key);
    }

    g_string_append(s, "\n[Service]\nType=oneshot\n");
    g_string_append_printf(s, "ExecStart=" SBINDIR "/netplan apply --sriov-only\n");

    _netplan_g_string_free_to_file(s, rootdir, path, NULL);

    _netplan_safe_mkdir_p_dir(link);
    if (symlink(path, link) < 0 && errno != EEXIST) {
        // LCOV_EXCL_START
        g_set_error(error, G_MARKUP_ERROR, G_MARKUP_ERROR_INVALID_CONTENT,
                    "failed to create enablement symlink: %m");
        return FALSE;
        // LCOV_EXCL_STOP
    }
    return TRUE;
}
