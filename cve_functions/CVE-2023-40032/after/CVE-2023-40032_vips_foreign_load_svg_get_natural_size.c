vips_foreign_load_svg_get_natural_size( VipsForeignLoadSvg *svg, 
	double *out_width, double *out_height )
{
	VipsObjectClass *class = VIPS_OBJECT_GET_CLASS( svg );

	double width;
	double height;

#if LIBRSVG_CHECK_VERSION( 2, 52, 0 )

	if( !rsvg_handle_get_intrinsic_size_in_pixels( svg->page, 
		&width, &height ) ) {
		RsvgRectangle viewbox;

		/* Try the intrinsic dimensions first.
		 */
		gboolean has_width, has_height;
		RsvgLength iwidth, iheight;
		gboolean has_viewbox;

		rsvg_handle_get_intrinsic_dimensions( svg->page,
			&has_width, &iwidth,
			&has_height, &iheight,
			&has_viewbox, &viewbox );

#if LIBRSVG_CHECK_VERSION( 2, 54, 0 )
		/* After librsvg 2.54.0, the `has_width` and `has_height` 
		 * arguments always returns `TRUE`, since with SVG2 all 
		 * documents *have* a default width and height of `100%`.
		 */
		width = svg_css_length_to_pixels( iwidth, svg->dpi );
		height = svg_css_length_to_pixels( iheight, svg->dpi );

		has_width = width > 0.0;
		has_height = height > 0.0;

		if( has_width && has_height ) {
			/* Success! Taking the viewbox into account is not 
			 * needed.
			 */
		}
		else if( has_width && has_viewbox ) {
			height = width * viewbox.height / viewbox.width;
		}
		else if( has_height && has_viewbox ) {
			width = height * viewbox.width / viewbox.height;
		}
		else if( has_viewbox ) {
			width = viewbox.width;
			height = viewbox.height;
		}
#else /*!LIBRSVG_CHECK_VERSION( 2, 54, 0 )*/
		if( has_width && has_height ) {
			/* We can use these values directly.
			 */
			width = svg_css_length_to_pixels( iwidth, svg->dpi );
			height = svg_css_length_to_pixels( iheight, svg->dpi );
		}
		else if( has_width && has_viewbox ) {
			width = svg_css_length_to_pixels( iwidth, svg->dpi );
			height = width * viewbox.height / viewbox.width;
		}
		else if( has_height && has_viewbox ) {
			height = svg_css_length_to_pixels( iheight, svg->dpi );
			width = height * viewbox.width / viewbox.height;
		}
		else if( has_viewbox ) {
			width = viewbox.width;
			height = viewbox.height;
		}
#endif /*!LIBRSVG_CHECK_VERSION( 2, 54, 0 )*/

		if( width <= 0.0 ||
			height <= 0.0 ) {
			/* We haven't found a usable set of sizes, so try 
			 * working out the visible area.
			 */
			rsvg_handle_get_geometry_for_element( svg->page, NULL,
				&viewbox, NULL, NULL );
			width = viewbox.x + viewbox.width;
			height = viewbox.y + viewbox.height;
		}
	}

#else /*!LIBRSVG_CHECK_VERSION( 2, 52, 0 )*/

{
	RsvgDimensionData dimensions;

	rsvg_handle_get_dimensions( svg->page, &dimensions );
	width = dimensions.width;
	height = dimensions.height;
}

#endif /*LIBRSVG_CHECK_VERSION( 2, 52, 0 )*/

	/* width or height below 0.5 can't be rounded to 1.
	 */
	if( width < 0.5 || 
		height < 0.5 ) {
		vips_error( class->nickname, "%s", _( "bad dimensions" ) );
		return( -1 );
	}

	*out_width = width;
	*out_height = height;

	return( 0 );
}
