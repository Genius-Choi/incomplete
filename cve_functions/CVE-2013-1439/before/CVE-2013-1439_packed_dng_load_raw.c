void CLASS packed_dng_load_raw()
{
  ushort *pixel, *rp;
  int row, col;

  pixel = (ushort *) calloc (raw_width * tiff_samples, sizeof *pixel);
  merror (pixel, "packed_dng_load_raw()");

#ifdef LIBRAW_LIBRARY_BUILD
  int dsz= raw_height*raw_width * tiff_samples * tiff_bps/8;
  LibRaw_byte_buffer *buf = NULL;
  if (tiff_bps != 16)
      {
          buf = ifp->make_byte_buffer(dsz);
      }
  LibRaw_bit_buffer bits;
#endif

  for (row=0; row < raw_height; row++) {
    if (tiff_bps == 16)
      read_shorts (pixel, raw_width * tiff_samples);
    else {
#ifdef LIBRAW_LIBRARY_BUILD
        bits.reset();
        for (col=0; col < raw_width * tiff_samples; col++)
            pixel[col] = bits._getbits(buf,tiff_bps,zero_after_ff);

#else
      getbits(-1);
      for (col=0; col < raw_width * tiff_samples; col++)
	pixel[col] = getbits(tiff_bps);
#endif
    }
#ifndef LIBRAW_LIBRARY_BUILD
    for (rp=pixel, col=0; col < raw_width; col++)
      adobe_copy_pixel (row, col, &rp);
#else
    if(raw_image)
      for (rp=pixel, col=0; col < raw_width; col++)
        adobe_copy_pixel_raw (row, col, &rp);
    else
      for (rp=pixel, col=0; col < raw_width; col++)
        adobe_copy_pixel_color (row, col, &rp);
#endif
  }
  free (pixel);
#ifdef LIBRAW_LIBRARY_BUILD
    if(buf)
        delete buf;
#endif
}
