ssize_t onion_response_vprintf(onion_response * res, const char *fmt,
                               va_list args) {
  char temp[512];
  va_list argz;
  int l;
  va_copy(argz, args);
  l = vsnprintf(temp, sizeof(temp), fmt, argz);
  va_end(argz);
  if (l < 0) {
    ONION_ERROR("Invalid vprintf fmt");
    return -1;
  } else if (l < sizeof(temp)) {
    return onion_response_write(res, temp, l);
  } else {
    ssize_t s;
    char *buf = onion_low_scalar_malloc(l + 1);
    if (!buf) {
      // this cannot happen, since onion_low_scalar_malloc
      // handles that error...
      ONION_ERROR("Could not reserve %d bytes", l + 1);
      return -1;
    }
    vsnprintf(buf, l + 1, fmt, args);
    s = onion_response_write(res, buf, l);
    onion_low_free(buf);
    return s;
  }
}
