fu_plugin_runner_verify(FuPlugin *self,
			FuDevice *device,
			FuProgress *progress,
			FuPluginVerifyFlags flags,
			GError **error)
{
	FuPluginVfuncs *vfuncs = fu_plugin_get_vfuncs(self);
	GPtrArray *checksums;
	g_autoptr(GError) error_local = NULL;

	g_return_val_if_fail(FU_IS_PLUGIN(self), FALSE);
	g_return_val_if_fail(FU_IS_DEVICE(device), FALSE);
	g_return_val_if_fail(FU_IS_PROGRESS(progress), FALSE);
	g_return_val_if_fail(error == NULL || *error == NULL, FALSE);

	/* not enabled */
	if (fu_plugin_has_flag(self, FWUPD_PLUGIN_FLAG_DISABLED))
		return TRUE;

	/* optional */
	if (vfuncs->verify == NULL) {
		if (!fu_device_has_flag(device, FWUPD_DEVICE_FLAG_CAN_VERIFY)) {
			g_set_error(error,
				    FWUPD_ERROR,
				    FWUPD_ERROR_NOT_SUPPORTED,
				    "device %s does not support verification",
				    fu_device_get_id(device));
			return FALSE;
		}
		return fu_plugin_device_read_firmware(self, device, progress, error);
	}

	/* clear any existing verification checksums */
	checksums = fu_device_get_checksums(device);
	g_ptr_array_set_size(checksums, 0);

	/* run additional detach */
	if (!fu_plugin_runner_device_generic_progress(
		self,
		device,
		progress,
		"fu_plugin_detach",
		vfuncs->detach != NULL ? vfuncs->detach : fu_plugin_device_detach,
		error))
		return FALSE;

	/* run vfunc */
	g_debug("verify(%s)", fu_plugin_get_name(self));
	if (!vfuncs->verify(self, device, progress, flags, &error_local)) {
		g_autoptr(GError) error_attach = NULL;
		if (error_local == NULL) {
			g_critical("unset plugin error in verify(%s)", fu_plugin_get_name(self));
			g_set_error_literal(&error_local,
					    FWUPD_ERROR,
					    FWUPD_ERROR_INTERNAL,
					    "unspecified error");
		}
		g_propagate_prefixed_error(error,
					   g_steal_pointer(&error_local),
					   "failed to verify using %s: ",
					   fu_plugin_get_name(self));
		/* make the device "work" again, but don't prefix the error */
		if (!fu_plugin_runner_device_generic_progress(
			self,
			device,
			progress,
			"fu_plugin_attach",
			vfuncs->attach != NULL ? vfuncs->attach : fu_plugin_device_attach,
			&error_attach)) {
			g_warning("failed to attach whilst aborting verify(): %s",
				  error_attach->message);
		}
		return FALSE;
	}

	/* run optional attach */
	if (!fu_plugin_runner_device_generic_progress(
		self,
		device,
		progress,
		"fu_plugin_attach",
		vfuncs->attach != NULL ? vfuncs->attach : fu_plugin_device_attach,
		error))
		return FALSE;

	/* success */
	return TRUE;
}
