fu_plugin_runner_device_array_generic(FuPlugin *self,
				      GPtrArray *devices,
				      const gchar *symbol_name,
				      FuPluginDeviceArrayFunc func,
				      GError **error)
{
	g_autoptr(GError) error_local = NULL;

	/* not enabled */
	if (fu_plugin_has_flag(self, FWUPD_PLUGIN_FLAG_DISABLED))
		return TRUE;

	/* optional */
	if (func == NULL)
		return TRUE;
	g_debug("%s(%s)", symbol_name + 10, fu_plugin_get_name(self));
	if (!func(self, devices, &error_local)) {
		if (error_local == NULL) {
			g_critical("unset plugin error in for %s(%s)",
				   fu_plugin_get_name(self),
				   symbol_name + 10);
			g_set_error_literal(&error_local,
					    FWUPD_ERROR,
					    FWUPD_ERROR_INTERNAL,
					    "unspecified error");
		}
		g_propagate_prefixed_error(error,
					   g_steal_pointer(&error_local),
					   "failed to %s using %s: ",
					   symbol_name + 10,
					   fu_plugin_get_name(self));
		return FALSE;
	}
	return TRUE;
}
