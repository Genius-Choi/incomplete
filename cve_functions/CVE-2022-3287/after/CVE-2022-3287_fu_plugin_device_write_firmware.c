fu_plugin_device_write_firmware(FuPlugin *self,
				FuDevice *device,
				GBytes *fw,
				FuProgress *progress,
				FwupdInstallFlags flags,
				GError **error)
{
	FuDevice *proxy = fu_device_get_proxy_with_fallback(device);
	g_autoptr(FuDeviceLocker) locker = NULL;
	locker = fu_device_locker_new(proxy, error);
	if (locker == NULL)
		return FALSE;

	/* back the old firmware up to /var/lib/fwupd */
	if (fu_device_has_flag(device, FWUPD_DEVICE_FLAG_BACKUP_BEFORE_INSTALL)) {
		g_autoptr(GBytes) fw_old = NULL;
		g_autofree gchar *path = NULL;
		g_autofree gchar *fn = NULL;
		g_autofree gchar *localstatedir = NULL;

		/* progress */
		fu_progress_set_id(progress, G_STRLOC);
		fu_progress_add_flag(progress, FU_PROGRESS_FLAG_NO_PROFILE);
		fu_progress_add_step(progress, FWUPD_STATUS_DEVICE_READ, 25, NULL);
		fu_progress_add_step(progress, FWUPD_STATUS_DEVICE_WRITE, 75, NULL);

		fw_old = fu_device_dump_firmware(device, fu_progress_get_child(progress), error);
		if (fw_old == NULL) {
			g_prefix_error(error, "failed to backup old firmware: ");
			return FALSE;
		}
		localstatedir = fu_path_from_kind(FU_PATH_KIND_LOCALSTATEDIR_PKG);
		fn = g_strdup_printf("%s.bin", fu_device_get_version(device));
		path = g_build_filename(
		    localstatedir,
		    "backup",
		    fu_device_get_id(device),
		    fu_device_get_serial(device) != NULL ? fu_device_get_serial(device) : "default",
		    fn,
		    NULL);
		fu_progress_step_done(progress);
		if (!fu_bytes_set_contents(path, fw_old, error))
			return FALSE;
		if (!fu_device_write_firmware(device,
					      fw,
					      fu_progress_get_child(progress),
					      flags,
					      error))
			return FALSE;
		fu_progress_step_done(progress);
		return TRUE;
	}

	return fu_device_write_firmware(device, fw, progress, flags, error);
}
