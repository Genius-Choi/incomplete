mg_exit_library(void)
{
	if (mg_init_library_called <= 0) {
		return 0;
	}

	mg_global_lock();

	mg_init_library_called--;
	if (mg_init_library_called == 0) {
#if defined(_WIN32)
		(void)WSACleanup();
#endif /* _WIN32  */
#if !defined(NO_SSL)
		if (mg_ssl_initialized) {
			uninitialize_ssl();
			mg_ssl_initialized = 0;
		}
#endif

#if defined(_WIN32)
		(void)DeleteCriticalSection(&global_log_file_lock);
#endif /* _WIN32 */
#if !defined(_WIN32)
		(void)pthread_mutexattr_destroy(&pthread_mutex_attr);
#endif

		(void)pthread_key_delete(sTlsKey);

#if defined(USE_LUA)
		lua_exit_optional_libraries();
#endif

		mg_global_unlock();
		(void)pthread_mutex_destroy(&global_lock_mutex);
		return 1;
	}

	mg_global_unlock();
	return 1;
}
