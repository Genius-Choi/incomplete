match_prefix(const char *pattern, size_t pattern_len, const char *str)
{
	const char *or_str;
	ptrdiff_t i, j, len, res;

	if ((or_str = (const char *)memchr(pattern, '|', pattern_len)) != NULL) {
		res = match_prefix(pattern, (size_t)(or_str - pattern), str);
		return (res > 0) ? res : match_prefix(or_str + 1,
		                                      (size_t)((pattern + pattern_len)
		                                               - (or_str + 1)),
		                                      str);
	}

	for (i = 0, j = 0; (i < (ptrdiff_t)pattern_len); i++, j++) {
		if ((pattern[i] == '?') && (str[j] != '\0')) {
			continue;
		} else if (pattern[i] == '$') {
			return (str[j] == '\0') ? j : -1;
		} else if (pattern[i] == '*') {
			i++;
			if (pattern[i] == '*') {
				i++;
				len = strlen(str + j);
			} else {
				len = strcspn(str + j, "/");
			}
			if (i == (ptrdiff_t)pattern_len) {
				return j + len;
			}
			do {
				res = match_prefix(pattern + i, pattern_len - i, str + j + len);
			} while (res == -1 && len-- > 0);
			return (res == -1) ? -1 : j + res + len;
		} else if (lowercase(&pattern[i]) != lowercase(&str[j])) {
			return -1;
		}
	}
	return (ptrdiff_t)j;
}
