mg_get_context_info_impl(const struct mg_context *ctx, char *buffer, int buflen)

{
	char block[256];
	int context_info_length = 0;

#if defined(_WIN32)
	const char *eol = "\r\n";
#else
	const char *eol = "\n";
#endif
	struct mg_memory_stat *ms = get_memory_stat((struct mg_context *)ctx);

	const char *eoobj = "}";
	int reserved_len = (int)strlen(eoobj) + (int)strlen(eol);

	if ((buffer == NULL) || (buflen < 1)) {
		buflen = 0;
	} else {
		*buffer = 0;
	}

	mg_snprintf(NULL, NULL, block, sizeof(block), "{%s", eol);
	context_info_length += (int)strlen(block);
	if (context_info_length < buflen) {
		strcat0(buffer, block);
	}

	if (ms) { /* <-- should be always true */
		/* Memory information */
		mg_snprintf(NULL,
		            NULL,
		            block,
		            sizeof(block),
		            "\"memory\" : {%s"
		            "\"blocks\" : %i,%s"
		            "\"used\" : %" INT64_FMT ",%s"
		            "\"maxUsed\" : %" INT64_FMT "%s"
		            "}%s%s",
		            eol,
		            ms->blockCount,
		            eol,
		            ms->totalMemUsed,
		            eol,
		            ms->maxMemUsed,
		            eol,
		            (ctx ? "," : ""),
		            eol);

		context_info_length += (int)strlen(block);
		if (context_info_length + reserved_len < buflen) {
			strcat0(buffer, block);
		}
	}

	if (ctx) {
		/* Declare all variables at begin of the block, to comply
		 * with old C standards. */
		char start_time_str[64] = {0};
		char now_str[64] = {0};
		time_t start_time = ctx->start_time;
		time_t now = time(NULL);

		/* Connections information */
		mg_snprintf(NULL,
		            NULL,
		            block,
		            sizeof(block),
		            "\"connections\" : {%s"
		            "\"active\" : %i,%s"
		            "\"maxActive\" : %i,%s"
		            "\"total\" : %" INT64_FMT "%s"
		            "},%s",
		            eol,
		            ctx->active_connections,
		            eol,
		            ctx->max_connections,
		            eol,
		            ctx->total_connections,
		            eol,
		            eol);

		context_info_length += (int)strlen(block);
		if (context_info_length + reserved_len < buflen) {
			strcat0(buffer, block);
		}

		/* Requests information */
		mg_snprintf(NULL,
		            NULL,
		            block,
		            sizeof(block),
		            "\"requests\" : {%s"
		            "\"total\" : %" INT64_FMT "%s"
		            "},%s",
		            eol,
		            ctx->total_requests,
		            eol,
		            eol);

		context_info_length += (int)strlen(block);
		if (context_info_length + reserved_len < buflen) {
			strcat0(buffer, block);
		}

		/* Data information */
		mg_snprintf(NULL,
		            NULL,
		            block,
		            sizeof(block),
		            "\"data\" : {%s"
		            "\"read\" : %" INT64_FMT "%s,"
		            "\"written\" : %" INT64_FMT "%s"
		            "},%s",
		            eol,
		            ctx->total_data_read,
		            eol,
		            ctx->total_data_written,
		            eol,
		            eol);

		context_info_length += (int)strlen(block);
		if (context_info_length + reserved_len < buflen) {
			strcat0(buffer, block);
		}

		/* Execution time information */
		gmt_time_string(start_time_str,
		                sizeof(start_time_str) - 1,
		                &start_time);
		gmt_time_string(now_str, sizeof(now_str) - 1, &now);

		mg_snprintf(NULL,
		            NULL,
		            block,
		            sizeof(block),
		            "\"time\" : {%s"
		            "\"uptime\" : %.0f,%s"
		            "\"start\" : \"%s\",%s"
		            "\"now\" : \"%s\"%s"
		            "}%s",
		            eol,
		            difftime(now, start_time),
		            eol,
		            start_time_str,
		            eol,
		            now_str,
		            eol,
		            eol);

		context_info_length += (int)strlen(block);
		if (context_info_length + reserved_len < buflen) {
			strcat0(buffer, block);
		}
	}

	/* Terminate string */
	if ((buflen > 0) && buffer && buffer[0]) {
		if (context_info_length < buflen) {
			strcat0(buffer, eoobj);
			strcat0(buffer, eol);
		}
	}
	context_info_length += reserved_len;

	return context_info_length;
}
