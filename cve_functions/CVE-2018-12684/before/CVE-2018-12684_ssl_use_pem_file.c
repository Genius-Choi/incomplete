ssl_use_pem_file(struct mg_context *phys_ctx,
                 struct mg_domain_context *dom_ctx,
                 const char *pem,
                 const char *chain)
{
	if (SSL_CTX_use_certificate_file(dom_ctx->ssl_ctx, pem, 1) == 0) {
		mg_cry_internal(fc(phys_ctx),
		                "%s: cannot open certificate file %s: %s",
		                __func__,
		                pem,
		                ssl_error());
		return 0;
	}

	/* could use SSL_CTX_set_default_passwd_cb_userdata */
	if (SSL_CTX_use_PrivateKey_file(dom_ctx->ssl_ctx, pem, 1) == 0) {
		mg_cry_internal(fc(phys_ctx),
		                "%s: cannot open private key file %s: %s",
		                __func__,
		                pem,
		                ssl_error());
		return 0;
	}

	if (SSL_CTX_check_private_key(dom_ctx->ssl_ctx) == 0) {
		mg_cry_internal(fc(phys_ctx),
		                "%s: certificate and private key do not match: %s",
		                __func__,
		                pem);
		return 0;
	}

	/* In contrast to OpenSSL, wolfSSL does not support certificate
	 * chain files that contain private keys and certificates in
	 * SSL_CTX_use_certificate_chain_file.
	 * The CivetWeb-Server used pem-Files that contained both information.
	 * In order to make wolfSSL work, it is split in two files.
	 * One file that contains key and certificate used by the server and
	 * an optional chain file for the ssl stack.
	 */
	if (chain) {
		if (SSL_CTX_use_certificate_chain_file(dom_ctx->ssl_ctx, chain) == 0) {
			mg_cry_internal(fc(phys_ctx),
			                "%s: cannot use certificate chain file %s: %s",
			                __func__,
			                pem,
			                ssl_error());
			return 0;
		}
	}
	return 1;
}
