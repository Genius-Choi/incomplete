init_ssl_ctx(struct mg_context *phys_ctx, struct mg_domain_context *dom_ctx)
{
	void *ssl_ctx = 0;
	int callback_ret;
	const char *pem;
	const char *chain;
	char ebuf[128];

	if (!phys_ctx) {
		return 0;
	}

	if (!dom_ctx) {
		dom_ctx = &(phys_ctx->dd);
	}

	if (!is_ssl_port_used(dom_ctx->config[LISTENING_PORTS])) {
		/* No SSL port is set. No need to setup SSL. */
		return 1;
	}

	/* Check for external SSL_CTX */
	callback_ret =
	    (phys_ctx->callbacks.external_ssl_ctx == NULL)
	        ? 0
	        : (phys_ctx->callbacks.external_ssl_ctx(&ssl_ctx,
	                                                phys_ctx->user_data));

	if (callback_ret < 0) {
		mg_cry_internal(fc(phys_ctx),
		                "external_ssl_ctx callback returned error: %i",
		                callback_ret);
		return 0;
	} else if (callback_ret > 0) {
		dom_ctx->ssl_ctx = (SSL_CTX *)ssl_ctx;
		if (!initialize_ssl(ebuf, sizeof(ebuf))) {
			mg_cry_internal(fc(phys_ctx), "%s", ebuf);
			return 0;
		}
		return 1;
	}
	/* else: external_ssl_ctx does not exist or returns 0,
	 * CivetWeb should continue initializing SSL */

	/* If PEM file is not specified and the init_ssl callback
	 * is not specified, setup will fail. */
	if (((pem = dom_ctx->config[SSL_CERTIFICATE]) == NULL)
	    && (phys_ctx->callbacks.init_ssl == NULL)) {
		/* No certificate and no callback:
		 * Essential data to set up TLS is missing.
		 */
		mg_cry_internal(fc(phys_ctx),
		                "Initializing SSL failed: -%s is not set",
		                config_options[SSL_CERTIFICATE].name);
		return 0;
	}

	chain = dom_ctx->config[SSL_CERTIFICATE_CHAIN];
	if (chain == NULL) {
		chain = pem;
	}
	if ((chain != NULL) && (*chain == 0)) {
		chain = NULL;
	}

	if (!initialize_ssl(ebuf, sizeof(ebuf))) {
		mg_cry_internal(fc(phys_ctx), "%s", ebuf);
		return 0;
	}

	return init_ssl_ctx_impl(phys_ctx, dom_ctx, pem, chain);
}
