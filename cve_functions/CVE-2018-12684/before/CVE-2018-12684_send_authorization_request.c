send_authorization_request(struct mg_connection *conn, const char *realm)
{
	char date[64];
	time_t curtime = time(NULL);
	uint64_t nonce = (uint64_t)(conn->phys_ctx->start_time);

	if (!realm) {
		realm = conn->dom_ctx->config[AUTHENTICATION_DOMAIN];
	}

	(void)pthread_mutex_lock(&conn->phys_ctx->nonce_mutex);
	nonce += conn->dom_ctx->nonce_count;
	++conn->dom_ctx->nonce_count;
	(void)pthread_mutex_unlock(&conn->phys_ctx->nonce_mutex);

	nonce ^= conn->dom_ctx->auth_nonce_mask;
	conn->status_code = 401;
	conn->must_close = 1;

	gmt_time_string(date, sizeof(date), &curtime);

	mg_printf(conn, "HTTP/1.1 401 Unauthorized\r\n");
	send_no_cache_header(conn);
	send_additional_header(conn);
	mg_printf(conn,
	          "Date: %s\r\n"
	          "Connection: %s\r\n"
	          "Content-Length: 0\r\n"
	          "WWW-Authenticate: Digest qop=\"auth\", realm=\"%s\", "
	          "nonce=\"%" UINT64_FMT "\"\r\n\r\n",
	          date,
	          suggest_connection_header(conn),
	          realm,
	          nonce);
}
