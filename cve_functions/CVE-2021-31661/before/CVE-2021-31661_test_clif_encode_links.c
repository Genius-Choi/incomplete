static void test_clif_encode_links(void)
{
    const char exp_string[] = "</sensor/temp>;rt=\"temperature\";if=\"sensor\","
                              "</node/info>,</node/ep>;ct=\"40\"";
    clif_attr_t attrs[] = {
        { .key = "rt", .value = "temperature" },
        { .key = "if", .value = "sensor" },
        { .key = "ct", .value = "40" }
    };

    clif_t links[] = {
        { .target = "/sensor/temp", .attrs = attrs, .attrs_len = 2 },
        { .target = "/node/info", .attrs_len = 0 },
        { .target = "/node/ep", .attrs = &attrs[2], .attrs_len = 1 }
    };

    const size_t exp_size = sizeof(exp_string) - 1;
    char output[sizeof(exp_string) + 1];
    size_t pos = 0;
    ssize_t res = 0;

    /* first test with NULL output to check the needed bytes */
    res = clif_encode_link(&links[0], NULL, 0);
    pos += res;

    for (unsigned i = 1; i < ARRAY_SIZE(links); i++) {
        res = clif_add_link_separator(NULL, 0);
        if (res <= 0) {
            break;
        }
        pos += res;

        res = clif_encode_link(&links[i],NULL, 0);
        if (res <= 0) {
            break;
        }
        pos += res;
    }

    TEST_ASSERT_EQUAL_INT(exp_size, pos);

    /* now actually encode the links */
    pos = 0;
    res = clif_encode_link(&links[0], output, sizeof(output));
    pos += res;

    for (unsigned i = 1; i < ARRAY_SIZE(links); i++) {
        res = clif_add_link_separator(&output[pos], sizeof(output) - pos);
        if (res <= 0) {
            break;
        }
        pos += res;

        res = clif_encode_link(&links[i], &output[pos], sizeof(output) - pos);
        if (res <= 0) {
            break;
        }
        pos += res;
    }
    output[pos++] = '\0';

#ifdef TESTS_CLIF_PRINT
    puts("\n========================================");
    puts("[Test: encode_links]");
    puts("---------------------");
    printf("Encoded links: %s\n", output);
#endif

    TEST_ASSERT_EQUAL_STRING(exp_string, output);
    TEST_ASSERT_EQUAL_INT(exp_size, pos - 1); /* do not count '\0' */
}
