epub_document_make_tree_entry(linknode* ListData,LinksCBStruct* UserData)
{
    GtkTreeIter tree_iter;
    EvLink *link = NULL;
    gboolean expand;
    char *title_markup;

    if (ListData->children) {
        expand=TRUE;
    }
    else {
        expand=FALSE;
    }

    EvLinkDest *ev_dest = NULL;
    EvLinkAction *ev_action;

    /* We shall use a EV_LINK_DEST_TYPE_PAGE for page links,
     * and a EV_LINK_DEST_TYPE_HLINK(custom) for refs on a page of type url#label
     * because we need both dest and page label for this.
     */

    if (g_strrstr(ListData->pagelink,"#") == NULL) {
        ev_dest = ev_link_dest_new_page(ListData->page);
    }
    else {
        ev_dest = ev_link_dest_new_hlink((gchar*)ListData->pagelink,ListData->page);
    }

    ev_action = ev_link_action_new_dest (ev_dest);

    link = ev_link_new((gchar*)ListData->linktext,ev_action);

    gtk_tree_store_append (GTK_TREE_STORE (UserData->model), &tree_iter,(UserData->parent));
    title_markup = g_markup_escape_text ((gchar*)ListData->linktext, -1);

    gtk_tree_store_set (GTK_TREE_STORE (UserData->model), &tree_iter,
                        EV_DOCUMENT_LINKS_COLUMN_MARKUP, title_markup,
                        EV_DOCUMENT_LINKS_COLUMN_LINK, link,
                        EV_DOCUMENT_LINKS_COLUMN_EXPAND, expand,
                        -1);

    if (ListData->children) {
        LinksCBStruct cbstruct;
        cbstruct.parent = &tree_iter;
        cbstruct.model = UserData->model;
        g_list_foreach (ListData->children,(GFunc)epub_document_make_tree_entry,&cbstruct);
    }

    g_free (title_markup);
    g_object_unref (link);
}
