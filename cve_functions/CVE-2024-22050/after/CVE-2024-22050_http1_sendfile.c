static int http1_sendfile(http_s *h, int fd, uintptr_t length,
                          uintptr_t offset) {
  FIOBJ packet = headers2str(h, 0);
  if (!packet) {
    close(fd);
    http1_after_finish(h);
    return -1;
  }
  if (length < HTTP_MAX_HEADER_LENGTH) {
    /* optimize away small files */
    fio_str_info_s s = fiobj_obj2cstr(packet);
    fiobj_str_capa_assert(packet, s.len + length);
    s = fiobj_obj2cstr(packet);
    intptr_t i = pread(fd, s.data + s.len, length, offset);
    if (i < 0) {
      close(fd);
      fiobj_send_free((handle2pr(h)->p.uuid), packet);
      fio_close((handle2pr(h)->p.uuid));
      return -1;
    }
    close(fd);
    fiobj_str_resize(packet, s.len + i);
    fiobj_send_free((handle2pr(h)->p.uuid), packet);
    http1_after_finish(h);
    return 0;
  }
  fiobj_send_free((handle2pr(h)->p.uuid), packet);
  fio_sendfile((handle2pr(h)->p.uuid), fd, offset, length);
  http1_after_finish(h);
  return 0;
}
