FIO_FUNC void fio_atol_test(void) {
  fprintf(stderr, "=== Testing fio_ltoa and fio_atol (partial)\n");
#ifndef NODEBUG
  fprintf(stderr,
          "Note: No optimizations - facil.io performance will be slow.\n");
#endif
  fprintf(stderr,
          "      Test with make test/optimized for realistic results.\n");
  time_t start, end;

#define TEST_ATOL(s, n)                                                        \
  do {                                                                         \
    char *p = (char *)(s);                                                     \
    int64_t r = fio_atol(&p);                                                  \
    FIO_ASSERT(r == (n), "fio_atol test error! %s => %zd (not %zd)",           \
               ((char *)(s)), (size_t)r, (size_t)n);                           \
    FIO_ASSERT((s) + strlen((s)) == p,                                         \
               "fio_atol test error! %s reading position not at end (%zu)",    \
               (s), (size_t)(p - (s)));                                        \
    char buf[72];                                                              \
    buf[fio_ltoa(buf, n, 2)] = 0;                                              \
    p = buf;                                                                   \
    FIO_ASSERT(fio_atol(&p) == (n),                                            \
               "fio_ltoa base 2 test error! "                                  \
               "%s != %s (%zd)",                                               \
               buf, ((char *)(s)), (size_t)((p = buf), fio_atol(&p)));         \
    buf[fio_ltoa(buf, n, 8)] = 0;                                              \
    p = buf;                                                                   \
    FIO_ASSERT(fio_atol(&p) == (n),                                            \
               "fio_ltoa base 8 test error! "                                  \
               "%s != %s (%zd)",                                               \
               buf, ((char *)(s)), (size_t)((p = buf), fio_atol(&p)));         \
    buf[fio_ltoa(buf, n, 10)] = 0;                                             \
    p = buf;                                                                   \
    FIO_ASSERT(fio_atol(&p) == (n),                                            \
               "fio_ltoa base 10 test error! "                                 \
               "%s != %s (%zd)",                                               \
               buf, ((char *)(s)), (size_t)((p = buf), fio_atol(&p)));         \
    buf[fio_ltoa(buf, n, 16)] = 0;                                             \
    p = buf;                                                                   \
    FIO_ASSERT(fio_atol(&p) == (n),                                            \
               "fio_ltoa base 16 test error! "                                 \
               "%s != %s (%zd)",                                               \
               buf, ((char *)(s)), (size_t)((p = buf), fio_atol(&p)));         \
  } while (0)
  TEST_ATOL("0x1", 1);
  TEST_ATOL("-0x1", -1);
  TEST_ATOL("-0xa", -10);                                /* sign before hex */
  TEST_ATOL("0xe5d4c3b2a1908770", -1885667171979196560); /* sign within hex */
  TEST_ATOL("0b00000000000011", 3);
  TEST_ATOL("-0b00000000000011", -3);
  TEST_ATOL("0b0000000000000000000000000000000000000000000000000", 0);
  TEST_ATOL("0", 0);
  TEST_ATOL("1", 1);
  TEST_ATOL("2", 2);
  TEST_ATOL("-2", -2);
  TEST_ATOL("0000000000000000000000000000000000000000000000042", 34); /* oct */
  TEST_ATOL("9223372036854775807", 9223372036854775807LL); /* INT64_MAX */
  TEST_ATOL("9223372036854775808",
            9223372036854775807LL); /* INT64_MAX overflow protection */
  TEST_ATOL("9223372036854775999",
            9223372036854775807LL); /* INT64_MAX overflow protection */

  char number_hex[128] = "0xe5d4c3b2a1908770"; /* hex with embedded sign */
  // char number_hex[128] = "-0x1a2b3c4d5e6f7890";
  char number[128] = "-1885667171979196560";
  intptr_t expect = -1885667171979196560;
  intptr_t result = 0;

  result = 0;

  start = clock();
  for (size_t i = 0; i < FIO_ATOL_TEST_MAX_CYCLES; ++i) {
    __asm__ volatile("" ::: "memory");
    char *pos = number;
    result = fio_atol(&pos);
    __asm__ volatile("" ::: "memory");
  }
  end = clock();
  fprintf(stderr, "fio_atol base 10 (%ld): %zd CPU cycles\n", result,
          end - start);

  result = 0;
  start = clock();
  for (size_t i = 0; i < FIO_ATOL_TEST_MAX_CYCLES; ++i) {
    __asm__ volatile("" ::: "memory");
    result = strtol(number, NULL, 0);
    __asm__ volatile("" ::: "memory");
  }
  end = clock();
  fprintf(stderr, "native strtol base 10 (%ld): %zd CPU cycles\n", result,
          end - start);

  result = 0;
  start = clock();
  for (size_t i = 0; i < FIO_ATOL_TEST_MAX_CYCLES; ++i) {
    __asm__ volatile("" ::: "memory");
    char *pos = number_hex;
    result = fio_atol(&pos);
    __asm__ volatile("" ::: "memory");
  }
  end = clock();
  fprintf(stderr, "fio_atol base 16 (%ld): %zd CPU cycles\n", result,
          end - start);

  result = 0;
  start = clock();
  for (size_t i = 0; i < FIO_ATOL_TEST_MAX_CYCLES; ++i) {
    __asm__ volatile("" ::: "memory");
    result = strtol(number_hex, NULL, 0);
    __asm__ volatile("" ::: "memory");
  }
  end = clock();
  fprintf(stderr, "native strtol base 16 (%ld): %zd CPU cycles%s\n", result,
          end - start, (result != expect ? " (!?stdlib overflow?!)" : ""));

  result = 0;
  start = clock();
  for (size_t i = 0; i < FIO_ATOL_TEST_MAX_CYCLES; ++i) {
    __asm__ volatile("" ::: "memory");
    fio_ltoa(number, expect, 10);
    __asm__ volatile("" ::: "memory");
  }
  end = clock();
  {
    char *buf = number;
    FIO_ASSERT(fio_atol(&buf) == expect,
               "fio_ltoa with base 10 returned wrong result (%s != %ld)",
               number, expect);
  }
  fprintf(stderr, "fio_ltoa base 10 (%s): %zd CPU cycles\n", number,
          end - start);

  result = 0;
  start = clock();
  for (size_t i = 0; i < FIO_ATOL_TEST_MAX_CYCLES; ++i) {
    __asm__ volatile("" ::: "memory");
    sprintf(number, "%ld", expect);
    __asm__ volatile("" ::: "memory");
  }
  end = clock();
  fprintf(stderr, "native sprintf base 10 (%s): %zd CPU cycles\n", number,
          end - start);
  FIO_ASSERT(fio_ltoa(number, 0, 0) == 1,
             "base 10 zero should be single char.");
  FIO_ASSERT(memcmp(number, "0", 2) == 0, "base 10 zero should be \"0\" (%s).",
             number);
  fprintf(stderr, "* passed.\n");
#undef TEST_ATOL
}
