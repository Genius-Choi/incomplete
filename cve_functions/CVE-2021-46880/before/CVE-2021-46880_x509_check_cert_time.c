x509_check_cert_time(X509_STORE_CTX *ctx, X509 *x, int depth)
{
	time_t ptime;
	int i;

	if (ctx->param->flags & X509_V_FLAG_USE_CHECK_TIME)
		ptime = ctx->param->check_time;
	else if (ctx->param->flags & X509_V_FLAG_NO_CHECK_TIME)
		return 1;
	else
		ptime = time(NULL);

	if (x->ex_flags & EXFLAG_SET)
		i = time_t_bogocmp(x->not_before, ptime);
	else
		i = X509_cmp_time(X509_get_notBefore(x), &ptime);

	if (i >= 0 && depth < 0)
		return 0;
	if (i == 0 && !verify_cb_cert(ctx, x, depth,
	    X509_V_ERR_ERROR_IN_CERT_NOT_BEFORE_FIELD))
		return 0;
	if (i > 0 && !verify_cb_cert(ctx, x, depth,
	    X509_V_ERR_CERT_NOT_YET_VALID))
		return 0;

	if (x->ex_flags & EXFLAG_SET)
		i = time_t_bogocmp(x->not_after, ptime);
	else
		i = X509_cmp_time_internal(X509_get_notAfter(x), &ptime, 1);

	if (i <= 0 && depth < 0)
		return 0;
	if (i == 0 && !verify_cb_cert(ctx, x, depth,
	    X509_V_ERR_ERROR_IN_CERT_NOT_AFTER_FIELD))
		return 0;
	if (i < 0 && !verify_cb_cert(ctx, x, depth,
	    X509_V_ERR_CERT_HAS_EXPIRED))
		return 0;

	return 1;
}
