BOOL drive_file_query_information(DRIVE_FILE* file, UINT32 FsInformationClass, wStream* output)
{
	WIN32_FILE_ATTRIBUTE_DATA fileAttributes;
	DEBUG_WSTR("FindFirstFile %s", file->fullpath);

	if (!file || !output)
		return FALSE;

	if (!GetFileAttributesExW(file->fullpath, GetFileExInfoStandard, &fileAttributes))
		goto out_fail;

	switch (FsInformationClass)
	{
		case FileBasicInformation:

			/* http://msdn.microsoft.com/en-us/library/cc232094.aspx */
			if (!Stream_EnsureRemainingCapacity(output, 4 + 36))
				goto out_fail;

			Stream_Write_UINT32(output, 36); /* Length */
			Stream_Write_UINT32(output,
			                    fileAttributes.ftCreationTime.dwLowDateTime); /* CreationTime */
			Stream_Write_UINT32(output,
			                    fileAttributes.ftCreationTime.dwHighDateTime); /* CreationTime */
			Stream_Write_UINT32(output,
			                    fileAttributes.ftLastAccessTime.dwLowDateTime); /* LastAccessTime */
			Stream_Write_UINT32(
			    output, fileAttributes.ftLastAccessTime.dwHighDateTime); /* LastAccessTime */
			Stream_Write_UINT32(output,
			                    fileAttributes.ftLastWriteTime.dwLowDateTime); /* LastWriteTime */
			Stream_Write_UINT32(output,
			                    fileAttributes.ftLastWriteTime.dwHighDateTime); /* LastWriteTime */
			Stream_Write_UINT32(output,
			                    fileAttributes.ftLastWriteTime.dwLowDateTime); /* ChangeTime */
			Stream_Write_UINT32(output,
			                    fileAttributes.ftLastWriteTime.dwHighDateTime); /* ChangeTime */
			Stream_Write_UINT32(output, fileAttributes.dwFileAttributes);       /* FileAttributes */
			/* Reserved(4), MUST NOT be added! */
			break;

		case FileStandardInformation:

			/*  http://msdn.microsoft.com/en-us/library/cc232088.aspx */
			if (!Stream_EnsureRemainingCapacity(output, 4 + 22))
				goto out_fail;

			Stream_Write_UINT32(output, 22);                           /* Length */
			Stream_Write_UINT32(output, fileAttributes.nFileSizeLow);  /* AllocationSize */
			Stream_Write_UINT32(output, fileAttributes.nFileSizeHigh); /* AllocationSize */
			Stream_Write_UINT32(output, fileAttributes.nFileSizeLow);  /* EndOfFile */
			Stream_Write_UINT32(output, fileAttributes.nFileSizeHigh); /* EndOfFile */
			Stream_Write_UINT32(output, 0);                            /* NumberOfLinks */
			Stream_Write_UINT8(output, file->delete_pending ? 1 : 0);  /* DeletePending */
			Stream_Write_UINT8(output, fileAttributes.dwFileAttributes & FILE_ATTRIBUTE_DIRECTORY
			                               ? TRUE
			                               : FALSE); /* Directory */
			/* Reserved(2), MUST NOT be added! */
			break;

		case FileAttributeTagInformation:

			/* http://msdn.microsoft.com/en-us/library/cc232093.aspx */
			if (!Stream_EnsureRemainingCapacity(output, 4 + 8))
				goto out_fail;

			Stream_Write_UINT32(output, 8);                               /* Length */
			Stream_Write_UINT32(output, fileAttributes.dwFileAttributes); /* FileAttributes */
			Stream_Write_UINT32(output, 0);                               /* ReparseTag */
			break;

		default:
			/* Unhandled FsInformationClass */
			goto out_fail;
	}

	return TRUE;
out_fail:
	Stream_Write_UINT32(output, 0); /* Length */
	return FALSE;
}
