virtio_net_tap_open(char *devname)
{
	char tbuf[IFNAMSIZ];
	int tunfd, rc, macvtap_index;
	struct ifreq ifr;

	/*Check if tun/tap or macvtap interface is used */
	if (virtio_net_is_macvtap(devname, &macvtap_index)) {
		rc = snprintf(tbuf, IFNAMSIZ, "/dev/tap%d", macvtap_index);
	} else {
		rc = snprintf(tbuf, IFNAMSIZ, "%s", "/dev/net/tun");
	}

	if (rc < 0 || rc >= IFNAMSIZ) {
		WPRINTF(("Failed to set interface name %s\n", tbuf));
		return -1;
	}

	tunfd = open(tbuf, O_RDWR);
	if (tunfd < 0) {
		WPRINTF(("Failed to open interface %s\n", tbuf));
		return -1;
	}

	memset(&ifr, 0, sizeof(ifr));
	ifr.ifr_flags = IFF_TAP | IFF_NO_PI;

	if (*devname) {
		strncpy(ifr.ifr_name, devname, IFNAMSIZ);
		ifr.ifr_name[IFNAMSIZ - 1] = '\0';
	}

	rc = ioctl(tunfd, TUNSETIFF, (void *)&ifr);
	if (rc < 0) {
		WPRINTF(("open of tap device %s failed: %d\n",
			devname, errno));
		close(tunfd);
		return -1;
	}

	strncpy(devname, ifr.ifr_name, IFNAMSIZ);
	return tunfd;
}
