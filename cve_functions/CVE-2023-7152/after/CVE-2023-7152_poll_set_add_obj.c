STATIC void poll_set_add_obj(poll_set_t *poll_set, const mp_obj_t *obj, mp_uint_t obj_len, mp_uint_t events, bool or_events) {
    for (mp_uint_t i = 0; i < obj_len; i++) {
        mp_map_elem_t *elem = mp_map_lookup(&poll_set->map, mp_obj_id(obj[i]), MP_MAP_LOOKUP_ADD_IF_NOT_FOUND);
        if (elem->value == MP_OBJ_NULL) {
            // object not found; get its ioctl and add it to the poll list

            // If an exception is raised below when adding the new object then the map entry for that
            // object remains unpopulated, and methods like poll() may crash.  This case is not handled.

            poll_obj_t *poll_obj = m_new_obj(poll_obj_t);
            poll_obj->obj = obj[i];

            #if MICROPY_PY_SELECT_POSIX_OPTIMISATIONS
            int fd = -1;
            if (mp_obj_is_int(obj[i])) {
                // A file descriptor integer passed in as the object, so use it directly.
                fd = mp_obj_get_int(obj[i]);
                if (fd < 0) {
                    mp_raise_ValueError(NULL);
                }
                poll_obj->ioctl = NULL;
            } else {
                // An object passed in.  Check if it has a file descriptor.
                const mp_stream_p_t *stream_p = mp_get_stream_raise(obj[i], MP_STREAM_OP_IOCTL);
                poll_obj->ioctl = stream_p->ioctl;
                int err;
                mp_uint_t res = stream_p->ioctl(obj[i], MP_STREAM_GET_FILENO, 0, &err);
                if (res != MP_STREAM_ERROR) {
                    fd = res;
                }
            }
            if (fd >= 0) {
                // Object has a file descriptor so add it to pollfds.
                poll_obj->pollfd = poll_set_add_fd(poll_set, fd);
            } else {
                // Object doesn't have a file descriptor.
                poll_obj->pollfd = NULL;
            }
            #else
            const mp_stream_p_t *stream_p = mp_get_stream_raise(obj[i], MP_STREAM_OP_IOCTL);
            poll_obj->ioctl = stream_p->ioctl;
            #endif

            poll_obj_set_events(poll_obj, events);
            poll_obj_set_revents(poll_obj, 0);
            elem->value = MP_OBJ_FROM_PTR(poll_obj);
        } else {
            // object exists; update its events
            poll_obj_t *poll_obj = (poll_obj_t *)MP_OBJ_TO_PTR(elem->value);
            #if MICROPY_PY_SELECT_SELECT
            if (or_events) {
                events |= poll_obj_get_events(poll_obj);
            }
            #else
            (void)or_events;
            #endif
            poll_obj_set_events(poll_obj, events);
        }
    }
}
