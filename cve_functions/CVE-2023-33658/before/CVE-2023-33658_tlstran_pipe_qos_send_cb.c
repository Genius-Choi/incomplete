tlstran_pipe_qos_send_cb(void *arg)
{
	tlstran_pipe *p = arg;
	nni_msg      *msg;
	nni_aio      *qsaio = p->qsaio;
	uint8_t       type;
	size_t        n;

	if (nni_aio_result(qsaio) != 0) {
		nni_msg_free(nni_aio_get_msg(qsaio));
		nni_aio_set_msg(qsaio, NULL);
		tlstran_pipe_close(p);
		return;
	}
	nni_mtx_lock(&p->mtx);
	n = nni_aio_count(qsaio);
	nni_aio_iov_advance(qsaio, n);
	if (nni_aio_iov_count(qsaio) > 0) {
		nng_stream_send(p->conn, qsaio);
		nni_mtx_unlock(&p->mtx);
		return;
	}
	msg  = nni_aio_get_msg(p->qsaio);
	type = nni_msg_cmd_type(msg);

	if (p->tcp_cparam->pro_ver == 5) {
		(type == CMD_PUBCOMP || type == PUBACK) ? p->qrecv_quota++
		                                        : p->qrecv_quota;
	}
	nni_msg_free(msg);
	if (nni_lmq_get(&p->rslmq, &msg) == 0) {
		nni_iov iov;
		nni_msg_insert(
		    msg, nni_msg_header(msg), nni_msg_header_len(msg));
		iov.iov_len = nni_msg_len(msg);
		iov.iov_buf = nni_msg_body(msg);
		nni_aio_set_msg(p->qsaio, msg);
		// send it down...
		nni_aio_set_iov(p->qsaio, 1, &iov);
		nng_stream_send(p->conn, p->qsaio);
		p->busy = true;
		nni_mtx_unlock(&p->mtx);
		nni_aio_set_msg(qsaio, NULL);
		return;
	}
	p->busy = false;
	nni_mtx_unlock(&p->mtx);
	nni_aio_set_msg(qsaio, NULL);
	return;
}
