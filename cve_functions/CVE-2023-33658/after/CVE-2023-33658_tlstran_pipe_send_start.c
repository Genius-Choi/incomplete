tlstran_pipe_send_start(tlstran_pipe *p)
{
	nni_aio *aio;
	nni_msg *msg;

	log_trace("########### tlstran_pipe_send_start ###########");
	if (p->closed) {
		while ((aio = nni_list_first(&p->sendq)) != NULL) {
			nni_list_remove(&p->sendq, aio);
			nni_aio_finish_error(aio, NNG_ECLOSED);
		}
		return;
	}

	if ((aio = nni_list_first(&p->sendq)) == NULL) {
		log_trace("aio not functioning");
		return;
	}

	// This runs to send the message.
	msg = nni_aio_get_msg(aio);
	if (msg == NULL || p->tcp_cparam == NULL) {
		// TODO error handler
		nni_println("ERROR: sending NULL msg or pipe is invalid!");
		nni_aio_finish(aio, NNG_ECANCELED, 0);
		return;
	}
	if (p->tcp_cparam->pro_ver == 4) {
		tlstran_pipe_send_start_v4(p, msg, aio);
	} else if (p->tcp_cparam->pro_ver == 5) {
		tlstran_pipe_send_start_v5(p, msg, aio);
	}
	return;
}
