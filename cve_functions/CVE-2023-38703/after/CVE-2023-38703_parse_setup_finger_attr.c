static pj_status_t parse_setup_finger_attr(dtls_srtp *ds,
                                           pj_bool_t rem_as_offerer,
                                           const pjmedia_sdp_session *sdp,
                                           unsigned media_index)
{
    pjmedia_sdp_media *m;
    pjmedia_sdp_attr *a;

    m = sdp->media[media_index];

    /* Parse a=setup */
    a = pjmedia_sdp_media_find_attr(m, &ID_SETUP, NULL);
    if (!a)
        a = pjmedia_sdp_attr_find(sdp->attr_count,
                                  sdp->attr, &ID_SETUP, NULL);
    if (!a)
        return PJMEDIA_SRTP_ESDPAMBIGUEANS;

    if (pj_stristr(&a->value, &ID_PASSIVE) ||
        (rem_as_offerer && pj_stristr(&a->value, &ID_ACTPASS)))
    {
        /* Remote offers/answers 'passive' (or offers 'actpass'), so we are
         * the client.
         */
        ds->setup = DTLS_SETUP_ACTIVE;
    } else if (pj_stristr(&a->value, &ID_ACTIVE)) {
        /* Remote offers/answers 'active' so we are the server. */
        ds->setup = DTLS_SETUP_PASSIVE;
    } else {
        /* Unknown value set in remote a=setup */
        return PJMEDIA_SRTP_ESDPAMBIGUEANS;
    }

    /* Parse a=fingerprint */
    a = pjmedia_sdp_media_find_attr(m, &ID_FINGERPRINT, NULL);
    if (!a)
        a = pjmedia_sdp_attr_find(sdp->attr_count,
                                  sdp->attr, &ID_FINGERPRINT,
                                  NULL);
    if (!a) {
        /* No fingerprint attribute in remote SDP */
        return PJMEDIA_SRTP_DTLS_ENOFPRINT;
    } else {
        pj_str_t rem_fp = a->value;
        pj_strtrim(&rem_fp);
        if (pj_stricmp(&ds->rem_fingerprint, &rem_fp))
            pj_strdup(ds->pool, &ds->rem_fingerprint, &rem_fp);
    }

    return PJ_SUCCESS;
}
