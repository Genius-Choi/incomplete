static pj_status_t ssl_get_srtp_material(dtls_srtp *ds, unsigned idx)
{
    unsigned char material[SRTP_MAX_KEY_LEN * 2];
    SRTP_PROTECTION_PROFILE *profile;
    int rc, i, crypto_idx = -1;
    pjmedia_srtp_crypto *tx, *rx;
    pj_status_t status = PJ_SUCCESS;

    pj_lock_acquire(ds->ossl_lock);

    if (!ds->ossl_ssl[idx]) {
        status = PJ_EGONE;
        goto on_return;
    }

    /* Get selected crypto-suite */
    profile = SSL_get_selected_srtp_profile(ds->ossl_ssl[idx]);
    if (!profile) {
        status = PJMEDIA_SRTP_DTLS_ENOCRYPTO;
        goto on_return;
    }

    tx = &ds->tx_crypto[idx];
    rx = &ds->rx_crypto[idx];
    pj_bzero(tx, sizeof(*tx));
    pj_bzero(rx, sizeof(*rx));
    for (i=0; i<(int)PJ_ARRAY_SIZE(ossl_profiles); ++i) {
        if (pj_ansi_stricmp(profile->name, ossl_profiles[i])==0) {
            pj_strset2(&tx->name, pj_profiles[i]);
            pj_strset2(&rx->name, pj_profiles[i]);
            crypto_idx = get_crypto_idx(&tx->name);
            break;
        }
    }
    if (crypto_idx == -1) {
        status = PJMEDIA_SRTP_ENOTSUPCRYPTO;
        goto on_return;
    }

    /* Get keying material from DTLS nego. There seems to be no info about
     * material length returned by SSL_export_keying_material()?
     */
    rc = SSL_export_keying_material(ds->ossl_ssl[idx], material,
                                    sizeof(material), "EXTRACTOR-dtls_srtp",
                                    19, NULL, 0, 0);
    if (rc == 0) {
        status = PJMEDIA_SRTP_EINKEYLEN;
        goto on_return;
    }

    /* Parse SRTP master key & salt from keying material */
    {
        char *p = (char*)material;
        char *k1, *k2;
        crypto_suite *cs = &crypto_suites[crypto_idx];
        unsigned key_len, salt_len;

        key_len = cs->cipher_key_len - cs->cipher_salt_len;
        salt_len = cs->cipher_salt_len;

        tx->key.ptr = (char*)pj_pool_alloc(ds->pool, key_len+salt_len);
        tx->key.slen = key_len+salt_len;
        rx->key.ptr = (char*)pj_pool_alloc(ds->pool, key_len+salt_len);
        rx->key.slen = key_len+salt_len;
        if (ds->setup == DTLS_SETUP_ACTIVE) {
            k1 = tx->key.ptr;
            k2 = rx->key.ptr;
        } else {
            k1 = rx->key.ptr;
            k2 = tx->key.ptr;
        }
        pj_memcpy(k1, p, key_len); p += key_len;
        pj_memcpy(k2, p, key_len); p += key_len;
        pj_memcpy(k1+key_len, p, salt_len); p += salt_len;
        pj_memcpy(k2+key_len, p, salt_len);
        ds->got_keys = PJ_TRUE;
    }

on_return:
    pj_lock_release(ds->ossl_lock);
    return status;
}
