PJ_DEF(pj_status_t) pjmedia_ice_trickle_send_local_cand(
                                            pjmedia_transport *tp,
                                            pj_pool_t *sdp_pool,
                                            pjmedia_sdp_session *sdp,
                                            pj_bool_t *p_end_of_cand)
{
    struct transport_ice *tp_ice = (struct transport_ice*)tp;
    pj_str_t ufrag, pwd;
    pj_ice_sess_cand cand[PJ_ICE_MAX_CAND];
    unsigned cand_cnt, i, comp_cnt;
    pj_bool_t end_of_cand;
    pj_status_t status;

    PJ_ASSERT_RETURN(tp && sdp_pool && sdp, PJ_EINVAL);

    /* Make sure ICE transport has session already */
    if (!tp_ice->ice_st || !pj_ice_strans_has_sess(tp_ice->ice_st))
        return PJ_EINVALIDOP;

    end_of_cand = tp_ice->end_of_cand;

    /* Get ufrag and pwd from current session */
    pj_ice_strans_get_ufrag_pwd(tp_ice->ice_st, &ufrag, &pwd, NULL, NULL);

    cand_cnt = 0;
    comp_cnt = pj_ice_strans_get_running_comp_cnt(tp_ice->ice_st);
    for (i = 0; i < comp_cnt; ++i) {
        unsigned cnt = PJ_ICE_MAX_CAND - cand_cnt;

        /* Get all local candidates for this comp */
        status = pj_ice_strans_enum_cands(tp_ice->ice_st, i+1,
                                          &cnt, &cand[cand_cnt]);
        if (status != PJ_SUCCESS) {
            PJ_PERROR(3,(tp_ice->base.name, status,
                         "Failed enumerating local candidates for comp-id=%d",
                         i+1));
            continue;
        }
        cand_cnt += cnt;

        tp_ice->last_send_cand_cnt[i] = cnt;
    }

    /* Update the SDP with all local candidates (not just the new ones).
     * https://tools.ietf.org/html/draft-ietf-mmusic-trickle-ice-sip-18:
     * 4.4. Delivering Candidates in INFO Requests: the agent MUST
     * repeat in the INFO request body all candidates that were previously
     * sent under the same combination of "a=ice-pwd:" and "a=ice-ufrag:"
     * in the same order as they were sent before.
     */
    status = pjmedia_ice_trickle_encode_sdp(sdp_pool, sdp, &tp_ice->sdp_mid,
                                            &ufrag, &pwd, cand_cnt, cand,
                                            end_of_cand);
    if (status != PJ_SUCCESS) {
        PJ_PERROR(3,(tp_ice->base.name, status,
                     "Failed encoding local candidates to SDP"));
    }

    if (p_end_of_cand)
        *p_end_of_cand = end_of_cand;

    return PJ_SUCCESS;
}
