static enum MHD_Result mhd_iterate_post_data (void * coninfo_cls, enum MHD_ValueKind kind, const char * key,
                                              const char * filename, const char * content_type,
                                              const char * transfer_encoding, const char * data, uint64_t off, size_t size) {
#else
static int mhd_iterate_post_data (void * coninfo_cls, enum MHD_ValueKind kind, const char * key,
                                  const char * filename, const char * content_type,
                                  const char * transfer_encoding, const char * data, uint64_t off, size_t size) {
#endif
  struct connection_info_struct * con_info = coninfo_cls;
  size_t data_size = size, cur_size;
  char * filename_param = NULL, * data_concat = NULL;
  const char * cur_data;
#if MHD_VERSION >= 0x00097002
  enum MHD_Result ret = MHD_YES;
#else
  int ret = MHD_YES;
#endif
  UNUSED(kind);

  if (con_info->u_instance == NULL) {
    ret = MHD_NO;
  } else if (filename != NULL && con_info->u_instance->file_upload_callback != NULL) {
    if (con_info->u_instance->file_upload_callback(con_info->request, key, filename, content_type, transfer_encoding, data, off, size, con_info->u_instance->file_upload_cls) != U_OK) {
      ret = MHD_NO;
    }
  } else {
    
    do {
      if (con_info->u_instance->check_utf8) {
        if (utf8_check(key, o_strlen(key)) != NULL || data == NULL || utf8_check(data, o_strlen(data)) != NULL || (filename != NULL && utf8_check(filename, o_strlen(filename)) != NULL)) {
          break;
        }
      }
      
      if (con_info->max_post_param_size && off > con_info->max_post_param_size) {
        break;
      }
      
      if (off + size > con_info->max_post_param_size) {
        data_size = con_info->max_post_param_size - off;
      }
      
      if (filename != NULL) {
        filename_param = msprintf("%s_filename", key);
        if (!u_map_has_key((struct _u_map *)con_info->request->map_post_body, filename_param) && u_map_put((struct _u_map *)con_info->request->map_post_body, filename_param, filename) != U_OK) {
          y_log_message(Y_LOG_LEVEL_ERROR, "Ulfius - Error u_map_put filename value");
        }
        cur_data = u_map_get((struct _u_map *)con_info->request->map_post_body, key);
        cur_size = u_map_get_length((struct _u_map *)con_info->request->map_post_body, key);
        if (cur_data != NULL) {
          if (off) {
            if (u_map_put_binary((struct _u_map *)con_info->request->map_post_body, key, data, cur_size, data_size) != U_OK) {
              ret = MHD_NO;
              break;
            }
          } else {
            if (u_map_put_binary((struct _u_map *)con_info->request->map_post_body, key, ",", cur_size, 1) != U_OK ||
                u_map_put_binary((struct _u_map *)con_info->request->map_post_body, key, data, cur_size+1, 1) != U_OK) {
              ret = MHD_NO;
              break;
            }
          }
        } else {
          if (u_map_put_binary((struct _u_map *)con_info->request->map_post_body, key, data, 0, data_size) != U_OK) {
            ret = MHD_NO;
            break;
          }
        }
      } else {
        cur_data = u_map_get((struct _u_map *)con_info->request->map_post_body, key);
        cur_size = u_map_get_length((struct _u_map *)con_info->request->map_post_body, key);
        if (cur_data != NULL) {
          if (off) {
            data_concat = msprintf("%s%s", cur_data, data);
          } else {
            data_concat = msprintf("%s,%s", cur_data, data);
          }
          if (u_map_put((struct _u_map *)con_info->request->map_post_body, key, data_concat) != U_OK) {
            ret = MHD_NO;
            break;
          }
        } else {
          if (u_map_put((struct _u_map *)con_info->request->map_post_body, key, data) != U_OK) {
            ret = MHD_NO;
            break;
          }
        }
      }
      
    } while (0);
    o_free(data_concat);
    o_free(filename_param);
  }
  return ret;
}
