char *gf_bt_get_string(GF_BTParser *parser, u8 string_delim)
{
	char *res;
	s32 i, size;

#define	BT_STR_CHECK_ALLOC	\
		if (i==size) {		\
			res = (char*)gf_realloc(res, sizeof(char) * (size+500+1));	\
			size += 500;	\
		}	\

	res = (char*)gf_malloc(sizeof(char) * 500);
	size = 500;
	while (parser->line_buffer[parser->line_pos]==' ') parser->line_pos++;

	if (parser->line_pos==parser->line_size) {
		if (gf_gzeof(parser->gz_in)) return NULL;
		gf_bt_check_line(parser);
	}
	if (!string_delim) string_delim = '"';

	i=0;
	while (1) {
		if (parser->line_buffer[parser->line_pos] == string_delim)
			if ( !parser->line_pos || (parser->line_buffer[parser->line_pos-1] != '\\') ) break;

		BT_STR_CHECK_ALLOC

		if ((parser->line_buffer[parser->line_pos]=='/') && (parser->line_buffer[parser->line_pos+1]=='/') && (parser->line_buffer[parser->line_pos-1]!=':') ) {
			/*this looks like a comment*/
			if (!strchr(&parser->line_buffer[parser->line_pos], string_delim)) {
				gf_bt_check_line(parser);
				continue;
			}
		}
		if ((parser->line_buffer[parser->line_pos] != '\\') || (parser->line_buffer[parser->line_pos+1] != string_delim)) {
			/*handle UTF-8 - WARNING: if parser is in unicode string is already utf8 multibyte chars*/
			if (!parser->unicode_type && parser->line_buffer[parser->line_pos] & 0x80) {
				char c = parser->line_buffer[parser->line_pos];
				/*non UTF8 (likely some win-CP)*/
				if ( (parser->line_buffer[parser->line_pos+1] & 0xc0) != 0x80) {
					res[i] = 0xc0 | ( (parser->line_buffer[parser->line_pos] >> 6) & 0x3 );
					i++;
					BT_STR_CHECK_ALLOC
					parser->line_buffer[parser->line_pos] &= 0xbf;
				}
				/*UTF8 2 bytes char*/
				else if ( (c & 0xe0) == 0xc0) {
					res[i] = parser->line_buffer[parser->line_pos];
					parser->line_pos++;
					i++;
					BT_STR_CHECK_ALLOC
				}
				/*UTF8 3 bytes char*/
				else if ( (c & 0xf0) == 0xe0) {
					res[i] = parser->line_buffer[parser->line_pos];
					parser->line_pos++;
					i++;
					BT_STR_CHECK_ALLOC
					res[i] = parser->line_buffer[parser->line_pos];
					parser->line_pos++;
					i++;
					BT_STR_CHECK_ALLOC
				}
				/*UTF8 4 bytes char*/
				else if ( (c & 0xf8) == 0xf0) {
					res[i] = parser->line_buffer[parser->line_pos];
					parser->line_pos++;
					i++;
					BT_STR_CHECK_ALLOC
					res[i] = parser->line_buffer[parser->line_pos];
					parser->line_pos++;
					i++;
					BT_STR_CHECK_ALLOC
					res[i] = parser->line_buffer[parser->line_pos];
					parser->line_pos++;
					i++;
					BT_STR_CHECK_ALLOC
				}
			}

			res[i] = parser->line_buffer[parser->line_pos];
			i++;
		}
		parser->line_pos++;
		if (parser->line_pos==parser->line_size) {
			gf_bt_check_line(parser);
		}

	}

#undef	BT_STR_CHECK_ALLOC

	res[i] = 0;
	parser->line_pos += 1;
	return res;
}
