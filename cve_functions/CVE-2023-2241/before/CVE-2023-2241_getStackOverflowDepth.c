size_t getStackOverflowDepth()
{
    // calculate stack overflow depth - need to do this because a value that consistently overflows a 64-bit stack
    // doesn't work on 32-bit systems because they run out of heap in ReadObjects before they get a chance to overflow stack
    // this is because sizeof(PdfParserObject) = 472 bytes (and there's one of these for every object read)
    constexpr size_t parserObjectSize = sizeof(PdfParserObject);

#if defined(_WIN64)
    // 1 MB default stack size, 64-bit address space, Windows x64 ABI
    // each stack frame has at least 4 64-bit stack params, 4 64-bit register params, plus 64-bit return address
    // stack frame size increases if function contains local variables or more than 4 parameters
    // see https://docs.microsoft.com/en-us/cpp/build/stack-usage?view=msvc-170
    constexpr size_t stackSize = 1 * 1024 * 1024;
    constexpr size_t frameSize = sizeof(void*) * (4 + 4 + 1); // 4 stack params + 4 register params + return address
    constexpr size_t maxFrames = stackSize / frameSize; // overflows at 14,563 recursive calls (or sooner if functions contain local variables)
#elif defined(_WIN32)
    // 1 MB default stack size, 32-bit address space (can't allocate more than 2GB), Windows x86 thiscall calling convention
    // each stack frame has at least 32-bit EBP and return address
    // stack frame size increases if function contains local variables or any parameters
    constexpr size_t stackSize = 1 * 1024 * 1024;
    constexpr size_t frameSize = sizeof(void*) * (1 + 1); // EBP and return address
    constexpr size_t maxFrames = stackSize / frameSize; // overflows at 131,072 recursive calls (or sooner if functions contain local variables or has parameters)
#else
    // assume 8MB macOS / Linux default stack size, 64-bit address space, System V AMD64 ABI
    // each stack frame has at least 64-bit EBP and return address
    // stack frame size increases if function contains local variables or any parameters
    constexpr size_t stackSize = 8 * 1024 * 1024;
    constexpr size_t frameSize = sizeof(void*) * (1 + 1); // EBP and return address
    constexpr size_t maxFrames = stackSize / frameSize; // overflows at 524,288 recursive calls (or sooner if functions contain local variables or has parameters)
#endif

    // add a few frames to sure we go beyond end of stack
    constexpr size_t overflowDepth = maxFrames + 1000;

    // overflowDepth must be less than GetMaxObjectCount otherwise PdfParser::ResizeOffsets
    // throws an error when reading the xref offsets table, and no recursive calls are made
    // must also be allocate less than half of address space to prevent out-of-memory exceptions
    REQUIRE(overflowDepth < PdfParser::GetMaxObjectCount());
    REQUIRE(overflowDepth * parserObjectSize < numeric_limits<size_t>::max() / 2);

    return overflowDepth;
}
