void HTTPServer::handleRequest(Client *cl, HTTPRequest* req) {
	// Parse the request
	// If there's an error, report it and send a server error in response
	if (!req->parse()) {
		std::cout << "[" << cl->getClientIP() << "] There was an error processing the request of type: " << req->methodIntToStr(req->getMethod()) << std::endl;
		std::cout << req->getParseError() << std::endl;
		sendStatusResponse(cl, Status(BAD_REQUEST), req->getParseError());
		return;
	}

	std::cout << "[" << cl->getClientIP() << "] " << req->methodIntToStr(req->getMethod()) << " " << req->getRequestUri() << std::endl;
	/*std::cout << "Headers:" << std::endl;
	for(int i = 0; i < req->getNumHeaders(); i++) {
		std::cout << req->getHeaderStr(i) << std::endl;
	}
	std::cout << std::endl;*/

	// Determine the appropriate vhost
	ResourceHost* resHost = NULL;
	std::string host = "";

	// Retrieve the host specified in the request (Required for HTTP/1.1 compliance)
	if (req->getVersion().compare(HTTP_VERSION_11) == 0) {
		host = req->getHeaderValue("Host");

		// All vhosts have the port appended, so need to append it to the host if it doesnt exist
		if (host.find(":") == std::string::npos) {
			host.append(":" + std::to_string(listenPort));
		}

		std::unordered_map<std::string, ResourceHost*>::const_iterator it = vhosts.find(host);

		if (it != vhosts.end())
			resHost = it->second;
	} else {
		// Temporary: HTTP/1.0 are given the first ResouceHost in the hostList
		// TODO: Allow admin to specify a 'default resource host'
		if (hostList.size() > 0)
			resHost = hostList[0];
	}

	// ResourceHost couldnt be determined or the Host specified by the client was invalid
	if (resHost == NULL) {
		sendStatusResponse(cl, Status(BAD_REQUEST), "Invalid/No Host specified: " + host);
		return;
	}

	// Send the request to the correct handler function
	switch (req->getMethod()) {
	case Method(HEAD):
	case Method(GET):
		handleGet(cl, req, resHost);
		break;
	case Method(OPTIONS):
		handleOptions(cl, req);
		break;
	case Method(TRACE):
		handleTrace(cl, req);
		break;
	default:
		std::cout << "[" << cl->getClientIP() << "] Could not handle or determine request of type " << req->methodIntToStr(req->getMethod()) << std::endl;
		sendStatusResponse(cl, Status(NOT_IMPLEMENTED));
		break;
	}
}
