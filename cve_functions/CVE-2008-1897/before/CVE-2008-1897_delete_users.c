static void delete_users(void)
{
	struct iax2_registry *reg;

	ao2_callback(users, 0, user_delme_cb, NULL);

	AST_LIST_LOCK(&registrations);
	while ((reg = AST_LIST_REMOVE_HEAD(&registrations, entry))) {
		AST_SCHED_DEL(sched, reg->expire);
		if (reg->callno) {
			ast_mutex_lock(&iaxsl[reg->callno]);
			if (iaxs[reg->callno]) {
				iaxs[reg->callno]->reg = NULL;
				iax2_destroy(reg->callno);
			}
			ast_mutex_unlock(&iaxsl[reg->callno]);
		}
		if (reg->dnsmgr)
			ast_dnsmgr_release(reg->dnsmgr);
		ast_free(reg);
	}
	AST_LIST_UNLOCK(&registrations);

	ao2_callback(peers, 0, peer_delme_cb, NULL);
}
