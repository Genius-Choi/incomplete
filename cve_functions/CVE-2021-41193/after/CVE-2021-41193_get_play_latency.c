    uint32_t audio_io_osx::get_play_latency(const AudioTimeStamp* output_time_stamp) {
        if ((output_time_stamp->mFlags & kAudioTimeStampHostTimeValid) == 0)
            return 0;
        
        UInt64 output_time_ns = AudioConvertHostTimeToNanos(
                                                            output_time_stamp->mHostTime);
        UInt64 now_ns = AudioConvertHostTimeToNanos(AudioGetCurrentHostTime());
        
        if (now_ns > output_time_ns){
            return 0;
        }
        
        double delay_ms = static_cast<double>
        (1e-6 * (output_time_ns - now_ns));
        
        return (uint32_t)delay_ms;
    }
