WUSER_HANDLE wcall_create_ex(const char *userid,
			     const char *clientid,
			     int use_mediamgr,
			     const char *msys_name,
			     wcall_ready_h *readyh,
			     wcall_send_h *sendh,
			     wcall_sft_req_h *sfth,
			     wcall_incoming_h *incomingh,
			     wcall_missed_h *missedh,
			     wcall_answered_h *answerh,
			     wcall_estab_h *estabh,
			     wcall_close_h *closeh,
			     wcall_metrics_h *metricsh,
			     wcall_config_req_h *cfg_reqh,
			     wcall_audio_cbr_change_h *acbrh,
			     wcall_video_state_change_h *vstateh,
			     void *arg)
{
	WUSER_HANDLE wuser = WUSER_INVALID_HANDLE;			
	char userid_anon[ANON_ID_LEN];
	char clientid_anon[ANON_CLIENT_LEN];
	struct calling_instance *inst = NULL;
	int err;

	if (!str_isset(userid) || !str_isset(clientid))
		return WUSER_INVALID_HANDLE;

	info(APITAG "wcall: create userid=%s clientid=%s\n",
	     anon_id(userid_anon, userid),
	     anon_client(clientid_anon, clientid));

	inst = mem_zalloc(sizeof(*inst), instance_destructor);
	if (inst == NULL) {
		err = ENOMEM;
		goto out;
	}

	wuser = create_wuser(inst);

	err = wcall_marshal_alloc(&inst->marshal);
	if (err) {
		warning("wcall_create: could not allocate marshal\n");
		goto out;
	}

	if (use_mediamgr != 0) {
		err = mediamgr_alloc(&inst->mm, mm_mcat_changed, inst);
		if (err) {
			warning("wcall: init: cannot allocate mediamgr "
				"inst=%p\n",
				inst);
			goto out;
		}
		debug("wcall: mediamgr=%p\n", inst->mm);
		mediamgr_register_route_change_h(inst->mm,
						 mm_audio_route_changed,
						 inst);
	}

	err = str_dup(&inst->userid, userid);
	if (err)
		goto out;
	
	err = str_dup(&inst->clientid, clientid);
	if (err)
		goto out;

	inst->readyh = readyh;
	inst->sendh = sendh;
	inst->sfth = sfth;
	inst->incomingh = incomingh;
	inst->missedh = missedh;
	inst->answerh = answerh;
	inst->estabh = estabh;
	inst->closeh = closeh;
	inst->metricsh = metricsh;
	inst->cfg_reqh = cfg_reqh;
	inst->vstateh = vstateh;
	inst->acbrh = acbrh;
	inst->arg = arg;

	inst->conf.econf.timeout_setup = 60000;
	inst->conf.econf.timeout_term  =  5000;
	inst->conf.trace = 0;
	
	err = lock_alloc(&inst->lock);
	if (err)
		goto out;

	uintptr_t vuser = inst->wuser;
	err = msystem_get(&inst->msys, msys_name, NULL,
			  msys_mute_handler, (void*)vuser);
	if (err) {
		warning("wcall(%p): create, cannot init msystem: %m\n",
			inst, err);
		goto out;
	}

	/* Always enable Crypto-KASE for now .. */
	msystem_enable_kase(inst->msys, true);

	err = msystem_enable_datachannel(inst->msys, true);
	if (err) {
		warning("wcall(%p): create: enable datachannel failed (%m)\n",
			inst, err);
		goto out;
	}
	
	err = config_alloc(&inst->cfg,
			   config_req_handler,
			   config_update_handler,
			   inst);
	if (err) {
		warning("wcall(%p): create: config_alloc failed (%m)\n",
			inst, err);
		goto out;		
	}

	err = config_start(inst->cfg);
	if (err) {
		warning("wcall: config_start failed (%m)\n", err);
		goto out;
	}

	lock_write_get(calling.lock);
	list_append(&calling.instances, &inst->le, inst);
	lock_rel(calling.lock);
	
	//err = async_cfg_wait(inst);

out:
	if (err) {
		wcall_i_destroy(inst);
		inst = NULL;
		wuser = WUSER_INVALID_HANDLE;
	}

	
	info(APITAG "wcall: create return inst=%p hnd=0x%08X\n",
	     inst, wuser);
	
	return wuser;
}
