    int32_t audio_io_osx::init_rec_audio_unit() {
        OSStatus result = -1;
        
        // Check if already initialized
        if (NULL != au_rec_) {
            info("audio_io_osx: Already initialized \n");
            return 0;
        }
        
        if( input_device_id_ == kAudioObjectUnknown){
            error("audio_io_osx: invalid _inputDeviceID \n");
        }
        
        Float64 nominal_sample_rate;
        UInt32 info_size = sizeof(nominal_sample_rate);
        
        static const AudioObjectPropertyAddress kNominalSampleRateAddress = {
            kAudioDevicePropertyNominalSampleRate,
            kAudioObjectPropertyScopeGlobal,
            kAudioObjectPropertyElementMaster
        };
        result = AudioObjectGetPropertyData(input_device_id_,
                                            &kNominalSampleRateAddress,
                                            0,
                                            0,
                                            &info_size,
                                            &nominal_sample_rate);
        if (result != noErr) {
            error("audio_io_osx: Failed to get device nominal sample rate for record AudioUnit \n");
        }
        
        // Start by obtaining an AudioOuputUnit using an AUHAL component description.
        AudioComponent comp;
        AudioComponentDescription desc;
        
        // Description for the Audio Unit we want to use (AUHAL in this case).
        desc.componentType = kAudioUnitType_Output;
        desc.componentSubType = kAudioUnitSubType_HALOutput;
        desc.componentManufacturer = kAudioUnitManufacturer_Apple;
        desc.componentFlags = 0;
        desc.componentFlagsMask = 0;
        comp = AudioComponentFindNext(0, &desc);
        
        // Get access to the service provided by the specified Audio Unit.
        result = AudioComponentInstanceNew(comp, &au_rec_);
        if (result) {
            error("audio_io_osx: Cannot open record AudioUnit \n");
        }
        
        UInt32 enableIO = 1;
        
        // Enable input on the AUHAL.
        result = AudioUnitSetProperty(au_rec_,
                                      kAudioOutputUnitProperty_EnableIO,
                                      kAudioUnitScope_Input,
                                      1,          // input element 1
                                      &enableIO,  // enable
                                      sizeof(enableIO));
        if (result) {
            error("audio_io_osx: Cannot enable input for record AudioUnit \n");
        }
        
        // Disable output on the AUHAL.
        enableIO = 0;
        result = AudioUnitSetProperty(au_rec_,
                                      kAudioOutputUnitProperty_EnableIO,
                                      kAudioUnitScope_Output,
                                      0,          // output element 0
                                      &enableIO,  // disable
                                      sizeof(enableIO));
        if (result) {
            error("audio_io_osx: Cannot disable output for record AudioUnit \n");
        }
        
        result = AudioUnitSetProperty(au_rec_,
                                      kAudioOutputUnitProperty_CurrentDevice,
                                      kAudioUnitScope_Global,
                                      0,
                                      &input_device_id_,
                                      sizeof(input_device_id_));
        if (result) {
            error("audio_io_osx: Cannot set current device for record AudioUnit \n");
        }
        
        AURenderCallbackStruct callback;
        callback.inputProc = rec_process;
        callback.inputProcRefCon = this;
        result = AudioUnitSetProperty(au_rec_,
                                      kAudioOutputUnitProperty_SetInputCallback,
                                      kAudioUnitScope_Global,
                                      0,
                                      &callback,
                                      sizeof(callback));
        if (result) {
            error("audio_io_osx: Cannot set input callback for record AudioUnit \n");
        }
        
        AudioStreamBasicDescription format_;
        UInt32 size = sizeof(format_);
        result = AudioUnitGetProperty(au_rec_,
                                      kAudioUnitProperty_StreamFormat,
                                      kAudioUnitScope_Output, 1, &format_,
                                      &size);
        
        format_.mSampleRate = (int)nominal_sample_rate;
        format_.mFormatID = kAudioFormatLinearPCM;
        format_.mFormatFlags    = kLinearPCMFormatFlagIsPacked |
        kLinearPCMFormatFlagIsSignedInteger;
        format_.mBitsPerChannel = sizeof(SInt16) * 8;
        format_.mChannelsPerFrame = 1;
        format_.mFramesPerPacket = 1;  // uncompressed audio
        format_.mBytesPerPacket = (format_.mBitsPerChannel *
                                   format_.mChannelsPerFrame) / 8;
        format_.mBytesPerFrame = format_.mBytesPerPacket;
        format_.mReserved = 0;
        
        result = AudioUnitSetProperty(au_rec_,
                                      kAudioUnitProperty_StreamFormat,
                                      kAudioUnitScope_Output,
                                      1,
                                      &format_,
                                      sizeof(format_));
        if (result) {
            error("audio_io_osx: Cannot set stream properties for record AudioUnit \n");
        }
        
        rec_fs_hz_ = format_.mSampleRate;
        
        UInt32 buffer_size = 0;
        UInt32 property_size = sizeof(buffer_size);
        result = AudioUnitGetProperty(au_rec_,
                                      kAudioDevicePropertyBufferFrameSize,
                                      kAudioUnitScope_Output,
                                      1,
                                      &buffer_size,
                                      &property_size);
        if (result != noErr) {
            error("audio_io_osx: Cannot get callback buffer size for record AudioUnit \n");
        }
        
        buffer_size = rec_fs_hz_/100;
        result = AudioUnitSetProperty(au_rec_,
                                      kAudioDevicePropertyBufferFrameSize,
                                      kAudioUnitScope_Output,
                                      1,
                                      &buffer_size,
                                      sizeof(buffer_size));
        if (result != noErr) {
            error("audio_io_osx: Cannot set callback buffer size for record AudioUnit \n");
        }
        
        result = AudioUnitInitialize(au_rec_);
        if (result) {
            error("audio_io_osx: Cannot initialize record AudioUnit \n");
        }
        
        return 0;
    }
