static void icall_close_handler(struct icall *icall, int err,
				const char *metrics_json, uint32_t msg_time,
				const char *userid, const char *clientid,
				void *arg)
{
	struct wcall *wcall = arg;
	struct calling_instance *inst = wcall ? wcall->inst : NULL;
	int reason;

	if (!WCALL_VALID(wcall)) {
		warning("wcall(%p): icall_close_handler: invalid wcall "
			"inst=%p\n", wcall, inst);
		return;
	}
	
	reason = err2reason(err);

	info(APITAG "wcall(%p): closeh(%p) group=no state=%s reason=%s\n",
	     wcall, inst->closeh, wcall_state_name(wcall->state),
	     wcall_reason_name(reason));

	
	/* If the call was already rejected, we don't want to
	 * do anything here
	 */
	if (wcall->state == WCALL_STATE_NONE)
		goto out;

	if (wcall->state != WCALL_STATE_TERM_LOCAL) {
		set_state(wcall, WCALL_STATE_TERM_REMOTE);
	}

	if (!userid) {
		userid = inst->userid;
	}
	set_state(wcall, WCALL_STATE_NONE);
	if (inst->closeh) {
		uint64_t now = tmr_jiffies();
		inst->closeh(reason, wcall->convid,
			     msg_time, userid, clientid, inst->arg);
		info(APITAG "wcall(%p): closeh took %llu ms\n",
		     wcall, tmr_jiffies() - now);
	}

	info(APITAG "wcall(%p): metricsh(%p) json=%p\n", wcall, inst->metricsh, metrics_json);

	if (inst->metricsh && metrics_json) {
		uint64_t now = tmr_jiffies();
		inst->metricsh(wcall->convid, metrics_json, inst->arg);
		info(APITAG "wcall(%p): metricsh took %llu ms\n",
		     wcall, tmr_jiffies() - now);
	}
out:
	mem_deref(wcall);
}
