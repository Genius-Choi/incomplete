njs_regexp_optional_test(njs_unit_test_t tests[], size_t num, njs_str_t *name,
    njs_opts_t *opts, njs_stat_t *stat)
{
    njs_bool_t  safe;

#ifndef NJS_HAVE_PCRE2
    int         erroff;
    pcre        *re1, *re2;
    const char  *errstr;

    /*
     * pcre-8.21 crashes when it compiles unicode escape codes inside
     * square brackets when PCRE_UTF8 option is provided.
     * Catching it in runtime by compiling it without PCRE_UTF8. Normally it
     * should return NULL and "character value in \u.... sequence is too large"
     * error string.
     */
    re1 = pcre_compile("/[\\u0410]/", PCRE_JAVASCRIPT_COMPAT, &errstr, &erroff,
                      NULL);

    if (re1 != NULL) {
        pcre_free(re1);
    }

    /*
     * pcre-7.8 fails to compile unicode escape codes inside square brackets
     * even when PCRE_UTF8 option is provided.
     */
    re2 = pcre_compile("/[\\u0410]/", PCRE_JAVASCRIPT_COMPAT | PCRE_UTF8,
                       &errstr, &erroff, NULL);

    if (re2 != NULL) {
        pcre_free(re2);
    }

    safe = (re1 == NULL && re2 != NULL);

#else

    safe = 1;

#endif

    if (safe) {
        return njs_unit_test(tests, num, name, opts, stat);
    }

    njs_printf("regexp optional tests skipped\n");

    return NJS_OK;
}
