static int filter_mntopts(const char *opts, char **filtered,
		unsigned long *mountflags)
{
    size_t origlen = strlen(opts);
    const char *end;
    char *dest;

    dest = *filtered = NULL;
    *mountflags = 0;

    if (origlen == 0)
	return 0;

    do {
	size_t len;
	unsigned int i;

	end = strchr(opts, ',');
	if (end == NULL) {
	    len = strlen(opts);
	} else {
	    len = end - opts;
	}

	for (i = 0; i < PAM_ARRAY_SIZE(mntflags); i++) {
	    if (mntflags[i].len != len)
		continue;
	    if (memcmp(mntflags[i].name, opts, len) == 0) {
		*mountflags |= mntflags[i].flag;
		opts = end;
		break;
	    }
	}

	if (opts != end) {
	    if (dest != NULL) {
		*dest = ',';
		++dest;
	    } else {
		dest = *filtered = calloc(1, origlen + 1);
		if (dest == NULL)
		    return -1;
	    }
	    memcpy(dest, opts, len);
	    dest += len;
	}

	opts = end + 1;
    } while (end != NULL);

    return 0;
}
