streamAssociatePDU(PRV_ASSOCIATEPDU * assoc, unsigned char *b,
                   unsigned long /*maxLength*/, unsigned long *rtnLen)
{
    unsigned long subLength;

    *b++ = assoc->type;
    *b++ = assoc->rsv1;
    COPY_LONG_BIG(assoc->length, b);
    b += 4;
    COPY_SHORT_BIG(assoc->protocol, b);
    b += 2;
    *b++ = assoc->rsv2[0];
    *b++ = assoc->rsv2[1];
    (void) memset(b, ' ', 32);

    // we don't copy the zero bytes at the end of the AEtitle strings
    // since the PDU requires a space-padded, non zero-padded string.
    size_t len = strlen(assoc->calledAPTitle);
    if (len > 16) len = 16;
    memcpy(b, assoc->calledAPTitle, len);
    b += 16;
    len = strlen(assoc->callingAPTitle);
    if (len > 16) len = 16;
    memcpy(b, assoc->callingAPTitle, len);
    b += 16;
    (void) memset(b, 0, 32);
    b += 32;

    *rtnLen = 1 + 1 + 4 + 2 + 2 + 16 + 16 + 32;

    OFCondition cond = streamSubItem(&assoc->applicationContext, b, &subLength);
    if (cond.bad())
        return cond;

    b += subLength;
    *rtnLen += subLength;
    cond = streamPresentationContext(&assoc->presentationContextList,
             b, &subLength);

    if (cond.bad())
        return cond;

    b += subLength;
    *rtnLen += subLength;
    cond = streamUserInfo(&assoc->userInfo, b, &subLength);
    if (cond.bad())
        return cond;

    b += subLength;
    *rtnLen += subLength;

    return EC_Normal;
}
