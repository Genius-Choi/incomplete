FindGoodListeningPortAddress(const HttpRequest *callerRequest, const AccessLogEntry *ale, const Filter filter)
{
    // Check all sources of usable listening port information, giving
    // HttpRequest and masterXaction a preference over ALE.

    const HttpRequest *request = callerRequest;
    if (!request && ale)
        request = ale->request;
    if (!request)
        return nullptr; // not enough information

    auto ip = FindGoodListeningPortAddressInPort(request->masterXaction->squidPort, filter);
    if (!ip && ale)
        ip = FindGoodListeningPortAddressInPort(ale->cache.port, filter);

    // XXX: also handle PROXY protocol here when we have a flag to identify such request
    if (ip || request->flags.interceptTproxy || request->flags.intercepted)
        return ip;

    /* handle non-intercepted cases that were not handled above */
    ip = FindGoodListeningPortAddressInConn(request->masterXaction->tcpClient, filter);
    if (!ip && ale)
        ip = FindGoodListeningPortAddressInConn(ale->tcpClient, filter);
    return ip; // may still be nil
}
