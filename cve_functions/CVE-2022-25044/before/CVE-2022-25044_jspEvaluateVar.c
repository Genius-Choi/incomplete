JsVar *jspEvaluateVar(JsVar *str, JsVar *scope, uint16_t lineNumberOffset) {
  JsLex lex;

  assert(jsvIsString(str));
  JsLex *oldLex = jslSetLex(&lex);
  jslInit(str);
#ifndef ESPR_NO_LINE_NUMBERS
  lex.lineNumberOffset = lineNumberOffset;
#endif


  JsExecInfo oldExecInfo = execInfo;
  execInfo.execute = EXEC_YES;
  if (scope) {
    // if we're adding a scope, make sure it's the *only* scope
    execInfo.scopesVar = 0;
    if (scope!=execInfo.root) jspeiAddScope(scope); // it's searched by default anyway
  }

  // actually do the parsing
  JsVar *v = jspParse();
  // clean up
  if (scope) jspeiClearScopes();
  jslKill();
  jslSetLex(oldLex);

  // restore state and execInfo (keep error flags & ctrl-c)
  oldExecInfo.execute |= execInfo.execute & EXEC_PERSIST;
  execInfo = oldExecInfo;

  // It may have returned a reference, but we just want the value...
  return jsvSkipNameAndUnLock(v);
}
