void jsvDefragment() {
  // garbage collect - removes cruft
  // also puts free list in order
  jsvGarbageCollect();
  // Fill defragVars with defraggable variables
  jshInterruptOff();
  const int DEFRAGVARS = 256; // POWER OF 2
  JsVarRef defragVars[DEFRAGVARS];
  memset(defragVars, 0, sizeof(defragVars));
  int defragVarIdx = 0;
  for (int i=0;i<jsvGetMemoryTotal();i++) {
    JsVarRef vr = i+1;
    JsVar *v = _jsvGetAddressOf(vr);
    if ((v->flags&JSV_VARTYPEMASK)!=JSV_UNUSED) {
      if (jsvIsFlatString(v)) {
        i += jsvGetFlatStringBlocks(v); // skip forward
      } else if (jsvGetLocks(v)==0) {
        defragVars[defragVarIdx] = vr;
        defragVarIdx = (defragVarIdx+1) & (DEFRAGVARS-1);
      }
    }
  }
  // Now go through defragVars defragging them
  defragVarIdx--;
  if (defragVarIdx<0) defragVarIdx+=DEFRAGVARS;
  while (defragVars[defragVarIdx]) {
    JsVarRef defragFromRef = defragVars[defragVarIdx];
    JsVarRef defragToRef = jsVarFirstEmpty;
    if (!defragToRef || defragFromRef<defragToRef) {
      // we're done!
      break;
    }
    // relocate!
    JsVar *defragFrom = _jsvGetAddressOf(defragFromRef);
    JsVar *defragTo = _jsvGetAddressOf(defragToRef);
    jsVarFirstEmpty = jsvGetNextSibling(defragTo); // move our reference to the next in the free list
    // copy data
    *defragTo = *defragFrom;
    defragFrom->flags = JSV_UNUSED;
    // find references!
    for (int i=0;i<jsvGetMemoryTotal();i++) {
      JsVarRef vr = i+1;
      JsVar *v = _jsvGetAddressOf(vr);
      if ((v->flags&JSV_VARTYPEMASK)!=JSV_UNUSED) {
        if (jsvIsFlatString(v)) {
          i += jsvGetFlatStringBlocks(v); // skip forward
        } else {
          if (jsvHasSingleChild(v))
            if (jsvGetFirstChild(v)==defragFromRef)
              jsvSetFirstChild(v,defragToRef);
          if (jsvHasStringExt(v))
            if (jsvGetLastChild(v)==defragFromRef)
              jsvSetLastChild(v,defragToRef);
          if (jsvHasChildren(v)) {
            if (jsvGetFirstChild(v)==defragFromRef)
              jsvSetFirstChild(v,defragToRef);
            if (jsvGetLastChild(v)==defragFromRef)
              jsvSetLastChild(v,defragToRef);
          }
          if (jsvIsName(v)) {
            if (jsvGetNextSibling(v)==defragFromRef)
              jsvSetNextSibling(v,defragToRef);
            if (jsvGetPrevSibling(v)==defragFromRef)
              jsvSetPrevSibling(v,defragToRef);
          }
        }
      }
    }
    // zero element and move to next...
    defragVars[defragVarIdx] = 0;
    defragVarIdx--;
    if (defragVarIdx<0) defragVarIdx+=DEFRAGVARS;
  }
  // rebuild free var list
  jsvCreateEmptyVarList();
  jshInterruptOn();
}
