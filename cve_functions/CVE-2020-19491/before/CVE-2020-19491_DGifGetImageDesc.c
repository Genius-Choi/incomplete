int CGIFFF DGifGetImageDesc(CGIFFF GifFileType *GifFile)
{
    int i, BitsPerPixel;
    GifByteType Buf[3];
    GifImageDesc Image;
    GifFilePrivateType *Private = (GifFilePrivateType *) GifFile->Private;
    memset(&Image, 0, sizeof(Image));

    if (!IS_READABLE(Private)) {
	/* This file was NOT open for reading: */
	_GifError = D_GIF_ERR_NOT_READABLE;
	return GIF_ERROR;
    }

    if (DGifGetWord(Private->File, &Image.Left) == GIF_ERROR ||
	DGifGetWord(Private->File, &Image.Top) == GIF_ERROR ||
	DGifGetWord(Private->File, &Image.Width) == GIF_ERROR ||
	DGifGetWord(Private->File, &Image.Height) == GIF_ERROR)
	return GIF_ERROR;
    if (fread(Buf, 1, 1, Private->File) != 1) {
	_GifError = D_GIF_ERR_READ_FAILED;
	return GIF_ERROR;
    }
    BitsPerPixel = (Buf[0] & 0x07) + 1;
    Image.Interlace = (Buf[0] & 0x40);
    if (Buf[0] & 0x80) {	    /* Does this image have local color map? */

	if (Image.ColorMap && GifFile->SavedImages == NULL)
	    FreeMapObject(Image.ColorMap);

	Image.ColorMap = MakeMapObject(1 << BitsPerPixel, NULL);

	/* Get the image local color map: */
	for (i = 0; i < Image.ColorMap->ColorCount; i++) {
	    if (fread(Buf, 1, 3, Private->File) != 3) {
		_GifError = D_GIF_ERR_READ_FAILED;
		return GIF_ERROR;
	    }
	    Image.ColorMap->Colors[i].Red = Buf[0];
	    Image.ColorMap->Colors[i].Green = Buf[1];
	    Image.ColorMap->Colors[i].Blue = Buf[2];
	}
    }

    /**** pts ****/
    if (NULL!=GifFile->SavedImages) {
      GifFile->SavedImages = (SavedImage *)xrealloc(GifFile->SavedImages,
		    sizeof(SavedImage) * (GifFile->ImageCount + 1));
    } else {
      assert(GifFile->ImageCount==0);
      GifFile->SavedImages = (SavedImage *)xmalloc(sizeof(SavedImage));
    }

    {
	SavedImage	*sp;
	sp = &GifFile->SavedImages[GifFile->ImageCount];
	memcpy(&sp->ImageDesc, &Image, sizeof(GifImageDesc));
	sp->RasterBits = (GifPixelType *)NULL;
	sp->ExtensionBlockCount = 0;
	sp->ExtensionBlocks = (ExtensionBlock *)NULL;
        sp->delay=0;
        sp->dispose=0;
        sp->iter=1;
        sp->transp=(-1);
    }

    GifFile->ImageCount++;

    Private->PixelCount = (long) Image.Width *
			    (long) Image.Height;

    /* Reset decompress algorithm parameters. */
    if (DGifSetupDecompress(GifFile)==GIF_ERROR) {
      _GifError = D_GIF_ERR_READ_FAILED;
      return GIF_ERROR;
    }

    return GIF_OK;
}
