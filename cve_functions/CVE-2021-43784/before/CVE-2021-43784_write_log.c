static void write_log(int level, const char *format, ...)
{
	char *message = NULL, *stage = NULL, *json = NULL;
	va_list args;
	int ret;

	if (logfd < 0 || level > loglevel)
		goto out;

	va_start(args, format);
	ret = vasprintf(&message, format, args);
	va_end(args);
	if (ret < 0) {
		message = NULL;
		goto out;
	}

	message = escape_json_string(message);

	if (current_stage == STAGE_SETUP)
		stage = strdup("nsexec");
	else
		ret = asprintf(&stage, "nsexec-%d", current_stage);
	if (ret < 0) {
		stage = NULL;
		goto out;
	}

	ret = asprintf(&json, "{\"level\":\"%s\", \"msg\": \"%s[%d]: %s\"}\n",
		       level_str[level], stage, getpid(), message);
	if (ret < 0) {
		json = NULL;
		goto out;
	}

	/* This logging is on a best-effort basis. In case of a short or failed
	 * write there is nothing we can do, so just ignore write() errors.
	 */
	ssize_t __attribute__((unused)) __res = write(logfd, json, ret);

out:
	free(message);
	free(stage);
	free(json);
}
