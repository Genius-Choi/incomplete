compute_allids_limit( Slapi_PBlock *pb, struct ldbminfo *li )
{
    Slapi_Connection    *conn = NULL;
    int                 limit;
    Slapi_Operation *op;

    slapi_pblock_get( pb, SLAPI_CONNECTION, &conn);
    slapi_pblock_get( pb, SLAPI_OPERATION, &op);

    if ( slapi_reslimit_get_integer_limit( conn,
            li->li_reslimit_allids_handle, &limit )
            != SLAPI_RESLIMIT_STATUS_SUCCESS ) {
        PR_Lock(li->li_config_mutex);
        limit = li->li_allidsthreshold;
        PR_Unlock(li->li_config_mutex);
    }
    if (op_is_pagedresults(op)) {
        if ( slapi_reslimit_get_integer_limit( conn,
                li->li_reslimit_pagedallids_handle, &limit )
             != SLAPI_RESLIMIT_STATUS_SUCCESS ) {
            PR_Lock(li->li_config_mutex);
            if (li->li_pagedallidsthreshold) {
                limit = li->li_pagedallidsthreshold;
            }
            PR_Unlock(li->li_config_mutex);
        }
    }
    return( limit );
}
