check_ip_ratelimit(struct sockaddr_storage* addr, socklen_t addrlen,
	struct sldns_buffer* buffer, int premax, int max, int has_cookie)
{
	int limit;

	if(has_cookie) limit = infra_ip_ratelimit_cookie;
	else           limit = infra_ip_ratelimit;

	/* Disabled */
	if(limit == 0) return 1;

	if(premax <= limit && max > limit) {
		char client_ip[128], qnm[LDNS_MAX_DOMAINLEN+1+12+12];
		addr_to_str(addr, addrlen, client_ip, sizeof(client_ip));
		qnm[0]=0;
		if(sldns_buffer_limit(buffer)>LDNS_HEADER_SIZE &&
			LDNS_QDCOUNT(sldns_buffer_begin(buffer))!=0) {
			(void)sldns_wire2str_rrquestion_buf(
				sldns_buffer_at(buffer, LDNS_HEADER_SIZE),
				sldns_buffer_limit(buffer)-LDNS_HEADER_SIZE,
				qnm, sizeof(qnm));
			if(strlen(qnm)>0 && qnm[strlen(qnm)-1]=='\n')
				qnm[strlen(qnm)-1] = 0; /*remove newline*/
			if(strchr(qnm, '\t'))
				*strchr(qnm, '\t') = ' ';
			if(strchr(qnm, '\t'))
				*strchr(qnm, '\t') = ' ';
			verbose(VERB_OPS, "ip_ratelimit exceeded %s %d%s %s",
				client_ip, limit,
				has_cookie?"(cookie)":"", qnm);
		} else {
			verbose(VERB_OPS, "ip_ratelimit exceeded %s %d%s (no query name)",
				client_ip, limit,
				has_cookie?"(cookie)":"");
		}
	}
	return (max <= limit);
}
