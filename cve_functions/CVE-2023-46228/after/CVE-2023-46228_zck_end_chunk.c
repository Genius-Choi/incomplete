ssize_t ZCK_PUBLIC_API zck_end_chunk(zckCtx *zck) {
    VALIDATE_WRITE_INT(zck);

    if(!zck->comp.started && !comp_init(zck))
        return -1;

    if(zck->comp.dc_data_size < zck->chunk_min_size) {
        zck_log(ZCK_LOG_DDEBUG, "Chunk too small, refusing to end chunk");
        return zck->comp.dc_data_size;
    }

    buzhash_reset(&(zck->buzhash));
    /* No point in compressing empty data */
    if(zck->comp.dc_data_size == 0)
        return 0;

    size_t data_size = zck->comp.dc_data_size;
    char *dst = NULL;
    size_t dst_size = 0;
    if(!zck->comp.end_cchunk(zck, &(zck->comp), &dst, &dst_size, 1))
        return -1;
    zck->comp.dc_data_size = 0;
    if(zck->no_write == 0 && dst_size > 0 && !write_data(zck, zck->temp_fd, dst, dst_size)) {
        free(dst);
        return -1;
    }
    if(!index_add_to_chunk(zck, dst, dst_size, 0)) {
        free(dst);
        return -1;
    }
    if(!index_finish_chunk(zck)) {
        free(dst);
        return -1;
    }
    zck_log(ZCK_LOG_DDEBUG, "Finished chunk size: %llu", (long long unsigned) data_size);
    free(dst);
    return data_size;
}
