bool comp_init(zckCtx *zck) {
    VALIDATE_BOOL(zck);

    zckComp *comp = &(zck->comp);

    if(zck->comp.started) {
        set_error(zck, "Compression already initialized");
        return false;
    }
    if((zck->comp.dict && zck->comp.dict_size == 0) ||
       (zck->comp.dict == NULL && zck->comp.dict_size > 0)) {
        set_error(zck, "Invalid dictionary configuration");
        return false;
    }
    zck_log(ZCK_LOG_DEBUG, "Initializing %s compression",
            zck_comp_name_from_type(comp->type));
    if(!zck->comp.init(zck, &(zck->comp)))
        return false;
    if(zck->mode == ZCK_MODE_WRITE) {
        if(zck->chunk_min_size == 0) {
            zck->chunk_min_size = CHUNK_DEFAULT_MIN;
            zck_log(ZCK_LOG_DEBUG, "Using default minimum chunk size of %llu",
                    (long long unsigned) zck->chunk_min_size);
        }
        if(zck->chunk_max_size == 0) {
            zck->chunk_max_size = CHUNK_DEFAULT_MAX;
            zck_log(ZCK_LOG_DEBUG, "Using default maximum chunk size of %llu",
                    (long long unsigned) zck->chunk_max_size);
        }
        if(zck->manual_chunk == 0) {
            zck_log(ZCK_LOG_DEBUG, "Using buzhash algorithm for chunking");
            zck->buzhash_width = DEFAULT_BUZHASH_WIDTH;
            zck->buzhash_match_bits = DEFAULT_BUZHASH_BITS;
            update_buzhash_bits(zck);
            zck_log(ZCK_LOG_DEBUG, "Setting average chunk size to %llu",
                    (long long unsigned) zck->buzhash_bitmask + 1);
            zck->chunk_auto_min = (zck->buzhash_bitmask + 1) / 4;
            if(zck->chunk_auto_min < zck->chunk_min_size)
                zck->chunk_auto_min = zck->chunk_min_size;
            zck_log(ZCK_LOG_DEBUG, "Setting automatic minimum chunk size to %llu",
                    (long long unsigned) zck->chunk_auto_min);
            zck->chunk_auto_max = (zck->buzhash_bitmask + 1) * 4;
            if(zck->chunk_auto_max > zck->chunk_max_size)
                zck->chunk_auto_max = zck->chunk_max_size;
            zck_log(ZCK_LOG_DEBUG, "Setting automatic maximum chunk size to %llu",
                    (long long unsigned) zck->chunk_auto_max);
        }
    }

    if(zck->temp_fd || zck->no_write) {
        if(zck->comp.dict) {
            char *dst = NULL;
            size_t dst_size = 0;

            if(zck->comp.compress(zck, comp, zck->comp.dict,
                                  zck->comp.dict_size, &dst, &dst_size, 0) < 0)
                return false;
            zck->comp.dc_data_size = zck->comp.dict_size;
            if(zck->no_write == 0 && !write_data(zck, zck->temp_fd, dst, dst_size)) {
                free(dst);
                return false;
            }
            if(!index_add_to_chunk(zck, dst, dst_size,
                                       zck->comp.dict_size)) {
                free(dst);
                return false;
            }
            free(dst);
            dst = NULL;
            dst_size = 0;

            if(!zck->comp.end_cchunk(zck, comp, &dst, &dst_size, 0))
                return false;
            zck->comp.dc_data_size = 0;
            if(zck->no_write == 0 && !write_data(zck, zck->temp_fd, dst, dst_size)) {
                free(dst);
                return false;
            }
            if(!index_add_to_chunk(zck, dst, dst_size, 0) ||
               !index_finish_chunk(zck)) {
                free(dst);
                return false;
            }
            free(dst);
        } else {
            if(!index_finish_chunk(zck))
                return false;
        }
    }
    zck->comp.started = true;
    return true;
}
