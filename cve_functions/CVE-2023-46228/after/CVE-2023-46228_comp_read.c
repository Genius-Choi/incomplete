ssize_t comp_read(zckCtx *zck, char *dst, size_t dst_size, bool use_dict) {
    VALIDATE_READ_INT(zck);

    if(!zck->comp.started) {
        set_error(zck, "Compression hasn't been initialized yet");
        return -1;
    }

    if(dst_size == 0)
        return 0;

    /* Read dictionary if it exists and hasn't been read yet */
    if(use_dict && zck->index.first->length > 0 && zck->comp.dict == NULL &&
       !import_dict(zck))
        return -1;

    size_t dc = 0;
    char *src = zmalloc(dst_size - dc);
    if (!src) {
        zck_log(ZCK_LOG_ERROR, "OOM in %s", __func__);
        return false;
    }
    bool finished_rd = false;
    bool finished_dc = false;
    zck_log(ZCK_LOG_DEBUG, "Trying to read %llu bytes", (long long unsigned) dst_size);
    while(dc < dst_size) {
        /* Get bytes from decompressed buffer */
        ssize_t rb = comp_read_from_dc(zck, &(zck->comp), dst+dc, dst_size-dc);
        if(rb < 0)
            goto read_error;
        dc += rb;
        if(dc == dst_size)
            break;
        if(rb > 0)
            continue;
        if(finished_dc || zck->comp.data_eof)
            break;

        /* Decompress compressed buffer into decompressed buffer */
        size_t dc_data_size = zck->comp.dc_data_size;
        size_t dc_data_loc = zck->comp.dc_data_loc;
        if(zck->comp.data_size > 0 &&
           !zck->comp.decompress(zck, &(zck->comp), use_dict))
            goto read_error;

        /* Check whether we decompressed more data */
        if(zck->comp.dc_data_size != dc_data_size ||
           zck->comp.dc_data_loc != dc_data_loc)
            continue;

        /* End decompression chunk if we're on a chunk boundary */
        if(zck->comp.data_idx == NULL) {
            zck->comp.data_idx = zck->index.first;
            /* Skip first chunk if it's an empty dict */
            if(zck->comp.data_idx->comp_length == 0)
                zck->comp.data_idx = zck->comp.data_idx->next;
            if(!hash_init(zck, &(zck->check_chunk_hash),
                          &(zck->chunk_hash_type)))
                goto hash_error;
            if(zck->comp.data_loc > 0) {
                if(!zck->has_uncompressed_source) {
                    if(!hash_update(zck, &(zck->check_full_hash), zck->comp.data,
                                    zck->comp.data_loc))
                        goto hash_error;
                }
                if(!hash_update(zck, &(zck->check_chunk_hash), zck->comp.data,
                                zck->comp.data_loc))
                    goto hash_error;
            }
            if(zck->comp.data_idx == NULL) {
                free(src);
                return 0;
            }
        }
        if(zck->comp.data_loc == zck->comp.data_idx->comp_length) {
            if(!comp_end_dchunk(zck, use_dict, zck->comp.data_idx->length)) {
                free(src);
                return -1;
            }
            if(zck->comp.data_idx == NULL)
                zck->comp.data_eof = true;
            continue;
        }

        /* If we finished reading and we've reached here, we're done
         * decompressing */
        if(finished_rd) {
            finished_dc = true;
            continue;
        }

        /* Make sure we don't read beyond current chunk length */
        size_t rs = dst_size;
        if(zck->comp.data_loc + rs > zck->comp.data_idx->comp_length)
            rs = zck->comp.data_idx->comp_length - zck->comp.data_loc;

        /* Decompressed buffer is empty, so read data from file and fill
         * compressed buffer */
        rb = read_data(zck, src, rs);
        if(rb < 0)
            goto read_error;
        if(rb < rs) {
            zck_log(ZCK_LOG_DDEBUG, "EOF");
            finished_rd = true;
        }
        if(zck->check_chunk_hash.ctx == NULL)
            if(!hash_init(zck, &(zck->check_chunk_hash),
                          &(zck->chunk_hash_type)))
                goto hash_error;
        if(!zck->has_uncompressed_source) {
            if(!hash_update(zck, &(zck->check_full_hash), src, rb))
                goto read_error;
        }
        if(!hash_update(zck, &(zck->check_chunk_hash), src, rb) ||
           !comp_add_to_data(zck, &(zck->comp), src, rb))
            goto read_error;
    }
    free(src);
    return dc;
read_error:
    free(src);
    return -1;
hash_error:
    free(src);
    return -2;
}
