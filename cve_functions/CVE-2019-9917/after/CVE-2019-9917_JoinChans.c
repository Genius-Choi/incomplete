void CIRCNetwork::JoinChans(set<CChan*>& sChans) {
    CString sKeys, sJoin;
    bool bHaveKey = false;
    size_t uiJoinLength = strlen("JOIN ");

    while (!sChans.empty()) {
        set<CChan*>::iterator it = sChans.begin();
        const CString& sName = (*it)->GetName();
        const CString& sKey = (*it)->GetKey();
        size_t len = sName.length() + sKey.length();
        len += 2;  // two comma

        if (!sKeys.empty() && uiJoinLength + len >= 512) break;

        if (!sJoin.empty()) {
            sJoin += ",";
            sKeys += ",";
        }
        uiJoinLength += len;
        sJoin += sName;
        if (!sKey.empty()) {
            sKeys += sKey;
            bHaveKey = true;
        }
        sChans.erase(it);
    }

    if (bHaveKey)
        PutIRC("JOIN " + sJoin + " " + sKeys);
    else
        PutIRC("JOIN " + sJoin);
}
