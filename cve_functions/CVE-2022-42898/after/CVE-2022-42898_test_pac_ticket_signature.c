test_pac_ticket_signature(krb5_context context)
{
    krb5_error_code ret;
    krb5_ticket *ticket;
    krb5_principal sprinc;
    krb5_authdata **authdata1, **authdata2;
    krb5_pac pac, pac2, pac3;
    uint32_t *list;
    size_t len, i;
    krb5_data data;

    ret = krb5_decode_ticket(&ticket_data, &ticket);
    if (ret)
        err(context, ret, "while decoding ticket");

    ret = krb5_decrypt_tkt_part(context, &ticket_sig_server_key, ticket);
    if (ret)
        err(context, ret, "while decrypting ticket");

    ret = krb5_parse_name(context, "s1@CDOM.COM", &sprinc);
    if (ret)
        err(context, ret, "krb5_parse_name");

    ret = krb5_kdc_verify_ticket(context, ticket->enc_part2, sprinc,
                                 &ticket_sig_server_key,
                                 &ticket_sig_krbtgt_key, &pac);
    if (ret)
        err(context, ret, "while verifying ticket");

    /* In this test, the server is also the client. */
    ret = krb5_pac_verify(context, pac, ticket->enc_part2->times.authtime,
                          ticket->server, NULL, NULL);
    if (ret)
        err(context, ret, "while verifying PAC client info");

    /* We know there is only a PAC in this test's ticket. */
    authdata1 = ticket->enc_part2->authorization_data;
    ticket->enc_part2->authorization_data = NULL;

    ret = krb5_kdc_sign_ticket(context, ticket->enc_part2, pac, sprinc,
                               sprinc, &ticket_sig_server_key,
                               &ticket_sig_krbtgt_key, FALSE);
    if (ret)
        err(context, ret, "while signing ticket");

    authdata2 = ticket->enc_part2->authorization_data;
    assert(authdata2 != NULL);
    assert(authdata2[1] == NULL);

    assert(authdata1[0]->length == authdata2[0]->length);
    assert(memcmp(authdata1[0]->contents, authdata2[0]->contents,
                  authdata1[0]->length) == 0);

    /* Test adding signatures to a new PAC. */
    ret = krb5_pac_init(context, &pac2);
    if (ret)
        err(context, ret, "krb5_pac_init");

    ret = krb5_pac_get_types(context, pac, &len, &list);
    if (ret)
        err(context, ret, "krb5_pac_get_types");

    for (i = 0; i < len; i++) {
        /* Skip server_cksum, privsvr_cksum, and ticket_cksum. */
        if (list[i] == 6 || list[i] == 7 || list[i] == 16)
            continue;

        ret = krb5_pac_get_buffer(context, pac, list[i], &data);
        if (ret)
            err(context, ret, "krb5_pac_get_buffer");

        ret = krb5_pac_add_buffer(context, pac2, list[i], &data);
        if (ret)
            err(context, ret, "krb5_pac_add_buffer");

        krb5_free_data_contents(context, &data);
    }
    free(list);

    krb5_free_authdata(context, authdata1);
    krb5_free_authdata(context, ticket->enc_part2->authorization_data);
    ticket->enc_part2->authorization_data = NULL;

    ret = krb5_kdc_sign_ticket(context, ticket->enc_part2, pac2, sprinc, NULL,
                               &ticket_sig_server_key, &ticket_sig_krbtgt_key,
                               FALSE);
    if (ret)
        err(context, ret, "while signing ticket");

    /* We can't compare the data since the order of the buffers may differ. */
    ret = krb5_kdc_verify_ticket(context, ticket->enc_part2, sprinc,
                                 &ticket_sig_server_key,
                                 &ticket_sig_krbtgt_key, &pac3);
    if (ret)
        err(context, ret, "while verifying ticket");

    krb5_pac_free(context, pac);
    krb5_pac_free(context, pac2);
    krb5_pac_free(context, pac3);
    krb5_free_principal(context, sprinc);
    krb5_free_ticket(context, ticket);
}
