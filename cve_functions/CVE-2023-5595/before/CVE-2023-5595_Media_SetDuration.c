GF_Err Media_SetDuration(GF_TrackBox *trak)
{
	GF_Err e;
	GF_ESD *esd;
	u64 DTS;
	u32 nbSamp, dur;

	if (!trak || !trak->Media || !trak->Media->information || !trak->Media->information->sampleTable)
		return GF_ISOM_INVALID_FILE;

	if (!trak->Media->information->sampleTable->SampleSize || !trak->Media->information->sampleTable->TimeToSample)
		return GF_ISOM_INVALID_FILE;

	nbSamp = trak->Media->information->sampleTable->SampleSize->sampleCount;

	if (nbSamp == 0) {
		trak->Media->mediaHeader->duration = 0;
		if (Track_IsMPEG4Stream(trak->Media->handler->handlerType)) {
			Media_GetESD(trak->Media, 1, &esd, 1);
			if (esd && esd->URLString) trak->Media->mediaHeader->duration = (u64) -1;
		}
		return GF_OK;
	}

	//get last sample
	e = stbl_GetSampleDTS_and_Duration(trak->Media->information->sampleTable->TimeToSample, nbSamp, &DTS, &dur);
	if (e < 0) return e;
	DTS += dur;

	//do not do that for old arch compat which was not taking into account cts offset
	if (gf_sys_old_arch_compat() || !trak->Media->information->sampleTable->CompositionOffset) {
		trak->Media->mediaHeader->duration = DTS;
		return GF_OK;
	}
	//try to set duration according to spec: "should be the largest composition timestamp plus the duration of that sample"
	s32 cts_o;
	stbl_GetSampleCTS(trak->Media->information->sampleTable->CompositionOffset, nbSamp, &cts_o);
	if (cts_o>0) DTS += cts_o;
	if (DTS>trak->Media->mediaHeader->duration)
		trak->Media->mediaHeader->duration = DTS;

	//this can be more precise in some corner cases but takes way too long - we keep code for reference
#if 0
	//browse from sample_num_max_cts_delta (updated in read and edit to point to sample number with max cts offset)
	u32 s_idx, min = trak->Media->information->sampleTable->CompositionOffset->sample_num_max_cts_delta;
	if (!min) return GF_OK;
	for (s_idx=min; s_idx<=nbSamp; s_idx++) {
		u64 a_dts;
		u32 a_dur;
		s32 cts_o;
		stbl_GetSampleCTS(trak->Media->information->sampleTable->CompositionOffset, s_idx, &cts_o);
		if (cts_o<=0) continue;
		stbl_GetSampleDTS_and_Duration(trak->Media->information->sampleTable->TimeToSample, s_idx, &a_dts, &a_dur);
		if (a_dts + a_dur + (u32) cts_o > DTS) {
			DTS = a_dts + (u32) cts_o + a_dur;
		}
	}
	trak->Media->mediaHeader->duration = DTS;
#endif
	return GF_OK;
}
