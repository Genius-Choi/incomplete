R_API char *r_str_wrap(const char *str, int w) {
	char *r, *ret;
	if (w < 1 || !str) {
		return strdup ("");
	}
	size_t r_size = 8 * strlen (str);
	r = ret = malloc (r_size);
	if (!r) {
		return NULL;
	}
	char *end = r + r_size;
	int cw = 0;
	while (*str && r + 1 < end) {
		size_t ansilen = __str_ansi_length (str);
		if (ansilen > 1) {
			memcpy (r, str, ansilen);
			str += ansilen;
			r += ansilen;
			continue;
		}
		if (*str == '\t') {
			// skip
		} else if (*str == '\r') {
			// skip
		} else if (*str == '\n') {
			*r++ = *str++;
			cw = 0;
		} else {
			if (cw > w) {
				*r++ = '\n';
				*r++ = *str++;
				cw = 1;
			} else {
				*r++ = *str++;
				cw++;
			}
		}
	}
	*r = 0;
	return ret;
}
