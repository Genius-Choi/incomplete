msg_mclass_t *sip_extend_mclass(msg_mclass_t *input)
{
  msg_mclass_t *mclass;

  if (input == NULL || input == _default) {
    _default_parser_cloned = msg_mclass_clone(_default, 0, 0);
    mclass = _default_parser_cloned;
  } else {
    mclass = input;
  }

  if (mclass) {
    extern msg_hclass_t * const sip_extensions[];
    int i;

    for (i = 0; sip_extensions[i]; i++) {
      msg_hclass_t *hclass = sip_extensions[i];
      if (mclass->mc_unknown != msg_find_hclass(mclass, hclass->hc_name, NULL))
	continue;

      if (msg_mclass_insert_header(mclass, hclass, 0) < 0) {
        if (input != mclass) {
          sip_destroy_mclass(mclass);
        }
        return mclass = NULL;
      }
    }
  }

  return mclass;
}
