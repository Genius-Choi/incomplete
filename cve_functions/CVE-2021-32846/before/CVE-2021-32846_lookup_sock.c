static struct pci_vtsock_sock *lookup_sock(struct pci_vtsock_softc *sc,
					   uint16_t type,
					   struct vsock_addr local_addr,
					   struct vsock_addr peer_addr)
{
	struct pci_vtsock_sock *s;

	assert(type == VIRTIO_VSOCK_TYPE_STREAM);

	pthread_rwlock_rdlock(&sc->list_rwlock);
	LIST_FOREACH(s, &sc->inuse_list, list) {
		get_sock(s);

		if ((s->state == SOCK_CONNECTED || s->state == SOCK_CONNECTING) &&
		    s->peer_addr.cid == peer_addr.cid &&
		    s->peer_addr.port == peer_addr.port &&
		    s->local_addr.cid == local_addr.cid &&
		    s->local_addr.port == local_addr.port) {
			goto found;
		}

		put_sock(s);
	}

	s = NULL;

found:
	pthread_rwlock_unlock(&sc->list_rwlock);
	return s;
}
