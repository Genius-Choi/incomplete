static struct pci_vtsock_sock *alloc_sock(struct pci_vtsock_softc *sc)
{
	struct pci_vtsock_sock *s;

	pthread_rwlock_wrlock(&sc->list_rwlock);
	s = LIST_FIRST(&sc->free_list);
	if (s) {
		get_sock(s);
		LIST_REMOVE(s, list);
		LIST_INSERT_HEAD(&sc->inuse_list, s, list);
		s->state = SOCK_CONNECTING;
	}
	pthread_rwlock_unlock(&sc->list_rwlock);

	if (!s) return NULL;

	s->buf_alloc = WRITE_BUF_LENGTH;
	s->fwd_cnt = 0;

	s->peer_buf_alloc = 0;
	s->peer_fwd_cnt = 0;
	s->rx_cnt = 0;
	s->credit_update_required = false;

	s->local_shutdown = 0;
	s->peer_shutdown = 0;

	s->write_buf_head = s->write_buf_tail = 0;

	return s;
}
