njs_external_state_init(njs_vm_t *vm, njs_external_state_t *s, njs_opts_t *opts)
{
    njs_int_t  ret;

    if (opts->externals) {
        s->env = &s->env0;

        ret = njs_external_env_init(s->env);
        if (ret != NJS_OK) {
            njs_stderror("njs_external_env_init() failed\n");
            return NJS_ERROR;
        }

    } else {
        s->env = NULL;
    }

    s->vm = njs_vm_clone(vm, s->env);
    if (s->vm == NULL) {
        njs_stderror("njs_vm_clone() failed\n");
        return NJS_ERROR;
    }

    if (opts->externals) {
        ret = njs_externals_init(s->vm);
        if (ret != NJS_OK) {
            njs_stderror("njs_externals_init() failed\n");
            return NJS_ERROR;
        }
    }

    s->state = sw_start;

    return NJS_OK;
}
