int spider_db_mbase_util::append_from_and_tables(
  ha_spider *spider,
  spider_fields *fields,
  spider_string *str,
  TABLE_LIST *table_list,
  uint table_count
) {
  int error_num;
  uint current_pos = 0, roop_count, backup_pos, outer_join_backup;
  TABLE *table;
  TABLE_LIST **used_table_list, *prev_table_list = NULL,
    *cond_table_list = NULL;
  DBUG_ENTER("spider_db_mbase_util::append_from_and_tables");
  DBUG_PRINT("info",("spider this=%p", this));
  used_table_list = (TABLE_LIST **)
    my_alloca(sizeof(TABLE_LIST *) * table_count);
  if (!used_table_list)
    DBUG_RETURN(HA_ERR_OUT_OF_MEM);

  if (str)
  {
    if (str->reserve(SPIDER_SQL_FROM_LEN))
    {
      my_afree(used_table_list);
      DBUG_RETURN(HA_ERR_OUT_OF_MEM);
    }
    str->q_append(SPIDER_SQL_FROM_STR, SPIDER_SQL_FROM_LEN);
  }

  do {
    table = table_list->table;
    if (table->const_table)
      continue;

    for (roop_count = 0; roop_count < current_pos; ++roop_count)
    {
      if (used_table_list[roop_count] == table_list)
        break;
    }
    if (roop_count < current_pos)
      continue;

    if (prev_table_list)
      current_pos = backup_pos;
    else
      backup_pos = current_pos;
    if ((error_num = append_table(spider, fields, str, table_list, used_table_list,
      &current_pos, &cond_table_list, FALSE, FALSE)))
    {
      my_afree(used_table_list);
      DBUG_RETURN(error_num);
    }
    if (prev_table_list)
    {
      outer_join_backup = prev_table_list->outer_join;
      prev_table_list->outer_join = JOIN_TYPE_LEFT;
      if ((error_num = append_table(spider, fields, str, prev_table_list,
        used_table_list, &current_pos, &cond_table_list, FALSE, FALSE)))
      {
        prev_table_list->outer_join = outer_join_backup;
        my_afree(used_table_list);
        DBUG_RETURN(error_num);
      }
      prev_table_list->outer_join = outer_join_backup;
      prev_table_list = NULL;
    }
    if (cond_table_list && (cond_table_list->outer_join & JOIN_TYPE_RIGHT))
    {
      prev_table_list = cond_table_list;
      cond_table_list = NULL;
      DBUG_PRINT("info",("spider cond_table_list=%p", cond_table_list));
    }
  } while ((table_list = table_list->next_local));
  my_afree(used_table_list);
  DBUG_RETURN(0);
}
