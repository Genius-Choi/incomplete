struct mg_connection *mg_connect_http_opt(
    struct mg_mgr *mgr, MG_CB(mg_event_handler_t ev_handler, void *user_data),
    struct mg_connect_opts opts, const char *url, const char *extra_headers,
    const char *post_data) {
  char *user = NULL, *pass = NULL, *addr = NULL;
  const char *path = NULL;
  struct mbuf auth;
  struct mg_connection *nc =
      mg_connect_http_base(mgr, MG_CB(ev_handler, user_data), opts, "http://",
                           "https://", url, &path, &user, &pass, &addr);

  if (nc == NULL) {
    return NULL;
  }

  mbuf_init(&auth, 0);
  if (user != NULL) {
    mg_basic_auth_header(user, pass, &auth);
  }

  if (post_data == NULL) post_data = "";
  if (extra_headers == NULL) extra_headers = "";

  mg_printf(nc, "%s %s HTTP/1.1\r\nHost: %s\r\nContent-Length: %" SIZE_T_FMT
                "\r\n%.*s%s\r\n%s",
            post_data[0] == '\0' ? "GET" : "POST", path, addr,
            strlen(post_data), (int) auth.len,
            (auth.buf == NULL ? "" : auth.buf), extra_headers, post_data);

  mbuf_free(&auth);
  MG_FREE(user);
  MG_FREE(pass);
  MG_FREE(addr);
  return nc;
}
