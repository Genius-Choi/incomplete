json_t * r_jws_serialize_json_t(jws_t * jws, jwks_t * jwks_privkey, int x5u_flags, int mode) {
  json_t * j_return = NULL, * j_signature;
  jwk_t * jwk = NULL;
  jwa_alg alg;
  const char * kid;
  unsigned char * signature = NULL;
  size_t i = 0;

  if (jwks_privkey == NULL) {
    jwks_privkey = jws->jwks_privkey;
  }
  if (jws != NULL && r_jwks_size(jwks_privkey)) {
    jws->token_mode = mode;
    if (mode == R_JSON_MODE_FLATTENED) {
      if ((kid = r_jws_get_header_str_value(jws, "kid")) != NULL) {
        jwk = r_jwks_get_by_kid(jwks_privkey, r_jws_get_header_str_value(jws, "kid"));
      } else {
        jwk = r_jwks_get_at(jwks_privkey, 0);
        kid = r_jwk_get_property_str(jwk, "kid");
      }
      if ((alg = jws->alg) == R_JWA_ALG_UNKNOWN && (alg = r_str_to_jwa_alg(r_jwk_get_property_str(jwk, "alg"))) != R_JWA_ALG_NONE && alg != R_JWA_ALG_UNKNOWN) {
        r_jws_set_alg(jws, alg);
      }
      if (r_jws_set_token_values(jws, 1) == RHN_OK) {
        if ((signature = _r_generate_signature(jws, jwk, alg, x5u_flags)) != NULL) {
          j_return = json_pack("{ssssss}", "payload", jws->payload_b64url, "protected", jws->header_b64url, "signature", signature);
          if (kid != NULL) {
            json_object_set_new(j_return, "header", json_pack("{ss}", "kid", kid));
          }
        } else {
          y_log_message(Y_LOG_LEVEL_ERROR, "r_jws_serialize_json_t - Error _r_generate_signature");
        }
        o_free(signature);
      } else {
        y_log_message(Y_LOG_LEVEL_ERROR, "r_jws_serialize_json_t - Error r_jws_set_header_value");
      }
      r_jwk_free(jwk);
    } else {
      if (r_jws_set_payload_value(jws, 1) == RHN_OK) {
        j_return = json_pack("{sss[]}", "payload", jws->payload_b64url, "signatures");
        for (i=0; i<r_jwks_size(jwks_privkey); i++) {
          jwk = r_jwks_get_at(jwks_privkey, i);
          if ((alg = r_str_to_jwa_alg(r_jwk_get_property_str(jwk, "alg"))) != R_JWA_ALG_NONE && alg != R_JWA_ALG_UNKNOWN) {
            kid = r_jwk_get_property_str(jwk, "kid");
            r_jws_set_alg(jws, alg);
            if (r_jws_set_header_value(jws, 1) == RHN_OK) {
              if ((signature = _r_generate_signature(jws, jwk, alg, x5u_flags)) != NULL) {
                j_signature = json_pack("{ssss}", "protected", jws->header_b64url, "signature", signature);
                if (kid != NULL) {
                  json_object_set_new(j_signature, "header", json_pack("{ss}", "kid", kid));
                }
                json_array_append_new(json_object_get(j_return, "signatures"), j_signature);
              } else {
                y_log_message(Y_LOG_LEVEL_ERROR, "r_jws_serialize_json_t - Error _r_generate_signature");
              }
              o_free(signature);
            } else {
              y_log_message(Y_LOG_LEVEL_ERROR, "r_jws_serialize_json_t - Error generating protected header at index %zu", i);
            }
          } else {
            y_log_message(Y_LOG_LEVEL_ERROR, "r_jws_serialize_json_t - Invalid jwk at index %zu, no alg specified", i);
          }
          r_jwk_free(jwk);
        }
      } else {
        y_log_message(Y_LOG_LEVEL_ERROR, "r_jws_serialize_json_t - Error r_jws_set_header_value");
      }
    }
    json_decref(jws->j_json_serialization);
    jws->j_json_serialization = json_deep_copy(j_return);
  } else {
    y_log_message(Y_LOG_LEVEL_ERROR, "r_jws_serialize_json_t - Error input parameters");
  }
  return j_return;
}
