int r_jws_advanced_parse_json_t(jws_t * jws, json_t * jws_json, uint32_t parse_flags, int x5u_flags) {
  int ret;
  size_t index = 0, signature_len = 0, header_len = 0;
  char * str_header = NULL;
  json_t * j_header = NULL, * j_element = NULL;
  struct _o_datum dat_header = {0, NULL}, dat_payload = {0, NULL};

  if (jws != NULL && json_is_object(jws_json)) {
    if (json_string_length(json_object_get(jws_json, "payload"))) {
      if (json_string_length(json_object_get(jws_json, "protected"))) {
        // Mode flattened - 1 signature maximum
        ret = RHN_OK;
        jws->token_mode = R_JSON_MODE_FLATTENED;

        do {
          json_decref(jws->j_json_serialization);
          if ((jws->j_json_serialization = json_deep_copy(jws_json)) == NULL) {
            y_log_message(Y_LOG_LEVEL_ERROR, "r_jws_parse_json_t - Error setting j_json_serialization");
            ret = RHN_ERROR;
            break;
          }

          o_free(jws->header_b64url);
          if ((jws->header_b64url = (unsigned char *)o_strdup(json_string_value(json_object_get(jws_json, "protected")))) == NULL) {
            y_log_message(Y_LOG_LEVEL_ERROR, "r_jws_parse_json_t - Error setting header_b64url");
            ret = RHN_ERROR;
            break;
          }

          o_free(jws->payload_b64url);
          if ((jws->payload_b64url = (unsigned char *)o_strdup(json_string_value(json_object_get(jws_json, "payload")))) == NULL) {
            y_log_message(Y_LOG_LEVEL_ERROR, "r_jws_parse_json_t - Error setting payload_b64url");
            ret = RHN_ERROR;
            break;
          }

          o_free(jws->signature_b64url);
          if (json_string_length(json_object_get(jws_json, "signature"))) {
            if ((jws->signature_b64url = (unsigned char *)o_strdup(json_string_value(json_object_get(jws_json, "signature")))) == NULL) {
              y_log_message(Y_LOG_LEVEL_ERROR, "r_jws_parse_json_t - Error setting signature_b64url");
              ret = RHN_ERROR;
              break;
            }
            if (!o_base64url_decode((unsigned char *)jws->signature_b64url, o_strlen((const char *)jws->signature_b64url), NULL, &signature_len)) {
              y_log_message(Y_LOG_LEVEL_ERROR, "r_jws_parse_json_t - Invalid JWS, signature not valid base64url format");
              ret = RHN_ERROR_PARAM;
              break;
            }
          } else {
            jws->signature_b64url = NULL;
          }

          // Decode header
          if (!o_base64url_decode_alloc((unsigned char *)jws->header_b64url, o_strlen((const char *)jws->header_b64url), &dat_header)) {
            y_log_message(Y_LOG_LEVEL_ERROR, "r_jws_parse_json_t - Error decoding str_header");
            ret = RHN_ERROR_PARAM;
            break;
          }

          j_header = json_loadb((const char*)dat_header.data, dat_header.size, JSON_DECODE_ANY, NULL);
          if (r_jws_extract_header(jws, j_header, parse_flags, x5u_flags) != RHN_OK) {
            y_log_message(Y_LOG_LEVEL_ERROR, "r_jws_parse_json_t - Error extracting header params");
            ret = RHN_ERROR_PARAM;
            break;
          }
          json_decref(jws->j_header);

          jws->j_header = json_incref(j_header);

          // Decode payload
          if (!o_base64url_decode_alloc((unsigned char *)jws->payload_b64url, o_strlen((const char *)jws->payload_b64url), &dat_payload)) {
            y_log_message(Y_LOG_LEVEL_ERROR, "r_jws_parse_json_t - Error decoding payload");
            ret = RHN_ERROR_PARAM;
            break;
          }

          if (r_jws_set_payload(jws, dat_payload.data, dat_payload.size) != RHN_OK) {
            y_log_message(Y_LOG_LEVEL_ERROR, "r_jws_parse_json_t - Error r_jws_set_payload");
            ret = RHN_ERROR;
            break;
          }

          if (r_jws_extract_header(jws, json_object_get(jws_json, "header"), parse_flags, x5u_flags) != RHN_OK) {
            y_log_message(Y_LOG_LEVEL_ERROR, "r_jws_parse_json_t - Error extracting header params");
            ret = RHN_ERROR_PARAM;
            break;
          }
        } while (0);
        json_decref(j_header);
        o_free(dat_header.data);
        o_free(dat_payload.data);

      } else {
        ret = RHN_OK;
        if (json_array_size(json_object_get(jws_json, "signatures"))) {
          json_array_foreach(json_object_get(jws_json, "signatures"), index, j_element) {
            if (!json_string_length(json_object_get(j_element, "protected")) || !json_string_length(json_object_get(j_element, "signature"))) {
              y_log_message(Y_LOG_LEVEL_ERROR, "r_jws_parse_json_t - Error invalid format, a signature object must contain string elements 'protected' and 'signature'");
              ret = RHN_ERROR_PARAM;
              break;
            }

            if (json_object_get(j_element, "header") && !json_is_object(json_object_get(j_element, "header"))) {
              y_log_message(Y_LOG_LEVEL_ERROR, "r_jws_parse_json_t - Error invalid format, the 'header property in a signature object must be a JSON object");
              ret = RHN_ERROR_PARAM;
              break;
            }

            if (!o_base64url_decode((const unsigned char *)json_string_value(json_object_get(j_element, "protected")), json_string_length(json_object_get(j_element, "protected")), NULL, &header_len)) {
              y_log_message(Y_LOG_LEVEL_ERROR, "r_jws_parse_json_t - Error header base64url format");
              ret = RHN_ERROR_PARAM;
              break;
            }

            if (!o_base64url_decode((const unsigned char *)json_string_value(json_object_get(j_element, "signature")), json_string_length(json_object_get(j_element, "signature")), NULL, &signature_len)) {
              y_log_message(Y_LOG_LEVEL_ERROR, "r_jws_parse_json_t - Error signature base64url format");
              ret = RHN_ERROR_PARAM;
              break;
            }

          }
        } else {
          y_log_message(Y_LOG_LEVEL_ERROR, "r_jws_parse_json_t - Error invalid format, signatures must be a JSON array");
          ret = RHN_ERROR_PARAM;
        }

        if (ret == RHN_OK) {
          // Mode general - multiple signatures allowed
          jws->token_mode = R_JSON_MODE_GENERAL;

          do {
            o_free(jws->header_b64url);
            jws->header_b64url = NULL;
            o_free(jws->signature_b64url);
            jws->signature_b64url = NULL;

            json_decref(jws->j_json_serialization);
            if ((jws->j_json_serialization = json_deep_copy(jws_json)) == NULL) {
              y_log_message(Y_LOG_LEVEL_ERROR, "r_jws_parse_json_t - Error setting j_json_serialization");
              ret = RHN_ERROR;
              break;
            }

            o_free(jws->payload_b64url);
            if ((jws->payload_b64url = (unsigned char *)o_strdup(json_string_value(json_object_get(jws_json, "payload")))) == NULL) {
              y_log_message(Y_LOG_LEVEL_ERROR, "r_jws_parse_json_t - Error setting payload_b64url");
              ret = RHN_ERROR;
              break;
            }

            // Decode payload
            if (!o_base64url_decode_alloc((unsigned char *)jws->payload_b64url, o_strlen((const char *)jws->payload_b64url), &dat_payload)) {
              y_log_message(Y_LOG_LEVEL_ERROR, "r_jws_parse_json_t - error decoding jws->payload");
              ret = RHN_ERROR_PARAM;
              break;
            }

            if (r_jws_set_payload(jws, dat_payload.data, dat_payload.size) != RHN_OK) {
              y_log_message(Y_LOG_LEVEL_ERROR, "r_jws_parse_json_t - Error r_jws_set_payload");
              ret = RHN_ERROR;
              break;
            }
          } while (0);
          json_decref(j_header);
          o_free(str_header);
          o_free(dat_payload.data);
        }

      }
    } else {
      y_log_message(Y_LOG_LEVEL_ERROR, "r_jws_parse_json_t - Error payload missing");
      ret = RHN_ERROR_PARAM;
    }
  } else {
    y_log_message(Y_LOG_LEVEL_ERROR, "r_jws_parse_json_t - Error input parameters");
    ret = RHN_ERROR_PARAM;
  }
  return ret;
}
