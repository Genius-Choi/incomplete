void __fastcall TSessionData::SavePasswords(THierarchicalStorage * Storage, bool PuttyExport, bool DoNotEncryptPasswords, bool SaveAll)
{
  if (!Configuration->DisablePasswordStoring && !PuttyExport && (!FPassword.IsEmpty() || SaveAll))
  {
    if (DoNotEncryptPasswords)
    {
      Storage->WriteString(L"PasswordPlain", Password);
      Storage->DeleteValue(L"Password");
    }
    else
    {
      Storage->WriteBinaryDataAsString(L"Password", StronglyRecryptPassword(FPassword, UserName+HostName));
      Storage->DeleteValue(L"PasswordPlain");
    }
  }
  else
  {
    Storage->DeleteValue(L"Password");
    Storage->DeleteValue(L"PasswordPlain");
  }

  if (PuttyExport)
  {
    // save password unencrypted
    Storage->WriteString(L"ProxyPassword", ProxyPassword);
  }
  else
  {
    if (DoNotEncryptPasswords)
    {
      if (!FProxyPassword.IsEmpty() || SaveAll)
      {
        Storage->WriteString(L"ProxyPassword", ProxyPassword);
      }
      else
      {
        Storage->DeleteValue(L"ProxyPassword");
      }
      Storage->DeleteValue(L"ProxyPasswordEnc");
    }
    else
    {
      // save password encrypted
      if (!FProxyPassword.IsEmpty() || SaveAll)
      {
        Storage->WriteBinaryDataAsString(L"ProxyPasswordEnc", StronglyRecryptPassword(FProxyPassword, ProxyUsername+ProxyHost));
      }
      else
      {
        Storage->DeleteValue(L"ProxyPasswordEnc");
      }
      Storage->DeleteValue(L"ProxyPassword");
    }

    if (DoNotEncryptPasswords)
    {
      if (!FTunnelPassword.IsEmpty() || SaveAll)
      {
        Storage->WriteString(L"TunnelPasswordPlain", TunnelPassword);
      }
      else
      {
        Storage->DeleteValue(L"TunnelPasswordPlain");
      }
    }
    else
    {
      if (!Configuration->DisablePasswordStoring && (!FTunnelPassword.IsEmpty() || SaveAll))
      {
        Storage->WriteBinaryDataAsString(L"TunnelPassword", StronglyRecryptPassword(FTunnelPassword, TunnelUserName+TunnelHostName));
      }
      else
      {
        Storage->DeleteValue(L"TunnelPassword");
      }
    }

    if (DoNotEncryptPasswords)
    {
      if (!FEncryptKey.IsEmpty() || SaveAll)
      {
        Storage->WriteString(L"EncryptKeyPlain", EncryptKey);
      }
      else
      {
        Storage->DeleteValue(L"EncryptKeyPlain");
      }
      Storage->DeleteValue(L"EncryptKey");
    }
    else
    {
      if (!FEncryptKey.IsEmpty() || SaveAll)
      {
        Storage->WriteBinaryDataAsString(L"EncryptKey", StronglyRecryptPassword(FEncryptKey, UserName+HostName));
      }
      else
      {
        Storage->DeleteValue(L"EncryptKey");
      }
      Storage->DeleteValue(L"EncryptKeyPlain");
    }
  }
}
