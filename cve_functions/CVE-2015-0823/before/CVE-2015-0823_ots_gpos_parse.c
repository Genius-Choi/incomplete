bool ots_gpos_parse(OpenTypeFile *file, const uint8_t *data, size_t length) {
  // Parsing GPOS table requires num_glyphs which is contained in maxp table.
  if (!file->maxp) {
    return OTS_FAILURE_MSG("missing maxp table needed in GPOS");
  }

  Buffer table(data, length);

  OpenTypeGPOS *gpos = new OpenTypeGPOS;
  file->gpos = gpos;

  uint32_t version = 0;
  uint16_t offset_script_list = 0;
  uint16_t offset_feature_list = 0;
  uint16_t offset_lookup_list = 0;
  if (!table.ReadU32(&version) ||
      !table.ReadU16(&offset_script_list) ||
      !table.ReadU16(&offset_feature_list) ||
      !table.ReadU16(&offset_lookup_list)) {
    DROP_THIS_TABLE("Incomplete table");
    return true;
  }

  if (version != 0x00010000) {
    DROP_THIS_TABLE("Bad version");
    return true;
  }

  if (offset_lookup_list) {
    if (offset_lookup_list < kGposHeaderSize || offset_lookup_list >= length) {
      DROP_THIS_TABLE("Bad lookup list offset in table header");
      return true;
    }

    if (!ParseLookupListTable(file, data + offset_lookup_list,
                              length - offset_lookup_list,
                              &kGposLookupSubtableParser,
                              &gpos->num_lookups)) {
      DROP_THIS_TABLE("Failed to parse lookup list table");
      return true;
    }
  }

  uint16_t num_features = 0;
  if (offset_feature_list) {
    if (offset_feature_list < kGposHeaderSize || offset_feature_list >= length) {
      DROP_THIS_TABLE("Bad feature list offset in table header");
      return true;
    }

    if (!ParseFeatureListTable(file, data + offset_feature_list,
                               length - offset_feature_list, gpos->num_lookups,
                               &num_features)) {
      DROP_THIS_TABLE("Failed to parse feature list table");
      return true;
    }
  }

  if (offset_script_list) {
    if (offset_script_list < kGposHeaderSize || offset_script_list >= length) {
      DROP_THIS_TABLE("Bad script list offset in table header");
      return true;
    }

    if (!ParseScriptListTable(file, data + offset_script_list,
                              length - offset_script_list, num_features)) {
      DROP_THIS_TABLE("Failed to parse script list table");
      return true;
    }
  }

  gpos->data = data;
  gpos->length = length;
  return true;
}
