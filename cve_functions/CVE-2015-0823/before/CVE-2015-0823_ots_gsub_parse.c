bool ots_gsub_parse(OpenTypeFile *file, const uint8_t *data, size_t length) {
  // Parsing gsub table requires |file->maxp->num_glyphs|
  if (!file->maxp) {
    return OTS_FAILURE_MSG("Missing maxp table in font, needed by GSUB");
  }

  Buffer table(data, length);

  OpenTypeGSUB *gsub = new OpenTypeGSUB;
  file->gsub = gsub;

  uint32_t version = 0;
  uint16_t offset_script_list = 0;
  uint16_t offset_feature_list = 0;
  uint16_t offset_lookup_list = 0;
  if (!table.ReadU32(&version) ||
      !table.ReadU16(&offset_script_list) ||
      !table.ReadU16(&offset_feature_list) ||
      !table.ReadU16(&offset_lookup_list)) {
    DROP_THIS_TABLE("Incomplete table");
    return true;
  }

  if (version != 0x00010000) {
    DROP_THIS_TABLE("Bad version");
    return true;
  }

  if (offset_lookup_list) {
    if (offset_lookup_list < kGsubHeaderSize || offset_lookup_list >= length) {
      DROP_THIS_TABLE("Bad lookup list offset in table header");
      return true;
    }

    if (!ParseLookupListTable(file, data + offset_lookup_list,
                              length - offset_lookup_list,
                              &kGsubLookupSubtableParser,
                              &gsub->num_lookups)) {
      DROP_THIS_TABLE("Failed to parse lookup list table");
      return true;
    }
  }

  uint16_t num_features = 0;
  if (offset_feature_list) {
    if (offset_feature_list < kGsubHeaderSize || offset_feature_list >= length) {
      DROP_THIS_TABLE("Bad feature list offset in table header");
      return true;
    }

    if (!ParseFeatureListTable(file, data + offset_feature_list,
                               length - offset_feature_list, gsub->num_lookups,
                               &num_features)) {
      DROP_THIS_TABLE("Failed to parse feature list table");
      return true;
    }
  }

  if (offset_script_list) {
    if (offset_script_list < kGsubHeaderSize || offset_script_list >= length) {
      DROP_THIS_TABLE("Bad script list offset in table header");
      return true;
    }

    if (!ParseScriptListTable(file, data + offset_script_list,
                              length - offset_script_list, num_features)) {
      DROP_THIS_TABLE("Failed to parse script list table");
      return true;
    }
  }

  gsub->data = data;
  gsub->length = length;
  return true;
}
