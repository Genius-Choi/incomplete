static apr_status_t oidc_cache_redis_connect(request_rec *r,
		oidc_cache_cfg_redis_t *context) {

	redisReply *reply = NULL;

	if (context->ctx == NULL) {

		/* no connection, connect to the configured Redis server */
		oidc_debug(r, "calling redisConnectWithTimeout");
		context->ctx = redisConnectWithTimeout(context->host_str, context->port, context->connect_timeout);

		/* check for errors */
		if ((context->ctx == NULL) || (context->ctx->err != 0)) {
			oidc_error(r, "failed to connect to Redis server (%s:%d): '%s'",
					context->host_str, context->port,
					context->ctx != NULL ? context->ctx->errstr : "");
			oidc_cache_redis_free(context);
		} else {
			/* log the connection */
			oidc_debug(r, "successfully connected to Redis server (%s:%d)",
					context->host_str, context->port);

			/* see if we need to authenticate to the Redis server */
			if (context->passwd != NULL) {
				reply = redisCommand(context->ctx, "AUTH %s", context->passwd);
				if ((reply == NULL) || (reply->type == REDIS_REPLY_ERROR))
					oidc_error(r,
							"Redis AUTH command (%s:%d) failed: '%s' [%s]",
							context->host_str, context->port,
							context->ctx->errstr, reply ? reply->str : "<n/a>");
				else
					oidc_debug(r,
							"successfully authenticated to the Redis server: %s",
							reply ? reply->str : "<n/a>");

				/* free the auth answer */
				oidc_cache_redis_reply_free(&reply);
			}

			/* see if we need to set the database */
			if (context->database != -1) {
				reply = redisCommand(context->ctx, "SELECT %d",
						context->database);
				if ((reply == NULL) || (reply->type == REDIS_REPLY_ERROR))
					oidc_error(r,
							"Redis SELECT command (%s:%d) failed: '%s' [%s]",
							context->host_str, context->port,
							context->ctx->errstr, reply ? reply->str : "<n/a>");
				else
					oidc_debug(r,
							"successfully selected database %d on the Redis server: %s",
							context->database, reply ? reply->str : "<n/a>");

				/* free the database answer */
				oidc_cache_redis_reply_free(&reply);
			}

			if (redisSetTimeout(context->ctx, context->timeout) != REDIS_OK)
				oidc_error(r, "redisSetTimeout failed: %s", context->ctx->errstr);

		}
	}

	return (context->ctx != NULL) ? APR_SUCCESS : APR_EGENERAL;
}
