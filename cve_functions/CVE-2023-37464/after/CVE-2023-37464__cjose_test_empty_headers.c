static void _cjose_test_empty_headers(cjose_jwk_t *key)
{

    cjose_jwe_t *jwe;
    cjose_err err;
    cjose_header_t *hdr;

    // regression test - if we created json without unprotected headers, we must
    // be able to read it back.

    hdr = cjose_header_new(&err);
    cjose_header_set(hdr, CJOSE_HDR_ALG, CJOSE_HDR_ALG_RSA_OAEP, &err);
    cjose_header_set(hdr, CJOSE_HDR_ENC, CJOSE_HDR_ENC_A256CBC_HS512, &err);

    cjose_jwe_recipient_t rec = { .jwk = (const cjose_jwk_t *)key, .unprotected_header = 0 };

    jwe = cjose_jwe_encrypt_multi(&rec, 1, hdr, 0, (uint8_t *)"", 1, &err);
    ck_assert_msg(NULL != jwe,
                  "failed to encrypt test data: "
                  "%s, file: %s, function: %s, line: %ld",
                  err.message, err.file, err.function, err.line);
    char *json = cjose_jwe_export_json(jwe, &err);
    ck_assert_msg(NULL != json,
                  "failed to serialize test data: "
                  "%s, file: %s, function: %s, line: %ld",
                  err.message, err.file, err.function, err.line);

    cjose_jwe_release(jwe);
    cjose_header_release(hdr);

    // import the json back

    jwe = cjose_jwe_import_json(json, strlen(json), &err);
    ck_assert_msg(NULL != jwe,
                  "failed to import test data: "
                  "%s, file: %s, function: %s, line: %ld",
                  err.message, err.file, err.function, err.line);
    size_t len;
    char *test = (char *)cjose_jwe_decrypt(jwe, key, &len, &err);
    ck_assert_msg(NULL != test,
                  "failed to decrypt test data: "
                  "%s, file: %s, function: %s, line: %ld",
                  err.message, err.file, err.function, err.line);
    ck_assert_msg((len == 1) && (*test == 0), "Decrypted data does not match original");

    free(test);
    free(json);
    cjose_jwe_release(jwe);
}
