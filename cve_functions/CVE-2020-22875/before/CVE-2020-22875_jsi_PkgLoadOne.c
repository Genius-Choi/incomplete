static Jsi_RC jsi_PkgLoadOne(Jsi_Interp *interp, const char *name, const char *path, int len, Jsi_Value **fval, Jsi_Number ver)
{
    bool trace = interp->debugOpts.pkgTrace;
    Jsi_RC rc = JSI_CONTINUE;
    const char *fn;
    const char *ext;
    if (!path)
        return JSI_CONTINUE;
    if (len<0)
        len = Jsi_Strlen(path);
#ifdef __WIN32
    ext = ".dll";
#else
    ext = ".so";
#endif
    Jsi_Value *fpath = NULL;
    Jsi_DString dStr;
    Jsi_DSInit(&dStr);
    int i;
    const char *sf = "";
    if (trace)
        sf = jsi_GetCurFile(interp);
    for (i=0; i<4 && rc == JSI_CONTINUE; i++) {
        const char *pref = (i%2 ? name : ""), *ps = (i%2 ? "/" : "");
        if (i<2) {
#ifdef JSI_OMIT_LOAD
        continue;
#endif
            Jsi_DSSetLength(&dStr, 0);
            Jsi_DSAppendLen(&dStr, path, len);
            Jsi_DSAppend(&dStr, "/", pref, ps, name, ext, NULL);
            fn = Jsi_DSValue(&dStr);
            if ((fpath = jsi_AccessFile(interp, fn, R_OK))) {
                if (trace)
                    Jsi_Printf(interp, jsi_Stderr,"Package-Trace: load('%s') from %s\n", fn, sf);
                rc = Jsi_LoadLibrary(interp, fn, 0);
            }
        } else {
            Jsi_DSSetLength(&dStr, 0);
            Jsi_DSAppendLen(&dStr, path, len);
            Jsi_DSAppend(&dStr, "/", pref, ps, name, ".jsi", NULL);
            fn = Jsi_DSValue(&dStr);
            if ((fpath = jsi_AccessFile(interp, fn, R_OK))) {
                if (trace)
                    Jsi_Printf(interp, jsi_Stderr, "Package-Trace: source('%s') from %s\n", fn, sf);
                int oisi = interp->isMain;
                interp->isMain = 0;
                rc = Jsi_EvalFile(interp, fpath, JSI_EVAL_GLOBAL);
                interp->isMain = oisi;
            }
        }
    }
    int needErr = 1;
    if (rc == JSI_OK) {
        ver = Jsi_PkgVersion(interp, name, NULL);
        if (ver < 0) {
            rc = Jsi_LogError("package missing provide('%s') in file: %s", name, Jsi_DSValue(&dStr));
            needErr = 0;
        }
    }
    if (rc == JSI_OK) {
        *fval = fpath;
    }
    else if (fpath)
        Jsi_DecrRefCount(interp, fpath);
    if (rc == JSI_ERROR && needErr)
        Jsi_LogError("within require('%s') in file: %s", name, Jsi_DSValue(&dStr));
    Jsi_DSFree(&dStr);
    return rc;
}
