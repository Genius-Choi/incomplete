static Jsi_RC jsi_ArraySortCmd(Jsi_Interp *interp, Jsi_Value *args, Jsi_Value *_this,Jsi_Value **ret, Jsi_Func *funcPtr)
{
    if (_this->vt != JSI_VT_OBJECT || !Jsi_ObjIsArray(interp, _this->d.obj))
        return Jsi_LogError("expected array object");

    int flags = 0, i, curlen, hasopt = 0;
    Jsi_Value *v, *arg = NULL;
    SortInfo si = {};
    si.interp = interp;


    Jsi_Obj *obj = _this->d.obj;
    curlen = obj->arrCnt;

    if (curlen <= 1) {
        goto done;
    }
    
    arg = Jsi_ValueArrayIndex(interp, args, 0);
    if (arg) {
        if (Jsi_ValueIsObjType(interp, arg, JSI_OT_OBJECT)) {
            if (Jsi_OptionsProcess(interp, jsi_ArraySortOptions, &si, arg, 0) < 0)
                return JSI_ERROR;
            hasopt = 1;
            switch (si.mode) {
                case 1: flags |= JSI_SORT_DESCEND; break;
                case 2: flags |= JSI_SORT_DICT; break;
                case 3: flags |= JSI_SORT_NOCASE; break;
            }
        } else if (Jsi_ValueIsObjType(interp, arg, JSI_OT_FUNCTION))
            si.compare = arg;
        else 
            return Jsi_LogError("expected object or function");
    }
    si.flags = flags;
    Jsi_ObjListifyArray(interp, obj);
#ifdef NO_QSORT_R
    /* TODO: mutex. */
    curSortInfo = &si;
    qsort(obj->arr, curlen, sizeof(Jsi_Value*), SortSubCmd);
#else
    qsort_r(obj->arr, curlen, sizeof(Jsi_Value*), SortSubCmd, &si);
#endif

    if (interp->deleting) {
#ifdef NO_QSORT_R
        curSortInfo = NULL;
#endif
        return JSI_ERROR;
    }
    if (si.unique) {
        int n, diff = 1, dupCnt=0;
        for (n=0, i=1; i<(int)obj->arrCnt; i++) {
            if (obj->arr[n] == obj->arr[i])
                diff = 1;
            else
#ifdef NO_QSORT_R
                diff = SortSubCmd(&obj->arr[n], &obj->arr[i]);
#else
#ifdef __WIN32
                diff = SortSubCmd(&si, &obj->arr[n], &obj->arr[i]);
#else
                diff = SortSubCmd(&obj->arr[n], &obj->arr[i], &si);
#endif
#endif
            if (diff) {
                n++;
                if (n!=i)
                    obj->arr[n] = obj->arr[i];
            } else {
                dupCnt++;
                if (obj->arr[i])
                    Jsi_DecrRefCount(interp, obj->arr[i]);
                obj->arr[i] = 0;
            }
        }
        obj->arrCnt -= dupCnt;
    }
#ifdef NO_QSORT_R
    curSortInfo = NULL;
#endif
    if (hasopt)
        Jsi_OptionsFree(interp, jsi_ArraySortOptions, &si, 0);
done:
    v = Jsi_ValueMakeObject(interp, NULL, obj);
    Jsi_ValueReplace(interp, ret, v);
    return JSI_OK;
    
    Jsi_ValueMakeNull(interp, ret);
    return JSI_OK;
}
