static void with_env(const std::string &key,
                     const std::string &val,
                     std::function<void()> fn)
{
  EXPECT_EQ(::setenv(key.c_str(), val.c_str(), 1), 0);
  try {
    fn();
  } catch (const std::exception &ex) {
    EXPECT_EQ(::unsetenv(key.c_str()), 0);
    throw ex;
  }
  EXPECT_EQ(::unsetenv(key.c_str()), 0);
}
