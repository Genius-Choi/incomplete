static std::tuple<ECHStatus, uint8_t> processECHHRR(
    const Optional<CookieState>& cookieState,
    const State& state,
    ClientHello& chlo) {
  auto decrypter = state.context()->getECHDecrypter();
  auto echExt = getExtension<ech::OuterECHClientHello>(chlo.extensions);
  ECHStatus echStatus = state.echStatus();

  // Check for cookie ECH
  bool cookieHasECH = cookieState && cookieState->echCipherSuite.has_value();

  // Do checks for both cases.
  if (echStatus == ECHStatus::Accepted || cookieHasECH) {
    if (!decrypter) {
      throw FizzException(
          "ech accepted but no decrypter set up",
          AlertDescription::internal_error);
    }
    if (!echExt) {
      throw FizzException(
          "ech not sent for hrr", AlertDescription::missing_extension);
    }
    if (!echExt->enc->empty()) {
      throw FizzException(
          "hrr ech enc not empty", AlertDescription::illegal_parameter);
    }
  }

  if (echStatus == ECHStatus::Accepted) {
    // Stateful HRR first.
    if (state.echState()->cipherSuite != echExt->cipher_suite) {
      throw FizzException(
          "ech hrr cipher suite mismatch", AlertDescription::illegal_parameter);
    }
    if (state.echState()->configId != echExt->config_id) {
      throw FizzException(
          "ech hrr config id mismatch", AlertDescription::illegal_parameter);
    }

    chlo =
        decrypter->decryptClientHelloHRR(chlo, state.echState()->hpkeContext);

    return {ECHStatus::Accepted, echExt->config_id};
  } else if (cookieHasECH) {
    // Stateless HRR now
    if (*cookieState->echCipherSuite != echExt->cipher_suite) {
      throw FizzException(
          "ech hrr cipher suite mismatch", AlertDescription::illegal_parameter);
    }
    if (*cookieState->echConfigId != echExt->config_id) {
      throw FizzException(
          "ech hrr config id mismatch", AlertDescription::illegal_parameter);
    }

    chlo = decrypter->decryptClientHelloHRR(chlo, cookieState->echEnc);

    return {ECHStatus::Accepted, echExt->config_id};
  }

  // Just return the ECH status as is
  return {echStatus, 0};
}
