static SemiFuture<Optional<AsyncKeyExchange::DoKexResult>> doKexFuture(
    KeyExchange* pKex,
    std::unique_ptr<folly::IOBuf> clientShare) {
  auto pAsyncKex = dynamic_cast<AsyncKeyExchange*>(pKex);
  if (pAsyncKex) {
    auto fut = pAsyncKex->doAsyncKexFuture(std::move(clientShare));
    return std::move(fut).deferValue([](AsyncKeyExchange::DoKexResult res) {
      return Optional(std::move(res));
    });
  } else {
    return doKexSyncFuture(pKex, std::move(clientShare));
  }
}
