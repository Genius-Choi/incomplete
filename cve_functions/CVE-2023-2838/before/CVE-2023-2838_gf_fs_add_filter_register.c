void gf_fs_add_filter_register(GF_FilterSession *fsess, const GF_FilterRegister *freg)
{
	if (!freg) return;
	if (!fsess) {
		if (freg->register_free) freg->register_free(fsess, (GF_FilterRegister *)freg);
		return;
	}

	if (!freg->name) {
		GF_LOG(GF_LOG_ERROR, GF_LOG_FILTER, ("Filter missing name - ignoring\n"));
		if (freg->register_free) freg->register_free(fsess, (GF_FilterRegister *)freg);
		return;
	}
#if 0
	if (strchr(freg->name, fsess->sep_args)	) {
		GF_LOG(GF_LOG_ERROR, GF_LOG_FILTER, ("Filter name cannot contain argument separator %c - ignoring\n", fsess->sep_args));
		if (freg->register_free) freg->register_free(fsess, (GF_FilterRegister *)freg);
		return;
	}
	if (strchr(freg->name, fsess->sep_name)) {
		GF_LOG(GF_LOG_ERROR, GF_LOG_FILTER, ("Filter name cannot contain argument value separator %c - ignoring\n", fsess->sep_name));
		if (freg->register_free) freg->register_free(fsess, (GF_FilterRegister *)freg);
		return;
	}
#endif
	if (!freg->process) {
		GF_LOG(GF_LOG_ERROR, GF_LOG_FILTER, ("Filter %s missing process function - ignoring\n", freg->name));
		if (freg->register_free) freg->register_free(fsess, (GF_FilterRegister *)freg);
		return;
	}

	//except for meta filters, don't accept a filter with input caps but no output caps
	//meta filters do follow the same rule, however when expanding them for help we may have weird cases
	//where no config is set but inputs are listed to expose mime types or extensions (cf ffdmx)
	if (!(freg->flags & GF_FS_REG_META)
		&& !freg->configure_pid
		&& gf_filter_has_in_caps(freg->caps, freg->nb_caps)
	) {
		GF_LOG(GF_LOG_ERROR, GF_LOG_FILTER, ("Filter %s missing configure_pid function but has input capabilities - ignoring\n", freg->name));
		if (freg->register_free) freg->register_free(fsess, (GF_FilterRegister *)freg);
		return;
	}

	gf_mx_p(fsess->filters_mx);
	gf_list_add(fsess->registry, (void *) freg);
	gf_mx_v(fsess->filters_mx);

	if (fsess->init_done && fsess->links && gf_list_count( fsess->links)) {
		gf_filter_sess_build_graph(fsess, freg);
	}
}
