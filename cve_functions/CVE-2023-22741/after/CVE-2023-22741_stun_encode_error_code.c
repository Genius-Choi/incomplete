int stun_encode_error_code(stun_attr_t *attr) {
  short int class, num;
  size_t phrase_len, padded;
  stun_attr_errorcode_t *error;

  error = (stun_attr_errorcode_t *) attr->pattr;
  class = error->code / 100;
  num = error->code % 100;

  phrase_len = strlen(error->phrase);
  if (phrase_len + 8 > 65536)
    phrase_len = 65536 - 8;

  /* note: align the phrase len (see RFC3489:11.2.9) */
  padded = phrase_len + (phrase_len % 4 == 0 ? 0 : 4 - (phrase_len % 4));

  /* note: error-code has four octets of headers plus the
   *       reason field -> len+4 octets */
  if (stun_encode_type_len(attr, (uint16_t)(padded + 4)) < 0) {
    return -1;
  }
  else {
    assert(attr->enc_buf.size == padded + 8);
    memset(attr->enc_buf.data+4, 0, 2);
    attr->enc_buf.data[6] = class;
    attr->enc_buf.data[7] = num;
    /* note: 4 octets of TLV header and 4 octets of error-code header */
    memcpy(attr->enc_buf.data+8, error->phrase,
	   phrase_len);
    memset(attr->enc_buf.data + 8 + phrase_len, 0, padded - phrase_len);
  }

  return attr->enc_buf.size;
}
