static int var_matched_vars_generate(modsec_rec *msr, msre_var *var, msre_rule *rule,
        apr_table_t *vartab, apr_pool_t *mptmp)
{
    const apr_array_header_t *arr = NULL;
    const apr_table_entry_t *te = NULL;
    int i, count = 0;

    arr = apr_table_elts(msr->matched_vars);
    te = (apr_table_entry_t *)arr->elts;
    for (i = 0; i < arr->nelts; i++) {
        int match = 0;
        msc_string *str = (msc_string *)te[i].val;

        /* Figure out if we want to include this variable. */
        if (var->param == NULL) match = 1;
        else {
            if (var->param_data != NULL) { /* Regex. */
                char *my_error_msg = NULL;
                if (!(msc_regexec((msc_regex_t *)var->param_data, str->name,
                                strlen(str->name), &my_error_msg) == PCRE_ERROR_NOMATCH)) match = 1;
            } else { /* Simple comparison. */
                if (strcasecmp(str->name, var->param) == 0) match = 1;
            }
        }

        /* If we had a match add this argument to the collection. */
        if (match && (strncmp(str->name,"MATCHED_VARS:",13) != 0) && (strncmp(str->name,"MATCHED_VARS_NAMES:",19))) {

            msre_var *rvar = apr_palloc(mptmp, sizeof(msre_var));

            rvar->param = NULL;
            rvar->param_data = NULL;
            rvar->metadata = NULL;
            rvar->param_regex = NULL;

            rvar->value = apr_pstrndup(mptmp, str->value, str->value_len);
            rvar->value_len = str->value_len;
            rvar->name = apr_psprintf(mptmp, "%s",
                    log_escape_nq(mptmp, str->name));

            if(var->is_counting == 0)
                rvar->is_counting = 0;
            else
                rvar->is_counting = 1;

            if(var->is_negated == 0)
                rvar->is_negated = 0;
            else
                rvar->is_negated = 1;

            apr_table_addn(vartab, rvar->name, (void *)rvar);

            if (msr->txcfg->debuglog_level >= 9) {
                msr_log(msr, 9, "Set variable \"%s\" value \"%s\" size %d to collection.", rvar->name, rvar->value, rvar->value_len);
            }

            count++;
        }
    }

    return count;
}
