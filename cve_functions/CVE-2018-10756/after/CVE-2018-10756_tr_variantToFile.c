int tr_variantToFile(tr_variant const* v, tr_variant_fmt fmt, char const* filename)
{
    char* tmp;
    tr_sys_file_t fd;
    int err = 0;
    char* real_filename;
    tr_error* error = NULL;

    /* follow symlinks to find the "real" file, to make sure the temporary
     * we build with tr_sys_file_open_temp() is created on the right partition */
    if ((real_filename = tr_sys_path_resolve(filename, NULL)) != NULL)
    {
        filename = real_filename;
    }

    /* if the file already exists, try to move it out of the way & keep it as a backup */
    tmp = tr_strdup_printf("%s.tmp.XXXXXX", filename);
    fd = tr_sys_file_open_temp(tmp, &error);

    if (fd != TR_BAD_SYS_FILE)
    {
        uint64_t nleft;

        /* save the variant to a temporary file */
        {
            struct evbuffer* buf = tr_variantToBuf(v, fmt);
            char const* walk = (char const*)evbuffer_pullup(buf, -1);
            nleft = evbuffer_get_length(buf);

            while (nleft > 0)
            {
                uint64_t n;

                if (!tr_sys_file_write(fd, walk, nleft, &n, &error))
                {
                    err = error->code;
                    break;
                }

                nleft -= n;
                walk += n;
            }

            evbuffer_free(buf);
        }

        tr_sys_file_close(fd, NULL);

        if (nleft > 0)
        {
            tr_logAddError(_("Couldn't save temporary file \"%1$s\": %2$s"), tmp, error->message);
            tr_sys_path_remove(tmp, NULL);
            tr_error_free(error);
        }
        else
        {
            tr_error_clear(&error);

            if (tr_sys_path_rename(tmp, filename, &error))
            {
                tr_logAddInfo(_("Saved \"%s\""), filename);
            }
            else
            {
                err = error->code;
                tr_logAddError(_("Couldn't save file \"%1$s\": %2$s"), filename, error->message);
                tr_sys_path_remove(tmp, NULL);
                tr_error_free(error);
            }
        }
    }
    else
    {
        err = error->code;
        tr_logAddError(_("Couldn't save temporary file \"%1$s\": %2$s"), tmp, error->message);
        tr_error_free(error);
    }

    tr_free(tmp);
    tr_free(real_filename);
    return err;
}
