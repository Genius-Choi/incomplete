void ProxyFilterIntegrationTest::testConnectionTiming(IntegrationStreamDecoderPtr& response,
                                                      bool cached_dns, int64_t original_usec) {
  int64_t handshake_end;
  int64_t dns_start = getHeaderValue(response->headers(), "dns_start");
  int64_t dns_end = getHeaderValue(response->headers(), "dns_end");
  int64_t connect_start = getHeaderValue(response->headers(), "upstream_connect_start");
  int64_t connect_end = getHeaderValue(response->headers(), "upstream_connect_complete");
  int64_t request_send_end = getHeaderValue(response->headers(), "request_send_end");
  int64_t response_begin = getHeaderValue(response->headers(), "response_begin");
  Event::DispatcherImpl dispatcher("foo", *api_, timeSystem());

  ASSERT_LT(original_usec, dns_start);
  ASSERT_LE(dns_start, dns_end);
  if (cached_dns) {
    ASSERT_GE(dns_end, connect_start);
  } else {
    ASSERT_LE(dns_end, connect_start);
  }
  if (upstream_tls_) {
    handshake_end = getHeaderValue(response->headers(), "upstream_handshake_complete");
    ASSERT_LE(connect_end, handshake_end);
    ASSERT_LE(handshake_end, request_send_end);
    ASSERT_LT(handshake_end, timeSystem().monotonicTime().time_since_epoch().count());
  }
  ASSERT_LE(connect_start, connect_end);
  ASSERT_LE(request_send_end, response_begin);
}
