build_misc_local_traffic_drop_flows_for_lrouter(
        struct ovn_datapath *od, struct hmap *lflows)
{
    if (od->nbr) {
        /* Allow IGMP and MLD packets (with TTL = 1) if the router is
         * configured to flood them statically on some ports.
         */
        if (od->mcast_info.rtr.flood_static) {
            ovn_lflow_add(lflows, od, S_ROUTER_IN_IP_INPUT, 120,
                          "igmp && ip.ttl == 1", "next;");
            ovn_lflow_add(lflows, od, S_ROUTER_IN_IP_INPUT, 120,
                          "(mldv1 || mldv2) && ip.ttl == 1", "next;");
        }

        /* L3 admission control: drop multicast and broadcast source, localhost
         * source or destination, and zero network source or destination
         * (priority 100). */
        ovn_lflow_add(lflows, od, S_ROUTER_IN_IP_INPUT, 100,
                      "ip4.src_mcast ||"
                      "ip4.src == 255.255.255.255 || "
                      "ip4.src == 127.0.0.0/8 || "
                      "ip4.dst == 127.0.0.0/8 || "
                      "ip4.src == 0.0.0.0/8 || "
                      "ip4.dst == 0.0.0.0/8",
                      debug_drop_action());

        /* Drop ARP packets (priority 85). ARP request packets for router's own
         * IPs are handled with priority-90 flows.
         * Drop IPv6 ND packets (priority 85). ND NA packets for router's own
         * IPs are handled with priority-90 flows.
         */
        ovn_lflow_add(lflows, od, S_ROUTER_IN_IP_INPUT, 85,
                      "arp || nd", debug_drop_action());

        /* Allow IPv6 multicast traffic that's supposed to reach the
         * router pipeline (e.g., router solicitations).
         */
        ovn_lflow_add(lflows, od, S_ROUTER_IN_IP_INPUT, 84, "nd_rs || nd_ra",
                      "next;");

        /* Drop other reserved multicast. */
        ovn_lflow_add(lflows, od, S_ROUTER_IN_IP_INPUT, 83,
                      "ip6.mcast_rsvd", debug_drop_action());

        /* Allow other multicast if relay enabled (priority 82). */
        ovn_lflow_add(lflows, od, S_ROUTER_IN_IP_INPUT, 82,
                      "ip4.mcast || ip6.mcast",
                      (od->mcast_info.rtr.relay ? "next;" :
                                                  debug_drop_action()));

        /* Drop Ethernet local broadcast.  By definition this traffic should
         * not be forwarded.*/
        ovn_lflow_add(lflows, od, S_ROUTER_IN_IP_INPUT, 50,
                      "eth.bcast", debug_drop_action());

        /* Avoid ICMP time exceeded for multicast, silent drop instead.
         * See RFC1812 section 5.3.1:
         *  If the TTL is reduced to zero (or less), the packet MUST be
         *  discarded, and if the destination is NOT A MULTICAST address the
         *  router MUST send an ICMP Time Exceeded message ...
         *
         * The reason behind is that TTL has special meanings for multicast.
         * For example, TTL = 1 means restricted to the same subnet, not
         * forwarded by the router. So it is very common to see multicast
         * packets with ttl = 1, and generating ICMP for such packets is
         * harmful from both slowpath performance and functionality point of
         * view.
         *
         * (priority-31 flows will send ICMP time exceeded) */
        ovn_lflow_add(lflows, od, S_ROUTER_IN_IP_INPUT, 32,
                      "ip.ttl == {0, 1} && !ip.later_frag && "
                      "(ip4.mcast || ip6.mcast)", debug_drop_action());

        /* TTL discard */
        ovn_lflow_add(lflows, od, S_ROUTER_IN_IP_INPUT, 30,
                      "ip.ttl == {0, 1}", debug_drop_action());

        /* Pass other traffic not already handled to the next table for
         * routing. */
        ovn_lflow_add(lflows, od, S_ROUTER_IN_IP_INPUT, 0, "1", "next;");
    }
}
