void belle_sip_provider_dispatch_message(belle_sip_provider_t *prov, belle_sip_message_t *msg){
	int message_integrity_verified = TRUE;
	
#ifndef BELLE_SIP_DONT_CHECK_HEADERS_IN_MESSAGE
	message_integrity_verified = belle_sip_message_check_headers(msg);
#endif

	if (belle_sip_message_is_request(msg)){
		if (message_integrity_verified) belle_sip_provider_dispatch_request(prov,(belle_sip_request_t*)msg);
		else{
			belle_sip_response_t *resp=belle_sip_response_create_from_request(BELLE_SIP_REQUEST(msg),400);
			if (resp){
				belle_sip_provider_send_response(prov,resp);
			}
		}
	}else{
		if (message_integrity_verified){
			belle_sip_provider_dispatch_response(prov,(belle_sip_response_t*)msg);
		}else if (!prov->response_integrity_checking_enabled){
			belle_sip_message("response_integrity_checking is disabled, the response is notified despite it is invalid.");
			belle_sip_provider_dispatch_response(prov,(belle_sip_response_t*)msg);
		}else{
			/* the response will be silently discarded */
		}
	}
	belle_sip_object_unref(msg);
}
