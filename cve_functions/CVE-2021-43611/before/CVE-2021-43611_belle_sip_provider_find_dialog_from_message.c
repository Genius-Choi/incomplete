belle_sip_dialog_t *belle_sip_provider_find_dialog_from_message(belle_sip_provider_t *prov, belle_sip_message_t *msg, int as_uas){
	belle_sip_header_call_id_t *call_id;
	belle_sip_header_from_t *from;
	belle_sip_header_to_t *to;
	const char *from_tag;
	const char *to_tag;
	const char *call_id_value;
	const char *local_tag,*remote_tag;

	if (belle_sip_message_is_request(msg)){
		belle_sip_request_t *req=BELLE_SIP_REQUEST(msg);
		if (req->dialog)
			return req->dialog;
	}

	to=belle_sip_message_get_header_by_type(msg,belle_sip_header_to_t);

	if (to==NULL || (to_tag=belle_sip_header_to_get_tag(to))==NULL){
		/* a request without to tag cannot be part of a dialog */
		return NULL;
	}

	call_id=belle_sip_message_get_header_by_type(msg,belle_sip_header_call_id_t);
	from=belle_sip_message_get_header_by_type(msg,belle_sip_header_from_t);

	if (call_id==NULL || from==NULL || (from_tag=belle_sip_header_from_get_tag(from))==NULL) return NULL;

	call_id_value=belle_sip_header_call_id_get_call_id(call_id);
	local_tag=as_uas ? to_tag : from_tag;
	remote_tag=as_uas ? from_tag : to_tag;
	return belle_sip_provider_find_dialog(prov,call_id_value,local_tag,remote_tag);
}
