njs_json_stringify_iterator(njs_vm_t *vm, njs_json_stringify_t *stringify,
    njs_value_t *object)
{
    u_char            *p;
    int64_t           size, length;
    njs_int_t         ret;
    njs_chb_t         chain;
    njs_value_t       *key, *value, index, wrapper;
    njs_object_t      *obj;
    njs_json_state_t  *state;

    obj = njs_json_wrap_value(vm, &wrapper, object);
    if (njs_slow_path(obj == NULL)) {
        goto memory_error;
    }

    state = njs_json_push_stringify_state(vm, stringify, &wrapper);
    if (njs_slow_path(state == NULL)) {
        goto memory_error;
    }

    njs_chb_init(&chain, vm->mem_pool);

    for ( ;; ) {
        if (state->index == 0) {
            njs_chb_append(&chain, state->array ? "[" : "{", 1);
            njs_json_stringify_indent(stringify, &chain, 0);
        }

        if (njs_json_stringify_done(state, state->array)) {
            njs_json_stringify_indent(stringify, &chain, -1);
            njs_chb_append(&chain, state->array ? "]" : "}", 1);

            state = njs_json_pop_stringify_state(stringify);
            if (state == NULL) {
                goto done;
            }

            continue;
        }

        value = &stringify->retval;

        if (state->array) {
            njs_set_number(&index, state->index);
            key = &index;

        } else {
            key = &state->keys->start[state->index];
        }

        ret = njs_value_property(vm, &state->value, key, value);
        if (njs_slow_path(ret == NJS_ERROR)) {
            return ret;
        }

        if (state->array && ret == NJS_DECLINED) {
            njs_set_null(value);
        }

        ret = njs_json_stringify_to_json(stringify, state, key, value);
        if (njs_slow_path(ret != NJS_OK)) {
            return ret;
        }

        ret = njs_json_stringify_replacer(stringify, state, key, value);
        if (njs_slow_path(ret != NJS_OK)) {
            return ret;
        }

        state->index++;

        if (!state->array
            && (njs_is_undefined(value)
                || njs_is_symbol(value)
                || njs_is_function(value)
                || !njs_is_valid(value)))
        {
            continue;
        }

        if (state->written) {
            njs_chb_append_literal(&chain,",");
            njs_json_stringify_indent(stringify, &chain, 0);
        }

        state->written = 1;

        if (!state->array) {
            njs_json_append_string(&chain, key, '\"');
            njs_chb_append_literal(&chain,":");
            if (stringify->space.length != 0) {
                njs_chb_append_literal(&chain," ");
            }
        }

        if (njs_json_is_object(value)) {
            state = njs_json_push_stringify_state(vm, stringify, value);
            if (njs_slow_path(state == NULL)) {
                return NJS_ERROR;
            }

            continue;
        }

        ret = njs_json_append_value(vm, &chain, value);
        if (njs_slow_path(ret != NJS_OK)) {
            return ret;
        }
    }

done:

    /*
     * The value to stringify is wrapped as '{"": value}'.
     * Stripping the wrapper's data.
     */

    njs_chb_drain(&chain, njs_length("{\"\":"));
    njs_chb_drop(&chain, njs_length("}"));

    if (stringify->space.length != 0) {
        njs_chb_drain(&chain, njs_length("\n "));
        njs_chb_drop(&chain, njs_length("\n"));
    }

    size = njs_chb_size(&chain);
    if (njs_slow_path(size < 0)) {
        njs_chb_destroy(&chain);
        goto memory_error;
    }

    if (size == 0) {
        njs_set_undefined(&vm->retval);
        goto release;
    }

    length = njs_chb_utf8_length(&chain);

    p = njs_string_alloc(vm, &vm->retval, size, length);
    if (njs_slow_path(p == NULL)) {
        njs_chb_destroy(&chain);
        goto memory_error;
    }

    njs_chb_join_to(&chain, p);

release:

    njs_chb_destroy(&chain);

    return NJS_OK;

memory_error:

    njs_memory_error(vm);

    return NJS_ERROR;
}
