njs_vm_value_dump(njs_vm_t *vm, njs_str_t *retval, njs_value_t *value,
    njs_uint_t console, njs_uint_t indent)
{
    njs_int_t             ret;
    njs_chb_t             chain;
    njs_str_t             str;
    njs_value_t           *key, *val, tag;
    njs_json_state_t      *state;
    njs_string_prop_t     string;
    njs_object_prop_t     *prop;
    njs_property_query_t  pq;
    njs_json_stringify_t  *stringify, dump_stringify;

    stringify = &dump_stringify;

    stringify->vm = vm;
    stringify->depth = 0;

    njs_chb_init(&chain, vm->mem_pool);

    if (!njs_dump_is_recursive(value)) {
        ret = njs_dump_terminal(stringify, &chain, value, console);
        if (njs_slow_path(ret != NJS_OK)) {
            goto memory_error;
        }

        goto done;
    }

    njs_set_undefined(&stringify->replacer);
    stringify->keys_type = NJS_ENUM_STRING | NJS_ENUM_SYMBOL;
    indent = njs_min(indent, 10);
    stringify->space.length = indent;
    stringify->space.start = stringify->space_buf;

    njs_memset(stringify->space.start, ' ', indent);

    state = njs_json_push_stringify_state(vm, stringify, value);
    if (njs_slow_path(state == NULL)) {
        goto memory_error;
    }

    for ( ;; ) {
        if (state->index == 0) {
            ret = njs_object_string_tag(vm, &state->value, &tag);
            if (njs_slow_path(ret == NJS_ERROR)) {
                return ret;
            }

            if (ret == NJS_OK) {
                (void) njs_string_prop(&string, &tag);
                njs_chb_append(&chain, string.start, string.size);
                njs_chb_append_literal(&chain, " ");
            }

            njs_chb_append(&chain, state->array ? "[" : "{", 1);
            njs_json_stringify_indent(stringify, &chain, 1);
        }

        if (njs_json_stringify_done(state, state->fast_array)) {
            njs_dump_empty(stringify, state, &chain, 0);

            njs_json_stringify_indent(stringify, &chain, 0);
            njs_chb_append(&chain, state->array ? "]" : "}", 1);

            state = njs_json_pop_stringify_state(stringify);
            if (state == NULL) {
                goto done;
            }

            continue;
        }

        if (state->fast_array) {
            if (state->written) {
                njs_chb_append_literal(&chain, ",");
                njs_json_stringify_indent(stringify, &chain, 1);
            }

            state->written = 1;

            val = &njs_array_start(&state->value)[state->index++];

        } else {
            njs_property_query_init(&pq, NJS_PROPERTY_QUERY_GET, 0);

            key = &state->keys->start[state->index++];
            state->key = key;

            ret = njs_property_query(vm, &pq, &state->value, key);
            if (njs_slow_path(ret != NJS_OK)) {
                if (ret == NJS_DECLINED) {
                    continue;
                }

                goto exception;
            }

            prop = pq.lhq.value;

            if (prop->type == NJS_WHITEOUT || !prop->enumerable) {
                continue;
            }

            if (state->written) {
                njs_chb_append_literal(&chain, ",");
                njs_json_stringify_indent(stringify, &chain, 1);
            }

            state->written = 1;

            njs_dump_empty(stringify, state, &chain, 1);

            if (!state->array || isnan(njs_key_to_index(key))) {
                njs_key_string_get(vm, key, &pq.lhq.key);
                njs_chb_append(&chain, pq.lhq.key.start, pq.lhq.key.length);
                njs_chb_append_literal(&chain, ":");
                if (stringify->space.length != 0) {
                    njs_chb_append_literal(&chain, " ");
                }
            }

            val = &prop->value;

            if (prop->type == NJS_PROPERTY_HANDLER) {
                pq.scratch = *prop;
                prop = &pq.scratch;
                ret = prop->value.data.u.prop_handler(vm, prop, &state->value,
                                                      NULL, &prop->value);

                if (njs_slow_path(ret == NJS_ERROR)) {
                    return ret;
                }

                val = &prop->value;
            }

            if (njs_is_accessor_descriptor(prop)) {
                if (njs_is_defined(&prop->getter)) {
                    if (njs_is_defined(&prop->setter)) {
                        val = njs_value_arg(&string_get_set);

                    } else {
                        val = njs_value_arg(&string_get);
                    }

                } else {
                    val = njs_value_arg(&string_set);
                }
            }
        }

        if (njs_dump_is_recursive(val)) {
            if (njs_slow_path(njs_dump_visited(vm, stringify, val))) {
                njs_chb_append_literal(&chain, "[Circular]");
                continue;
            }

            state = njs_json_push_stringify_state(vm, stringify, val);
            if (njs_slow_path(state == NULL)) {
                goto exception;
            }

            continue;
        }

        ret = njs_dump_terminal(stringify, &chain, val, console);
        if (njs_slow_path(ret != NJS_OK)) {
            if (ret == NJS_DECLINED) {
                goto exception;
            }

            goto memory_error;
        }
    }

done:

    ret = njs_chb_join(&chain, &str);
    if (njs_slow_path(ret != NJS_OK)) {
        goto memory_error;
    }

    njs_chb_destroy(&chain);

    *retval = str;

    return NJS_OK;

memory_error:

    njs_memory_error(vm);

exception:

    njs_vm_value_string(vm, retval, &vm->retval);

    return NJS_OK;
}
