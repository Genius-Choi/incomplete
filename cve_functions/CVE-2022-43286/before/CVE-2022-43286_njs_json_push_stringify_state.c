njs_json_push_stringify_state(njs_vm_t *vm, njs_json_stringify_t *stringify,
    njs_value_t *value)
{
    njs_int_t         ret;
    njs_json_state_t  *state;

    if (njs_slow_path(stringify->depth >= NJS_JSON_MAX_DEPTH)) {
        njs_type_error(vm, "Nested too deep or a cyclic structure");
        return NULL;
    }

    state = &stringify->states[stringify->depth++];
    state->value = *value;
    state->array = njs_is_array(value);
    state->fast_array = njs_is_fast_array(value);
    state->index = 0;
    state->written = 0;
    state->keys = NULL;
    state->key = NULL;

    if (state->fast_array) {
        state->length = njs_array_len(value);
    }

    if (njs_is_array(&stringify->replacer)) {
        state->keys = njs_array(&stringify->replacer);

    } else if (state->array && !state->fast_array) {
        state->keys = njs_array_keys(vm, value, 0);
        if (njs_slow_path(state->keys == NULL)) {
            return NULL;
        }

        ret = njs_object_length(vm, &state->value, &state->length);
        if (njs_slow_path(ret == NJS_ERROR)) {
            return NULL;
        }

    } else {
        state->keys = njs_value_own_enumerate(vm, value, NJS_ENUM_KEYS,
                                              stringify->keys_type, 0);

        if (njs_slow_path(state->keys == NULL)) {
            return NULL;
        }
    }

    return state;
}
