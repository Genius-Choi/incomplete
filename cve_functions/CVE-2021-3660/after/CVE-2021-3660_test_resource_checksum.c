test_resource_checksum (TestResourceCase *tc,
                        gconstpointer data)
{
  CockpitWebResponse *response;
  GError *error = NULL;
  GBytes *bytes;
  gconstpointer str;
  const gchar *expected = "HTTP/1.1 200 OK\r\n"
    STATIC_HEADERS
    "ETag: \"" CHECKSUM "-c\"\r\n"
    "Access-Control-Allow-Origin: http://localhost\r\n"
    "Transfer-Encoding: chunked\r\n"
    "Cache-Control: max-age=31556926, public\r\n"
    "\r\n"
    "32\r\n"
    "These are the contents of file.ext\nOh marmalaaade\n"
    "\r\n"
    "0\r\n\r\n";

  /* We require that no user packages are loaded, so we have a checksum */
  g_assert (data == &checksum_fixture);

  request_checksum (tc);

  response = cockpit_web_response_new (tc->io, "/unused", "/unused", NULL, NULL, COCKPIT_WEB_RESPONSE_NONE);
  cockpit_channel_response_serve (tc->service, tc->headers, response,
                                CHECKSUM,
                                "/test/sub/file.ext");

  while (cockpit_web_response_get_state (response) != COCKPIT_WEB_RESPONSE_SENT)
    g_main_context_iteration (NULL, TRUE);

  g_output_stream_close (G_OUTPUT_STREAM (tc->output), NULL, &error);
  g_assert_no_error (error);

  bytes = g_memory_output_stream_steal_as_bytes (tc->output);
  str = g_bytes_get_data (bytes, NULL);
  g_assert (str_contains_strv (str, expected, "\n"));
  cockpit_assert_strmatch (str,
                           "*\r\n"
                           "32\r\n"
                           "These are the contents of file.ext\nOh marmalaaade\n"
                           "\r\n"
                           "0\r\n\r\n");

  g_bytes_unref (bytes);
  g_object_unref (response);
}
