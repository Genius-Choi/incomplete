test_large (TestCase *tc,
            gconstpointer fixture)
{
  GError *error = NULL;
  gchar *contents;
  gsize length;
  gsize prefixlength;
  GBytes *data;
  GBytes *sub;
  guint count;
  JsonObject *object;

  g_assert (fixture == &fixture_large);

  while (tc->closed == FALSE)
    g_main_context_iteration (NULL, TRUE);
  g_assert_cmpstr (tc->problem, ==, NULL);

  g_assert (g_file_get_contents (SRCDIR "/src/bridge/mock-resource/system/cockpit/test/sub/COPYING",
                                 &contents, &length, &error));
  g_assert_no_error (error);

  data = mock_transport_combine_output (tc->transport, "444", &count);

  /* Should not have been sent as one block */
  g_assert_cmpuint (count, ==, 8);
  prefixlength = strcspn (g_bytes_get_data (data, NULL), "}}") + 2;
  g_assert_cmpuint (g_bytes_get_size (data), >, prefixlength);
  object = cockpit_json_parse_object (g_bytes_get_data (data, NULL), prefixlength, &error);
  cockpit_assert_json_eq (object, "{\"status\":200,\"reason\":\"OK\",\"headers\":{" STATIC_HEADERS_CACHECONTROL "}}");
  sub = g_bytes_new_from_bytes (data, prefixlength, g_bytes_get_size (data) - prefixlength);
  cockpit_assert_bytes_eq (sub, contents, length);

  json_object_unref (object);
  g_bytes_unref (sub);
  g_bytes_unref (data);
  g_free (contents);
}
