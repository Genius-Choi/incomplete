setup_document_children(EpubDocument *epub_document,xmlNodePtr node)
{
    GList *index = NULL;
    
    xmlretval = NULL;
    xml_parse_children_of_node(node,(xmlChar*)"navPoint",NULL,NULL);
    xmlNodePtr navPoint = xmlretval;
    
    while(navPoint != NULL) {
    
        if ( !xmlStrcmp(navPoint->name,(xmlChar*)"navPoint")) {
    		xmlretval = NULL;
    		xml_parse_children_of_node(navPoint,(xmlChar*)"navLabel",NULL,NULL);
    		xmlNodePtr navLabel = xmlretval;
    		xmlretval = NULL;
    		gchar *fragment=NULL,*end=NULL;
    		GString *uri = NULL;
            GString *pagelink = NULL;

    		xml_parse_children_of_node(navLabel,(xmlChar*)"text",NULL,NULL);
    		
            linknode *newnode = g_new0(linknode,1);
            newnode->linktext = NULL;
            while (newnode->linktext == NULL) {
	            newnode->linktext = (gchar*)xml_get_data_from_node(xmlretval,XML_KEYWORD,NULL);
	            xmlretval = xmlretval->next;
            }
           
            xmlretval = NULL;
            xml_parse_children_of_node(navPoint,(xmlChar*)"content",NULL,NULL);
            pagelink = g_string_new(epub_document->documentdir);
            newnode->pagelink = (gchar*)xml_get_data_from_node(xmlretval,XML_ATTRIBUTE,(xmlChar*)"src");
            g_string_append_printf(pagelink,"/%s",newnode->pagelink);

            xmlFree(newnode->pagelink);

            gchar *escaped = g_strdup(pagelink->str);

            //unescaping any special characters
            pagelink->str = g_uri_unescape_string (escaped,NULL);
            g_free(escaped);

            // cut off fragment after '#', only in the last segment of path
            if ((end = g_strrstr(pagelink->str,"#")) != NULL && (end > g_strrstr(pagelink->str,"/"))) {
	            fragment = g_strdup(g_strrstr(pagelink->str,"#"));
	            *end = '\0';
            }
            
            uri = g_string_new(g_filename_to_uri(pagelink->str,NULL,NULL));
            
            // handle the html extension (IssueID #266)
            if (g_strrstr(uri->str, ".html") != NULL)
                g_string_insert_c (uri, uri->len-4, 'x');
                
            g_string_free(pagelink,TRUE);

            if (fragment) {
	            g_string_append(uri,fragment);
            }

            newnode->pagelink = g_strdup(uri->str);
            newnode->children = setup_document_children(epub_document, navPoint);
            g_string_free(uri,TRUE);
            index = g_list_prepend(index,newnode);
        } 

        navPoint = navPoint->next;
    }
    
    return g_list_reverse (index);
}
