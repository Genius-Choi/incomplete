    .SetShapeFn([](InferenceContext* c) {
      ShapeHandle unused;
      TF_RETURN_IF_ERROR(c->WithRankAtLeast(c->input(0), 1, &unused));
      TF_RETURN_IF_ERROR(c->WithRank(c->input(1), 0, &unused));

      DimensionHandle fingerprint_size;
      const Tensor* method = c->input_tensor(1);
      if (method == nullptr) {
        fingerprint_size = c->UnknownDim();
      } else {
        if (method->dims() != 0) {
          return errors::InvalidArgument("`method` must be rank 0: ",
                                         method->shape());
        }
        const string& method_string = method->scalar<tstring>()();
        if (method_string != "farmhash64") {
          return errors::InvalidArgument("Unsupported method: ", method_string);
        }
        fingerprint_size = c->MakeDim(sizeof(uint64));
      }

      DimensionHandle batch = c->Dim(c->input(0), 0);
      c->set_output(0, c->MakeShape({batch, fingerprint_size}));
      return OkStatus();
    });
