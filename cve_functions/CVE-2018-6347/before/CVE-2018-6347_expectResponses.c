  void expectResponses(uint32_t n, uint32_t code = 200,
                       ErrorCode errorCode = ErrorCode::NO_ERROR,
                       bool expect100 = false, bool expectGoaway = false) {
    clientCodec_->setCallback(&callbacks_);
    if (isParallelCodecProtocol(clientCodec_->getProtocol())) {
      EXPECT_CALL(callbacks_, onSettings(_))
        .WillOnce(Invoke([this] (const SettingsList& settings) {
              if (flowControl_[0] > 0) {
                bool foundInitialWindow = false;
                for (const auto& setting: settings) {
                  if (setting.id == SettingsId::INITIAL_WINDOW_SIZE) {
                    EXPECT_EQ(flowControl_[0], setting.value);
                    foundInitialWindow = true;
                  }
                }
                EXPECT_TRUE(foundInitialWindow);
              }
            }));
    }
    if (flowControl_[2] > 0) {
      int64_t sessionDelta =
        flowControl_[2] - clientCodec_->getDefaultWindowSize();
      if (clientCodec_->supportsSessionFlowControl() && sessionDelta) {
        EXPECT_CALL(callbacks_, onWindowUpdate(0, sessionDelta));
      }
    }
    if (flowControl_[1] > 0) {
      size_t initWindow = flowControl_[0] > 0 ?
        flowControl_[0] : clientCodec_->getDefaultWindowSize();
      int64_t streamDelta = flowControl_[1] - initWindow;
      if (clientCodec_->supportsStreamFlowControl() && streamDelta) {
        EXPECT_CALL(callbacks_, onWindowUpdate(1, streamDelta));
      }
    }

    if (expectGoaway) {
      EXPECT_CALL(callbacks_, onGoaway(HTTPCodec::StreamID(1),
                                      ErrorCode::NO_ERROR, _));
    }

    for (uint32_t i = 0; i < n; i++) {
      uint8_t times = (expect100) ? 2 : 1;
      EXPECT_CALL(callbacks_, onMessageBegin(_, _))
        .Times(times).RetiresOnSaturation();
      EXPECT_CALL(callbacks_, onHeadersComplete(_, _))
        .WillOnce(Invoke([code] (HTTPCodec::StreamID,
                                 std::shared_ptr<HTTPMessage> msg) {
                           EXPECT_EQ(msg->getStatusCode(), code);
                         }));
      if (expect100) {
        EXPECT_CALL(callbacks_, onHeadersComplete(_, _))
          .WillOnce(Invoke([] (HTTPCodec::StreamID,
                               std::shared_ptr<HTTPMessage> msg) {
                             EXPECT_EQ(msg->getStatusCode(), 100);
                           }))
          .RetiresOnSaturation();
      }
      if (errorCode != ErrorCode::NO_ERROR) {
        EXPECT_CALL(callbacks_, onAbort(_, _))
          .WillOnce(Invoke([errorCode] (HTTPCodec::StreamID,
                                        ErrorCode error) {
                             EXPECT_EQ(error, errorCode);
                         }));
      }
      EXPECT_CALL(callbacks_, onBody(_, _, _)).RetiresOnSaturation();
      EXPECT_CALL(callbacks_, onMessageComplete(_, _)).RetiresOnSaturation();
    }
    parseOutput(*clientCodec_);
  }
