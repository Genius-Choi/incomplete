  explicit HTTPDownstreamTest(
    std::vector<int64_t> flowControl = { -1, -1, -1 },
    bool startImmediately = true)
    : eventBase_(),
      transport_(new TestAsyncTransport(&eventBase_)),
      transactionTimeouts_(makeTimeoutSet(&eventBase_)),
      flowControl_(flowControl) {
    EXPECT_CALL(mockController_, getGracefulShutdownTimeout())
      .WillRepeatedly(Return(std::chrono::milliseconds(0)));
    EXPECT_CALL(mockController_, attachSession(_))
      .WillRepeatedly(Invoke([&] (HTTPSessionBase* session) {
        session->setPrioritySampled(true);
      }));
    HTTPSession::setDefaultReadBufferLimit(65536);
    auto codec = makeServerCodec<typename C::Codec>(C::version);
    rawCodec_ = codec.get();

    // If the codec is H2, getHeaderIndexingStrategy will be called when setting
    // up the codec
    if (rawCodec_->getProtocol() == CodecProtocol::HTTP_2) {
      EXPECT_CALL(mockController_, getHeaderIndexingStrategy())
        .WillOnce(
          Return(&testH2IndexingStrat_)
      );
    }

    httpSession_ = new HTTPDownstreamSession(
      transactionTimeouts_.get(),
      std::move(AsyncTransportWrapper::UniquePtr(transport_)),
      localAddr, peerAddr,
      &mockController_,
      std::move(codec),
      mockTransportInfo /* no stats for now */,
      nullptr);
    for (auto& param: flowControl) {
      if (param < 0) {
        param = rawCodec_->getDefaultWindowSize();
      }
    }

    // Ensure the H2 header indexing strategy was setup correctly if applicable
    if (rawCodec_->getProtocol() == CodecProtocol::HTTP_2) {
      HTTP2Codec* recastedCodec = dynamic_cast<HTTP2Codec*>(rawCodec_);
      EXPECT_EQ(
        recastedCodec->getHeaderIndexingStrategy(), &testH2IndexingStrat_);
    }

    httpSession_->setFlowControl(flowControl[0], flowControl[1],
                                 flowControl[2]);
    httpSession_->setEgressSettings({{ SettingsId::MAX_CONCURRENT_STREAMS, 80 },
                                     { SettingsId::HEADER_TABLE_SIZE, 5555 },
                                     { SettingsId::ENABLE_PUSH, 1 },
                                     { SettingsId::ENABLE_EX_HEADERS, 1 }});
    if (startImmediately) {
      httpSession_->startNow();
    }
    clientCodec_ = makeClientCodec<typename C::Codec>(C::version);
    if (clientCodec_->getProtocol() == CodecProtocol::HTTP_2) {
      clientCodec_->getEgressSettings()->setSetting(
        SettingsId::ENABLE_EX_HEADERS, 1);
    }
    clientCodec_->generateConnectionPreface(requests_);
    clientCodec_->setCallback(&callbacks_);
  }
