constructExtNeg(unsigned char type,
                DUL_ASSOCIATESERVICEPARAMETERS * params,
                SOPClassExtendedNegotiationSubItemList **lst,
                unsigned long *rtnLength)
{
    unsigned long length;
    *rtnLength = 0;

    if (type == DUL_TYPEASSOCIATERQ && params->requestedExtNegList != NULL) {
        *lst = new SOPClassExtendedNegotiationSubItemList;
        if (*lst == NULL) return EC_MemoryExhausted;
        appendList(*(params->requestedExtNegList), **lst);
    } else if (type == DUL_TYPEASSOCIATEAC && params->acceptedExtNegList != NULL) {
        *lst = new SOPClassExtendedNegotiationSubItemList;
        if (*lst == NULL)  return EC_MemoryExhausted;
        appendList(*(params->acceptedExtNegList), **lst);
    }

    if (*lst != NULL) {
        OFListIterator(SOPClassExtendedNegotiationSubItem*) i = (*lst)->begin();
        while (i != (*lst)->end()) {
            SOPClassExtendedNegotiationSubItem* extNeg = *i;
            extNeg->itemType = 0x56;
            // recompute the length fields
            extNeg->sopClassUIDLength = OFstatic_cast(unsigned short, extNeg->sopClassUID.length());
            extNeg->itemLength = 2 + extNeg->sopClassUIDLength + extNeg->serviceClassAppInfoLength;
            length = 4 + extNeg->itemLength;
            *rtnLength += length;

            ++i;
        }
    }

    return EC_Normal;
}
