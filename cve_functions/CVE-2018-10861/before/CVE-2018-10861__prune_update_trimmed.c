void OSDMonitor::_prune_update_trimmed(
    MonitorDBStore::TransactionRef tx,
    version_t first)
{
  dout(10) << __func__
           << " first " << first
           << " last_pinned " << osdmap_manifest.get_last_pinned()
           << " last_pinned " << osdmap_manifest.get_last_pinned()
           << dendl;

  if (!osdmap_manifest.is_pinned(first)) {
    osdmap_manifest.pin(first);
  }

  set<version_t>::iterator p_end = osdmap_manifest.pinned.find(first);
  set<version_t>::iterator p = osdmap_manifest.pinned.begin();
  osdmap_manifest.pinned.erase(p, p_end);
  ceph_assert(osdmap_manifest.get_first_pinned() == first);

  if (osdmap_manifest.get_last_pinned() == first+1 ||
      osdmap_manifest.pinned.size() == 1) {
    // we reached the end of the line, as pinned maps go; clean up our
    // manifest, and let `should_prune()` decide whether we should prune
    // again.
    tx->erase(get_service_name(), "osdmap_manifest");
    return;
  }

  bufferlist bl;
  osdmap_manifest.encode(bl);
  tx->put(get_service_name(), "osdmap_manifest", bl);
}
