addFileEntriesToResponse(const char* basepath, uint8_t* buffer, int bufPos, int maxBufSize, char* directoryName, char** continueAfterFileName, bool* moreFollows)
{
	int directoryNameLength = strlen(directoryName);

    DirectoryHandle directory = openDirectory(basepath, directoryName);

    if (directory != NULL) {

        bool isDirectory;
        char* fileName = FileSystem_readDirectory(directory, &isDirectory);

        while (fileName != NULL) {
        	directoryName[directoryNameLength] = 0;

        	if (directoryNameLength > 0) {
        		if (directoryName[directoryNameLength - 1] != '/')
        		    StringUtils_appendString(directoryName, 256, "/");
        	}

        	StringUtils_appendString(directoryName, 256, fileName);

            bufPos = addFileEntriesToResponse(basepath, buffer, bufPos, maxBufSize, directoryName, continueAfterFileName, moreFollows);

            if (*moreFollows == true)
                break;

            fileName = FileSystem_readDirectory(directory, &isDirectory);
        }

        FileSystem_closeDirectory(directory);
    }
    else {

        if (*continueAfterFileName != NULL) {
            if (strcmp(*continueAfterFileName, directoryName) == 0) {
                *continueAfterFileName = NULL;
            }
        }
        else {
            uint64_t msTime;

            uint32_t fileSize;

            if (getFileInfo(basepath, directoryName, &fileSize, &msTime)) {
                char gtString[30];

                Conversions_msTimeToGeneralizedTime(msTime, (uint8_t*) gtString);

                int fileAttributesSize = encodeFileAttributes(0xa1, fileSize, gtString, NULL, 0);

                int filenameSize = encodeFileSpecification(0xa0, directoryName, NULL, 0);

                int dirEntrySize = 2 + fileAttributesSize + filenameSize;

                int overallEntrySize = 1 + BerEncoder_determineLengthSize(dirEntrySize) + dirEntrySize;

                int bufferSpaceLeft = maxBufSize - bufPos;

                if (overallEntrySize > bufferSpaceLeft) {
                    *moreFollows = true;
                }
                else {

                    bufPos = BerEncoder_encodeTL(0x30, dirEntrySize, buffer, bufPos); /* SEQUENCE (DirectoryEntry) */
                    bufPos = encodeFileSpecification(0xa0, directoryName, buffer, bufPos); /* fileName */
                    bufPos = encodeFileAttributes(0xa1, fileSize, gtString, buffer, bufPos); /* file attributes */
                }
            }
            else
                bufPos = -1;

        }

    }

    directoryName[directoryNameLength] = 0;

    return bufPos;
}
