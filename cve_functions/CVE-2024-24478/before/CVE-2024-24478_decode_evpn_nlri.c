static int decode_evpn_nlri(proto_tree *tree, tvbuff_t *tvb, gint offset, packet_info *pinfo) {
    int reader_offset = offset;
    int start_offset = offset+2;
    proto_tree *prefix_tree;
    proto_item *ti;
    guint8 route_type;
    guint8 nlri_len;
    guint8 ip_len;
    guint32 total_length = 0;
    guint32 or_length;
    path_attr_data *data = NULL;
    proto_item *item;
    int ret;

    route_type = tvb_get_guint8(tvb, offset);

    nlri_len = tvb_get_guint8(tvb, offset + 1);

    ti = proto_tree_add_item(tree, hf_bgp_evpn_nlri, tvb, reader_offset,
                               nlri_len+2, ENC_NA);

    prefix_tree = proto_item_add_subtree(ti, ett_bgp_evpn_nlri);

    proto_tree_add_item(prefix_tree, hf_bgp_evpn_nlri_rt, tvb, reader_offset,
                        1, ENC_BIG_ENDIAN);
    proto_item_append_text(ti, ": %s", val_to_str(tvb_get_guint8(tvb, offset), evpnrtypevals, "Unknown capability %d"));
    /* moving to next field */
    reader_offset++;

    proto_tree_add_item(prefix_tree, hf_bgp_evpn_nlri_len, tvb, reader_offset,
                        1, ENC_BIG_ENDIAN);
    reader_offset++;

    switch (route_type) {
    case EVPN_AD_ROUTE:
    /*
                +---------------------------------------+
                |      RD   (8 octets)                  |
                +---------------------------------------+
                |Ethernet Segment Identifier (10 octets)|
                +---------------------------------------+
                |  Ethernet Tag ID (4 octets)           |
                +---------------------------------------+
                |  MPLS Label (3 octets)                |
                +---------------------------------------+
   */

        if (nlri_len < 25) {
            expert_add_info_format(pinfo, prefix_tree, &ei_bgp_evpn_nlri_rt_len_err,
                                   "Invalid length (%u) of EVPN NLRI Route Type 1 (Ethernet Auto-discovery Route)", nlri_len);
            return -1;
        }
        item = proto_tree_add_item(prefix_tree, hf_bgp_evpn_nlri_rd, tvb, reader_offset,
                                   8, ENC_NA);
        proto_item_append_text(item, " (%s)", decode_bgp_rd(pinfo->pool, tvb, reader_offset));
        reader_offset += 8;

        decode_evpn_nlri_esi(prefix_tree, tvb, reader_offset, pinfo);
        reader_offset += 10;
        proto_tree_add_item(prefix_tree, hf_bgp_evpn_nlri_etag, tvb, reader_offset,
                                   4, ENC_BIG_ENDIAN);
        reader_offset += 4;
        data = load_path_attr_data(pinfo);
        if (data && data->encaps_community_present &&
                (data->encaps_tunnel_type == BGP_EXT_COM_TUNNEL_VXLAN || data->encaps_tunnel_type == BGP_EXT_COM_TUNNEL_VXLANGPE)) {
            proto_tree_add_item(prefix_tree, hf_bgp_evpn_nlri_vni, tvb, reader_offset, 3, ENC_BIG_ENDIAN);
            reader_offset += 3;
        } else {
            proto_tree_add_item(prefix_tree, hf_bgp_evpn_nlri_mpls_ls1, tvb, reader_offset, 3, ENC_BIG_ENDIAN);
            reader_offset += 3;
        }
        total_length = reader_offset - offset;
        break;

    case EVPN_MAC_ROUTE:
/*
        +---------------------------------------+
        |      RD   (8 octets)                  |
        +---------------------------------------+
        |Ethernet Segment Identifier (10 octets)|
        +---------------------------------------+
        |  Ethernet Tag ID (4 octets)           |
        +---------------------------------------+
        |  MAC Address Length (1 octet)         |
        +---------------------------------------+
        |  MAC Address (6 octets)               |
        +---------------------------------------+
        |  IP Address Length (1 octet)          |
        +---------------------------------------+
        |  IP Address (0 or 4 or 16 octets)     |
        +---------------------------------------+
        |  MPLS Label1 (3 octets)               |
        +---------------------------------------+
        |  MPLS Label2 (0 or 3 octets)          |
        +---------------------------------------+

*/

        if (nlri_len < 33) {
            expert_add_info_format(pinfo, prefix_tree, &ei_bgp_evpn_nlri_rt_len_err,
                                   "Invalid length (%u) of EVPN NLRI Route Type 2 (MAC/IP Advertisement Route)", nlri_len);
            return -1;
        }
        item = proto_tree_add_item(prefix_tree, hf_bgp_evpn_nlri_rd, tvb, reader_offset,
                                   8, ENC_NA);
        proto_item_append_text(item, " (%s)", decode_bgp_rd(pinfo->pool, tvb, reader_offset));
        reader_offset += 8;

        decode_evpn_nlri_esi(prefix_tree, tvb, reader_offset, pinfo);
        reader_offset += 10;

        proto_tree_add_item(prefix_tree, hf_bgp_evpn_nlri_etag, tvb, reader_offset,
                            4, ENC_BIG_ENDIAN);
        reader_offset += 4;

        proto_tree_add_item(prefix_tree, hf_bgp_evpn_nlri_maclen, tvb, reader_offset,
                            1, ENC_BIG_ENDIAN);
        reader_offset += 1;

        proto_tree_add_item(prefix_tree, hf_bgp_evpn_nlri_mac_addr, tvb, reader_offset,
                            6, ENC_NA);
        reader_offset += 6;

        ip_len = tvb_get_guint8(tvb, reader_offset) / 8;
        proto_tree_add_item(prefix_tree, hf_bgp_evpn_nlri_iplen, tvb, reader_offset,
                            1, ENC_BIG_ENDIAN);
        reader_offset++;

        if (ip_len == 4) {
            /*IPv4 address*/
            if (nlri_len < 37) {
                expert_add_info_format(pinfo, prefix_tree, &ei_bgp_evpn_nlri_rt_len_err,
                                       "Invalid length (%u) of EVPN NLRI Route Type 2 (MAC/IP Advertisement Route)", nlri_len);
                return -1;
            }
            proto_tree_add_item(prefix_tree, hf_bgp_evpn_nlri_ip_addr, tvb, reader_offset,
                                4, ENC_NA);
            reader_offset += 4;
        } else if (ip_len == 16) {
            /*IPv6 address*/
            if (nlri_len < 49) {
                expert_add_info_format(pinfo, prefix_tree, &ei_bgp_evpn_nlri_rt_len_err,
                                       "Invalid length (%u) of EVPN NLRI Route Type 2 (MAC/IP Advertisement Route)", nlri_len);
                return -1;
            }
            proto_tree_add_item(prefix_tree, hf_bgp_evpn_nlri_ipv6_addr, tvb, reader_offset,
                                16, ENC_NA);
            reader_offset += 16;
        } else if (ip_len == 0) {
            /*IP not included*/
            proto_tree_add_expert(prefix_tree, pinfo, &ei_bgp_evpn_nlri_rt4_no_ip, tvb, reader_offset-1, 1);
        } else {
            return -1;
        }
        data = load_path_attr_data(pinfo);
        if (data && data->encaps_community_present &&
                (data->encaps_tunnel_type == BGP_EXT_COM_TUNNEL_VXLAN || data->encaps_tunnel_type == BGP_EXT_COM_TUNNEL_VXLANGPE)) {
            proto_tree_add_item(prefix_tree, hf_bgp_evpn_nlri_vni, tvb, reader_offset, 3, ENC_BIG_ENDIAN);
            reader_offset += 3;
            if (reader_offset - start_offset < nlri_len) {
                proto_tree_add_item(prefix_tree, hf_bgp_evpn_nlri_vni, tvb, reader_offset, 3, ENC_BIG_ENDIAN);
                reader_offset += 3;
            }
        } else {
            proto_tree_add_item(prefix_tree, hf_bgp_evpn_nlri_mpls_ls1, tvb, reader_offset, 3, ENC_BIG_ENDIAN);
            reader_offset += 3;
            /* we check if we reached the end of the nlri reading fields one by one */
            /* if not, the second optional label is in the payload */
            if (reader_offset - start_offset < nlri_len) {
                proto_tree_add_item(prefix_tree, hf_bgp_evpn_nlri_mpls_ls2, tvb, reader_offset, 3, ENC_BIG_ENDIAN);
                reader_offset += 3;
            }
        }
        total_length = reader_offset - offset;
        break;

    case EVPN_INC_MCAST_TREE:
/*
        +---------------------------------------+
        |      RD   (8 octets)                  |
        +---------------------------------------+
        |  Ethernet Tag ID (4 octets)           |
        +---------------------------------------+
        |  IP Address Length (1 octet)          |
        +---------------------------------------+
        |   Originating Router's IP Addr        |
        |          (4 or 16 octets)             |
        +---------------------------------------+
*/

        if (nlri_len < 13) {
            expert_add_info_format(pinfo, prefix_tree, &ei_bgp_evpn_nlri_rt_len_err,
                                   "Invalid length (%u) of EVPN NLRI Route Type 3 (Inclusive Multicast Ethernet Tag Route)", nlri_len);
            return -1;
        }
        item = proto_tree_add_item(prefix_tree, hf_bgp_evpn_nlri_rd, tvb, reader_offset,
                                   8, ENC_NA);
        proto_item_append_text(item, " (%s)", decode_bgp_rd(pinfo->pool, tvb, reader_offset));
        reader_offset += 8;

        proto_tree_add_item(prefix_tree, hf_bgp_evpn_nlri_etag, tvb, reader_offset,
                            4, ENC_BIG_ENDIAN);
        /* move to next field */
        reader_offset += 4;
        ip_len = tvb_get_guint8(tvb, reader_offset) / 8;
        proto_tree_add_item(prefix_tree, hf_bgp_evpn_nlri_iplen, tvb, reader_offset,
                            1, ENC_BIG_ENDIAN);
        reader_offset += 1;

        if (ip_len == 4) {
            /*IPv4 address*/
            if (nlri_len < 17) {
                expert_add_info_format(pinfo, prefix_tree, &ei_bgp_evpn_nlri_rt_len_err,
                                       "Invalid length (%u) of EVPN NLRI Route Type 3 (Inclusive Multicast Ethernet Tag Route)", nlri_len);
                return -1;
            }
            proto_tree_add_item(prefix_tree, hf_bgp_evpn_nlri_ip_addr, tvb, reader_offset,
                                4, ENC_NA);
            reader_offset += 4;
        } else if (ip_len == 16) {
            /*IPv6 address*/
            if (nlri_len < 29) {
                expert_add_info_format(pinfo, prefix_tree, &ei_bgp_evpn_nlri_rt_len_err,
                                       "Invalid length (%u) of EVPN NLRI Route Type 3 (Inclusive Multicast Ethernet Tag Route)", nlri_len);
                return -1;
            }
            proto_tree_add_item(prefix_tree, hf_bgp_evpn_nlri_ipv6_addr, tvb, reader_offset,
                                16, ENC_NA);
            reader_offset += 16;
        } else if (ip_len == 0) {
            /*IP not included*/
            proto_tree_add_expert(prefix_tree, pinfo, &ei_bgp_evpn_nlri_rt4_no_ip, tvb, reader_offset, 1);
        } else {
            return -1;
        }
        total_length = reader_offset - offset;
        break;

    case EVPN_ETH_SEGMENT_ROUTE:
/*
        +---------------------------------------+
        |      RD   (8 octets)                  |
        +---------------------------------------+
        |Ethernet Segment Identifier (10 octets)|
        +---------------------------------------+
        |  IP Address Length (1 octet)          |
        +---------------------------------------+
        |   Originating Router's IP Addr        |
        |          (4 or 16 octets)             |
        +---------------------------------------+
*/

        if (nlri_len < 19) {
            expert_add_info_format(pinfo, prefix_tree, &ei_bgp_evpn_nlri_rt_len_err,
                                   "Invalid length (%u) of EVPN NLRI Route Type 4 (Ethernet Segment Route)", nlri_len);
            return -1;
        }
        item = proto_tree_add_item(prefix_tree, hf_bgp_evpn_nlri_rd, tvb, reader_offset,
                                   8, ENC_NA);
        proto_item_append_text(item, " (%s)", decode_bgp_rd(pinfo->pool, tvb, reader_offset));
        reader_offset += 8;

        decode_evpn_nlri_esi(prefix_tree, tvb, reader_offset, pinfo);
        /* move to next field */
        reader_offset += 10;

        ip_len = tvb_get_guint8(tvb, reader_offset) / 8;
        proto_tree_add_item(prefix_tree, hf_bgp_evpn_nlri_iplen, tvb, reader_offset,
                            1, ENC_BIG_ENDIAN);
        reader_offset++;

        if (ip_len == 4) {
            /*IPv4 address*/
            if (nlri_len < 23) {
                expert_add_info_format(pinfo, prefix_tree, &ei_bgp_evpn_nlri_rt_len_err,
                                       "Invalid length (%u) of EVPN NLRI Route Type 4 (Ethernet Segment Route)", nlri_len);
                return -1;
            }
            proto_tree_add_item(prefix_tree, hf_bgp_evpn_nlri_ip_addr, tvb, reader_offset,
                                4, ENC_NA);
            reader_offset += 4;
        } else if (ip_len == 16) {
            /*IPv6 address*/
            if (nlri_len < 35) {
                expert_add_info_format(pinfo, prefix_tree, &ei_bgp_evpn_nlri_rt_len_err,
                                       "Invalid length (%u) of EVPN NLRI Route Type 4 (Ethernet Segment Route)", nlri_len);
                return -1;
            }
            proto_tree_add_item(prefix_tree, hf_bgp_evpn_nlri_ipv6_addr, tvb, reader_offset,
                                16, ENC_NA);
            reader_offset += 16;
        } else if (ip_len == 0) {
            /*IP not included*/
            proto_tree_add_expert(prefix_tree, pinfo, &ei_bgp_evpn_nlri_rt4_no_ip, tvb, reader_offset, 1);
        } else {
            return -1;
        }
        total_length = reader_offset - offset;
        break;
    case EVPN_IP_PREFIX_ROUTE:

/*
    +---------------------------------------+
    |      RD   (8 octets)                  |
    +---------------------------------------+
    |Ethernet Segment Identifier (10 octets)|
    +---------------------------------------+
    |  Ethernet Tag ID (4 octets)           |
    +---------------------------------------+
    |  IP Prefix Length (1 octet)           |
    +---------------------------------------+
    |  IP Prefix (4 or 16 octets)           |
    +---------------------------------------+
    |  GW IP Address (4 or 16 octets)       |
    +---------------------------------------+
    |  MPLS Label (3 octets)                |
    +---------------------------------------+
*/

        if (nlri_len < 26) {
            expert_add_info_format(pinfo, prefix_tree, &ei_bgp_evpn_nlri_rt_len_err,
                                   "Invalid length (%u) of EVPN NLRI Route Type 4 (Ethernet Segment Route)", nlri_len);
            return -1;
        }
        item = proto_tree_add_item(prefix_tree, hf_bgp_evpn_nlri_rd, tvb, reader_offset,
                                   8, ENC_NA);
        proto_item_append_text(item, " (%s)", decode_bgp_rd(pinfo->pool, tvb, reader_offset));
        reader_offset += 8;

        decode_evpn_nlri_esi(prefix_tree, tvb, reader_offset, pinfo);
        reader_offset += 10;

        proto_tree_add_item(prefix_tree, hf_bgp_evpn_nlri_etag, tvb, reader_offset,
                            4, ENC_BIG_ENDIAN);
        reader_offset += 4;

        proto_tree_add_item(prefix_tree, hf_bgp_evpn_nlri_prefix_len, tvb, reader_offset,
                            1, ENC_BIG_ENDIAN);
        reader_offset++;

        switch (nlri_len) {
            case 34 :
                /* IPv4 address */
                proto_tree_add_item(prefix_tree, hf_bgp_evpn_nlri_ip_addr, tvb, reader_offset,
                                    4, ENC_NA);
                reader_offset += 4;

                proto_tree_add_item(prefix_tree, hf_bgp_evpn_nlri_ipv4_gtw, tvb, reader_offset,
                                    4, ENC_NA);
                reader_offset += 4;

                data = load_path_attr_data(pinfo);
                if (data && data->encaps_community_present &&
                        (data->encaps_tunnel_type == BGP_EXT_COM_TUNNEL_VXLAN || data->encaps_tunnel_type == BGP_EXT_COM_TUNNEL_VXLANGPE)) {
                    proto_tree_add_item(prefix_tree, hf_bgp_evpn_nlri_vni, tvb, reader_offset, 3, ENC_BIG_ENDIAN);
                } else {
                    decode_MPLS_stack_tree(tvb, reader_offset, prefix_tree);
                }
                total_length = 36;
                break;
            case 58 :
                /* IPv6 address */
                proto_tree_add_item(prefix_tree, hf_bgp_evpn_nlri_ipv6_addr, tvb, reader_offset,
                                    16, ENC_NA);
                reader_offset += 16;

                proto_tree_add_item(prefix_tree, hf_bgp_evpn_nlri_ipv6_gtw, tvb, reader_offset,
                                    16, ENC_NA);
                reader_offset += 16;

                data = load_path_attr_data(pinfo);
                if (data && data->encaps_community_present &&
                        (data->encaps_tunnel_type == BGP_EXT_COM_TUNNEL_VXLAN || data->encaps_tunnel_type == BGP_EXT_COM_TUNNEL_VXLANGPE)) {
                    proto_tree_add_item(prefix_tree, hf_bgp_evpn_nlri_vni, tvb, reader_offset, 3, ENC_BIG_ENDIAN);
                } else {
                    decode_MPLS_stack_tree(tvb, reader_offset, prefix_tree);
                }
                total_length = 60;
                break;
            default :
                expert_add_info_format(pinfo, prefix_tree, &ei_bgp_evpn_nlri_rt_len_err,
                                       "Invalid length (%u) of EVPN NLRI Route Type 5 (IP Prefix Route)", nlri_len);
                return -1;
        }
        break;

    case EVPN_MC_ETHER_TAG_ROUTE:
    case EVPN_IGMP_JOIN_ROUTE:
    case EVPN_IGMP_LEAVE_ROUTE:
    case EVPN_S_PMSI_A_D_ROUTE:
/*
          +---------------------------------------+
          |  RD (8 octets)                        |
          +---------------------------------------+
          |  Ethernet Tag ID (4 octets)           |
          +---------------------------------------+
          |  Multicast Source Length (1 octet)    |
          +---------------------------------------+
          |  Multicast Source Address (variable)  |
          +---------------------------------------+
          |  Multicast Group Length (1 octet)     |
          +---------------------------------------+
          |  Multicast Group Address (Variable)   |
          +---------------------------------------+
          |  Originator Router Length (1 octet)   |
          +---------------------------------------+
          |  Originator Router Address (variable) |
          +---------------------------------------+
          |  Flags (1 octets) (optional)          |
          +---------------------------------------+

          +--------------------------------------------------+
          |  RD (8 octets)                                   |
          +--------------------------------------------------+
          | Ethernet Segment Identifier (10 octets)          |
          +--------------------------------------------------+
          |  Ethernet Tag ID  (4 octets)                     |
          +--------------------------------------------------+
          |  Multicast Source Length (1 octet)               |
          +--------------------------------------------------+
          |  Multicast Source Address (variable)             |
          +--------------------------------------------------+
          |  Multicast Group Length (1 octet)                |
          +--------------------------------------------------+
          |  Multicast Group Address (Variable)              |
          +--------------------------------------------------+
          |  Originator Router Length (1 octet)              |
          +--------------------------------------------------+
          |  Originator Router Address (variable)            |
          +--------------------------------------------------+
          |  Flags (1 octet)                                 |
          +--------------------------------------------------+
*/

        if (nlri_len < 15) {
            expert_add_info_format(pinfo, prefix_tree, &ei_bgp_evpn_nlri_rt_len_err,
                                   "Invalid length (%u) of EVPN NLRI Route Type %u", nlri_len, route_type);
            return -1;
        }
        item = proto_tree_add_item(prefix_tree, hf_bgp_evpn_nlri_rd, tvb, reader_offset,
                                   8, ENC_NA);
        proto_item_append_text(item, " (%s)", decode_bgp_rd(pinfo->pool, tvb, reader_offset));
        reader_offset += 8;

        if (route_type == EVPN_IGMP_JOIN_ROUTE || route_type == EVPN_IGMP_LEAVE_ROUTE) {
            decode_evpn_nlri_esi(prefix_tree, tvb, reader_offset, pinfo);
            reader_offset += 10;
        }

        proto_tree_add_item(prefix_tree, hf_bgp_evpn_nlri_etag, tvb, reader_offset,
                            4, ENC_BIG_ENDIAN);
        reader_offset += 4;

        ret = decode_mcast_vpn_nlri_addresses(prefix_tree, tvb, reader_offset);
        if (ret < 0)
            return -1;

        reader_offset = ret;
        proto_tree_add_item_ret_uint(prefix_tree, hf_bgp_evpn_nlri_igmp_mc_or_length, tvb,
                                     reader_offset, 1, ENC_BIG_ENDIAN, &or_length);
        reader_offset += 1;
        switch(or_length) {
            case 32:
                proto_tree_add_item(prefix_tree, hf_bgp_evpn_nlri_igmp_mc_or_addr_ipv4, tvb,
                                    reader_offset, 4, ENC_BIG_ENDIAN);
                reader_offset += 4;
                break;
            case 128:
                 proto_tree_add_item(prefix_tree, hf_bgp_evpn_nlri_igmp_mc_or_addr_ipv6, tvb,
                                     reader_offset, 16, ENC_NA);
                 reader_offset += 16;
                 break;
        }
        if (reader_offset - start_offset < nlri_len) {
            proto_tree_add_bitmask(prefix_tree, tvb, reader_offset, hf_bgp_evpn_nlri_igmp_mc_flags,
                                   ett_bgp_evpn_nlri_mc, evpn_nlri_igmp_mc_flags, ENC_BIG_ENDIAN);
            reader_offset += 1;
        }
        total_length = reader_offset - offset;
        break;

    default:
        expert_add_info_format(pinfo, tree, &ei_bgp_evpn_nlri_rt_type_err,
                               "Invalid EVPN Route Type (%u)", route_type);
        return -1;
    }

    return total_length;
}
