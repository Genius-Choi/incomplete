dissect_bgp(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)
{
    volatile int  offset = 0;   /* offset into the tvbuff           */
    static guchar marker[] = {   /* BGP message marker               */
        0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
        0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    };
    proto_item    *ti;           /* tree item                        */
    proto_tree    *bgp_tree;     /* BGP packet tree                  */
    tvbuff_t *volatile this_tvb; /* for tcp_dissect_pdus()           */

    /*
     * Scan through the TCP payload looking for a BGP marker.
     */
    while (tvb_reported_length_remaining(tvb, offset) > 0) {
        /*
         * Start with a quick search for 0xFFFF, then do the heavier
         * tvb_memeql() once we find it.
         */
        offset = tvb_find_guint16(tvb, offset, -1, 0xFFFF);
        if (offset < 0) {
            /* Didn't find even the start of a marker */
            return 0;
        }
        else if (0 == tvb_memeql(tvb, offset, marker, BGP_MARKER_SIZE)) {
            /* Found the marker - stop scanning and start processing BGP packets. */
            break;
        }
        else {
            /* Keep scanning through the tvbuff to try to find a marker. */
            offset++;
        }
    }

    col_clear(pinfo->cinfo, COL_INFO);

    /*
     * If we skipped any bytes, mark it as a BGP continuation.
     */
    if (offset > 0) {
        ti = proto_tree_add_item(tree, proto_bgp, tvb, 0, offset, ENC_NA);
        bgp_tree = proto_item_add_subtree(ti, ett_bgp);
        proto_item_append_text(bgp_tree, " - Continuation");
        proto_tree_add_item(bgp_tree, hf_bgp_continuation, tvb, 0, offset, ENC_NA);

        /* Don't include the continuation in PDU reassembly */
        this_tvb = tvb_new_subset_remaining(tvb, offset);
    }
    else {
        this_tvb = tvb;
    }

    /*
     * Now process the BGP packets in the TCP payload.
     */
    tcp_dissect_pdus(this_tvb, pinfo, tree, bgp_desegment, BGP_HEADER_SIZE,
                     get_bgp_len, dissect_bgp_pdu, NULL);
    return tvb_captured_length(tvb);
}
