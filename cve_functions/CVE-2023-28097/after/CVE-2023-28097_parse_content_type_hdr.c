int parse_content_type_hdr( struct sip_msg *msg )
{
	char *end;
	char *ret;
	unsigned int  mime;
	content_t * rez;

	/* is the header already found? */
	if ( msg->content_type==0 ) {
		/* if not, found it */
		if ( parse_headers(msg, HDR_CONTENTTYPE_F, 0)==-1)
			goto error;
		if ( msg->content_type==0 ) {
			LM_DBG("missing Content-Type header\n");
			return 0;
		}
	}

	/* maybe the header is already parsed! */
	if ( msg->content_type->parsed!=0)
		return get_content_type(msg);

	rez = (content_t*) pkg_malloc(sizeof (content_t));
	if (rez == NULL)
	{
		LM_ERR("Unable to allocate memory\n");
		goto error;
	}
	memset(rez, 0, sizeof (content_t));


	/* it seams we have to parse it! :-( */
	end = msg->content_type->body.s + msg->content_type->body.len;
	ret = decode_mime_type(msg->content_type->body.s, end , &mime, rez);
	if (ret==0)
		goto parse_error;
	if (ret!=end) {
		LM_ERR("the header CONTENT_TYPE contains "
			"more then one mime type :-(!\n");
		goto parse_error;
	}
	if ((mime&0x00ff)==SUBTYPE_ALL || (mime>>16)==TYPE_ALL) {
		LM_ERR("invalid mime with wildcard '*' in Content-Type hdr!\n");
		goto parse_error;
	}


	rez->type = mime;
	msg->content_type->parsed = rez;
	return mime;

parse_error:
	pkg_free(rez);
	set_err_info(OSER_EC_PARSER, OSER_EL_MEDIUM,
		"error parsing CT-TYPE header");
	set_err_reply(400, "bad headers");

error:
	return -1;
}
