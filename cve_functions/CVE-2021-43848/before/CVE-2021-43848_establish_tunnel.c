static void establish_tunnel(h2o_req_t *req, h2o_tunnel_t *tunnel, uint64_t idle_timeout)
{
    struct st_h2o_http3_server_stream_t *stream = H2O_STRUCT_FROM_MEMBER(struct st_h2o_http3_server_stream_t, req, req);

    if (stream->tunnel == NULL) {
        /* the tunnel has been closed in the meantime */
        return;
    }
    stream->tunnel->tunnel = tunnel;
    tunnel->data = stream;
    tunnel->on_write_complete = tunnel_on_write_complete;
    tunnel->on_read = tunnel_on_read;

    write_response(stream);
    h2o_probe_log_response(&stream->req, stream->quic->stream_id, stream->tunnel->tunnel);
    set_state(stream, H2O_HTTP3_SERVER_STREAM_STATE_SEND_BODY, 1);

    finalize_do_send(stream);
    assert(!stream->proceed_while_sending);
    stream->proceed_requested = 1; /* suppress invocation of `tunnel->proceed_read` until `tunnel_on_read` gets called */

    if (stream->req_body != NULL)
        tunnel_write(stream);
}
