ConnectionImpl::ConnectionImpl(Network::Connection& connection, Stats::Scope& stats,
                               const Http2Settings& http2_settings,
                               const uint32_t max_request_headers_kb)
    : stats_{ALL_HTTP2_CODEC_STATS(POOL_COUNTER_PREFIX(stats, "http2."))}, connection_(connection),
      max_request_headers_kb_(max_request_headers_kb),
      per_stream_buffer_limit_(http2_settings.initial_stream_window_size_),
      stream_error_on_invalid_http_messaging_(checkRuntimeOverride(
          http2_settings.stream_error_on_invalid_http_messaging_, InvalidHttpMessagingOverrideKey)),
      flood_detected_(false),
      max_outbound_frames_(
          Runtime::getInteger(MaxOutboundFramesOverrideKey, http2_settings.max_outbound_frames_)),
      frame_buffer_releasor_([this](const Buffer::OwnedBufferFragmentImpl* fragment) {
        releaseOutboundFrame(fragment);
      }),
      max_outbound_control_frames_(Runtime::getInteger(
          MaxOutboundControlFramesOverrideKey, http2_settings.max_outbound_control_frames_)),
      control_frame_buffer_releasor_([this](const Buffer::OwnedBufferFragmentImpl* fragment) {
        releaseOutboundControlFrame(fragment);
      }),
      max_consecutive_inbound_frames_with_empty_payload_(
          Runtime::getInteger(MaxConsecutiveInboundFramesWithEmptyPayloadOverrideKey,
                              http2_settings.max_consecutive_inbound_frames_with_empty_payload_)),
      max_inbound_priority_frames_per_stream_(
          Runtime::getInteger(MaxInboundPriorityFramesPerStreamOverrideKey,
                              http2_settings.max_inbound_priority_frames_per_stream_)),
      max_inbound_window_update_frames_per_data_frame_sent_(Runtime::getInteger(
          MaxInboundWindowUpdateFramesPerDataFrameSentOverrideKey,
          http2_settings.max_inbound_window_update_frames_per_data_frame_sent_)),
      dispatching_(false), raised_goaway_(false), pending_deferred_reset_(false) {}
