void ConnectionImpl::sendSettings(const Http2Settings& http2_settings, bool disable_push) {
  ASSERT(http2_settings.hpack_table_size_ <= Http2Settings::MAX_HPACK_TABLE_SIZE);
  ASSERT(Http2Settings::MIN_MAX_CONCURRENT_STREAMS <= http2_settings.max_concurrent_streams_ &&
         http2_settings.max_concurrent_streams_ <= Http2Settings::MAX_MAX_CONCURRENT_STREAMS);
  ASSERT(
      Http2Settings::MIN_INITIAL_STREAM_WINDOW_SIZE <= http2_settings.initial_stream_window_size_ &&
      http2_settings.initial_stream_window_size_ <= Http2Settings::MAX_INITIAL_STREAM_WINDOW_SIZE);
  ASSERT(Http2Settings::MIN_INITIAL_CONNECTION_WINDOW_SIZE <=
             http2_settings.initial_connection_window_size_ &&
         http2_settings.initial_connection_window_size_ <=
             Http2Settings::MAX_INITIAL_CONNECTION_WINDOW_SIZE);

  std::vector<nghttp2_settings_entry> iv;

  if (http2_settings.allow_connect_) {
    iv.push_back({NGHTTP2_SETTINGS_ENABLE_CONNECT_PROTOCOL, 1});
  }

  if (http2_settings.hpack_table_size_ != NGHTTP2_DEFAULT_HEADER_TABLE_SIZE) {
    iv.push_back({NGHTTP2_SETTINGS_HEADER_TABLE_SIZE, http2_settings.hpack_table_size_});
    ENVOY_CONN_LOG(debug, "setting HPACK table size to {}", connection_,
                   http2_settings.hpack_table_size_);
  }

  if (http2_settings.max_concurrent_streams_ != NGHTTP2_INITIAL_MAX_CONCURRENT_STREAMS) {
    iv.push_back({NGHTTP2_SETTINGS_MAX_CONCURRENT_STREAMS, http2_settings.max_concurrent_streams_});
    ENVOY_CONN_LOG(debug, "setting max concurrent streams to {}", connection_,
                   http2_settings.max_concurrent_streams_);
  }

  if (http2_settings.initial_stream_window_size_ != NGHTTP2_INITIAL_WINDOW_SIZE) {
    iv.push_back(
        {NGHTTP2_SETTINGS_INITIAL_WINDOW_SIZE, http2_settings.initial_stream_window_size_});
    ENVOY_CONN_LOG(debug, "setting stream-level initial window size to {}", connection_,
                   http2_settings.initial_stream_window_size_);
  }

  if (disable_push) {
    // Universally disable receiving push promise frames as we don't currently support them. nghttp2
    // will fail the connection if the other side still sends them.
    // TODO(mattklein123): Remove this when we correctly proxy push promise.
    iv.push_back({NGHTTP2_SETTINGS_ENABLE_PUSH, 0});
  }

  if (!iv.empty()) {
    int rc = nghttp2_submit_settings(session_, NGHTTP2_FLAG_NONE, &iv[0], iv.size());
    ASSERT(rc == 0);
  } else {
    // nghttp2_submit_settings need to be called at least once
    int rc = nghttp2_submit_settings(session_, NGHTTP2_FLAG_NONE, nullptr, 0);
    ASSERT(rc == 0);
  }

  // Increase connection window size up to our default size.
  if (http2_settings.initial_connection_window_size_ != NGHTTP2_INITIAL_CONNECTION_WINDOW_SIZE) {
    ENVOY_CONN_LOG(debug, "updating connection-level initial window size to {}", connection_,
                   http2_settings.initial_connection_window_size_);
    int rc = nghttp2_submit_window_update(session_, NGHTTP2_FLAG_NONE, 0,
                                          http2_settings.initial_connection_window_size_ -
                                              NGHTTP2_INITIAL_CONNECTION_WINDOW_SIZE);
    ASSERT(rc == 0);
  }
}
