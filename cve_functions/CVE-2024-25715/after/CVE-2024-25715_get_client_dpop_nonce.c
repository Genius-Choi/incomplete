static char * get_client_dpop_nonce(struct _oidc_config * config, const char * client_id) {
  json_t * j_query, * j_result;
  int res;
  char * nonce = NULL, new_nonce[OIDC_DPOP_NONCE_LENGTH+1];

  j_query = json_pack("{sss[s]s{ss}}",
                      "table", GLEWLWYD_PLUGIN_OIDC_TABLE_DPOP_CLIENT_NONCE,
                      "columns",
                        "gpodcn_nonce AS nonce",
                      "where",
                        "gpodcn_client_id", client_id);
  res = h_select(config->glewlwyd_config->glewlwyd_config->conn, j_query, &j_result, NULL);
  json_decref(j_query);
  if (res == H_OK) {
    if (json_array_size(j_result)) {
      nonce = o_strdup(json_string_value(json_object_get(json_array_get(j_result, 0), "nonce")));
    } else {
      if (!pthread_mutex_lock(&config->insert_lock)) {
        if (rand_string_nonce(new_nonce, OIDC_DPOP_NONCE_LENGTH) != NULL) {
          j_query = json_pack("{sss{sssssI}}",
                              "table", GLEWLWYD_PLUGIN_OIDC_TABLE_DPOP_CLIENT_NONCE,
                              "values",
                                "gpodcn_client_id", client_id,
                                "gpodcn_nonce", new_nonce,
                                "gpodcn_counter", json_integer_value(json_object_get(config->j_params, "oauth-dpop-nonce-counter")));
          res = h_insert(config->glewlwyd_config->glewlwyd_config->conn, j_query, NULL);
          json_decref(j_query);
          if (res == H_OK) {
            nonce = o_strdup(new_nonce);
          } else {
            y_log_message(Y_LOG_LEVEL_ERROR, "get_client_dpop_nonce - Error executing j_query (2)");
          }
        } else {
          y_log_message(Y_LOG_LEVEL_ERROR, "get_client_dpop_nonce - Error rand_string_nonce");
        }
        pthread_mutex_unlock(&config->insert_lock);
      } else {
        y_log_message(Y_LOG_LEVEL_ERROR, "refresh_client_dpop_nonce - Error pthread_mutex_lock");
      }
    }
    json_decref(j_result);
  } else {
    y_log_message(Y_LOG_LEVEL_ERROR, "get_client_dpop_nonce - Error executing j_query (1)");
  }
  return nonce;
}
