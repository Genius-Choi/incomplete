static char * generate_refresh_token(struct _oauth2_config * config, const char * client_id, const char * username, const char * scope_list, time_t now, const char * ip_source) {
  jwt_t * jwt;
  char * token = NULL;
  char salt[OAUTH2_SALT_LENGTH + 1] = {0};

  if ((jwt = r_jwt_copy(config->jwt_key)) != NULL) {
    // Build jwt payload
    rand_string_nonce(salt, OAUTH2_SALT_LENGTH);
    r_jwt_set_claim_str_value(jwt, "salt", salt);
    r_jwt_set_claim_str_value(jwt, "username", username);
    r_jwt_set_claim_str_value(jwt, "type", "refresh_token");
    r_jwt_set_claim_int_value(jwt, "iat", now);
    if (scope_list != NULL) {
      r_jwt_set_claim_str_value(jwt, "scope", scope_list);
    }
    if (client_id != NULL) {
      r_jwt_set_claim_str_value(jwt, "client_id", client_id);
    }
    token = r_jwt_serialize_signed(jwt, NULL, 0);
    if (token == NULL) {
      y_log_message(Y_LOG_LEVEL_ERROR, "generate_refresh_token - oauth2 - generating token");
    } else {
      y_log_message(Y_LOG_LEVEL_INFO, "Event oauth2 - Plugin '%s' - Refresh token generated for client '%s' granted by user '%s' with scope list '%s', origin: %s", config->name, client_id, username, scope_list, ip_source);
    }
  } else {
    y_log_message(Y_LOG_LEVEL_ERROR, "oauth2 generate_refresh_token - Error cloning jwt");
  }
  r_jwt_free(jwt);
  return token;
}
