static int check_request_jti_unused(struct _oidc_config * config, const char * jti, const char * iss, const char * ip_source) {
  json_t * j_query, * j_result = NULL, * j_last_index;
  int ret, res;
  char * jti_hash = NULL;

  if (pthread_mutex_lock(&config->insert_lock)) {
    y_log_message(Y_LOG_LEVEL_ERROR, "serialize_client_register - oidc - Error pthread_mutex_lock");
    ret = G_ERROR;
  } else {
    if (!o_strnullempty(jti)) {
      if ((jti_hash = config->glewlwyd_config->glewlwyd_callback_generate_hash(config->glewlwyd_config, jti)) != NULL) {
        j_query = json_pack("{sss[s]s{ssssss}}",
                            "table",
                            GLEWLWYD_PLUGIN_OIDC_TABLE_CLIENT_TOKEN_REQUEST,
                            "columns",
                              "gpoctr_id",
                            "where",
                              "gpoctr_plugin_name",
                              config->name,
                              "gpoctr_cient_id",
                              iss,
                              "gpoctr_jti_hash",
                              jti_hash);
        res = h_select(config->glewlwyd_config->glewlwyd_config->conn, j_query, &j_result, NULL);
        json_decref(j_query);
        if (res == H_OK) {
          if (json_array_size(j_result)) {
            y_log_message(Y_LOG_LEVEL_DEBUG, "check_request_jti_unused - jti already used for client '%s', origin %s", iss, ip_source);
            ret = G_ERROR_UNAUTHORIZED;
          } else {
            j_query = json_pack("{sss{ssssssss}}",
                                "table",
                                GLEWLWYD_PLUGIN_OIDC_TABLE_CLIENT_TOKEN_REQUEST,
                                "values",
                                  "gpoctr_plugin_name",
                                  config->name,
                                  "gpoctr_cient_id",
                                  iss,
                                  "gpoctr_issued_for",
                                  ip_source,
                                  "gpoctr_jti_hash",
                                  jti_hash);
            res = h_insert(config->glewlwyd_config->glewlwyd_config->conn, j_query, NULL);
            json_decref(j_query);
            if (res == H_OK) {
              j_last_index = h_last_insert_id(config->glewlwyd_config->glewlwyd_config->conn);
              if (j_last_index != NULL) {
                config->glewlwyd_config->glewlwyd_callback_update_issued_for(config->glewlwyd_config, NULL, GLEWLWYD_PLUGIN_OIDC_TABLE_CLIENT_TOKEN_REQUEST, "gpoctr_issued_for", ip_source, "gpoctr_id", json_integer_value(j_last_index));
                ret = G_OK;
              } else {
                y_log_message(Y_LOG_LEVEL_ERROR, "check_request_jti_unused - oidc - Error h_last_insert_id");
                ret = G_ERROR_DB;
              }
              json_decref(j_last_index);
            } else {
              y_log_message(Y_LOG_LEVEL_ERROR, "check_request_jti_unused - Error executing j_query (2)");
              config->glewlwyd_config->glewlwyd_plugin_callback_metrics_increment_counter(config->glewlwyd_config, GLWD_METRICS_DATABSE_ERROR, 1, NULL);
              ret = G_ERROR_DB;
            }
          }
          json_decref(j_result);
        } else {
          y_log_message(Y_LOG_LEVEL_ERROR, "check_request_jti_unused - Error executing j_query (1)");
          config->glewlwyd_config->glewlwyd_plugin_callback_metrics_increment_counter(config->glewlwyd_config, GLWD_METRICS_DATABSE_ERROR, 1, NULL);
          ret = G_ERROR_DB;
        }
        o_free(jti_hash);
      } else {
        y_log_message(Y_LOG_LEVEL_ERROR, "serialize_client_register - oidc - Error glewlwyd_callback_generate_hash");
        ret = G_ERROR;
      }
    } else {
      y_log_message(Y_LOG_LEVEL_DEBUG, "check_request_jti_unused - no jti in jwt request for client '%s', origin %s", iss, ip_source);
      ret = G_ERROR_PARAM;
    }
    pthread_mutex_unlock(&config->insert_lock);
  }
  return ret;
}
