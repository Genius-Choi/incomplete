static int callback_ciba_user_check(const struct _u_request * request, struct _u_response * response, void * user_data) {
  struct _oidc_config * config = (struct _oidc_config *)user_data;
  json_t * j_ciba_request = get_ciba_request_from_user_req_id(config, u_map_get(request->map_url, "user_req_id")), * j_session, * j_client;
  struct _u_map additional_parameters;
  char * redirect_url, sid[OIDC_SID_LENGTH+1] = {0};

  u_map_init(&additional_parameters);
  if (check_result_value(j_ciba_request, G_OK)) {
    if (get_session_token(config, request, response, sid) == G_OK) {
      if (!u_map_has_key(request->map_url, "cancel")) {
        u_map_put(&additional_parameters, "login_hint", json_string_value(json_object_get(json_object_get(j_ciba_request, "ciba"), "username")));
        u_map_put(&additional_parameters, "ciba_binding_message", json_string_value(json_object_get(json_object_get(j_ciba_request, "ciba"), "binding_message")));
        u_map_put(&additional_parameters, "ciba_login_hint", "true");
        if (u_map_has_key(request->map_url, "g_continue")) {
          if (0 == json_integer_value(json_object_get(json_object_get(j_ciba_request, "ciba"), "status"))) {
            j_client = config->glewlwyd_config->glewlwyd_plugin_callback_get_client(config->glewlwyd_config, json_string_value(json_object_get(json_object_get(j_ciba_request, "ciba"), "client_id")));
            if (check_result_value(j_client, G_OK)) {
              j_session = validate_session_client_scope(config, request, json_string_value(json_object_get(json_object_get(j_ciba_request, "ciba"), "client_id")), json_string_value(json_object_get(json_object_get(j_ciba_request, "ciba"), "scope")));
              if (check_result_value(j_session, G_OK)) {
                if (0 == o_strcmp(json_string_value(json_object_get(json_object_get(json_object_get(j_session, "session"), "user"), "username")), json_string_value(json_object_get(json_object_get(j_ciba_request, "ciba"), "username")))) {
                  if (json_object_get(json_object_get(j_session, "session"), "authorization_required") == json_false()) {
                    if (pthread_mutex_lock(&config->insert_lock)) {
                      y_log_message(Y_LOG_LEVEL_ERROR, "callback_ciba_user_check oidc - Error pthread_mutex_lock");
                      response->status = 302;
                      u_map_put(&additional_parameters, "ciba_message", "server_error");
                      redirect_url = get_login_url(config, request, "ciba_user_check", json_string_value(json_object_get(json_object_get(j_ciba_request, "ciba"), "client_id")), NULL, &additional_parameters);
                      ulfius_add_header_to_response(response, "Location", redirect_url);
                      o_free(redirect_url);
                    } else {
                      if (update_ciba_request(config,
                                              json_integer_value(json_object_get(json_object_get(j_ciba_request, "ciba"), "gpob_id")),
                                              json_string_value(json_object_get(json_object_get(j_session, "session"), "scope_filtered")),
                                              json_object_get(json_object_get(j_session, "session"), "amr"),
                                              1,
                                              sid) == G_OK) {
                        if (send_ciba_client_notification(config, json_object_get(j_client, "client"), json_object_get(json_object_get(j_session, "session"), "user"), json_object_get(j_ciba_request, "ciba"), json_string_value(json_object_get(json_object_get(j_session, "session"), "scope_filtered")), 1, sid) != G_OK) {
                          y_log_message(Y_LOG_LEVEL_ERROR, "callback_ciba_user_check - Error send_ciba_client_notification");
                        }
                        // Redirect to login page with a success message
                        response->status = 302;
                        u_map_put(&additional_parameters, "ciba_message", "complete");
                        redirect_url = get_login_url(config, request, "ciba_user_check", json_string_value(json_object_get(json_object_get(j_ciba_request, "ciba"), "client_id")), NULL, &additional_parameters);
                        ulfius_add_header_to_response(response, "Location", redirect_url);
                        o_free(redirect_url);
                      } else {
                        y_log_message(Y_LOG_LEVEL_ERROR, "callback_ciba_user_check - Error update_ciba_request status 1");
                        response->status = 302;
                        u_map_put(&additional_parameters, "ciba_message", "server_error");
                        redirect_url = get_login_url(config, request, "ciba_user_check", json_string_value(json_object_get(json_object_get(j_ciba_request, "ciba"), "client_id")), NULL, &additional_parameters);
                        ulfius_add_header_to_response(response, "Location", redirect_url);
                        o_free(redirect_url);
                      }
                      pthread_mutex_unlock(&config->insert_lock);
                    }
                  } else {
                     // Redirect to login page
                    response->status = 302;
                    redirect_url = get_login_url(config, request, "ciba_user_check", json_string_value(json_object_get(json_object_get(j_ciba_request, "ciba"), "client_id")), json_string_value(json_object_get(json_object_get(j_ciba_request, "ciba"), "scope")), &additional_parameters);
                    ulfius_add_header_to_response(response, "Location", redirect_url);
                    o_free(redirect_url);
                  }
                } else {
                   // Redirect to login page
                  response->status = 302;
                  redirect_url = get_login_url(config, request, "ciba_user_check", json_string_value(json_object_get(json_object_get(j_ciba_request, "ciba"), "client_id")), json_string_value(json_object_get(json_object_get(j_ciba_request, "ciba"), "scope")), &additional_parameters);
                  ulfius_add_header_to_response(response, "Location", redirect_url);
                  o_free(redirect_url);
                }
              } else if (check_result_value(j_session, G_ERROR_NOT_FOUND)) {
                 // Redirect to login page
                response->status = 302;
                redirect_url = get_login_url(config, request, "ciba_user_check", json_string_value(json_object_get(json_object_get(j_ciba_request, "ciba"), "client_id")), json_string_value(json_object_get(json_object_get(j_ciba_request, "ciba"), "scope")), &additional_parameters);
                ulfius_add_header_to_response(response, "Location", redirect_url);
                o_free(redirect_url);
              } else if (check_result_value(j_session, G_ERROR_UNAUTHORIZED)) {
                if (pthread_mutex_lock(&config->insert_lock)) {
                  y_log_message(Y_LOG_LEVEL_ERROR, "callback_ciba_user_check oidc - Error pthread_mutex_lock");
                  response->status = 302;
                  u_map_put(&additional_parameters, "ciba_message", "server_error");
                  redirect_url = get_login_url(config, request, "ciba_user_check", json_string_value(json_object_get(json_object_get(j_ciba_request, "ciba"), "client_id")), NULL, &additional_parameters);
                  ulfius_add_header_to_response(response, "Location", redirect_url);
                  o_free(redirect_url);
                } else {
                  if (update_ciba_request(config,
                                          json_integer_value(json_object_get(json_object_get(j_ciba_request, "ciba"), "gpob_id")),
                                          json_string_value(json_object_get(j_session, "scope_filtered")),
                                          json_object_get(j_session, "amr"),
                                          2,
                                          NULL) == G_OK) {
                    // Redirect to login page with a error message
                    response->status = 302;
                    u_map_put(&additional_parameters, "ciba_message", "invalid");
                    redirect_url = get_login_url(config, request, "ciba_user_check", json_string_value(json_object_get(json_object_get(j_ciba_request, "ciba"), "client_id")), NULL, &additional_parameters);
                    ulfius_add_header_to_response(response, "Location", redirect_url);
                    o_free(redirect_url);
                  } else {
                    y_log_message(Y_LOG_LEVEL_ERROR, "callback_ciba_user_check - Error update_ciba_request status 2");
                    response->status = 302;
                    u_map_put(&additional_parameters, "ciba_message", "server_error");
                    redirect_url = get_login_url(config, request, "ciba_user_check", json_string_value(json_object_get(json_object_get(j_ciba_request, "ciba"), "client_id")), NULL, &additional_parameters);
                    ulfius_add_header_to_response(response, "Location", redirect_url);
                    o_free(redirect_url);
                  }
                  pthread_mutex_unlock(&config->insert_lock);
                }
              } else {
                y_log_message(Y_LOG_LEVEL_ERROR, "callback_ciba_user_check - Error validate_session_client_scope");
                response->status = 302;
                u_map_put(&additional_parameters, "ciba_message", "server_error");
                redirect_url = get_login_url(config, request, "ciba_user_check", json_string_value(json_object_get(json_object_get(j_ciba_request, "ciba"), "client_id")), NULL, &additional_parameters);
                ulfius_add_header_to_response(response, "Location", redirect_url);
                o_free(redirect_url);
              }
              json_decref(j_session);
            } else {
              y_log_message(Y_LOG_LEVEL_ERROR, "callback_ciba_user_check - Error glewlwyd_plugin_callback_get_client");
              response->status = 302;
              u_map_put(&additional_parameters, "ciba_message", "server_error");
              redirect_url = get_login_url(config, request, "ciba_user_check", json_string_value(json_object_get(json_object_get(j_ciba_request, "ciba"), "client_id")), NULL, &additional_parameters);
              ulfius_add_header_to_response(response, "Location", redirect_url);
              o_free(redirect_url);
            }
            json_decref(j_client);
          } else {
            // Redirect to login page with a error message
            response->status = 302;
            u_map_put(&additional_parameters, "ciba_message", "invalid");
            redirect_url = get_login_url(config, request, "ciba_user_check", json_string_value(json_object_get(json_object_get(j_ciba_request, "ciba"), "client_id")), NULL, &additional_parameters);
            ulfius_add_header_to_response(response, "Location", redirect_url);
            o_free(redirect_url);
          }
        } else {
          // Redirect to login page
          response->status = 302;
          redirect_url = get_login_url(config, request, "ciba_user_check", json_string_value(json_object_get(json_object_get(j_ciba_request, "ciba"), "client_id")), json_string_value(json_object_get(json_object_get(j_ciba_request, "ciba"), "scope")), &additional_parameters);
          ulfius_add_header_to_response(response, "Location", redirect_url);
          o_free(redirect_url);
        }
      } else {
        if (pthread_mutex_lock(&config->insert_lock)) {
          y_log_message(Y_LOG_LEVEL_ERROR, "callback_ciba_user_check oidc - Error pthread_mutex_lock");
          response->status = 302;
          u_map_put(&additional_parameters, "ciba_message", "server_error");
          redirect_url = get_login_url(config, request, "ciba_user_check", json_string_value(json_object_get(json_object_get(j_ciba_request, "ciba"), "client_id")), NULL, &additional_parameters);
          ulfius_add_header_to_response(response, "Location", redirect_url);
          o_free(redirect_url);
        } else {
          if (update_ciba_request(config, json_integer_value(json_object_get(json_object_get(j_ciba_request, "ciba"), "gpob_id")), NULL, NULL, 3, NULL) == G_OK) {
            response->status = 302;
            u_map_put(&additional_parameters, "ciba_message", "cancelled");
            redirect_url = get_login_url(config, request, "ciba_user_check", json_string_value(json_object_get(json_object_get(j_ciba_request, "ciba"), "client_id")), NULL, &additional_parameters);
            ulfius_add_header_to_response(response, "Location", redirect_url);
            o_free(redirect_url);
          } else {
            y_log_message(Y_LOG_LEVEL_ERROR, "callback_ciba_user_check - Error update_ciba_request status 3");
            response->status = 302;
            u_map_put(&additional_parameters, "ciba_message", "server_error");
            redirect_url = get_login_url(config, request, "ciba_user_check", json_string_value(json_object_get(json_object_get(j_ciba_request, "ciba"), "client_id")), NULL, &additional_parameters);
            ulfius_add_header_to_response(response, "Location", redirect_url);
            o_free(redirect_url);
          }
          pthread_mutex_unlock(&config->insert_lock);
        }
      }
    } else {
      y_log_message(Y_LOG_LEVEL_ERROR, "callback_ciba_user_check - Error get_session_token");
      response->status = 302;
      u_map_put(&additional_parameters, "ciba_message", "server_error");
      redirect_url = get_login_url(config, request, "ciba_user_check", json_string_value(json_object_get(json_object_get(j_ciba_request, "ciba"), "client_id")), NULL, &additional_parameters);
      ulfius_add_header_to_response(response, "Location", redirect_url);
      o_free(redirect_url);
    }
  } else if (check_result_value(j_ciba_request, G_ERROR_NOT_FOUND)) {
    response->status = 302;
    u_map_put(&additional_parameters, "ciba_message", "not_found");
    redirect_url = get_login_url(config, request, "ciba_user_check", NULL, NULL, &additional_parameters);
    ulfius_add_header_to_response(response, "Location", redirect_url);
    o_free(redirect_url);
  } else {
    y_log_message(Y_LOG_LEVEL_ERROR, "callback_ciba_user_check - Error get_ciba_request_from_user_req_id");
    response->status = 302;
    u_map_put(&additional_parameters, "ciba_message", "server_error");
    redirect_url = get_login_url(config, request, "ciba_user_check", NULL, NULL, &additional_parameters);
    ulfius_add_header_to_response(response, "Location", redirect_url);
    o_free(redirect_url);
  }
  json_decref(j_ciba_request);
  u_map_clean(&additional_parameters);
  return U_CALLBACK_CONTINUE;
}
