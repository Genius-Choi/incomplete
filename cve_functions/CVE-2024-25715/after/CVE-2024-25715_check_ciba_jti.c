static int check_ciba_jti(struct _oidc_config * config,
                          const char * jti,
                          const char * client_id,
                          const char * ip_source) {
  char * jti_hash;
  json_t * j_query, * j_result;
  int res, ret;

  if (!o_strnullempty(jti)) {
    if ((jti_hash = config->glewlwyd_config->glewlwyd_callback_generate_hash(config->glewlwyd_config, jti)) != NULL) {
      j_query = json_pack("{sss[s]s{ssssss}}",
                          "table", GLEWLWYD_PLUGIN_OIDC_TABLE_CIBA,
                          "columns",
                            "gpob_id",
                          "where",
                            "gpob_plugin_name", config->name,
                            "gpob_jti_hash", jti_hash,
                            "gpob_client_id", client_id);
      res = h_select(config->glewlwyd_config->glewlwyd_config->conn, j_query, &j_result, NULL);
      json_decref(j_query);
      o_free(jti_hash);
      if (res == H_OK) {
        if (!json_array_size(j_result)) {
          ret = RHN_OK;
        } else {
          y_log_message(Y_LOG_LEVEL_WARNING, "jti already used for client %s at IP Address %s", client_id, ip_source);
          ret = G_ERROR_UNAUTHORIZED;
          config->glewlwyd_config->glewlwyd_plugin_callback_metrics_increment_counter(config->glewlwyd_config, GLWD_METRICS_OIDC_UNAUTHORIZED_CLIENT, 1, "plugin", config->name, NULL);
        }
        json_decref(j_result);
      } else {
        y_log_message(Y_LOG_LEVEL_ERROR, "check_ciba_jti - Error executing j_query");
        config->glewlwyd_config->glewlwyd_plugin_callback_metrics_increment_counter(config->glewlwyd_config, GLWD_METRICS_DATABSE_ERROR, 1, NULL);
        ret = G_ERROR_DB;
      }
    } else {
      y_log_message(Y_LOG_LEVEL_ERROR, "check_ciba_jti - Error glewlwyd_callback_generate_hash");
      ret = G_ERROR;
    }
  } else {
    ret = G_ERROR_PARAM;
  }
  return ret;
}
