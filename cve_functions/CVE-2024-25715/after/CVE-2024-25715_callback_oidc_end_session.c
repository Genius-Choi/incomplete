static int callback_oidc_end_session(const struct _u_request * request, struct _u_response * response, void * user_data) {
  struct _oidc_config * config = (struct _oidc_config *)user_data;
  struct _u_map map;
  char * logout_url, * redirect_uri = NULL, * state;
  json_t * j_metadata, * j_client;
  const char * post_logout_redirect_uri;

  u_map_init(&map);
  if (u_map_get(request->map_url, "id_token_hint") != NULL) {
    j_metadata = get_token_metadata(config, u_map_get(request->map_url, "id_token_hint"), "id_token", NULL);
    if (check_result_value(j_metadata, G_OK) && json_object_get(json_object_get(j_metadata, "token"), "active") == json_true()) {
      u_map_put(&map, "sid", json_string_value(json_object_get(json_object_get(j_metadata, "token"), "sid")));
      u_map_put(&map, "plugin", config->name);
      u_map_put(&map, "client_id", json_string_value(json_object_get(json_object_get(j_metadata, "token"), "client_id")));
      j_client = config->glewlwyd_config->glewlwyd_plugin_callback_get_client(config->glewlwyd_config, json_string_value(json_object_get(json_object_get(j_metadata, "token"), "client_id")));
      if (check_result_value(j_client, G_OK) && json_object_get(json_object_get(j_client, "client"), "enabled") == json_true()) {
        if (!o_strnullempty(post_logout_redirect_uri = u_map_get(request->map_url, "post_logout_redirect_uri"))) {
          if (json_array_has_string(json_object_get(json_object_get(j_client, "client"), "post_logout_redirect_uris"), u_map_get(request->map_url, "post_logout_redirect_uri"))) {
            if (u_map_get(request->map_url, "state") != NULL) {
              if (!o_strnullempty(u_map_get(request->map_url, "state"))) {
                state = msprintf("state=%s", u_map_get(request->map_url, "state"));
              } else {
                state = o_strdup("");
              }
              u_map_put(&map, "post_redirect_to", post_logout_redirect_uri);
              if (o_strrchr(post_logout_redirect_uri, '?') != NULL || o_strrchr(post_logout_redirect_uri, '#') != NULL) {
                redirect_uri = msprintf("%s&%s", post_logout_redirect_uri, state);
              } else {
                redirect_uri = msprintf("%s?%s", post_logout_redirect_uri, state);
              }
              o_free(state);
            } else {
              redirect_uri = o_strdup(post_logout_redirect_uri);
            }
          } else {
            y_log_message(Y_LOG_LEVEL_DEBUG, "callback_oidc_end_session - Invalid post_logout_redirect_uris");
          }
        }
      } else {
        y_log_message(Y_LOG_LEVEL_ERROR, "callback_oidc_end_session - Error getting client_id %s", json_string_value(json_object_get(json_object_get(j_metadata, "token"), "client_id")));
      }
      json_decref(j_client);
      u_map_put(&map, "prompt", "end_session");
    } else {
      y_log_message(Y_LOG_LEVEL_DEBUG, "callback_oidc_end_session - Invalid id_token");
      u_map_put(&map, "prompt", "single_logout");
    }
    json_decref(j_metadata);
    logout_url = config->glewlwyd_config->glewlwyd_callback_get_login_url(config->glewlwyd_config, NULL, NULL, redirect_uri, &map);
    response->status = 302;
    ulfius_add_header_to_response(response, "Location", logout_url);
    u_map_clean(&map);
    o_free(logout_url);
  }
  o_free(redirect_uri);
  return U_CALLBACK_CONTINUE;
}
