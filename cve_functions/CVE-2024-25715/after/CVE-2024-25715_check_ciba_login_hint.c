static json_t * check_ciba_login_hint(struct _oidc_config * config, json_t * j_client, const char * login_hint_token, const char * id_token_hint, const char * login_hint, const char * ip_source) {
  json_t * j_return = NULL, * j_login_hint = NULL, * j_result, * j_user;
  jwt_t * j_login_hint_token = NULL;
  char * username_from_sub = NULL;

  // expected values in the login_hint: sub or username, nothing else can be used as an identifier
  if (!o_strnullempty(login_hint_token)) {
    if ((j_login_hint_token = r_jwt_quick_parse(login_hint_token, R_PARSE_NONE, 0)) != NULL && decrypt_request_token(config, j_login_hint_token) == G_OK) {
      j_result = verify_request_signature(config, j_login_hint_token, json_string_value(json_object_get(j_client, "client_id")), GLEWLWYD_AUTH_CIBA, ip_source);
      if (check_result_value(j_result, G_OK)) {
        j_login_hint = r_jwt_get_full_claims_json_t(j_login_hint_token);
        if (json_string_null_or_empty(json_object_get(j_login_hint, "username")) && json_string_null_or_empty(json_object_get(j_login_hint, "sub"))) {
          json_decref(j_login_hint);
          j_login_hint = NULL;
          j_return = json_pack("{si}", "result", G_ERROR_PARAM);
        }
      } else if (check_result_value(j_result, G_ERROR_UNAUTHORIZED)) {
        j_return = json_pack("{si}", "result", G_ERROR_UNAUTHORIZED);
      } else {
        y_log_message(Y_LOG_LEVEL_ERROR, "check_ciba_login_hint - Error verify_request_signature");
        j_return = json_pack("{si}", "result", G_ERROR);
      }
      json_decref(j_result);
    } else {
      y_log_message(Y_LOG_LEVEL_ERROR, "check_ciba_login_hint - Invalid token");
      j_return = json_pack("{si}", "result", G_ERROR_PARAM);
    }
    r_jwt_free(j_login_hint_token);
  } else if (!o_strnullempty(login_hint)) {
    j_login_hint = json_loads(login_hint, JSON_DECODE_ANY, NULL);
    if (j_login_hint == NULL || (json_string_null_or_empty(json_object_get(j_login_hint, "username")) && json_string_null_or_empty(json_object_get(j_login_hint, "sub")))) {
      json_decref(j_login_hint);
      j_login_hint = NULL;
      j_return = json_pack("{si}", "result", G_ERROR_PARAM);
    }
  } else if (!o_strnullempty(id_token_hint)) {
    j_result = get_token_metadata(config, id_token_hint, "id_token", json_string_value(json_object_get(j_client, "client_id")));
    if (check_result_value(j_result, G_OK)) {
      if (json_object_get(json_object_get(j_result, "token"), "active") == json_true()) {
        j_login_hint = json_pack("{sO*sO*}", "sub", json_object_get(json_object_get(j_result, "token"), "sub"), "username", json_object_get(json_object_get(j_result, "token"), "username"));
      } else {
        j_return = json_pack("{si}", "result", G_ERROR_PARAM);
      }
    } else {
      y_log_message(Y_LOG_LEVEL_ERROR, "check_ciba_login_hint - This should not happen (1)");
      j_return = json_pack("{si}", "result", G_ERROR);
    }
    json_decref(j_result);
  } else {
    y_log_message(Y_LOG_LEVEL_ERROR, "check_ciba_login_hint - This should not happen (2)");
    j_return = json_pack("{si}", "result", G_ERROR);
  }
  if (j_return == NULL && j_login_hint != NULL) {
    if (!json_string_null_or_empty(json_object_get(j_login_hint, "sub"))) {
      if ((username_from_sub = get_username_from_sub(config, json_string_value(json_object_get(j_login_hint, "sub")), j_client)) == NULL) {
        y_log_message(Y_LOG_LEVEL_ERROR, "check_ciba_login_hint - Invalid sub '%s' for client_id '%s'", json_string_value(json_object_get(j_login_hint, "sub")), json_string_value(json_object_get(j_client, "client_id")));
        j_return = json_pack("{si}", "result", G_ERROR_PARAM);
      } else if (!json_string_null_or_empty(json_object_get(j_login_hint, "username")) && 0 != o_strcmp(username_from_sub, json_string_value(json_object_get(j_login_hint, "username")))) {
        y_log_message(Y_LOG_LEVEL_ERROR, "check_ciba_login_hint - sub '%s' does not match username '%s' for client_id '%s'", json_string_value(json_object_get(j_login_hint, "sub")), json_string_value(json_object_get(j_login_hint, "username")), json_string_value(json_object_get(j_client, "client_id")));
        j_return = json_pack("{si}", "result", G_ERROR_PARAM);
      }
    } else {
      username_from_sub = o_strdup(json_string_value(json_object_get(j_login_hint, "username")));
    }
    if (j_return == NULL) {
      j_user = config->glewlwyd_config->glewlwyd_plugin_callback_get_user(config->glewlwyd_config, username_from_sub);
      if (check_result_value(j_user, G_OK) && json_object_get(json_object_get(j_user, "user"), "enabled") == json_true()) {
        j_return = json_pack("{sisO}", "result", G_OK, "user", json_object_get(j_user, "user"));
      } else if (check_result_value(j_user, G_ERROR_NOT_FOUND) || json_object_get(json_object_get(j_user, "user"), "enabled") != json_true()) {
        y_log_message(Y_LOG_LEVEL_ERROR, "check_ciba_login_hint - invalid username '%s' for client_id '%s'", username_from_sub, json_string_value(json_object_get(j_login_hint, "username")), json_string_value(json_object_get(j_client, "client_id")));
        j_return = json_pack("{si}", "result", G_ERROR_PARAM);
      } else {
        y_log_message(Y_LOG_LEVEL_ERROR, "check_ciba_login_hint - Error glewlwyd_plugin_callback_get_user");
        j_return = json_pack("{si}", "result", G_ERROR);
      }
      json_decref(j_user);
    }
    o_free(username_from_sub);
  } else if (j_return == NULL) {
    y_log_message(Y_LOG_LEVEL_ERROR, "check_ciba_login_hint - This should not happen (3)");
    j_return = json_pack("{si}", "result", G_ERROR);
  }
  json_decref(j_login_hint);
  return j_return;
}
