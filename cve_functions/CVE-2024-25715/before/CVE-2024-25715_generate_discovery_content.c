static int generate_discovery_content(struct _oidc_config * config) {
  json_t * j_discovery = json_object(), * j_element = NULL, * j_rhon_info = r_library_info_json_t(), * j_dpop_sign_pubkey = json_array(), * j_sign_pubkey = json_array(), * j_signing_alg = json_array(), * j_enc_list = NULL;
  jwks_t * jwks_res;
  char * plugin_url = config->glewlwyd_config->glewlwyd_callback_get_plugin_external_url(config->glewlwyd_config, config->name);
  size_t index = 0;
  int ret = G_OK;
  const char * key = NULL;

  json_array_foreach(json_object_get(json_object_get(j_rhon_info, "jws"), "alg"), index, j_element) {
    if (0 != o_strncmp("HS", json_string_value(j_element), 2) && 0 != o_strcmp("none", json_string_value(j_element))) {
      json_array_append(j_dpop_sign_pubkey, j_element);
    }
    if (0 != o_strcmp("none", json_string_value(j_element))) {
      json_array_append(j_sign_pubkey, j_element);
    }
  }
  if (j_discovery != NULL && j_dpop_sign_pubkey != NULL && j_sign_pubkey != NULL && j_signing_alg != NULL && plugin_url != NULL) {
    jwks_res = r_jwks_search_json_str(config->jwks_sign, "{\"kty\":\"oct\"}");
    if (r_jwks_size(jwks_res)) {
      if (json_array_has_string(json_object_get(j_rhon_info, "jws"), "alg"), "HS256") {
        json_array_append_new(j_signing_alg, json_string("HS256"));
      }
      if (json_array_has_string(json_object_get(j_rhon_info, "jws"), "alg"), "HS384") {
        json_array_append_new(j_signing_alg, json_string("HS384"));
      }
      if (json_array_has_string(json_object_get(j_rhon_info, "jws"), "alg"), "HS512") {
        json_array_append_new(j_signing_alg, json_string("HS512"));
      }
    }
    r_jwks_free(jwks_res);

    jwks_res = r_jwks_search_json_str(config->jwks_sign, "{\"kty\":\"RSA\"}");
    if (r_jwks_size(jwks_res)) {
      if (json_array_has_string(json_object_get(j_rhon_info, "jws"), "alg"), "RS256") {
        json_array_append_new(j_signing_alg, json_string("RS256"));
      }
      if (json_array_has_string(json_object_get(j_rhon_info, "jws"), "alg"), "RS384") {
        json_array_append_new(j_signing_alg, json_string("RS384"));
      }
      if (json_array_has_string(json_object_get(j_rhon_info, "jws"), "alg"), "RS512") {
        json_array_append_new(j_signing_alg, json_string("RS512"));
      }
      if (json_array_has_string(json_object_get(j_rhon_info, "jws"), "alg"), "PS256") {
        json_array_append_new(j_signing_alg, json_string("PS256"));
      }
      if (json_array_has_string(json_object_get(j_rhon_info, "jws"), "alg"), "PS384") {
        json_array_append_new(j_signing_alg, json_string("PS384"));
      }
      if (json_array_has_string(json_object_get(j_rhon_info, "jws"), "alg"), "PS512") {
        json_array_append_new(j_signing_alg, json_string("PS512"));
      }
    }
    r_jwks_free(jwks_res);

    jwks_res = r_jwks_search_json_str(config->jwks_sign, "{\"kty\":\"EC\"}");
    if (r_jwks_size(jwks_res)) {
      if (json_array_has_string(json_object_get(j_rhon_info, "jws"), "alg"), "ES256") {
        json_array_append_new(j_signing_alg, json_string("ES256"));
      }
      if (json_array_has_string(json_object_get(j_rhon_info, "jws"), "alg"), "ES384") {
        json_array_append_new(j_signing_alg, json_string("ES384"));
      }
      if (json_array_has_string(json_object_get(j_rhon_info, "jws"), "alg"), "ES512") {
        json_array_append_new(j_signing_alg, json_string("ES512"));
      }
    }
    r_jwks_free(jwks_res);

    if (json_object_get(config->j_params, "oauth-fapi-allow-restrict-alg") == json_true()) {
      j_enc_list = json_object_get(config->j_params, "oauth-fapi-restrict-alg");
    } else {
      j_enc_list = json_object_get(json_object_get(j_rhon_info, "jwe"), "alg");
    }

    jwks_res = r_jwks_search_json_str(config->jwks_sign, "{\"kty\":\"OKP\"}");
    if (r_jwks_size(jwks_res)) {
      if (json_array_has_string(json_object_get(j_rhon_info, "jws"), "alg"), "EdDSA") {
        json_array_append_new(j_signing_alg, json_string("EdDSA"));
      }
      if (json_array_has_string(json_object_get(j_rhon_info, "jws"), "alg"), "ES256K") {
        json_array_append_new(j_signing_alg, json_string("ES256K"));
      }
    }
    r_jwks_free(jwks_res);

    json_object_set(j_discovery, "issuer", json_object_get(config->j_params, "iss"));
    json_object_set_new(j_discovery, "authorization_endpoint", json_pack("s+", plugin_url, "/auth"));
    json_object_set_new(j_discovery, "token_endpoint", json_pack("s+", plugin_url, "/token"));
    json_object_set_new(j_discovery, "userinfo_endpoint", json_pack("s+", plugin_url, "/userinfo"));
    json_object_set_new(j_discovery, "jwks_uri", json_pack("s+", plugin_url, "/jwks"));
    json_object_set_new(j_discovery, "token_endpoint_auth_methods_supported", json_pack("[ss]", "client_secret_basic", "client_secret_post"));

    json_object_set(j_discovery, "id_token_signing_alg_values_supported", j_signing_alg);
    json_object_set(j_discovery, "userinfo_signing_alg_values_supported", j_signing_alg);
    json_object_set(j_discovery, "access_token_signing_alg_values_supported", j_signing_alg);
    if (json_object_get(config->j_params, "encrypt-out-token-allow") == json_true()) {
      json_object_set(j_discovery, "id_token_encryption_alg_values_supported", j_enc_list);
      json_object_set(j_discovery, "id_token_encryption_enc_values_supported", json_object_get(json_object_get(j_rhon_info, "jwe"), "enc"));
      json_object_set(j_discovery, "userinfo_encryption_alg_values_supported", j_enc_list);
      json_object_set(j_discovery, "userinfo_encryption_enc_values_supported", json_object_get(json_object_get(j_rhon_info, "jwe"), "enc"));
      json_object_set(j_discovery, "access_token_encryption_alg_values_supported", j_enc_list);
      json_object_set(j_discovery, "access_token_encryption_enc_values_supported", json_object_get(json_object_get(j_rhon_info, "jwe"), "enc"));
    }
    if (json_object_get(config->j_params, "request-parameter-allow") == json_true()) {
      json_object_set(j_discovery, "request_object_signing_alg_values_supported", j_sign_pubkey);
      if (json_object_get(config->j_params, "request-parameter-allow-encrypted") == json_true()) {
        json_object_set(j_discovery, "request_object_encryption_alg_values_supported", j_enc_list);
        json_object_set(j_discovery, "request_object_encryption_enc_values_supported", json_object_get(json_object_get(j_rhon_info, "jwe"), "enc"));
      }
      json_array_append_new(json_object_get(j_discovery, "token_endpoint_auth_methods_supported"), json_string("client_secret_jwt"));
      json_object_set(j_discovery, "token_endpoint_auth_signing_alg_values_supported", j_sign_pubkey);
      if (!json_string_null_or_empty(json_object_get(config->j_params, "client-pubkey-parameter")) || !json_string_null_or_empty(json_object_get(config->j_params, "client-jwks-parameter")) || !json_string_null_or_empty(json_object_get(config->j_params, "client-jwks_uri-parameter"))) {
        json_array_append_new(json_object_get(j_discovery, "token_endpoint_auth_methods_supported"), json_string("private_key_jwt"));
      }
    }
    if (json_object_get(config->j_params, "oauth-dpop-allowed") == json_true()) {
      json_object_set(j_discovery, "dpop_signing_alg_values_supported", j_dpop_sign_pubkey);
    }
    if (json_object_get(config->j_params, "allowed-scope") != NULL && json_array_size(json_object_get(config->j_params, "allowed-scope"))) {
      json_object_set(j_discovery, "scopes_supported", json_object_get(config->j_params, "allowed-scope"));
    } else {
      json_object_set_new(j_discovery, "scopes_supported", json_pack("[s]", "openid"));
    }
    json_object_set_new(j_discovery, "response_types_supported", json_array());
    if (config->auth_type_enabled[GLEWLWYD_AUTHORIZATION_TYPE_AUTHORIZATION_CODE]) {
      json_array_append_new(json_object_get(j_discovery, "response_types_supported"), json_string("code"));
    }
    if (config->auth_type_enabled[GLEWLWYD_AUTHORIZATION_TYPE_ID_TOKEN]) {
      json_array_append_new(json_object_get(j_discovery, "response_types_supported"), json_string("id_token"));
    }
    if (config->auth_type_enabled[GLEWLWYD_AUTHORIZATION_TYPE_ID_TOKEN] && config->auth_type_enabled[GLEWLWYD_AUTHORIZATION_TYPE_TOKEN]) {
      json_array_append_new(json_object_get(j_discovery, "response_types_supported"), json_string("token id_token"));
    }
    if (config->auth_type_enabled[GLEWLWYD_AUTHORIZATION_TYPE_ID_TOKEN] && config->auth_type_enabled[GLEWLWYD_AUTHORIZATION_TYPE_AUTHORIZATION_CODE]) {
      json_array_append_new(json_object_get(j_discovery, "response_types_supported"), json_string("code id_token"));
    }
    if (config->auth_type_enabled[GLEWLWYD_AUTHORIZATION_TYPE_ID_TOKEN] && config->auth_type_enabled[GLEWLWYD_AUTHORIZATION_TYPE_AUTHORIZATION_CODE] && config->auth_type_enabled[GLEWLWYD_AUTHORIZATION_TYPE_TOKEN]) {
      json_array_append_new(json_object_get(j_discovery, "response_types_supported"), json_string("code token id_token"));
    }
    if (config->auth_type_enabled[GLEWLWYD_AUTHORIZATION_TYPE_NONE]) {
      json_array_append_new(json_object_get(j_discovery, "response_types_supported"), json_string("none"));
    }
    if (config->allow_non_oidc && config->auth_type_enabled[GLEWLWYD_AUTHORIZATION_TYPE_RESOURCE_OWNER_PASSWORD_CREDENTIALS]) {
      json_array_append_new(json_object_get(j_discovery, "response_types_supported"), json_string("password"));
    }
    if (config->allow_non_oidc && config->auth_type_enabled[GLEWLWYD_AUTHORIZATION_TYPE_TOKEN]) {
      json_array_append_new(json_object_get(j_discovery, "response_types_supported"), json_string("token"));
    }
    if (config->allow_non_oidc && config->auth_type_enabled[GLEWLWYD_AUTHORIZATION_TYPE_CLIENT_CREDENTIALS]) {
      json_array_append_new(json_object_get(j_discovery, "response_types_supported"), json_string("client_credentials"));
    }
    if (config->auth_type_enabled[GLEWLWYD_AUTHORIZATION_TYPE_REFRESH_TOKEN]) {
      json_array_append_new(json_object_get(j_discovery, "response_types_supported"), json_string("refresh_token"));
    }
    json_object_set_new(j_discovery, "response_modes_supported", json_pack("[sss]", "query", "fragment", "form_post"));
    json_object_set_new(j_discovery, "grant_types_supported", json_pack("[ss]", "authorization_code", "implicit"));
    json_object_set_new(j_discovery, "display_values_supported", json_pack("[ssss]", "page", "popup", "touch", "wap"));
    json_object_set_new(j_discovery, "claim_types_supported", json_pack("[s]", "normal"));
    json_object_set_new(j_discovery, "claims_parameter_supported", json_true());
    json_object_set_new(j_discovery, "claims_supported", json_array());
    json_array_foreach(json_object_get(config->j_params, "claims"), index, j_element) {
      json_array_append(json_object_get(j_discovery, "claims_supported"), json_object_get(j_element, "name"));
    }
    if (0 == o_strcmp("on-demand", json_string_value(json_object_get(config->j_params, "name-claim"))) || 0 == o_strcmp("mandatory", json_string_value(json_object_get(config->j_params, "name-claim")))) {
      json_array_append_new(json_object_get(j_discovery, "claims_supported"), json_string("name"));
    }
    if (0 == o_strcmp("on-demand", json_string_value(json_object_get(config->j_params, "email-claim"))) || 0 == o_strcmp("mandatory", json_string_value(json_object_get(config->j_params, "email-claim")))) {
      json_array_append_new(json_object_get(j_discovery, "claims_supported"), json_string("email"));
    }
    if (0 == o_strcmp("on-demand", json_string_value(json_object_get(config->j_params, "scope-claim"))) || 0 == o_strcmp("mandatory", json_string_value(json_object_get(config->j_params, "scope-claim")))) {
      json_array_append_new(json_object_get(j_discovery, "claims_supported"), json_string("scope"));
    }
    if (0 == o_strcmp("on-demand", json_string_value(json_object_get(json_object_get(config->j_params, "address-claim"), "type"))) || 0 == o_strcmp("mandatory", json_string_value(json_object_get(json_object_get(config->j_params, "address-claim"), "type")))) {
      json_array_append_new(json_object_get(j_discovery, "claims_supported"), json_string("address"));
    }
    if (!json_string_null_or_empty(json_object_get(config->j_params, "service-documentation"))) {
      json_object_set(j_discovery, "service_documentation", json_object_get(config->j_params, "service-documentation"));
    }
    json_object_set_new(j_discovery, "ui_locales_supported", json_pack("[ssss]", "en", "fr", "nl", "de"));
    json_object_set(j_discovery, "request_parameter_supported", json_object_get(config->j_params, "request-parameter-allow")==json_false()?json_false():json_true());
    json_object_set(j_discovery, "request_uri_parameter_supported", json_object_get(config->j_params, "request-parameter-allow")==json_false()?json_false():json_true());
    json_object_set_new(j_discovery, "require_request_uri_registration", json_false());
    if (!json_string_null_or_empty(json_object_get(config->j_params, "op-policy-uri"))) {
      json_object_set(j_discovery, "op_policy_uri", json_object_get(config->j_params, "op-policy-uri"));
    }
    if (!json_string_null_or_empty(json_object_get(config->j_params, "op-tos-uri"))) {
      json_object_set(j_discovery, "op_tos_uri", json_object_get(config->j_params, "op-tos-uri"));
    }
    if (config->subject_type == GLEWLWYD_OIDC_SUBJECT_TYPE_PAIRWISE) {
      json_object_set_new(j_discovery, "subject_types_supported", json_pack("[s]", "pairwise"));
    } else {
      json_object_set_new(j_discovery, "subject_types_supported", json_pack("[s]", "public"));
    }
    if (json_object_get(config->j_params, "pkce-allowed") == json_true()) {
      json_object_set_new(j_discovery, "code_challenge_methods_supported", json_pack("[s]", "S256"));
      if (json_object_get(config->j_params, "pkce-method-plain-allowed") == json_true()) {
        json_array_append_new(json_object_get(j_discovery, "code_challenge_methods_supported"), json_string("plain"));
      }
      if (json_object_get(config->j_params, "pkce-required") == json_true()) {
        json_object_set_new(j_discovery, "require_code_challenge", json_true());
      }
    }
    if (json_object_get(config->j_params, "introspection-revocation-allowed") == json_true()) {
      json_object_set_new(j_discovery, "revocation_endpoint", json_pack("s+", plugin_url, "/revoke"));
      json_object_set_new(j_discovery, "introspection_endpoint", json_pack("s+", plugin_url, "/introspect"));
      json_object_set_new(j_discovery, "revocation_endpoint_auth_methods_supported", json_array());
      json_object_set_new(j_discovery, "introspection_endpoint_auth_methods_supported", json_array());
      json_object_set(j_discovery, "introspection_signing_alg_values_supported", j_sign_pubkey);
      if (json_object_get(config->j_params, "request-parameter-allow-encrypted") == json_true() || json_object_get(config->j_params, "encrypt-out-token-allow") == json_true()) {
        json_object_set(j_discovery, "introspection_encryption_alg_values_supported", j_enc_list);
        json_object_set(j_discovery, "introspection_encryption_enc_values_supported", json_object_get(json_object_get(j_rhon_info, "jwe"), "enc"));
      }
      if (json_object_get(config->j_params, "introspection-revocation-allow-target-client") == json_true()) {
        json_array_append_new(json_object_get(j_discovery, "revocation_endpoint_auth_methods_supported"), json_string("client_secret_basic"));
        json_array_append_new(json_object_get(j_discovery, "introspection_endpoint_auth_methods_supported"), json_string("client_secret_basic"));
      }
      if (!o_strnullempty(config->introspect_revoke_scope)) {
        json_array_append_new(json_object_get(j_discovery, "revocation_endpoint_auth_methods_supported"), json_string("bearer"));
        json_array_append_new(json_object_get(j_discovery, "introspection_endpoint_auth_methods_supported"), json_string("bearer"));
      }
    }
    if (json_object_get(config->j_params, "register-client-allowed") == json_true()) {
      json_object_set_new(j_discovery, "registration_endpoint", json_pack("s+", plugin_url, "/register"));
    }
    if (json_object_get(config->j_params, "session-management-allowed") == json_true()) {
      json_object_set_new(j_discovery, "end_session_endpoint", json_pack("s+", plugin_url, "/end_session"));
      json_object_set_new(j_discovery, "check_session_iframe", json_pack("s+", plugin_url, "/check_session_iframe"));
    }
    if (json_object_get(config->j_params, "auth-type-device-enabled") == json_true()) {
      json_object_set_new(j_discovery, "device_authorization_endpoint", json_pack("s+", plugin_url, "/device_authorization"));
      json_array_append_new(json_object_get(j_discovery, "grant_types_supported"), json_string(GLEWLWYD_DEVICE_AUTH_GRANT_TYPE));
    }
    if (!json_string_null_or_empty(json_object_get(config->j_params, "client-cert-source"))) {
      if (json_object_get(config->j_params, "client-cert-use-endpoint-aliases") == json_true()) {
        json_object_set_new(j_discovery, "mtls_endpoint_aliases", json_pack("{ss+}", "token_endpoint", plugin_url, "/mtls/token"));
        if (json_object_get(config->j_params, "auth-type-device-enabled") == json_true()) {
          json_object_set_new(json_object_get(j_discovery, "mtls_endpoint_aliases"), "device_authorization_endpoint", json_pack("s+", plugin_url, "/mtls/device_authorization"));
        }
        if (json_object_get(config->j_params, "introspection-revocation-allowed") == json_true()) {
          json_object_set_new(json_object_get(j_discovery, "mtls_endpoint_aliases"), "revocation_endpoint", json_pack("s+", plugin_url, "/mtls/revoke"));
          json_object_set_new(json_object_get(j_discovery, "mtls_endpoint_aliases"), "introspection_endpoint", json_pack("s+", plugin_url, "/mtls/introspect"));
        }
        if (json_object_get(config->j_params, "oauth-par-allowed") == json_true()) {
          json_object_set_new(json_object_get(j_discovery, "mtls_endpoint_aliases"), "pushed_authorization_request_endpoint", json_pack("s+", plugin_url, "/mtls/par"));
        }
        if (json_object_get(config->j_params, "oauth-ciba-allowed") == json_true()) {
          json_object_set_new(json_object_get(j_discovery, "mtls_endpoint_aliases"), "backchannel_authentication_endpoint", json_pack("s+", plugin_url, "/mtls/ciba"));
        }
      }
      json_array_append_new(json_object_get(j_discovery, "token_endpoint_auth_methods_supported"), json_string("tls_client_auth"));
      if (json_object_get(config->j_params, "client-cert-self-signed-allowed") == json_true()) {
        json_array_append_new(json_object_get(j_discovery, "token_endpoint_auth_methods_supported"), json_string("self_signed_tls_client_auth"));
      }
    }
    if (json_object_get(config->j_params, "oauth-rar-allowed") == json_true()) {
      json_object_set_new(j_discovery, "authorization_details_types_supported", json_array());
      json_object_foreach(json_object_get(config->j_params, "rar-types"), key, j_element) {
        json_array_append_new(json_object_get(j_discovery, "authorization_details_types_supported"), json_string(key));
      }
    }
    if (json_object_get(config->j_params, "oauth-par-allowed") == json_true()) {
      json_object_set_new(j_discovery, "pushed_authorization_request_endpoint", json_pack("s+", plugin_url, "/par"));
      if (json_object_get(config->j_params, "oauth-par-required") == json_true()) {
        json_object_set(j_discovery, "require_pushed_authorization_requests", json_true());
      } else {
        json_object_set(j_discovery, "require_pushed_authorization_requests", json_false());
      }
    }
    if (json_object_get(config->j_params, "oauth-ciba-allowed") == json_true()) {
      json_object_set_new(j_discovery, "backchannel_token_delivery_modes_supported", json_array());
      if (json_object_get(config->j_params, "oauth-ciba-mode-poll-allowed") == json_true()) {
        json_array_append_new(json_object_get(j_discovery, "backchannel_token_delivery_modes_supported"), json_string("poll"));
      }
      if (json_object_get(config->j_params, "oauth-ciba-mode-ping-allowed") == json_true()) {
        json_array_append_new(json_object_get(j_discovery, "backchannel_token_delivery_modes_supported"), json_string("ping"));
      }
      if (json_object_get(config->j_params, "oauth-ciba-mode-push-allowed") == json_true()) {
        json_array_append_new(json_object_get(j_discovery, "backchannel_token_delivery_modes_supported"), json_string("push"));
      }
      json_object_set_new(j_discovery, "backchannel_authentication_endpoint", json_pack("s+", plugin_url, "/ciba"));
      json_object_set(j_discovery, "backchannel_authentication_request_signing_alg_values_supported", j_sign_pubkey);
      if (json_object_get(config->j_params, "encrypt-out-token-allow") == json_true()) {
        json_object_set(j_discovery, "backchannel_authentication_request_encryption_alg_values_supported", j_enc_list);
        json_object_set(j_discovery, "backchannel_authentication_request_encryption_enc_values_supported", json_object_get(json_object_get(j_rhon_info, "jwe"), "enc"));
      }
      if (json_object_get(config->j_params, "oauth-ciba-user-code-allowed") == json_true()) {
        json_object_set_new(j_discovery, "backchannel_user_code_parameter_supported", json_true());
      } else {
        json_object_set_new(j_discovery, "backchannel_user_code_parameter_supported", json_false());
      }
      json_array_append_new(json_object_get(j_discovery, "grant_types_supported"), json_string(GLEWLWYD_CIBA_GRANT_TYPE));
    }
    if (json_object_get(config->j_params, "oauth-fapi-allow-jarm") == json_true()) {
      json_array_append_new(json_object_get(j_discovery, "response_modes_supported"), json_string("query.jwt"));
      json_array_append_new(json_object_get(j_discovery, "response_modes_supported"), json_string("fragment.jwt"));
      json_array_append_new(json_object_get(j_discovery, "response_modes_supported"), json_string("form_post.jwt"));
      json_array_append_new(json_object_get(j_discovery, "response_modes_supported"), json_string("jwt"));
      json_object_set(j_discovery, "authorization_signing_alg_values_supported", j_sign_pubkey);
      if (json_object_get(config->j_params, "encrypt-out-token-allow") == json_true()) {
        json_object_set(j_discovery, "authorization_encryption_alg_values_supported", j_enc_list);
        json_object_set(j_discovery, "authorization_encryption_enc_values_supported", json_object_get(json_object_get(j_rhon_info, "jwe"), "enc"));
      }
    }
    config->discovery_str = json_dumps(j_discovery, JSON_COMPACT);
  } else {
    y_log_message(Y_LOG_LEVEL_ERROR, "generate_discovery_content - Error allocating resources for j_discovery");
    ret = G_ERROR;
  }
  json_decref(j_discovery);
  json_decref(j_dpop_sign_pubkey);
  json_decref(j_rhon_info);
  json_decref(j_signing_alg);
  json_decref(j_sign_pubkey);
  o_free(plugin_url);
  return ret;
}
