static json_t * get_ciba_request_from_user_req_id(struct _oidc_config * config, const char * user_req_id) {
  json_t * j_query, * j_result, * j_result_scope, * j_result_scheme, * j_return, * j_element = NULL, * j_client;
  int res;
  char * expires_at_clause, * scope_list = NULL;
  time_t now;
  size_t index = 0;

  if (!o_strnullempty(user_req_id)) {
    time(&now);
    if (config->glewlwyd_config->glewlwyd_config->conn->type==HOEL_DB_TYPE_MARIADB) {
      expires_at_clause = msprintf("> FROM_UNIXTIME(%u)", (now));
    } else if (config->glewlwyd_config->glewlwyd_config->conn->type==HOEL_DB_TYPE_PGSQL) {
      expires_at_clause = msprintf("> TO_TIMESTAMP(%u)", now);
    } else { // HOEL_DB_TYPE_SQLITE
      expires_at_clause = msprintf("> %u", (now));
    }
    j_query = json_pack("{sss[sssssssssss]s{sssssis{ssss}si}}",
                        "table", GLEWLWYD_PLUGIN_OIDC_TABLE_CIBA,
                        "columns",
                          "gpob_id",
                          "gpob_client_id AS client_id",
                          "gpob_x5t_s256 AS x5t_s256",
                          "gpob_username AS username",
                          "gpob_status AS status",
                          "gpob_binding_message AS binding_message",
                          "gpob_client_notification_token AS client_notification_token",
                          "gpob_auth_req_id AS auth_req_id",
                          "gpob_issued_for AS issued_for",
                          "gpob_user_agent AS user_agent",
                          "gpob_dpop_jkt AS dpop_jkt",
                        "where",
                          "gpob_plugin_name", config->name,
                          "gpob_user_req_id", user_req_id,
                          "gpob_status", 0,
                          "gpob_expires_at",
                            "operator", "raw",
                            "value", expires_at_clause,
                          "gpob_enabled", 1);
    o_free(expires_at_clause);
    res = h_select(config->glewlwyd_config->glewlwyd_config->conn, j_query, &j_result, NULL);
    json_decref(j_query);
    if (res == H_OK) {
      if (json_array_size(j_result)) {
        j_query = json_pack("{sss[ss]s{sO}}",
                            "table", GLEWLWYD_PLUGIN_OIDC_TABLE_CIBA_SCOPE,
                            "columns",
                              "gpops_scope AS scope",
                              "gpobs_granted",
                            "where",
                              "gpob_id", json_object_get(json_array_get(j_result, 0), "gpob_id"));
        res = h_select(config->glewlwyd_config->glewlwyd_config->conn, j_query, &j_result_scope, NULL);
        json_decref(j_query);
        if (res == H_OK) {
          json_array_foreach(j_result_scope, index, j_element) {
            if (json_integer_value(json_object_get(j_element, "gpobs_granted"))) {
              json_object_set(j_element, "granted", json_true());
            } else {
              json_object_set(j_element, "granted", json_false());
            }
            json_object_del(j_element, "gpobs_granted");
            if (scope_list == NULL) {
              scope_list = o_strdup(json_string_value(json_object_get(j_element, "scope")));
            } else {
              scope_list = mstrcatf(scope_list, " %s", json_string_value(json_object_get(j_element, "scope")));
            }
          }
          json_object_set_new(json_array_get(j_result, 0), "scope", json_string(scope_list));
          json_object_set(json_array_get(j_result, 0), "scopes", j_result_scope);
          json_decref(j_result_scope);
          o_free(scope_list);
        } else {
          y_log_message(Y_LOG_LEVEL_ERROR, "get_ciba_request_from_user_req_id - Error executing j_query (2)");
        }
        j_client = config->glewlwyd_config->glewlwyd_plugin_callback_get_client(config->glewlwyd_config, json_string_value(json_object_get(json_array_get(j_result, 0), "client_id")));
        if (check_result_value(j_client, G_OK) && json_object_get(json_object_get(j_client, "client"), "enabled") == json_true()) {
          json_object_set(json_array_get(j_result, 0), "client", json_object_get(j_client, "client"));
        } else {
          y_log_message(Y_LOG_LEVEL_ERROR, "get_ciba_request_from_user_req_id - Error glewlwyd_plugin_callback_get_client '%s'", json_string_value(json_object_get(json_array_get(j_result, 0), "client_id")));
        }
        json_decref(j_client);
        json_object_set_new(json_array_get(j_result, 0), "amr", json_array());
        j_query = json_pack("{sss[s]s{sO}}",
                            "table", GLEWLWYD_PLUGIN_OIDC_TABLE_CIBA_SCHEME,
                            "columns",
                              "gpobh_scheme_module AS scheme_module",
                            "where",
                              "gpob_id", json_object_get(json_array_get(j_result, 0), "gpob_id"));
        res = h_select(config->glewlwyd_config->glewlwyd_config->conn, j_query, &j_result_scheme, NULL);
        json_decref(j_query);
        if (res == H_OK) {
          json_array_foreach(j_result_scheme, index, j_element) {
            json_array_append(json_object_get(json_array_get(j_result, 0), "amr"), json_object_get(j_element, "scheme_module"));
          }
          json_decref(j_result_scheme);
        } else {
          y_log_message(Y_LOG_LEVEL_ERROR, "get_ciba_request_from_user_req_id - Error executing j_query (3)");
        }
        j_return = json_pack("{sisO}", "result", G_OK, "ciba", json_array_get(j_result, 0));
      } else {
        j_return = json_pack("{si}", "result", G_ERROR_NOT_FOUND);
      }
      json_decref(j_result);
    } else {
      y_log_message(Y_LOG_LEVEL_ERROR, "get_ciba_request_from_user_req_id - Error executing j_query (1)");
      j_return = json_pack("{si}", "result", G_ERROR_DB);
    }
  } else {
    j_return = json_pack("{si}", "result", G_ERROR_NOT_FOUND);
  }
  return j_return;
}
