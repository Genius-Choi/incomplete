static int update_ciba_request(struct _oidc_config * config, json_int_t gpob_id, const char * scopes_granted, json_t * j_amr, int status, const char * sid) {
  json_t * j_query, * j_element = NULL;
  int res, ret;
  char ** scope_array = NULL, * scope_escaped, * scope_clause = NULL;
  size_t i = 0;

  j_query = json_pack("{sss{siss?}s{sI}}",
                      "table", GLEWLWYD_PLUGIN_OIDC_TABLE_CIBA,
                      "set",
                        "gpob_status", status,
                        "gpob_sid", sid,
                      "where",
                        "gpob_id", gpob_id);
  res = h_update(config->glewlwyd_config->glewlwyd_config->conn, j_query, NULL);
  json_decref(j_query);
  if (res == H_OK) {
    if (scopes_granted != NULL) {
      if (split_string_remove_duplicates(scopes_granted, " ", &scope_array)) {
        j_query = json_pack("{sss{si}s{sI}}",
                            "table", GLEWLWYD_PLUGIN_OIDC_TABLE_CIBA_SCOPE,
                            "set",
                              "gpobs_granted", 0,
                            "where",
                              "gpob_id", gpob_id);
        res = h_update(config->glewlwyd_config->glewlwyd_config->conn, j_query, NULL);
        json_decref(j_query);
        if (res == H_OK) {
          for (i=0; scope_array[i]!=NULL; i++) {
            scope_escaped = h_escape_string_with_quotes(config->glewlwyd_config->glewlwyd_config->conn, scope_array[i]);
            if (scope_clause == NULL) {
              scope_clause = msprintf("IN (%s", scope_escaped);
            } else {
              scope_clause = mstrcatf(scope_clause, ",%s", scope_escaped);
            }
            o_free(scope_escaped);
          }
          j_query = json_pack("{sss{si}s{sIs{ssss+}}}",
                              "table", GLEWLWYD_PLUGIN_OIDC_TABLE_CIBA_SCOPE,
                              "set",
                                "gpobs_granted", 1,
                              "where",
                                "gpob_id", gpob_id,
                                "gpops_scope",
                                  "operator", "raw",
                                  "value", scope_clause, ")");
          o_free(scope_clause);
          res = h_update(config->glewlwyd_config->glewlwyd_config->conn, j_query, NULL);
          json_decref(j_query);
          if (res == H_OK) {
            j_query = json_pack("{sss{sI}}",
                                "table", GLEWLWYD_PLUGIN_OIDC_TABLE_CIBA_SCHEME,
                                "where",
                                  "gpob_id", gpob_id);
            res = h_delete(config->glewlwyd_config->glewlwyd_config->conn, j_query, NULL);
            json_decref(j_query);
            if (res == H_OK) {
              j_query = json_pack("{sss[]}",
                                  "table", GLEWLWYD_PLUGIN_OIDC_TABLE_CIBA_SCHEME,
                                  "values");
              json_array_foreach(j_amr, i, j_element) {
                json_array_append_new(json_object_get(j_query, "values"), json_pack("{sIsO}", "gpob_id", gpob_id, "gpobh_scheme_module", j_element));
              }
              if (json_array_size(json_object_get(j_query, "values"))) {
                res = h_insert(config->glewlwyd_config->glewlwyd_config->conn, j_query, NULL);
                if (res == H_OK) {
                  ret = G_OK;
                } else {
                  y_log_message(Y_LOG_LEVEL_ERROR, "update_ciba_request - Error executing j_query (5)");
                  ret = G_ERROR_DB;
                }
              } else {
                ret = G_OK;
              }
              json_decref(j_query);
            } else {
              y_log_message(Y_LOG_LEVEL_ERROR, "update_ciba_request - Error executing j_query (4)");
              ret = G_ERROR_DB;
            }
          } else {
            y_log_message(Y_LOG_LEVEL_ERROR, "update_ciba_request - Error executing j_query (3)");
            ret = G_ERROR_DB;
          }
        } else {
          y_log_message(Y_LOG_LEVEL_ERROR, "update_ciba_request - Error executing j_query (2)");
          ret = G_ERROR_DB;
        }
        free_string_array(scope_array);
      } else {
        y_log_message(Y_LOG_LEVEL_ERROR, "update_ciba_request - Error split_string_remove_duplicates");
        ret = G_ERROR;
      }
    } else {
      ret = G_OK;
    }
  } else {
    y_log_message(Y_LOG_LEVEL_ERROR, "update_ciba_request - Error executing j_query (1)");
    ret = G_ERROR_DB;
  }
  return ret;
}
