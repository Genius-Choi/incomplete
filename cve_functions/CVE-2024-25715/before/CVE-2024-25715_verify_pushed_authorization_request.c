static json_t * verify_pushed_authorization_request(struct _oidc_config * config, const char * request_uri, const char * client_id, const char * ip_source) {
  json_t * j_query, * j_result = NULL, * j_result_scope = NULL, * j_return, * j_element = NULL, * j_client = NULL;
  int res;
  char * request_uri_hash = NULL, * expires_at_clause = NULL, * scope_list = NULL, * tmp;
  time_t now;
  size_t index = 0;

  if (!o_strnullempty(client_id)) {
    time(&now);
    if (config->glewlwyd_config->glewlwyd_config->conn->type==HOEL_DB_TYPE_MARIADB) {
      expires_at_clause = msprintf("((gpop_status=0 AND gpop_expires_at> FROM_UNIXTIME(%u)) OR gpop_status=1)", (now));
    } else if (config->glewlwyd_config->glewlwyd_config->conn->type==HOEL_DB_TYPE_PGSQL) {
      expires_at_clause = msprintf("((gpop_status=0 AND gpop_expires_at> TO_TIMESTAMP(%u)) OR gpop_status=1)", now);
    } else { // HOEL_DB_TYPE_SQLITE
      expires_at_clause = msprintf("((gpop_status=0 AND gpop_expires_at> %u) OR gpop_status=1)", (now));
    }
    if ((request_uri_hash = config->glewlwyd_config->glewlwyd_callback_generate_hash(config->glewlwyd_config, request_uri)) != NULL) {
      j_query = json_pack("{sss[sssssssssssss]s{ss ss ss s{ss ss}}}",
                          "table",
                          GLEWLWYD_PLUGIN_OIDC_TABLE_PAR,
                          "columns",
                            "gpop_id",
                            "gpop_client_id AS client_id",
                            "gpop_response_type AS response_type",
                            "gpop_state AS state",
                            "gpop_redirect_uri AS redirect_uri",
                            "gpop_nonce AS nonce",
                            "gpop_code_challenge AS code_challenge",
                            "gpop_resource AS resource",
                            "gpop_dpop_jkt AS dpop_jkt",
                            "gpop_claims_request",
                            "gpop_authorization_details",
                            "gpop_additional_parameters",
                            "gpop_status",
                          "where",
                            "gpop_plugin_name",
                            config->name,
                            "gpop_client_id",
                            client_id,
                            "gpop_request_uri_hash",
                            request_uri_hash,
                            "1=1 AND",
                              "operator",
                              "raw",
                              "value",
                              expires_at_clause);
      o_free(request_uri_hash);
      o_free(expires_at_clause);
      res = h_select(config->glewlwyd_config->glewlwyd_config->conn, j_query, &j_result, NULL);
      json_decref(j_query);
      if (res == H_OK) {
        if (json_array_size(j_result)) {
          if (!json_integer_value(json_object_get(json_array_get(j_result, 0), "gpop_status"))) {
            j_query = json_pack("{sss{si}s{sO}}",
                                "table",
                                GLEWLWYD_PLUGIN_OIDC_TABLE_PAR,
                                "set",
                                  "gpop_status",
                                  1,
                                "where",
                                  "gpop_id",
                                  json_object_get(json_array_get(j_result, 0), "gpop_id"));
            res = h_update(config->glewlwyd_config->glewlwyd_config->conn, j_query, NULL);
            json_decref(j_query);
            if (res != H_OK) {
              y_log_message(Y_LOG_LEVEL_ERROR, "verify_pushed_authorization_request oidc - Error executing j_query (2)");
              config->glewlwyd_config->glewlwyd_plugin_callback_metrics_increment_counter(config->glewlwyd_config, GLWD_METRICS_DATABSE_ERROR, 1, NULL);
              j_return = json_pack("{si}", "result", G_ERROR_DB);
            }
          }
          if (res == H_OK) {
            j_query = json_pack("{sss[s]s{sO}}",
                                "table",
                                GLEWLWYD_PLUGIN_OIDC_TABLE_PAR_SCOPE,
                                "columns",
                                  "gpops_scope AS scope",
                                "where",
                                  "gpop_id",
                                  json_object_get(json_array_get(j_result, 0), "gpop_id"));
            res = h_select(config->glewlwyd_config->glewlwyd_config->conn, j_query, &j_result_scope, NULL);
            json_decref(j_query);
            if (res == H_OK) {
              json_array_foreach(j_result_scope, index, j_element) {
                if (scope_list == NULL) {
                  scope_list = o_strdup(json_string_value(json_object_get(j_element, "scope")));
                } else {
                  scope_list = mstrcatf(scope_list, " %s", json_string_value(json_object_get(j_element, "scope")));
                }
              }
              json_object_set_new(json_array_get(j_result, 0), "scope", json_string(scope_list));
              if (json_object_get(json_array_get(j_result, 0), "gpop_claims_request") != json_null()) {
                json_object_set_new(json_array_get(j_result, 0), "claims_request", json_loads(json_string_value(json_object_get(json_array_get(j_result, 0), "gpop_claims_request")), JSON_DECODE_ANY, NULL));
              }
              if (json_object_get(json_array_get(j_result, 0), "gpop_authorization_details") != json_null()) {
                json_object_set_new(json_array_get(j_result, 0), "authorization_details", json_loads(json_string_value(json_object_get(json_array_get(j_result, 0), "gpop_authorization_details")), JSON_DECODE_ANY, NULL));
              }
              if (json_object_get(json_array_get(j_result, 0), "gpop_additional_parameters") != json_null()) {
                json_object_set_new(json_array_get(j_result, 0), "additional_parameters", json_loads(json_string_value(json_object_get(json_array_get(j_result, 0), "gpop_additional_parameters")), JSON_DECODE_ANY, NULL));
              }
              json_object_del(json_array_get(j_result, 0), "gpop_claims_request");
              json_object_del(json_array_get(j_result, 0), "gpop_authorization_details");
              json_object_del(json_array_get(j_result, 0), "gpop_additional_parameters");
              json_object_set_new(json_array_get(j_result, 0), "type", json_integer(R_JWT_TYPE_NONE));
              json_decref(j_result_scope);
              if (0 == o_strncmp(json_string_value(json_object_get(json_array_get(j_result, 0), "code_challenge")), GLEWLWYD_CODE_CHALLENGE_S256_PREFIX, o_strlen(GLEWLWYD_CODE_CHALLENGE_S256_PREFIX))) {
                tmp = o_strdup(json_string_value(json_object_get(json_array_get(j_result, 0), "code_challenge"))+o_strlen(GLEWLWYD_CODE_CHALLENGE_S256_PREFIX));
                json_object_del(json_array_get(j_result, 0), "code_challenge");
                json_object_set_new(json_array_get(j_result, 0), "code_challenge", json_string(tmp));
                json_object_set_new(json_array_get(j_result, 0), "code_challenge_method", json_string("S256")); // TODO: remove when /auth will be refactored
                o_free(tmp);
              } else {
                json_object_set_new(json_array_get(j_result, 0), "code_challenge_method", json_string("plain"));
              }
              j_client = config->glewlwyd_config->glewlwyd_plugin_callback_get_client(config->glewlwyd_config, client_id);
              if (check_result_value(j_client, G_OK)) {
                j_return = json_pack("{sisOsO}", "result", G_OK, "request", json_array_get(j_result, 0), "client", json_object_get(j_client, "client"));
              } else {
                y_log_message(Y_LOG_LEVEL_ERROR, "verify_pushed_authorization_request oidc - Error glewlwyd_plugin_callback_get_client");
                j_return = json_pack("{si}", "result", G_ERROR);
              }
              o_free(scope_list);
              json_decref(j_client);
            } else {
              y_log_message(Y_LOG_LEVEL_ERROR, "verify_pushed_authorization_request oidc - Error executing j_query (3)");
              config->glewlwyd_config->glewlwyd_plugin_callback_metrics_increment_counter(config->glewlwyd_config, GLWD_METRICS_DATABSE_ERROR, 1, NULL);
              j_return = json_pack("{si}", "result", G_ERROR_DB);
            }
          }
        } else {
          y_log_message(Y_LOG_LEVEL_WARNING, "Security - Authorization invalid for client_id %s at IP Address %s", client_id, ip_source);
          j_return = json_pack("{si}", "result", G_ERROR_UNAUTHORIZED);
          config->glewlwyd_config->glewlwyd_plugin_callback_metrics_increment_counter(config->glewlwyd_config, GLWD_METRICS_OIDC_UNAUTHORIZED_CLIENT, 1, "plugin", config->name, NULL);
        }
        json_decref(j_result);
      } else {
        y_log_message(Y_LOG_LEVEL_ERROR, "verify_pushed_authorization_request oidc - Error executing j_query (1)");
        config->glewlwyd_config->glewlwyd_plugin_callback_metrics_increment_counter(config->glewlwyd_config, GLWD_METRICS_DATABSE_ERROR, 1, NULL);
        j_return = json_pack("{si}", "result", G_ERROR_DB);
      }
    } else {
      y_log_message(Y_LOG_LEVEL_ERROR, "verify_pushed_authorization_request oidc - Error glewlwyd_callback_generate_hash");
      j_return = json_pack("{si}", "result", G_ERROR);
    }
  } else {
    y_log_message(Y_LOG_LEVEL_WARNING, "Security - Authorization invalid for client_id %s at IP Address %s", "(none)", ip_source);
    j_return = json_pack("{si}", "result", G_ERROR_UNAUTHORIZED);
    config->glewlwyd_config->glewlwyd_plugin_callback_metrics_increment_counter(config->glewlwyd_config, GLWD_METRICS_OIDC_UNAUTHORIZED_CLIENT, 1, "plugin", config->name, NULL);
  }
  return j_return;
}
