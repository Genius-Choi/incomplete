static int serialize_client_register(struct _oidc_config * config, const struct _u_request * request, json_t * j_client, const char * client_management_at) {
  json_t * j_query, * j_result, * j_last_index;
  int res, ret = G_OK;
  char * issued_for = get_client_hostname(request, config->glewlwyd_config->glewlwyd_config->originating_ip_header), * access_token_hash = NULL, * management_at_hash = NULL;
  json_int_t gpoa_id = 0;

  if (pthread_mutex_lock(&config->insert_lock)) {
    y_log_message(Y_LOG_LEVEL_ERROR, "serialize_client_register - oidc - Error pthread_mutex_lock");
    ret = G_ERROR;
  } else {
    if (json_array_size(json_object_get(config->j_params, "register-client-auth-scope"))) {
      if (1 == u_map_count_keys_case(request->map_header, GLEWLWYD_HEADER_AUTHORIZATION) && (access_token_hash = config->glewlwyd_config->glewlwyd_callback_generate_hash(config->glewlwyd_config, (u_map_get_case(request->map_header, GLEWLWYD_HEADER_AUTHORIZATION) + o_strlen(GLEWLWYD_HEADER_PREFIX_BEARER)))) != NULL) {
        j_query = json_pack("{sss[s]s{ssss}}",
                            "table",
                            GLEWLWYD_PLUGIN_OIDC_TABLE_ACCESS_TOKEN,
                            "columns",
                              "gpoa_id",
                            "where",
                              "gpoa_plugin_name",
                              config->name,
                              "gpoa_token_hash",
                              access_token_hash);
        res = h_select(config->glewlwyd_config->glewlwyd_config->conn, j_query, &j_result, NULL);
        json_decref(j_query);
        if (res == H_OK) {
          if (json_array_size(j_result)) {
            gpoa_id = json_integer_value(json_object_get(json_array_get(j_result, 0), "gpoa_id"));
          } else {
            ret = G_ERROR_PARAM;
          }
          json_decref(j_result);
        } else {
          y_log_message(Y_LOG_LEVEL_ERROR, "serialize_client_register - Error executing j_query (1)");
          config->glewlwyd_config->glewlwyd_plugin_callback_metrics_increment_counter(config->glewlwyd_config, GLWD_METRICS_DATABSE_ERROR, 1, NULL);
          ret = G_ERROR_DB;
        }
      } else {
        y_log_message(Y_LOG_LEVEL_ERROR, "serialize_client_register - Error glewlwyd_callback_generate_hash");
        ret = G_ERROR;
      }
    }
    if (ret == G_OK) {
      if (!o_strnullempty(client_management_at)) {
        management_at_hash = config->glewlwyd_config->glewlwyd_callback_generate_hash(config->glewlwyd_config, client_management_at);
      } else {
        management_at_hash = o_strdup("disabled");
      }
      j_query = json_pack("{sss{sssOssss*ss?}}",
                          "table",
                          GLEWLWYD_PLUGIN_OIDC_TABLE_CLIENT_REGISTRATION,
                          "values",
                            "gpocr_plugin_name",
                            config->name,
                            "gpocr_cient_id",
                            json_object_get(j_client, "client_id"),
                            "gpocr_issued_for",
                            issued_for,
                            "gpocr_user_agent",
                            u_map_get_case(request->map_header, "user-agent"),
                            "gpocr_management_at_hash",
                            management_at_hash);
      if (gpoa_id) {
        json_object_set_new(json_object_get(j_query, "values"), "gpoa_id", json_integer(gpoa_id));
      }
      res = h_insert(config->glewlwyd_config->glewlwyd_config->conn, j_query, NULL);
      json_decref(j_query);
      if (res == H_OK) {
        j_last_index = h_last_insert_id(config->glewlwyd_config->glewlwyd_config->conn);
        if (j_last_index != NULL) {
          config->glewlwyd_config->glewlwyd_callback_update_issued_for(config->glewlwyd_config, NULL, GLEWLWYD_PLUGIN_OIDC_TABLE_CLIENT_REGISTRATION, "gpocr_issued_for", issued_for, "gpocr_id", json_integer_value(j_last_index));
        } else {
          y_log_message(Y_LOG_LEVEL_ERROR, "serialize_client_register - oidc - Error h_last_insert_id");
          ret = G_ERROR_DB;
        }
        json_decref(j_last_index);
      } else {
        y_log_message(Y_LOG_LEVEL_ERROR, "serialize_client_register - Error executing j_query (2)");
        config->glewlwyd_config->glewlwyd_plugin_callback_metrics_increment_counter(config->glewlwyd_config, GLWD_METRICS_DATABSE_ERROR, 1, NULL);
        ret = G_ERROR_DB;
      }
    }
    o_free(access_token_hash);
    o_free(management_at_hash);
    pthread_mutex_unlock(&config->insert_lock);
  }
  o_free(issued_for);
  return ret;
}
