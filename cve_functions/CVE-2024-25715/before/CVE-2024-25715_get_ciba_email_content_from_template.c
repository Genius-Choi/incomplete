static json_t * get_ciba_email_content_from_template(struct _oidc_config * config, json_t * j_user, json_t * j_client, const char * user_req_id, const char * binding_message) {
  char * body = NULL,
       * tmp,
       * str_client,
       * external_url = config->glewlwyd_config->glewlwyd_callback_get_plugin_external_url(config->glewlwyd_config, config->name),
       * ciba_user_url_connect = msprintf("%s/ciba_user_check?user_req_id=%s", external_url, user_req_id),
       * ciba_user_url_cancel = msprintf("%s/ciba_user_check?user_req_id=%s&cancel", external_url, user_req_id);
  const char * lang = json_string_value(json_object_get(j_user, json_string_value(json_object_get(config->j_params, "oauth-ciba-email-user-lang-property"))));
  json_t * j_template = NULL, * j_element = NULL, * j_return;
  o_free(external_url);

  if (!!o_strnullempty(lang)) {
    json_object_foreach(json_object_get(config->j_params, "oauth-ciba-email-templates"), lang, j_element) {
      if (json_object_get(j_element, "oauth-ciba-email-defaultLang") == json_true()) {
        j_template = j_element;
        break;
      }
    }
  } else {
    if ((j_template = json_object_get(json_object_get(config->j_params, "oauth-ciba-email-templates"), lang)) == NULL) {
      json_object_foreach(json_object_get(config->j_params, "oauth-ciba-email-templates"), lang, j_element) {
        if (json_object_get(j_element, "oauth-ciba-email-defaultLang") == json_true()) {
          j_template = j_element;
          break;
        }
      }
    }
  }
  if (j_template != NULL) {
    body = str_replace(json_string_value(json_object_get(j_template, "oauth-ciba-email-body-pattern")), "{CONNECT_URL}", ciba_user_url_connect);
    if (o_strstr(body, "{CANCEL_URL}") != NULL) {
      tmp = str_replace(body, "{CANCEL_URL}", ciba_user_url_cancel);
      o_free(body);
      body = tmp;
      tmp = NULL;
    }
    if (o_strstr(body, "{BINDING_MESSAGE}") != NULL) {
      tmp = str_replace(body, "{BINDING_MESSAGE}", !o_strnullempty(binding_message)?binding_message:"");
      o_free(body);
      body = tmp;
      tmp = NULL;
    }
    if (o_strstr(body, "{CLIENT}") != NULL) {
      if (!json_string_null_or_empty(json_object_get(j_client, "name"))) {
        str_client = msprintf("%s (%s)", json_string_value(json_object_get(j_client, "name")), json_string_value(json_object_get(j_client, "client_id")));
      } else {
        str_client = msprintf("%s", json_string_value(json_object_get(j_client, "client_id")));
      }
      tmp = str_replace(body, "{CLIENT}", str_client);
      o_free(body);
      body = tmp;
      tmp = NULL;
      o_free(str_client);
    }
    j_return = json_pack("{sissss}", "result", G_OK, "subject", json_string_value(json_object_get(j_template, "oauth-ciba-email-subject")), "body", body);
    o_free(body);
  } else {
    y_log_message(Y_LOG_LEVEL_ERROR, "get_ciba_email_content_from_template - Invalid lang");
    j_return = json_pack("{si}", "result", G_ERROR_PARAM);
  }
  o_free(ciba_user_url_connect);
  o_free(ciba_user_url_cancel);
  return j_return;
}
