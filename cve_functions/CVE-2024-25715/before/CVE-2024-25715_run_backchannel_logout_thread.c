static void * run_backchannel_logout_thread(void * args) {
  struct _backchannel_elements * elt = (struct _backchannel_elements *)args;
  json_t * j_element = NULL, * j_client, * j_events = json_pack("{s{}}", "http://schemas.openid.net/event/backchannel-logout");;
  size_t index = 0;
  int res;
  jwt_t * jwt;
  char * sub, jti[OIDC_JTI_LENGTH+1] = {0}, * token = NULL, * out_token = NULL;
  jwa_alg alg;
  jwk_t * jwk = NULL;
  struct _u_request req;
  struct _u_response resp;

  json_array_foreach(elt->j_client_id_list, index, j_element) {
    j_client = elt->config->glewlwyd_config->glewlwyd_plugin_callback_get_client(elt->config->glewlwyd_config, json_string_value(json_object_get(j_element, "client_id")));
    if (check_result_value(j_client, G_OK) && json_object_get(json_object_get(j_client, "client"), "enabled") == json_true() &&
        !json_string_null_or_empty(json_object_get(json_object_get(j_client, "client"), "backchannel_logout_uri"))) {
      alg = get_token_sign_alg(elt->config, json_object_get(j_client, "client"), GLEWLWYD_TOKEN_TYPE_ID_TOKEN);
      jwk = get_jwk_sign(elt->config, json_object_get(j_client, "client"), alg);
      if (alg != R_JWA_ALG_UNKNOWN && alg != R_JWA_ALG_NONE && jwk != NULL) {
        r_jwt_init(&jwt);
        r_jwt_set_claim_str_value(jwt, "iss", json_string_value(json_object_get(elt->config->j_params, "iss")));
        r_jwt_set_claim_str_value(jwt, "aud", json_string_value(json_object_get(json_object_get(j_client, "client"), "client_id")));
        sub = get_sub(elt->config, elt->username, json_object_get(j_client, "client"));
        r_jwt_set_claim_str_value(jwt, "sub", sub);
        o_free(sub);
        r_jwt_set_claim_int_value(jwt, "iat", (rhn_int_t)time(NULL));
        if (rand_string_nonce(jti, OIDC_JTI_LENGTH) != NULL) {
          r_jwt_set_claim_str_value(jwt, "jti", jti);
          if (is_true(json_string_value(json_object_get(json_object_get(j_client, "client"), "backchannel_logout_session_required")))) {
            r_jwt_set_claim_str_value(jwt, "sid", elt->sid);
          }
          r_jwt_set_claim_json_t_value(jwt, "events", j_events);
          r_jwt_set_sign_alg(jwt, alg);
          token = r_jwt_serialize_signed(jwt, jwk, 0);
          out_token = encrypt_token_if_required(elt->config, token, json_object_get(j_client, "client"), GLEWLWYD_TOKEN_TYPE_ID_TOKEN, &res);
        }
        r_jwt_free(jwt);
        if (out_token != NULL) {
          ulfius_init_request(&req);
          ulfius_init_response(&resp);
          ulfius_set_request_properties(&req, U_OPT_HTTP_URL, json_string_value(json_object_get(json_object_get(j_client, "client"), "backchannel_logout_uri")),
                                              U_OPT_HTTP_VERB, "POST",
                                              U_OPT_POST_BODY_PARAMETER, "logout_token", out_token,
                                              U_OPT_CHECK_SERVER_CERTIFICATE, json_object_get(elt->config->j_params, "request-uri-allow-https-non-secure")==json_true()?0:1,
                                              U_OPT_CHECK_PROXY_CERTIFICATE, json_object_get(elt->config->j_params, "request-uri-allow-https-non-secure")==json_true()?0:1,
                                              U_OPT_NONE);
          if (ulfius_send_http_request_with_limit(&req, &resp, elt->config->glewlwyd_config->glewlwyd_config->response_body_limit, elt->config->glewlwyd_config->glewlwyd_config->max_header) == U_OK) {
            if (resp.status == 200) {
              y_log_message(Y_LOG_LEVEL_DEBUG, "Send backchannel_logout successfully for client %s", json_string_value(json_object_get(json_object_get(j_client, "client"), "client_id")));
            } else {
              y_log_message(Y_LOG_LEVEL_ERROR, "run_backchannel_logout_thread - Error backchannel_logout response for client %s, response status %d", json_string_value(json_object_get(json_object_get(j_client, "client"), "client_id")), resp.status);
              y_log_message(Y_LOG_LEVEL_DEBUG, "  -  response body %.*s", resp.binary_body_length, resp.binary_body);
            }
          } else {
            y_log_message(Y_LOG_LEVEL_ERROR, "run_backchannel_logout_thread - Error ulfius_send_http_request_with_limit for client %s", json_string_value(json_object_get(json_object_get(j_client, "client"), "client_id")));
          }
          ulfius_clean_request(&req);
          ulfius_clean_response(&resp);
        } else {
          y_log_message(Y_LOG_LEVEL_ERROR, "run_backchannel_logout_thread - Error serializing JWT for client %s", json_string_value(json_object_get(json_object_get(j_client, "client"), "client_id")));
        }
        o_free(token);
        o_free(out_token);
      } else {
        y_log_message(Y_LOG_LEVEL_ERROR, "run_backchannel_logout_thread - Invalid alg or sign key for client %s", json_string_value(json_object_get(json_object_get(j_client, "client"), "client_id")));
      }
      r_jwk_free(jwk);
    }
    json_decref(j_client);
  }
  json_decref(j_events);
  json_decref(elt->j_client_id_list);
  o_free(elt->username);
  o_free(elt->sid);
  o_free(elt);
  pthread_exit(NULL);
}
