static int callback_check_userinfo(const struct _u_request * request, struct _u_response * response, void * user_data) {
  struct _oidc_config * config = (struct _oidc_config *)user_data;
  json_t * j_introspect, * j_dpop, * json_body;
  int ret = U_CALLBACK_UNAUTHORIZED, is_header_dpop = 0, res;
  const char * access_token = get_auth_header_token(u_map_get_case(request->map_header, GLEWLWYD_HEADER_AUTHORIZATION), &is_header_dpop),
             * dpop = u_map_get_case(request->map_header, GLEWLWYD_HEADER_DPOP),
             * ip_source = get_ip_source(request, config->glewlwyd_config->glewlwyd_config->originating_ip_header);
  char * dpop_nonce;

  if (access_token != NULL && 1 == u_map_count_keys_case(request->map_header, GLEWLWYD_HEADER_AUTHORIZATION)) {
    j_introspect = get_token_metadata(config, access_token, "access_token", NULL);
    if (check_result_value(j_introspect, G_OK) && json_object_get(json_object_get(j_introspect, "token"), "active") == json_true()) {
      if (is_header_dpop && 1 == u_map_count_keys_case(request->map_header, GLEWLWYD_HEADER_DPOP) && json_object_get(json_object_get(json_object_get(j_introspect, "token"), "cnf"), "jkt") != NULL && dpop != NULL) {
        j_dpop = oidc_verify_dpop_proof(config, request, request->http_verb, "/userinfo", json_object_get(j_introspect, "client"), access_token, NULL);
        if (check_result_value(j_dpop, G_OK)) {
          if (json_object_get(j_dpop, "jkt") == NULL ||
              (res = check_dpop_jti(config,
                                    json_string_value(json_object_get(json_object_get(j_dpop, "claims"), "jti")),
                                    json_string_value(json_object_get(json_object_get(j_dpop, "claims"), "htm")),
                                    json_string_value(json_object_get(json_object_get(j_dpop, "claims"), "htu")),
                                    json_integer_value(json_object_get(json_object_get(j_dpop, "claims"), "iat")),
                                    json_string_value(json_object_get(json_object_get(j_introspect, "token"), "client_id")),
                                    json_string_value(json_object_get(json_object_get(json_object_get(j_introspect, "token"), "cnf"), "jkt")),
                                    ip_source)) == G_OK) {
            if (json_object_get(j_dpop, "jkt") != NULL && json_object_get(config->j_params, "oauth-dpop-nonce-mandatory") == json_true()) {
              if ((dpop_nonce = refresh_client_dpop_nonce(config, json_string_value(json_object_get(json_object_get(j_introspect, "token"), "client_id")))) != NULL) {
                ulfius_set_response_properties(response, U_OPT_HEADER_PARAMETER, "DPoP-Nonce", dpop_nonce, U_OPT_NONE);
                o_free(dpop_nonce);
              }
            }
            if (ulfius_set_response_shared_data(response, json_incref(json_object_get(j_introspect, "token")), (void (*)(void *))&json_decref) == U_OK) {
              json_object_set((json_t *)response->shared_data, "username", json_object_get(j_introspect, "username"));
              json_object_set((json_t *)response->shared_data, "client", json_object_get(j_introspect, "client"));
              ret = U_CALLBACK_CONTINUE;
            } else {
              y_log_message(Y_LOG_LEVEL_ERROR, "callback_check_userinfo - Error ulfius_set_response_shared_data");
              ret = U_CALLBACK_ERROR;
            }
          } else if (res == G_ERROR_UNAUTHORIZED) {
            config->glewlwyd_config->glewlwyd_plugin_callback_metrics_increment_counter(config->glewlwyd_config, GLWD_METRICS_OIDC_INVALID_ACCESS_TOKEN, 1, "plugin", config->name, "endpoint", "userinfo", NULL);
          } else {
            y_log_message(Y_LOG_LEVEL_ERROR, "callback_check_userinfo - Error check_dpop_jti");
            ret = U_CALLBACK_ERROR;
          }
        } else if (check_result_value(j_dpop, G_ERROR_PARAM) || check_result_value(j_dpop, G_ERROR_UNAUTHORIZED)) {
          if (json_object_get(j_dpop, "nonce") != NULL) {
            ulfius_set_response_properties(response, U_OPT_STATUS, 401,
                                                     U_OPT_HEADER_PARAMETER, "DPoP-Nonce", json_string_value(json_object_get(j_dpop, "nonce")),
                                                     U_OPT_HEADER_PARAMETER, "WWW-Authenticate", "DPoP error=\"use_dpop_nonce\", error_description=\"Resource server requires nonce in DPoP proof\"",
                                                     U_OPT_NONE);
          } else {
            y_log_message(Y_LOG_LEVEL_WARNING, "Security - DPoP invalid at IP Address %s", get_ip_source(request, config->glewlwyd_config->glewlwyd_config->originating_ip_header));
            json_body = json_pack("{ssss}", "error", "invalid_dpop_proof", "error_description", "Invalid DPoP");
            ulfius_set_json_body_response(response, 401, json_body);
            json_decref(json_body);
            config->glewlwyd_config->glewlwyd_plugin_callback_metrics_increment_counter(config->glewlwyd_config, GLWD_METRICS_OIDC_UNAUTHORIZED_CLIENT, 1, "plugin", config->name, NULL);
          }
        } else if (check_result_value(j_dpop, G_ERROR)) {
          y_log_message(Y_LOG_LEVEL_ERROR, "callback_check_userinfo - Error oidc_verify_dpop_proof");
          ret = U_CALLBACK_ERROR;
        }
        json_decref(j_dpop);
      } else if (!is_header_dpop && json_object_get(json_object_get(json_object_get(j_introspect, "token"), "cnf"), "jkt") == NULL && dpop == NULL) {
        if (ulfius_set_response_shared_data(response, json_incref(json_object_get(j_introspect, "token")), (void (*)(void *))&json_decref) == U_OK) {
          json_object_set((json_t *)response->shared_data, "username", json_object_get(j_introspect, "username"));
          json_object_set((json_t *)response->shared_data, "client", json_object_get(j_introspect, "client"));
          ret = U_CALLBACK_CONTINUE;
        } else {
          y_log_message(Y_LOG_LEVEL_ERROR, "callback_check_userinfo - Error ulfius_set_response_shared_data");
          ret = U_CALLBACK_ERROR;
        }
      } else {
        config->glewlwyd_config->glewlwyd_plugin_callback_metrics_increment_counter(config->glewlwyd_config, GLWD_METRICS_OIDC_INVALID_ACCESS_TOKEN, 1, "plugin", config->name, "endpoint", "userinfo", NULL);
      }
    } else {
      config->glewlwyd_config->glewlwyd_plugin_callback_metrics_increment_counter(config->glewlwyd_config, GLWD_METRICS_OIDC_INVALID_ACCESS_TOKEN, 1, "plugin", config->name, "endpoint", "userinfo", NULL);
    }
    json_decref(j_introspect);
  }
  return ret;
}
