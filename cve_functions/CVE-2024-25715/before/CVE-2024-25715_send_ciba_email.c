static int send_ciba_email(struct _oidc_config * config, json_t * j_user, json_t * j_client, const char * user_req_id, const char * binding_message) {
  int ret;
  json_t * j_email_template;

  if (!json_string_null_or_empty(json_object_get(j_user, "email"))) {
    j_email_template = get_ciba_email_content_from_template(config, j_user, j_client, user_req_id, binding_message);
    if (check_result_value(j_email_template, G_OK)) {
      if (ulfius_send_smtp_rich_email(json_string_value(json_object_get(config->j_params, "oauth-ciba-email-host")),
                                     (int)json_integer_value(json_object_get(config->j_params, "oauth-ciba-email-port")),
                                     json_object_get(config->j_params, "oauth-ciba-email-use-tls")==json_true()?1:0,
                                     json_object_get(config->j_params, "oauth-ciba-email-verify-certificate")==json_false()?0:1,
                                     !json_string_null_or_empty(json_object_get(config->j_params, "oauth-ciba-email-user"))?json_string_value(json_object_get(config->j_params, "oauth-ciba-email-user")):NULL,
                                     !json_string_null_or_empty(json_object_get(config->j_params, "oauth-ciba-email-password"))?json_string_value(json_object_get(config->j_params, "oauth-ciba-email-password")):NULL,
                                     json_string_value(json_object_get(config->j_params, "oauth-ciba-email-from")),
                                     json_string_value(json_object_get(j_user, "email")),
                                     NULL,
                                     NULL,
                                     !json_string_null_or_empty(json_object_get(config->j_params, "oauth-ciba-email-content-type"))?json_string_value(json_object_get(config->j_params, "oauth-ciba-email-content-type")):"text/plain; charset=utf-8",
                                     json_string_value(json_object_get(j_email_template, "subject")),
                                     json_string_value(json_object_get(j_email_template, "body"))) == U_OK) {
        ret = G_OK;
      } else {
        y_log_message(Y_LOG_LEVEL_ERROR, "send_ciba_email - Error ulfius_send_smtp_rich_email");
        ret = G_ERROR;
      }
    } else {
      y_log_message(Y_LOG_LEVEL_ERROR, "send_ciba_email - Error get_ciba_email_content_from_template");
      ret = G_ERROR;
    }
    json_decref(j_email_template);
  } else {
    ret = G_ERROR_PARAM;
  }
  return ret;
}
