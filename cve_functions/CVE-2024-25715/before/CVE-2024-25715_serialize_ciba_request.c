static int serialize_ciba_request(struct _oidc_config * config,
                                  const char * client_id,
                                  json_t * j_user,
                                  const char * client_notification_token,
                                  const char * auth_req_id,
                                  const char * user_req_id,
                                  const char * binding_message,
                                  long int requested_expiry,
                                  const char * ip_source,
                                  const char * user_agent,
                                  const char * scope,
                                  const char * x5t_s256,
                                  const char * jti_hash,
                                  const char * dpop_jkt) {
  int ret, res;
  json_t * j_query, * j_last_id;
  char ** scope_array = NULL, * expires_at_clause;
  size_t i;
  time_t now;

  if (pthread_mutex_lock(&config->insert_lock)) {
    y_log_message(Y_LOG_LEVEL_ERROR, "serialize_ciba_request oidc - Error pthread_mutex_lock");
    ret = G_ERROR;
  } else {
    // disable all other enabled ciba requests from the same client_id to the same username
    j_query = json_pack("{sss{si}s{ss ss sO si}}",
                        "table", GLEWLWYD_PLUGIN_OIDC_TABLE_CIBA,
                        "set",
                         "gpob_enabled", 0,
                        "where",
                          "gpob_plugin_name", config->name,
                          "gpob_client_id", client_id,
                          "gpob_username", json_object_get(j_user, "username"),
                          "gpob_enabled", 1);
    res = h_update(config->glewlwyd_config->glewlwyd_config->conn, j_query, NULL);
    json_decref(j_query);
    if (res == H_OK) {
      time(&now);
      if (config->glewlwyd_config->glewlwyd_config->conn->type==HOEL_DB_TYPE_MARIADB) {
        expires_at_clause = msprintf("FROM_UNIXTIME(%u)", (now + (time_t)requested_expiry));
      } else if (config->glewlwyd_config->glewlwyd_config->conn->type==HOEL_DB_TYPE_PGSQL) {
        expires_at_clause = msprintf("TO_TIMESTAMP(%u)", (now + (time_t)requested_expiry ));
      } else { // HOEL_DB_TYPE_SQLITE
        expires_at_clause = msprintf("%u", (now + (time_t)requested_expiry));
      }
      j_query = json_pack("{sss{ss ss ss* sO ss* ss* ss ss ss* s{ss} ss ss* ss*}}",
                          "table", GLEWLWYD_PLUGIN_OIDC_TABLE_CIBA,
                          "values",
                            "gpob_plugin_name", config->name,
                            "gpob_client_id", client_id,
                            "gpob_x5t_s256", x5t_s256,
                            "gpob_username", json_object_get(j_user, "username"),
                            "gpob_client_notification_token", client_notification_token,
                            "gpob_jti_hash", jti_hash,
                            "gpob_auth_req_id", auth_req_id,
                            "gpob_user_req_id", user_req_id,
                            "gpob_binding_message", binding_message,
                            "gpob_expires_at",
                              "raw", expires_at_clause,
                            "gpob_issued_for", ip_source,
                            "gpob_user_agent", user_agent,
                            "gpob_dpop_jkt", dpop_jkt);
      res = h_insert(config->glewlwyd_config->glewlwyd_config->conn, j_query, NULL);
      json_decref(j_query);
      o_free(expires_at_clause);
      if (res == H_OK) {
        if ((j_last_id = h_last_insert_id(config->glewlwyd_config->glewlwyd_config->conn)) != NULL) {
          config->glewlwyd_config->glewlwyd_callback_update_issued_for(config->glewlwyd_config, NULL, GLEWLWYD_PLUGIN_OIDC_TABLE_CIBA, "gpob_issued_for", ip_source, "gpob_id", json_integer_value(j_last_id));
          j_query = json_pack("{sss[]}", "table", GLEWLWYD_PLUGIN_OIDC_TABLE_CIBA_SCOPE, "values");
          if (split_string_remove_duplicates(scope, " ", &scope_array)) {
            for (i=0; scope_array[i] != NULL; i++) {
              json_array_append_new(json_object_get(j_query, "values"), json_pack("{sOss}", "gpob_id", j_last_id, "gpops_scope", scope_array[i]));
            }
            res = h_insert(config->glewlwyd_config->glewlwyd_config->conn, j_query, NULL);
            if (res == H_OK) {
              ret = G_OK;
            } else {
              y_log_message(Y_LOG_LEVEL_ERROR, "serialize_ciba_request - Error executing j_query (3)");
              ret = G_ERROR_DB;
            }
          } else {
            y_log_message(Y_LOG_LEVEL_ERROR, "serialize_ciba_request - Error split_string_remove_duplicates");
            ret = G_ERROR;
          }
          free_string_array(scope_array);
          json_decref(j_query);
        } else {
          y_log_message(Y_LOG_LEVEL_ERROR, "serialize_ciba_request - Error h_last_insert_id");
          ret = G_ERROR_DB;
        }
        json_decref(j_last_id);
      } else {
        y_log_message(Y_LOG_LEVEL_ERROR, "serialize_ciba_request - Error executing j_query (2)");
        ret = G_ERROR_DB;
      }
    } else {
      y_log_message(Y_LOG_LEVEL_ERROR, "serialize_ciba_request - Error executing j_query (1)");
      ret = G_ERROR_DB;
    }

    pthread_mutex_unlock(&config->insert_lock);
  }

  return ret;
}
