static int callback_oauth2_device_authorization(const struct _u_request * request, struct _u_response * response, void * user_data) {
  struct _oauth2_config * config = (struct _oauth2_config *)user_data;
  const char * ip_source = get_ip_source(request, config->glewlwyd_config->glewlwyd_config->originating_ip_header), * client_id = request->auth_basic_user, * client_secret = request->auth_basic_password;
  char * verification_uri, * verification_uri_complete, * plugin_url = config->glewlwyd_config->glewlwyd_callback_get_plugin_external_url(config->glewlwyd_config, json_string_value(json_object_get(config->j_params, "name")));
  json_t * j_client, * j_body, * j_result;

  if (client_id == NULL && u_map_get(request->map_post_body, "client_id") != NULL) {
    client_id = u_map_get(request->map_post_body, "client_id");
  }
  if (client_secret == NULL && u_map_get(request->map_post_body, "client_secret") != NULL) {
    client_secret = u_map_get(request->map_post_body, "client_secret");
  }
  if (!o_strnullempty(u_map_get(request->map_post_body, "scope"))) {
    j_client = check_client_valid(config,
                                 client_id,
                                 client_id,
                                 client_secret,
                                 NULL,
                                 GLEWLWYD_AUTHORIZATION_TYPE_DEVICE_AUTHORIZATION,
                                 0,
                                 ip_source);
    if (check_result_value(j_client, G_OK)) {
      client_id = json_string_value(json_object_get(json_object_get(j_client, "client"), "client_id"));
      j_result = generate_device_authorization(config, client_id, u_map_get(request->map_post_body, "scope"), ip_source);
      if (check_result_value(j_result, G_OK)) {
          verification_uri = msprintf("%s/device", plugin_url);
          verification_uri_complete = msprintf("%s/device?code=%s", plugin_url, json_string_value(json_object_get(json_object_get(j_result, "authorization"), "user_code")));
          j_body = json_pack("{sOsOsssssOsO}",
                             "device_code", json_object_get(json_object_get(j_result, "authorization"), "device_code"),
                             "user_code", json_object_get(json_object_get(j_result, "authorization"), "user_code"),
                             "verification_uri", verification_uri,
                             "verification_uri_complete", verification_uri_complete,
                             "expires_in", json_object_get(config->j_params, "device-authorization-expiration"),
                             "interval", json_object_get(config->j_params, "device-authorization-interval"));
          ulfius_set_json_body_response(response, 200, j_body);
          json_decref(j_body);
          o_free(verification_uri);
          o_free(verification_uri_complete);
          config->glewlwyd_config->glewlwyd_plugin_callback_metrics_increment_counter(config->glewlwyd_config, GLWD_METRICS_OAUTH2_DEVICE_CODE, 1, "plugin", config->name, NULL);
      } else {
        y_log_message(Y_LOG_LEVEL_ERROR, "callback_oauth2_device_authorization oauth2 - Error generate_device_authorization");
        j_body = json_pack("{ss}", "error", "server_error");
        ulfius_set_json_body_response(response, 500, j_body);
        json_decref(j_body);
      }
      json_decref(j_result);
    } else {
      j_body = json_pack("{ss}", "error", "unauthorized_client");
      ulfius_set_json_body_response(response, 403, j_body);
      json_decref(j_body);
      config->glewlwyd_config->glewlwyd_plugin_callback_metrics_increment_counter(config->glewlwyd_config, GLWD_METRICS_OAUTH2_UNAUTHORIZED_CLIENT, 1, "plugin", config->name, NULL);
    }
    json_decref(j_client);
  } else {
    j_body = json_pack("{ss}", "error", "invalid_scope");
    ulfius_set_json_body_response(response, 400, j_body);
    json_decref(j_body);
  }
  o_free(plugin_url);
  return U_CALLBACK_CONTINUE;
}
