store_ansi(ch, rep, pos)
	LWCHAR ch;
	char *rep;
	POSITION pos;
{
	switch (ansi_step(line_ansi, ch))
	{
	case ANSI_MID:
		STORE_CHAR(ch, AT_ANSI, rep, pos);
		if (line_ansi->hlink)
			hlink_in_line = 1;
		xbuf_add_byte(&last_ansi, (unsigned char) ch);
		break;
	case ANSI_END:
		STORE_CHAR(ch, AT_ANSI, rep, pos);
		ansi_done(line_ansi);
		line_ansi = NULL;
		xbuf_add_byte(&last_ansi, (unsigned char) ch);
		xbuf_set(&last_ansis[curr_last_ansi], &last_ansi);
		xbuf_reset(&last_ansi);
		curr_last_ansi = (curr_last_ansi + 1) % NUM_LAST_ANSIS;
		break;
	case ANSI_ERR:
		{
			/* Remove whole unrecognized sequence.  */
			char *start = (cshift < hshift) ? xbuf_char_data(&shifted_ansi): linebuf.buf;
			int *end = (cshift < hshift) ? &shifted_ansi.end : &linebuf.end;
			char *p = start + *end;
			LWCHAR bch;
			do {
				bch = step_char(&p, -1, start);
			} while (p > start && !IS_CSI_START(bch));
			*end = (int) (p - start);
		}
		xbuf_reset(&last_ansi);
		ansi_done(line_ansi);
		line_ansi = NULL;
		break;
	}
	return (0);
} 
