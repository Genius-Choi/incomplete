Status SnapshotManager::WorkerHeartbeat(const WorkerHeartbeatRequest& request,
                                        WorkerHeartbeatResponse& response) {
  SnapshotTaskDef* snapshot_task = response.add_snapshot_tasks();
  snapshot_task->set_base_path(path_);
  snapshot_task->set_num_sources(num_sources());
  *snapshot_task->mutable_metadata() = metadata_;

  if (auto it = assignments_.find(request.worker_address());
      it != assignments_.end()) {
    snapshot_task->set_stream_index(it->second);
    return OkStatus();
  }

  // TODO(mpcallanan): Handle orphans.

  TF_ASSIGN_OR_RETURN(int64_t new_stream_index,
                      CreateNewStream(request.worker_address()));
  snapshot_task->set_stream_index(new_stream_index);
  return OkStatus();
}
