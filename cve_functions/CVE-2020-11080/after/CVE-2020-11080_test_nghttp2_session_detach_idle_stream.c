void test_nghttp2_session_detach_idle_stream(void) {
  nghttp2_session *session;
  nghttp2_session_callbacks callbacks;
  int i;
  nghttp2_stream *stream;

  memset(&callbacks, 0, sizeof(callbacks));
  callbacks.send_callback = null_send_callback;

  nghttp2_session_server_new(&session, &callbacks, NULL);

  for (i = 1; i <= 3; ++i) {
    nghttp2_session_open_stream(session, i, NGHTTP2_STREAM_FLAG_NONE,
                                &pri_spec_default, NGHTTP2_STREAM_IDLE, NULL);
  }

  CU_ASSERT(3 == session->num_idle_streams);

  /* Detach middle stream */
  stream = nghttp2_session_get_stream_raw(session, 2);

  CU_ASSERT(session->idle_stream_head == stream->closed_prev);
  CU_ASSERT(session->idle_stream_tail == stream->closed_next);
  CU_ASSERT(stream == session->idle_stream_head->closed_next);
  CU_ASSERT(stream == session->idle_stream_tail->closed_prev);

  nghttp2_session_detach_idle_stream(session, stream);

  CU_ASSERT(2 == session->num_idle_streams);

  CU_ASSERT(NULL == stream->closed_prev);
  CU_ASSERT(NULL == stream->closed_next);

  CU_ASSERT(session->idle_stream_head ==
            session->idle_stream_tail->closed_prev);
  CU_ASSERT(session->idle_stream_tail ==
            session->idle_stream_head->closed_next);

  /* Detach head stream */
  stream = session->idle_stream_head;

  nghttp2_session_detach_idle_stream(session, stream);

  CU_ASSERT(1 == session->num_idle_streams);

  CU_ASSERT(session->idle_stream_head == session->idle_stream_tail);
  CU_ASSERT(NULL == session->idle_stream_head->closed_prev);
  CU_ASSERT(NULL == session->idle_stream_head->closed_next);

  /* Detach last stream */

  stream = session->idle_stream_head;

  nghttp2_session_detach_idle_stream(session, stream);

  CU_ASSERT(0 == session->num_idle_streams);

  CU_ASSERT(NULL == session->idle_stream_head);
  CU_ASSERT(NULL == session->idle_stream_tail);

  for (i = 4; i <= 5; ++i) {
    nghttp2_session_open_stream(session, i, NGHTTP2_STREAM_FLAG_NONE,
                                &pri_spec_default, NGHTTP2_STREAM_IDLE, NULL);
  }

  CU_ASSERT(2 == session->num_idle_streams);

  /* Detach tail stream */

  stream = session->idle_stream_tail;

  nghttp2_session_detach_idle_stream(session, stream);

  CU_ASSERT(1 == session->num_idle_streams);

  CU_ASSERT(session->idle_stream_head == session->idle_stream_tail);
  CU_ASSERT(NULL == session->idle_stream_head->closed_prev);
  CU_ASSERT(NULL == session->idle_stream_head->closed_next);

  nghttp2_session_del(session);
}
