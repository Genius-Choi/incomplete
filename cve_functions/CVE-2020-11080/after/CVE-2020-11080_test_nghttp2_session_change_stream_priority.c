void test_nghttp2_session_change_stream_priority(void) {
  nghttp2_session *session;
  nghttp2_session_callbacks callbacks;
  nghttp2_stream *stream1, *stream2, *stream3, *stream5;
  nghttp2_priority_spec pri_spec;
  int rv;

  memset(&callbacks, 0, sizeof(callbacks));

  nghttp2_session_server_new(&session, &callbacks, NULL);

  stream1 = open_recv_stream(session, 1);
  stream3 = open_recv_stream_with_dep_weight(session, 3, 199, stream1);
  stream2 = open_sent_stream_with_dep_weight(session, 2, 101, stream3);

  nghttp2_priority_spec_init(&pri_spec, 1, 256, 0);

  rv = nghttp2_session_change_stream_priority(session, 2, &pri_spec);

  CU_ASSERT(0 == rv);

  CU_ASSERT(stream1 == stream2->dep_prev);
  CU_ASSERT(256 == stream2->weight);

  /* Cannot change stream which does not exist */
  rv = nghttp2_session_change_stream_priority(session, 5, &pri_spec);
  CU_ASSERT(NGHTTP2_ERR_INVALID_ARGUMENT == rv);

  /* It is an error to depend on itself */
  rv = nghttp2_session_change_stream_priority(session, 1, &pri_spec);
  CU_ASSERT(NGHTTP2_ERR_INVALID_ARGUMENT == rv);

  /* It is an error to change priority of root stream (0) */
  rv = nghttp2_session_change_stream_priority(session, 0, &pri_spec);
  CU_ASSERT(NGHTTP2_ERR_INVALID_ARGUMENT == rv);

  /* Depends on the non-existing idle stream.  This creates that idle
     stream. */
  nghttp2_priority_spec_init(&pri_spec, 5, 9, 1);

  rv = nghttp2_session_change_stream_priority(session, 2, &pri_spec);

  CU_ASSERT(0 == rv);

  stream5 = nghttp2_session_get_stream_raw(session, 5);

  CU_ASSERT(NULL != stream5);
  CU_ASSERT(&session->root == stream5->dep_prev);
  CU_ASSERT(stream5 == stream2->dep_prev);
  CU_ASSERT(9 == stream2->weight);

  nghttp2_session_del(session);

  /* Check that this works in client session too */
  nghttp2_session_client_new(&session, &callbacks, NULL);

  stream1 = open_sent_stream(session, 1);

  nghttp2_priority_spec_init(&pri_spec, 5, 9, 1);

  rv = nghttp2_session_change_stream_priority(session, 1, &pri_spec);

  CU_ASSERT(0 == rv);

  stream5 = nghttp2_session_get_stream_raw(session, 5);

  CU_ASSERT(NULL != stream5);
  CU_ASSERT(&session->root == stream5->dep_prev);
  CU_ASSERT(stream5 == stream1->dep_prev);
  CU_ASSERT(9 == stream1->weight);

  nghttp2_session_del(session);
}
