void test_nghttp2_session_stream_attach_item_subtree(void) {
  nghttp2_session *session;
  nghttp2_session_callbacks callbacks;
  nghttp2_stream *a, *b, *c, *d, *e, *f;
  nghttp2_outbound_item *da, *db, *dd, *de;
  nghttp2_mem *mem;

  mem = nghttp2_mem_default();

  memset(&callbacks, 0, sizeof(callbacks));

  nghttp2_session_server_new(&session, &callbacks, NULL);

  a = open_stream(session, 1);
  b = open_stream_with_dep(session, 3, a);
  c = open_stream_with_dep(session, 5, a);
  d = open_stream_with_dep(session, 7, c);

  e = open_stream_with_dep_weight(session, 9, 32, &session->root);
  f = open_stream_with_dep(session, 11, e);

  /*
   * a        e
   * |        |
   * c--b     f
   * |
   * d
   */

  de = create_data_ob_item(mem);

  nghttp2_stream_attach_item(e, de);

  db = create_data_ob_item(mem);

  nghttp2_stream_attach_item(b, db);

  CU_ASSERT(a->queued);
  CU_ASSERT(b->queued);
  CU_ASSERT(!c->queued);
  CU_ASSERT(!d->queued);
  CU_ASSERT(e->queued);
  CU_ASSERT(!f->queued);

  CU_ASSERT(1 == nghttp2_pq_size(&a->obq));
  CU_ASSERT(nghttp2_pq_empty(&b->obq));
  CU_ASSERT(nghttp2_pq_empty(&c->obq));
  CU_ASSERT(nghttp2_pq_empty(&d->obq));
  CU_ASSERT(nghttp2_pq_empty(&e->obq));
  CU_ASSERT(nghttp2_pq_empty(&f->obq));

  /* Insert subtree e under a */

  nghttp2_stream_dep_remove_subtree(e);
  nghttp2_stream_dep_insert_subtree(a, e);

  /*
   * a
   * |
   * e
   * |
   * f--c--b
   *    |
   *    d
   */

  CU_ASSERT(a->queued);
  CU_ASSERT(b->queued);
  CU_ASSERT(!c->queued);
  CU_ASSERT(!d->queued);
  CU_ASSERT(e->queued);
  CU_ASSERT(!f->queued);

  CU_ASSERT(1 == nghttp2_pq_size(&a->obq));
  CU_ASSERT(nghttp2_pq_empty(&b->obq));
  CU_ASSERT(nghttp2_pq_empty(&c->obq));
  CU_ASSERT(nghttp2_pq_empty(&d->obq));
  CU_ASSERT(1 == nghttp2_pq_size(&e->obq));
  CU_ASSERT(nghttp2_pq_empty(&f->obq));

  /* Remove subtree b */

  nghttp2_stream_dep_remove_subtree(b);

  CU_ASSERT(0 == nghttp2_stream_dep_add_subtree(&session->root, b));

  /*
   * a       b
   * |
   * e
   * |
   * f--c
   *    |
   *    d
   */

  CU_ASSERT(a->queued);
  CU_ASSERT(b->queued);
  CU_ASSERT(!c->queued);
  CU_ASSERT(!d->queued);
  CU_ASSERT(e->queued);
  CU_ASSERT(!f->queued);

  CU_ASSERT(1 == nghttp2_pq_size(&a->obq));
  CU_ASSERT(nghttp2_pq_empty(&b->obq));
  CU_ASSERT(nghttp2_pq_empty(&c->obq));
  CU_ASSERT(nghttp2_pq_empty(&d->obq));
  CU_ASSERT(nghttp2_pq_empty(&e->obq));
  CU_ASSERT(nghttp2_pq_empty(&f->obq));

  /* Remove subtree a, and add it to root again */

  nghttp2_stream_dep_remove_subtree(a);

  CU_ASSERT(0 == nghttp2_stream_dep_add_subtree(&session->root, a));

  CU_ASSERT(a->queued);
  CU_ASSERT(b->queued);
  CU_ASSERT(!c->queued);
  CU_ASSERT(!d->queued);
  CU_ASSERT(e->queued);
  CU_ASSERT(!f->queued);

  CU_ASSERT(1 == nghttp2_pq_size(&a->obq));
  CU_ASSERT(nghttp2_pq_empty(&b->obq));
  CU_ASSERT(nghttp2_pq_empty(&c->obq));
  CU_ASSERT(nghttp2_pq_empty(&d->obq));
  CU_ASSERT(nghttp2_pq_empty(&e->obq));
  CU_ASSERT(nghttp2_pq_empty(&f->obq));

  /* Remove subtree c */

  nghttp2_stream_dep_remove_subtree(c);

  CU_ASSERT(0 == nghttp2_stream_dep_add_subtree(&session->root, c));

  /*
   * a       b     c
   * |             |
   * e             d
   * |
   * f
   */

  CU_ASSERT(a->queued);
  CU_ASSERT(b->queued);
  CU_ASSERT(!c->queued);
  CU_ASSERT(!d->queued);
  CU_ASSERT(e->queued);
  CU_ASSERT(!f->queued);

  CU_ASSERT(1 == nghttp2_pq_size(&a->obq));
  CU_ASSERT(nghttp2_pq_empty(&b->obq));
  CU_ASSERT(nghttp2_pq_empty(&c->obq));
  CU_ASSERT(nghttp2_pq_empty(&d->obq));
  CU_ASSERT(nghttp2_pq_empty(&e->obq));
  CU_ASSERT(nghttp2_pq_empty(&f->obq));

  dd = create_data_ob_item(mem);

  nghttp2_stream_attach_item(d, dd);

  /* Add subtree c to a */

  nghttp2_stream_dep_remove_subtree(c);
  nghttp2_stream_dep_add_subtree(a, c);

  /*
   * a       b
   * |
   * c--e
   * |  |
   * d  f
   */

  CU_ASSERT(a->queued);
  CU_ASSERT(b->queued);
  CU_ASSERT(c->queued);
  CU_ASSERT(d->queued);
  CU_ASSERT(e->queued);
  CU_ASSERT(!f->queued);

  CU_ASSERT(2 == nghttp2_pq_size(&a->obq));
  CU_ASSERT(nghttp2_pq_empty(&b->obq));
  CU_ASSERT(1 == nghttp2_pq_size(&c->obq));
  CU_ASSERT(nghttp2_pq_empty(&d->obq));
  CU_ASSERT(nghttp2_pq_empty(&e->obq));
  CU_ASSERT(nghttp2_pq_empty(&f->obq));

  /* Insert b under a */

  nghttp2_stream_dep_remove_subtree(b);
  nghttp2_stream_dep_insert_subtree(a, b);

  /*
   * a
   * |
   * b
   * |
   * c--e
   * |  |
   * d  f
   */

  CU_ASSERT(a->queued);
  CU_ASSERT(b->queued);
  CU_ASSERT(c->queued);
  CU_ASSERT(d->queued);
  CU_ASSERT(e->queued);
  CU_ASSERT(!f->queued);

  CU_ASSERT(1 == nghttp2_pq_size(&a->obq));
  CU_ASSERT(2 == nghttp2_pq_size(&b->obq));
  CU_ASSERT(1 == nghttp2_pq_size(&c->obq));
  CU_ASSERT(nghttp2_pq_empty(&d->obq));
  CU_ASSERT(nghttp2_pq_empty(&e->obq));
  CU_ASSERT(nghttp2_pq_empty(&f->obq));

  /* Remove subtree b */

  nghttp2_stream_dep_remove_subtree(b);
  CU_ASSERT(0 == nghttp2_stream_dep_add_subtree(&session->root, b));

  /*
   * b       a
   * |
   * e--c
   * |  |
   * f  d
   */

  CU_ASSERT(!a->queued);
  CU_ASSERT(b->queued);
  CU_ASSERT(c->queued);
  CU_ASSERT(d->queued);
  CU_ASSERT(e->queued);
  CU_ASSERT(!f->queued);

  CU_ASSERT(nghttp2_pq_empty(&a->obq));
  CU_ASSERT(2 == nghttp2_pq_size(&b->obq));
  CU_ASSERT(1 == nghttp2_pq_size(&c->obq));
  CU_ASSERT(nghttp2_pq_empty(&d->obq));
  CU_ASSERT(nghttp2_pq_empty(&e->obq));
  CU_ASSERT(nghttp2_pq_empty(&f->obq));

  /* Remove subtree c, and detach item from b, and then re-add
     subtree c under b */

  nghttp2_stream_dep_remove_subtree(c);
  nghttp2_stream_detach_item(b);
  nghttp2_stream_dep_add_subtree(b, c);

  /*
   * b       a
   * |
   * e--c
   * |  |
   * f  d
   */

  CU_ASSERT(!a->queued);
  CU_ASSERT(b->queued);
  CU_ASSERT(c->queued);
  CU_ASSERT(d->queued);
  CU_ASSERT(e->queued);
  CU_ASSERT(!f->queued);

  CU_ASSERT(nghttp2_pq_empty(&a->obq));
  CU_ASSERT(2 == nghttp2_pq_size(&b->obq));
  CU_ASSERT(1 == nghttp2_pq_size(&c->obq));
  CU_ASSERT(nghttp2_pq_empty(&d->obq));
  CU_ASSERT(nghttp2_pq_empty(&e->obq));
  CU_ASSERT(nghttp2_pq_empty(&f->obq));

  /* Attach data to a, and add subtree a under b */

  da = create_data_ob_item(mem);
  nghttp2_stream_attach_item(a, da);
  nghttp2_stream_dep_remove_subtree(a);
  nghttp2_stream_dep_add_subtree(b, a);

  /*
   * b
   * |
   * a--e--c
   *    |  |
   *    f  d
   */

  CU_ASSERT(a->queued);
  CU_ASSERT(b->queued);
  CU_ASSERT(c->queued);
  CU_ASSERT(d->queued);
  CU_ASSERT(e->queued);
  CU_ASSERT(!f->queued);

  CU_ASSERT(nghttp2_pq_empty(&a->obq));
  CU_ASSERT(3 == nghttp2_pq_size(&b->obq));
  CU_ASSERT(1 == nghttp2_pq_size(&c->obq));
  CU_ASSERT(nghttp2_pq_empty(&d->obq));
  CU_ASSERT(nghttp2_pq_empty(&e->obq));
  CU_ASSERT(nghttp2_pq_empty(&f->obq));

  /* Remove subtree c, and add under f */
  nghttp2_stream_dep_remove_subtree(c);
  nghttp2_stream_dep_insert_subtree(f, c);

  /*
   * b
   * |
   * a--e
   *    |
   *    f
   *    |
   *    c
   *    |
   *    d
   */

  CU_ASSERT(a->queued);
  CU_ASSERT(b->queued);
  CU_ASSERT(c->queued);
  CU_ASSERT(d->queued);
  CU_ASSERT(e->queued);
  CU_ASSERT(f->queued);

  CU_ASSERT(nghttp2_pq_empty(&a->obq));
  CU_ASSERT(2 == nghttp2_pq_size(&b->obq));
  CU_ASSERT(1 == nghttp2_pq_size(&c->obq));
  CU_ASSERT(nghttp2_pq_empty(&d->obq));
  CU_ASSERT(1 == nghttp2_pq_size(&e->obq));
  CU_ASSERT(1 == nghttp2_pq_size(&f->obq));

  /* db has been detached */
  nghttp2_outbound_item_free(db, mem);
  free(db);

  nghttp2_session_del(session);
}
