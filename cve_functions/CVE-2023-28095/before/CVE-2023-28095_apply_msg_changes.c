static inline void apply_msg_changes(struct sip_msg *msg,
							char *new_buf, unsigned int *new_offs,
							unsigned int *orig_offs, struct socket_info *sock,
							unsigned int max_offset)
{
	unsigned int size;

	/* apply changes over the SIP headers */
	process_lumps(msg, msg->add_rm, new_buf, new_offs, orig_offs, sock, -1);
	if (msg->body==NULL) {
		/* no body parsed, no advanced ops done, just dummy lumps over body */
		process_lumps(msg, msg->body_lumps, new_buf, new_offs,
			orig_offs, sock, max_offset);
		/* copy the rest of the message */
		memcpy(new_buf+*new_offs, msg->buf+*orig_offs, max_offset-*orig_offs);
		*new_offs += max_offset-*orig_offs;
	} else {
		/* copy whatever is left in the original buffer (up to the body) */
		size = (msg->body->part_count) ?
			  ((msg->body->body.s - msg->buf) - *orig_offs) /* msg had body */
			: (msg->len - *orig_offs);                      /* no body */
		memcpy(new_buf+*new_offs, msg->buf+*orig_offs, size );
		*new_offs += size;
		*orig_offs += size;
		/* rebuild the body, part by part, in a content wise manner */
		reassemble_body_parts(msg, new_buf, new_offs, orig_offs, sock);
	}
}
