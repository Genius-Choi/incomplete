void fp12_exp_cyc_sim(fp12_t e, const fp12_t a, const bn_t b, const fp12_t c, const bn_t d) {
	int i, j, l;
	bn_t _b[4], _d[4], n, x;
	fp12_t t[4], u[4];

	if (bn_is_zero(b)) {
		return fp12_exp_cyc(e, c, d);
	}

	if (bn_is_zero(d)) {
		return fp12_exp_cyc(e, a, b);
	}

	bn_null(n);
	bn_null(x);

	RLC_TRY {
		bn_new(n);
		bn_new(x);
		for (i = 0; i < 4; i++) {
			bn_null(_b[i]);
			bn_null(_d[i]);
			fp12_null(t[i]);
			fp12_null(u[i]);
			bn_new(_b[i]);
			bn_new(_d[i]);
			fp12_new(t[i]);
			fp12_new(u[i]);
		}

		ep_curve_get_ord(n);
		fp_prime_get_par(x);
		bn_rec_frb(_b, 4, b, x, n, ep_curve_is_pairf() == EP_BN);
		bn_rec_frb(_d, 4, d, x, n, ep_curve_is_pairf() == EP_BN);

		if (ep_curve_is_pairf()) {
			for (i = 0; i < 4; i++) {
				fp12_frb(t[i], a, i);
				fp12_frb(u[i], c, i);
				if (bn_sign(_b[i]) == RLC_NEG) {
					fp12_inv_cyc(t[i], t[i]);
				}
				if (bn_sign(_d[i]) == RLC_NEG) {
					fp12_inv_cyc(u[i], u[i]);
				}
			}

			l = RLC_MAX(bn_bits(_b[0]), bn_bits(_b[1]));
			l = RLC_MAX(l, RLC_MAX(bn_bits(_b[2]), bn_bits(_b[3])));
			l = RLC_MAX(l, RLC_MAX(bn_bits(_d[0]), bn_bits(_d[1])));
			l = RLC_MAX(l, RLC_MAX(bn_bits(_d[2]), bn_bits(_d[3])));

			fp12_set_dig(e, 1);
			for (i = l - 1; i >= 0; i--) {
				fp12_sqr_cyc(e, e);
				for (j = 0; j < 4; j++) {
					if (bn_get_bit(_b[j], i)) {
						fp12_mul(e, e, t[j]);
					}
					if (bn_get_bit(_d[j], i)) {
						fp12_mul(e, e, u[j]);
					}
				}
			}
		} else {
			if (bn_sign(b) == RLC_NEG) {
				fp12_inv_cyc(t[0], a);
			} else {
				fp12_copy(t[0], a);
			}
			if (bn_sign(d) == RLC_NEG) {
				fp12_inv_cyc(u[0], c);
			} else {
				fp12_copy(u[0], c);
			}

			fp12_set_dig(e, 1);
			l = RLC_MAX(bn_bits(b), bn_bits(d));
			for (i = l - 1; i >= 0; i--) {
				fp12_sqr_cyc(e, e);
				if (bn_get_bit(b, i)) {
					fp12_mul(e, e, t[0]);
				}
				if (bn_get_bit(d, i)) {
					fp12_mul(e, e, u[0]);
				}
			}
		}
	} RLC_CATCH_ANY {
		RLC_THROW(ERR_CAUGHT);
	} RLC_FINALLY {
		bn_free(n);
		bn_free(x);
		for (i = 0; i < 4; i++) {
			bn_free(_b[i]);
			bn_free(_d[i]);
			fp12_free(t[i]);
			fp12_free(u[i]);
		}
	}
}
