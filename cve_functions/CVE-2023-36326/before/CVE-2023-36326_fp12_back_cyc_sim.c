void fp12_back_cyc_sim(fp12_t c[], const fp12_t a[], int n) {
    fp2_t *t = RLC_ALLOCA(fp2_t, n * 3);
    fp2_t
        *t0 = t + 0 * n,
        *t1 = t + 1 * n,
        *t2 = t + 2 * n;

	if (n == 0) {
		RLC_FREE(t);
		return;
	}

	RLC_TRY {
		if (t == NULL) {
			RLC_THROW(ERR_NO_MEMORY);
		}
		for (int i = 0; i < n; i++) {
			fp2_null(t0[i]);
			fp2_null(t1[i]);
			fp2_null(t2[i]);
			fp2_new(t0[i]);
			fp2_new(t1[i]);
			fp2_new(t2[i]);
		}

		for (int i = 0; i < n; i++) {
			/* TODO: make this constant time. */
			if (fp2_is_zero(a[i][1][0])) {
				/* t0 = 2 * g4 * g5 */
				fp2_mul(t0[i], a[i][0][1], a[i][1][2]);
				fp2_dbl(t0[i], t0[i]);
				fp2_copy(t1[i], a[i][0][2]);
			} else {
				/* t0 = g4^2. */
				fp2_sqr(t0[i], a[i][0][1]);
				/* t1 = 3 * g4^2 - 2 * g3. */
				fp2_sub(t1[i], t0[i], a[i][0][2]);
				fp2_dbl(t1[i], t1[i]);
				fp2_add(t1[i], t1[i], t0[i]);
				/* t0 = E * g5^2 + t1. */
				fp2_sqr(t2[i], a[i][1][2]);
				fp2_mul_nor(t0[i], t2[i]);
				fp2_add(t0[i], t0[i], t1[i]);
				/* t1 = (4 * g2). */
				fp2_dbl(t1[i], a[i][1][0]);
				fp2_dbl(t1[i], t1[i]);
			}
		}

		/* t1 = 1 / t1. */
		fp2_inv_sim(t1, t1, n);

		for (int i = 0; i < n; i++) {
			/* t0 = g1. */
			fp2_mul(c[i][1][1], t0[i], t1[i]);

			/* t1 = g3 * g4. */
			fp2_mul(t1[i], a[i][0][2], a[i][0][1]);
			/* t2 = 2 * g1^2 - 3 * g3 * g4. */
			fp2_sqr(t2[i], c[i][1][1]);
			fp2_sub(t2[i], t2[i], t1[i]);
			fp2_dbl(t2[i], t2[i]);
			fp2_sub(t2[i], t2[i], t1[i]);
			/* t1 = g2 * g5. */
			fp2_mul(t1[i], a[i][1][0], a[i][1][2]);
			/* t2 = E * (2 * g1^2 + g2 * g5 - 3 * g3 * g4) + 1. */
			fp2_add(t2[i], t2[i], t1[i]);
			fp2_mul_nor(c[i][0][0], t2[i]);
			fp_add_dig(c[i][0][0][0], c[i][0][0][0], 1);

			fp2_copy(c[i][0][1], a[i][0][1]);
			fp2_copy(c[i][0][2], a[i][0][2]);
			fp2_copy(c[i][1][0], a[i][1][0]);
			fp2_copy(c[i][1][2], a[i][1][2]);
		}
	} RLC_CATCH_ANY {
		RLC_THROW(ERR_CAUGHT);
	} RLC_FINALLY {
		for (int i = 0; i < n; i++) {
			fp2_free(t0[i]);
			fp2_free(t1[i]);
			fp2_free(t2[i]);
		}
		RLC_FREE(t);
	}
}
