static uint32_t decode_variable_length(const char *buf,
                                       uint32_t *bytes_consumed) {
  uint32_t value = 0, multiplier = 1, offset;

  for (offset = 0; offset < 4; offset++) {
    uint8_t encoded_byte = ((uint8_t *) buf)[offset];
    value += (encoded_byte & 0x7F) * multiplier;
    multiplier *= 128;

    if (!(encoded_byte & 0x80)) break;
  }

  if (bytes_consumed != NULL) *bytes_consumed = offset + 1;

  return value;
}
