static void mqtt_cb(struct mg_connection *c, int ev, void *evd, void *fnd) {
  struct mqtt_data *test_data = (struct mqtt_data *) fnd;
  char *buf = test_data->buf;

  if (ev == MG_EV_MQTT_OPEN) {
    buf[0] = *(int *) evd == 0 ? 'X' : 'Y';
  } else if (ev == MG_EV_MQTT_CMD) {
    struct mg_mqtt_message *mm = (struct mg_mqtt_message *) evd;
    if (mm->cmd == MQTT_CMD_SUBACK) {
      test_data->subscribed = 1;
    }
    if (mm->cmd == MQTT_CMD_PUBACK) {
      test_data->published = 1;
    }
  } else if (ev == MG_EV_MQTT_MSG) {
    struct mg_mqtt_message *mm = (struct mg_mqtt_message *) evd;
    snprintf(buf + 1, test_data->bufsize, "%.*s/%.*s", (int) mm->topic.len,
             mm->topic.ptr, (int) mm->data.len, mm->data.ptr);

    if (mm->cmd == MQTT_CMD_PUBLISH && c->is_mqtt5) {
      size_t pos = 0;
      struct mg_mqtt_prop prop;

      // note: the server will send the properties sorted by their ID
      ASSERT((pos = mg_mqtt_next_prop(mm, &prop, pos)) > 0);
      ASSERT(prop.iv == 10 && prop.id == MQTT_PROP_MESSAGE_EXPIRY_INTERVAL);

      ASSERT((pos = mg_mqtt_next_prop(mm, &prop, pos)) > 0);
      ASSERT(prop.id == MQTT_PROP_CONTENT_TYPE);
      ASSERT(strncmp(prop.val.ptr, "test_content_val_2", prop.val.len) == 0 &&
             prop.val.len == strlen("test_content_val_2"));

      ASSERT((pos = mg_mqtt_next_prop(mm, &prop, pos)) > 0);
      ASSERT(prop.id == MQTT_PROP_USER_PROPERTY);
      ASSERT(strncmp(prop.key.ptr, "test_key_1", prop.key.len) == 0 &&
             prop.key.len == strlen("test_key_1"));
      ASSERT(strncmp(prop.val.ptr, "test_value_1", prop.val.len) == 0 &&
             prop.val.len == strlen("test_value_1"));

      ASSERT((pos = mg_mqtt_next_prop(mm, &prop, pos)) > 0);
      ASSERT(prop.id == MQTT_PROP_USER_PROPERTY);
      ASSERT(strncmp(prop.key.ptr, "test_key_2", prop.key.len) == 0 &&
             prop.key.len == strlen("test_key_2"));
      ASSERT(strncmp(prop.val.ptr, "test_value_2", prop.val.len) == 0 &&
             prop.val.len == strlen("test_value_2"));

      ASSERT((pos = mg_mqtt_next_prop(mm, &prop, pos)) == 0);
    }
  }
  (void) c;
}
