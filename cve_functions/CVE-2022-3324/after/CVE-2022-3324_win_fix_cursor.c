win_fix_cursor(int normal)
{
    win_T    *wp = curwin;
    long     so = get_scrolloff_value();
    linenr_T nlnum = 0;

    if (wp->w_buffer->b_ml.ml_line_count < wp->w_height)
	return;
#ifdef FEAT_CMDWIN
    if (skip_win_fix_cursor)
	return;
#endif

    so = MIN(wp->w_height / 2, so);
    // Check if cursor position is above topline or below botline.
    if (wp->w_cursor.lnum < (wp->w_topline + so) && wp->w_topline != 1)
	nlnum = MIN(wp->w_topline + so, wp->w_buffer->b_ml.ml_line_count);
    else if (wp->w_cursor.lnum > (wp->w_botline - so - 1)
	    && (wp->w_botline - wp->w_buffer->b_ml.ml_line_count) != 1)
	nlnum = MAX(wp->w_botline - so - 1, 1);
    // If cursor was invalid scroll or change cursor.
    if (nlnum)
    {
	if (normal)
	{   // Make sure cursor is closer to topline than botline.
	    if (so == wp->w_height / 2
			  && nlnum - wp->w_topline > wp->w_botline - 1 - nlnum)
		nlnum--;
	    setmark('\'');		// save cursor position
	    wp->w_cursor.lnum = nlnum;	// change to avoid scrolling
	    curs_columns(TRUE);		// validate w_wrow
	}
	else
	{   // Ensure cursor stays visible if we are not in normal mode.
	    wp->w_fraction = 0.5 * FRACTION_MULT;
	    scroll_to_fraction(wp, wp->w_prev_height);
	    validate_botline_win(curwin);
	}
    }
}
