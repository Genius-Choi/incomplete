void OAuth2ClientImpl::asyncGetAccessToken(const std::string& auth_code,
                                           const std::string& client_id, const std::string& secret,
                                           const std::string& cb_url) {
  const auto encoded_client_id = Http::Utility::PercentEncoding::encode(client_id, ":/=&?");
  const auto encoded_secret = Http::Utility::PercentEncoding::encode(secret, ":/=&?");
  const auto encoded_cb_url = Http::Utility::PercentEncoding::encode(cb_url, ":/=&?");

  Http::RequestMessagePtr request = createPostRequest();
  const std::string body = fmt::format(GetAccessTokenBodyFormatString, auth_code, encoded_client_id,
                                       encoded_secret, encoded_cb_url);
  request->body().add(body);
  request->headers().setContentLength(body.length());
  ENVOY_LOG(debug, "Dispatching OAuth request for access token.");
  dispatchRequest(std::move(request));

  ASSERT(state_ == OAuthState::Idle);
  state_ = OAuthState::PendingAccessToken;
}
