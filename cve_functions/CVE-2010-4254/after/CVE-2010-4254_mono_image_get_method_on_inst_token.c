mono_image_get_method_on_inst_token (MonoDynamicImage *assembly, MonoReflectionMethodOnTypeBuilderInst *m, gboolean create_methodspec)
{
	guint32 sig, token;
	MonoClass *klass;
	MonoGenericClass *gclass;
	MonoReflectionMethodBuilder *mb = m->mb;
	ReflectionMethodBuilder rmb;
	MonoType *type;
	char *name;

	if (m->method_args) {
		MonoMethod *inflated;

		inflated = mono_reflection_method_on_tb_inst_get_handle (m);
		if (create_methodspec)
			token = mono_image_get_methodspec_token (assembly, inflated);
		else
			token = mono_image_get_inflated_method_token (assembly, inflated);
		return token;
	}

	token = GPOINTER_TO_UINT (g_hash_table_lookup (assembly->handleref, m));
	if (token)
		return token;
	type = mono_reflection_type_get_handle ((MonoReflectionType*)m->inst);
	klass = mono_class_from_mono_type (type);
	gclass = type->data.generic_class;
	g_assert (gclass->is_dynamic);

	reflection_methodbuilder_from_method_builder (&rmb, mb);

	name = mono_string_to_utf8 (rmb.name);

	sig = method_builder_encode_signature (assembly, &rmb);

	token = mono_image_get_memberref_token (assembly, &klass->byval_arg, name, sig);
	g_free (name);

	g_hash_table_insert (assembly->handleref, m, GUINT_TO_POINTER (token));
	return token;
}
