wsemul_vt100_output_normal(struct wsemul_vt100_emuldata *edp,
    struct wsemul_inputstate *instate, int kernel)
{
	u_int *ct, dc;
	u_char c;
	int oldsschartab = edp->sschartab;
	int rc = 0;

	if ((edp->flags & (VTFL_LASTCHAR | VTFL_DECAWM)) ==
	    (VTFL_LASTCHAR | VTFL_DECAWM)) {
		rc = wsemul_vt100_nextline(edp);
		if (rc != 0)
			return rc;
		edp->ccol = 0;
		edp->flags &= ~VTFL_LASTCHAR;
	}

#ifdef HAVE_UTF8_SUPPORT
	if (edp->flags & VTFL_UTF8) {
		(*edp->emulops->mapchar)(edp->emulcookie, instate->inchar, &dc);
	} else
#endif
	{
		c = instate->inchar & 0xff;
		if (c & 0x80) {
			c &= 0x7f;
			ct = edp->chartab_G[edp->chartab1];
		} else {
			if (edp->sschartab) {
				ct = edp->chartab_G[edp->sschartab];
				edp->sschartab = 0;
			} else
				ct = edp->chartab_G[edp->chartab0];
		}
		dc = ct ? ct[c] : c;
	}

	if ((edp->flags & VTFL_INSERTMODE) && COLS_LEFT) {
		WSEMULOP(rc, edp, &edp->abortstate, copycols,
		    COPYCOLS(edp->ccol, edp->ccol + 1, COLS_LEFT));
		if (rc != 0) {
			/* undo potential sschartab update */
			edp->sschartab = oldsschartab;

			return rc;
		}
	}

#ifdef HAVE_DOUBLE_WIDTH_HEIGHT
	WSEMULOP(rc, edp, &edp->abortstate, putchar,
	    (edp->emulcookie, edp->crow, edp->ccol << edp->dw, dc,
	     kernel ? edp->kernattr : edp->curattr));
#else
	WSEMULOP(rc, edp, &edp->abortstate, putchar,
	    (edp->emulcookie, edp->crow, edp->ccol, dc,
	     kernel ? edp->kernattr : edp->curattr));
#endif
	if (rc != 0) {
		/* undo potential sschartab update */
		edp->sschartab = oldsschartab;

		return rc;
	}

	if (COLS_LEFT)
		edp->ccol++;
	else
		edp->flags |= VTFL_LASTCHAR;

	return 0;
}
