gpio_pio_write(struct virtio_gpio *gpio, int n, uint64_t reg)
{
	struct gpio_line *line;
	int value, dir, mode;
	uint16_t config;

	if (n >= gpio->nvline) {
		WPRINTF(("pio write is invalid, n %d, nvline %d\n",
				n, gpio->nvline));
		return;
	}

	line = gpio->vlines[n];
	value = reg & PIO_GPIO_VALUE_MASK;
	dir = (reg & PIO_GPIO_DIR_MASK) >> PIO_GPIO_DIR_OFFSET;
	mode = (reg & PIO_GPIO_MODE_MASK) >> PIO_GPIO_MODE_OFFSET;
	config = (reg & PIO_GPIO_CONFIG_MASK) >> PIO_GPIO_CONFIG_OFFSET;

	/* 0 means GPIO, 1 means IRQ */
	if (mode == 1) {
		WPRINTF(("pio write failure, gpio %d is in IRQ mode\n", n));
		return;
	}

	DPRINTF(("pio write n %d, reg 0x%lX, val %d, dir %d, mod %d, cfg 0x%x\n",
			n, reg, value, dir, mode, config));

	if (config != line->config)
		gpio_set_config(gpio, n, config);

	/* 0 means output, 1 means input */
	if (dir != line->dir || ((dir == 0) && (value != line->value)))
		dir == 0 ? gpio_set_direction_output(gpio, n, value) :
			gpio_set_direction_input(gpio, n);

}
