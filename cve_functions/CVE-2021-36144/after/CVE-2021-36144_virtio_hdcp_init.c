virtio_hdcp_init(struct vmctx *ctx, struct pci_vdev *dev, char *opts)
{
	struct virtio_hdcp *vhdcp;

	pthread_mutexattr_t attr;
	char tname[MAXCOMLEN + 1];
	int rc;

	vhdcp = calloc(1, sizeof(struct virtio_hdcp));
	if (!vhdcp) {
		WPRINTF(("vhdcp init: fail to alloc virtio_hdcp\n"));
		return -1;
	}

	/* init mutex attribute properly */
	int mutexattr_type = virtio_uses_msix()
			? PTHREAD_MUTEX_DEFAULT
			: PTHREAD_MUTEX_RECURSIVE;

	rc = pthread_mutexattr_init(&attr);
	if (rc)
		WPRINTF(("vhdcp init: mutexattr init fail, erro %d\n", rc));
	rc = pthread_mutexattr_settype(&attr, mutexattr_type);
	if (rc)
		WPRINTF(("vhdcp init: mutexattr_settype fail, erro %d\n", rc));
	rc = pthread_mutex_init(&vhdcp->mtx, &attr);
	if (rc)
		WPRINTF(("vhdcp init: mutexattr_settype fail, erro %d\n", rc));

	DPRINTF(("vhdcp init: using VBS-U...\n"));
	virtio_linkup(&vhdcp->base, &virtio_hdcp_ops,
			vhdcp, dev, vhdcp->queues, BACKEND_VBSU);
	vhdcp->base.mtx = &vhdcp->mtx;

	vhdcp->queues[0].qsize  = VIRTIO_HDCP_RINGSZ;
	vhdcp->queues[0].notify = virtio_hdcp_notify;

	/* initialize config space */
	pci_set_cfgdata16(dev, PCIR_DEVICE, VIRTIO_DEV_HDCP);
	pci_set_cfgdata16(dev, PCIR_VENDOR, INTEL_VENDOR_ID);
	pci_set_cfgdata8(dev, PCIR_CLASS, PCIC_CRYPTO);
	pci_set_cfgdata8(dev, PCIR_SUBCLASS, PCIS_SIMPLECOMM_OTHER);
	pci_set_cfgdata16(dev, PCIR_SUBDEV_0, VIRTIO_TYPE_HDCP);
	pci_set_cfgdata16(dev, PCIR_SUBVEND_0, INTEL_VENDOR_ID);

	if (virtio_interrupt_init(&vhdcp->base, virtio_uses_msix())) {
		WPRINTF(("vhdcp init: interrupt init fail\n"));
		free(vhdcp);
		return -1;
	}

	virtio_set_io_bar(&vhdcp->base, 0);

	/*
	 * connect to hdcp daemon in init phase
	 *
	 * @FIXME if failed connecting to HDCP daemon, the return value should
	 * be set appropriately for SOS not exposing the HDCP PCI device to UOS
	 */
	vhdcp->fd = connect_hdcp_daemon();
	if (vhdcp->fd < 0) {
		WPRINTF(("connection to server failed\n"));
		return -errno;
	}

	vhdcp->in_progress = 0;
	pthread_mutex_init(&vhdcp->rx_mtx, NULL);
	pthread_cond_init(&vhdcp->rx_cond, NULL);
	pthread_create(&vhdcp->rx_tid, NULL,
			virtio_hdcp_talk_to_daemon, (void *)vhdcp);
	snprintf(tname, sizeof(tname), "vthdcp-%d:%d tx",
			dev->slot, dev->func);
	pthread_setname_np(vhdcp->rx_tid, tname);

	return 0;
}
