virtio_rnd_deinit(struct vmctx *ctx, struct pci_vdev *dev, char *opts)
{
	struct virtio_rnd *rnd;
	void *jval;

	rnd = dev->arg;
	if (rnd == NULL) {
		DPRINTF(("%s: rnd is NULL\n", __func__));
		return;
	}

	pthread_cancel(rnd->rx_tid);
	pthread_join(rnd->rx_tid, &jval);

	if (rnd->vbs_k.status == VIRTIO_DEV_STARTED) {
		DPRINTF(("%s: deinit virtio_rnd_k!\n", __func__));
		virtio_rnd_kernel_stop(rnd);
		virtio_rnd_kernel_reset(rnd);
		rnd->vbs_k.status = VIRTIO_DEV_INITIAL;
		if (rnd->vbs_k.fd >= 0) {
			close(rnd->vbs_k.fd);
			rnd->vbs_k.fd = -1;
		}
	}

	if (rnd->fd >= 0) {
		close(rnd->fd);
		rnd->fd = -1;
	}
	DPRINTF(("%s: free struct virtio_rnd!\n", __func__));
	free(rnd);
}
