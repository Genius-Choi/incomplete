gpio_irq_set_pin_state(int fd __attribute__((unused)),
		enum ev_type t __attribute__((unused)),
		void *arg)
{
	struct gpioevent_data data;
	struct virtio_gpio *gpio;
	struct gpio_irq_desc *desc;
	int err;

	desc = (struct gpio_irq_desc *) arg;
	gpio = (struct virtio_gpio *) desc->data;

	/* get pin state */
	memset(&data, 0, sizeof(data));
	err = read(desc->fd, &data, sizeof(data));
	if (err != sizeof(data)) {
		WPRINTF(("virtio gpio, gpio mevent read error %s, len %d\n",
				strerror(errno), err));
		return;
	}

	if (data.id == GPIOEVENT_EVENT_RISING_EDGE) {

		/* pin level is high */
		desc->level = 1;

		/* jitter protection */
		if ((desc->mode & IRQ_TYPE_EDGE_RISING)
				|| (desc->mode & IRQ_TYPE_LEVEL_HIGH)) {
			gpio_irq_generate_intr(gpio, desc->pin);
		}
	} else if (data.id == GPIOEVENT_EVENT_FALLING_EDGE) {

		/* pin level is low */
		desc->level = 0;

		/* jitter protection */
		if ((desc->mode & IRQ_TYPE_EDGE_FALLING)
				|| (desc->mode & IRQ_TYPE_LEVEL_LOW)) {
			gpio_irq_generate_intr(gpio, desc->pin);
		}
	} else
		WPRINTF(("virtio gpio, undefined GPIO event id %d\n", data.id));
}
