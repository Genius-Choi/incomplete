virtio_console_add_backend(struct virtio_console *console, char *opt)
{
	struct virtio_console_backend *be;
	int error = 0, fd = -1;
	bool is_console = false;
	char *backend = NULL;
	char *portname = NULL;
	char *portpath = NULL;
	char *socket_type = NULL;
	enum virtio_console_be_type be_type = VIRTIO_CONSOLE_BE_INVALID;

	backend = strsep(&opt, ":");
	if (backend == NULL) {
		WPRINTF(("vtcon: no backend is specified!\n"));
		error = -1;
		goto parse_fail;
	}

	if (backend[0] == '@') {
		is_console = true;
		backend++;
	} else
		is_console = false;

	be_type = virtio_console_get_be_type(backend);
	if (be_type == VIRTIO_CONSOLE_BE_INVALID) {
		WPRINTF(("vtcon: invalid backend %s!\n",
			backend));
		error = -1;
		goto parse_fail;
	}

	if (opt != NULL) {
		if (be_type == VIRTIO_CONSOLE_BE_SOCKET) {
			portname = strsep(&opt, "=");
			portpath = strsep(&opt, ":");
			socket_type = opt;
		} else {
			portname = strsep(&opt, "=");
			portpath = opt;
		}
		if (portname == NULL) {
			WPRINTF(("vtcon: portname missing \n"));
			error = -1;
			goto parse_fail;
		}
		if (portpath == NULL
			&& be_type != VIRTIO_CONSOLE_BE_STDIO
			&& be_type != VIRTIO_CONSOLE_BE_PTY
			&& be_type != VIRTIO_CONSOLE_BE_SOCKET) {
			WPRINTF(("vtcon: portpath missing for %s\n",
				portname));
			error = -1;
			goto parse_fail;
		}
	} else {
		WPRINTF(("vtcon: please at least config portname\n"));
		error = -1;
		goto parse_fail;
	}

	be = calloc(1, sizeof(struct virtio_console_backend));
	if (be == NULL) {
		error = -1;
		goto out;
	}

	fd = virtio_console_open_backend(portpath, be_type);
	if (fd < 0) {
		error = -1;
		goto out;
	}

	be->fd = fd;
	be->server_fd = fd;
	be->be_type = be_type;
	be->portpath = portpath;
	be->socket_type = socket_type;

	if (virtio_console_config_backend(be) < 0) {
		WPRINTF(("vtcon: virtio_console_config_backend failed\n"));
		error = -1;
		goto out;
	}

	be->port = virtio_console_add_port(console, portname,
		virtio_console_backend_write, be, is_console);
	if (be->port == NULL) {
		WPRINTF(("vtcon: virtio_console_add_port failed\n"));
		error = -1;
		goto out;
	}

	if (virtio_console_backend_can_read(be_type)) {
		if (be->be_type == VIRTIO_CONSOLE_BE_SOCKET && (be->socket_type == NULL
			|| !strcmp(be->socket_type,"server"))) {
			be->evp = mevent_add(fd, EVF_READ,
					virtio_console_accept_new_connection, be,
					virtio_console_teardown_backend, be);
			if (be->evp == NULL) {
				WPRINTF(("vtcon: mevent_add failed\n"));
				error = -1;
				goto out;
			}
			console->ref_count++;
		}
		else if (isatty(fd) || (be->be_type == VIRTIO_CONSOLE_BE_SOCKET
			&& !strcmp(be->socket_type,"client"))) {
			be->evp = mevent_add(fd, EVF_READ,
					virtio_console_backend_read, be,
					virtio_console_teardown_backend, be);
			if (be->evp == NULL) {
				WPRINTF(("vtcon: mevent_add failed\n"));
				error = -1;
				goto out;
			}
			console->ref_count++;
		}
	}

	virtio_console_open_port(be->port, true);
	be->open = true;

out:
	if (error != 0) {
		if (be) {
			if (be->port) {
				be->port->enabled = false;
				be->port->arg = NULL;
			}
			if (be->be_type == VIRTIO_CONSOLE_BE_PTY &&
				be->pts_fd > 0)
				close(be->pts_fd);
			free(be);
		}
		if (fd != -1 && fd != STDIN_FILENO)
			close(fd);
	}

parse_fail:
	return error;
}
