refcnt_get(const struct refcnt *ref)
{
	int new, val;

	do {
		val = atomic_read(ref);
		if (val == 0)
			return 0;

		new = val + 1;
		/* check for overflow */
		assert(new > 0);

	} while (!__sync_bool_compare_and_swap((int *)&ref->count, val, new));

	return new;
}
