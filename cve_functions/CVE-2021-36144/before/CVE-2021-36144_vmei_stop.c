vmei_stop(struct virtio_mei *vmei)
{
	vmei_set_status(vmei, VMEI_STST_DEINIT);
	pthread_mutex_lock(&vmei->tx_mutex);
	pthread_cond_signal(&vmei->tx_cond);
	pthread_mutex_unlock(&vmei->tx_mutex);

	pthread_mutex_lock(&vmei->rx_mutex);
	pthread_cond_signal(&vmei->rx_cond);
	pthread_mutex_unlock(&vmei->rx_mutex);

	vmei_virtual_fw_reset(vmei);

	pthread_join(vmei->rx_thread, NULL);
	pthread_join(vmei->tx_thread, NULL);

	vmei_free_me_clients(vmei);

	pthread_mutex_destroy(&vmei->rx_mutex);
	pthread_mutex_destroy(&vmei->tx_mutex);
	pthread_mutex_destroy(&vmei->list_mutex);

	return 0;
}
