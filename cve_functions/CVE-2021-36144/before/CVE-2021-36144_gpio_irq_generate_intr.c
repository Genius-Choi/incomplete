gpio_irq_generate_intr(struct virtio_gpio *gpio, int pin)
{
	struct gpio_irq_chip *chip;
	struct gpio_irq_desc *desc;

	chip = &gpio->irq_chip;
	desc = &chip->descs[pin];

	/* Ignore interrupt until it is unmasked */
	if (desc->mask)
		return;

	pthread_mutex_lock(&chip->intr_mtx);

	/* set it to pending mask */
	chip->intr_pending |= BIT(pin);

	/*
	 * if all interrupts in service are acknowledged, then send pending
	 * interrupts.
	 */
	if (!chip->intr_service) {
		chip->intr_service = chip->intr_pending;
		chip->intr_pending = 0;

		/* deliver interrupt */
		gpio_irq_deliver_intr(gpio, chip->intr_service);
	}
	pthread_mutex_unlock(&chip->intr_mtx);
}
