virtio_net_tap_setup(struct virtio_net *net, char *devname)
{
	char tbuf[IFNAMSIZ];
	int vhost_fd = -1;
	int rc;

	rc = snprintf(tbuf, IFNAMSIZ, "%s", devname);
	if (rc < 0 || rc >= IFNAMSIZ) /* give warning if error or truncation happens */
		WPRINTF(("Failed to set tap device name %s\n", tbuf));

	net->virtio_net_rx = virtio_net_tap_rx;
	net->virtio_net_tx = virtio_net_tap_tx;

	net->tapfd = virtio_net_tap_open(tbuf);
	if (net->tapfd == -1) {
		WPRINTF(("open of tap device %s failed\n", tbuf));
		return;
	}
	DPRINTF(("open of tap device %s success!\n", tbuf));

	/*
	 * Set non-blocking and register for read
	 * notifications with the event loop
	 */
	int opt = 1;

	if (ioctl(net->tapfd, FIONBIO, &opt) < 0) {
		WPRINTF(("tap device O_NONBLOCK failed\n"));
		close(net->tapfd);
		net->tapfd = -1;
	}

	if (net->use_vhost) {
		vhost_fd = open("/dev/vhost-net", O_RDWR);
		if (vhost_fd < 0)
			WPRINTF(("open of vhost-net failed\n"));
		else {
			net->vhost_net = vhost_net_init(&net->base, vhost_fd,
				net->tapfd, 0);
			if (!net->vhost_net) {
				WPRINTF(("vhost_net_init failed, fallback "
					"to userspace virtio\n"));
				close(vhost_fd);
				vhost_fd = -1;
			}
		}
	}

	if (vhost_fd < 0) {
		net->mevp = mevent_add(net->tapfd, EVF_READ,
				       virtio_net_rx_callback, net,
				       virtio_net_teardown, net);
		if (net->mevp == NULL) {
			WPRINTF(("Could not register event\n"));
			close(net->tapfd);
			net->tapfd = -1;
		}
	}
}
