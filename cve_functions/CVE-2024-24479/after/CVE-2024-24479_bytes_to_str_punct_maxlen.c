bytes_to_str_punct_maxlen(wmem_allocator_t *scope,
			const guint8 *src, size_t src_size,
			char punct, size_t max_bytes_len)
{
	char *buf;
	size_t max_char_size;
	char *buf_ptr;
	int truncated = 0;

	ws_return_str_if_null(scope, src);
	ws_return_str_if_zero(scope, src_size);

	if (!punct)
		return bytes_to_str_maxlen(scope, src, src_size, max_bytes_len);

	if (max_bytes_len == 0 || max_bytes_len > src_size) {
		max_bytes_len = src_size;
	}
	else if (max_bytes_len < src_size) {
		truncated = 1;
	}

	/* Include space for ellipsis and '\0'. Optional extra punct
	 * at the end is already accounted for. */
	max_char_size = max_bytes_len * 3 + strlen(UTF8_HORIZONTAL_ELLIPSIS) + 1;

	buf = wmem_alloc(scope, max_char_size);
	buf_ptr = bytes_to_hexstr_punct(buf, src, max_bytes_len, punct);

	if (truncated) {
		*buf_ptr++ = punct;
		buf_ptr = g_stpcpy(buf_ptr, UTF8_HORIZONTAL_ELLIPSIS);
	}

	*buf_ptr = '\0';
	return buf;
}
