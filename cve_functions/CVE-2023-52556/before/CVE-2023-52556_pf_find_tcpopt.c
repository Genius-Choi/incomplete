pf_find_tcpopt(u_int8_t *opt, u_int8_t *opts, size_t hlen, u_int8_t type,
    u_int8_t min_typelen)
{
	u_int8_t *eoh = opts + hlen;

	if (min_typelen < 2)
		return (NULL);

	while ((eoh - opt) >= min_typelen) {
		switch (*opt) {
		case TCPOPT_EOL:
			/* FALLTHROUGH - Workaround the failure of some
			   systems to NOP-pad their bzero'd option buffers,
			   producing spurious EOLs */
		case TCPOPT_NOP:
			opt++;
			continue;
		default:
			if (opt[0] == type &&
			    opt[1] >= min_typelen)
				return (opt);
		}

		opt += MAX(opt[1], 2); /* evade infinite loops */
	}

	return (NULL);
}
