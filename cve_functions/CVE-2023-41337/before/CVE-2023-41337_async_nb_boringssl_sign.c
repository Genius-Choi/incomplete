enum ssl_private_key_result_t async_nb_boringssl_sign(SSL *ssl, uint8_t *out, size_t *outlen, size_t max_out,
                                                      uint16_t signature_algorithm, const uint8_t *in, size_t len)
{
    if (h2o_socket_boringssl_async_resumption_in_flight(ssl))
        return ssl_private_key_failure;

    EVP_PKEY *key = SSL_get_privatekey(ssl);
    const EVP_MD *md = SSL_get_signature_algorithm_digest(signature_algorithm);
    int rsa_pss = SSL_is_signature_algorithm_rsa_pss(signature_algorithm);

    struct async_nb_job_t *job = async_nb_job_new();
    neverbleed_start_digestsign(&job->buf, key, md, in, len, rsa_pss);
    SSL_set_ex_data(ssl, h2o_socket_boringssl_get_async_job_index(), job);
    async_nb_job_submit(job);

    return ssl_private_key_retry;
}
