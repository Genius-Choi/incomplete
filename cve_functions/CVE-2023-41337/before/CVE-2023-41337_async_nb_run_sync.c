static void async_nb_run_sync(neverbleed_iobuf_t *buf, void (*transaction_cb)(neverbleed_t *, neverbleed_iobuf_t *))
{
    int fd = neverbleed_get_fd(neverbleed);
    int flags = fcntl(fd, F_GETFL, 0);

    // set fd to blocking for synchronous I/O
    if (fcntl(fd, F_SETFL, flags & ~O_NONBLOCK) == -1) {
        perror("fcntl");
        abort();
    }

    transaction_cb(neverbleed, buf);

    // set fd back to original
    if (fcntl(fd, F_SETFL, flags) == -1) {
        perror("fcntl");
        abort();
    }
}
