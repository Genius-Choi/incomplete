c_ares_set_dns_servers(void)
{
    if ((!async_dns_initialized) || (!use_custom_dns_server_list))
        return;

    if (ndnsservers == 0) {
        //clear the list of servers.  This may effectively disable name resolution
        ares_set_servers_ports(ghba_chan, NULL);
        ares_set_servers_ports(ghbn_chan, NULL);
    } else {
        struct ares_addr_port_node* servers = wmem_alloc_array(NULL, struct ares_addr_port_node, ndnsservers);
        ws_in4_addr ipv4addr;
        ws_in6_addr ipv6addr;
        gboolean invalid_IP_found = FALSE;
        struct ares_addr_port_node* server;
        guint i;
        for (i = 0, server = servers; i < ndnsservers-1; i++, server++) {
            if (ws_inet_pton6(dnsserverlist_uats[i].ipaddr, &ipv6addr)) {
                server->family = AF_INET6;
                memcpy(&server->addr.addr6, &ipv6addr, 16);
            } else if (ws_inet_pton4(dnsserverlist_uats[i].ipaddr, &ipv4addr)) {
                server->family = AF_INET;
                memcpy(&server->addr.addr4, &ipv4addr, 4);
            } else {
                //This shouldn't happen, but just in case...
                invalid_IP_found = TRUE;
                server->family = 0;
                memset(&server->addr.addr4, 0, 4);
                break;
            }

            server->udp_port = (int)dnsserverlist_uats[i].udp_port;
            server->tcp_port = (int)dnsserverlist_uats[i].tcp_port;

            server->next = (server+1);
        }
        if (!invalid_IP_found) {
            if (ws_inet_pton6(dnsserverlist_uats[i].ipaddr, &ipv6addr)) {
                server->family = AF_INET6;
                memcpy(&server->addr.addr6, &ipv6addr, 16);
            }
            else if (ws_inet_pton4(dnsserverlist_uats[i].ipaddr, &ipv4addr)) {
                server->family = AF_INET;
                memcpy(&server->addr.addr4, &ipv4addr, 4);
            } else {
                //This shouldn't happen, but just in case...
                server->family = 0;
                memset(&server->addr.addr4, 0, 4);
            }
        }
        server->udp_port = (int)dnsserverlist_uats[i].udp_port;
        server->tcp_port = (int)dnsserverlist_uats[i].tcp_port;

        server->next = NULL;

        ares_set_servers_ports(ghba_chan, servers);
        ares_set_servers_ports(ghbn_chan, servers);
        wmem_free(NULL, servers);
    }
}
