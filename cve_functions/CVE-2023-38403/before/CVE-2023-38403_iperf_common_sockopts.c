iperf_common_sockopts(struct iperf_test *test, int s)
{
    int opt;

    /* Set IP TOS */
    if ((opt = test->settings->tos)) {
	if (getsockdomain(s) == AF_INET6) {
#ifdef IPV6_TCLASS
	    if (setsockopt(s, IPPROTO_IPV6, IPV6_TCLASS, &opt, sizeof(opt)) < 0) {
                i_errno = IESETCOS;
                return -1;
            }

	    /* if the control connection was established with a mapped v4 address
	       then set IP_TOS on v6 stream socket as well */
	    if (iperf_get_mapped_v4(test)) {
		if (setsockopt(s, IPPROTO_IP, IP_TOS, &opt, sizeof(opt)) < 0) {
                    /* ignore any failure of v4 TOS in IPv6 case */
                }
            }
#else
            i_errno = IESETCOS;
            return -1;
#endif
        } else {
            if (setsockopt(s, IPPROTO_IP, IP_TOS, &opt, sizeof(opt)) < 0) {
                i_errno = IESETTOS;
                return -1;
            }
        }
    }
    return 0;
}
