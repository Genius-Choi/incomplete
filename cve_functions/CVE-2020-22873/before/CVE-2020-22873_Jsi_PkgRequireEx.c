Jsi_Number Jsi_PkgRequireEx(Jsi_Interp *interp, const char *name, Jsi_Number version, Jsi_PkgOpts **poptsPtr)
{
    jsi_PkgInfo *ptr = jsi_PkgGet(interp, name), *ptr2 = NULL;
    if (ptr) {
        if (version)
            ptr->lastReq = version;
        if (ptr->initProc && ptr->needInit) {
            if ((*ptr->initProc)(interp, 0) != JSI_OK) 
                return -1;
            ptr->needInit = 0;
        }
            if (poptsPtr)
                *poptsPtr = &ptr->popts;
        return ptr->version;
    } else if ((ptr2 = jsi_PkgGet(interp->topInterp, name)) && ptr2->initProc) {
        // C-extensions load from topInterp
        if (interp->debugOpts.pkgTrace)
            Jsi_Printf(interp, jsi_Stderr , "Package-Trace: load from topLevel: %s\n", name);
        ptr = (jsi_PkgInfo*)Jsi_Calloc(1, sizeof(*ptr));
        *ptr = *ptr2;
        if (ptr->loadFile)
            ptr->loadFile = Jsi_KeyAdd(interp->topInterp, ptr->loadFile);
        ptr->needInit = 1;
        Jsi_HashSet(interp->packageHash, name, ptr);
        if ((*ptr2->initProc)(interp, 0) == JSI_OK && (ptr = jsi_PkgGet(interp, name))) {
            ptr->needInit = 0;
            return ptr->version;
            if (poptsPtr)
                *poptsPtr = &ptr->popts;
        }
    }
    if (interp->pkgReqDepth>interp->maxIncDepth) {
        Jsi_LogError("recursive require('%s')", name);
        return -1;
    }
    
    interp->pkgReqDepth++;
    version = jsi_VersionNormalize(version, NULL, 0);
    if (jsi_PkgLoad(interp, name, version) != JSI_OK) {
        Jsi_LogError("failed require('%s')", name);
        interp->pkgReqDepth--;
        return -1;
    }
    interp->pkgReqDepth--;
    ptr = jsi_PkgGet(interp, name);
    if (!ptr) {
        Jsi_LogError("package not found for require('%s')", name);
        return -1;
    }
    if (poptsPtr)
        *poptsPtr = &ptr->popts;
    return ptr->version;
}
