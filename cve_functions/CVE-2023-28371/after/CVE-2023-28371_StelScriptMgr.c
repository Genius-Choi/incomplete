StelScriptMgr::StelScriptMgr(QObject *parent): QObject(parent)
{
	waitEventLoop = new QEventLoop();
#ifdef ENABLE_SCRIPT_QML
	engine = new QJSEngine(this);
	engine->installExtensions(QJSEngine::ConsoleExtension); // TBD: Maybe remove as unnecessary for us?
#else
	engine = new QScriptEngine(this);
	// This is enough for a simple Array access for a QVector<int> input or return type (e.g. Calendars plugin)
	qScriptRegisterSequenceMetaType<QVector<int>>(engine); // no longer needed with QJSEngine!
#endif
	connect(&StelApp::getInstance(), SIGNAL(aboutToQuit()), this, SLOT(stopScript()), Qt::DirectConnection);

	// Scripting images
	ScreenImageMgr* scriptImages = new ScreenImageMgr();
	scriptImages->init();
	StelApp::getInstance().getModuleMgr().registerModule(scriptImages);

	defVecClasses(engine); // Install handling of Vec3d[deprecated]/Vec3f[deprecated]/V3d/V3f/Color classes

	// Add the core object to access methods related to core
	mainAPI = new StelMainScriptAPI(this);
#ifdef ENABLE_SCRIPT_QML
	QJSValue objectValue = engine->newQObject(mainAPI);
	mainAPI->setEngine(engine);
#else
	QScriptValue objectValue = engine->newQObject(mainAPI);
#endif
	engine->globalObject().setProperty("core", objectValue);

	// Add other classes which we want to be directly accessible from scripts
	if(StelSkyLayerMgr* smgr = GETSTELMODULE(StelSkyLayerMgr))
		objectValue = engine->newQObject(smgr);

	// For accessing star scale, twinkle etc.
	objectValue = engine->newQObject(StelApp::getInstance().getCore()->getSkyDrawer());
	engine->globalObject().setProperty("StelSkyDrawer", objectValue);

	setScriptRate(1.0);

#ifndef ENABLE_SCRIPT_QML
	engine->setProcessEventsInterval(1); // was 10, let's allow a smoother script execution

	agent = new StelScriptEngineAgent(engine);
	engine->setAgent(agent);
#endif
	initActions();
}
