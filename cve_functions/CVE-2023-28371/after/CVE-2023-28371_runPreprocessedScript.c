bool StelScriptMgr::runPreprocessedScript(const QString &preprocessedScript, const QString& scriptId)
{
#ifdef ENABLE_SCRIPT_QML
	if (!mutex.tryLock())
#else
	if (engine->isEvaluating())
#endif
	{
		QString msg = QString("ERROR: there is already a script running, please wait until it's over.");
		emit scriptDebug(msg);
		qWarning() << msg;
		return false;
	}

	// Make sure that the gui objects have been completely initialized (there used to be problems with startup scripts).
	Q_ASSERT(StelApp::getInstance().getGui());

	engine->globalObject().setProperty("scriptRateReadOnly", 1.0);

	scriptFileName = scriptId;

	// Notify that the script starts here
	emit scriptRunning();
	emit runningScriptIdChanged(scriptId);

#ifdef ENABLE_SCRIPT_QML
	engine->setInterrupted(false);
	//QStringList stackTrace;
	//result=engine->evaluate(preprocessedScript, QString(), 1, &stackTrace);
	result=engine->evaluate(preprocessedScript, QString(), 1);
	scriptEnded();
#else
	// run that script in a new context
	QScriptContext *context = engine->pushContext();
	engine->evaluate(preprocessedScript);
	engine->popContext();
	scriptEnded();
	Q_UNUSED(context)
#endif
	return true;
}
