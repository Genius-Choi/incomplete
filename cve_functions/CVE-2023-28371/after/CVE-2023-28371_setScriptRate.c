void StelScriptMgr::setScriptRate(double r)
{
	//qDebug() << "StelScriptMgr::setScriptRate(" << r << ")";
#ifdef ENABLE_SCRIPT_QML
	if (mutex.tryLock())
	{
		engine->globalObject().setProperty("scriptRateReadOnly", r);
		mutex.unlock();
		return;
	}
#else
	if (!engine->isEvaluating())
	{
		engine->globalObject().setProperty("scriptRateReadOnly", r);
		return;
	}
#endif
	qreal currentScriptRate = engine->globalObject().property("scriptRateReadOnly").toNumber();
	
	// pre-calculate the new time rate in an effort to prevent there being much latency
	// between setting the script rate and the time rate.
	qreal factor = r / currentScriptRate;
	
	StelCore* core = StelApp::getInstance().getCore();
	core->setTimeRate(core->getTimeRate() * factor);
	
	GETSTELMODULE(StelMovementMgr)->setMovementSpeedFactor(static_cast<float>(core->getTimeRate()));
	engine->globalObject().setProperty("scriptRateReadOnly", r);
}
