void ds_check_timer(unsigned int ticks, void* param)
{
	ds_partition_t *partition;
	dlg_t *dlg;
	ds_set_p list;
	int_str val;
	int j;
	int nodes_no, node_idx=-1;
	unsigned int h;

	if ( !( ds_cluster_id<=0
	|| (ds_cluster_prob_mode == DS_CLUSTER_PROB_MODE_ALL)
	|| (ds_cluster_prob_mode == DS_CLUSTER_PROB_MODE_DISTRIBUTED &&
		(node_idx=ds_cluster_get_my_index(&nodes_no))>=0 )
	|| (ds_cluster_prob_mode == DS_CLUSTER_PROB_MODE_SHTAG &&
		ds_cluster_shtag_is_active())
	) )
		return;

	for (partition = partitions; partition; partition = partition->next){
		/* Check for the list. */
		if ( (*partition->data)->sets==NULL )
			continue;

		/* access ds data under reader's lock */
		lock_start_read( partition->lock );

		/* Iterate over the groups and the entries of each group: */
		for( list=(*partition->data)->sets ; list!= NULL ; list= list->next)
		{
			for(j=0; j<list->nr; j++)
			{
				/* If list is probed by this proxy and the Flag of
				 * the entry has "Probing" set, send a probe: */
				if ( (!ds_probing_list || in_int_list(ds_probing_list, list->id)==0) &&
				((list->dlist[j].flags&DS_INACTIVE_DST)==0) &&
				(ds_probing_mode==1 || (list->dlist[j].flags&DS_PROBING_DST)!=0
				))
				{
					/* stage 2 of checking, clustering level */
					if (node_idx>=0) {
						h=core_hash( &list->dlist[j].uri, NULL, 0);
						if ( (h % nodes_no) != node_idx)
							continue;
					}

					LM_DBG("probing set #%d, URI %.*s\n", list->id,
							list->dlist[j].uri.len, list->dlist[j].uri.s);

					/* Execute the Dialog using the "request"-Method of the
					 * TM-Module.*/
					if (tmb.new_auto_dlg_uac(&ds_ping_from,
					&list->dlist[j].uri, NULL, NULL,
					list->dlist[j].sock?list->dlist[j].sock:probing_sock,
					&dlg) != 0 ) {
						LM_ERR("failed to create new TM dlg\n");
						continue;
					}
					dlg->state = DLG_CONFIRMED;

					if (ds_ping_maxfwd>=0) {
						dlg->mf_enforced = 1;
						dlg->mf_value = (unsigned short)ds_ping_maxfwd;
					}

					ds_options_callback_param_t *cb_param =
								shm_malloc(sizeof(*cb_param));

					if (cb_param == NULL) {
						LM_CRIT("No more shared memory\n");
						continue;
					}

					if (partition->attrs_avp_name>=0) {
						val.s = list->dlist[j].attrs;
						dlg->avps = new_avp(
							AVP_VAL_STR|partition->attrs_avp_type,
							partition->attrs_avp_name, val);
						// we do not care if the adding failed, there will
						// be no attr AVP exposed in local route
						if (dlg->avps)
							dlg->avps->next = NULL;
					}

					cb_param->partition = partition;
					cb_param->set_id = list->id;
					if (tmb.t_request_within(&ds_ping_method,
							NULL,
							NULL,
							dlg,
							ds_options_callback,
							(void*)cb_param,
							osips_shm_free) < 0) {
						LM_ERR("unable to execute dialog\n");
						shm_free(cb_param);
					}
					tmb.free_dlg(dlg);
				}
			}
		}

		lock_stop_read( partition->lock );
	}
}
