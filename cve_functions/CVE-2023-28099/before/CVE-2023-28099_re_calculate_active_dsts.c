static inline void re_calculate_active_dsts(ds_set_p sp)
{
	int j,i;
	ds_dest_p dst;
	int oldw;

	/* pre-calculate the running weights for each destination */
	for( j=0,i=-1,sp->active_nr=sp->nr ; j<sp->nr ; j++ ) {
		dst = &sp->dlist[j];
		if (dst->fs_sock && dst->fs_sock->stats.valid) {
			lock_start_read(dst->fs_sock->stats_lk);

			oldw = dst->weight;
			dst->weight = round(max_freeswitch_weight *
			(1 - dst->fs_sock->stats.sess /
			     (double)dst->fs_sock->stats.max_sess) *
			(dst->fs_sock->stats.id_cpu / (double)100));

			LM_DBG("weight update for %.*s: %d -> %d (%d %d %.3f)\n",
			       dst->uri.len, dst->uri.s, oldw, dst->weight,
				   dst->fs_sock->stats.sess, dst->fs_sock->stats.max_sess,
				   dst->fs_sock->stats.id_cpu);

			lock_stop_read(dst->fs_sock->stats_lk);
		}

		/* running weight is the current weight plus the running weight of
		 * the previous element */
		dst->running_weight = dst->weight
			+ ((j==0) ? 0 : sp->dlist[j-1].running_weight);
		/* now the running weight for the active destinations */
		if ( dst_is_active(*dst)) {
			dst->active_running_weight = dst->weight
				+ ((i==-1) ? 0 : sp->dlist[i].active_running_weight);
			i = j; /* last active destination */
		} else {
			dst->active_running_weight =
				((i==-1) ? 0 : sp->dlist[i].active_running_weight);
			sp->active_nr --;
		}
		LM_DBG("destination i=%d, j=%d, weight=%d, sum=%d, active_sum=%d\n",
			i,j, dst->weight, dst->running_weight, dst->active_running_weight);
	}
}
