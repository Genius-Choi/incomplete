int ds_route_algo(struct sip_msg *msg, ds_set_p set, 
		ds_dest_p **sorted_set,	int ds_use_default)
{
	int i, j, k, end_idx, cnt, rt_idx, fret;
	ds_dest_p *sset;

	if (!set) {
		LM_ERR("invalid set\n");
		return -1;
	}

	if ((rt_idx = get_script_route_ID_by_name(algo_route_param.s,
	sroutes->request, RT_NO)) == -1) {
		LM_ERR("Invalid route parameter \n");
		return -1;
	}

	sset = shm_realloc(*sorted_set, set->nr * sizeof(ds_dest_p));
	if (!sset) {
		LM_ERR("no more shm memory\n");
		return -1;
	}
	*sorted_set = sset;

	end_idx = set->nr - 1;
	if (ds_use_default) {
		sset[end_idx] = &set->dlist[end_idx];
		end_idx--;
	}

	for (i = 0, cnt = 0; i < set->nr - (ds_use_default?1:0); i++) {
		if ( !dst_is_active(set->dlist[i]) ) {
			/* move to the end of the list */
			sset[end_idx--] = &set->dlist[i];
			continue;
		}

		fret = run_route_algo(msg, rt_idx, &set->dlist[i]);
		set->dlist[i].route_algo_value = fret;

		/* search the proper position */
		j = 0;
		for (; j < cnt && sset[j]->route_algo_value <= fret; j++);
		/* make space for the new entry */
		for (k = cnt; k > j; k--)
			sset[k] = sset[k - 1];
		sset[j] = &set->dlist[i];
		cnt++;
	}

	return cnt;
}
