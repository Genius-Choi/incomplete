int ds_print_mi_list(mi_item_t *part_item, ds_partition_t *partition, int full)
{
	int len, i, j;
	char* p;
	ds_set_p list;
	mi_item_t *sets_arr, *set_item, *dests_arr, *dest_item, *addr_arr;

	if ( (*partition->data)->sets==NULL ) {
		LM_DBG("empty destination sets\n");
		return  0;
	}

	sets_arr = add_mi_array(part_item, MI_SSTR("SETS"));
	if (!sets_arr)
		return -1;

	/* access ds data under reader's lock */
	lock_start_read( partition->lock );

	for(list = (*partition->data)->sets ; list!= NULL; list= list->next) {
		set_item = add_mi_object(sets_arr, NULL, 0);
		if (!set_item)
			goto error;

		if (add_mi_number(set_item, MI_SSTR("id"), list->id) < 0)
			goto error;

		dests_arr = add_mi_array(set_item, MI_SSTR("Destinations"));
		if (!dests_arr)
			return -1;

		for(j=0; j<list->nr; j++)
		{
			dest_item = add_mi_object(dests_arr, NULL, 0);
			if (!dest_item)
				goto error;

			if (add_mi_string(dest_item, MI_SSTR("URI"),
				list->dlist[j].uri.s, list->dlist[j].uri.len) < 0)
				goto error;

			if (list->dlist[j].flags & DS_INACTIVE_DST) {
				if (add_mi_string(dest_item, MI_SSTR("state"),
					MI_SSTR("Inactive")) < 0)
					goto error;
			} else if (list->dlist[j].flags & DS_PROBING_DST) {
				if (add_mi_string(dest_item, MI_SSTR("state"),
					MI_SSTR("Probing")) < 0)
					goto error;
			} else
				if (add_mi_string(dest_item, MI_SSTR("state"),
					MI_SSTR("Active")) < 0)
					goto error;

			if (add_mi_number(dest_item, MI_SSTR("first_hit_counter"),
				list->dlist[j].chosen_count) < 0)
				goto error;

			if (list->dlist[j].sock)
			{
				p = socket2str(list->dlist[j].sock, NULL, &len, 0);
				if (p)
					if (add_mi_string(dest_item, MI_SSTR("socket"), p, len) < 0)
						goto error;
			}

			if (list->dlist[j].attrs.s)
				if (add_mi_string(dest_item, MI_SSTR("attr"),
					list->dlist[j].attrs.s, list->dlist[j].attrs.len) < 0)
					goto error;

			if (list->dlist[j].script_attrs.s)
				if (add_mi_string(dest_item, MI_SSTR("script_attr"),
					list->dlist[j].script_attrs.s, list->dlist[j].script_attrs.len) < 0)
					goto error;

			if (full) {
				if (add_mi_number(dest_item, MI_SSTR("weight"),
					list->dlist[j].weight) < 0)
					goto error;

				if (add_mi_number(dest_item, MI_SSTR("priority"),
					list->dlist[j].priority) < 0)
					goto error;

				if (list->dlist[j].description.len)
					if (add_mi_string(dest_item, MI_SSTR("description"),
						list->dlist[j].description.s,
						list->dlist[j].description.len) < 0)
						goto error;
			}

			addr_arr = add_mi_array(dest_item, MI_SSTR("resolved_addresses"));
			if (!addr_arr)
				goto error;

			for (i = 0; i < list->dlist[j].ips_cnt; i++) {
				if (add_mi_string_fmt(addr_arr, NULL, 0, "%s:%d",
				        ip_addr2a(&list->dlist[j].ips[i]),
				        list->dlist[j].ports[i]) != 0)
				    goto error;
			}
		}
	}

	lock_stop_read( partition->lock );
	return 0;

error:
	lock_stop_read( partition->lock );
	return -1;
}
