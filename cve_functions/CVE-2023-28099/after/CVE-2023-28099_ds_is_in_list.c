int ds_is_in_list(struct sip_msg *_m, str *_ip, int port, int set,
                  ds_partition_t *partition, int active_only, str *pattern_s)
{
	pv_value_t val;
	ds_set_p list;
	struct ip_addr *ip;
	int_str avp_val;
	int j,k;
	char *pattern = NULL;

	if (!(ip = str2ip(_ip)) && !(ip = str2ip6(_ip))) {
		LM_ERR("IP val is not IP <%.*s>\n", _ip->len, _ip->s);
		return -1;
	}

	if (pattern_s) {
		pattern = pkg_malloc(pattern_s->len + 1);
		if (!pattern) {
			LM_ERR("oom for pattern!\n");
			return -1;
		}
		memcpy(pattern, pattern_s->s, pattern_s->len);
		pattern[pattern_s->len] = '\0';
	}

	memset(&val, 0, sizeof(pv_value_t));
	val.flags = PV_VAL_INT|PV_TYPE_INT;

	/* access ds data under reader's lock */
	lock_start_read( partition->lock );

	for(list = (*partition->data)->sets ; list!= NULL; list= list->next) {
		if ((set == -1) || (set == list->id)) {
			/* interate through all elements/destinations in the list */
			for(j=0; j<list->nr; j++) {
				/* interate through all IPs of each destination */
				for(k=0 ; k<list->dlist[j].ips_cnt ; k++ ) {
					if ( (list->dlist[j].ports[k]==0 || port==0
					|| port==list->dlist[j].ports[k]) &&
					ip_addr_cmp( ip, &list->dlist[j].ips[k]) ) {
						/* matching destination */
						if (active_only && !dst_is_active(list->dlist[j]) )
							continue;
						/* matching pattern - already null terminated :D */
						if (pattern) {
							if (!list->dlist[j].attrs.s)
								continue;
							if (fnmatch(pattern, list->dlist[j].attrs.s, FNM_PERIOD) != 0)
								continue;
						}
						if(set==-1 && ds_setid_pvname.s!=0) {
							val.ri = list->id;
							if(pv_set_value(_m, &ds_setid_pv,
									(int)EQ_T, &val)<0)
							{
								LM_ERR("setting PV failed\n");
								goto error;
							}
						}
						if (partition->attrs_avp_name>= 0) {
							avp_val.s = list->dlist[j].attrs;
							if(add_avp(AVP_VAL_STR|partition->attrs_avp_type,
										partition->attrs_avp_name,avp_val)!=0)
								goto error;
						}

						if (partition->script_attrs_avp_name>= 0) {
							avp_val.s = list->dlist[j].script_attrs;
							if(add_avp(AVP_VAL_STR|partition->script_attrs_avp_type,
										partition->script_attrs_avp_name,avp_val)!=0)
								goto error;
						}

						lock_stop_read( partition->lock );
						if (pattern)
							pkg_free(pattern);
						return 1;
					}
				}
			}
		}
	}

error:
	lock_stop_read( partition->lock );
	if (pattern)
		pkg_free(pattern);
	return -1;
}
