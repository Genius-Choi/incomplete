njs_promise_all_settled_element_functions(njs_vm_t *vm,
    njs_value_t *args, njs_uint_t nargs, njs_index_t rejected)
{
    njs_int_t                  ret;
    njs_value_t                arguments, *value;
    njs_object_t               *obj;
    const njs_value_t          *status, *set;
    njs_promise_all_context_t  *context;

    static const njs_value_t  string_status = njs_string("status");
    static const njs_value_t  string_fulfilled = njs_string("fulfilled");
    static const njs_value_t  string_value = njs_string("value");
    static const njs_value_t  string_rejected = njs_string("rejected");
    static const njs_value_t  string_reason = njs_string("reason");

    context = vm->top_frame->function->context;

    if (context->already_called) {
        njs_vm_retval_set(vm, &njs_value_undefined);
        return NJS_OK;
    }

    context->already_called = 1;

    obj = njs_object_alloc(vm);
    if (njs_slow_path(obj == NULL)) {
        return NJS_ERROR;
    }

    value = &context->values->start[context->index];

    njs_set_object(value, obj);

    if (rejected) {
        status = &string_rejected;
        set = &string_reason;

    } else {
        status = &string_fulfilled;
        set = &string_value;
    }

    ret = njs_value_property_set(vm, value, njs_value_arg(&string_status),
                                 njs_value_arg(status));
    if (njs_slow_path(ret == NJS_ERROR)) {
        return ret;
    }

    ret = njs_value_property_set(vm, value, njs_value_arg(set),
                                 njs_arg(args, nargs, 1));
    if (njs_slow_path(ret == NJS_ERROR)) {
        return ret;
    }

    if (--(*context->remaining_elements) == 0) {
        njs_mp_free(vm->mem_pool, context->remaining_elements);

        njs_set_array(&arguments, context->values);

        return njs_function_call(vm,
                                 njs_function(&context->capability->resolve),
                                 &njs_value_undefined, &arguments, 1,
                                 &vm->retval);
    }

    njs_vm_retval_set(vm, &njs_value_undefined);

    return NJS_OK;
}
