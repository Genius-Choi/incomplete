upper_layer_chksum(uint8_t proto)
{
/* gcc 4.4.0 - 4.6.1 (maybe 4.3...) with -Os on 8 bit CPUS incorrectly compiles:
 * int bar (int);
 * int foo (unsigned char a, unsigned char b) {
 *   int len = (a << 8) + b; //len becomes 0xff00&<random>+b
 *   return len + bar (len);
 * }
 * upper_layer_len triggers this bug unless it is declared volatile.
 * See https://sourceforge.net/apps/mantisbt/contiki/view.php?id=3
 */
  volatile uint16_t upper_layer_len;
  uint16_t sum;

  upper_layer_len = uipbuf_get_len_field(UIP_IP_BUF) - uip_ext_len;

  LOG_DBG("Upper layer checksum len: %d from: %d\n", upper_layer_len,
         (int)(UIP_IP_PAYLOAD(uip_ext_len) - uip_buf));

  /* First sum pseudoheader. */
  /* IP protocol and length fields. This addition cannot carry. */
  sum = upper_layer_len + proto;
  /* Sum IP source and destination addresses. */
  sum = chksum(sum, (uint8_t *)&UIP_IP_BUF->srcipaddr, 2 * sizeof(uip_ipaddr_t));

  /* Sum upper-layer header and data. */
  sum = chksum(sum, UIP_IP_PAYLOAD(uip_ext_len), upper_layer_len);

  return (sum == 0) ? 0xffff : uip_htons(sum);
}
