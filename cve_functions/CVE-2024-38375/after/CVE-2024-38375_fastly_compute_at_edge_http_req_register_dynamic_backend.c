bool fastly_compute_at_edge_http_req_register_dynamic_backend(
    fastly_world_string_t *prefix, fastly_world_string_t *target,
    fastly_compute_at_edge_http_types_dynamic_backend_config_t *config,
    fastly_compute_at_edge_types_error_t *err) {
  uint32_t backend_config_mask = 0;

  if (config->use_ssl.is_some && config->use_ssl.val) {
    backend_config_mask |= BACKEND_CONFIG_USE_SSL;
  }
  if (config->dont_pool.is_some && config->dont_pool.val) {
    backend_config_mask |= BACKEND_CONFIG_DONT_POOL;
  }
  if (config->host_override.is_some) {
    backend_config_mask |= BACKEND_CONFIG_HOST_OVERRIDE;
  }
  if (config->connect_timeout.is_some) {
    backend_config_mask |= BACKEND_CONFIG_CONNECT_TIMEOUT;
  }
  if (config->first_byte_timeout.is_some) {
    backend_config_mask |= BACKEND_CONFIG_FIRST_BYTE_TIMEOUT;
  }
  if (config->between_bytes_timeout.is_some) {
    backend_config_mask |= BACKEND_CONFIG_BETWEEN_BYTES_TIMEOUT;
  }
  if (config->ssl_min_version.is_some) {
    backend_config_mask |= BACKEND_CONFIG_SSL_MIN_VERSION;
  }
  if (config->ssl_max_version.is_some) {
    backend_config_mask |= BACKEND_CONFIG_SSL_MAX_VERSION;
  }
  if (config->cert_hostname.is_some) {
    backend_config_mask |= BACKEND_CONFIG_CERT_HOSTNAME;
  }
  if (config->ca_cert.is_some) {
    backend_config_mask |= BACKEND_CONFIG_CA_CERT;
  }
  if (config->ciphers.is_some) {
    backend_config_mask |= BACKEND_CONFIG_CIPHERS;
  }
  if (config->sni_hostname.is_some) {
    backend_config_mask |= BACKEND_CONFIG_SNI_HOSTNAME;
  }
  if (config->client_cert.is_some) {
    backend_config_mask |= BACKEND_CONFIG_CLIENT_CERT;
  }
  fastly::DynamicBackendConfig backend_configuration{
      .host_override = reinterpret_cast<char *>(config->host_override.val.ptr),
      .host_override_len = config->host_override.val.len,
      .connect_timeout_ms = config->connect_timeout.val,
      .first_byte_timeout_ms = config->first_byte_timeout.val,
      .between_bytes_timeout_ms = config->between_bytes_timeout.val,
      .ssl_min_version = config->ssl_min_version.val,
      .ssl_max_version = config->ssl_max_version.val,
      .cert_hostname = reinterpret_cast<char *>(config->cert_hostname.val.ptr),
      .cert_hostname_len = config->cert_hostname.val.len,
      .ca_cert = reinterpret_cast<char *>(config->ca_cert.val.ptr),
      .ca_cert_len = config->ca_cert.val.len,
      .ciphers = reinterpret_cast<char *>(config->ciphers.val.ptr),
      .ciphers_len = config->ciphers.val.len,
      .sni_hostname = reinterpret_cast<char *>(config->sni_hostname.val.ptr),
      .sni_hostname_len = config->sni_hostname.val.len,
      .client_certificate = reinterpret_cast<char *>(config->client_cert.val.client_cert.ptr),
      .client_certificate_len = config->client_cert.val.client_cert.len,
      .client_key = config->client_cert.val.client_key};
  return convert_result(
      fastly::req_register_dynamic_backend(reinterpret_cast<char *>(prefix->ptr), prefix->len,
                                           reinterpret_cast<char *>(target->ptr), target->len,
                                           backend_config_mask, &backend_configuration),
      err);
}
