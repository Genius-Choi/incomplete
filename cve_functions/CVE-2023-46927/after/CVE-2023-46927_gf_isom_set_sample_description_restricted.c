GF_Err gf_isom_set_sample_description_restricted(GF_ISOFile *movie, u32 trackNumber, u32 sampleDescIndex, u32 scheme_type)
{
	u32 type;
	GF_SampleEntryBox *ent;
	GF_TrackBox *trak;

	trak = gf_isom_get_track_from_file(movie, trackNumber);
	if (!trak || !trak->Media) return GF_BAD_PARAM;
	ent = gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, sampleDescIndex-1);
	if (!ent) return GF_BAD_PARAM;
	type = ent->type;

	u32 original_format = type;
	u32 gnr_type=0;
	if (original_format==GF_ISOM_BOX_TYPE_GNRA) {
		gnr_type = original_format;
		type = ((GF_GenericAudioSampleEntryBox*)ent)->EntryType;
	} else if (original_format==GF_ISOM_BOX_TYPE_GNRV) {
		gnr_type = original_format;
		type = ((GF_GenericVisualSampleEntryBox*)ent)->EntryType;
	} else if (original_format==GF_ISOM_BOX_TYPE_GNRM) {
		gnr_type = original_format;
		type = ((GF_GenericSampleEntryBox*)ent)->EntryType;
	}

	switch (type) {
	case GF_ISOM_BOX_TYPE_RESV:
	case GF_ISOM_BOX_TYPE_RESA:
	case GF_ISOM_BOX_TYPE_RESM:
	case GF_ISOM_BOX_TYPE_REST:
	case GF_ISOM_BOX_TYPE_RESU:
	case GF_ISOM_BOX_TYPE_RESS:
	case GF_ISOM_BOX_TYPE_RESF:
	case GF_ISOM_BOX_TYPE_RESP:
	case GF_ISOM_BOX_TYPE_RES3:
		return GF_OK;
	case GF_ISOM_BOX_TYPE_STXT:
		type = GF_ISOM_BOX_TYPE_REST;
		break;
	case GF_ISOM_BOX_TYPE_STPP:
		type = GF_ISOM_BOX_TYPE_RESU;
		break;
	case GF_ISOM_BOX_TYPE_METX:
	case GF_ISOM_BOX_TYPE_METT:
	case GF_ISOM_BOX_TYPE_URIM:
	case GF_ISOM_BOX_TYPE_MEBX:
		type = GF_ISOM_BOX_TYPE_RESM;
		break;
	default:
		type=0;
		switch (trak->Media->handler->handlerType) {
		case GF_ISOM_MEDIA_VISUAL:
		case GF_ISOM_MEDIA_AUXV:
		case GF_ISOM_MEDIA_PICT:
			type = GF_ISOM_BOX_TYPE_RESV;
			break;
		case GF_ISOM_MEDIA_AUDIO:
			type = GF_ISOM_BOX_TYPE_RESA;
			break;
		case GF_ISOM_MEDIA_OD:
		case GF_ISOM_MEDIA_OCR:
		case GF_ISOM_MEDIA_SCENE:
		case GF_ISOM_MEDIA_MPEG7:
		case GF_ISOM_MEDIA_OCI:
		case GF_ISOM_MEDIA_IPMP:
		case GF_ISOM_MEDIA_MPEGJ:
			type = GF_ISOM_BOX_TYPE_RESS;
			break;
		}
		break;
	}
	if (!type) return GF_NOT_SUPPORTED;

	GF_ProtectionSchemeInfoBox *rinf;
	rinf = (GF_ProtectionSchemeInfoBox *) gf_isom_box_find_child(ent->child_boxes, GF_ISOM_BOX_TYPE_RINF);
	if (rinf) gf_isom_box_del_parent(&ent->child_boxes, (GF_Box *)rinf);

	rinf = (GF_ProtectionSchemeInfoBox *)gf_isom_box_new_parent(&ent->child_boxes, GF_ISOM_BOX_TYPE_RINF);
	if (!rinf) return GF_OUT_OF_MEM;


	rinf->original_format = (GF_OriginalFormatBox *)gf_isom_box_new_parent(&rinf->child_boxes, GF_ISOM_BOX_TYPE_FRMA);
	if (!rinf->original_format) return GF_OUT_OF_MEM;
	if (gnr_type) {
		rinf->original_format->data_format = gnr_type;
		rinf->original_format->gnr_type = original_format;
	} else {
		rinf->original_format->data_format = original_format;
	}
	//common to isma, cenc and oma
	rinf->scheme_type = (GF_SchemeTypeBox *)gf_isom_box_new_parent(&rinf->child_boxes, GF_ISOM_BOX_TYPE_SCHM);
	if (!rinf->scheme_type) return GF_OUT_OF_MEM;
	rinf->scheme_type->scheme_type  = scheme_type;

	ent->type = type;
	return GF_OK;
}
