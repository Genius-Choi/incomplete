operation_error (FlatpakTransaction            *transaction,
                 FlatpakTransactionOperation   *op,
                 const GError                  *error,
                 FlatpakTransactionErrorDetails detail)
{
  FlatpakCliTransaction *self = FLATPAK_CLI_TRANSACTION (transaction);
  FlatpakTransactionOperationType op_type = flatpak_transaction_operation_get_operation_type (op);
  const char *ref = flatpak_transaction_operation_get_ref (op);
  g_autoptr(FlatpakRef) rref = flatpak_ref_parse (ref, NULL);
  gboolean non_fatal = (detail & FLATPAK_TRANSACTION_ERROR_DETAILS_NON_FATAL) != 0;
  g_autofree char *text = NULL;
  const char *on = "";
  const char *off = "";

  if (flatpak_fancy_output ())
    {
      on = FLATPAK_ANSI_BOLD_ON;
      off = FLATPAK_ANSI_BOLD_OFF;
    }

  if (g_error_matches (error, FLATPAK_ERROR, FLATPAK_ERROR_SKIPPED))
    {
      set_op_progress (self, op, "⍻");
      text = g_strdup_printf (_("Info: %s was skipped"), flatpak_ref_get_name (rref));
      if (flatpak_fancy_output ())
        {
          flatpak_table_printer_set_cell (self->printer, self->progress_row, 0, text);
          self->progress_row++;
          flatpak_table_printer_add_span (self->printer, "");
          flatpak_table_printer_finish_row (self->printer);
          redraw (self);
        }
      else
        g_print ("%s\n", text);

      return TRUE;
    }

  set_op_progress (self, op, "✗");

  /* Here we go to great lengths not to split the sentences. See
   * https://wiki.gnome.org/TranslationProject/DevGuidelines/Never%20split%20sentences
   */
  if (g_error_matches (error, FLATPAK_ERROR, FLATPAK_ERROR_ALREADY_INSTALLED))
    {
      if (non_fatal)
        text = g_strdup_printf (_("Warning: %s%s%s already installed"),
                                on, flatpak_ref_get_name (rref), off);
      else
        text = g_strdup_printf (_("Error: %s%s%s already installed"),
                                on, flatpak_ref_get_name (rref), off);
    }
  else if (g_error_matches (error, FLATPAK_ERROR, FLATPAK_ERROR_NOT_INSTALLED))
    {
      if (non_fatal)
        text = g_strdup_printf (_("Warning: %s%s%s not installed"),
                                on, flatpak_ref_get_name (rref), off);
      else
        text = g_strdup_printf (_("Error: %s%s%s not installed"),
                                on, flatpak_ref_get_name (rref), off);
    }
  else if (g_error_matches (error, FLATPAK_ERROR, FLATPAK_ERROR_NEED_NEW_FLATPAK))
    {
      if (non_fatal)
        text = g_strdup_printf (_("Warning: %s%s%s needs a later flatpak version"),
                                on, flatpak_ref_get_name (rref), off);
      else
        text = g_strdup_printf (_("Error: %s%s%s needs a later flatpak version"),
                                on, flatpak_ref_get_name (rref), off);
    }
  else if (g_error_matches (error, FLATPAK_ERROR, FLATPAK_ERROR_OUT_OF_SPACE))
    {
      if (non_fatal)
        text = g_strdup (_("Warning: Not enough disk space to complete this operation"));
      else
        text = g_strdup (_("Error: Not enough disk space to complete this operation"));
    }
  else if (error)
    {
      if (non_fatal)
        text = g_strdup_printf (_("Warning: %s"), error->message);
      else
        text = g_strdup_printf (_("Error: %s"), error->message);
    }
  else
    text = g_strdup ("(internal error, please report)");

  if (!non_fatal && self->first_operation_error == NULL)
    {
      /* Here we go to great lengths not to split the sentences. See
       * https://wiki.gnome.org/TranslationProject/DevGuidelines/Never%20split%20sentences
       */
      switch (op_type)
        {
          case FLATPAK_TRANSACTION_OPERATION_INSTALL:
            g_propagate_prefixed_error (&self->first_operation_error,
                                        g_error_copy (error),
                                        _("Failed to install %s%s%s: "),
                                        on, flatpak_ref_get_name (rref), off);
            break;

          case FLATPAK_TRANSACTION_OPERATION_UPDATE:
            g_propagate_prefixed_error (&self->first_operation_error,
                                        g_error_copy (error),
                                        _("Failed to update %s%s%s: "),
                                        on, flatpak_ref_get_name (rref), off);
            break;

          case FLATPAK_TRANSACTION_OPERATION_INSTALL_BUNDLE:
            g_propagate_prefixed_error (&self->first_operation_error,
                                        g_error_copy (error),
                                        _("Failed to install bundle %s%s%s: "),
                                        on, flatpak_ref_get_name (rref), off);
            break;

          case FLATPAK_TRANSACTION_OPERATION_UNINSTALL:
            g_propagate_prefixed_error (&self->first_operation_error,
                                        g_error_copy (error),
                                        _("Failed to uninstall %s%s%s: "),
                                        on, flatpak_ref_get_name (rref), off);
            break;

          default:
            g_assert_not_reached ();
        }
    }

  if (flatpak_fancy_output ())
    {
      flatpak_table_printer_set_cell (self->printer, self->progress_row, 0, text);
      self->progress_row++;
      flatpak_table_printer_add_span (self->printer, "");
      flatpak_table_printer_finish_row (self->printer);
      redraw (self);
    }
  else
    g_printerr ("%s\n", text);

  if (!non_fatal && self->stop_on_first_error)
    return FALSE;

  return TRUE; /* Continue */
}
