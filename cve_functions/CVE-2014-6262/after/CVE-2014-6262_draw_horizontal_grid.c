int draw_horizontal_grid(
    image_desc_t
    *im)
{
    int       i;
    double    scaledstep;
    char      graph_label[100];
    int       nlabels = 0;
    double    X0 = im->xorigin;
    double    X1 = im->xorigin + im->xsize;
    int       sgrid = (int) (im->minval / im->ygrid_scale.gridstep - 1);
    int       egrid = (int) (im->maxval / im->ygrid_scale.gridstep + 1);
    double    MaxY;
    double second_axis_magfact = 0;
    char *second_axis_symb = "";

    scaledstep =
        im->ygrid_scale.gridstep /
        (double) im->magfact * (double) im->viewfactor;
    MaxY = scaledstep * (double) egrid;
    for (i = sgrid; i <= egrid; i++) {
        double    Y0 = ytr(im,
                           im->ygrid_scale.gridstep * i);
        double    YN = ytr(im,
                           im->ygrid_scale.gridstep * (i + 1));

        if (floor(Y0 + 0.5) >=
            im->yorigin - im->ysize && floor(Y0 + 0.5) <= im->yorigin) {
            /* Make sure at least 2 grid labels are shown, even if it doesn't agree
               with the chosen settings. Add a label if required by settings, or if
               there is only one label so far and the next grid line is out of bounds. */
            if (i % im->ygrid_scale.labfact == 0
                || (nlabels == 1
                    && (YN < im->yorigin - im->ysize || YN > im->yorigin))) {
                if (im->symbol == ' ') {
                    if (im->primary_axis_format[0] == '\0'){
                        if (im->extra_flags & ALTYGRID) {
                            sprintf(graph_label,
                                    im->ygrid_scale.labfmt,
                                    scaledstep * (double) i);
                        } else {
                            if (MaxY < 10) {
                                sprintf(graph_label, "%4.1f",
                                        scaledstep * (double) i);
                            } else {
                                sprintf(graph_label, "%4.0f",
                                        scaledstep * (double) i);
                            }
                        }
                    } else {
                        sprintf(graph_label, im->primary_axis_format,
                                scaledstep * (double) i);
                    }
                } else {
                    char      sisym = (i == 0 ? ' ' : im->symbol);
                    
                    if (im->primary_axis_format[0] == '\0'){
                        if (im->extra_flags & ALTYGRID) {
                            sprintf(graph_label,
                                    im->ygrid_scale.labfmt,
                                    scaledstep * (double) i, sisym);
                        } else {
                            if (MaxY < 10) {
                                sprintf(graph_label, "%4.1f %c",
                                        scaledstep * (double) i, sisym);
                            } else {
                                sprintf(graph_label, "%4.0f %c",
                                        scaledstep * (double) i, sisym);
                            }
                        }
                    } else {
                        sprintf(graph_label, im->primary_axis_format,
                                scaledstep * (double) i, sisym);
                    }
                }
                nlabels++;
                if (im->second_axis_scale != 0){
                        char graph_label_right[100];
                        double sval = im->ygrid_scale.gridstep*(double)i*im->second_axis_scale+im->second_axis_shift;
                        if (im->second_axis_format[0] == '\0'){
                            if (!second_axis_magfact){
                                double dummy = im->ygrid_scale.gridstep*(double)(sgrid+egrid)/2.0*im->second_axis_scale+im->second_axis_shift;
                                auto_scale(im,&dummy,&second_axis_symb,&second_axis_magfact);
                            }
                            sval /= second_axis_magfact;

                            if(MaxY < 10) {
                                sprintf(graph_label_right,"%5.1f %s",sval,second_axis_symb);
                            } else {
                                sprintf(graph_label_right,"%5.0f %s",sval,second_axis_symb);
                            }
                        }
                        else {
                           sprintf(graph_label_right,im->second_axis_format,sval,"");
                        }
                        gfx_text ( im,
                               X1+7, Y0,
                               im->graph_col[GRC_FONT],
                               im->text_prop[TEXT_PROP_AXIS].font_desc,
                               im->tabwidth,0.0, GFX_H_LEFT, GFX_V_CENTER,
                               graph_label_right );
                }

                gfx_text(im,
                         X0 -
                         im->
                         text_prop[TEXT_PROP_AXIS].
                         size, Y0,
                         im->graph_col[GRC_FONT],
                         im->
                         text_prop[TEXT_PROP_AXIS].
                         font_desc,
                         im->tabwidth, 0.0,
                         GFX_H_RIGHT, GFX_V_CENTER, graph_label);
                gfx_line(im, X0 - 2, Y0, X0, Y0,
                         MGRIDWIDTH, im->graph_col[GRC_MGRID]);
                gfx_line(im, X1, Y0, X1 + 2, Y0,
                         MGRIDWIDTH, im->graph_col[GRC_MGRID]);
                gfx_dashed_line(im, X0 - 2, Y0,
                                X1 + 2, Y0,
                                MGRIDWIDTH,
                                im->
                                graph_col
                                [GRC_MGRID],
                                im->grid_dash_on, im->grid_dash_off);
            } else if (!(im->extra_flags & NOMINOR)) {
                gfx_line(im,
                         X0 - 2, Y0,
                         X0, Y0, GRIDWIDTH, im->graph_col[GRC_GRID]);
                gfx_line(im, X1, Y0, X1 + 2, Y0,
                         GRIDWIDTH, im->graph_col[GRC_GRID]);
                gfx_dashed_line(im, X0 - 1, Y0,
                                X1 + 1, Y0,
                                GRIDWIDTH,
                                im->
                                graph_col[GRC_GRID],
                                im->grid_dash_on, im->grid_dash_off);
            }
        }
    }
    return 1;
}
