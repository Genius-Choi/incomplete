int graph_size_location(
    image_desc_t
    *im,
    int elements)
{
    /* The actual size of the image to draw is determined from
     ** several sources.  The size given on the command line is
     ** the graph area but we need more as we have to draw labels
     ** and other things outside the graph area. If the option
     ** --full-size-mode is selected the size defines the total
     ** image size and the size available for the graph is
     ** calculated.
     */

    /** +---+-----------------------------------+
     ** | y |...............graph title.........|
     ** |   +---+-------------------------------+
     ** | a | y |                               |
     ** | x |   |                               |
     ** | i | a |                               |
     ** | s | x |       main graph area         |
     ** |   | i |                               |
     ** | t | s |                               |
     ** | i |   |                               |
     ** | t | l |                               |
     ** | l | b +-------------------------------+
     ** | e | l |       x axis labels           |
     ** +---+---+-------------------------------+
     ** |....................legends............|
     ** +---------------------------------------+
     ** |                   watermark           |
     ** +---------------------------------------+
     */

    int       Xvertical = 0, Xvertical2 = 0, Ytitle =
        0, Xylabel = 0, Xmain = 0, Ymain =
        0, Yxlabel = 0, Xspacing = 15, Yspacing = 15, Ywatermark = 4;

    // no legends and no the shall be plotted it's easy
    if (im->extra_flags & ONLY_GRAPH) {
        im->xorigin = 0;
        im->ximg = im->xsize;
        im->yimg = im->ysize;
        im->yorigin = im->ysize;
        xtr(im, 0);
        ytr(im, DNAN);
        return 0;
    }

    if(im->watermark[0] != '\0') {
        Ywatermark = im->text_prop[TEXT_PROP_WATERMARK].size * 2;
    }

    // calculate the width of the left vertical legend
    if (im->ylegend[0] != '\0') {
        Xvertical = im->text_prop[TEXT_PROP_UNIT].size * 2;
    }

    // calculate the width of the right vertical legend
    if (im->second_axis_legend[0] != '\0') {
        Xvertical2 = im->text_prop[TEXT_PROP_UNIT].size * 2;
    }
    else{
        Xvertical2 = Xspacing;
    }

    if (im->title[0] != '\0') {
        /* The title is placed "inbetween" two text lines so it
         ** automatically has some vertical spacing.  The horizontal
         ** spacing is added here, on each side.
         */
        /* if necessary, reduce the font size of the title until it fits the image width */
        Ytitle = im->text_prop[TEXT_PROP_TITLE].size * 2.6 + 10;
    }
    else{
        // we have no title; get a little clearing from the top
        Ytitle = Yspacing;
    }

    if (elements) {
        if (im->draw_x_grid) {
            // calculate the height of the horizontal labelling
            Yxlabel = im->text_prop[TEXT_PROP_AXIS].size * 2.5;
        }
        if (im->draw_y_grid || im->forceleftspace) {
            // calculate the width of the vertical labelling
            Xylabel =
                gfx_get_text_width(im, 0,
                                   im->text_prop[TEXT_PROP_AXIS].font_desc,
                                   im->tabwidth, "0") * im->unitslength;
        }
    }

    // add some space to the labelling
    Xylabel += Xspacing;

    /* If the legend is printed besides the graph the width has to be
     ** calculated first. Placing the legend north or south of the
     ** graph requires the width calculation first, so the legend is
     ** skipped for the moment.
     */
    im->legendheight = 0;
    im->legendwidth = 0;
    if (!(im->extra_flags & NOLEGEND)) {
        if(im->legendposition == WEST || im->legendposition == EAST){
            if (leg_place(im, 1) == -1){
                return -1;
            }
        }
    }

    if (im->extra_flags & FULL_SIZE_MODE) {

        /* The actual size of the image to draw has been determined by the user.
         ** The graph area is the space remaining after accounting for the legend,
         ** the watermark, the axis labels, and the title.
         */
        im->ximg = im->xsize;
        im->yimg = im->ysize;
        Xmain = im->ximg;
        Ymain = im->yimg;

        /* Now calculate the total size.  Insert some spacing where
           desired.  im->xorigin and im->yorigin need to correspond
           with the lower left corner of the main graph area or, if
           this one is not set, the imaginary box surrounding the
           pie chart area. */
        /* Initial size calculation for the main graph area */

        Xmain -= Xylabel;// + Xspacing;
        if((im->legendposition == WEST || im->legendposition == EAST) && !(im->extra_flags & NOLEGEND) ){
            Xmain -= im->legendwidth;// + Xspacing;
        }
        if (im->second_axis_scale != 0){
            Xmain -= Xylabel;
        }
        if (!(im->extra_flags & NO_RRDTOOL_TAG)){
            Xmain -= Xspacing;
        }

        Xmain -= Xvertical + Xvertical2;

        /* limit the remaining space to 0 */
        if(Xmain < 1){
            Xmain = 1;
        }
        im->xsize = Xmain;

        /* Putting the legend north or south, the height can now be calculated */
        if (!(im->extra_flags & NOLEGEND)) {
            if(im->legendposition == NORTH || im->legendposition == SOUTH){
                im->legendwidth = im->ximg;
                if (leg_place(im, 0) == -1){
                    return -1;
                }
            }
        }

        if( (im->legendposition == NORTH || im->legendposition == SOUTH)  && !(im->extra_flags & NOLEGEND) ){
            Ymain -=  Yxlabel + im->legendheight;
        }
        else{
            Ymain -= Yxlabel;
        }

        /* reserve space for the title *or* some padding above the graph */
        Ymain -= Ytitle;

            /* reserve space for padding below the graph */
        if (im->extra_flags & NOLEGEND) {
            Ymain -= 0.5*Yspacing;
        }

        if (im->watermark[0] != '\0') {
            Ymain -= Ywatermark;
        }
        /* limit the remaining height to 0 */
        if(Ymain < 1){
            Ymain = 1;
        }
        im->ysize = Ymain;
    } else {            /* dimension options -width and -height refer to the dimensions of the main graph area */

        /* The actual size of the image to draw is determined from
         ** several sources.  The size given on the command line is
         ** the graph area but we need more as we have to draw labels
         ** and other things outside the graph area.
         */

        if (elements) {
            Xmain = im->xsize; // + Xspacing;
            Ymain = im->ysize;
        }

        im->ximg = Xmain + Xylabel;
        if (!(im->extra_flags & NO_RRDTOOL_TAG)){
            im->ximg += Xspacing;
        }

        if( (im->legendposition == WEST || im->legendposition == EAST) && !(im->extra_flags & NOLEGEND) ){
            im->ximg += im->legendwidth;// + Xspacing;
        }
        if (im->second_axis_scale != 0){
            im->ximg += Xylabel;
        }

        im->ximg += Xvertical + Xvertical2;

        if (!(im->extra_flags & NOLEGEND)) {
            if(im->legendposition == NORTH || im->legendposition == SOUTH){
                im->legendwidth = im->ximg;
                if (leg_place(im, 0) == -1){
                    return -1;
                }
            }
        }

        im->yimg = Ymain + Yxlabel;
        if( (im->legendposition == NORTH || im->legendposition == SOUTH)  && !(im->extra_flags & NOLEGEND) ){
             im->yimg += im->legendheight;
        }

        /* reserve space for the title *or* some padding above the graph */
        if (Ytitle) {
            im->yimg += Ytitle;
        } else {
            im->yimg += 1.5 * Yspacing;
        }
        /* reserve space for padding below the graph */
        if (im->extra_flags & NOLEGEND) {
            im->yimg += 0.5*Yspacing;
        }

        if (im->watermark[0] != '\0') {
            im->yimg += Ywatermark;
        }
    }


    /* In case of putting the legend in west or east position the first
     ** legend calculation might lead to wrong positions if some items
     ** are not aligned on the left hand side (e.g. centered) as the
     ** legendwidth wight have been increased after the item was placed.
     ** In this case the positions have to be recalculated.
     */
    if (!(im->extra_flags & NOLEGEND)) {
        if(im->legendposition == WEST || im->legendposition == EAST){
            if (leg_place(im, 0) == -1){
                return -1;
            }
        }
    }

    /* After calculating all dimensions
     ** it is now possible to calculate
     ** all offsets.
     */
    switch(im->legendposition){
        case NORTH:
            im->xOriginTitle   = (im->ximg / 2);
            im->yOriginTitle   = 0;

            im->xOriginLegend  = 0;
            im->yOriginLegend  = Ytitle;

            im->xOriginLegendY = 0;
            im->yOriginLegendY = Ytitle + im->legendheight + (Ymain / 2) + Yxlabel;

            im->xorigin        = Xvertical + Xylabel;
            im->yorigin        = Ytitle + im->legendheight + Ymain;

            im->xOriginLegendY2 = Xvertical + Xylabel + Xmain;
            if (im->second_axis_scale != 0){
                im->xOriginLegendY2 += Xylabel;
            }
            im->yOriginLegendY2 = Ytitle + im->legendheight + (Ymain / 2) + Yxlabel;

            break;

        case WEST:
            im->xOriginTitle   = im->legendwidth + im->xsize / 2;
            im->yOriginTitle   = 0;

            im->xOriginLegend  = 0;
            im->yOriginLegend  = Ytitle;

            im->xOriginLegendY = im->legendwidth;
            im->yOriginLegendY = Ytitle + (Ymain / 2);

            im->xorigin        = im->legendwidth + Xvertical + Xylabel;
            im->yorigin        = Ytitle + Ymain;

            im->xOriginLegendY2 = im->legendwidth + Xvertical + Xylabel + Xmain;
            if (im->second_axis_scale != 0){
                im->xOriginLegendY2 += Xylabel;
            }
            im->yOriginLegendY2 = Ytitle + (Ymain / 2);

            break;

        case SOUTH:
            im->xOriginTitle   = im->ximg / 2;
            im->yOriginTitle   = 0;

            im->xOriginLegend  = 0;
            im->yOriginLegend  = Ytitle + Ymain + Yxlabel;

            im->xOriginLegendY = 0;
            im->yOriginLegendY = Ytitle + (Ymain / 2);

            im->xorigin        = Xvertical + Xylabel;
            im->yorigin        = Ytitle + Ymain;

            im->xOriginLegendY2 = Xvertical + Xylabel + Xmain;
            if (im->second_axis_scale != 0){
                im->xOriginLegendY2 += Xylabel;
            }
            im->yOriginLegendY2 = Ytitle + (Ymain / 2);

            break;

        case EAST:
            im->xOriginTitle   = im->xsize / 2;
            im->yOriginTitle   = 0;

            im->xOriginLegend  = Xvertical + Xylabel + Xmain + Xvertical2;
            if (im->second_axis_scale != 0){
                im->xOriginLegend += Xylabel;
            }
            im->yOriginLegend  = Ytitle;

            im->xOriginLegendY = 0;
            im->yOriginLegendY = Ytitle + (Ymain / 2);

            im->xorigin        = Xvertical + Xylabel;
            im->yorigin        = Ytitle + Ymain;

            im->xOriginLegendY2 = Xvertical + Xylabel + Xmain;
            if (im->second_axis_scale != 0){
                im->xOriginLegendY2 += Xylabel;
            }
            im->yOriginLegendY2 = Ytitle + (Ymain / 2);

            if (!(im->extra_flags & NO_RRDTOOL_TAG)){
                im->xOriginTitle    += Xspacing;
                im->xOriginLegend   += Xspacing;
                im->xOriginLegendY  += Xspacing;
                im->xorigin         += Xspacing;
                im->xOriginLegendY2 += Xspacing;
            }
            break;
    }

    xtr(im, 0);
    ytr(im, DNAN);
    return 0;
}
